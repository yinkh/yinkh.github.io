{"config":{"lang":["ja"],"separator":"[\\s\\u200b\\-]","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u4e3b\u9875","text":"<p>\u90ae\u7bb1\uff1ayin-kh@qq.com</p>"},{"location":"tags/","title":"\u6807\u7b7e","text":"<p>\u6587\u7ae0\u5217\u8868:</p>"},{"location":"auto/github-pages/","title":"Github Pages\u548cActions","text":""},{"location":"auto/github-pages/#1","title":"1. \u5f00\u542f\u670d\u52a1","text":"<p>\u65b0\u5efagithub\u4ed3\u5e93\uff0c\u4ec5\u516c\u5f00\u7684\u4ed3\u5e93\u652f\u6301github-pages\u670d\u52a1\u3002</p> <p>\u5728\u4ed3\u5e93\u7684Settings-&gt;Pages\u4e2d\u5f00\u542f\u670d\u52a1\u3002</p> <p>\u53ef\u9009\u62e9\u9879\u76ee\u4ee3\u7801\u6765\u6e90\u7684\u5206\u652f+Souce\u76ee\u5f55\u3002</p>"},{"location":"auto/github-pages/#2","title":"2. \u81ea\u5b9a\u4e49\u57df\u540d","text":""},{"location":"auto/github-pages/#_1","title":"\u57df\u540d\u8ba4\u8bc1","text":"<p>\u5728\u4f60\u7684\u57df\u540d\u63d0\u4f9b\u5546\u7684\u63a7\u5236\u53f0\u4e2d\uff0c\u65b0\u589e\u4e00\u6761CNAME\u8bb0\u5f55\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>\u4e3b\u673a\u8bb0\u5f55 www</li> <li>\u8bb0\u5f55\u7c7b\u578b CNAME</li> <li>\u8bb0\u5f55\u503c yinkh.github.io</li> </ul>"},{"location":"auto/github-pages/#_2","title":"\u754c\u9762\u914d\u7f6e","text":"<p>\u5728\u4ed3\u5e93\u7684Settings-&gt;Pages\u4e2d\u5f00\u542f\u670d\u52a1\u3002</p> <p>\u5f00\u542f\u540egithubs\u4f1a\u81ea\u52a8\u5728\u9879\u76ee\u5bf9\u5e94\u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2aCNAME\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u4e3a\u4f60\u7684\u81ea\u5b9a\u4e49\u57df\u540d\u3002</p>"},{"location":"auto/github-pages/#_3","title":"\u6587\u4ef6\u914d\u7f6e","text":"<p>\u5728\u9879\u76ee\u7684source\u76ee\u5f55\u4e2d\uff0c\u624b\u52a8\u65b0\u589e\u4e00\u4e2aCNAME\u6587\u4ef6\uff0c\u6587\u4ef6\u5185\u5bb9\u4e3a\u4f60\u7684\u81ea\u5b9a\u4e49\u57df\u540d\uff0c\u53ef\u4ee5\u8fbe\u5230\u540c\u6837\u7684\u6548\u679c\u3002</p>"},{"location":"auto/github-pages/#cname","title":"CNAME\u9519\u8bef","text":"<p>\u8fd9\u4e2a\u6587\u4ef6\u4e0d\u53ef\u4ee5\u5220\u9664\uff0c\u5220\u9664\u5c06\u5bfc\u81f4\u81ea\u5b9a\u4e49\u57df\u540d\u89e3\u6790\u5931\u6548\u3002</p> <p>\u4e4b\u524d\u6211\u603b\u662f\u5168\u5c40\u8986\u76d6\u9879\u76ee\u4e0b\u7684\u9759\u6001\u6587\u4ef6\uff0cCNAME\u6587\u4ef6\u88ab\u5220\u9664\u4e86\uff0c\u5bfc\u81f4\u81ea\u5b9a\u4e49\u57df\u540d\u4e00\u4f1a\u751f\u6548\uff0c\u4e00\u4f1a\u63d0\u793a404 github-pages\u4e0d\u5b58\u5728\uff0c\u5b9a\u4f4d\u4e86\u597d\u4e45\u3002\u5177\u4f53\u53ef\u4ee5\u53c2\u8003\uff1aCNAME \u9519\u8bef</p>"},{"location":"auto/github-pages/#3-ci","title":"3. CI","text":"<p>\u5728\u9879\u76ee\u6839\u76ee\u5f55\u65b0\u5efa\u6587\u4ef6\u5939<code>.github/workflows</code>\uff0c\u65b0\u589e\u6587\u4ef6 ci.yml:</p> ci.yml<pre><code>name: publish-github-pages\non:\npush:\nbranches:\n- main\njobs:\ndeploy:\nruns-on: ubuntu-latest # \u7f16\u8bd1\u673a\u7cfb\u7edf\nsteps:\n- uses: actions/checkout@v2 # \u68c0\u51fa\u4ee3\u7801\n- uses: actions/setup-python@v2 # \u8bbe\u7f6ePython\u7248\u672c\nwith:\npython-version: 3.9\n- run: pip install -r requirements.txt # \u6309\u7167\u5bf9\u5e94\u4f9d\u8d56\n- run: mkdocs build # \u7f16\u8bd1\u9759\u6001\u6587\u4ef6\u7ad9\u70b9\n- name: Deploy # \u63a8\u9001\u9759\u6001\u6587\u4ef6\u76ee\u5f55\u81f3github-pages\u4ed3\u5e93\nuses: peaceiris/actions-gh-pages@v3 # \u5f15\u7528\u7684\u4e09\u65b9Action\nwith:\nexternal_repository: yinkh/yinkh.github.io # \u8981\u63a8\u9001\u7684\u4ed3\u5e93\u5730\u5740\npersonal_token: your personal_token # \u81ea\u5df1\u7684token\npublish_dir: ./sites # \u6e90\u4ed3\u5e93\u8981\u4e0a\u4f20\u7684\u76ee\u5f55\npublish_branch: master # \u76ee\u7684\u4ed3\u5e93\u5bf9\u5e94\u7684\u5206\u5b50\n</code></pre>"},{"location":"auto/ui-automator-viewer/","title":"UI Automator Viewer","text":"<p>UI Automator Viewer\u662f\u4e00\u6b3e\u7531Google\u63d0\u4f9b\u7684\u7528\u4e8e\u6355\u83b7\u5b89\u5353\u9875\u9762\u6784\u6210\u7684\u5de5\u5177\u3002\u4e0b\u8f7dAndroidSDK\u540e\u53ef\u4ee5\u5728<code>D:\\AndoridSDK\\tools\\bin</code>\u67e5\u770b</p>"},{"location":"cache/redis/zset/","title":"Redis SortedSet(\u6709\u5e8f\u96c6\u5408)\u4f7f\u7528\u7b14\u8bb0","text":""},{"location":"cache/redis/zset/#1","title":"1\u3001\u4f7f\u7528\u573a\u5408","text":"<p>\u6709\u5927\u91cf\u5b9e\u65f6\u66f4\u65b0\u7684\u6570\u636e\u5f85\u6392\u5e8f\uff0c\u4f7f\u7528Redis\u4e2d\u7684SortedSet\u964d\u4f4e\u4ee3\u7801\u590d\u6742\u5ea6\u5e76\u83b7\u5f97\u8f83\u597d\u7684\u6392\u5e8f\u65f6\u6548\u6027\u3002</p>"},{"location":"cache/redis/zset/#2redis","title":"2\u3001Redis","text":"<ul> <li>\u5b89\u88c5</li> </ul> <p>windows:\u524d\u5f80github\u4e0b\u8f7d\u6700\u65b0\u7684msi\u6587\u4ef6\u8fdb\u884c\u5b89\u88c5\u5373\u53ef\u3002</p> <p>ubuntu: <code>sudo apt-get install redis-server</code></p>"},{"location":"cache/redis/zset/#2django-redis","title":"2\u3001django-redis","text":"<ul> <li>\u5b89\u88c5</li> </ul> <pre><code>pip install django-redis==4.8.0\n</code></pre> <ul> <li>\u8bbe\u7f6e</li> </ul> <p>settings.py</p> <pre><code># \u7f13\u5b58\nCACHES = {\n\"default\": {\n\"BACKEND\": \"django_redis.cache.RedisCache\",\n\"LOCATION\": \"redis://127.0.0.1:6379/1\",\n\"OPTIONS\": {\n\"CLIENT_CLASS\": \"django_redis.client.DefaultClient\",\n}\n}\n}\n</code></pre> <ul> <li>\u6587\u6863</li> </ul> <p>Django-Redis\u4e2d\u6587\u6587\u6863</p> <ul> <li>\u83b7\u53d6\u539f\u751fRedis\u8fde\u63a5</li> </ul> <p>\u5173\u4e8e<code>SortedSet</code>\u7684\u76f8\u5173\u64cd\u4f5c\uff0c<code>django-redis</code>\u4e0d\u63d0\u4f9b\u4efb\u4f55\u652f\u6491\uff0c\u4f46\u662f<code>django-redis</code>\u63d0\u4f9b\u4e86\u63a5\u53e3\u53ef\u6362\u53d6\u5230\u539f\u751f<code>redis</code>\u5ba2\u6237\u7aef\uff1a</p> <pre><code>from django_redis import get_redis_connection\nredis = get_redis_connection(\"default\")\n</code></pre>"},{"location":"cache/redis/zset/#3","title":"3\u3001\u5e38\u7528\u547d\u4ee4","text":"<ul> <li><code>zadd</code></li> </ul> <p><code>total_point</code>\u4e3a\u6709\u5e8f\u96c6\u540d\u79f0\uff0c<code>user.point</code>\u4e3a\u503c\uff0c<code>user.id</code>\u4e3a\u952e\u3002</p> <pre><code>redis.zadd('total_point', user.point, user.id)\n</code></pre> <p>\u540c\u65f6\u6dfb\u52a0\u591a\u4e2a\u952e\u503c\u5bf9\u6709\u4e24\u79cd\u65b9\u5f0f\uff0c1\u662f\u4f7f\u7528<code>*args</code>:<code>score1, name1, score2, name2, ...</code>\uff0c2\u662f\u4f7f\u7528<code>**kwargs</code>:<code>name1=score1, name2=score2, ...</code>\u3002</p> <pre><code>redis.zadd('my-key', 1.1, 'name1', 2.2, 'name2', name3=3.3, name4=4.4)\n</code></pre> <ul> <li><code>zscore</code></li> </ul> <p>\u6839\u636e\u952e\u53bb\u5bf9\u5e94\u6709\u5e8f\u96c6\u67e5\u627e\u503c\u3002</p> <pre><code>redis.zscore('total_point', user.id) \n</code></pre> <ul> <li><code>zrank</code></li> </ul> <p>\u6839\u636e\u952e\u53bb\u5bf9\u5e94\u6709\u5e8f\u96c6\u83b7\u53d6\u6392\u540d\uff0c\u503c\u4ece\u5c0f\u5230\u5927\u8fdb\u884c\u6392\u5e8f\uff0c\u7b2c\u4e00\u540d\u6392\u540d\u4e3a0\u3002</p> <pre><code>redis.zrank('total_point', user.id) + 1\n</code></pre> <ul> <li><code>zrevrank</code></li> </ul> <p>\u6839\u636e\u952e\u53bb\u5bf9\u5e94\u6709\u5e8f\u96c6\u83b7\u53d6\u6392\u540d\uff0c\u503c\u4ece\u5927\u5230\u5c0f\u8fdb\u884c\u6392\u5e8f\uff0c\u7b2c\u4e00\u540d\u6392\u540d\u4e3a0\u3002</p> <pre><code>redis.zrevrank('total_point', user.id) + 1\n</code></pre> <ul> <li><code>zremrangebyrank</code></li> </ul> <p>\u79fb\u9664\u6709\u5e8f\u96c6\u4e2d\u6307\u5b9a\u6392\u540d\u533a\u95f4\u7684\u6240\u6709\u6210\u5458\uff0c0\u8868\u793a\u7b2c\u4e00\u4e2a\u6210\u5458\uff0c-1\u8868\u793a\u6700\u540e\u4e00\u4e2a\u6210\u5458\u3002</p> <pre><code># \u6e05\u7a7a\u6709\u7eed\u96c6yesterday_point\nredis.zremrangebyrank('yesterday_point', 0, -1) \n</code></pre> <p>Redis\u547d\u4ee4\u53c2\u8003</p>"},{"location":"front/javascript/javascript-note/","title":"JavaScript\u7b14\u8bb0","text":""},{"location":"front/javascript/javascript-note/#javascripts","title":"JavaScripts:","text":"<ul> <li> <p>\ufefflocation.replace(location.href) \u53ea\u5237\u65b0\u9875\u9762\uff0c\u4e0d\u5237\u65b0\u9759\u6001\u6587\u4ef6\uff0c\u76f8\u5f53\u4e8eF5.</p> </li> <li> <p>loaction.reload(true) \u5237\u65b0\u9875\u9762\u53ca\u9759\u6001\u6587\u4ef6\uff0c\u76f8\u5f53\u4e8ectrl+F5.</p> </li> <li> <p>\u5728ajax\u7684success\u4e2dhistory.back()\\history.go(-1)\u4e0d\u751f\u6548,\u9700\u8981\u4f7f\u7528hostory.go(-2)</p> </li> </ul>"},{"location":"front/javascript/javascript-note/#html","title":"Html:","text":"<ul> <li> <p><code>&lt;input type=\"file\" name=\"excel\" accept=\".xls\" required&gt;</code>  \u4ee3\u8868\u8f93\u5165\u7c7b\u578b\u4e3afile \u683c\u5f0f\u4e3a.xls \u5728POST\u4e2d\u53c2\u6570\u540d\u4e3aexcel \u5fc5\u586b</p> </li> <li> <p><code>&lt;input type=\"number\" step=\"any\"&gt;</code>\u8bbe\u7f6e\u8f93\u5165\u6570\u5b57\u5c0f\u6570\u70b9\u4e0d\u9650</p> </li> <li> <p>colgroup col\u6807\u7b7e\u53ef\u4ee5\u63a7\u5236\u8868\u683c\u663e\u793a\u7684\u6bd4\u4f8b\uff0ccol\u4e3a\u7a7a\u65f6\u8868\u793a\u8be5\u884c\u5360\u636e\u5269\u4e0b\u7684\u6240\u6709\u5bbd\u5ea6\uff0c\u4f46\u5fc5\u987b\u914d\u5408 tbody \u6807\u7b7e\u4f7f\u7528\u4f7f\u7528\u3002eg\uff1a</p> </li> </ul> <pre><code>&lt;table class=\"layui-table\" style=\"margin-top: 10px\"&gt;\n&lt;colgroup&gt;\n&lt;col width=\"50\"&gt;\n&lt;col width=\"100\"&gt;\n&lt;col&gt;\n&lt;col width=\"200\"&gt;\n&lt;col width=\"200\"&gt;\n&lt;/colgroup&gt;\n&lt;thead&gt;\n&lt;tr&gt;\n&lt;th&gt;&lt;input type=\"checkbox\" name=\"\" lay-skin=\"primary\" lay-filter=\"allChoose\" id=\"allChoose\"&gt;&lt;/th&gt;\n&lt;th style=\"text-align: center\"&gt;ID&lt;/th&gt;\n&lt;th&gt;\u6807\u9898&lt;/th&gt;\n&lt;th style=\"text-align: center\"&gt;\u8bed\u8a00&lt;/th&gt;\n&lt;th style=\"text-align: center\"&gt;\u64cd\u4f5c&lt;/th&gt;\n&lt;/tr&gt;\n&lt;/thead&gt;\n&lt;tbody&gt;\n&lt;tr&gt;&lt;/tr&gt;\n&lt;/tbody&gt;\n&lt;/table&gt;\n&lt;/div&gt;\n</code></pre> <ul> <li> <p>\u5faa\u73af\u6e32\u67d3\u5217\u8868\u65f6\uff0c\u53ef\u4ee5\u5c06\u6570\u636e\u7684id\u7ed1\u5b9a\u7ed9tr\u7684id,\u8fd9\u6837\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528dom\u8282\u70b9\u6d3b\u52a8tr\u540e\uff0c\u4f7f\u7528 .attr \u65b9\u6cd5\u83b7\u53d6\u5230\u6570\u636eid\u3002</p> </li> <li> <p>\u5faa\u73af\u6e32\u67d3\u5217\u8868\u65f6\uff0c\u9700\u8981\u5c06\u5faa\u73af\u751f\u6210\u7684js\u4ee3\u7801\u653e\u7f6e\u5230tr\u533a\u5757\u4e2d\uff0c\u4e0d\u7136\u53bb\u53d6index\u7684\u65f6\u5019\u56de\u51fa\u73b0\u8fd4\u56de0 2 4 6 8 \u7684\u60c5\u51b5\u3002</p> </li> <li> <p>Django\u7684\u6a21\u677f\u8bed\u8a00\u8fd0\u884c\u5728\u540e\u7aef\uff0cjs\u8fd0\u884c\u5728\u524d\u7aef\uff0c\u6240\u4ee5django\u6a21\u677f\u8bed\u8a00\u4e2d\u7684\u53d8\u91cf\u4e0d\u53ef\u4ee5\u51fa\u73b0\u5728js\u4e2d\uff0c\u53ea\u53ef\u4ee5\u4f7f\u7528url\u53cd\u5411\u68c0\u7d22\u6216\u8005\u5c06js\u4e2d\u7684\u5bf9\u8c61\u8f6c\u6362\u6210str,\u4e0d\u53ef\u4ee5\u5728js\u4e2d\u5c06django\u6a21\u677f\u53d8\u91cf\u4f5c\u4e3a\u4e00\u4e2a\u53d8\u91cf\u6765\u4f7f\u7528\uff0c\u53ea\u53ef\u4ee5\u4f5c\u4e3a\u5e38\u91cf\u6765\u4f7f\u7528\uff0c\u56e0\u4e3a\u4e00\u7ecf\u8fc7\u540e\u53f0\u6e32\u67d3\u540e\uff0cdjango\u7684\u6a21\u677f\u53d8\u91cf\u5c31\u53d8\u6210\u4e86\u5e38\u91cf\u5b58\u5728js\u4e2d\u4e86\u3002</p> </li> <li> <p>\u5728js\u4e2d\u4f7f\u7528Django \u6a21\u677f\u53d8\u91cf\u65f6\uff0c\u9700\u8981\u5728\u4e24\u7aef\u52a0\u4e0a\u201c\u201d,\u5c06\u53d8\u91cf\u8f6c\u5316\u4e3a\u5f53\u524d\u72b6\u6001\u5bf9\u5e94\u7684str,\u5982 news_list(Queryset[1,2]),\u5f15\u7528\u683c\u5f0f\u4e3a\u201c{{news_list}}\u201d\uff0cjs\u4e2d\u5f97\u5230\u7684\u7ed3\u679c\u4e3a\u201cQueryset[1,2]\u201d,\u5176\u7c7b\u578bstr\u800c\u975eQueryset\u3002</p> </li> <li> <p>jquery.js\u8981\u5728bootstrap.js\u4e4b\u524d\u5f15\u7528\uff0c\u56e0\u4e3abootstarp.js\u9700\u8981jquery.js\u7684\u652f\u6301\u3002</p> </li> <li> <p>form\u4e2d\u6dfb\u52a0novalidate\u53ef\u4ee5\u7981\u7528\u672c\u5730\u7684\u9884\u68c0\u6d4b\u7a0b\u5e8f</p> </li> <li> <p><code>{% if field.field.required %} # \u5b57\u6bb5\u662f\u5426\u5fc5\u586b</code></p> </li> </ul> <p>\ufeff</p>"},{"location":"front/nodejs/nvm/","title":"nvm\u7ba1\u7406nodejs\u7248\u672c","text":"<p>nodejs\u7248\u672c\u7ba1\u7406\u5de5\u5177\uff0cwindows\u4f7f\u7528nvm-windows</p>"},{"location":"front/nodejs/nvm/#_1","title":"\u4e0b\u8f7d","text":"<p>nvm-windows/releases\uff0c\u9009\u62e9 nvm-setup.exe \u4e0b\u8f7d\u3002</p>"},{"location":"front/nodejs/nvm/#_2","title":"\u5b89\u88c5","text":"<p>\u4e0b\u4e00\u6b65\u5373\u53ef</p>"},{"location":"front/nodejs/nvm/#_3","title":"\u73af\u5883\u53d8\u91cf","text":"<p>\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u4f1a\u591a\u51fa\u4e24\u4e2a\u73af\u5883\u53d8\u91cf NVM_HOME\uff08nvm\u5b89\u88c5\u76ee\u5f55\uff09 \u548c NVM_SYMLINK\uff08nodejs\u5b89\u88c5\u76ee\u5f55\uff09</p>"},{"location":"front/nodejs/nvm/#_4","title":"\u4ee3\u7406","text":"<p>\u975e\u5fc5\u8981\u7684\u64cd\u4f5c\uff0c\u4f7f\u7528\u4ee3\u7801\u53ef\u4ee5\u52a0\u5feb\u4e0b\u8f7d\u901f\u5ea6\u3002</p> <p>\u5728\u5b89\u88c5\u76ee\u5f55\u4e0b\u7684setting.txt\u6587\u4ef6\u4e2d\u8ffd\u52a0\uff1a</p> <pre><code>nvm node_mirror https://npm.taobao.org/mirrors/node/\nnvm npm_mirror https://npm.taobao.org/mirrors/npm/\n</code></pre>"},{"location":"front/nodejs/nvm/#_5","title":"\u7528\u6cd5","text":"<ul> <li> <p>nvm list available \u67e5\u770b\u53ef\u4ee5\u4e0b\u8f7d\u7684nodejs\u7248\u672c</p> </li> <li> <p>nvm install 14.19.3 \u4e0b\u8f7d\u6307\u5b9anodejs\u7248\u672c</p> </li> <li>nvm uninstall 14.19.3 \u5378\u8f7d\u6307\u5b9a\u7248\u672c</li> <li> <p>nvm list \u67e5\u770b\u5df2\u5b89\u88c5\u7684nodejs\u7248\u672c</p> </li> <li> <p>nvm use 16.8.0 \u4f7f\u7528\u6307\u5b9a\u7248\u672c</p> </li> </ul>"},{"location":"front/nodejs/nvm/#_6","title":"\u95ee\u9898","text":"<p>Q1: use\u62a5\u9519 exit status 145</p> <pre><code>D:\\web_workspace\\demo&gt;nvm use 14.18.3\nexit status 145: \u013f\u00bc\ufffd\ufffd\ufffd\u01ff\u0575\u0121\ufffd\nexit status 1: \ufffd\ufffd\ufffd\u013c\ufffd\ufffd\u0474\ufffd\ufffd\ufffd\u02b1\ufffd\ufffd\ufffd\u07b7\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\u013c\ufffd\ufffd\ufffd\n</code></pre> <p>A1\uff1a\u5378\u8f7d\u4e4b\u524d\u5b89\u88c5\u7684nodejs\u5373\u53ef</p> <p>https://github.com/coreybutler/nvm-windows/issues/674</p>"},{"location":"front/vue/typescript/","title":"TS\u8bed\u6cd5","text":"<pre><code>const selectedDeviceList = ref&lt;any[]&gt;([])\n\nlet device_list: any[] = []\n</code></pre> <pre><code>      &lt;el-table :data=\"caseList\" style=\"width: 100%\"&gt;\n&lt;el-table-column fixed showOverflowTooltip prop=\"case_id\" label=\"CaseID\" width=\"200px\" /&gt;\n&lt;el-table-column prop=\"case_name\" label=\"\u540d\u79f0\" /&gt;\n&lt;el-table-column prop=\"tag\" label=\"\u6807\u7b7e\" width=\"80px\" /&gt;\n&lt;el-table-column :formatter=\"formatResult\" label=\"\u7ed3\u679c\" /&gt;\n&lt;el-table-column showOverflowTooltip label=\"\u5f02\u5e38\"&gt;\n&lt;template #default=\"scope\"&gt;\n&lt;span&gt;\n              const a = get()\n            &lt;/span&gt;\n&lt;/template&gt;\n&lt;/el-table-column&gt;\n&lt;/el-table&gt;\n</code></pre>"},{"location":"front/vue/vue3-create-project/","title":"VUE3\u521b\u5efa\u9879\u76ee","text":"<p>pnpm create vite AutoTestWeb</p> <p>\u63a8\u8350\u4f7f\u7528 vite</p> <pre><code>\u221a Target directory \"AutoTestWeb\" is not empty. Remove existing files and continue? ... yes\n\u221a Package name: ... autotestweb\n\u221a Select a framework: \u00bb Vue\n\u221a Select a variant: \u00bb TypeScript\n</code></pre>"},{"location":"java/android/adb/","title":"ADB\u914d\u7f6e","text":"<p>adb shell logcat -b main -G 2M adb logcat -f /sdcard/Download/logcat.log</p>"},{"location":"java/android/adb/#_1","title":"\u7aef\u53e3\u8f6c\u53d1","text":"<p>adb reverse --remove tcp:10086 adb forward --remove tcp:10086</p> <p>adb reverse localabstract:scrcpy tcp:10086 adb forward tcp:5005 tcp:5005</p>"},{"location":"java/android/andorid-dialog-edittext/","title":"dialog\u81ea\u52a8\u5f39\u51fa\u8f6f\u952e\u76d8\u3001\u5149\u6807\u79fb\u81f3Edittext\u672b\u5c3e","text":"dialog.xml<pre><code>&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;LinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\"\nandroid:orientation=\"vertical\"\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"match_parent\"\nandroid:background=\"#ffff\"\n&gt;\n&lt;EditText\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"wrap_content\"\nandroid:id=\"@+id/dialog_edittext\" /&gt;\n&lt;/LinearLayout&gt;\n</code></pre> <p>\u5b9e\u73b0\u4ee3\u7801:</p> <pre><code>AlertDialog.Builder builder;\nbuilder = new AlertDialog.Builder(this);\nLayoutInflater inflater = getLayoutInflater();\nView view = inflater.inflate(R.layout.dialog, null);\nfinal ClearEditText addHeader  = (ClearEditText) view.findViewById(R.id.dialog_edittext);\naddHeader.setHint(\"\u6dfb\u52a0Header\");\naddHeader.setText(Utils.getValue(getApplicationContext(),Constants.header));\n//                addHeader.setText(\"378da32d78c444ce4da2f90ed529b436b8a28429\");\nbuilder.setTitle(\"\u6dfb\u52a0\u5934\u90e8:\");\nbuilder.setPositiveButton(\"\u786e\u5b9a\",\nnew DialogInterface.OnClickListener() {\n@Override\npublic void onClick(DialogInterface dialog, int which) {\n}\n});\nbuilder.setNegativeButton(\"\u53d6\u6d88\", null);\nAlertDialog alertDialog = builder.create();\nalertDialog.setView(view);\nalertDialog.setOnShowListener(new DialogInterface.OnShowListener() {\n@Override\npublic void onShow(DialogInterface dialog) {\n//\u8c03\u51fa\u952e\u76d8\nInputMethodManager manager = ((InputMethodManager) context.getSystemService(Activity.INPUT_METHOD_SERVICE));\nmanager.showSoftInput(addHeader,InputMethodManager.SHOW_IMPLICIT);\n//\u5149\u6807\u79fb\u81f3\u672b\u5c3e\u5904\nSelection.setSelection(addHeader.getText(), addHeader.length());\n}\n});\nalertDialog.show();\n</code></pre>"},{"location":"java/android/android-activity/","title":"Android Activity\u95f4\u4f20\u9012\u5bf9\u8c61","text":"<p>1\u3001\u81ea\u5b9a\u4e49\u7684model Project \u8981\u7ee7\u627fSerializable\u63a5\u53e3,Project \u7684\u6210\u5458\u53d8\u91cf\u4e2d\u82e5\u6709\u81ea\u5b9a\u4e49\u7684\u6210\u5458\u53d8\u91cf\u7c7b\u578b\uff0c\u8be5\u6210\u5458\u53d8\u91cf\u7c7b\u578b\u7c7b\u4e5f\u9700\u8981\u7ee7\u627fSerializable\u63a5\u53e3\u3002</p> <pre><code>public class Project implements Serializable {\n}\n</code></pre> <p>2\u3001\u7531MainActivity\u8df3\u8f6c\u81f3XXXActivity</p> <pre><code>Intent intent = new Intent();\nintent.putExtra(\"project\",workedList.get(position));\nintent.setClass(MainActivity.this,XXX.class);\nstartActivity(intent);\n</code></pre> <p>3\u3001XXX.java\u4e2d</p> <pre><code>Project project = (Project) getIntent().getSerializableExtra(\"project\");\n</code></pre>"},{"location":"java/android/android-amap/","title":"\u9ad8\u5fb7\u5730\u56fe\u76f8\u5173\u7b14\u8bb0","text":"<ul> <li>\u83b7\u53d6\u5f00\u53d1SHA1\uff0c\u5728AS\u4e2d\u7684Terminal\u4e2d\u8f93\u5165\u547d\u4ee4\uff1a</li> <li>\"C:Program Files\\Java\\jdk1.8.0_101\\bin\\keytool\" -list -v -keystore D:\\ykh_key.jks</li> <li></li> <li>\u5176\u4e2d\"C:Program Files\\Java\\jdk1.8.0_101\\\"  \u4e3a\u4f60\u7684Java\u5b89\u88c5\u8def\u5f84\u3002\u83b7\u53d6\u6d4b\u8bd5SHA1\uff0c\u76f4\u63a5\u5728Eclipse\u4e2dWindow-&gt;Preferences-&gt;Android-&gt;Build-&gt;SHA1 fingerprint\u67e5\u770b\u3002</li> <li>\u62f7\u8d1dso\u652f\u6301\u5e93\u7684\u4f4d\u7f6e\u4e3asrc/main/jniLibs\u6587\u4ef6\u5939\u4e0b\uff0cjniLibs\u6587\u4ef6\u5939\u9700\u8981\u65b0\u5efa\uff0c\u62f7\u8d1d\u7684\u652f\u6301\u5e93\u6709armeabi\u548carm64-v8a</li> </ul>"},{"location":"java/android/android-md/","title":"Material Design\u5361\u7247\u9634\u5f71\u3001Ripple Effect\u5b9e\u73b0","text":"<p>Material Design\u7684\u4e2d\u4f7f\u7528\u5bf9\u754c\u9762\u7684\u7ed8\u5236\u662f\u5728\u4e09\u7ef4\u5750\u6807\u4e2d\uff0c\u6bcf\u4e2a\u63a7\u4ef6\u3001\u5e03\u5c40\u90fd\u6709\u81ea\u5df1\u7684\u9ad8\u5ea6\uff0c\u901a\u8fc7\u63a7\u4ef6\u7684\u9ad8\u5ea6\u53d8\u5316\u6765\u54cd\u5e94\u7528\u6237\u7684\u64cd\u4f5c\u3002\u5177\u6709\u4ee5\u4e0b\u7279\u6027\uff1a</p> <ul> <li>\u9ad8\u89c6\u56fe\u4f1a\u8986\u76d6\u4f4e\u89c6\u56fe</li> <li>\u9ad8\u89c6\u56fe\u4f1a\u5728\u4f4e\u89c6\u56fe\u4e0a\u6295\u4e0b\u9ad8\u89c6\u56fe\u7684\u9634\u5f71</li> <li>\u76f8\u5bf9\u9ad8\u5ea6\u5dee\u8d8a\u5927\uff0c\u9634\u5f71\u4f1a\u8d8a\u663e\u8457</li> </ul> <p>\u5728FrameLayout \u4e2d\u9700\u8981\u8bbe\u7f6e\u5b83\u7684elevation\uff08\u9ad8\u5ea6\u3001\u4ef0\u89d2\uff09\u5c5e\u6027\u6765\u63a7\u5236\u63a7\u4ef6\u7684\u60ac\u6d6e\u9ad8\u5ea6\uff0c\u9700\u8981\u8bbe\u7f6e\u9875\u9762\u7684\u80cc\u666f\u8272\u4e3a\u7eaf\u767d\u8272\uff08#fff\uff09\uff0c\u5373\u53ef\u8fbe\u5230\u5c01\u9762\u56fe\u7684\u6548\u679c\u3002</p> <pre><code>&lt;FrameLayout\nandroid:elevation=\"1dp\"\nandroid:layout_marginTop=\"1dp\"\nandroid:layout_marginLeft=\"3dp\"\nandroid:layout_marginRight=\"3dp\"\nandroid:layout_marginBottom=\"2dp\"\nandroid:background=\"#fff\"\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"wrap_content\"\n&lt;/FrameLayout&gt;\n</code></pre> <p>\u70b9\u51fb\u65f6\u7684ripple effect\u9700\u8981\u540c\u65f6\u8bbe\u7f6e</p> <pre><code>android:background=\"?attr/selectableItemBackground\"\nandroid:clickable=\"true\"\n</code></pre> <p>\u624d\u80fd\u751f\u6548.</p>"},{"location":"java/android/android-mjpg/","title":"Android MJPG\u5e95\u5c42C\u6587\u4ef6\u7f16\u8bd1\u7b14\u8bb0","text":"<ol> <li>\u672c\u6b21mjpg\u914d\u7f6e\u57fa\u4e8esimplemjpegview,\u4e0b\u8f7d\u6e90\u7801\u3002</li> <li>MjpegInpiutStream.java\u6587\u4ef6\u4e2d\u5305\u542b\u4e24\u4e2anative\u4fee\u9970\u7684\u51fd\u6570pixeltobmp\u548cfreeCameraMemory\u6765\u4fee\u6539jni\u6587\u4ef6\u4e0b\u7684ImageProc\u4e2d\u7684.c\u548c.h\u6587\u4ef6\u4e2d\u5bf9\u5e94\u7684\u51fd\u6570\u540d\u4e3aJava_dreamgo_ipcamera_mjpg_MjpegInputStream_pixeltobmp\u548cJava_dreamgo_ipcamera_mjpg_MjpegInputStream_freeCameraMemory,\u5176\u4e2dJava_dreamgo_ipcamera_mjpg_\u4e3a\u8def\u5f84\u540d\u3001MjpegInputStream\u4e3a\u7c7b\u540d\u3001pixeltobmp\u4e3a\u51fd\u6570\u540d\uff0c\u9700\u8981\u6839\u636e\u5f53\u524dMjpegInputStream\u6240\u5728\u7684\u8def\u5f84\u8fdb\u884c\u8c03\u6574\u3002\u5c06ImageProc.c\u6587\u4ef6\u4e2d274\u884c\u7531 if(bmp==NULL) return ; \u6539\u4e3a if(bmp==NULL) return -1; \u4e0d\u7136\u5c06\u65e0\u6cd5\u4f7f\u7528ndk\u7f16\u8bd1\u3002</li> <li>\u5728build.gradle\u4e2d\u7684android\u6807\u7b7e\u52a0\u5165</li> <li>//\u5fc5\u987b\u8981\u52a0\u6b64\u884c \u4e0d\u8981C\u6587\u4ef6\u90e8\u5206\u4f1a\u7f16\u8bd1\u9519\u8bef</li> <li>sourceSets.main.jni.srcDirs = []</li> <li>\u5220\u9664\u6e90\u7801\u4e2d\u81ea\u5e26\u7684jniLibs\u6587\u4ef6\u5939\uff0c\u524d\u5f80http://androiddevtools.cn/\u4e0b\u8f7dandroid-ndk-r12b\u3002anroid-ndk-r13b\u65e0\u6cd5\u4f7f\u7528\u3002</li> <li>\u6309\u7167\u4e0b\u56fe\u547d\u4ee4\u5728Android Studio\u7684Terminal\u6267\u884c\uff0c\u6267\u884c\u5b8c\u6210\u540e\u5c06\u4f1a\u5728main\u6587\u4ef6\u5939\u4e0b\u751f\u6210\u5bf9\u5e94\u7684libs\u6587\u4ef6\u5939\uff0c\u5c06libs\u6587\u4ef6\u5939\u91cd\u547d\u540d\u4e3ajniLibs\u8fd0\u884c\u9879\u76ee\u5373\u53ef\u3002</li> <li>\u8fdb\u4e00\u6b65\u5c01\u88c5\u7684MJPG\u64ad\u653e\u5668\uff08\u5e26\u8ba4\u8bc1\u529f\u80fd\uff09\uff0c\u53ef\u89c1ipcam-view\u3002</li> </ol>"},{"location":"java/android/android-note/","title":"Android\u7b14\u8bb0","text":""},{"location":"java/android/android-note/#_1","title":"\u754c\u9762\u5e03\u5c40","text":""},{"location":"java/android/android-note/#appbarlayouttoolbartoolbar","title":"AppBarLayout\u4e2d\u5d4c\u5957ToolBar\u53ef\u4ee5\u4e3aToolBar\u6dfb\u52a0\u9634\u5f71\u6548\u679c","text":""},{"location":"java/android/android-note/#_2","title":"\u903b\u8f91\u63a7\u5236","text":""},{"location":"java/android/android-note/#intent","title":"intent\u6e05\u7a7a\u4efb\u52a1\u5806\u6808","text":"<pre><code>// \u6e05\u7a7a\u4efb\u52a1\u5806\u6808\nintent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);\n</code></pre>"},{"location":"java/android/android-note/#json","title":"\u6253\u5370Json\u4e2d\u6240\u6709\u7684\u5185\u5bb9","text":"<pre><code>Iterator&lt;String&gt; iter = dataJson.keys();\nwhile (iter.hasNext()) {\nString key = iter.next();\ntry {\nObject value = dataJson.get(key);\nLog.e(\"Http\", key+\" : \"+value);\n} catch (JSONException e) {\n// Something went wrong!\n}\n}\n</code></pre>"},{"location":"java/android/android-note/#_3","title":"\u8bbe\u7f6e\u6587\u672c\u5185\u5bb9\u53ef\u88ab\u9009\u4e2d","text":"<pre><code>show.setTextIsSelectable(true);\nandroid:textIsSelectable=\"true\"\n</code></pre>"},{"location":"java/android/android-note/#_4","title":"\u83b7\u53d6\u6388\u6743\u7ed3\u679c","text":"<p>Activity :</p> <pre><code>ActivityCompat.requestPermissions(this,new String[]{Manifest.permission.ACCESS_FINE_LOCATION},YOUR_REQUEST_CODE);\n</code></pre> <p>Fragment :</p> <pre><code>requestPermissions(new String[]{Manifest.permission.ACCESS_FINE_LOCATION}, YOUR_REQUEST_CODE);\n</code></pre>"},{"location":"java/android/android-note/#heap-size128","title":"\u7a81\u7834heap size\u4e3a128\u7684\u9650\u5236","text":"<p>\u5728Application\u6807\u7b7e\u4e2d\u4f7f\u7528android:largeHeap=\"true\"\u53ef\u4ee5\u7a81\u7834heap size\u4e3a128\u7684\u9650\u5236</p> <p>\u67e5\u770b\u5f53\u524dheap size:</p> <pre><code>ActivityManager manager= (ActivityManager) getSystemService(Context.ACTIVITY_SERVICE);\nint heapsize=manager.getMemoryClass();\nLogUtils.e(\"heap size is \" + heapsize);\n</code></pre>"},{"location":"java/android/android-note/#expandablelistview","title":"ExpandableListView\u6ce8\u610f\u4e8b\u9879","text":"<p><code>ExpandableListView</code>\u82e5<code>group</code>\u4e2a\u6570\u53d8\u5316\u65f6\uff0c\u4fee\u6539<code>adapter</code>\u4e2d\u6570\u636e\u548c\u5237\u65b0<code>expandableListView</code>\u754c\u9762\u9700\u8981\u5728\u540c\u4e00\u8fdb\u7a0b\u4e2d\u4f9d\u6b21\u8fdb\u884c\uff0c\u82e5\u5728\u4e3b\u754c\u9762\u4e2d\u4fee\u6539\u6570\u636e\uff0c\u5728\u65b0\u8fdb\u7a0b\u4e2d\u5237\u65b0\u754c\u9762\u4f1a\u5bfc\u81f4\u5237\u65b0\u754c\u9762\u65f6\u53d1\u751f\u6570\u7ec4\u6ea2\u51fa\u7684\u9519\u8bef\uff0ceg:\u4e00\u4e2a<code>group1</code>\u65f6\uff0c\u8be5<code>group1</code>\u6709\u4e24\u4e2a<code>child</code>\uff0c\u52a8\u6001\u52a0\u5165\u4e00\u4e2a\u65b0<code>group2</code>\uff08\u65e0<code>child</code>\uff09\u65f6\uff0c\u4f1a\u51fa\u73b0<code>group1</code>\u4e2d<code>child</code>\u4e2a\u6570\u6b21\u6570\u7ec4\u6ea2\u51fa\u9519\u8bef\uff0c\u521d\u6b65\u4f30\u8ba1\u539f\u56e0\u662f\u5237\u65b0\u754c\u9762\u65f6\u4f9d\u65e7\u4ee5\u4e3a<code>group1</code>\u6709\u4e24\u4e2a<code>child</code>\u800c\u6570\u636e\u6e90\u5df2\u6539\u53d8\u4e3a\u7a7a\u7684<code>List</code>\u800c\u51fa\u73b0\u6570\u7ec4\u6ea2\u51fa\u3002</p> <p>\u6b63\u786e\u4ee3\u7801\uff1a</p> <pre><code>lv_handler.post(new Runnable() {\n@Override\npublic void run() {\n//\u6b64\u5904\u5217\u8868\u4e2a\u6570\u53d8\u5316 \u6570\u636e\u66f4\u65b0\u548c\u754c\u9762\u53d8\u5316\u5fc5\u987b\u5728\u540c\u4e00\u7ebf\u7a0b\u4f9d\u6b21\u8fdb\u884c\nscanAdapter.is_ble_open = true;\nscanAdapter.setGroupStringsByBle();\nscanAdapter.notifyDataSetChanged();\nscanAdapter.notifyDataSetInvalidated();\nble_scan_expand.invalidateViews();\nexpandAllGroup(ble_scan_expand);\n}\n});\n</code></pre> <p>\u4f1a\u53d1\u751f\u9519\u8bef\u4ee3\u7801\uff1a</p> <pre><code>scanAdapter.is_ble_open = true;\nscanAdapter.setGroupStringsByBle();\nlv_handler.post(new Runnable() {\n@Override\npublic void run() {\nscanAdapter.notifyDataSetChanged();\nscanAdapter.notifyDataSetInvalidated();\nble_scan_expand.invalidateViews();\n}\n});\nexpandAllGroup(ble_scan_expand);\n</code></pre>"},{"location":"java/android/android-note/#fragmentstartactivityforresult","title":"<code>Fragment</code>\u4e2d\u4f7f\u7528<code>startActivityForResult</code>","text":"<pre><code>Fragement`\u5fc5\u987b\u4f7f\u7528`startActivityForResult(intent, code);`\u800c\u4e0d\u662f`getActivity().startActivityForResult(intent,111);\n</code></pre> <p><code>Fragment</code>\u6240\u5728\u7684\u7236<code>activity</code>\u5fc5\u987b\u91cd\u5199\uff08\u5fc5\u987b\u8c03\u7528super\uff09\uff1a</p> <pre><code>@Override\npublic void onActivityResult(int requestCode, int resultCode, Intent data) {\nsuper.onActivityResult(requestCode, resultCode, data);\n}\n</code></pre>"},{"location":"java/android/android-note/#_5","title":"\u83b7\u53d6\u989c\u8272","text":"<pre><code>ContextCompat.getColor(getContext(), R.color.color_xxx)\n</code></pre>"},{"location":"java/android/android-note/#ondrawnew","title":"<code>onDraw()</code>\u65b9\u6cd5\u4e2d<code>new</code>\u5bf9\u8c61","text":"<pre><code>onDraw()\u65b9\u6cd5\u4e0d\u63a8\u8350new\u5bf9\u8c61\uff0c\u56e0\u4e3a\u8be5\u65b9\u6cd5\u4f1a\u88ab\u7cfb\u7edf\u591a\u6b21\u8c03\u7528\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u5185\u5bb9\u6cc4\u9732\u3002\n&gt; [Object allocation during draw/layout?](https://stackoverflow.com/questions/16472529/object-allocation-during-draw-layout#)\n</code></pre>"},{"location":"java/android/android-note/#javautilconcurrentmodificationexception","title":"<code>java.util.ConcurrentModificationException</code>","text":"<pre><code>\u5728\u8fed\u4ee3\u8fc7\u7a0b\u4e2d`remove`\u6570\u7ec4\u5143\u7d20\u540e\u6ca1\u6709`break`\u8fed\u4ee3\uff0c\u4f1a\u629b\u51fa\u8be5\u9519\u8bef\u3002\u4e3e\u4f8b\uff1a\u82e5\u6570\u7ec4\u4e2d\u67093\u4e2a\u5143\u7d20\uff0c\u5728\u5faa\u73af\u8bfb\u53d6\u5230\u7b2c2\u4e2a\u5143\u7d20\u65f6\uff0c`remove`\u4e86\u7b2c\u4e8c\u4e2a\u5143\u7d20\u4f46\u662f\u5e76\u672a\u9000\u51fa\u5faa\u73af\uff0c\u8bfb\u53d6\u7b2c3\u4e2a\u5143\u7d20\u65f6\u4f1a\u53d1\u751f\u8be5\u9519\u8bef\u3002\u89e3\u51b3\u65b9\u6cd5\u4e3a`remove`\u540e\u7acb\u5373\u9000\u51fa\u8fed\u4ee3\u3002\n</code></pre>"},{"location":"java/android/android-note/#recycleview-item","title":"RecycleView Item\u70b9\u51fb\u4e8b\u4ef6\u65e0\u6548","text":"<ul> <li><code>RecycleView</code>\u5728<code>RelatedView</code>\u4e2d\u5207\u6362\u663e\u793a\u65f6\uff0c\u8981\u4e3a\u5176\u8bbe<code>OnItemClick</code>\u65f6\u8981\u786e\u4fdd\u5176\u4e0a\u4f20\u65e0\u5e03\u5c40\u3002</li> <li>\u5217\u8868item\u4e2d\u5185\u5c42<code>LinearLayout</code>\u8bbe\u7f6e<code>clickable=\"true\"</code>\u5e76\u5c06ID\u8d4b\u7ed9\u5916\u5c42<code>LinearLayout</code>\u4f1a\u5bfc\u81f4<code>onclick</code>\u4e8b\u4ef6\u65e0\u6cd5\u89e6\u53d1\u7684bug,\u89e3\u51b3\u65b9\u6cd5\u4e3a\u5c06<code>clickable=\"true\"</code>\u6539\u4e3a<code>focusable=\"true\"</code>\u6216\u8005\u5c06ID\u8d4b\u7ed9\u5185\u5c42<code>LinearLayout</code>\u3002</li> </ul>"},{"location":"java/android/android-note/#attrcolorprimarylight","title":"\u81ea\u5b9a\u4e49<code>attr</code>\u4e2d\u7684<code>colorPrimaryLight</code>","text":"<ul> <li>\u52a0<code>attr</code>\u6587\u4ef6</li> <li>\u5728\u4e3b<code>style</code>\u58f0\u660e\u8be5\u989c\u8272</li> <li>\u4f7f\u7528 <code>?attr/colorPrimaryLight</code></li> </ul>"},{"location":"java/android/android-note/#_6","title":"\u914d\u7f6e\u76f8\u5173","text":""},{"location":"java/android/android-note/#android-sdk","title":"Android SDK\u66f4\u65b0","text":"<pre><code>setting-&gt;\u641c\u7d22SDK-&gt;\u9009\u62e9SDK tools\u8fdb\u884c\u66f4\u65b0\n\n\u66f4\u65b0\u5b8c\u6210\u5237\u65b0\u9879\u76ee\u5373\u53ef\n</code></pre>"},{"location":"java/android/android-note/#errorfailed-to-open-zip-file-gradles-dependency-cache-may-be-corrupt","title":"<code>Error:Failed to open zip file. Gradle's dependency cache may be corrupt</code>","text":"<pre><code>* \u524d\u5f80\u4e0b\u8f7d\u5bf9\u5e94\u7684gradle\u6587\u4ef6\uff0c\u76f4\u63a5\u66ff\u6362url\u4e2d\u7684\u7248\u672c\u53f7\u5373\u53ef\uff0c\u5bf9\u5e94\u7684\u7248\u672c\u53f7\u53ef\u5728`gradle/gradle-wrapper.properties`\u6587\u4ef6\u4e2d\u67e5\u770b\uff0chttp://downloads.gradle.org/distributions/gradle-4.1-all.zip \u3002\n* \u4e0b\u8f7d\u5e76\u89e3\u538b\u538b\u7f29\u6587\u4ef6\u81f3 `C:\\Users\\ykh\\.gradle\\wrapper\\dists\\gradle-4.1-all`\n* File-&gt;setting-&gt;Build,Execution,Deployment-&gt;Gradle,\u9009\u62e9`Use locale gradle distribution-&gt;Gradle home`\uff0c\u9009\u4e2d\u4e4b\u524d\u89e3\u538b\u7684\u6587\u4ef6\u5939\u3002\n* File-&gt;Synchronize\n</code></pre>"},{"location":"java/android/android-note/#please-select-android-sdk","title":"Please select Android SDK","text":"<pre><code>File -&gt; Sync Project with Gradle Files\n</code></pre>"},{"location":"java/android/android-note/#grade","title":"\u5361\u5728<code>Grade</code>\u66f4\u65b0","text":"<pre><code>`File\\Settings\\Build, Execution, Deployment\\Build tools\\Gradle`\uff0c\u91cd\u9009`Grade Home`\u81f3`C:\\android-studio\\gradle\\gradle-4.1.`\u3002\n</code></pre>"},{"location":"java/android/android-note/#author-info","title":"Author Info","text":"<p>\u6253\u5f00<code>Settings -&gt; Editor -&gt; File and Code Templates -&gt; Includes -&gt; File Header</code></p> <pre><code>/**\n* Created by ${USER} on ${DATE}.\n*/\n</code></pre> <p>\u6216\u8005</p> <pre><code>#set ($USER = \"Name name\")\n#set ($COMPANY = \"company Ltd\")\n#set ($EMAIL = \"example@gmail.com\")\n\n/**\n * Created by ${USER} on ${DATE}.\n * ${COMPANY}\n * ${EMAIL}\n */\n</code></pre>"},{"location":"java/android/android-note/#preview","title":"\u5b9e\u65f6\u9884\u89c8Preview\u4e0d\u751f\u6548","text":"<p>SDK\u7684image\u672a\u5b8c\u5168\u5b89\u88c5\u6210\u529f\u53ef\u80fd\u5bfc\u81f4preview\u5931\u8d25\uff0c\u89e3\u51b3\u65b9\u6cd5\u662f\u91cd\u65b0\u9009\u62e9preview\u4f7f\u7528\u7684SDK\u7248\u672c\u6216\u8005\u5b8c\u5168\u5b89\u88c5\u8be5SDK\u5bf9\u5e94\u7684image\u3002</p>"},{"location":"java/android/android-note/#javadoc","title":"\u751f\u6210JavaDoc\u6587\u6863","text":"<pre><code>Tools-&gt;Generate JavaDoc\n</code></pre> <p><code>Locale</code>\u8bbe\u7f6e\u4e3a<code>en</code>,<code>Other command line arguments</code>\u8bbe\u7f6e\u4e3a<code>-encoding utf-8 -charset utf-8</code>\u9632\u6b62\u4e2d\u6587\u6ce8\u91ca\u62a5 \u9519\u8bef: \u7f16\u7801GBK\u7684\u4e0d\u53ef\u6620\u5c04\u5b57\u7b26\u3002</p>"},{"location":"java/android/android-note/#cannot-resolve-symbol-after-update","title":"cannot resolve symbol after update","text":"<p>\u65b9\u6cd5\u4e00\uff1aYou can do \"File\" -&gt; \"Invalidate Caches...\", and select \"Invalidate and Restart\" option to fix this.\uff08\u65e0\u6548\uff09</p> <p>\u65b9\u6cd5\u4e8c\uff1a</p> <pre><code>1 Exit from Studio\n2 Delete .idea/, build/, app/build/ directories.\n3 Start Studio.\n4 Re-setup Settings-&gt;Build tools-&gt;Gradle to use local distribution (last stable Gradle locally installed)\n5 app run failed, user File -&gt; Sync Project with Gradle Files.\n</code></pre>"},{"location":"java/android/android-note/#command-pattern","title":"Command Pattern","text":"<pre><code>public interface Command {\npublic void execute(Object data);\n}\npublic class PrintCommand implements Command {\npublic void execute(Object data) {\nshowToast(data.toString());\n}\n}\npublic static void callCommand(Command command, Object data) {\ncommand.execute(data);\n}\ncallCommand(new PrintCommand(), \"hello world\");\n</code></pre>"},{"location":"java/android/android-note/#java8","title":"Java8","text":""},{"location":"java/android/android-note/#can-be-replaced-with-method-reference","title":"can be replaced with method reference","text":"<pre><code>sendLoop(new SendLoopInterface() {\n@Override\npublic void onSend() {\nPATCH();\n}\n});\nsendLoop(this::PATCH);\n</code></pre>"},{"location":"java/android/android-studio/","title":"Android studio","text":"<p>Q\uff1agit Invocation failed Unexpected end of file from server</p> <p>A\uff1aFile -&gt; Settings -&gt; Version Control -&gt; Git -&gt; Use credential helper (set check) -&gt; push Apply button</p> <p>https://stackoverflow.com/questions/66508158/git-pull-failed-invocation-failed-unexpected-end-of-file-from-server</p>"},{"location":"java/android/android-toolbar/","title":"Android\u72b6\u6001\u680f\u900f\u660e","text":"<p>\u8981\u6c42\u6700\u4f4e\u7684API\u4e3aandroid4.4(API19)\uff0c\u8bbe\u7f6eActivity\u7684Style\u4e3a</p> <pre><code>&lt;style name=\"AppTheme.ActionBar.Transparent\" parent=\"AppTheme\"&gt;\n&lt;item name=\"windowActionBar\"&gt;false&lt;/item&gt;\n&lt;item name=\"windowNoTitle\"&gt;true&lt;/item&gt;\n&lt;item name=\"colorPrimaryDark\"&gt;@android:color/transparent&lt;/item&gt;\n&lt;item name=\"colorPrimary\"&gt;@android:color/transparent&lt;/item&gt;\n&lt;item name=\"android:windowTranslucentStatus\"&gt;true&lt;/item&gt;\n&lt;/style&gt;\n</code></pre> <p>Activity\u5bf9\u5e94\u7684\u754c\u9762\u6700\u5916\u5c42\u7684Linearlayout\u8bbe\u7f6e</p> <pre><code>android:fitsSystemWindows=\"false\"\n</code></pre> <p>\u6548\u679c\u5982\u56fe\uff1a</p> <p></p>"},{"location":"java/android/apk-builder/","title":"\u5b89\u88c5gradle","text":"<p>https://gradle.org/install/</p>"},{"location":"java/android/apk-builder/#sdkmanager","title":"\u5b89\u88c5sdkmanager","text":"<p>\u524d\u5f80 https://developer.android.google.cn/studio#command-tools \u4e0b\u8f7d\u53ea\u5305\u542b\u547d\u4ee4\u884c\u7684\u7248\u672c <pre><code>cd /home/opt\nmkdir android_sdk\ncd android_sdk\n\nunzip commandlinetools-linux-9477386_latest.zip\ncd cmdline-tools/\nmkdir tools\nmv -i * tools\n\nexport ANDROID_HOME=/home/opt/android_sdk\nexport ANDROID_SDK_ROOT=/home/opt/android_sdk/\nexport PATH=$ANDROID_HOME/cmdline-tools/tools/bin/:$PATH\nsdkmanager --list # \u67e5\u770b\u5b89\u88c5\u7684\u5305\nsdkmanager \"platforms;android-30\" # \u5b89\u88c5\u5305\n</code></pre></p>"},{"location":"java/android/apk-builder/#_1","title":"\u7f16\u8bd1","text":"<pre><code>gradlew module_name:build -x test -x lint\n./gradlew module_name:build -x test -x lint # ubuntu\u7cfb\u7edf\n</code></pre> <pre><code>./gradlew module_name:assembleDebug -x test -x lint\n./gradlew module_name:assembleDebugAndroidTest -x test -x lint\n</code></pre>"},{"location":"java/android/language/","title":"Android\u8bed\u8a00\u70ed\u5207\u6362\u65b9\u6848","text":""},{"location":"java/android/language/#_1","title":"\u65b9\u6848","text":"<p>\u7ed3\u5408\u4e4b\u524d\u505a\u8fc7\u7684\u4e24\u6b21\u4e0d\u91cd\u542fApp\u8fdb\u884c\u8bed\u8a00\u5207\u6362\u7ed9\u51fa\u5f53\u524d\u6700\u4f18\u7684\u89e3\u51b3\u65b9\u6848\u3002</p> <p>\u4e3b\u8981\u601d\u8def\u662f\u5728<code>SharedPreference</code>\u4e2d\u5b58\u50a8\u5f53\u524d\u7684\u8bed\u8a00\u73af\u5883\uff0c\u4e00\u65e6\u5207\u6362\u8bed\u8a00\uff0c\u5219\u8df3\u56de\u4e3b\u754c\u9762\uff08\u4e3b\u754c\u9762\u7684<code>launchMode</code>\u4e3a<code>singleTask</code>\uff09\uff0c\u5728onCreate\u4e2d\u5148\u8bbe\u7f6e\u8bed\u8a00\u73af\u5883\u518d\u6e32\u67d3\u9875\u9762\uff0c\u5728<code>onResume</code>\u5224\u65ad\u662f\u5426\u5237\u65b0\u8bed\u8a00\uff0c\u82e5\u5237\u65b0\u8bed\u8a00\u5219\u8c03\u7528<code>recreate()</code>\u65b9\u6cd5\u91cd\u65b0\u6e32\u67d3\u5bf9\u5e94\u8bed\u8a00\u73af\u5883\u7684\u754c\u9762\u3002</p> <ol> <li>\u5199<code>BaseActivity</code>\u57fa\u7c7b</li> </ol> <pre><code>/**\n * Created by ykh on 2017/9/8.\n * \u57fa\u7c7b\n */\npublic class BaseActivity extends AppCompatActivity {\nprotected Activity context;\n@Override\nprotected void onCreate(Bundle savedInstanceState) {\nsuper.onCreate(savedInstanceState);\ncontext = this;\n}\n/**\n     * load the language user selected\n     * 0 CHINESE 1 ENGLISH other SYSTEM\n     */\npublic void setLanguage() {\nif(Utils.hasValue(context,\"Language\")){\nint current_language  = Utils.getIntValue(context,\"Language\");\nif(current_language == 0){\nsetLang(Locale.SIMPLIFIED_CHINESE);\n}else if(current_language == 1) {\nsetLang(Locale.ENGLISH);\n}else{\nsetLang(Locale.getDefault());\n}\n}\n}\n/**\n     * set language locale\n     * @param locale locale\n     */\nprivate void setLang(Locale locale) {\n// \u83b7\u5f97res\u8d44\u6e90\u5bf9\u8c61\nResources resources = getResources();\n// \u83b7\u5f97\u8bbe\u7f6e\u5bf9\u8c61\nConfiguration config = resources.getConfiguration();\n// \u83b7\u5f97\u5c4f\u5e55\u53c2\u6570\uff1a\u4e3b\u8981\u662f\u5206\u8fa8\u7387\uff0c\u50cf\u7d20\u7b49\u3002\nDisplayMetrics dm = resources.getDisplayMetrics();\n// \u8bed\u8a00\nconfig.locale = locale;\nresources.updateConfiguration(config, dm);\n}\n}\n</code></pre> <p>\u6240\u6709\u754c\u9762\u7684\u7c7b\u5747\u7ee7\u627f<code>BaseActivity</code>,\u89c9\u5f97\u9ebb\u70e6\u53ef\u4ee5\u76f4\u63a5\u5c06<code>BaseActivity</code>\u4e2d\u7684<code>setLanguage</code>\u548c<code>setLang</code>\u65b9\u6cd5\u62f7\u8d1d\u81f3Util\u4e2d\u8c03\u7528\u3002</p> <ol> <li>\u5728<code>AndroidManifest.xm</code>l\u4e2d\u8bbe\u7f6e<code>MainActivity</code>\u7684<code>launchMode</code>\u4e3a<code>singleTask</code></li> </ol> <pre><code> &lt;activity android:name=\".ui.MainActivity\"\nandroid:screenOrientation=\"portrait\"\nandroid:launchMode=\"singleTask\"&gt;\n...\n</code></pre> <ol> <li><code>MainActivity</code>\u7ee7\u627f<code>BaseActivity</code>,\u5e76\u8bbe\u7f6e<code>onCreate</code>\u65f6\uff0c\u5728\u754c\u9762\u52a0\u8f7d\u524d\u8bbe\u7f6e\u8bed\u8a00\u73af\u5883\u3002</li> </ol> <pre><code>@Override\nprotected void onCreate(Bundle savedInstanceState) {\nsuper.onCreate(savedInstanceState);\n// \u5728\u754c\u9762\u52a0\u8f7d(setContentView\u65b9\u6cd5\u8c03\u7528\u524d)\u524d\u8bbe\u7f6e\u8bed\u8a00\u73af\u5883\nsetLanguage();\nsetContentView(R.layout.activity_main);\n}\n</code></pre> <ol> <li><code>LanguageActivity</code>\u4e2d\u5207\u6362\u8bed\u8a00\uff0c<code>SharedPreference</code>\u4e2d<code>Language</code>\u5b580\u65f6\u4e3a\u4e2d\u6587\uff0c<code>Language</code>\u5b581\u65f6\u4e3a\u82f1\u6587</li> </ol> <pre><code>@OnClick(R.id.setting_ll_language_chinese)\nvoid language_chinese() {\nUtils.putIntValue(context, \"Language\", 0);\nUtils.putBooleanValue(context, \"reset_language\", true);\nstartActivity(new Intent(LanguageActivity.this, MainActivity.class));\n}\n@OnClick(R.id.setting_ll_language_english)\nvoid language_english() {\nUtils.putIntValue(context, \"Language\", 1);\nUtils.putBooleanValue(context, \"reset_language\", true);\nstartActivity(new Intent(LanguageActivity.this, MainActivity.class));\n}\n</code></pre> <ol> <li><code>MainActivity</code> <code>onResume</code>\u4e2d\u6839\u636e<code>SharedPreference</code>\u5224\u65ad\u662f\u5426\u5207\u6362\u8bed\u8a00\u4ee5\u53ca\u5207\u6362\u81f3\u4ec0\u4e48\u8bed\u8a00\u3002</li> </ol> <pre><code>@Override\nprotected void onResume() {\nsuper.onResume();\nif (Utils.getBooleanValue(context, \"reset_language\")) {\nUtils.putBooleanValue(context, \"reset_language\", false);\n//\u91cd\u65b0\u6e32\u67d3\u754c\u9762\nrecreate();\n}\n}\n</code></pre> <p><code>recreate();</code>\u65b9\u6cd5\u4f1a\u91cd\u65b0\u6e32\u67d3\u672c\u754c\u9762\uff0c\u4f1a\u91cd\u65b0\u8c03\u7528<code>MainActivity</code>\u7684<code>onCreate</code>\u65b9\u6cd5\uff0c\u7531\u4e8e\u8bbe\u7f6e\u8bed\u8a00\u73af\u5883\u5728\u524d\uff0c\u6e32\u67d3\u754c\u9762\u5728\u540e\uff0c\u90a3\u4e48MainActivity\u7684\u754c\u9762\u5c31\u5c06\u7acb\u5373\u53d8\u4e3a\u8bbe\u7f6e\u7684\u8bed\u8a00\u73af\u5883\u5bf9\u5e94\u7684\u754c\u9762\u3002</p> <p>\u81f3\u6b64\u70ed\u66f4\u65b0Android App\u8bed\u8a00\u73af\u5883\u4ecb\u7ecd\u5b8c\u6210</p>"},{"location":"java/android/language/#iso-639-1","title":"<code>ISO 639-1</code> \u5bf9\u7167\u8868","text":"<pre><code>Language / Locale                 Supported since version\n\nEnglish, US (en_US)               1.1\nGerman, Germany (de_DE)           1.1\nChinese, PRC (zh_CN)              1.5\nChinese, Taiwan (zh_TW)           1.5\nCzech, Czech Republic (cs_CZ)     1.5\nDutch, Belgium (nl_BE)            1.5\nDutch, Netherlands (nl_NL)        1.5\nEnglish, Australia (en_AU)        1.5\nEnglish, Britain (en_GB)          1.5\nEnglish, Canada (en_CA)           1.5\nEnglish, New Zealand (en_NZ)      1.5\nEnglish, Singapore(en_SG)         1.5\nFrench, Belgium (fr_BE)           1.5\nFrench, Canada (fr_CA)            1.5\nFrench, France (fr_FR)            1.5\nFrench, Switzerland (fr_CH)       1.5\nGerman, Austria (de_AT)           1.5\nGerman, Liechtenstein (de_LI)     1.5\nGerman, Switzerland (de_CH)       1.5\nItalian, Italy (it_IT)            1.5\nItalian, Switzerland (it_CH)      1.5\nJapanese (ja_JP)                  1.5\nKorean (ko_KR)                    1.5\nPolish (pl_PL)                    1.5\nRussian (ru_RU)                   1.5\nSpanish (es_ES)                   1.5\nArabic, Egypt (ar_EG)             2.3\nArabic, Israel (ar_IL)            2.3\nBulgarian, Bulgaria (bg_BG)       2.3\nCatalan, Spain (ca_ES)            2.3\nCroatian, Croatia (hr_HR)         2.3\nDanish, Denmark(da_DK)            2.3\nEnglish, India (en_IN)            2.3\nEnglish, Ireland (en_IE)          2.3\nEnglish, Zimbabwe (en_ZA)         2.3\nFinnish, Finland (fi_FI)          2.3\nGreek, Greece (el_GR)             2.3\nHebrew, Israel (iw_IL)*           2.3\nHindi, India (hi_IN)              2.3\nHungarian, Hungary (hu_HU)        2.3\nIndonesian, Indonesia (in_ID)*    2.3\nLatvian, Latvia (lv_LV)           2.3\nLithuanian, Lithuania (lt_LT)     2.3\nNorwegian-Bokm\u00e5l, Norway(nb_NO)   2.3\nPortuguese, Brazil (pt_BR)        2.3\nPortuguese, Portugal (pt_PT)      2.3\nRomanian, Romania (ro_RO)         2.3\nSerbian (sr_RS)                   2.3\nSlovak, Slovakia (sk_SK)          2.3\nSlovenian, Slovenia (sl_SI)       2.3\nSpanish, US (es_US)               2.3\nSwedish, Sweden (sv_SE)           2.3\nTagalog, Philippines (tl_PH)      2.3\nThai, Thailand (th_TH)            2.3\nTurkish, Turkey (tr_TR)           2.3\nUkrainian, Ukraine (uk_UA)        2.3\nVietnamese, Vietnam (vi_VN)       2.3\n</code></pre> <p>\u4ee5<code>English</code>\u4e3a\u4f8b\uff0c<code>code</code>\u4e3a<code>en_US</code>\uff0c\u8bed\u8a00\u6587\u4ef6\u5939\u540d\u79f0\u5e94\u4e3a<code>values-en</code>\uff0c\u83b7\u53d6<code>Locale</code>\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>Locale english = new Locale(\"en\", \"US\");\n</code></pre>"},{"location":"java/android/okhttp3/","title":"Android OkHttp3","text":""},{"location":"java/android/okhttp3/#_1","title":"\u8bf7\u6c42\u53c2\u6570","text":""},{"location":"java/android/okhttp3/#_2","title":"\u56fa\u5b9a\u6dfb\u52a0","text":"<pre><code>RequestBody requestBody = new FormBody.Builder()\n.add(\"key1\", value1)\n.build();\n</code></pre>"},{"location":"java/android/okhttp3/#_3","title":"\u52a8\u6001\u6dfb\u52a0","text":"<pre><code>FormBody.Builder builder = new FormBody.Builder();\nbuilder.add(\"key1\", value1);\n// \u6839\u636e\u8f93\u5165\u662f\u5426\u4e3a\u7a7a\u5224\u65ad\u662f\u5426\u4f20\u9012\u53c2\u6570\nif (!TextUtils.isEmpty(edittext.getText().toString())) {\nbuilder.add(\"key2\", edittext.getText().toString());\n}\n</code></pre>"},{"location":"java/android/okhttp3/#_4","title":"\u6dfb\u52a0\u6587\u4ef6","text":"<pre><code>MultipartBody.Builder builder = new MultipartBody.Builder();\nbuilder.addFormDataPart(\"key1\", value1);\nFile file = new File(path);\nbuilder.addFormDataPart(\"file_key\", file.getName(),\nRequestBody.create(MediaType.parse(\"application/octet-stream\"), file));\n//\u6ce8\u610f \u5728build\u524d\u8981setType\u4e3aMultipartBody.FORM \u4e0d\u7136\u4f1a\u53d1\u751f\u5a92\u4f53\u7c7b\u578b\u4e0d\u6b63\u786e\u9519\u8bef\nRequestBody requestBody = builder.setType(MultipartBody.FORM).build();\n</code></pre>"},{"location":"java/android/okhttp3/#_5","title":"\u8bf7\u6c42\u65b9\u6cd5","text":"<p>\u53ef\u4f7f\u7528<code>addHeader(\"key\", value)</code>\u6765\u52a8\u6001\u6dfb\u52a0<code>Header</code>\uff0c\u82e5\u53c2\u6570\u52a8\u6001\u6dfb\u52a0\uff0c\u5219\u4f7f\u7528<code>builder.build()</code>\u66ff\u4ee3<code>requestBody</code>\u5373\u53ef\u3002</p>"},{"location":"java/android/okhttp3/#get","title":"GET","text":"<pre><code>Request requestGet = new Request.Builder()\n.get()\n.url(getUrl())\n.build();\n</code></pre>"},{"location":"java/android/okhttp3/#post","title":"POST","text":"<pre><code>Request request = new Request.Builder()\n.post(requestBody)\n.addHeader(\"key\", value)\n.url(getUrl())\n.build();\n</code></pre>"},{"location":"java/android/okhttp3/#delete","title":"DELETE","text":"<pre><code>    Request request = new Request.Builder()\n.delete()\n.url(getUrl())\n.build();\n</code></pre>"},{"location":"java/android/okhttp3/#put","title":"PUT","text":"<pre><code>Request request = new Request.Builder()\n.put(requestBody)\n.url(getUrl())\n.build();\n</code></pre>"},{"location":"java/android/okhttp3/#_6","title":"\u53d1\u8d77\u8bf7\u6c42","text":"<p>\u5728<code>Activity</code>\u4e2d\uff1a</p> <pre><code>OkHttpClient okHttpClient = new OkHttpClient();\nokHttpClient.newCall(request).enqueue(new Callback() {\n@Override\npublic void onFailure(Call call, IOException e) {\nrunOnUiThread(new Runnable() {\n@Override\npublic void run() {\nshowToast(\"Network failure\");\n}\n});\n}\n@Override\npublic void onResponse(Call call, final Response response) throws IOException {\nfinal String data = response.body().string();\nrunOnUiThread(new Runnable() {\n@Override\npublic void run() {\nswitch (response.code()) {\ncase 200:\nshowToast(\"Success\");\nbreak;\ndefault:\nshowToast(\"Network success but this is some logic error\");\nbreak;\n}\n}\n});\n}\n});\n</code></pre> <p>\u5728<code>Fragment</code>\u4e2d\uff1a</p> <pre><code>public Handler handler = new Handler(Looper.getMainLooper());\nOkHttpClient okHttpClient = new OkHttpClient();\nokHttpClient.newCall(request).enqueue(new Callback() {\n@Override\npublic void onFailure(Call call, IOException e) {\nhandler.post(new Runnable() {\n@Override\npublic void run() {\nshowToast(\"Network failure\");\n}\n});\n}\n@Override\npublic void onResponse(Call call, final Response response) throws IOException {\nfinal String data = response.body().string();\nhandler.post(new Runnable() {\n@Override\npublic void run() {\nswitch (response.code()) {\ncase 200:\nshowToast(\"Success\");\nbreak;\ndefault:\nshowToast(\"Network success but this is some logic error\");\nbreak;\n}\n}\n});\n}\n});\n</code></pre>"},{"location":"java/android/okhttp3/#header","title":"\u5168\u5c40Header","text":"<p><code>HttpClient.java</code>:</p> <pre><code>import okhttp3.Interceptor;\nimport okhttp3.OkHttpClient;\nimport okhttp3.Request;\nimport okhttp3.Response;\npublic class HttpClient {\nprivate static String token = null;\nprivate static OkHttpClient client = new OkHttpClient.Builder()\n.connectTimeout(Constants.TTL, TimeUnit.MILLISECONDS)//\u8bbe\u7f6e10s\u949f\u8d85\u65f6\n.addInterceptor(new Interceptor() {\n//\u62e6\u622a\u5668 \u7528\u4e8e\u4e3a\u6bcf\u4e2arequest\u6dfb\u52a0\"Authorization\", \"Token \"+token \u4fe1\u606f\u7528\u4e8e\u670d\u52a1\u5668\u533a\u5206\u5408\u6cd5\u7528\u6237\n@Override\npublic Response intercept(Chain chain) throws IOException {\nRequest request = chain.request();\nif (token != null) {\nrequest = request.newBuilder()\n.addHeader(\"Authorization\", \"Token \" + token).build();//\u9a8c\u8bc1\u4fe1\u606f\n}\nreturn chain.proceed(request);\n}\n}).build();\npublic static void setToken(String new_token) {\ntoken = new_token;\n}\npublic static String getToken() {\nreturn token;\n}\npublic static OkHttpClient getClient() {\nreturn client;\n}\n}\n</code></pre> <p>\u8bbe\u7f6eToken:</p> <pre><code>//\u4e3aOkHttp\u7684\u5934\u90e8\u6dfb\u52a0Token\nHttpClient.setToken(access_token);\n</code></pre> <p>\u4e4b\u540e\u9700\u8981\u4f7f\u7528\u6709\u8be5Header\u7684\u8bf7\u6c42\u76f4\u63a5\u8c03\u7528\uff1a</p> <pre><code>HttpClient.getClient().newCall(request).enqueue(new Callback() {....}\n</code></pre> <p>\u4e0d\u4f7f\u7528\u6709\u8be5Header\u7684\u8bf7\u6c42\uff1a</p> <pre><code>OkHttpClient okHttpClient = new OkHttpClient();\nokHttpClient.newCall(request).enqueue(new Callback() {...}\n</code></pre>"},{"location":"java/android/pda-keyboard/","title":"Android PDA\u952e\u76d8\u903b\u8f91","text":""},{"location":"java/android/pda-keyboard/#_1","title":"\u9884\u671f\u6548\u679c","text":"<p>\u7531\u4e8ePDA\u4e0a\u6709\u5b9e\u4f53\u952e\u76d8\uff0c\u5927\u90e8\u5206\u64cd\u4f5c\u76f4\u63a5\u4f7f\u7528\u5b9e\u4f53\u952e\u76d8\u5b8c\u6210\uff0c\u4f7f\u7528\u8f6f\u952e\u76d8\u8f85\u52a9\u8f93\u5165\u3002\u70b9\u51fb\u8f93\u5165\u6846\uff0c\u53ea\u83b7\u53d6\u8f93\u5165\u6846\u7684\u7126\u70b9\u800c\u4e0d\u5f39\u51fa\u8f6f\u952e\u76d8\uff0c\u8fd9\u6837\u65b9\u4fbf\u4f7f\u7528\u5b9e\u4f53\u952e\u76d8\u8f93\u5165\u3002\u5728\u8f93\u5165\u6846\u65c1\u653e\u7f6e\u4e00\u4e2a\u6309\u94ae\uff0c\u7528\u4e8e\u63a7\u5236\u8f6f\u952e\u76d8\u7684\u5f39\u51fa\u548c\u5173\u95ed\u3002 \u529f\u80fd\u70b9\u5982\u4e0b\uff1a</p> <ul> <li>\u8f93\u5165\u6846\u83b7\u53d6\u7126\u70b9\u540e\uff0c\u4ec5\u53ef\u4f7f\u7528\u5b9e\u4f53\u952e\u76d8\u8f93\u5165\u4e0d\u5f39\u51fa\u8f6f\u952e\u76d8\u3002</li> <li>\u70b9\u51fb\u5f39\u51fa/\u6536\u8d77\u8f6f\u952e\u76d8\u6309\u94ae\u540e\uff0c\u6839\u636e\u5f53\u524d\u952e\u76d8\u72b6\u6001\u5f39\u51fa\u6216\u6536\u8d77\u8f6f\u952e\u76d8\u3002</li> <li>\u70b9\u51fb\u8f6f\u952e\u76d8\u5185\u7f6e\u7684\u6536\u8d77\u6309\u94ae\u540e\uff0c\u8981\u5b9e\u65f6\u6539\u53d8\u5f39\u51fa/\u6536\u8d77\u8f6f\u952e\u76d8\u6309\u94ae\u7684\u72b6\u6001\u3002</li> </ul>"},{"location":"java/android/pda-keyboard/#_2","title":"\u6700\u7ec8\u6548\u679c","text":"<p>\u70b9\u51fb\u8f93\u5165\u6846\u540e\uff1a</p> <p>\u4e22\u5931</p> <p>\u70b9\u51fb\u5f39\u51fa\u952e\u76d8\u6309\u94ae\u540e\uff1a</p> <p>\u4e22\u5931</p>"},{"location":"java/android/pda-keyboard/#_3","title":"\u5b9e\u73b0\u8fc7\u7a0b","text":"<p>\u5e03\u5c40\u4ee3\u7801\uff1a</p> <pre><code>&lt;!--\u5de5\u5355\u53f7--&gt;\n&lt;LinearLayout\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"wrap_content\"\nandroid:layout_marginBottom=\"4dp\"\nandroid:gravity=\"center_vertical\"\nandroid:orientation=\"horizontal\"&gt;\n&lt;TextView\nandroid:layout_width=\"wrap_content\"\nandroid:layout_height=\"wrap_content\"\nandroid:text=\"@string/prescription_work_no\"\nandroid:textColor=\"@color/holo_blue_bright\"\nandroid:textSize=\"18sp\" /&gt;\n&lt;LinearLayout\nandroid:layout_width=\"match_parent\"\nandroid:layout_height=\"wrap_content\"\nandroid:orientation=\"horizontal\"&gt;\n&lt;ykh.tisanems.utils.KeyboardEditText\nandroid:id=\"@+id/prescription_work_no_search_key\"\nandroid:layout_width=\"0dp\"\nandroid:layout_height=\"wrap_content\"\nandroid:layout_weight=\"1\"\nandroid:hint=\"@string/prescription_work_search_key\"\nandroid:imeOptions=\"actionSearch\"\nandroid:textColor=\"@color/colorAccent\"\nandroid:textColorHint=\"@color/colorPrimaryLight\" /&gt;\n&lt;ImageView\nandroid:id=\"@+id/prescription_work_no_search_keyboard\"\nandroid:layout_width=\"44dp\"\nandroid:layout_height=\"44dp\"\nandroid:padding=\"8dp\"\nandroid:src=\"@drawable/icon_keyboard\" /&gt;\n&lt;/LinearLayout&gt;\n&lt;/LinearLayout&gt;\n</code></pre> <p><code>KeyboardEditText</code> \u53ef\u4ee5\u4f7f\u7528<code>EditText</code>\u4ee3\u66ff</p> <p>\u63a7\u5236\u4ee3\u7801\uff1a</p> <pre><code>//\u76d1\u542c\u8f6f\u952e\u76d8\u53d8\u5316\nKeyboardVisibilityEvent.setEventListener(\ncontext,\nnew KeyboardVisibilityEventListener() {\n@Override\npublic void onVisibilityChanged(boolean isOpen) {\nif (!isOpen) {\nprescription_work_search_key.setInputType(InputType.TYPE_NULL);\nprescription_work_search_keyboard.setImageResource(R.drawable.icon_keyboard);\nprescription_work_no_search_key.setInputType(InputType.TYPE_NULL);\nprescription_work_no_search_keyboard.setImageResource(R.drawable.icon_keyboard);\n}\n}\n});\nprescription_work_search_key.setInputType(InputType.TYPE_NULL);\n//\u8f6f\u952e\u76d8\u5f39\u51fa\u5173\u95ed\nprescription_work_search_keyboard.setOnClickListener(new View.OnClickListener() {\n@Override\npublic void onClick(View view) {\nInputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);\nif (prescription_work_search_key.getInputType() == InputType.TYPE_NULL) {\nprescription_work_search_key.setInputType(InputType.TYPE_CLASS_TEXT);\nprescription_work_search_key.requestFocus();\nprescription_work_search_key.setSelection(prescription_work_search_key.length());\nimm.showSoftInput(prescription_work_search_key, InputMethodManager.SHOW_FORCED);\nprescription_work_search_keyboard.setImageResource(R.drawable.icon_keyboard_off);\n} else {\nprescription_work_search_key.setInputType(InputType.TYPE_NULL);\nimm.hideSoftInputFromWindow(prescription_work_search_key.getWindowToken(), 0);\nprescription_work_search_keyboard.setImageResource(R.drawable.icon_keyboard);\n}\n}\n});\n//\u8f93\u5165\u6846\u7126\u70b9\u53d8\u5316\nprescription_work_search_key.setOnFocusChangeListener(new View.OnFocusChangeListener() {\n@Override\npublic void onFocusChange(View view, boolean b) {\n// \u65e0\u8bba\u662f\u5426\u53ef\u8f93\u5165\u3001\u662f\u5426\u6709\u7126\u70b9 \u90fd\u7f6e\u4e8e\u952e\u76d8\u5173\u95ed\u72b6\u6001\nprescription_work_search_key.setInputType(InputType.TYPE_NULL);\nprescription_work_search_keyboard.setImageResource(R.drawable.icon_keyboard);\nInputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);\nimm.hideSoftInputFromWindow(prescription_work_search_key.getWindowToken(), 0);\n}\n});\n//\u5f00\u59cb\u641c\u7d22\nprescription_work_search_key.setOnKeyListener(new View.OnKeyListener() {\n@Override\npublic boolean onKey(View view, int keyCode, KeyEvent keyEvent) {\nif (keyEvent.getAction() != KeyEvent.ACTION_DOWN &amp;&amp; keyCode == KeyEvent.KEYCODE_ENTER) {\nsearchPrescriptionWork(prescription_work_search_key.getText().toString().trim());\n}\n//\u4e0d\u5931\u53bb\u7126\u70b9\nreturn false;\n}\n});\n</code></pre> <p>\u8bf4\u660e\uff1a</p> <ol> <li>\u4f7f\u7528\u5e93KeyboardVisibilityEvent\u6765\u5168\u5c40\u76d1\u542c\u8f6f\u952e\u76d8\u7684\u5f39\u51fa\u548c\u5173\u95ed\uff0c\u5173\u95ed\u65f6\u8bbe\u7f6e\u754c\u9762\u4e0a\u6240\u6709\u7684\u8f93\u5165\u6846\u7684\u8f93\u5165\u7c7b\u578b\u4e3a<code>InputType.TYPE_NULL</code>\uff0c\u5c55\u5f00/\u6536\u8d77\u8f6f\u952e\u76d8\u6309\u94ae\u72b6\u6001\u4e3a\u6536\u8d77\u3002</li> <li>\u8bbe\u7f6e\u8be5\u8f93\u5165\u6846\u7684\u8f93\u5165\u7c7b\u578b\u4e3a<code>InputType.TYPE_NULL</code>\uff0c\u4ee5\u4fdd\u8bc1\u70b9\u51fb\u540e\u80fd\u83b7\u53d6\u5230\u7126\u70b9\u4f46\u662f\u4e0d\u5c55\u5f00\u8f6f\u952e\u76d8\u3002</li> <li>\u4e3a\u5c55\u5f00/\u6536\u8d77\u8f6f\u952e\u76d8\u6309\u94ae\u8bbe\u7f6e\u70b9\u51fb\u4e8b\u4ef6\uff0c\u82e5\u5f53\u524d\u8f93\u5165\u6846\u7684\u8f93\u5165\u7c7b\u578b\u4e3a<code>InputType.TYPE_NULL</code>\u5219\u8ba4\u4e3a\u5f53\u524d\u8f6f\u952e\u76d8\u6536\u8d77\uff0c\u5219\u5c55\u5f00\u8f6f\u952e\u76d8\u5e76\u8bbe\u7f6e\u8f93\u5165\u7c7b\u578b\u4e3a<code>InputType.TYPE_CLASS_TEXT</code>\uff0c\u5426\u5219\u5219\u6536\u8d77\u952e\u76d8\u5e76\u8bbe\u7f6e\u8f93\u5165\u6846\u7c7b\u578b\u4e3a<code>InputType.TYPE_NULL</code>\u3002</li> <li>\u8bbe\u7f6e\u8f93\u5165\u6846\u7126\u70b9\u53d8\u5316\u65f6\u59cb\u7ec8\u6536\u8d77\u8f6f\u952e\u76d8\u3002</li> <li>\u4e3a\u952e\u76d8\u548c\u8f6f\u952e\u76d8\u7684<code>Enter</code>\u6309\u94ae\u7ed1\u5b9a\u4e8b\u4ef6\u3002</li> </ol>"},{"location":"java/android/scrcpy/","title":"Scrcpy\u4e8c\u6b21\u5f00\u53d1","text":""},{"location":"java/android/scrcpy/#_1","title":"\u89e3\u7801\u5668\u9009\u62e9","text":"<p>scrcpy-win64-v1.24\\scrcpy.exe --encoder _ <pre><code>[server] ERROR: Try to use one of the available encoders:\n[server] ERROR:     scrcpy --encoder 'c2.qti.avc.encoder'\n[server] ERROR:     scrcpy --encoder 'OMX.qcom.video.encoder.avc'\n[server] ERROR:     scrcpy --encoder 'c2.android.avc.encoder'\n[server] ERROR:     scrcpy --encoder 'OMX.google.h264.encoder'\n</code></pre></p> <p>MTK\u673a\u578b <pre><code>[server] ERROR: Try to use one of the available encoders:\n[server] ERROR:     scrcpy --encoder 'c2.mtk.avc.encoder'\n[server] ERROR:     scrcpy --encoder 'OMX.MTK.VIDEO.ENCODER.AVC'\n[server] ERROR:     scrcpy --encoder 'c2.android.avc.encoder'\n[server] ERROR:     scrcpy --encoder 'OMX.google.h264.encoder'\n</code></pre></p>"},{"location":"java/android/scrcpy/#_2","title":"\u7aef\u53e3\u8f6c\u53d1","text":"<p>adb reverse --remove tcp:10086 adb forward --remove tcp:10086</p> <p>adb reverse localabstract:scrcpy tcp:10086 5005\u7aef\u53e3\u7528\u4e8edebug adb forward tcp:5005 tcp:5005</p>"},{"location":"java/android/scrcpy/#_3","title":"\u4e8c\u6b21\u5f00\u53d1","text":"<p><pre><code>\u4e0b\u8f7d\u6e90\u7801\n\n\u4fee\u6539\u6743\u9650\nchmod -R 777 scrcpy\n</code></pre> \u4e3a\u652f\u6301\u5728\u8131\u79bb\u7535\u8111\u7684\u573a\u666f\u4e0b\u5bf9\u624b\u673a\u8fdb\u884c\u5f55\u5c4f\uff0c\u4e8c\u6b21\u5f00\u53d1scrcpy-server.jar\uff0c\u4e3b\u8981\u601d\u8def\u662f\u901a\u8fc7socket server\u63a7\u5236\u5f55\u5236\u7684\u542f\u52a8\u548c\u505c\u6b62\u3002 \u81ea\u52a8\u4ee5ScreenEncoder\uff0c\u5728encode\u65b9\u6cd5\u4e2d\u5c06\u6570\u636e\u5199\u5165\u81ea\u5b9a\u4e49\u7684MediaMuxer\u4e2d\u3002</p>"},{"location":"java/android/scrcpy/#_4","title":"\u6253\u5305","text":"<p>\u5148\u6309\u7167\u6e90\u7801\u4e2dbuild.md\u7684\u8981\u6c42\u5b89\u88c5\u4f9d\u8d56\u5e93\uff0c\u4f7f\u7528ubuntu18.04\u8fdb\u884c\u6253\u5305\u3002 <pre><code>\u5bfc\u5165\u73af\u5883\u53d8\u91cf\nexport ANDROID_SDK_ROOT=/home/yinkh/Android/Sdk\n\u6253\u5305\u5de5\u5177\u914d\u7f6e server_debugger=true\u6307\u5b9a\u4e3a\u8c03\u8bd5\u6a21\u5f0f\nmeson x --buildtype=release --strip -Db_lto=true -Dserver_debugger=true\n\u6253\u5305 \u6587\u4ef6\u8f93\u51fa\u81f3x\u6587\u4ef6\u5939\nninja -Cx\n</code></pre></p>"},{"location":"java/android/scrcpy/#_5","title":"\u6267\u884c","text":"<pre><code>\u624b\u673a\nCLASSPATH=/sdcard/scrcpy-server.jar app_process / com.genymobile.scrcpy.api.ApiServer\n\u7535\u8111\nadb shell CLASSPATH=/sdcard/scrcpy-server.jar app_process / com.genymobile.scrcpy.api.ApiServer\n</code></pre> <p>\u4e0b\u9762\u7684\u90fd\u5728\u975eroot\u4e0b\u64cd\u4f5c  <pre><code>meson build-auto --buildtype=release --strip -Db_lto=true -Dserver_debugger=true\n-Dprebuilt_server=scrcpy-server cd build-auto ninja\n\nCLASSPATH=/sdcard/scrcpy-server.jar app_process / com.genymobile.scrcpy.Server\n</code></pre></p>"},{"location":"java/android/todo-sync/","title":"Android\u79bb\u7ebf\u6570\u636e\u540c\u6b65\u7b56\u7565","text":""},{"location":"java/android/todo-sync/#_1","title":"\u9700\u6c42","text":"<p>\u6700\u8fd1\u505a\u4e86\u4e2aTodo\u7c7b\u7684android\u5ba2\u6237\u7aef,\u5ba2\u6237\u9700\u8981\u5ba2\u6237\u7aef\u53ef\u4ee5\u79bb\u7ebf\u4f7f\u7528\uff0c\u5e76\u4e14\u5f53\u5ba2\u6237\u7aef\u518d\u6b21\u8fde\u63a5\u5230\u670d\u52a1\u7aef\u65f6\uff0c\u9700\u8981\u5c06\u6570\u636e\u540c\u6b65\u81f3\u670d\u52a1\u7aef\uff0c\u5e76\u4e14\u8981\u652f\u6301\u591a\u7ec8\u7aef\u540c\u4e00\u8d26\u53f7\u540c\u65f6\u767b\u5f55\u64cd\u4f5c\u3002\u8fd9\u4e2a\u9700\u6c42\u548c\u5370\u8c61\u7b14\u8bb0\u5341\u5206\u76f8\u4f3c\uff0c\u5728\u7f51\u4e0a\u4e5f\u68c0\u7d22\u4e86\u8bb8\u591a\u76f8\u5173\u7684\u8d44\u6599\uff0c\u4f46\u57fa\u672c\u4e0a\u90fd\u5e2e\u52a9\u4e0d\u5927\u3002\u6700\u540e\u53ea\u597d\u81ea\u5df1\u6784\u601d\u8bbe\u8ba1\uff0c\u5728\u8fd9\u91cc\u8bb0\u5f55\u4e0b\u8be5\u9700\u6c42\u7684\u5b9e\u73b0\u601d\u8def\u548c\u6838\u5fc3\u4ee3\u7801\u3002</p>"},{"location":"java/android/todo-sync/#_2","title":"\u5b9e\u73b0\u601d\u8def","text":"<ol> <li>android\u5ba2\u6237\u7aef\u8981\u80fd\u591f\u79bb\u7ebf\u4f7f\u7528\uff0c\u8fd9\u5c31\u8981\u6c42android\u5ba2\u6237\u7aef\u80fd\u591f\u5728\u672c\u5730\u7ba1\u7406\u6570\u636e\uff0c\u5728\u8fd9\u91cc\u91c7\u7528Sqlite\uff0c\u7ecf\u8fc7\u5bf9\u6bd4\u540e\u91c7\u7528Suger ORM\u3002</li> <li>android\u5ba2\u6237\u7aef\u79bb\u7ebf\u64cd\u4f5c\u7684\u6570\u636e\u8981\u652f\u6301\u591a\u7aef\u767b\u5f55 \uff0c\u4e3a\u4e86\u9632\u6b62\u5728\u672c\u5730\u751f\u6210\u7684\u6570\u636e\u4e3b\u952e\u548c\u5176\u4ed6\u79bb\u7ebf\u5ba2\u6237\u7aef\u751f\u6210\u7684\u6570\u636e\u4e3b\u952e\u51b2\u7a81\uff0c\u90a3\u4e48\u6570\u636e\u4e3b\u952e\u4fbf\u4e0d\u9002\u5408\u4f7f\u7528\u81ea\u589eINT\u6765\u5b9e\u73b0\uff0c\u8fd9\u91cc\u91c7\u7528UUID4\u4f5c\u4e3a\u6570\u636e\u8868\u4e3b\u952e\u3002</li> <li>\u79bb\u7ebf\u64cd\u4f5c\u7684\u6570\u636e\u8981\u7edf\u4e00\u7531\u524d\u53f0ui\u53d1\u9001\u81f3\u540e\u53f0service\uff0c\u518d\u7531\u5f53\u524d\u7f51\u7edc\u72b6\u6001\u6765\u5224\u65ad\u5f53\u524d\u52a8\u4f5c\u7684\u64cd\u4f5c\u903b\u8f91\uff0c\u4e3a\u4e86\u660e\u786e\u5904\u7406\u903b\u8f91\u3002\u4f7f\u7528EventBus\u4f5c\u4e3a\u6d88\u606f\u603b\u7ebf\u6765\u8d1f\u8d23\u4f20\u9012\u6570\u636e\u64cd\u4f5c\u3001ui\u53d8\u5316\u7b49\u64cd\u4f5c\u6d88\u606f\u3002</li> <li>\u79bb\u7ebf\u6570\u636e\u518d\u518d\u6b21\u8054\u7f51\u65f6\u8981\u548c\u670d\u52a1\u5668\u5f53\u524d\u6570\u636e\u8fdb\u884c\u6bd4\u5bf9\uff0c\u8981\u8bb0\u5f55\u6570\u636e\u6700\u540e\u4e00\u6b21\u64cd\u4f5c\u7684\u65f6\u95f4\u4f5c\u4e3a\u6570\u636e\u7684\u662f\u5426\u9700\u8981\u66f4\u65b0\u7684\u51ed\u8bc1\u3002\u5177\u4f53\u5904\u7406\u903b\u8f91\u5982\u4e0b\uff1a</li> </ol> \u573a\u666f \u64cd\u4f5c \u672c\u5730\u6709\u6570\u636eA\uff0c\u670d\u52a1\u5668\u6ca1\u6709\u6570\u636eA \u5411\u670d\u52a1\u5668\u65b0\u589e\u6570\u636eA \u672c\u5730\u6ca1\u6709\u6570\u636eA\uff0c\u670d\u52a1\u5668\u6709\u6570\u636eA \u5411\u670d\u52a1\u5668\u5220\u9664\u6570\u636eA \u670d\u52a1\u5668\u548c\u672c\u5730\u5747\u6709\u6570\u636eA\uff0c\u670d\u52a1\u5668\u8bb0\u5f55\u7684\u66f4\u65b0\u65f6\u95f4\u66f4\u665a \u6570\u636eA\u7531\u670d\u52a1\u5668\u5411\u672c\u5730\u66f4\u65b0 \u670d\u52a1\u5668\u548c\u672c\u5730\u5747\u6709\u6570\u636eA\uff0c\u670d\u52a1\u5668\u8bb0\u5f55\u7684\u66f4\u65b0\u65f6\u95f4\u66f4\u65e9 \u6570\u636eA\u7531\u672c\u5730\u5411\u670d\u52a1\u5668\u66f4\u65b0 \u670d\u52a1\u5668\u548c\u672c\u5730\u5747\u6709\u6570\u636eA\uff0c\u4e24\u7aef\u66f4\u65b0\u65f6\u95f4\u76f8\u540c \u4e0d\u5904\u7406 <ol> <li>\u672c\u5730\u6570\u636e\u6a21\u578b\u4e2d\u8bb0\u5f55\u5982\u4e0b\u4e09\u4e2a\u5b57\u6bb5\uff0c\u7528\u4e8e\u533a\u5206\u6570\u636e\u6700\u8fd1\u8fdb\u884c\u7684\u64cd\u4f5c\u3002</li> </ol> <pre><code>private Boolean isCreate = false;\nprivate Boolean isUpdate = false;\nprivate Boolean isDelete = false;\n</code></pre>"},{"location":"java/android/todo-sync/#_3","title":"\u6838\u5fc3\u4ee3\u7801","text":"<pre><code>/**\n* \u540c\u6b65\u6570\u636e\n*/\npublic void sync() {\nLogger.i(\"Start sync category\");\nif (!Utils.isNetworkConnected(this)) {\nLogger.w(\"End sync category, because network is not connected!\");\nreturn;\n}\n// step1 \u5411\u670d\u52a1\u5668\u65b0\u589e\u672c\u5730\u65b0\u589e\nList&lt;Category&gt; categoryCreateList = Category.find(Category.class, \"IS_CREATE = ?\", \"1\");\nfor (Category category : categoryCreateList) {\naddCategory(category);\n}\n// step2 \u5411\u670d\u52a1\u5668\u5220\u9664\u672c\u5730\u5220\u9664\nList&lt;Category&gt; categoryDeleteList = Category.find(Category.class, \"IS_DELETE = ?\", \"1\");\nfor (Category category : categoryDeleteList) {\ndeleteCategory(category);\n}\nRequest request = new Request.Builder()\n.get()\n.url(Constants.CategorySyncList)\n.build();\nHttpClientUtil.getClient().newCall(request).enqueue(new Callback() {\n@Override\npublic void onFailure(Call call, IOException e) {\nLogger.e(\"Category onFailure\");\n}\n@Override\npublic void onResponse(Call call, final Response response) throws IOException {\nfinal String data = response.body().string();\nswitch (response.code()) {\ncase 200:\nLogger.json(data);\nGson gson = new Gson();\n// \u670d\u52a1\u7aef\u6570\u636e\nList&lt;Category&gt; categoryServerList = gson.fromJson(data, new TypeToken&lt;List&lt;Category&gt;&gt;() {\n}.getType());\nList&lt;String&gt; categoryServerIdList = new ArrayList&lt;&gt;();\nfor (Category category : categoryServerList) {\ncategoryServerIdList.add(category.getUuid());\n}\n// \u672c\u5730\u6570\u636e\nList&lt;Category&gt; categoryDbList = Category.listAll(Category.class);\nHashMap&lt;String, String&gt; categoryDbIdList = new HashMap&lt;&gt;();\nfor (Category category : categoryDbList) {\ncategoryDbIdList.put(category.getUuid(), category.getUpdate_time());\n}\nfor (Category categoryServer : categoryServerList) {\nif (!categoryDbIdList.keySet().contains(categoryServer.getUuid())) {\n// step3 \u670d\u52a1\u5668\u6bd4\u672c\u5730\u591a\u7684\uff0c\u5411\u672c\u5730\u65b0\u589e\nLogger.i(\"need to add \" + categoryServer.getUuid());\ncategoryServer.save();\n} else {\nCategory categoryDb = Category.findByUUID(categoryServer.getUuid());\nswitch (Utils.timeEqual(categoryServer.getUpdate_time(), categoryDbIdList.get(categoryServer.getUuid()))) {\ncase 0:\n// step5.1 \u66f4\u65b0\u65f6\u95f4\u76f8\u540c\u7684\u4e0d\u5904\u7406\nLogger.i(\"not change \" + categoryServer.getUuid());\nbreak;\ncase 1:\n// step5.2 \u672c\u5730\u6bd4\u670d\u52a1\u5668\u66f4\u65b0\u65f6\u95f4\u665a\u7684\uff0c\u5411\u670d\u52a1\u5668\u66f4\u65b0\nLogger.i(\"server_time:%s local_time:%s, need to update %s to server\", categoryServer.getUpdate_time(),\ncategoryDbIdList.get(categoryServer.getUuid()), categoryServer.getUuid());\nif (categoryDb != null) {\nupdateCategory(categoryDb);\n}\nbreak;\ncase -1:\n// step5.3 \u672c\u5730\u6bd4\u670d\u52a1\u5668\u66f4\u65b0\u65f6\u95f4\u65e9\u7684\uff0c\u5411\u672c\u5730\u66f4\u65b0\nLogger.i(\"server_time:%s local_time:%s, need to update %s to local\", categoryServer.getUpdate_time(),\ncategoryDbIdList.get(categoryServer.getUuid()), categoryServer.getUuid());\nif (categoryDb != null) {\ncategoryServer.setId(categoryDb.getId());\ncategoryServer.save();\n}\nbreak;\ndefault:\nbreak;\n}\n}\n}\nfor (Category categoryDb : categoryDbList) {\nif (!categoryServerIdList.contains(categoryDb.getUuid())) {\n// step4 \u670d\u52a1\u5668\u6bd4\u672c\u5730\u5c11\u7684\uff0c\u4ece\u672c\u5730\u5220\u9664\ncategoryDb.delete();\n}\n}\nbreak;\ndefault:\nbreak;\n}\n// step6 \u540c\u6b65UI\nSync sync = new Sync(\"category_list\");\nEventBus.getDefault().post(sync);\nLogger.i(\"End sync category\");\n}\n});\n}\n</code></pre> <p>Todo: for then if \u53ef\u4ee5\u4f18\u5316\u4e3a\u53d6\u5dee\u96c6\u3001\u8865\u96c6\u3002</p>"},{"location":"java/android/viewpager/","title":"Android ViewPager\u603b\u7ed3","text":""},{"location":"java/android/viewpager/#_1","title":"\u8bbe\u7f6e\u7f13\u5b58\u9875\u6570","text":"<pre><code>vievPager.setOffscreenPageLimit(1)\n</code></pre> <p>\u6700\u5c0f\u503c\u4e3a1\uff0c\u4e0d\u53ef\u4e3a0; \u60f3\u4e0d\u9884\u52a0\u8f7d\u4e0b\u4e00\u9875\u6570\u636e\uff0c\u53c2\u89c1 \u61d2\u52a0\u8f7d \u90e8\u5206\u3002</p>"},{"location":"java/android/viewpager/#_2","title":"\u8bbe\u7f6e\u7981\u6b62\u6ed1\u52a8","text":"<pre><code>import android.content.Context;\nimport android.support.v4.view.ViewPager;\nimport android.util.AttributeSet;\nimport android.view.MotionEvent;\n/**\n* Created by ykh on 2016/7/11.\n*/\npublic class CustomViewPager extends ViewPager {\nprivate boolean isCanScroll = true;\npublic CustomViewPager(Context context) {\nsuper(context);\n}\npublic CustomViewPager(Context context, AttributeSet attrs) {\nsuper(context, attrs);\n}\npublic void setCanScroll(boolean isCanScroll) {\nthis.isCanScroll = isCanScroll;\n}\n// \u53ea\u91cd\u5199\u8be5\u65b9\u6cd5\u65e0\u6cd5\u7981\u7528\n@Override\npublic boolean onTouchEvent(MotionEvent event) {\nreturn this.isCanScroll &amp;&amp; super.onTouchEvent(event);\n}\n// \u8fd8\u9700\u8981\u91cd\u5199\u672c\u65b9\u6cd5\n@Override\npublic boolean onInterceptTouchEvent(MotionEvent event) {\nreturn this.isCanScroll &amp;&amp; super.onInterceptTouchEvent(event);\n}\n}\n</code></pre> <p>\u7528\u6cd5\uff1a</p> <pre><code>//\u5141\u8bb8viewpager\u5de6\u53f3\u6ed1\u52a8\nviewPager.setCanScroll(true);\n//\u7981\u6b62viewpager\u5de6\u53f3\u6ed1\u52a8\nviewPager.setCanScroll(false);\n</code></pre> <p>\u4e0d\u91cd\u5199onInterceptTouchEvent\u65b9\u6cd5\u4f1a\u5bfc\u81f4\u7981\u6b62\u6ed1\u52a8\u65f6\u7528\u6237\u53ef\u4ee5\u6162\u6162\u7684\u4e00\u70b9\u70b9\u7684\u5212\u51fa\u4e0b\u4e00\u9875\u7684\u4e00\u591a\u534a\u9875\u9762\u7684\u60c5\u51b5\u3002</p> <p>\u65b9\u6cd5\u5177\u4f53\u610f\u4e49\u89c1\u300aAndroid\u5f00\u53d1\u827a\u672f\u63a2\u8ba8\u300bP141\u3002</p>"},{"location":"java/android/viewpager/#_3","title":"\u61d2\u52a0\u8f7d","text":"<p>\u82e5\u4e0d\u63a7\u5236\u9884\u52a0\u8f7d\uff1a</p> <pre><code>@Override\npublic void onViewCreated(View view, Bundle savedInstanceState) {\ninitView();\nsuper.onViewCreated(view, savedInstanceState);\n}\n</code></pre> <p>\u82e5\u63a7\u5236\u9884\u52a0\u8f7d\uff1a package ykh.viewpagerdemo;</p> <pre><code>import android.content.Context;\nimport android.os.Handler;\nimport android.os.Looper;\nimport android.support.v4.app.Fragment;\nimport android.widget.Toast;\n/**\n * Created by ykh on 2018/6/09.\n */\npublic abstract class BaseFragment extends Fragment {\n/**\n     * Fragment\u5f53\u524d\u72b6\u6001\u662f\u5426\u53ef\u89c1\n     */\nprotected boolean isVisible;\n@Override\npublic void setUserVisibleHint(boolean isVisibleToUser) {\nsuper.setUserVisibleHint(isVisibleToUser);\nif (getUserVisibleHint()) {\nisVisible = true;\nonVisible();\n} else {\nisVisible = false;\nonInvisible();\n}\n}\n/**\n     * \u53ef\u89c1\n     */\nprotected void onVisible() {\nonViewLoad();\n}\n/**\n     * \u4e0d\u53ef\u89c1\n     */\nprotected void onInvisible() {\nonViewLost();\n}\n/**\n     * \u5ef6\u8fdf\u52a0\u8f7d\n     * \u5b50\u7c7b\u5fc5\u987b\u91cd\u5199\u6b64\u65b9\u6cd5\n     */\nprotected abstract void onViewLoad();\nprotected abstract void onViewLost();\n}\n</code></pre> <p>\u5b50<code>Fragment</code>\u7ee7\u627f<code>BaseFragment</code>,\u9700\u8981\u6ce8\u610f\u7684\u662f<code>onViewLoad</code>\u7684\u8c03\u7528\u987a\u5e8f\u5728<code>onViewCreated</code>\u4e4b\u524d\uff0c\u4e5f\u5c31\u662f\u8bf4\u7b2c\u4e00\u6b21\u6570\u636e\u52a0\u8f7d\u7684\u65f6\u5019\uff0c\u53ef\u89c1\u7684\u9875\u9762\u5728<code>onViewCreated</code>\u65b9\u6cd5\u4e2d<code>initView</code>\uff0c\u4e0d\u53ef\u89c1\u7684\u9875\u9762\u5728<code>onViewLoad\u4e2dinitView</code>\u52a0\u8f7d\u6570\u636e\u3002\u5b9e\u4f8b\uff1a</p> <pre><code>import android.app.Activity;\nimport android.content.Context;\nimport android.os.Bundle;\nimport android.view.LayoutInflater;\nimport android.view.View;\nimport android.view.ViewGroup;\nimport android.widget.TextView;\npublic class ListFragment extends BaseFragment {\nprivate boolean is_init = false;\nprivate Activity activity;\nprivate View layout;\nprivate String name_str;\nprivate TextView name;\nprivate int count = 0;\n@Override\npublic View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {\nactivity = this.getActivity();\nlayout = activity.getLayoutInflater().inflate(R.layout.fragment_todo_list, container, false);\nBundle bundle = this.getArguments();\nif (bundle != null) {\nname_str = bundle.getString(\"name\", \"\");\n}\nreturn layout;\n}\n@Override\npublic void onViewCreated(View view, Bundle savedInstanceState) {\nif (isVisible) {\ninitView();\n}\nsuper.onViewCreated(view, savedInstanceState);\n}\npublic void initView() {\nif (!is_init) {\nLogger.i(\"initView \" + name_str);\ncount++;\nname = (TextView) layout.findViewById(R.id.name);\nname.setText(name_str + \" Pager Loaded Times:\" + count);\n// \u61d2\u52a0\u8f7d\u6570\u636e\u7684\u5730\u65b9\nis_init = true;\n}\n}\n@Override\nprotected void onViewLoad() {\nLogger.i(\"onViewLoad \" + name_str + activity);\nif (activity != null) {\ninitView();\n}\n}\n@Override\nprotected void onViewLost() {\n}\n@Override\npublic void onDestroyView() {\nsuper.onDestroyView();\nis_init = false;\n}\n}\n</code></pre>"},{"location":"java/android/viewpager/#fragmentpageradapterfragmentstatepageradapter","title":"<code>FragmentPagerAdapter</code>\u548c<code>FragmentStatePagerAdapter</code>\u7684\u533a\u522b","text":"<p>\u4f7f\u7528 <code>FragmentPagerAdapter</code> \u65f6\uff0c<code>ViewPager</code> \u4e2d\u7684\u6240\u6709 <code>Fragment</code> \u5b9e\u4f8b\u5e38\u9a7b\u5185\u5b58\uff0c\u5f53 Fragment \u53d8\u5f97\u4e0d\u53ef\u89c1\u65f6\u4ec5\u4ec5\u662f\u89c6\u56fe\u7ed3\u6784\u7684\u9500\u6bc1\uff0c\u5373\u8c03\u7528\u4e86 <code>onDestroyView</code> \u65b9\u6cd5\u3002\u7531\u4e8e <code>FragmentPagerAdapter</code> \u5185\u5b58\u6d88\u8017\u8f83\u5927\uff0c\u6240\u4ee5\u9002\u5408\u5c11\u91cf\u9759\u6001\u9875\u9762\u7684\u573a\u666f\u3002</p> <p>\u4f7f\u7528 <code>FragmentStatePagerAdapter</code> \u65f6\uff0c\u5f53 <code>Fragment</code> \u53d8\u5f97\u4e0d\u53ef\u89c1\uff0c\u4e0d\u4ec5\u89c6\u56fe\u5c42\u6b21\u9500\u6bc1\uff0c\u5b9e\u4f8b\u4e5f\u88ab\u9500\u6bc1\uff0c\u5373\u8c03\u7528\u4e86<code>onDestroyView</code> \u548c <code>onDestroy</code> \u65b9\u6cd5\uff0c\u4ec5\u4ec5\u4fdd\u5b58 <code>Fragment</code> \u72b6\u6001\u3002\u76f8\u6bd4\u800c\u8a00\uff0c <code>FragmentStatePagerAdapter</code> \u5185\u5b58\u5360\u7528\u8f83\u5c0f\uff0c\u6240\u4ee5\u9002\u5408\u5927\u91cf\u52a8\u6001\u9875\u9762\uff0c\u6bd4\u5982\u6211\u4eec\u5e38\u89c1\u7684\u65b0\u95fb\u5217\u8868\u7c7b\u5e94\u7528\u3002</p> <p>Android Fragment\uff0bViewPager \u7ec4\u5408\uff0c\u4e00\u4e9b\u4f60\u4e0d\u53ef\u4e0d\u77e5\u7684\u6ce8\u610f\u4e8b\u9879</p>"},{"location":"java/android/viewpager/#viewpagerfragment","title":"\u66ff\u6362ViewPager\u4e2dFragment\u65e0\u6548\u95ee\u9898","text":""},{"location":"java/android/viewpager/#fragmentpageradapterviewpagerfragment","title":"FragmentPagerAdapter\u5185\u7f6e\u7f13\u5b58\u5bfc\u81f4\u66ff\u6362ViewPager\u4e2dFragment\u65e0\u6548\u95ee\u9898","text":"<p>\u904d\u5386<code>FragmentPagerAdapter</code>\u6e90\u4ee3\u7801\u53ef\u89c1<code>instantiateItem</code>\u51fd\u6570\uff0c\u5176\u6839\u636e<code>getItemId(position)</code>\u51fd\u6570\u6765\u5f97\u5230<code>itemId</code>\uff0c\u518d\u6839\u636e\u6839\u636e<code>makeFragmentName(container.getId(), itemId)</code>\u6765\u83b7\u53d6<code>itemId</code>\u5bf9\u5e94\u7684<code>name</code>,\u518d\u6839\u636e<code>findFragmentByTag(name)</code>\u6765\u5224\u65ad\u5f53\u524d<code>fragment</code>\u662f\u5426\u5df2\u7ecf\u5b58\u5728\uff0c\u5df2\u5b58\u5728\u5219\u76f4\u63a5\u4f7f\u7528\uff0c\u4e0d\u5b58\u5728\u5219\u8c03\u7528<code>getItem(position)</code>\u51fd\u6570\u6765\u91cd\u65b0\u751f\u6210\u3002</p> <pre><code>@SuppressWarnings(\"ReferenceEquality\")\n@Override\npublic Object instantiateItem(ViewGroup container, int position) {\nif (mCurTransaction == null) {\nmCurTransaction = mFragmentManager.beginTransaction();\n}\nfinal long itemId = getItemId(position);\n// Do we already have this fragment?\nString name = makeFragmentName(container.getId(), itemId);\nFragment fragment = mFragmentManager.findFragmentByTag(name);\nif (fragment != null) {\nif (DEBUG) Log.v(TAG, \"Attaching item #\" + itemId + \": f=\" + fragment);\nmCurTransaction.attach(fragment);\n} else {\nfragment = getItem(position);\nif (DEBUG) Log.v(TAG, \"Adding item #\" + itemId + \": f=\" + fragment);\nmCurTransaction.add(container.getId(), fragment,\nmakeFragmentName(container.getId(), itemId));\n}\nif (fragment != mCurrentPrimaryItem) {\nfragment.setMenuVisibility(false);\nfragment.setUserVisibleHint(false);\n}\nreturn fragment;\n}\n</code></pre>"},{"location":"java/android/viewpager/#_4","title":"\u641c\u7d22\u5f97\u5230\u7684\u89e3\u51b3\u65b9\u6cd5","text":"<ul> <li>\u65b9\u6cd5\u4e00\uff1a\u91cd\u5199<code>adapter</code>\u7684<code>getItemPosition()</code>\u65b9\u6cd5\u5982\u4e0b\uff1a</li> </ul> <pre><code>public int getItemPosition(Object object) {\nreturn POSITION_NONE;\n}\n</code></pre> <p>\u5f53\u8c03\u7528<code>notifyDataSetChanged()</code>\u7684\u65f6\u5019\u3002<code>ViewPager</code>\u4f1a<code>remove</code>\u6389\u5168\u90e8\u7684<code>view</code>\uff0c\u7136\u540e\u53c8\u4e00\u6b21\u53bb\u8f7d\u5165\u3002\u53ef\u884c\uff0c\u53ef\u662f\u6548\u7387\u4f4e\u3002</p> <p>\u8be6\u89c1\u6b64\u5904</p> <ul> <li>\u65b9\u6cd5\u4e8c\uff1a\u66b4\u529b\u5220\u9664<code>fragment</code>,\u65b9\u6cd5\u5982\u4e0b\uff1a</li> </ul> <pre><code>List&lt;Fragment&gt; fragments = getSupportFragmentManager(0.getFragments();\nfor(int i=0;i&lt;fragments.size();i++){\ngetSupportFragmentManager().beginTransaction().remove(fragments.get(i));\n}\n</code></pre> <ul> <li> <p>\u65b9\u6cd5\u4e09\uff1a\u91cd\u5199<code>FragmentPagerAdapter</code>\u7684<code>instantiateItem</code>\u65b9\u6cd5\u3002</p> </li> <li> <p>\u65b9\u6cd5\u56db\uff1a\u91cd\u5199<code>getItemId</code>\u5982\u4e0b\uff1a</p> </li> </ul> <pre><code>public long getItemId(int position) {\nreturn registeredFragments.get(position).hashCode();\n}\n</code></pre> <p>FragmentPagerAdapter\u91cc\u5728\u6839\u636egetItemId(int position)\u6765\u5224\u65ad\u5f53\u524dposition\u91ccFragment\u662f\u5426\u5b58\u5728\uff0c\u5982\u679c\u5b58\u5728\uff0c\u5219\u4e0d\u4f1a\u521b\u5efa\u4ea6\u4e0d\u4f1a\u66f4\u65b0\uff0c\u90a3\u4e48\u8981\u8ba9FragmentPagerAdapter\u7684\u66f4\u65b0\u751f\u6548\uff0c\u90a3\u5728getItemId(int)\u91cc\u6839\u636e\u6570\u636e\u8fd4\u56de\u4e00\u4e2a\u552f\u4e00\u7684\u6570\u636eID\uff0c\u5f53FragmentPagerAdapter\u66f4\u65b0\u65f6\uff0c\u6570\u636eID\u6539\u53d8\u4e86\uff0c\u90a3\u4e48Fragment\u5c31\u4f1a\u8c03\u7528getItem(int)\u53bb\u83b7\u53d6\u65b0Fragment\uff0c\u8fbe\u5230\u66f4\u65b0\u6548\u679c\uff08\u6765\u6e90\uff09</p> <ul> <li>\u65b9\u6cd55\uff1a\u4e3a\u6bcf\u4e2a<code>Fragment</code>\u8bbe\u7f6etag(\u63a8\u8350)</li> </ul> <p>\u6458\u6284\u5982\u4e0b\uff1a</p> <p>My approach is to use the setTag() method for any instantiated view in the instantiateItem() method. So when you want to change the data or invalidate the view that you need, you can call the findViewWithTag() method on the ViewPager to retrieve the previously instantiated view and modify/use it as you want without having to delete/create a new view each time you want to update some value.</p> <p>ViewPager PagerAdapter not updating the View</p> <p>\u5177\u4f53\u5b9e\u73b0\u53ef\u89c1\u6b64\u535a\u5ba2\uff0c\u6838\u5fc3\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>public class FragmentViewPagerAdapter extends FragmentPagerAdapter {\nprivate FragmentManager mFragmentManager;\nprivate List&lt;String&gt; mDatas;\nprivate List&lt;String&gt; tagList = new ArrayList&lt;String&gt;();\npublic FragmentViewPagerAdapter(FragmentManager fm, List&lt;String&gt; datas) {\nsuper(fm);\nthis.mFragmentManager = fm;\nthis.mDatas = datas;\n}\n@Override\npublic Object instantiateItem(ViewGroup container, int position) {\ntagList.add(makeFragmentName(container.getId(), getItemId(position))); //\u628atag\u5b58\u8d77\u6765   \nreturn super.instantiateItem(container, position);\n}\n@Override\npublic void destroyItem(ViewGroup container, int position, Object object) {\nsuper.destroyItem(container, position, object);\ntagList.remove(makeFragmentName(container.getId(), getItemId(position)));//\u628atag\u5220\u6389\n}\n@Override\npublic Fragment getItem(int position) {\nString url = mDatas.get(position);\nWebViewFragmentV4 webview = new WebViewFragmentV4(url);//\u672c\u6587\u6e2c\u8bd5\u7684Fragment\u662f\u4e00\u4e2aWebViewFragment\nreturn webview;\n}\n@Override\npublic int getCount() {\nif (mDatas == null) {\nreturn 0;\n} else {\nreturn mDatas.size();\n}\n}\npublic void update(List&lt;String&gt; datas) {\nthis.mDatas = datas;\nnotifyDataSetChanged();//\u5e76\u4e0d\u80fd\u8d77\u5230\u66f4\u65b0Fragment\u5185\u5bb9\u7684\u4f5c\u7528\u3002\n}\npublic void update(int position) {//\u8fd9\u4e2a\u4e8b\u771f\u6b63\u7684\u66f4\u65b0Fragment\u7684\u5185\u5bb9\nWebViewFragmentV4 fragment = (WebViewFragmentV4) mFragmentManager.findFragmentByTag(tagList.get(position));\nif (fragment == null) {\nreturn;\n}\nfragment.update();\n}\nprivate static String makeFragmentName(int viewId, long id) {\nreturn \"android:switcher:\" + viewId + \":\" + id;\n}\n}\n</code></pre>"},{"location":"java/android/viewpager/#_5","title":"\u6700\u540e\u4f7f\u7528\u7684\u89e3\u51b3\u65b9\u6848","text":"<p>\u5199\u535a\u5ba2\u7684\u65f6\u5019\u9047\u5230\u7684\u5177\u4f53\u95ee\u9898\u573a\u666f\u4e3a\uff0c\u4e00\u4e2a<code>ViewPager</code>\u4e2d\u6709\u4e24\u4e2a<code>Fragment</code>,\u9700\u8981\u52a8\u6001\u7684\u66ff\u6362(\u800c\u4e0d\u662f\u66f4\u65b0\u5176\u5185\u5bb9)\u7b2c\u4e8c\u4e2a<code>Fragment</code>\u4e3a\u65b0\u7684<code>Fragment</code>\uff0c\u4f46\u662f\u53c8\u4e0d\u613f\u610f\u91cd\u65b0\u52a0\u8f7d\u7b2c\u4e00\u4e2a\uff0c\u4f7f\u7528\u7684<code>adapter</code>\u5982\u4e0b\uff1a</p> <pre><code>private class DynamicPagerAdapter extends FragmentPagerAdapter {\nprivate ArrayList&lt;Fragment&gt; registeredFragments;\nprivate List&lt;Integer&gt; hashList;\nprivate DynamicPagerAdapter(FragmentManager fm) {\nsuper(fm);\nthis.registeredFragments = new ArrayList&lt;&gt;();\nhashList = new ArrayList&lt;&gt;();\n}\npublic int getItemPosition(Object object) {\nint index = getIndexByTag(object.hashCode());\nif (index &gt;= 0) {\nhashList.remove(index);\nreturn POSITION_NONE;\n} else {\nreturn POSITION_UNCHANGED;\n}\n}\npublic long getItemId(int position) {\nreturn registeredFragments.get(position).hashCode();\n}\n@Override\npublic Fragment getItem(int position) {\nreturn registeredFragments.get(position);\n}\n@Override\npublic int getCount() {\nreturn registeredFragments.size();\n}\npublic void add(Fragment fragment) {\nregisteredFragments.add(fragment);\nhashList.add(fragment.hashCode());\nnotifyDataSetChanged();\n}\npublic void remove(int position) {\nregisteredFragments.remove(position);\nnotifyDataSetChanged();\n}\nprivate int getIndexByTag(int hashCode) {\nfor (int i = 0; i &lt; hashList.size(); i++) {\nif (hashList.get(i) == hashCode) {\nreturn i;\n}\n}\nreturn -1;\n}\n}\n</code></pre> <p>\u4e3b\u8981\u601d\u8def\uff1a\u8bb0\u5f55\u6240\u6709\u65b0\u589e\u7684<code>Fragment</code>\u7684<code>hashCode</code>,\u5728<code>getItemPosition</code>\u65f6\uff0c\u6839\u636e<code>Fragment</code>\u5224\u65ad\u8be5\u5bf9\u8c61\u662f\u5426\u5df2\u7ecf\u88ab\u8bb0\u5f55\uff0c\u82e5\u672a\u8bb0\u5f55\u5219\u8fd4\u56de<code>POSITION_NONE</code>\u8ba9\u5176\u88ab\u91cd\u65b0\u52a0\u8f7d\uff0c\u5426\u5219\u8fd4\u56de<code>POSITION_UNCHANGED</code>\u4ee5\u4f7f\u7528\u7f13\u5b58\u3002</p>"},{"location":"java/android/viewpager/#viewpagerfragment_1","title":"ViewPager\u4e2d\u4f7f\u7528\u76f8\u540c\u7684Fragment","text":""},{"location":"java/android/viewpager/#fragment","title":"\u9875\u9762\u4e0d\u66f4\u65b0\uff0c\u53ea\u663e\u793a\u7b2c\u4e00\u4e2aFragment","text":"<p>\u7ed1\u5b9a\u63a7\u4ef6\u65f6\u5e94\u4f7f\u7528<code>layout</code>\u67e5\u627e\u800c\u4e0d\u662f<code>activity</code>\u67e5\u627e\uff0c\u5e94\u8be5\u4e3a\uff1a</p> <pre><code>name = (TextView) layout.findViewById(R.id.name);\n</code></pre> <p>\u800c\u4e0d\u662f\uff1a</p> <pre><code>name = (TextView) activity.findViewById(R.id.name);\n</code></pre>"},{"location":"linux/adb-install/","title":"Ubuntu \u624b\u52a8\u5b89\u88c5 adb","text":"<ol> <li>\u524d\u5f80\u5b98\u7f51\u4e0b\u8f7d https://developer.android.com/studio/releases/platform-tools</li> <li>\u62f7\u8d1d\u81f3 /usr/lib/android-sdk \u76ee\u5f55</li> <li>\u5728/usr/lib/android-sdk\u76ee\u5f55\u89e3\u538b unzip platform-tools_r33.0.3-linux.zip -d .</li> <li>\u521b\u5efa\u8f6f\u94fe\u63a5 ln -s /usr/lib/android-sdk/platform-tools/adb /usr/bin/adb</li> <li>adb version \u53ef\u6b63\u5e38\u8f93\u51fa</li> </ol> <pre><code>(venv) root@mi:/usr/lib/android-sdk/platform-tools# adb version\nAndroid Debug Bridge version 1.0.41\nVersion 33.0.3-8952118\nInstalled as /usr/lib/android-sdk/platform-tools/adb\n</code></pre>"},{"location":"linux/git-note/","title":"Git\u7b14\u8bb0","text":""},{"location":"linux/git-note/#_1","title":"\u5e38\u7528\u547d\u4ee4","text":"<pre><code>git clone \u4ed3\u5e93\u5730\u5740\n\ngit pull \u4ed3\u5e93\u5730\u5740\n\ngit rm -r myFolder \u4ecegit\u5220\u9664\u6587\u4ef6\u5939\n\ngit rm --cached -r myFolder \u4ece\u672c\u5730git\u4e2d\u5220\u9664\u67d0\u4e2a\u6587\u4ef6\u5939\n\ngit rm --cached myfile \u4ece\u672c\u5730git\u4e2d\u5220\u9664\u67d0\u4e2a\u6587\u4ef6\n\ngit checkout . \u653e\u5f03\u5f53\u524d\u672a\u63d0\u4ea4\u7684\u4fee\u6539\u6587\u4ef6\n\nhttps://{username}:{passwd}@git.coding.net \u5728Uri\u5730\u5740\u4e2d\u5b58\u5165git\u7684\u8d26\u6237\u5bc6\u7801\u4e4b\u540e\u6267\u884c git config --global credential.helper store\n\ngit remote set-url origin https://git.coding.net/ykh/Blog.git\u91cd\u65b0\u8bbe\u7f6e\u4ed3\u5e93\u5730\u5740\n\ngit log --all --decorate --oneline --graph # \u663e\u793agit log \u79fb\u9664--decorate\u53ef\u4e0d\u663e\u793a\u5206\u652f\u4fe1\u606f\n</code></pre>"},{"location":"linux/git-note/#gitignore","title":".gitignore\u6587\u4ef6\u4f5c\u7528","text":"<p>\u521b\u5efa<code>.gitignore</code>\u6587\u4ef6\uff0c\u6587\u4ef6\u7528\u4e8e\u544a\u8bc9git\u5ffd\u7565\u67d0\u4e9b\u7279\u5b9a\u6216\u8005\u7279\u5b9a\u6587\u4ef6\u7c7b\u578b\u7684\u6587\u4ef6\uff1a</p> <pre><code>*.[oa]                  #\u5ffd\u7565\u6240\u6709.o\u548c.a\u7c7b\u578b\u7684\u6587\u4ef6\n*.log                   #\u5ffd\u7565\u6240\u6709.log\u7c7b\u578b\u7684\u6587\u4ef6\n!info.log               #\u4e0d\u5ffd\u7565info.log\u6587\u4ef6\n*~                      #\u5ffd\u7565\u6240\u6709\u6587\u4ef6\u540d\u79f0\u4ee5~\u7ed3\u5c3e\u7684\u6587\u4ef6\nmedia/                  #\u5ffd\u7565\u6240\u6709\u7684media/\u6587\u4ef6\u5939\nmigrations/*.py         #\u5ffd\u7565\u6240\u6709migrations/\u6587\u4ef6\u5939\u4e0b\u7684.py\u6587\u4ef6\n!migrations/__init__.py #\u4e0d\u5ffd\u7565\u6240\u6709migrations/\u6587\u4ef6\u5939\u4e0b\u7684__init__.py Django\u9879\u76ee\u591a\u7aef\u540c\u6b65\u7684\u65f6\u5019\u6781\u4e3a\u6709\u7528\n/environment            #\u5ffd\u7565\u6839\u76ee\u5f55\u4e0b\u7684environment\u6587\u4ef6\u5939\n</code></pre>"},{"location":"linux/git-note/#_2","title":"\u5e38\u89c1\u9519\u8bef","text":""},{"location":"linux/git-note/#_3","title":"\u51b2\u7a81","text":"<p>\u672c\u5730\u7248\u672c\u4f4e\u4e8e\u8fdc\u7a0b\u7248\u672c\uff0c\u5219\u5148\u4ece\u8fdc\u7a0b\u670d\u52a1\u5668\u62c9\u53d6\u4ee3\u7801\uff0c\u5728\u672c\u5730\u5408\u5e76\u5b8c\u6210\u540e\u518d\u6b21\u63d0\u4ea4</p>"},{"location":"linux/git-note/#error-path-signalspy-is-unmerged","title":"<code>error: path 'signals.py' is unmerged</code>","text":"<pre><code>git reset signals.py\ngit checkout signals.py\n</code></pre> <p>\u547d\u4ee4\u53ef\u4f7f\u7528git Bash\u3001SourceTree\u3001PyCharm\u7b49\u5de5\u5177\u6267\u884c</p>"},{"location":"linux/git-note/#python3git-log","title":"python3\u83b7\u53d6git log\u4fe1\u606f\u811a\u672c","text":"<p>\u5728<code>Terminal</code>\u4e2d\u8f93\u5165<code>git log | git_parser.py</code>\u5373\u53ef\u6267\u884c\u811a\u672c,<code>git_parser.py</code>\u6587\u4ef6\uff1a</p> <pre><code>import re\nimport io\nimport sys\nimport datetime\n# array to store dict of commit data\ncommits = []\ndef parse_commit(commit_lines):\n# dict to store commit data\ncommit = {}\n# iterate lines and save\nfor commit_line in commit_lines:\nif commit_line == '' or commit_line == '\\n':\n# ignore empty lines\npass\nelif bool(re.match('commit', commit_line, re.IGNORECASE)):\n# commit xxxx\nif len(commit) != 0:  # new commit, so re-initialize\ncommits.append(commit)\ncommit = {'hash': re.match('commit (.*)', commit_line, re.IGNORECASE).group(1)}\nelif bool(re.match('merge:', commit_line, re.IGNORECASE)):\n# Merge: xxxx xxxx\npass\nelif bool(re.match('author:', commit_line, re.IGNORECASE)):\n# Author: xxxx &lt;xxxx@xxxx.com&gt;\nm = re.compile('Author: (.*) &lt;(.*)&gt;').match(commit_line)\ncommit['author'] = m.group(1)\ncommit['email'] = m.group(2)\nelif bool(re.match('date:', commit_line, re.IGNORECASE)):\n# Date: xxx\nm = re.compile('Date:   (.*)').match(commit_line)\ndate = m.group(1)\ncommit['date'] = datetime.datetime.strptime(date, '%a %b %d %H:%M:%S %Y %z').strftime('%Y-%m-%d %H:%M:%S')\nelif bool(re.match('    ', commit_line, re.IGNORECASE)):\n# (4 empty spaces)\nif commit.get('message') is None:\ncommit['message'] = commit_line.strip()\nelse:\nprint('ERROR: Unexpected Line: ' + commit_line)\nif __name__ == '__main__':\ninput_stream = io.TextIOWrapper(sys.stdin.buffer, encoding='utf-8')\nparse_commit(input_stream.readlines())\n# print commits\nprint('Author'.ljust(8) + '  ' + 'Email'.ljust(20) + '  ' + 'Hash'.ljust(8) + '  ' + 'Date'.ljust(\n20) + '  ' + 'Message'.ljust(20))\nprint(\"=====================================================================================================\")\nfor commit in commits:\nprint(commit['author'].ljust(8) + '  ' + commit['email'][:20].ljust(20) + '  ' + commit['hash'][:7].ljust(\n8) + '  ' + commit['date'] + '  ' + commit['message'])\n</code></pre>"},{"location":"linux/install-python3.8.3/","title":"CentOS-7/Ubuntu18 \u5b89\u88c5Python3.8.3","text":""},{"location":"linux/install-python3.8.3/#_1","title":"\u5b89\u88c5\u4f9d\u8d56","text":"<p><code>yum install openssl-devel gcc make libffi-devel</code> <code>apt install libssl-dev libffi-dev</code></p>"},{"location":"linux/install-python3.8.3/#_2","title":"\u4e0b\u8f7d","text":"<p>\u524d\u5f80 \u534e\u4e3a\u955c\u50cf \u4e0b\u8f7dPython-3.8.3.tgz\u6587\u4ef6</p>"},{"location":"linux/install-python3.8.3/#_3","title":"\u5b89\u88c5","text":"<p>\u5c06\u4e0b\u8f7d\u5f97\u5230\u7684Python-3.8.3.tgz\u6587\u4ef6\u4f20\u5165\u673a\u5668\u7684/tmp/\u76ee\u5f55</p> <p>\u8fdb\u5165\u76ee\u5f55</p> <p><code>cd /tmp</code> </p> <p>\u89e3\u538b</p> <p><code>tar -zxvf Python-3.8.3.tgz</code></p> <p>\u8fdb\u5165\u89e3\u538b\u76ee\u5f55 </p> <p><code>cd Python-3.8.3</code></p> <p>\u914d\u7f6e\u5b89\u88c5\u4f4d\u7f6e</p> <p><code>./configure prefix=/usr/local/python3</code> <code>./configure prefix=/usr/local/python3  --enable-shared --with-ssl</code></p> <p>\u5b89\u88c5</p> <p><code>make &amp;&amp; make install</code></p>"},{"location":"linux/install-python3.8.3/#_4","title":"\u8f6f\u94fe\u63a5","text":"<p>\u5982\u679c\u6700\u540e\u6ca1\u63d0\u793a\u51fa\u9519\uff0c\u5c31\u4ee3\u8868\u6b63\u786e\u5b89\u88c5\u4e86\uff0c\u5728/usr/local/\u76ee\u5f55\u4e0b\u5c31\u4f1a\u6709python3\u76ee\u5f55\u3002</p> <p>\u6dfb\u52a0\u8f6f\u94fe\u63a5</p> <pre><code>rm -rf /usr/bin/python3\nln -s /usr/local/python3/bin/python3.8 /usr/bin/python3 </code></pre>"},{"location":"linux/install-python3.8.3/#_5","title":"\u6d4b\u8bd5","text":"<pre><code>[root@localhost python3]# python3\nPython 3.8.3 (default, Sep  8 2020, 06:06:08) \n</code></pre>"},{"location":"linux/install-python3.8.3/#pip","title":"\u5b89\u88c5pip","text":"<pre><code>curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py\npython3 get-pip.py\n\npython3 -m pip list\n</code></pre>"},{"location":"linux/install-python3.8.3/#_6","title":"\u5b89\u88c5\u865a\u62df\u73af\u5883","text":"<p>python3 -m pip install virtualenv python3 -m virtualenv"},{"location":"linux/mysql/","title":"Ubuntu18.04\u5b89\u88c5\u548c\u4f7f\u7528mysql5.7","text":""},{"location":"linux/mysql/#_1","title":"\u5b89\u88c5","text":"<ul> <li>sudo apt update</li> <li>sudo apt install mysql-server</li> <li>sudo mysql_secure_installation \u914d\u7f6emysql</li> </ul> <p>https://www.jianshu.com/p/4583aebf247a</p>"},{"location":"linux/mysql/#_2","title":"\u65e0\u6cd5\u8fdc\u7a0b\u767b\u5f55","text":"<p>\u4fee\u6539\u914d\u7f6e /etc/mysql/mysql.conf.d  vim /etc/mysql/mysql.conf.d  \u4fee\u6539\u5176\u4e2d\u7684 bind-address \u7531127.0.0.1 \u4e3a 0.0.0.0 \u91cd\u542fmysql\u670d\u52a1\u5373\u53ef sudo service mysql restart</p>"},{"location":"linux/mysql/#_3","title":"\u4f7f\u7528","text":"<ul> <li>systemctl status mysql.service \u67e5\u770b\u72b6\u6001</li> <li>sudo service mysql restart \u91cd\u542f</li> </ul>"},{"location":"linux/mysql/#_4","title":"\u7528\u6237\u7ba1\u7406","text":"<ul> <li>SELECT User,Host FROM mysql.user; \u67e5\u770b</li> <li>DROP USER 'bloguser'@'localhost'; \u5220\u9664</li> <li>CREATE USER 'user'@'%' IDENTIFIED BY 'password'; \u65b0\u589e user\u548cpassword\u8981\u6362\u6210\u81ea\u5df1\u8981\u7684</li> <li>GRANT ALL PRIVILEGES ON . TO 'user'@'%' WITH GRANT OPTION; \u6388\u6743</li> <li>FLUSH PRIVILEGES; \u5237\u65b0\u6743\u9650</li> </ul>"},{"location":"linux/nginx-vs-apache/","title":"Nginx Vs Apache","text":"<p>Apache\u57fa\u4e8eselect\u5b9e\u73b0\uff0cNginx\u57fa\u4e8eepoll\u5b9e\u73b0\u3002select\u548cepoll\u7684\u533a\u522b\u53c2\u8003IO\u591a\u8def\u590d\u7528\u6a21\u578b\u3002</p> <p>Nginx(\u9002\u5408\u7f51\u7edc\u5bc6\u96c6\u578b)\u662f\u4e8b\u4ef6\u9a71\u52a8\u578b\uff0c\u5f53\u5176\u5728\u7cfb\u7edf\u8d44\u6e90\u4e0d\u53ef\u7528\u65f6\uff0c\u5bf9\u5e94\u7684\u8fdb\u7a0b\u5c06\u88ab\u6302\u8d77\u76f4\u81f3\u7cfb\u7edf\u8d44\u6e90\u53ef\u7528\u65f6\u624d\u4f1a\u88ab\u5524\u9192(\u5f02\u6b65)\u3002</p> <p>\u800cApache(\u9002\u5408\u8ba1\u7b97\u5bc6\u96c6\u578b)\u5728\u7cfb\u7edf\u8d44\u6e90\u4e0d\u53ef\u7528\u65f6\uff0c\u5c06\u4e00\u76f4\u7b49\u5f85\u76f4\u81f3\u7cfb\u7edf\u8d44\u6e90\u53ef\u7528(\u540c\u6b65-\u963b\u585e\u578b)\u3002</p> <p>\u8fd9\u5c06\u5bfc\u81f4Apache\u5bf9\u6bd4Nginx\u4f1a\u6709\u66f4\u5927\u7684\u5185\u5b58\u5360\u7528\u3001\u66f4\u5c11\u7684\u5e76\u53d1\u91cf\u652f\u6301\u3002</p> <p>Why nginx is faster than Apache, and why you needn\u2019t necessarily care</p>"},{"location":"linux/os-note/","title":"\u64cd\u4f5c\u7cfb\u7edf\u7b14\u8bb0","text":""},{"location":"linux/os-note/#io","title":"IO\u591a\u8def\u590d\u7528\u6a21\u578b","text":"<ul> <li>select \u4e3a\u4e0d\u65ad\u7684\u53bb\u8f6e\u8bad\u6570\u636e\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u4e3aO(n)\uff0c\u6027\u80fd\u6bd4\u8f83\u4f4e\u3002</li> <li>poll \u57fa\u672c\u4e0eselect\u76f8\u540c\uff0c\u552f\u4e00\u7684\u533a\u522b\u662fpoll\u4e0d\u9650\u5236\u6700\u5927\u8fde\u63a5\u6570\u3002</li> <li>epoll \u4f1a\u6ce8\u518c\u4e8b\u4ef6\u76d1\u542c\uff0c\u6bcf\u5f53\u6570\u636e\u6709\u53d8\u5316\u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u8fdb\u884c\u901a\u77e5\u3002</li> </ul>"},{"location":"linux/os-note/#_1","title":"\u540c\u6b65\u548c\u5f02\u6b65\uff0c\u963b\u585e\u548c\u975e\u963b\u585e","text":"<p>\u53ea\u6709\u540c\u6b65\u6709\u963b\u585e\u548c\u975e\u963b\u585e\u7684\u8bf4\u6cd5</p> <ul> <li>\u540c\u6b65-\u963b\u585e \u4e00\u76f4\u7b49\u5f85\u4e8b\u4ef6\u5b8c\u6210\uff0c\u5728\u6b64\u671f\u95f4\u4e0d\u6267\u884c\u5176\u5b83\u64cd\u4f5c\u3002eg\uff1a\u4e00\u76f4\u5750\u5728\u65c1\u8fb9\u7b49\u6c34\u70e7\u5f00</li> <li>\u540c\u6b65-\u975e\u963b\u585e \u4ee5\u5b9a\u671f\u56de\u6765\u67e5\u770b\u7684\u65b9\u5f0f\u7b49\u5f85\u4e8b\u4ef6\u5b8c\u6210\u3002eg\uff1a\u4e00\u4f1a\u56de\u6765\u770b\u4e00\u4e0b\u6c34\u662f\u5426\u70e7\u5f00\u4e86</li> <li>\u5f02\u6b65 \u63a5\u6536\u65f6\u95f4\u5b8c\u6210\u7684\u901a\u77e5\u3002eg\uff1a\u7528\u5e26\u62a5\u8b66\u529f\u80fd\u7684\u6c34\u58f6\uff0c\u6c34\u58f6\u54cd\u4e86\u56de\u6765\u5904\u7406\u3002</li> </ul>"},{"location":"linux/raspberrypi/","title":"\u6811\u8393\u6d3e\u5b89\u88c5 python3 \u53ca python IDE","text":"<ol> <li>\u524d\u5f80https://www.raspberrypi.org/downloads/\u4e0b\u8f7d\u6811\u8393\u6d3eNOOBS\u5b8c\u5168\u7248\u7cfb\u7edf !</li> <li>\u524d\u5f80https://www.sdcard.org/downloads/formatter_4/\u4e0b\u8f7dSDFormatter v4.0\u5e76\u5b89\u88c5 !</li> <li>\u4e0b\u8f7dRASPBIAN\u7cfb\u7edf\uff0c\u5f97\u5230.img\u6587\u4ef6\uff0c\u4f7f\u7528Win32 Disk Imager \u5c06\u955c\u50cf\u5199\u5165\u5185\u5b58\u5361\u3002</li> <li>\u4f7f\u7528SDFormatter\u683c\u5f0f\u5316\u4f60\u7684\u5185\u5b58\u5361\u4e3aFAT\u683c\u5f0f\uff0c\u65e2\u8bbe\u7f6e\u8c03\u6574\u903b\u8f91\u5927\u5c0f(FORMAT SIZE ADJUSTMEN)\u9009\u9879\u4e3aON\uff0c\u5c06\u4e0b\u8f7d\u7684NODE.zip\u538b\u7f29\u5305\u4e2d\u7684\u6240\u6709\u6587\u4ef6\u63d0\u53d6\u51fa\u6765\u62f7\u8d1d\u5230SD\u5361\u7684\u6839\u76ee\u5f55\uff0c\u62f7\u8d1d\u5b8c\u6210\u540e\u5b89\u5168\u79fb\u9664\u5e76\u5c06SD\u5361\u63d2\u5230\u4f60\u7684\u6811\u8393\u6d3e\u4e2d\uff0c\u91cd\u542f\u4f60\u7684\u6811\u8393\u6d3e\u65f6\u5c06\u770b\u5230\u9009\u62e9\u754c\u9762\uff0c\u63d2\u4e0a\u952e\u76d8\u9f20\u6807\u9009\u62e9\u63a8\u8350\u7684Raspbian OS\uff0c\u7b49\u5f85\u5b89\u88c5\u5b8c\u6210\u540e\u91cd\u542f\uff0c\u9ed8\u8ba4\u8d26\u53f7\u4e3api\uff0c\u5bc6\u7801\u4e3araspberry\u3002 \u518d\u6b21\u91cd\u542f\u540e\u4f7f\u7528<code>startx</code>\u547d\u4ee4\u8fdb\u5165\u56fe\u50cf\u754c\u9762\u540e\uff0c\u5728Menu-&gt;Programming\u4e2d\u65e2\u53ef\u627e\u5230\u7cfb\u7edf\u81ea\u5e26\u7684Python2\u6216\u8005Python3\u7684IDE\u3002</li> </ol>"},{"location":"linux/supervisor-celery/","title":"Supervisor\u4f7f\u7528\u7b14\u8bb0\u53cacelery\u751f\u4ea7\u90e8\u7f72","text":""},{"location":"linux/supervisor-celery/#1-supervisor","title":"1 supervisor\u4f5c\u7528","text":"<p>Linux\u7684\u540e\u53f0\u8fdb\u7a0b\u8fd0\u884c\u6709\u597d\u51e0\u79cd\u65b9\u6cd5\uff0c\u4f8b\u5982nohup\uff0cscreen\u7b49\uff0c\u4f46\u662f\uff0c\u5982\u679c\u662f\u4e00\u4e2a\u670d\u52a1\u7a0b\u5e8f\uff0c\u8981\u53ef\u9760\u5730\u5728\u540e\u53f0\u8fd0\u884c\uff0c\u6211\u4eec\u5c31\u9700\u8981\u628a\u5b83\u505a\u6210daemon\uff0c\u6700\u597d\u8fd8\u80fd\u76d1\u63a7\u8fdb\u7a0b\u72b6\u6001\uff0c\u5728\u610f\u5916\u7ed3\u675f\u65f6\u80fd\u81ea\u52a8\u91cd\u542f\u3002</p> <p>supervisor\u5c31\u662f\u7528Python\u5f00\u53d1\u7684\u4e00\u5957\u901a\u7528\u7684\u8fdb\u7a0b\u7ba1\u7406\u7a0b\u5e8f\uff0c\u80fd\u5c06\u4e00\u4e2a\u666e\u901a\u7684\u547d\u4ee4\u884c\u8fdb\u7a0b\u53d8\u4e3a\u540e\u53f0daemon\uff0c\u5e76\u76d1\u63a7\u8fdb\u7a0b\u72b6\u6001\uff0c\u5f02\u5e38\u9000\u51fa\u65f6\u80fd\u81ea\u52a8\u91cd\u542f\u3002</p> <p>Supervisor\u7528\u4e8elinux\u7cfb\u7edf\u4e2d\u8fdb\u884c\u8fdb\u7a0b\u5b88\u62a4\uff0csupervisor3.x\u7248\u672c\u4ec5\u652f\u6301\u5728python2\u73af\u5883\u4e0b\u8fd0\u884c\uff0c\u4f46\u5bf9\u5176\u7ba1\u7406\u7684\u5b50\u8fdb\u7a0b\u8fd0\u884c\u73af\u5883\u6ca1\u6709\u8981\u6c42\uff0c\u5728\u5373\u5c06\u53d1\u5e03\u76844.x\u7248\u672c\u5f00\u59cb\u652f\u6301python3\u3002</p>"},{"location":"linux/supervisor-celery/#2-supervisor","title":"2 supervisor\u5b89\u88c5","text":"<p>\u4f7f\u7528easy_install\u5b89\u88c5(\u9700\u8981\u9ed8\u8ba4python\u73af\u5883\u4e3apython2)</p> <pre><code>easy_install supervisor\nsudo python2.7 -m easy_install supervisor\n</code></pre> <p>Git\u514b\u9686\u5b89\u88c5</p> <pre><code>cd /usr/bin\nsudo git clone https://github.com/Supervisor/supervisor.git\ncd supervisor\nsudo python2 setup.py install\n</code></pre>"},{"location":"linux/supervisor-celery/#3-supervisor","title":"3 supervisor\u914d\u7f6e","text":"<p>\u751f\u6210\u9700\u8981\u7684\u6587\u4ef6\u5939</p> <pre><code>sudo mkdir /etc/supervisord /etc/supervisord/conf.d /var/log/supervisord\n</code></pre> <p>\u7531\u914d\u7f6e\u6a21\u677f\u751f\u6210\u914d\u7f6e\u6587\u4ef6\u5e76\u8d4b\u6743</p> <pre><code>sudo chmod -R 777 /etc/supervisor/ # \u6587\u4ef6\u5939\u8d4b\u6743\nsudo echo_supervisord_conf &gt; /etc/supervisord/supervisord.conf # \u751f\u6210\u9ed8\u8ba4\u914d\u7f6e\u6a21\u677f\nsudo chmod -R 777 /etc/supervisord/supervisord.conf # \u5bf9\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u8d4b\u6743\nsudo gedit /etc/supervisord/supervisord.conf # \u7f16\u8f91\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\n</code></pre> <p>\u9700\u8981\u7279\u6b8a\u914d\u7f6e\u7684\u5730\u65b9\uff1a</p> <pre><code>[unix_http_server]\nfile=/tmp/supervisor.sock   ; the path to the socket file\n[supervisord]\nlogfile=/var/log/supervisord/supervisord.log ; main log file; default $CWD/supervisord.log\nlogfile_maxbytes=50MB        ; max main logfile bytes b4 rotation; default 50MB\nlogfile_backups=10           ; # of main logfile backups; 0 means none, default 10\nloglevel=info                ; log level; default info; others: debug,warn,trace\npidfile=/tmp/supervisord.pid ; supervisord pidfile; default supervisord.pid\nnodaemon=false               ; start in foreground if true; default false\nminfds=1024                  ; min. avail startup file descriptors; default 1024\nminprocs=200                 ; min. avail process descriptors;default 200\nchildlogdir=/tmp            ; 'AUTO' child log dir, default $TEMP\n[rpcinterface:supervisor]\nsupervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface\n[supervisorctl]\nserverurl=unix:///tmp/supervisor.sock ; use a unix:// URL  for a unix socket\n# \u6b64\u5904\u9700\u8981\u914d\u7f6e \u7528\u4e8e\u4fdd\u8bc1supervisor\u505c\u6b62\u8fdb\u7a0b\u540e\u5176\u5bf9\u5e94\u7684UNIX\u8fdb\u7a0b\u88ab\u540c\u6b65\u5173\u95ed\n# \u4e0d\u7136\u4f1a\u51fa\u73b0celery\u5df2\u88ab\u5173\u95ed\u4f46\u662f\u4efb\u52a1\u961f\u5217\u4ecd\u7136\u53ef\u7528\u7684\u60c5\u51b5\nstopasgroup=true             ; send stop signal to the UNIX process group (default false)\n# \u6b64\u5904\u9700\u8981\u914d\u7f6e \u4fdd\u8bc1/etc/supervisord/conf.d/\u6587\u4ef6\u5939\u4e0b\u6240\u6709\u4ee5.conf\u7c7b\u578b\u7ed3\u5c3e\u7684\u6587\u4ef6\u90fd\u88ab\u5f53\u505a\u914d\u7f6e\u6587\u4ef6\u88ab\u52a0\u8f7d\n[include]\nfiles = /etc/supervisord/conf.d/*.conf\n</code></pre>"},{"location":"linux/supervisor-celery/#4-cleley","title":"4 cleley\u914d\u7f6e","text":"<p>\u793a\u4f8b\u4f7f\u7528\u7684\u9879\u76ee\u6839\u76ee\u5f55\u4e3a/django/JRFamily/,\u4f7f\u7528\u7684virtualenv\u8def\u5f84\u4e3a/django/JRFamily/environment/\uff0c\u65e5\u5fd7\u5b58\u50a8\u8def\u5f84\u4e3a/django/JRFamily/log/\u3002</p> <p>\u751f\u6210\u65e5\u5fd7\u6587\u4ef6\uff0csupervisor\u4e0d\u4f1a\u81ea\u52a8\u751f\u6210\uff1a</p> <pre><code>cd /django/JRFamily/log/\nsudo touch celery_beat.log\nsudo touch celery_worker.log\n</code></pre> <p>\u65b0\u589e/etc/supervisord/conf.d/JRFamily.conf\u6587\u4ef6\uff1a</p> <pre><code>[program:jrfamily_celery_beat]\ncommand=/django/JRFamily/environment/bin/python manage.py celery beat -l info\ndirectory=/django/JRFamily\nstdout_logfile=/django/JRFamily/log/celery_beat.log\nstderr_logfile=/django/JRFamily/log/celery_beat.log\nautostart=true\nautorestart=true\nuser=dreamgo\nstartsecs=10\n[program:jrfamily_celery_worker]\nnumprocs=2\nprocess_name=worker%(process_num)s\ncommand=/django/JRFamily/environment/bin/python manage.py celery worker -E -l info\ndirectory=/django/JRFamily\nstdout_logfile=/django/JRFamily/log/celery_worker.log\nstderr_logfile=/django/JRFamily/log/celery_worker.log\nautostart=true\nautorestart=true\nuser=dreamgo\nstartsecs=10\n[program:jrfamily_celery_beat]\ncommand=/django/JRFamily/environment/bin/python manage.py celerycam\ndirectory=/django/JRFamily\nstdout_logfile=/django/JRFamily/log/celery_beat.log\nstderr_logfile=/django/JRFamily/log/celery_beat.log\nautostart=true\nautorestart=true\nuser=dreamgo\nstartsecs=10\n</code></pre> <p>autostart\u4e3a\u662f\u5426\u81ea\u52a8\u542f\u52a8\uff0cuser\u4e3a\u5f53\u524d\u7cfb\u7edf\u7528\u6237\u540d\u3002</p> <p>\u4e0a\u8ff0\u811a\u672c\u4f9d\u6b21\u6267\u884c\u7684\u547d\u4ee4\u4e3a\uff1a</p> <pre><code>python manage.py celery beat -l info # \u5f00\u542ftask\u53d1\u9001\u7aef\npython manage.py celery worker -E -l info # -E\u662f\u4e3a\u4e86celerycam\u80fd\u591f\u6355\u6349\u5230task\u72b6\u6001\npython manage.py celerycam # \u6355\u6349task\u6267\u884c\u72b6\u6001 \u53ef\u5728admin-&gt;Djcelery-&gt;Task\u67e5\u770b\n</code></pre>"},{"location":"linux/supervisor-celery/#5-rabbitmq","title":"5 RabbitMQ\u914d\u7f6e","text":"<p>\u5728\u540c\u4e00\u53f0\u670d\u52a1\u5668\u4e0a\u90e8\u7f72\u591a\u4e2aDjango\u7ad9\u70b9\u65f6\uff0c\u82e5\u4f7f\u7528\u540c\u4e00\u4e2aRabbitMQ\u8fde\u63a5\uff0c\u5c06\u5bfc\u81f4\u591a\u4e2aDjango\u7ad9\u70b9\u5171\u7528\u540c\u4e00\u4e2a\u4efb\u52a1\u961f\u5217\uff0c\u4f7f\u5f97\u5176\u4e2d\u67d0\u4e00\u4e2a\u7ad9\u70b9\u53ea\u80fd\u63a5\u53d7\u5230n/m\u7684\u4efb\u52a1(n\u4e3a\u672c\u7ad9\u70b9\u5f00\u542f\u7684celery wroker\u6570\u91cf,m\u4e3a\u603b\u7ad9\u70b9\u5f00\u542f\u7684celery worker\u6570\u91cf)\u3002\u4f7f\u7528RabbitMQ\u4e2d\u7684vhost\u529f\u80fd\u6765\u9694\u7edd\u5404\u4e2a\u7ad9\u70b9\u4e4b\u95f4\u7684RabbitMQ\u8fde\u63a5\uff0c\u4ece\u800c\u786e\u4fdd\u672c\u7ad9\u70b9\u53d1\u51fa\u7684\u4efb\u52a1(task)\u53ea\u6709\u672c\u7ad9\u70b9\u5f00\u542f\u7684worker\u80fd\u591f\u63a5\u53d7\u5230\u5e76\u8fdb\u884c\u5904\u7406\u3002</p> <p>RabbitMQ\u4e2d\u7684vhost\u6982\u5ff5\u76f8\u5f53\u4e8eApache\u4e2d\u7684VirtualHost\u3002</p> <p>\u8bf7\u6309\u7167\u4e0b\u5217\u547d\u4ee4\u987a\u5e8f\u6dfb\u52a0\u7528\u6237\u5e76\u5c06\u7528\u6237\u7ed1\u5b9a\u5230\u5bf9\u5e94\u7684vhost\u4e0a\uff1a</p> <pre><code>sudo rabbitmqctl add_user {username} {password} # \u6dfb\u52a0\u7528\u6237\nsudo rabbitmqctl add_vhost {vhost_name} # \u6dfb\u52a0vhost\nsudo rabbitmqctl set_permissions -p {vhost_name} {username} \".*\" \".*\" \".*\" # \u4e3a\u7528\u6237\u8bbe\u7f6e\u65b9\u4f4dvhost\u7684\u6743\u9650\nsudo rabbitmqctl set_user_tags {username} {tag ...}\n</code></pre> <p>\u591a\u4e2a\u7ad9\u70b9\u53ef\u4ee5\u5171\u7528\u4e00\u4e2a\u7528\u6237\u8d26\u53f7\uff0c\u4f46\u662f\u5fc5\u987b\u4f7f\u7528\u4e0d\u540c\u7684vhost\u3002 \u66f4\u591arabbitmqctl\u4f7f\u7528\u65b9\u6cd5\u8bf7\u53c2\u89c1rabbitmqctl\u4f7f\u7528\u624b\u518c\u3002</p> <p>\u5728Django\u4e2d\u7684settings\u6587\u4ef6\u8bbe\u7f6e\uff1a</p> <pre><code>BROKER_URL = 'amqp://username:password@localhost:5672/vhost_name'\n# \u8bf7\u7279\u522b\u6ce8\u610f BROKER_URL\u53ea\u6709\u5728\u5927\u5199\u65f6\u6709\u6548\uff0c\u5c0f\u5199\u65f6\u65e0\u6548\u3002\n</code></pre> <p>\u591a\u7ad9\u70b9\u95ee\u9898\u89e3\u51b3\u65f6\u67e5\u770b\u7684\u76f8\u5173\u8d44\u6599\uff1a</p> <p>Run Multiple Django Apps With Celery On One Server With Rabbitmq VHosts</p> <p>Using celeryd as a daemon with multiple django apps?</p> <p>Running multiple Django Celery websites on same server</p> <p>Run Multiple Django Apps With Celery On One Server With Rabbitmq VHosts</p>"},{"location":"linux/supervisor-celery/#6-supervisor","title":"6 supervisor\u4f7f\u7528","text":"<p>\u5f00\u542f\u3001\u65ad\u5f00supervisor.sock\u8fde\u63a5</p> <pre><code>sudo supervisord -c /etc/supervisord/supervisord.conf # \u5f00\u542f\nsudo unlink /tmp/supervisor.sock # \u65ad\u5f00\u8fde\u63a5\n</code></pre> <p>\u72b6\u6001\u67e5\u770b\u3001\u63a7\u5236</p> <pre><code>supervisorctl -c /etc/supervisord/supervisord.conf\n&gt; status    # \u67e5\u770b\u7a0b\u5e8f\u72b6\u6001\n&gt; stop [process_alias]   # \u5173\u95ed usercenter \u7a0b\u5e8f\n&gt; start [process_alias]  # \u542f\u52a8 usercenter \u7a0b\u5e8f\n&gt; restart [process_alias]    # \u91cd\u542f usercenter \u7a0b\u5e8f\n&gt; reread    \uff03 \u8bfb\u53d6\u6709\u66f4\u65b0\uff08\u589e\u52a0\uff09\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u4e0d\u4f1a\u542f\u52a8\u65b0\u6dfb\u52a0\u7684\u7a0b\u5e8f\n&gt; update    \uff03 \u91cd\u542f\u914d\u7f6e\u6587\u4ef6\u4fee\u6539\u8fc7\u7684\u7a0b\u5e8f  \nsudo supervisorctl -c /etc/supervisord/supervisord.conf stop all \n# \u5173\u95ed\u5168\u90e8\u8fdb\u7a0b unlink\u524d\u5fc5\u987b\u4f7f\u7528\u8be5\u547d\u4ee4\u5173\u95edsupervisord \u4e0d\u7136celery\u4f9d\u65e7\u5b58\u5728\u4e8e\u7cfb\u7edf\u4e2d \u5bfc\u81f4\u5185\u5b58\u6cc4\u9732\u4ee5\u53ca\u6709\u89c4\u5f8b\u7684\u4efb\u52a1\u4e22\u5931\uff01\uff01\uff01\nsudo supervisorctl -c /etc/supervisord/supervisord.conf start all # \u542f\u52a8\u6240\u6709\u914d\u7f6e\nsudo supervisorctl -c /etc/supervisord/supervisord.conf reread # \u8bfb\u53d6\u6709\u66f4\u65b0\uff08\u589e\u52a0\uff09\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u4e0d\u4f1a\u542f\u52a8\u65b0\u6dfb\u52a0\u7684\u7a0b\u5e8f\nsudo supervisorctl -c /etc/supervisord/supervisord.conf update # \u91cd\u542f\u914d\u7f6e\u6587\u4ef6\u4fee\u6539\u8fc7\u7684\u7a0b\u5e8f\n</code></pre> <p>Linux\u8fdb\u7a0b\u67e5\u770b\u3001\u6e05\u7406</p> <pre><code>ps auxf|grep celery # \u6811\u5f62\u663e\u793a \u63a8\u8350\nps -efH|grep celery # \u67e5\u770bcelery\u76f8\u5173\u8fdb\u7a0b \u5fc5\u987b\u662f\u5927\u5199\u7684H\u4ee5\u683c\u5f0f\u5316\u663e\u793a\u683c\u5f0f\nps aux|grep celery | awk '{system(\"kill -9 \" $2)}' # \u6740\u6b7bcelery\u76f8\u5173\u8fdb\u7a0b\n</code></pre>"},{"location":"linux/supervisor-celery/#7-supervisor","title":"7 supervisor\u5f00\u673a\u81ea\u542f\u52a8","text":"<p>ubuntu\u5f00\u542f\u81ea\u542f\u52a8\u811a\u672c\u539f\u59cb\u94fe\u63a5</p> <p>\u4fee\u6539\u540e\u811a\u672c/etc/init.d/supervisord\uff1a</p> <pre><code>#! /bin/sh\n#\n# Downloaded from:\n# http://bazaar.launchpad.net/~ubuntu-branches/ubuntu/trusty/supervisor/trusty/view/head:/debian/supervisor.init\n#\n# skeleton  example file to build /etc/init.d/ scripts.\n#       This file should be used to construct scripts for /etc/init.d.\n#\n#       Written by Miquel van Smoorenburg &lt;miquels@cistron.nl&gt;.\n#       Modified for Debian\n#       by Ian Murdock &lt;imurdock@gnu.ai.mit.edu&gt;.\n#               Further changes by Javier Fernandez-Sanguino &lt;jfs@debian.org&gt;\n#               Modified by sbilly &lt;superli.1980@gmail.com&gt; Added supervisorctl to status\n#\n# Version:  @(#)skeleton  1.9  26-Feb-2001  miquels@cistron.nl\n#\n### BEGIN INIT INFO\n# Provides:          supervisor\n# Required-Start:    $remote_fs $network $named\n# Required-Stop:     $remote_fs $network $named\n# Default-Start:     2 3 4 5\n# Default-Stop:      0 1 6\n# Short-Description: Start/stop supervisor\n# Description:       Start/stop supervisor daemon and its configured\n#                    subprocesses.\n### END INIT INFO\n. /lib/lsb/init-functions\n\nPATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin\nDAEMON=/usr/local/bin/supervisord\nSUPERVISORCTL=/usr/local/bin/supervisorctl\nNAME=supervisord\nDESC=supervisor\n\ntest -x $DAEMON || exit 0\nLOGDIR=/var/log/supervisord\nPIDFILE=/tmp/supervisord.pid\nDODTIME=5                   # Time to wait for the server to die, in seconds\n# If this value is set too low you might not\n# let some servers to die gracefully and\n# 'restart' will not work\n# Include supervisor defaults if available\nif [ -f /etc/default/supervisor ] ; then\n. /etc/default/supervisor\nfi\nDAEMON_OPTS=\"-c /etc/supervisord/supervisord.conf $DAEMON_OPTS\"\nset -e\n\nrunning_pid()\n{\n# Check if a given process pid's cmdline matches a given name\npid=$1\nname=$2\n[ -z \"$pid\" ] &amp;&amp; return 1\n[ ! -d /proc/$pid ] &amp;&amp;  return 1\n(cat /proc/$pid/cmdline | tr \"\\000\" \"\\n\"|grep -q $name) || return 1\nreturn 0\n}\nrunning()\n{\n# Check if the process is running looking at /proc\n# (works for all users)\n# No pidfile, probably no daemon present\n[ ! -f \"$PIDFILE\" ] &amp;&amp; return 1\n# Obtain the pid and check it against the binary name\npid=`cat $PIDFILE`\nrunning_pid $pid $DAEMON || return 1\nreturn 0\n}\nforce_stop() {\n# Forcefully kill the process\n[ ! -f \"$PIDFILE\" ] &amp;&amp; return\nif running ; then\nkill -15 $pid\n# Is it really dead?\n[ -n \"$DODTIME\" ] &amp;&amp; sleep \"$DODTIME\"s\n        if running ; then\nkill -9 $pid\n[ -n \"$DODTIME\" ] &amp;&amp; sleep \"$DODTIME\"s\n            if running ; then\necho \"Cannot kill $NAME (pid=$pid)!\"\nexit 1\nfi\nfi\nfi\nrm -f $PIDFILE\nreturn 0\n}\ncase \"$1\" in\nstart)\necho -n \"Starting $DESC: \"\nstart-stop-daemon --start --quiet --pidfile $PIDFILE \\\n--startas $DAEMON -- $DAEMON_OPTS\ntest -f $PIDFILE || sleep 1\nif running ; then\necho \"$NAME.\"\nelse\necho \" ERROR.\"\nfi\n;;\nstop)\necho -n \"Stopping $DESC: \"\nstart-stop-daemon --stop --quiet --oknodo --pidfile $PIDFILE\necho \"$NAME.\"\n;;\nforce-stop)\necho -n \"Forcefully stopping $DESC: \"\nforce_stop\n        if ! running ; then\necho \"$NAME.\"\nelse\necho \" ERROR.\"\nfi\n;;\n#reload)\n#\n#   If the daemon can reload its config files on the fly\n#   for example by sending it SIGHUP, do it here.\n#\n#   If the daemon responds to changes in its config file\n#   directly anyway, make this a do-nothing entry.\n#\n# echo \"Reloading $DESC configuration files.\"\n# start-stop-daemon --stop --signal 1 --quiet --pidfile \\\n#   /var/run/$NAME.pid --exec $DAEMON\n#;;\nforce-reload)\n#\n#   If the \"reload\" option is implemented, move the \"force-reload\"\n#   option to the \"reload\" entry above. If not, \"force-reload\" is\n#   just the same as \"restart\" except that it does nothing if the\n#   daemon isn't already running.\n# check wether $DAEMON is running. If so, restart\nstart-stop-daemon --stop --test --quiet --pidfile $PIDFILE \\\n--startas $DAEMON \\\n&amp;&amp; $0 restart \\\n|| exit 0\n;;\nrestart)\necho -n \"Restarting $DESC: \"\nstart-stop-daemon --stop --quiet --oknodo --pidfile $PIDFILE\n[ -n \"$DODTIME\" ] &amp;&amp; sleep $DODTIME\nstart-stop-daemon --start --quiet --pidfile $PIDFILE \\\n--startas $DAEMON -- $DAEMON_OPTS\necho \"$NAME.\"\n;;\nstatus)\necho -n \"$NAME is \"\nif running ;  then\necho \"running\"\nelse\necho \" not running.\"\nexit 1\nfi\n$SUPERVISORCTL $DAEMON_OPTS status\n    ;;\n*)\nN=/etc/init.d/$NAME\n# echo \"Usage: $N {start|stop|restart|reload|force-reload}\" &gt;&amp;2\necho \"Usage: $N {start|stop|restart|force-reload|status|force-stop}\" &gt;&amp;2\nexit 1\n;;\nesac\nexit 0\n</code></pre> <p>\u81ea\u542f\u52a8\u811a\u672c\u4fee\u6539\u6ce8\u610f\u4e8b\u9879\uff1a</p> <ul> <li>\u9700\u8981\u4fee\u6539DAEMON\u3001SUPERVISORCTL\u4e24\u4e2a\u8def\u5f84\uff0c\u5747\u4f4d\u4e8e/usr/local/bin\u76ee\u5f55\u4e0b\uff0c\u539f\u59cb\u76ee\u5f55\u4e3a/usr/bin\u3002</li> <li>\u52a1\u5fc5\u786e\u4fddPIDFILE\u7684\u4f4d\u7f6e\u548c/etc/supervisord/supervisord.conf\u4e2d\u7684pidfile\u5bf9\u5e94\u76f8\u540c\u7684\u6587\u4ef6\u3002</li> <li>\u786e\u4fddLOGDIR\u8bbe\u7f6e\u7684\u76ee\u5f55\u548c/etc/supervisord/supervisord.conf\u4e2d\u7684logfile\u6240\u5728\u7684\u76ee\u5f55\u76f8\u540c\u3002</li> </ul>"},{"location":"linux/supervisor-celery/#ubuntu","title":"\u8bbe\u7f6e\u811a\u672c\u4e3aUbuntu\u4e2d\u7684\u670d\u52a1","text":"<pre><code>sudo chmod -R 777 /etc/init.d/supervisord\nsudo update-rc.d supervisord defaults\nsudo service --status-all\n</code></pre> <p>\u79fb\u9664\u670d\u52a1</p> <pre><code>sudo update-rc.d -f supervisord remove\n</code></pre> <p>\ufeff</p>"},{"location":"linux/ubuntu-install/","title":"ubuntu\u5b89\u88c5\u914d\u7f6e\u8bb0\u5f55","text":""},{"location":"linux/ubuntu-install/#ubuntu","title":"ubuntu\u5b89\u88c5\u8bb0\u5f55","text":""},{"location":"linux/ubuntu-install/#1ubuntu1404-iso","title":"1\u3001\u4e0b\u8f7dubuntu14.04 iso\u955c\u50cf\u6587\u4ef6","text":""},{"location":"linux/ubuntu-install/#2rufusubuntu","title":"2\u3001\u4e0b\u8f7drufus\u8f6f\u4ef6\u5236\u4f5cubuntu\u5b89\u88c5\u5f15\u5bfc\u76d8","text":"<p> \u9700\u8981\u70b9\u51fb\u521b\u5efa\u4e00\u4e2a\u542f\u52a8\u76d8\u4f7f\u7528\u9009\u4e2d\u4e0b\u8f7d\u7684iso\u955c\u50cf\u6587\u4ef6</p>"},{"location":"linux/ubuntu-install/#3ubuntu","title":"3\u3001\u5b89\u88c5\u6b65\u9aa4\u5b89\u88c5ubuntu","text":""},{"location":"linux/ubuntu-install/#4","title":"4\u3001\u5b89\u88c5\u8fdc\u7a0b\u684c\u9762","text":"<pre><code>ubuntu16.04 service\u7248\u5b89\u88c5GUI:\nsudo apt-get install --no-install-recommends ubuntu-desktop\n\nsudo apt-get update\nsudo apt-get install xfce4\nsudo apt-get install xrdp vnc4server\necho \"xfce4-session\" &gt;~/.xsession\nsudo service xrdp restart\n\n\u9700\u8981\u5173\u95ed\u5c4f\u4fdd\uff0c\u5c4f\u4fdd\u5360\u7528\u5927\u91cf\u5e26\u5bbd\uff1a\nsetting-&gt;setting manager-&gt;Screensaver\n</code></pre>"},{"location":"linux/ubuntu-install/#5window","title":"5\u3001\u5728window\u4e0a\u5f00\u542f\u8fdc\u7a0b\u8fde\u63a5","text":"<pre><code>sudo apt-get install gnome-terminal \u5b89\u88c5\u65b0\u7ec8\u7aef\nsudo update-alternatives --config x-terminal-emulator \u8bbe\u7f6e\u9ed8\u8ba4\u7ec8\u7aef\u4e3agnome\nterminal\u6ca1\u6709\u5149\u6807\uff1a\u5728Terminal-&gt;Edit-&gt;Profile Preferences-&gt;Colors-&gt;\u53cd\u9009Use colors from system theme\u5373\u53ef\n</code></pre> <p>\u6587\u4ef6\u7ba1\u7406\u5668\u65e0\u7f29\u7565\u56fe\uff1a\u6267\u884c</p> <pre><code>sudo apt-get install gnome-icon-theme-full tango-icon-theme\n</code></pre> <p>\u65ad\u5f00\u8fde\u63a5\u518d\u6b21\u91cd\u8fde\u5373\u53ef</p>"},{"location":"linux/ubuntu-install/#6ufw","title":"6\u3001ufw\u9632\u706b\u5899\u8bbe\u7f6e","text":"<pre><code>sudo ufw default deny \u9ed8\u8ba4\u62d2\u7edd\u6240\u6709\u8bf7\u6c42\nsudo ufw enable/disable \u5f00\u542f\u6216\u8005\u5173\u95ed\u9632\u706b\u5899\nsudo ufw status \u67e5\u770b\u9632\u706b\u5899\u72b6\u6001\nsudo ufw allow ssh/22 \u5141\u8bb822\u7aef\u53e3\u53ef\u88ab\u8bbf\u95ee 22\u7aef\u53e3\u4e3assh\u7aef\u53e3\nsudo ufw allow 80 \u5141\u8bb880\u7aef\u53e3 \u4e3aapache\u4f7f\u7528\nsudo ufw allow from 192.168.1.107 \u5141\u8bb8\u8be5IP\u7684\u4e3b\u673a\u8bbf\u95ee\u6240\u6709\u7aef\u53e3\nsudo ufw reset \u91cd\u7f6e\u6240\u6709\u89c4\u5219\nsudo ufw delete allow 3350 \u5220\u9664\u67d0\u6761\u89c4\u5219\n\nsudo ufw allow 3350\nsudo ufw allow 3389 windows\u8fdc\u7a0b\u684c\u9762\u9ed8\u8ba4\u7aef\u53e3\u53f7\u4e3a\uff1a3389\uff0c\u4e24\u4e2a\u90fd\u5f00\u542f\u624d\u80fd\u8fde\u63a5\u5230\u8fdc\u7a0b\u684c\u9762\n\nsudo ufw allow 8000 django\u9875\u9762\u6d4b\u8bd5\u4f7f\u7528\n</code></pre>"},{"location":"linux/ubuntu-install/#7","title":"7\u3001\u6587\u4ef6\u4e92\u4f20","text":"<p>\u5b89\u88c5putty,\u5728putty\u7684\u5b89\u88c5\u76ee\u5f55\u4e2d\u62f7\u8d1d\u51fapscp.exe\u6587\u4ef6\u81f3C:\\Windows\\System32\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5728\u4efb\u610f\u5730\u65b9\u8fd0\u884cpscp\u547d\u4ee4\u3002</p> <p>\u5728\u684c\u9762\u6253\u5f00cmd,\u6b32\u4f20\u8f93ss.png\u81f3ubuntu,\u4f7f\u7528\u547d\u4ee4\uff1ahttps://www.alibabacloud.com/help/zh/doc-detail/51798.htm)</p> <pre><code>pscp ss.png dramgo@192.168.1.102:/var/www \u53ea\u6709\u5de6\u659c\u6760\u53ef\u7528\npscp ss.png dramgo@192.168.1.102:Downloads\n\u5176\u4e2ddramgo\u662fubuntu\u7684\u7528\u6237\u540d\uff0c192.168.1.102\u662fubuntu\u7684IP\u5730\u5740\u3002\n\n\u82e5\u51fa\u73b0unable to open /home/ss.png: permission denied \n\u5219\u9700\u8981\u5bf9ubuntu\u670d\u52a1\u5668\u4e0a\u7684\u5bf9\u5e94\u6587\u4ef6\u5939\u8fdb\u884c\u8bfb\u5199\u6388\u6743\uff0c\n\u4f7f\u7528\u547d\u4ee4\nsudo chmod -R 777 /home/\n\u4fee\u6539\u8be5\u76ee\u5f55\u7684\u6743\u9650\u4e3a\u666e\u901a\u7528\u6237\u53ef\u8bbf\u95ee\u3002\n</code></pre> <p>\u4eceubuntu\u670d\u52a1\u5668\u4e0b\u8f7dss.png\u5230window,\u4f7f\u7528\u547d\u4ee4\uff1a</p> <pre><code>pscp dreamgo@192.168.1.102:/var/www/ss.png C:/ss.png\n\u4ece\u8fdc\u7a0b\u670d\u52a1\u5668\u7684/var/www/ss.png \u4e0b\u8f7d\u5230\u672c\u5730C\u76d8ss.png\n</code></pre> <p>\u63d0\u793aFatal:Network error: COnnection refused \u539f\u56e0\uff1a\u8fdc\u7a0b\u670d\u52a1\u5668\u672a\u5b89\u88c5ssh\u670d\u52a1</p> <pre><code>sudo apt-get install openssh-server openssh-client\n</code></pre>"},{"location":"linux/ubuntu-install/#8","title":"8\u3001\u89e3\u538b","text":"<pre><code>tar -xvzf community_images.tar.gz \u89e3\u538b\nzip -r compressed_filename.zip foldername \u538b\u7f29\nunzip dreamgo.zip \u89e3\u538bzip\n</code></pre>"},{"location":"linux/ubuntu-install/#9pycharm","title":"9\u3001pycharm\u5b89\u88c5\u53ca\u6fc0\u6d3b","text":"<p>\u5728windows\u4e0a\u8fd0\u884c\u670d\u52a1\u6fc0\u6d3b\u7a0b\u5e8f\uff0c\u53d1\u9001\u5bf9\u5e94pycharm\u6587\u4ef6\u81f3ubuntu\uff0c\u89e3\u538b\u5e76\u8fdb\u5165bin\u76ee\u5f55\uff0c\u8fd0\u884csudo ./pycharm.sh\u5b89\u88c5pycharm\u3002 \u9009\u62e9\u670d\u52a1\u7aef\u6fc0\u6d3b\uff0c\u8f93\u5165http://192.168.1.x(windows\u5730\u5740)\uff1a\u6fc0\u6d3b\u5bf9\u5e94\u7684\u7aef\u53e3\u53f7 \u4e4b\u540e\u53ef\u4ee5\u7528/usr/local/bin/charm\u6253\u5f00\u8f6f\u4ef6</p>"},{"location":"linux/ubuntu-install/#10mysql","title":"10\u3001mysql","text":"<pre><code>mysql -uroot -proot \u8fdb\u5165mysql\u547d\u4ee4\u884c\u64cd\u4f5c\ncreate database dreamgo; \u4e00\u5b9a\u8981\u52a0;\u53f7\n</code></pre>"},{"location":"linux/ubuntu-install/#11tab","title":"11\u3001tab\u65e0\u6cd5\u81ea\u52a8\u8865\u5168","text":"<p>\u5728setting-&gt;Window Manager-&gt;Keyboard-&gt;\u5173\u95ed Switch window for same application</p> <p>\u6216\u8005</p> <p>\u53f3\u51fb\u5de6\u9762 \u5e94\u7528\u7a0b\u5e8f-&gt;\u8bbe\u7f6e-&gt;\u7a97\u53e3\u7ba1\u7406\u5668-&gt;\u952e\u76d8-&gt;\u5207\u6362\u540c\u4e00\u5e94\u7528\u7a0b\u5e8f\u7684\u7a97\u53e3</p>"},{"location":"linux/ubuntu-install/#12","title":"12\u3001\u6821\u51c6\u6807\u51c6\u65f6\u95f4","text":"<pre><code>sudo ntpdate ntp.ubuntu.com\n</code></pre>"},{"location":"linux/ubuntu-install/#13putty","title":"13\u3001Putty\u4f7f\u7528\u5bc6\u94a5\u767b\u9646","text":"<p>\u5728\u963f\u91cc\u4e91\u4e0a\u751f\u6210\u5bc6\u94a5\u5bf9\uff0c\u7ed1\u5b9a\u5bc6\u94a5\u81f3\u5bf9\u5e94\u4e3b\u673a\u5b9e\u4f8b\u3002\u4e0b\u8f7d\u79c1\u94a5pem\u6587\u4ef6\uff0c\u518d\u901a\u8fc7Putty\u5b89\u88c5\u76ee\u5f55\u4e0b\u7684puttygen.exe\u5c06\u751f\u6210\u7684pem\u6587\u4ef6\u8f6c\u6210ppk\u6587\u4ef6\u3002\u6253\u5f00putty\uff0c\u70b9\u51fbConnection-&gt;SSH-&gt;Auth-&gt;Browse\u9009\u4e2dppk\u6587\u4ef6\uff0c\u70b9\u51fbsession,\u8f93\u5165username@ip_address\u70b9\u51fb\u8fde\u63a5\u5373\u53ef\u94fe\u63a5\u81f3\u8fdc\u7a0b\u670d\u52a1\u5668\u3002\u4f7f\u7528 SSH \u5bc6\u94a5\u5bf9\u8fde\u63a5 Linux \u5b9e\u4f8b</p>"},{"location":"linux/ubuntu/","title":"Ubuntu\u7b14\u8bb0","text":""},{"location":"linux/ubuntu/#_1","title":"\u667a\u80fd\u8865\u5168","text":"<p>CentOS\u4e0b\uff0c\u6709\u4e00\u4e2a\u5f88\u667a\u80fd\u7684\u529f\u80fd\uff0c\u5c31\u662f\u53ea\u8f93\u5165\u4e00\u6761\u5386\u53f2\u547d\u4ee4\u7684\u524d\u51e0\u4e2a\u5b57\u6bcd\uff0c\u518d\u6309PageUp\u548cPageDown\u952e\uff0c\u5c31\u53ef\u4ee5\u5728\u4ee5\u6b64\u5b57\u6bcd\u4e3a\u524d\u7f00\u7684\u5386\u53f2\u547d\u4ee4\u4e2d\u4e0a\u4e0b\u5207\u6362\u3002\u8fd9\u4e2a\u529f\u80fd\u975e\u5e38\u5b9e\u7528\uff0c\u800c\u4e14\u6bd4CTRL+R\u4f7f\u7528\u8d77\u6765\u66f4\u53cb\u5584\u3001\u66f4\u65b9\u4fbf\u3002\u9057\u61be\u7684\u662f\uff0cubuntu\u4e0a\u5e76\u6ca1\u6709\u8fd9\u4e2a\u529f\u80fd\u3002Google\u4e0a\u641c\u7d22\u624d\u76f4\u5230\uff0c\u8fd9\u4e2a\u53ea\u662flinux\u5728\u7ec8\u7aef\u5bf9\u952e\u76d8\u7684\u6620\u5c04\u800c\u5df2\uff0c\u548clinux\u7684\u67d0\u4e2a\u53d1\u884c\u7248\u65e0\u5173\u3002\u53ea\u662fCentOS\u4e0b\u9ed8\u8ba4\u6253\u5f00\u4e86\u8fd9\u4e2a\u529f\u80fd\uff0c\u800cubuntu\u9ed8\u8ba4\u7981\u6b62\u4e86\u800c\u5df2\u3002 </p> <p>\u7f16\u8f91\u6587\u4ef6 <code>vim  /etc/inputrc</code> \u4e3a\uff1a</p> <p><pre><code># alternate mappings for \"page up\" and \"page down\" to search the history\n\"\\e[5~\": history-search-backward\n^\\e[6~\": history-search-forward\n</code></pre> \u53d6\u6d88\u4e0a\u8ff0\u4e24\u884c\u7684\u6ce8\u91ca\u540e\uff0c\u4fdd\u5b58\u5e76\u9000\u51fa\u3002\u91cd\u8fde\u7ec8\u7aef\u5373\u53ef\u751f\u6548\u3002</p> <p>https://blog.csdn.net/denkywu/article/details/93979941</p>"},{"location":"linux/ubuntu/#root","title":"\u8bbe\u7f6eroot\u5bc6\u7801","text":"<pre><code>sudo passwd root\n</code></pre>"},{"location":"linux/ubuntu/#_2","title":"\u8bbe\u7f6e\u65f6\u533a","text":"<pre><code>tzselect\n\u9009\u62e94 China\n\n\u9009\u5b8c\u540e\u540c\u6b65 sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime\n</code></pre>"},{"location":"linux/ubuntu/#_3","title":"\u78c1\u76d8","text":"<pre><code>\u67e5\u770b\u76ee\u5f55\u5360\u7528\u60c5\u51b5\ndu -sh *\n\n\u6e05\u7a7a\u56de\u6536\u7ad9\ncd /home/user/.local/share/Trash/\nsudo rm -rf *\n</code></pre>"},{"location":"linux/ubuntu/#ssh","title":"SSH","text":"<pre><code>apt install openssh-server\nsystemctl status ssh\n</code></pre>"},{"location":"linux/ubuntu/#ubuntu","title":"\u67e5\u770bUbuntu\u7248\u672c","text":"<pre><code>lsb_release -a\n</code></pre>"},{"location":"linux/ubuntu/#apt","title":"apt","text":"<pre><code>\u663e\u793a\u53ef\u6309\u7167\u7684\u7248\u672c\nsudo apt-cache madison appname\n</code></pre>"},{"location":"linux/unzip/","title":"Unzip","text":""},{"location":"linux/unzip/#_1","title":"\u6587\u4ef6\u89e3\u538b\u540e\u6587\u4ef6\u540d\u79f0\u4e71\u7801","text":"<p>\u7531\u4e8e\u4e2d\u6587\u7684Windows\u4f7f\u7528\u7684\u662fGBK\u7f16\u7801\uff0c\u800cLinux\u9ed8\u8ba4\u4f7f\u7528UTF-8\u7f16\u7801\u7684\uff0c\u5982\u679c\u5728Windows\u6253\u5305\u5e26\u4e2d\u6587\u6587\u4ef6\u7684zip\u5305\uff0c\u5219\u8fd9\u4e2azip\u5305\u5728Linux\u4e0b\u9762\u4f7f\u7528\u9ed8\u8ba4\u7684\u5f52\u6863\u7ba1\u7406\u5668\u6253\u5f00\u8fd9\u4e2azip\u5305\u7684\u65f6\u5019\uff0c\u4e2d\u6587\u6587\u4ef6\u540d\u4f1a\u663e\u793a\u4e71\u7801\u3002 \u89e3\u51b3\u65b9\u6cd5:  <pre><code>unzip -O GBK *.zip\n</code></pre></p> <p>https://blog.csdn.net/qq_40608730/article/details/110673393</p>"},{"location":"linux/vm/","title":"\u865a\u62df\u673a\u5b89\u88c5\u95ee\u9898\u8bb0\u5f55","text":""},{"location":"linux/vm/#vmci","title":"\u65e0\u6cd5\u83b7\u5f97 VMCI \u9a71\u52a8\u7a0b\u5e8f\u7684\u7248\u672c: \u53e5\u67c4\u65e0\u6548\u3002","text":"<pre><code>\u65e0\u6cd5\u83b7\u5f97 VMCI \u9a71\u52a8\u7a0b\u5e8f\u7684\u7248\u672c: \u53e5\u67c4\u65e0\u6548\u3002\n\n\u9a71\u52a8\u7a0b\u5e8f\u201cvmci.sys\u201d\u7684\u7248\u672c\u4e0d\u6b63\u786e\u3002\u8bf7\u5c1d\u8bd5\u91cd\u65b0\u5b89\u88c5 VMware Workstation\u3002\n\n\u6a21\u5757\u201cDevicePowerOn\u201d\u542f\u52a8\u5931\u8d25\u3002\n\n\u672a\u80fd\u542f\u52a8\u865a\u62df\u673a\u3002\n</code></pre> <p>\u89e3\u51b3\u65b9\u6cd5\uff1a</p> <p>\u8fdb\u5165\u865a\u62df\u673a\u5b89\u88c5\u76ee\u5f55\uff0c\u9009\u62e9.vmx\u6587\u4ef6\uff0c\u5c06\u6587\u4ef6\u5185</p> <p>vmci0.present = \"TRUE\"\u6539\u4e3aFALSE</p> <pre><code>vi /etc/sysconfig/network-scripts/ifcfg-ens33\n\nservice network restart\n</code></pre>"},{"location":"linux/vm/#vm-tools","title":"VM Tools\u7070\u8272","text":"<ol> <li>\u5173\u95ed\u865a\u62df\u673a\uff1b</li> <li>\u5728\u865a\u62df\u673a\u8bbe\u7f6e\u5206\u522b\u8bbe\u7f6e CD/DVD\u3001CD/DVD2 \u548c\u8f6f\u76d8\u4e3a\u81ea\u52a8\u68c0\u6d4b\u4e09\u4e2a\u6b65\u9aa4\uff1b</li> <li>\u518d\u91cd\u542f\u865a\u62df\u673a\uff0c\u7070\u8272\u5b57\u5373\u70b9\u4eae\u3002</li> <li>\u5728 VMware \u5bfc\u822a\u680f\u627e\u5230\uff1a\u865a\u62df\u673a\u2014\u2014\u5b89\u88c5 VMware tools\uff0c\u70b9\u51fb</li> <li>\u865a\u62df\u673a\u4f1a\u53d1\u73b0\u591a\u4e86\u4e00\u4e2a CD \u955c\u50cf\u2014\u2014 VMware Tools\uff0c\u6253\u5f00\u540e\u5c06 VMwareTools-10.0.5-3228253.tar.gz \u89e3\u538b\u5230\u4e00\u4e2a\u672c\u5730\u3002</li> <li>\u6253\u5f00 shell\uff0c\u901a\u8fc7 cd \u6253\u5f00 vmware-tools-distrib\uff08\u4e0a\u4e00\u6b65\u89e3\u538b\u6587\u4ef6\u540d\uff09\uff0c\u6267\u884c <code>./vmware-install.pl</code></li> <li>\u4e00\u8def\u4e0b\u4e00\u6b65\u5373\u53ef\u5b8c\u6210\u5b89\u88c5\u3002 <p>https://oldtang.com/5565.html</p> </li> </ol> <pre><code>apt-get install open-vm-tools\n</code></pre>"},{"location":"linux/vm/#_1","title":"\u9000\u51fa\u865a\u62df\u673a\u7a97\u53e3","text":"<p>CTRL+ALT</p>"},{"location":"linux/wrk/","title":"wrk\u538b\u6d4b\u5de5\u5177","text":"<p>\u5b89\u88c5</p> <pre><code>cd /opt\ngit clone https://github.com/wg/wrk.git\ncd wrk\nmake\nln -s /opt/wrk/wrk /usr/local/bin\n</code></pre> <p>Git\u4e0b\u8f7d\u6162\u7684\u8bdd\u53ef\u4ee5\u4f7f\u7528\u52a0\u901f\u94fe\u63a5 https://github.com.cnpmjs.org/wg/wrk.git</p> <p>\u4f7f\u7528\u8bf4\u660e</p> <pre><code>[root@localhost opt]# wrk\nUsage: wrk &lt;options&gt; &lt;url&gt;                            \nOptions:                                            \n  -c, --connections &lt;N&gt; Connections to keep open  \n  -d, --duration   &lt;T&gt; Duration of test          \n  -t, --threads     &lt;N&gt; Number of threads to use  \n\n  -s, --script     &lt;S&gt; Load Lua script file      \n  -H, --header     &lt;H&gt; Add header to request      \n      --latency         Print latency statistics  \n      --timeout     &lt;T&gt; Socket/request timeout    \n  -v, --version         Print version details      \n\nNumeric arguments may include a SI unit (1k, 1M, 1G)\nTime arguments may include a time unit (2s, 2m, 2h)\n</code></pre> <p>\u793a\u4f8b\uff1a</p> <pre><code>[root@localhost ~]# wrk -t 8 -c 500 -d 30 --latency http://192.168.11.5:8000/client/1\nRunning 30s test @ http://192.168.11.5:8000/client/1\n  8 threads and 500 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency   751.06ms  526.96ms   1.95s    59.53%\n    Req/Sec   112.46    107.55   650.00     78.82%\n  Latency Distribution\n     50%  848.00ms\n     75%  934.46ms\n     90%    1.65s \n     99%    1.82s \n  17120 requests in 30.09s, 8.72MB read\n  Socket errors: connect 0, read 0, write 0, timeout 860\nRequests/sec:    568.93\nTransfer/sec:    296.69KB\n</code></pre>"},{"location":"other/FileZilla/","title":"FileZilla Server\u642d\u5efa","text":"<p>\u5728Server 2008R2 \u4e0a\u4f7f\u7528FileZilla Server0.9.48\u7248\u672c\u914d\u7f6eFtp\u670d\u52a1\u3002</p> <p>\u5728Edit\u4e2d\u53ef\u4ee5\u914d\u7f6egroups\u548c\u589e\u52a0users,\u5728\u7528\u6237\u548c\u7ec4\u7684\u8bbe\u7f6e\u754c\u9762\u4e2d\u7684Shared folders\u4e3a\u5206\u4eab\u76ee\u5f55\u7684\u8bbe\u7f6e\uff0c\u6ce8\u610f\u8981\u5bf9\u76ee\u5f55\u6743\u9650\u8fdb\u884c\u63a7\u5236\uff0c+subdirs\u4ee3\u8868\u5b50\u76ee\u5f55\u7684\u6743\u9650\uff0c\u4e0d\u52fe\u9009\u5c06\u4e0d\u5177\u6709\u5bf9\u5b50\u76ee\u5f55\u7684\u6743\u9650\u3002</p> <p>\u540c\u4e00\u7528\u6237\u6216\u7ec4\u5171\u4eab\u4e24\u4e2a\u6ca1\u6709\u7236\u7ea7\u5173\u7cfb\u7684\u6587\u4ef6\u5939\u7684\u65f6\u5019\uff0c\u8981\u7ed9\u975e\u4e3b\u6587\u4ef6\u5939\u7684\u76ee\u5f55\u8bbe\u7f6e\u522b\u540d\uff0c\u683c\u5f0f\u4e3a/alias/,\u5177\u4f53\u5982\u56fe\uff1a</p> <p></p> <p>\u8bbe\u7f6e\u5b8c\u6210\u540e\u9700\u8981\u8bbe\u7f6eSever\u7684\u9632\u706b\u5899\u5982\u4e0b\uff0c\u70b9\u51fb\u5141\u8bb8\u5141\u8bb8\u53e6\u4e00\u7a0b\u5e8f\uff0c\u8fdb\u5165\u5b89\u88c5\u76ee\u5f55\u9009\u62e9\u8fd9\u4e24\u4e2a\u7a0b\u5e8f\uff0c</p> <p></p> <p>\u9700\u8981\u8ba9FileZilla Server\u548cFileZilla Server Interface\u4e24\u4e2a\u7a0b\u5e8f\u540c\u65f6\u901a\u8fc7\u9632\u706b\u5899\uff0c\u8fd9\u6837FileZilla Client\u624d\u80fd\u591f\u6210\u529f\u8fde\u63a5\u5230\u670d\u52a1\u5668\u3002</p>"},{"location":"other/icon-generate/","title":"\u6587\u5b57\u8f6c\u56fe\u6807","text":""},{"location":"other/icon-generate/#_1","title":"\u56fe\u6807\u751f\u6210","text":"<p>\u63a8\u8350\u7f51\u7ad9\uff1afavicon</p>"},{"location":"other/icon-generate/#_2","title":"\u63a8\u8350\u914d\u7f6e","text":"<p>\u5b57\u4f53\uff1aAveria Sans Libre</p> <p>\u5b57\u4f53\u989c\u8272\uff1a#F08</p>"},{"location":"other/school-ms/","title":"schoolms\u4e2d\u903b\u8f91\u95ee\u9898\u8bb0\u5f55","text":"<p>\u3010\u6559\u52a1\u3011</p> <p>\u8bfe\u7a0b\u8868\u751f\u6210\uff1a\u751f\u6210\u8349\u7a3f-&gt;\u63d0\u4ea4   \u63d0\u4ea4\u6210\u529f or \u6709\u51b2\u7a81-&gt;\u4fee\u6539\u8349\u7a3f\uff08\u6309\u51b2\u7a81\u63d0\u793a\uff09-&gt;\u518d\u6b21\u63d0\u4ea4</p> <p>\u51c6\u5b66\u5458\u8d2d\u4e702\u6b21\u76f8\u540c\u8bfe\u7a0b\u65f6\uff0c\u76f4\u63a5\u7d2f\u52a0\u8d2d\u4e70\u8be5\u8bfe\u7a0b\u7684\u8bfe\u7a0b\u65f6\u957f\u3002\ufeff</p> <p>\u8bfe\u8868\u4e00\u65e6\u751f\u6548\u5c31\u4e0d\u53ef\u518d\u88ab\u4fee\u6539\uff0c\u53ea\u53ef\u4f7f\u7528cancel\u63a5\u53e3\u8fdb\u884c\u53d6\u6d88\u8bfe\u7a0b\u3002</p> <p>\u63d0\u4ea4\u6392\u8bfe\u8349\u7a3f\u65f6\u76f8\u5e94\u589e\u52a0\u73ed\u7ea7\u3001\u73ed\u7ea7\u5185\u5b66\u5458\u7684\u5df2\u6392\u8bfe\u65f6\u3002</p> <p>\u53d6\u6d88\u6210\u529f\u51cf\u5c11\u5bf9\u5e94\u73ed\u7ea7\u7684\u5df2\u6392\u8bfe\u65f6\u3002</p> <p>\u8bfe\u7a0b\u8868\u7684\u8bfe\u6d88\u72b6\u6001\u6539\u53d8\u65f6\uff0csave\u65b9\u6cd5\u52a8\u6001\u6539\u53d8\u73ed\u7ea7\u7684\u8bfe\u6d88\u65f6\u95f4\u3002</p> <p>\u5b66\u5458\u8bfe\u6d88\u72b6\u6001\u6539\u53d8\u65f6\uff0csave\u65b9\u6cd5\u52a8\u6001\u6539\u53d8\u5b66\u5458\u7684\u8bfe\u6d88\uff08\u5df2\u4e0a\uff09\u65f6\u95f4\u3002</p> <p>\u8d2d\u8bfe\u4e4b\u540e\u8bbe\u7f6e\u5b66\u5458\u8d2d\u8bfe\u65f6\u957f\uff0c\u5b66\u5458\u52a0\u5165\u73ed\u7ea7\u6216\u8005\u79fb\u51fa\u73ed\u7ea7\u65f6\u8bbe\u7f6e\u8ba1\u5212\u65f6\u957f\u3002</p> <p>\u5206\u73ed\uff1a\u5f85\u5206\u73ed\u5b66\u5458\u3001\u6279\u91cf\u8bbe\u7f6e\u5165\u73ed\u65f6\u95f4\u3001\u5165\u73ed\u65f6\u4fee\u6539\u5df2\u8ba1\u5212\u8bfe\u65f6\u3002</p> <p>\u73ed\u7ea7\u5b66\u5458\u8981\u6c42\u548c\u5b66\u5458\u76f8\u540c\u7684\u6a21\u578b\u6743\u9650\u3002</p> <p>\u73ed\u7ea7\u5f00\u59cb\u6392\u8bfe\u4e4b\u524d\uff0c\u4f9d\u6b21\u68c0\u67e5\u5b66\u5458\u7684\u5269\u4f59\u8bfe\u65f6\u662f\u5426\u8db3\u591f\u6392\u8bfe\u3002</p> <p>\u5165\u73ed\u65f6\u68c0\u6d4b\u5b66\u5458\u7684\u8bfe\u7a0b\u548c\u73ed\u7ea7\u5f00\u8bbe\u7684\u8bfe\u7a0b\u662f\u5426\u76f8\u540c\uff1f</p> <p>\u8bfe\u7a0b\u8868\u521b\u5efa\u7684\u65f6\u5019\u662f\u8349\u7a3f\u72b6\u6001\uff0c\u63d0\u4ea4\u65f6\u8f6c\u5316\u4e3a\u751f\u6548\u72b6\u6001\uff08\u52a0\u5df2\u6392\u8bfe\u65f6\uff09\uff0c\u5220\u9664\u65f6\u8f6c\u6362\u4e3a\u5220\u9664\u72b6\u6001\uff08\u51cf\u5df2\u6392\u8bfe\u65f6\uff09\u3002</p> <p>\u65b0\u589e\u73ed\u7ea7 \u73ed\u7ea7\u5f00\u8bfe\u8bfe\u7a0b\u603b\u8bfe\u65f6-&gt;\u8ba1\u5212\u8bfe\u65f6</p> <p>\u5b66\u5458\u5165\u73ed\u65f6-&gt;\u5df2\u6392\u8bfe\u65f6\u7d2f\u52a0\u4e0a\u73ed\u7ea7\u7684\u5df2\u6392\u8bfe\u65f6  \u5b66\u5458\u79fb\u51fa\u73ed\u7ea7\u65f6-&gt;\u5df2\u6392\u8bfe\u65f6\u51cf\u53bb\u73ed\u7ea7\u5df2\u6392\u8bfe\u65f6</p> <p>\u8bfe\u7a0b\u8868 \u751f\u6548/\u5220\u9664 -&gt; \u73ed\u7ea7\u3001\u5b66\u5458\u5df2\u6392\u8bfe\u65f6 \u662f\u5426\u4e0a\u8bfe-&gt;\u73ed\u7ea7\u5df2\u4e0a\u8bfe\u65f6</p> <p>\u5b66\u5458\u8003\u52e4\u8bfe\u6d88 -&gt; \u5b66\u5458\u5df2\u4e0a\u8bfe\u65f6</p> \u73ed\u7ea7 \u5df2\u4e0a\uff08\u8bfe\u6d88\uff09 \u5df2\u6392 \u8ba1\u5212 \u6765\u6e90\uff1a \u8bfe\u7a0b\u8868\u5df2\u4e0a\u3001\u672a\u4e0a \u8bfe\u7a0b\u8868\u751f\u6548/\u5220\u9664(\u672a\u4e0a)/\u53d6\u6d88 \u521b\u5efa\u65f6\u6765\u81ea\u8bfe\u7a0b\u603b\u8bfe\u65f6 \u73ed\u7ea7\u5b66\u5458 \u5df2\u4e0a\uff08\u8bfe\u6d88\uff09 \u5df2\u6392 \u8ba1\u5212 \u5145\u503c \u6765\u6e90\uff1a \u73ed\u7ea7\u5b66\u5458\u8bfe\u6d88 \u8bfe\u7a0b\u8868\u751f\u6548/\u5220\u9664\uff08\u672a\u4e0a\uff09/\u53d6\u6d88 \u5165\u73ed\u65f6\u7d2f\u52a0 \u51fa\u73ed\u65f6\u51cf\u5c11 \u6765\u81ea\u8d2d\u8bfe\u8bb0\u5f55"},{"location":"other/term/","title":"\u6d4b\u8bd5\u76f8\u5173","text":"<ul> <li>CL\u5206\u6790\uff1a\u5176\u4e2dCL\u6307change list</li> <li>TR\uff1aTechnical Review \u6280\u672f\u8bc4\u5ba1\uff0c\u4e5f\u79f0\u8f6f\u4ef6\u6210\u719f\u5ea6\u8bc4\u5ba1\uff0c\u4ee3\u8868\u5f53\u524d\u9636\u6bb5\u4ea7\u54c1\u6210\u719f\u5ea6</li> <li>STR\uff1aSoftware Technical Review \u6307\u9488\u5bf9\u8f6f\u4ef6\u8fdb\u884c\u7684TR\u8bc4\u5ba1</li> <li>\u8f6f\u4ef6KO\uff1a\u8f6f\u4ef6Kick Off\uff0c\u8f6f\u4ef6\u9879\u76ee\u5f00\u5de5\u4f1a\u8bae</li> <li>EWP\uff1aEarly Warning Process\uff0c\u65e9\u671f\u9884\u8b66\u673a\u5236\uff0c\u65b0\u4ea7\u54c1\u4e0a\u5e02\u540e\u7b2c\u4e00\u6279\u6545\u969c\u673a\u7684\u5206\u6790\u6d3b\u52a8</li> <li>\u8f6f\u4ef6\u9879\u76ee\u5b9a\u7ea7\uff1a\u8f6f\u4ef6\u9879\u76ee\u5b9a\u7ea7\u6307\u9488\u5bf9\u8f6f\u4ef6\u7279\u6027\u5bf9\u8f6f\u4ef6\u9879\u76ee\u8fdb\u884c\u5206\u7ea7\uff0c\u660e\u786e\u5b9a\u7ea7\u6807\u51c6\u548c\u4f9d\u636e</li> <li>KEP\uff1aKey Experience Path \u5173\u952e\u4f53\u9a8c\u8def\u5f84\uff0cKEP\u662f\u6bcf\u4e2a\u7279\u6027\u4e2d\u6700\u4e3b\u8981\u7684\u5f71\u54cd\u7528\u6237\u4f53\u9a8c\u7684\u573a\u666f\u548c\u8fc7\u7a0b</li> <li>KEI\uff1aKey Experience Indicator \u5173\u952e\u4f53\u9a8c\u6307\u6807\uff0cKEI\u662f\u5bf9\u5e94\u6bcf\u4e2a\u7528\u6237\u573a\u666f\u4e0b\uff0c\u5e94\u6ee1\u8db3\u7684\u6700\u4f73\u7aef\u5230\u7aef\u4f53\u9a8c\u6307\u6807</li> <li>DI\uff1aDefect index \u7f3a\u9677\u6307\u6570</li> <li>Common Feature\uff1a\u666e\u901a\u9700\u6c42</li> <li>New Feature\uff1a\u65b0\u9700\u6c42</li> <li>PRD\uff1aProduct Requirement Document \u4ea7\u54c1\u9700\u6c42\u6587\u6863</li> <li>OTA\uff1aOver the Air Technology \u6570\u636e\u4e0b\u8f7d\u540e\u670d\u52a1\u66f4\u65b0</li> <li>\u81ea\u5347\u7ea7\uff1a\u5e94\u7528\u901a\u8fc7\u5e94\u7528\u5546\u5e97\u666e\u901a\u5347\u7ea7</li> <li>\u89e3\u8026/\u975e\u89e3\u8026\u5e94\u7528\uff1a\u89e3\u8026\u5e94\u7528\u6307\u7684\u65e0\u9700\u968fROM\u5916\u53d1\uff0c\u53ef\u901a\u8fc7\u5e94\u7528\u5546\u5e97\u81ea\u5347\u7ea7\u7684\u5e94\u7528\uff1b\u975e\u89e3\u8026\u5e94\u7528\u6307\u8fdb\u53ef\u968fROM OTA\u5347\u7ea7\u7684\u5e94\u7528\uff0c\u65e0\u6cd5\u901a\u8fc7\u5e94\u7528\u5546\u5e97\u81ea\u5347\u7ea7\u7684\u5e94\u7528\u3002</li> </ul>"},{"location":"other/term/#ipd","title":"IPD\u6d41\u7a0b","text":"<p>Integrated Product Development / \u96c6\u6210\u4ea7\u54c1\u5f00\u53d1</p> <p>IPD \u7684\u601d\u60f3\u6765\u6e90\u4e8e PRTM \u516c\u53f8 1986 \u5e74\u63d0\u51fa\u7684\u300a\u4ea7\u54c1\u53ca\u751f\u547d\u5468\u671f\u4f18\u5316\u6cd5\u300b\uff08\u7b80\u79f0 PACE - Product and Cycle-time Excellence\uff09\u3002\u540e\u6765 IBM \u5438\u6536\u4e86 PACE \u5f88\u591a\u7684\u7406\u8bba\u7cbe\u534e\uff0c\u66f4\u5f3a\u8c03\u8de8\u90e8\u95e8\u534f\u540c\u4ee5\u53ca\u5e02\u573a\u9a71\u52a8\u7684\u91cd\u8981\u6027\uff0c\u5e76\u96c6\u6210\u4e86\u7f57\u4f2f\u7279\u00b7G\u00b7\u5e93\u4f2f\u7684\u95e8\u5f84\uff08Stage-Gate\uff09\u7406\u5ff5\uff0c\u6700\u7ec8\u5f62\u6210\u4e86 IBM \u4ea7\u54c1\u5f00\u53d1\u7684\u65b9\u6cd5\u4f53\u7cfb\u2014\u2014IPD\u30021998 \u5e74\u534e\u4e3a\u5728 IBM \u7684\u5e2e\u52a9\u4e0b\u5bfc\u5165 IPD\uff0c\u540e\u7ecf\u8fc7\u4e8c\u5341\u5e74\u7684\u4e0d\u65ad\u53d1\u5c55\u4f18\u5316\uff0c\u5f62\u6210\u4e86\u534e\u4e3a\u7279\u8272\u7684 IPD \u6574\u5957\u65b9\u6cd5\u8bba\u548c\u53ef\u64cd\u4f5c\u4f53\u7cfb\u3002 \u00b7</p> <ul> <li>TR1\uff1a\u6982\u5ff5\u8bc4\u5ba1\uff0c\u786e\u8ba4\u6982\u5ff5\u662f\u5426\u53ef\u884c</li> <li>TR2\uff1a\u65b9\u6848\u8bc4\u5ba1\uff0c\u786e\u8ba4\u65b9\u6848\u662f\u5426\u53ef\u884c</li> <li>TR3\uff1a\u53ef\u884c\u6027\u8bc4\u5ba1\uff0c\u786e\u8ba4\u652f\u6301PDR\u7684\u6280\u672f\u65b9\u6848\u662f\u5426\u53ef\u884c</li> <li>TR4\uff1a\u6280\u672f\u65b9\u6848\u4e0e\u6392\u671f\u8bc4\u5ba1\uff0c\u786e\u8ba4\u6280\u672f\u65b9\u6848\u53ca\u6392\u671f\u3001\u6d4b\u8bd5\u65b9\u6848\u53ca\u6392\u671f\u662f\u5426\u53ef\u884c</li> <li>TR4A\uff1aFC\u8bc4\u5ba1\uff0c\u786e\u8ba4\u5de5\u5177\u662f\u5426FC</li> <li>TR5\uff1a\u7a33\u5b9a\u72b6\u6001\u8bc4\u5ba1\uff0c\u786e\u8ba4\u662f\u5426\u8fbe\u5230\u62c9\u7a33\u5b9a\u5206\u652f\u7684\u8d28\u91cf\u6807\u51c6</li> <li>TR6\uff1a\u5c01\u5305\u8bc4\u5ba1\uff0c\u786e\u8ba4\u5168\u5bb6\u662f\u5426\u8fbe\u5230\u5c01\u5305\u6807\u51c6</li> </ul>"},{"location":"python/django/apache/","title":"Apache\u90e8\u7f72Django","text":""},{"location":"python/django/apache/#2018-02-06-python36","title":"2018-02-06 \u66f4\u65b0\u4f7f\u7528python3.6\u7248\u672c","text":""},{"location":"python/django/apache/#linuxapache","title":"Linux\u90e8\u7f72Apache\u751f\u4ea7\u73af\u5883","text":"<pre><code>Ubuntu 14.04\nApache 2.4.7\nPython 3.6\nDjango 2.0.2\n</code></pre>"},{"location":"python/django/apache/#1ubuntupython36","title":"1\u3001ubuntu\u5b89\u88c5python3.6","text":"<p>ubuntu14.04\u7cfb\u7edf\u4f1a\u81ea\u5e26python2.7\u548cpython3.4\uff0c\u8bf7\u4e0d\u8981\u5378\u8f7dpython2.7\uff0c\u4e5f\u4e0d\u8981\u5c06\u65b0\u5b89\u88c5\u7684python3.6\u6307\u5411python/python3\u3002</p> <pre><code>sudo apt-get install python-software-properties\nsudo apt-get install software-properties-common\n\n# sudo add-apt-repository ppa:deadsnakes/ppa\nsudo add-apt-repository ppa:jonathonf/python-3.6\n\nsudo apt-get update\nsudo apt-get install python3.6 python3.6-dev python3.6-venv\n</code></pre> <p>How to install pip for Python 3.6 on Ubuntu 16.10?</p>"},{"location":"python/django/apache/#2apache2","title":"2\u3001\u5b89\u88c5apache2","text":"<pre><code>sudo apt-get update\nsudo apt-get install apache2 apache2-dev\n</code></pre> <p>On Linux systems, if Apache has been installed from a package repository, you must have installed the corresponding Apache \"dev\" package as well.</p>"},{"location":"python/django/apache/#3mod_wsgi","title":"3\u3001\u5b89\u88c5<code>mod_wsgi</code>\u6a21\u5757","text":"<p><code>mod_wsgi</code>\u4f9d\u8d56\u4e8e<code>python</code>\u7684<code>c api</code>,\u6545\u53ea\u53ef\u652f\u6301\u4e00\u4e2a\u7248\u672c\u7684<code>python</code>\u3002\u8fd9\u5c31\u8981\u6c42<code>Django</code>\u9879\u76ee\u4f7f\u7528\u7684\u865a\u62df\u73af\u5883\u4e2d\u7684<code>python</code>\u7248\u672c\u548c<code>mod_wsgi</code>\u7f16\u8bd1\u4f7f\u7528\u7684<code>python</code>\u7248\u672c\u5b8c\u5168\u76f8\u540c\uff0c\u4e0d\u7136\u5c06\u65e0\u6cd5\u4f7f\u7528\u3002</p> <p>pip \u5b89\u88c5<code>wsgi</code>\u7684\u5e93\u65f6\u4f1a\u81ea\u52a8\u5411<code>/etc/apache2/mods-available/</code>\u4e2d\u6dfb\u52a0<code>wsgi.conf(\u7a7a\u7684\u6ce8\u91ca\u6587\u4ef6)\u548cwsgi.load</code>\uff0c\u624b\u52a8\u5b89\u88c5\u9700\u8981\u624b\u52a8\u65b0\u589e<code>wsgi.load</code>\u6587\u4ef6\u3002</p> <p><code>wsgi.load</code>:</p> <pre><code>LoadModule wsgi_module /usr/lib/apache2/modules/mod_wsgi.so\nmod_wsgi.so\u4f4d\u4e8e\u6587\u4ef6\u5939/usr/lib/apache2/modules/\u4e2d\n</code></pre> <ul> <li>\u65b9\u6cd51\uff1apip \u5b89\u88c5</li> </ul> <pre><code>sudo apt-get install libapache2-mod-wsgi-py3\n</code></pre> <p>\u8be5\u65b9\u6cd5\u5c06\u76f4\u63a5\u4f7f\u7528\u7cfb\u7edf\u7684<code>python3</code>\u5bf9\u5e94\u7684<code>python</code>\u7248\u672c\u7f16\u8bd1<code>mod_wsgi</code>,<code>ubuntu14.04</code>\u7cfb\u7edf\u7684\u9ed8\u8ba4<code>python3</code>\u4e3a<code>python3.4</code>,\u800c<code>python3.4</code>\u5728<code>django2.02</code>\u540e\u5c06\u65e0\u6cd5\u4f7f\u7528\u3002<code>ubuntu16.06</code>\u7cfb\u7edf\u9ed8\u8ba4\u7684<code>python3</code>\u4e3a<code>python3.5</code>\u3002</p> <p>\u540c\u4e00\u7cfb\u7edf\u6709\u591a\u4e2a<code>python3</code>,\u7cfb\u7edf\u9ed8\u8ba4\u53d6\u6700\u4f4e\u7248\u672c\u7684python3\u4ee5\u63d0\u4f9b\u66f4\u597d\u7684\u517c\u5bb9\u6027\u3002</p> <p>\u53ef\u4ee5\u4f7f\u7528\u4e0b\u8ff0\u547d\u4ee4\u6765\u4fee\u6539\u9ed8\u8ba4<code>python</code>\u548c<code>python3</code>\u7684\u7248\u672c\uff0c\u4f46\u662f\u5f3a\u70c8\u4e0d\u63a8\u8350\uff0c\u4fee\u6539\u9ed8\u8ba4<code>python\\python3</code>\u7248\u672c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u7cfb\u7edf\u65e0\u6cd5\u6b63\u5e38\u8fd0\u884c\u3002</p> <pre><code># \u8bbe\u7f6epython-&gt;python3.6 python3-&gt;python3.6\nsudo cp /usr/bin/python /usr/bin/python_bak\nsudo rm /usr/bin/python')\nsudo ln -s /usr/bin/python3.6 /usr/bin/python\nsudo cp /usr/bin/python3 /usr/bin/python3_bak\nsudo rm /usr/bin/python3')\nsudo ln -s /usr/bin/python3.6 /usr/bin/python3\n</code></pre> <p>python\u751f\u6210\u7684\u865a\u62df\u73af\u5883\u7248\u672c\u5fc5\u987b\u548c\u7f16\u8bd1\u4f7f\u7528\u7684mod_wsgi\u7248\u672c\u76f8\u540c:\u94fe\u63a51 \u94fe\u63a52 \u94fe\u63a53 \u94fe\u63a54 \u94fe\u63a55</p> <ul> <li>\u65b9\u6cd52\uff08\u63a8\u8350\uff09\uff1a\u5b89\u88c5\u5305\u5b89\u88c5</li> </ul> <p>\u524d\u5f80github\u4e0b\u8f7d\u6700\u65b0\u7248\u672c\u7684<code>mod_wsgi</code>,\u4e0a\u4f20\u81f3\u670d\u52a1\u5668\uff0c\u6216\u4f7f\u7528</p> <pre><code>wget -O mod_wsgi-4.6.4.tar.gz https://codeload.github.com/GrahamDumpleton/mod_wsgi/tar.gz/4.6.4\n</code></pre> <p>\u4e0b\u8f7d\uff0c\u6267\u884c\u4e0b\u5217\u547d\u4ee4\u5b89\u88c5\uff1a</p> <pre><code>tar xvfz mod_wsgi-X.Y.tar.gz # \u89e3\u538b\ncd mod_wsgi-X.Y/ # \u8fdb\u5165\u89e3\u538b\u76ee\u5f55\nsudo ./configure --with-python=/usr/bin/python3.6 # \u6307\u5b9apython\u7248\u672c\u7f16\u8bd1mod_wsgi\u6a21\u5757\nsudo make # \u7f16\u8bd1\nsudo make install # \u5b89\u88c5\nsudo nano /etc/apache2/mods-available/wsgi.load # \u65b0\u589ewsgi.load\nLoadModule wsgi_module /usr/lib/apache2/modules/mod_wsgi.so # wsgi.load\u6587\u4ef6\u5199\u5165 \u52a0\u8f7dmod_wsgi\nsudo a2enmod wsgi # \u5f00\u542fmod_wsgi\nsudo service apache2 restart # \u91cd\u542fapache2\n</code></pre> <p>mod_wsgi \u3010Unpacking The Source Code\u90e8\u5206\u3011 Stack Overflow\u4e2dValentin Kantor\u7684\u56de\u7b54</p>"},{"location":"python/django/apache/#4xsendfile","title":"4\u3001\u5b89\u88c5xsendfile\u6a21\u5757","text":"<p><code>xsendfile</code>\u4e3b\u8981\u7528\u4e8e\u6587\u4ef6\u4e0a\u4f20\u4e0b\u8f7d\uff0c\u4e0d\u9700\u8981\u8be5\u529f\u80fd\u8bf7\u76f4\u63a5\u8df3\u8fc7\uff0c\u8be5\u6a21\u5757\u4e0e\u7f16\u8bd1<code>python</code>\u65e0\u5173\uff0c\u53ef\u76f4\u63a5pip\u5b89\u88c5\u3002</p> <pre><code>sudo apt-get install libapache2-mod-xsendfile\nsudo a2enmod xsendfile\n</code></pre>"},{"location":"python/django/apache/#5","title":"5\u3001\u521b\u5efa\u865a\u62df\u73af\u5883","text":"<ul> <li>\u65b9\u6cd5\u4e00\uff08\u63a8\u8350\uff09\uff1a</li> </ul> <pre><code>python3.6 -m venv environment # \u521b\u5efa\u865a\u62df\u73af\u5883 python3.3\u540e\u7248\u672c\u652f\u6301\n</code></pre> <ul> <li>\u65b9\u6cd5\u4e8c\uff1a</li> </ul> <pre><code>sudo apt-get install python3-pip # \u6b64pip\u5bf9\u5e94python3.4\nsudo pip3 install virtualenv # \u6b64pip3\u5bf9\u5e94python3.4\nvirtualenv environment --python=python3.6 # \u6307\u5b9a\u521b\u5efa\u7684\u73af\u5883\u4f7f\u7528python3.6,\u4e0d\u6307\u5b9a\u5c06\u4f7f\u7528\u9ed8\u8ba4\u7684python3.4\u800c\u5bfc\u81f4\u65e0\u6cd5\u517c\u5bb9mod_wsgi\u7f16\u8bd1\u7248\u672c\u3002\n</code></pre> <p>\u6fc0\u6d3b\\\u5173\u95ed\u865a\u62df\u73af\u5883</p> <pre><code>source environment/bin/activate \u6fc0\u6d3b\u865a\u62df\u73af\u5883\ndeactivate \u5173\u95ed\u865a\u62df\u73af\u5883\n</code></pre>"},{"location":"python/django/apache/#6apache2","title":"6\u3001\u914d\u7f6eapache2","text":"<pre><code>sudo chmod -R 777 /etc/apache2 # \u4e3aapache2\u76ee\u5f55\u5f00\u542f\u8bfb\u5199\u6743\u9650,\u9632\u6b62\u8bbe\u7f6e\u4fdd\u5b58\u5931\u8d25\nsudo chmod -R /django/demo # \u4e3a\u9879\u76ee\u5f00\u542f\u8bfb\u5199\u6743\u9650,\u65b9\u4fbf\u7f16\u8f91\nsudo nano /etc/apache2/site-available/demo.conf # \u7f16\u8f91\u914d\u7f6e\u6587\u4ef6\n</code></pre> <p><code>demo.conf</code>:</p> <pre><code>&lt;VirtualHost *:8000&gt;\nServerAdmin ykh@dreamgo.tech\nServerName 192.168.1.102\nDocumentRoot /django/demo\nAlias /static /django/demo/static\n&lt;Directory /django/demo/static&gt;\nRequire all granted\n&lt;/Directory&gt;\nAlias /static /django/demo/media\n&lt;Directory /django/demo/media&gt;\nRequire all granted\n&lt;/Directory&gt;\nWSGIScriptAlias / /django/demo/demo/wsgi.py\n&lt;Directory /django/demo/demo&gt;\n&lt;Files wsgi.py&gt;\nRequire all granted\n&lt;/Files&gt;\n&lt;/Directory&gt;\nWSGIDaemonProcess 192.168.1.102 python-path=/django/demo python-home=/django/demo/environment\nWSGIProcessGroup 192.168.1.102\n&lt;/VirtualHost&gt;\n</code></pre> <p>\u4f7f\u75288000\u7aef\u53e3\u9700\u8981\u914d\u7f6e\uff1a</p> <pre><code>sudo ufw allow 8000 \u9632\u706b\u5899\u5f00\u653e8000\u7aef\u53e3\n</code></pre> <p>\u7f16\u8f91<code>/etc/apache2/ports.conf</code>\u6587\u4ef6,\u65b0\u589eListen 8000,\u4fdd\u5b58\u5e76\u91cd\u542fApache2\u3002</p> <p>\u4f7f\u7528\u547d\u4ee4\u5f00\u542f\u7ad9\u70b9\uff1a</p> <pre><code>sudo a2enmod wsgi\nsudo a2ensite 000-default.conf\nsudo service apache2 reload\nsudo service apache2 restart\n</code></pre> <p>\u7ad9\u70b9\u5173\u95ed\u547d\u4ee4</p> <pre><code>sudo a2dissite 000-default.conf\n</code></pre> <p>Apache\u9ed8\u8ba4\u7684\u65e5\u5fd7\u6587\u4ef6\u4f4d\u4e8e/var/log/apache2/error.log</p> <pre><code>\u914d\u7f6e\u865a\u62df\u4e3b\u673a\uff1aErrorLog /django/dreamgo/error.log\n</code></pre> <p>Django\u4e2d\u6587\u8bed\u8a00\u9519\u8bef\uff1a</p> <pre><code>\u9519\u8bef\u63d0\u793a\uff1a no translation files found for default language zh_Hans\n\u89e3\u51b3\u65b9\u6848\uff1a \u5728settings\u4e2d\u5c06LANGUAGE_CODE = 'zh_Hans'\u6539\u4e3aLANGUAGE_CODE = 'zh-hans'\n\u53ef\u81f3\uff0c\u5bf9\u5e94\u7684\u8bed\u8a00\u4ee3\u7801\u53ef\u81f3django/conf/locale/__init__.py\u4e2d\u67e5\u627e\u3002\n</code></pre>"},{"location":"python/django/apache/#7mysql57","title":"7\u3001\u5b89\u88c5mysql5.7","text":"<p><code>ubuntu16.06</code>\u8bf7\u76f4\u63a5\u5b89\u88c5\uff0c<code>apt-get install mysql-server</code>,\u7248\u672c\u4e3a5.7.12\u3002</p> <p><code>ubuntu14.04</code>: \u7531\u4e8e\u4e0d\u540c\u7248\u672c\u7684sql\u65e0\u6cd5\u5907\u4efd\uff0c\u6545\u4f7f\u7528\u548cwindows\u4e0a\u76f8\u540c\u7684mysql5.7,linux apt-get \u5b89\u88c5\u7684\u4e3a5.5.54\u3002</p> <p>\u6b65\u9aa4\uff1a</p> <pre><code>wget http://dev.mysql.com/get/mysql-apt-config_0.6.0-1_all.deb\nsudo dpkg -i mysql-apt-config_0.6.0-1_all.deb\nsudo apt-get update\nsudo apt-get install mysql-server\nmysql --version\n</code></pre> <ul> <li>\u51fa\u73b0\u4e2d\u6587\u4e71\u7801\u9519\u8bef</li> </ul> <pre><code>CREATE DATABASE &lt;dbname&gt; CHARACTER SET utf8;\n\u8bf7\u5728\u521b\u9020\u6570\u636e\u5e93\u7684\u65f6\u5019\u6307\u5b9a\u6570\u636e\u5e93\u7f16\u7801\u96c6\u4e3autf8\uff1b\n</code></pre> <ul> <li><code>pip mysqlclient</code>\u65f6\u63d0\u793a <code>mysql_config not found</code></li> </ul> <pre><code>sudo apt-get install libmysqlclient-dev\n</code></pre>"},{"location":"python/django/apache/#8mysqlwindowsubuntu","title":"8\u3001MySql\u7531Windows\u8fc1\u79fb\u81f3Ubuntu","text":"<p>Windows\u8fdb\u5165C:\\Program Files\\MySQL\\MySQL Server 5.7\\bin\u6253\u5f00cmd:</p> <p>Windows:</p> <pre><code>mysqldump -uroot -proot --all-databases &gt;C:\\all_data.sql \u5907\u4efd\u5168\u90e8\u6570\u636e\u5e93\n</code></pre> <p>Linux:</p> <pre><code>mysql -uroot -proot \u8fdb\u5165mysql\u547d\u4ee4\u4ea4\u4e92\u7ec8\u7aef\n    create database dreamgo; \u65b0\u5efa\u6570\u636e\u5e93\n    drop database dreamgo\uff1b \u5220\u9664\u6570\u636e\u5e93\n    show databases; \u5217\u51fa\u6240\u6709\u6570\u636e\u5e93\n    use database_name; \u4f7f\u7528\u67d0\u4e2a\u6570\u636e\u5e93\n</code></pre> <p>\u901a\u7528\uff1a</p> <pre><code>mysql --version \u67e5\u770bmysql\u7248\u672c\nmysqldump -uroot -p dreamgo &gt;C:\\dreamgo.sql \u5907\u4efd\u4e00\u4e2a\u6570\u636e\u5e93 \u9700\u8981\u8fc1\u79fb\u7684\u4e24\u4e2a\u6570\u636e\u5e93\u7248\u672c\u76f8\u540c\nmysqldump -uroot -p database_name &lt;C:\\dreamgo.sql \u6062\u590d\u6570\u636e\u63d0\u793a\u6210\u529f\u4f46\u662f\u65e0\u8868\u88ab\u6dfb\u52a0\nmysql -uroot -p database_name &lt;C:\\dreamgo.sql \u6062\u590d\u6570\u636e\u6210\u529f\nmysql_upgrade -uroot -proot --force \u63d0\u793a\u7cfb\u7edf\u7684session\u8868\u4e0d\u5b58\u5728\u65f6\u6267\u884c\n</code></pre>"},{"location":"python/django/apache/#9https","title":"9\u3001Https\u652f\u6301","text":"<ol> <li> <p>\u524d\u5f80\u963f\u91cc\u4e91\u6ce8\u518c\u5e76\u4e0b\u8f7d\u514d\u8d39CA\u8bc1\u4e66\uff0c\u8bf7\u6ce8\u610f\u7ed1\u5b9a\u57df\u540d\u65f6\u514d\u8d39\u7684CA\u8bc1\u4e66\u4ec5\u53ef\u7ed1\u5b9a\u5355\u4e2a\u666e\u901a\u57df\u540d\uff0c\u4e0d\u53ef\u7ed1\u5b9a\u901a\u7528\u57df\u540d\uff0c\u65e2\u82e5\u4f7f\u7528\u7684\u57df\u540d\u662f\u4e8c\u7ea7\u57df\u540d\u7684\u8bdd\uff0c\u9700\u8981\u76f4\u63a5\u7ed1\u5b9a\u5230\u4e8c\u7ea7\u57df\u540d\u800c\u4e0d\u662f\u7236\u7ea7\u57df\u540d\u3002</p> </li> <li> <p>\u5728<code>/etc/apache2/</code>\u6587\u4ef6\u5939\u6839\u76ee\u5f55\u4e0b\u521b\u5efa\u4e00\u4e2acert\u6587\u4ef6\u5939\uff0c\u518d\u5728cert\u6587\u4ef6\u5939\u4e0b\u521b\u5efa\u4e00\u4e2a<code>blog_dreamgotech_com</code>\u6587\u4ef6\u5939\uff0c\u62f7\u8d1d\u963f\u91cc\u4e91\u4e0b\u8f7d\u7684\u8bc1\u4e66\u538b\u7f29\u5305\u4e2d\u7684\u56db\u4e2a\u6587\u4ef6\u5230\u5728<code>/etc/apache2/cert/blog_dreamgotech_com/</code>\u6587\u4ef6\u5939\u4e0b\u3002</p> </li> <li> <p>\u5f00\u542f<code>ssl</code>\u4ee5\u53ca<code>rewrite</code>\u6a21\u5757</p> </li> </ol> <pre><code>sudo a2enmod rewrite\nsudo a2enmod ssl\n</code></pre> <ol> <li>\u786e\u8ba4<code>ports.conf</code>\u5982\u4e0b\uff1a</li> </ol> <pre><code>Listen 80\n&lt;IfModule ssl_module&gt;\nListen 443\n&lt;/IfModule&gt;\n&lt;IfModule mod_gnutls.c&gt;\nListen 443\n&lt;/IfModule&gt;\n</code></pre> <ol> <li>\u914d\u7f6e<code>blog.conf</code>\u6587\u4ef6\u4e3a</li> </ol> <pre><code>&lt;VirtualHost *:80&gt;\n# Http\u91cd\u5b9a\u5411\u81f3Https\u7ad9\u70b9\nServerName blog.dreamgotech.com\nRewriteEngine On\nRewriteCond %{HTTP_HOST} ^blog\\.dreamgotech\\.com\nRewriteCond %{HTTPS} off\nRewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI}\n&lt;/VirtualHost&gt;\n&lt;VirtualHost *:443&gt;\nServerName blog.dreamgotech.com\nServerAdmin ykh@dreamgo.tech\nDocumentRoot /django/Blog/\nSSLEngine on\n# \u6dfb\u52a0 SSL \u534f\u8bae\u652f\u6301\u534f\u8bae\uff0c\u53bb\u6389\u4e0d\u5b89\u5168\u7684\u534f\u8bae\nSSLProtocol all -SSLv2 -SSLv3\n# \u4fee\u6539\u52a0\u5bc6\u5957\u4ef6\u5982\u4e0b\nSSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM\nSSLHonorCipherOrder on\n# \u8bc1\u4e66\u516c\u94a5\u914d\u7f6e\nSSLCertificateFile cert/blog_dreamgotech_com/public.pem\n# \u8bc1\u4e66\u79c1\u94a5\u914d\u7f6e\nSSLCertificateKeyFile cert/blog_dreamgotech_com/xxxx.key\n# \u8bc1\u4e66\u94fe\u914d\u7f6e\uff0c\u5982\u679c\u8be5\u5c5e\u6027\u5f00\u5934\u6709 '#'\u5b57\u7b26\uff0c\u8bf7\u5220\u9664\u6389\nSSLCertificateChainFile cert/blog_dreamgotech_com/chain.pem\nAlias /static /django/Blog/static/\n&lt;Directory /django/Blog/static/&gt;\nRequire all granted\n&lt;/Directory&gt;\nAlias /media /django/Blog/media/\n&lt;Directory /django/Blog/media/&gt;\nRequire all granted\n&lt;/Directory&gt;\nWSGIScriptAlias / /django/Blog/Blog/wsgi.py\n&lt;Directory /django/Blog/Blog&gt;\n&lt;Files wsgi.py&gt;\nRequire all granted\n&lt;/Files&gt;\n&lt;/Directory&gt;\nWSGIPassAuthorization On\nWSGIDaemonProcess blog.dreamgo.tech python-path=/django/Blog python-home=/django/Blog/environment\nWSGIProcessGroup blog.dreamgo.tech\nWSGIScriptAlias / /django/Blog/Blog/wsgi.py\nErrorLog /django/Blog/log/error.log\nCustomLog /django/Blog/log/access.log combined\n&lt;/VirtualHost&gt;\n</code></pre> <ol> <li>\u91cd\u542fApache</li> </ol>"},{"location":"python/django/apache/#10pip","title":"10\u3001pip\u4fee\u6539\u6e90","text":"<p>window\u4e0a\u4fee\u6539user/Administrator/AppData/Local/pip/pip.ini\u4e3a</p> <pre><code>[global]  index-url = http://pypi.douban.com/simple/ [install] trusted-host=pypi.douban.com </code></pre> <p>\u963f\u91cc\u4e91\u7684linux\u4e91\u670d\u52a1\u5668\u81ea\u52a8\u4f1a\u4fee\u6539\u6e90\u4e3a\u963f\u91cc\u4e91\uff0c\u914d\u7f6e\u672c\u5730linux\u4e3b\u673apip\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>sudo mkdir ~/.pip\ncd ~/.pip\nsudo touch pip.conf\nsudo nano pip.conf\n\u5185\u5bb9\u4fee\u6539\u5982\u4e0a\n</code></pre>"},{"location":"python/django/apache/#11mysql","title":"11\u3001mysql\u81ea\u52a8\u5907\u4efd","text":"<pre><code>sudo apt-get install automysqlbackup\n\u5b89\u88c5\u65f6\u82e5\u63d0\u793a\u9009\u62e9mail\u65f6\u4f7f\u7528\u5de6\u53f3\u952e\u9009\u4e2dOK\u7ee7\u7eed\u5373\u53ef\n\nautomysqlbackup\u7684\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e/etc/default/automysqlbackup\u6587\u4ef6\nsudo nano /etc/default/automysqlbackup\n\n\u65b0\u5efa\u5907\u4efd\u76ee\u5f55\"/django/mysql_backup\"\u5e76\u8d4b\u4e88777\u6743\u9650\n</code></pre> <p>automysqlbackup,\u9700\u8981\u914d\u7f6e\u8d26\u6237\u3001\u5bc6\u7801\u3001\u5907\u4efd\u76ee\u5f55\u3001\u5907\u4efd\u9891\u7387\u3001\u5f85\u5907\u4efd\u6570\u636e\u5e93\u540d\u79f0\u5217\u8868:</p> <pre><code># By default, the Debian version of automysqlbackup will use:\n# mysqldump --defaults-file=/etc/mysql/debian.cnf\n# but you might want to overwrite with a specific user &amp; pass.\n# To do this, simply edit bellow.\n# Username to access the MySQL server e.g. dbuser\nUSERNAME=\"root\"\n# Username to access the MySQL server e.g. password\nPASSWORD=\"root\"\n# Host name (or IP address) of MySQL server e.g localhost\nDBHOST=localhost\n# List of DBNAMES for Daily/Weekly Backup e.g. \"DB1 DB2 DB3\"\n# Note that it's absolutely normal that the db named \"mysql\" is not in this\n# list, as it's added later by the script. See the MDBNAMES directives below\n# in this file (advanced options).\n# This is ONLY a convenient default, if you don't like it, don't complain\n# and write your own.\n# The following is a quick hack that will find the names of the databases by\n# reading the mysql folder content. Feel free to replace by something else.\nDBNAMES=\"all\"\n# Backup directory location e.g /backups\n# Folders inside this one will be created (daily, weekly, etc.), and the\n# subfolders will be database names. Note that backups will be owned by\n# root, with Unix rights 0600.\nBACKUPDIR=\"/django/mysql_backup\"\n# Mail setup\n# What would you like to be mailed to you?\n# - log   : send only log file\n# - files : send log file and sql files as attachments (see docs)\n# - stdout : will simply output the log to the screen if run manually.\n# - quiet : Only send logs if an error occurs to the MAILADDR.\nMAILCONTENT=\"files\"\n# Set the maximum allowed email size in k. (4000 = approx 5MB email [see\n# docs])\nMAXATTSIZE=\"4000\"\n# Email Address to send mail to? (user@domain.com)\nMAILADDR=\"ykh@dreamgo.tech\"\n# ============================================================\n# === ADVANCED OPTIONS ( Read the doc's below for details )===\n#=============================================================\n# List of DBBNAMES for Monthly Backups.\nMDBNAMES=\"mysql $DBNAMES\"\n# List of DBNAMES to EXLUCDE if DBNAMES are set to all (must be in \" quotes)\nDBEXCLUDE=\"information_schema performance_schema sys mysql\"\n# Include CREATE DATABASE in backup?\nCREATE_DATABASE=yes\n# Separate backup directory and file for each DB? (yes or no)\nSEPDIR=yes\n# Which day do you want weekly backups? (1 to 7 where 1 is Monday)\nDOWEEKLY=6\n# Choose Compression type. (gzip or bzip2)\nCOMP=gzip\n# Compress communications between backup server and MySQL server?\nCOMMCOMP=no\n# Additionally keep a copy of the most recent backup in a seperate\n# directory.\nLATEST=no\n#  The maximum size of the buffer for client/server communication. e.g. 16MB\n#  (maximum is 1GB)\nMAX_ALLOWED_PACKET=\n#  For connections to localhost. Sometimes the Unix socket file must be\n#  specified.\nSOCKET=\n# Command to run before backups (uncomment to use)\n#PREBACKUP=\"/etc/mysql-backup-pre\"\n# Command run after backups (uncomment to use)\n#POSTBACKUP=\"/etc/mysql-backup-post\"\n# Backup of stored procedures and routines (comment to remove)\nROUTINES=yes\n</code></pre> <p>\u6267\u884c\u547d\u4ee4</p> <pre><code>sudo automysqlbackup /etc/default/automysqlbackup </code></pre> <p>\u8fd0\u884c\u914d\u7f6e\u5373\u53ef\u5728\u5bf9\u5e94\u7684\u5907\u4efd\u76ee\u5f55\u770b\u5230\u5907\u4efd\u7684\u6570\u636e\u5e93\u6587\u4ef6</p>"},{"location":"python/django/apache/#10","title":"10\u3001\u5e38\u89c1\u95ee\u9898&amp;\u5907\u6ce8","text":"<ul> <li>ubuntu\u6587\u4ef6\u64cd\u4f5c</li> </ul> <pre><code>sudo touch xxx.etx \u65b0\u5efa\u6587\u4ef6\nsudo mkdir xxx \u65b0\u5efa\u76ee\u5f55\nsudo mv dir1 dir2 \u526a\u5207\u6587\u4ef6\u5939\nsudo rm -rf dir \u5220\u9664\u6587\u4ef6\u5939\nsudo cp file dir \u62f7\u8d1d\u6587\u4ef6\u81f3\u67d0\u4e2a\u6587\u4ef6\u5939\n</code></pre> <ul> <li>Pillow\u5b89\u88c5\u9519\u8bef</li> </ul> <pre><code>sudo apt-get install python3-dev\nsudo apt-get install libjpeg8-dev\nsudo ln -s /usr/lib/x86_64-linux-gnu/libjpeg.so /usr/lib\n\npip install pillow\n</code></pre> <ul> <li>\u670d\u52a1\u5668500\u9519\u8bef</li> </ul> <p>\u5982\u679c\u6709log\u6587\u4ef6\uff0c\u5fc5\u987b\u5bf9log\u6587\u4ef6\u6240\u5728\u7684\u7236\u7ea7\u76ee\u5f55\u6388\u6743\u3002</p> <ul> <li>Nginx VS Apache2</li> </ul> <p>Apache\u9002\u7528\u4e8e\u8ba1\u7b97\u5bc6\u96c6\u578b\u7684\u52a8\u6001\u8bf7\u6c42(\u540e\u7aef)\uff0cNginx\u9002\u5408IO\u5bc6\u96c6\u578b\u7684\u9759\u6001\u6587\u4ef6\u5206\u53d1\u548c\u53cd\u5411\u4ee3\u7406(\u524d\u7aef)\u3002</p> <ul> <li>\u57df\u540d\u91cd\u5b9a\u5411</li> </ul> <p>\u6700\u8fd1\u4e3a\u535a\u5ba2\u66f4\u6362\u4e86\u65b0\u57df\u540d\uff0c\u4e0d\u5e0c\u671b\u4e4b\u524d\u770b\u535a\u5ba2\u7684\u4eba\u627e\u4e0d\u5230\u65b0\u57df\u540d\uff0c\u53c8\u4e0d\u60f3\u90e8\u7f72\u4e24\u4e2a\u7ad9\u70b9\u5bfc\u81f4\u5185\u5bb9\u5272\u88c2\u3002\u4e8e\u662f\u5229\u7528Apache\u7684\u57df\u540d\u91cd\u5b9a\u5411\u529f\u80fd\uff0c\u5c06\u65e7\u7684\u57df\u540d\u8bf7\u6c42\u76f4\u63a5\u91cd\u5b9a\u5411\u81f3\u65b0\u57df\u540d\u4e0b\u3002\u5982\u8bbf\u95ee\u65e7\u57df\u540d<code>blog.dreamgotech.com/article/26/</code>\u5c06\u88ab\u91cd\u5b9a\u5411\u5230\u65b0\u57df\u540d<code>www.yinkh.top/article/26/</code>\u3002\u5177\u4f53\u5b9e\u73b0\uff1a</p> <pre><code>&lt;VirtualHost *:80&gt;\nServerName xy.example.com\nRedirectPermanent / http://abc.example.com/\n&lt;/VirtualHost&gt;\n</code></pre> <p>\u5bf9\u4e8e\u6211\u7684\u535a\u5ba2\u6765\u8bf4\uff0c\u7531\u4e8e\u6709<code>http</code>\u548c<code>https</code>\u4e4b\u95f4\u7684\u91cd\u5b9a\u5411\uff0c\u4e8e\u662f\u8bbe\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>&lt;VirtualHost *:80&gt;\nServerName blog.dreamgotech.com\nRedirectPermanent / http://www.yinkh.top/\n&lt;/VirtualHost&gt;\n&lt;VirtualHost *:443&gt;\nServerName blog.dreamgotech.com\nServerAdmin ykh@dreamgo.tech\nRedirectPermanent / https://www.yinkh.top/\nSSLEngine on\nSSLProtocol all -SSLv2 -SSLv3\nSSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM\nSSLHonorCipherOrder on\nSSLCertificateFile cert/blog_dreamgotech_com/public.pem\nSSLCertificateKeyFile cert/blog_dreamgotech_com/214278817430753.key\nSSLCertificateChainFile cert/blog_dreamgotech_com/chain.pem\n&lt;/VirtualHost&gt;\n</code></pre>"},{"location":"python/django/apache/#2017-08-30","title":"2017-08-30 \u7248\u672c","text":""},{"location":"python/django/apache/#linuxapache_1","title":"Linux\u90e8\u7f72Apache\u751f\u4ea7\u73af\u5883","text":"<pre><code>Ubuntu 14.04\nApache 2.4.7\nPython 3.4\nDjango 1.10.6\n</code></pre>"},{"location":"python/django/apache/#1ubuntupython35","title":"1\u3001ubuntu\u5b89\u88c5python3.5","text":"<p>ubuntu14.04\u7cfb\u7edf\u4f1a\u81ea\u5e26python2.7\uff0c\u8bf7\u4e0d\u8981\u5378\u8f7d\u5b83\u3002</p> <pre><code>sudo apt-get install python-software-properties\nsudo apt-get install software-properties-common\n\nsudo add-apt-repository ppa:fkrull/deadsnakes\nsudo apt-get update\nsudo apt-get install python3.5\n\nsudo cp /usr/bin/python /usr/bin/python_bak \u5148\u5907\u4efd\nsudo rm /usr/bin/python \u5220\u9664\nsudo ln -s /usr/bin/python3.5 /usr/bin/python \u9ed8\u8ba4\u8bbe\u7f6e\u6210python3.5\n</code></pre>"},{"location":"python/django/apache/#2apache","title":"2\u3001\u5b89\u88c5apache\u7b49\u5fc5\u8981\u6a21\u5757","text":"<pre><code>sudo apt-get update\nsudo apt-get install python3-pip apache2 libapache2-mod-wsgi-py3\n\n\u5728python3\u73af\u5883\u4e0b\u4f7f\u7528pip3\u5b89\u88c5\u8f6f\u4ef6\u800c\u4e0d\u662fpip(python2\u4f7f\u7528)\nsudo pip3 install virtualenv\n\nvirtualenv dreamgo_env \u65b0\u5efa\u865a\u62df\u73af\u5883\nsource dreamgo/bin/activate \u6fc0\u6d3b\u865a\u62df\u73af\u5883\ndeactivate \u5173\u95ed\u865a\u62df\u73af\u5883\n\nsudo apt-get install gedit\n</code></pre>"},{"location":"python/django/apache/#3apache2","title":"3\u3001\u914d\u7f6eapache2","text":"<pre><code>sudo chmod -R 777 /etc/apache2 \u4e3aapache2\u76ee\u5f55\u5f00\u542f\u8bfb\u5199\u6743\u9650,\u9632\u6b62\u8bbe\u7f6e\u4fdd\u5b58\u5931\u8d25\nsudo chmod -R /home/dreamgo/dreamgo_official_site \u4e3a\u9879\u76ee\u5f00\u542f\u8bfb\u5199\u6743\u9650,\u65b9\u4fbf\u7f16\u8f91\n\n\u76f4\u63a5\u8fdb\u5165/etc/apache2/site-available/\u6587\u4ef6\u5939\u7f16\u8f91000-default.conf\u6216\u8005\u4f7f\u7528\u547d\u4ee4\uff1a\nsudo gedit /etc/apache2/site-available/000-default.conf\u7f16\u8f91\u914d\u7f6e\u6587\u4ef6\n</code></pre> <p>000-default.conf:</p> <pre><code>&lt;VirtualHost *:8000&gt;\nServerAdmin ykh@dreamgo.tech\nServerName 192.168.1.102\nDocumentRoot /home/dreamgo/dreamgo_official_site\nAlias /static /home/dreamgo/dreamgo_official_site/static\n&lt;Directory /home/dreamgo/dreamgo_official_site/static&gt;\nRequire all granted\n&lt;/Directory&gt;\n&lt;Directory /home/dreamgo/dreamgo_official_site/dreamgo_official_site&gt;\n&lt;Files wsgi.py&gt;\nRequire all granted\n&lt;/Files&gt;\n&lt;/Directory&gt;\nWSGIDaemonProcess 192.168.1.102 python-path=/home/dreamgo/dreamgo_official_site python-home=/home/dreamgo/dreamgo_official_site/dreamgo_env\nWSGIProcessGroup 192.168.1.102\nWSGIScriptAlias / /home/dreamgo/dreamgo_official_site/dreamgo_official_site/wsgi.py\n&lt;/VirtualHost&gt;\n</code></pre> <p>\u4f7f\u75288000\u7aef\u53e3\u9700\u8981\u914d\u7f6e\uff1a</p> <pre><code>sudo ufw allow 8000 \u9632\u706b\u5899\u5f00\u653e8000\u7aef\u53e3\n\u7f16\u8f91/etc/apache2/ports.conf\u6587\u4ef6,\u65b0\u589eListen 8000,\u4fdd\u5b58\u3002\n</code></pre> <p>\u4f7f\u7528\u547d\u4ee4\u5f00\u542f\u7ad9\u70b9\uff1a</p> <pre><code>sudo a2enmod wsgi\nsudo a2ensite 000-default.conf\nsudo service apache2 reload\nsudo service apache2 restart\n</code></pre> <p>\u7ad9\u70b9\u5173\u95ed\u547d\u4ee4</p> <pre><code>sudo a2dissite 000-default.conf\n</code></pre> <p>Django\u4e2d\u6587\u8bed\u8a00\u9519\u8bef\uff1a</p> <pre><code>\u9519\u8bef\u63d0\u793a\uff1a no translation files found for default language zh_Hans\n\u89e3\u51b3\u65b9\u6848\uff1a \u5728settings\u4e2d\u5c06LANGUAGE_CODE = 'zh_Hans'\u6539\u4e3aLANGUAGE_CODE = 'zh-hans'\n\u53ef\u81f3\uff0c\u5bf9\u5e94\u7684\u8bed\u8a00\u4ee3\u7801\u53ef\u81f3django/conf/locale/__init__.py\u4e2d\u67e5\u627e\u3002\n</code></pre>"},{"location":"python/django/apache/#4mysqlwindowsubuntu","title":"4\u3001MySql\u7531Windows\u8fc1\u79fb\u81f3Ubuntu","text":"<p>Windows\u8fdb\u5165C:\\Program Files\\MySQL\\MySQL Server 5.7\\bin\u6253\u5f00cmd:</p> <p>Windows:</p> <pre><code>mysqldump -uroot -proot --all-databases &gt;C:\\all_data.sql \u5907\u4efd\u5168\u90e8\u6570\u636e\u5e93\n</code></pre> <p>Linux:</p> <pre><code>mysql -uroot -proot \u8fdb\u5165mysql\u547d\u4ee4\u4ea4\u4e92\u7ec8\u7aef\n    create database dreamgo; \u65b0\u5efa\u6570\u636e\u5e93\n    drop database dreamgo\uff1b \u5220\u9664\u6570\u636e\u5e93\n    show databases; \u5217\u51fa\u6240\u6709\u6570\u636e\u5e93\n    use database_name; \u4f7f\u7528\u67d0\u4e2a\u6570\u636e\u5e93\n</code></pre> <p>\u901a\u7528\uff1a</p> <pre><code>mysql --version \u67e5\u770bmysql\u7248\u672c\nmysqldump -uroot -p dreamgo &gt;C:\\dreamgo.sql \u5907\u4efd\u4e00\u4e2a\u6570\u636e\u5e93 \u9700\u8981\u8fc1\u79fb\u7684\u4e24\u4e2a\u6570\u636e\u5e93\u7248\u672c\u76f8\u540c\nmysqldump -uroot -p database_name &lt;C:\\dreamgo.sql \u6062\u590d\u6570\u636e\u63d0\u793a\u6210\u529f\u4f46\u662f\u65e0\u8868\u88ab\u6dfb\u52a0\nmysql -uroot -p database_name &lt;C:\\dreamgo.sql \u6062\u590d\u6570\u636e\u6210\u529f\nmysql_upgrade -uroot -proot --force \u63d0\u793a\u7cfb\u7edf\u7684session\u8868\u4e0d\u5b58\u5728\u65f6\u6267\u884c\n</code></pre>"},{"location":"python/django/apache/#5apache","title":"5\u3001Apache\u6a21\u5757\u914d\u7f6e","text":"<p>pip \u5b89\u88c5wsgi\u7684\u5e93\u65f6\u4f1a\u81ea\u52a8\u5411/etc/apache2/mods-available/\u4e2d\u6dfb\u52a0wsgi.conf\u548cwsgi.load</p> <p>wsgi.load:</p> <pre><code>LoadModule wsgi_module /usr/lib/apache2/modules/mod_wsgi.so\nmod_wsgi.so\u4f4d\u4e8e\u6587\u4ef6\u5939/usr/lib/apache2/modules/\u4e2d\n</code></pre> <p>Apache\u9ed8\u8ba4\u7684\u65e5\u5fd7\u6587\u4ef6\u4f4d\u4e8e/var/log/apache2/error.log</p> <pre><code>\u914d\u7f6e\u865a\u62df\u4e3b\u673a\uff1aErrorLog /django/dreamgo/error.log\n</code></pre> <p>\u5b89\u88c5xsendfile,\u7528\u4e8e\u6587\u4ef6\u4e0a\u4f20\u4e0b\u8f7d\u3002</p> <pre><code>sudo apt-get install libapache2-mod-xsendfile\nsudo a2enmod xsendfile\n</code></pre>"},{"location":"python/django/apache/#6","title":"6\u3001\u6587\u4ef6\u64cd\u4f5c","text":"<pre><code>sudo touch xxx.etx \u65b0\u5efa\u6587\u4ef6\nsudo mkdir xxx \u65b0\u5efa\u76ee\u5f55\nsudo mv dir1 dir2 \u526a\u5207\u6587\u4ef6\u5939\nsudo rm -rf dir \u5220\u9664\u6587\u4ef6\u5939\n</code></pre>"},{"location":"python/django/apache/#7","title":"7\u3001\u914d\u7f6e\u9879\u76ee","text":"<p>Pillow\u5b89\u88c5\u9519\u8bef</p> <pre><code>sudo apt-get install python3-dev\nsudo apt-get install libjpeg8-dev\nsudo ln -s /usr/lib/x86_64-linux-gnu/libjpeg.so /usr/lib\n\npip install pillow\n</code></pre> <p>\u5982\u679c\u6709log\u6587\u4ef6\uff0c\u5fc5\u987b\u5bf9log\u6587\u4ef6\u6240\u5728\u7684\u7236\u7ea7\u76ee\u5f55\u6388\u6743\u3002</p>"},{"location":"python/django/apache/#8mysql57","title":"8\u3001\u5b89\u88c5mysql5.7","text":"<p>\u7531\u4e8e\u4e0d\u540c\u7248\u672c\u7684sql\u65e0\u6cd5\u5907\u4efd\uff0c\u6545\u4f7f\u7528\u548cwindows\u4e0a\u76f8\u540c\u7684mysql5.7,linux apt-get \u5b89\u88c5\u7684\u4e3a5.5.54\u3002</p> <p>\u6b65\u9aa4\uff1a</p> <pre><code>wget http://dev.mysql.com/get/mysql-apt-config_0.6.0-1_all.deb\nsudo dpkg -i mysql-apt-config_0.6.0-1_all.deb\nsudo apt-get update\nsudo apt-get install mysql-server\nmysql --version\n</code></pre> <ul> <li>\u51fa\u73b0\u4e2d\u6587\u4e71\u7801\u9519\u8bef</li> </ul> <pre><code>CREATE DATABASE &lt;dbname&gt; CHARACTER SET utf8;\n\u8bf7\u5728\u521b\u9020\u6570\u636e\u5e93\u7684\u65f6\u5019\u6307\u5b9a\u6570\u636e\u5e93\u7f16\u7801\u96c6\u4e3autf8\uff1b\n</code></pre> <ul> <li>pip mysqlclient\u65f6\u63d0\u793a mysql_config not found</li> </ul> <pre><code>sudo apt-get install libmysqlclient-dev\n</code></pre>"},{"location":"python/django/apache/#9https_1","title":"9\u3001Https\u652f\u6301","text":"<ol> <li> <p>\u524d\u5f80\u963f\u91cc\u4e91\u6ce8\u518c\u5e76\u4e0b\u8f7d\u514d\u8d39CA\u8bc1\u4e66\uff0c\u8bf7\u6ce8\u610f\u7ed1\u5b9a\u57df\u540d\u65f6\u514d\u8d39\u7684CA\u8bc1\u4e66\u4ec5\u53ef\u7ed1\u5b9a\u5355\u4e2a\u666e\u901a\u57df\u540d\uff0c\u4e0d\u53ef\u7ed1\u5b9a\u901a\u7528\u57df\u540d\uff0c\u65e2\u82e5\u4f7f\u7528\u7684\u57df\u540d\u662f\u4e8c\u7ea7\u57df\u540d\u7684\u8bdd\uff0c\u9700\u8981\u76f4\u63a5\u7ed1\u5b9a\u5230\u4e8c\u7ea7\u57df\u540d\u800c\u4e0d\u662f\u7236\u7ea7\u57df\u540d\u3002</p> </li> <li> <p>\u5728<code>/etc/apache2/</code>\u6587\u4ef6\u5939\u6839\u76ee\u5f55\u4e0b\u521b\u5efa\u4e00\u4e2acert\u6587\u4ef6\u5939\uff0c\u518d\u5728cert\u6587\u4ef6\u5939\u4e0b\u521b\u5efa\u4e00\u4e2a<code>blog_dreamgotech_com</code>\u6587\u4ef6\u5939\uff0c\u62f7\u8d1d\u963f\u91cc\u4e91\u4e0b\u8f7d\u7684\u8bc1\u4e66\u538b\u7f29\u5305\u4e2d\u7684\u56db\u4e2a\u6587\u4ef6\u5230\u5728<code>/etc/apache2/cert/blog_dreamgotech_com/</code>\u6587\u4ef6\u5939\u4e0b\u3002</p> </li> <li> <p>\u5f00\u542f<code>ssl</code>\u4ee5\u53ca<code>rewrite</code>\u6a21\u5757</p> </li> </ol> <pre><code>sudo a2enmod rewrite\nsudo a2enmod ssl\n</code></pre> <ol> <li>\u786e\u8ba4<code>ports.conf</code>\u5982\u4e0b\uff1a</li> </ol> <pre><code>Listen 80\n&lt;IfModule ssl_module&gt;\nListen 443\n&lt;/IfModule&gt;\n&lt;IfModule mod_gnutls.c&gt;\nListen 443\n&lt;/IfModule&gt;\n</code></pre> <ol> <li>\u914d\u7f6e<code>blog.conf</code>\u6587\u4ef6\u4e3a</li> </ol> <pre><code>&lt;VirtualHost *:80&gt;\n# Http\u91cd\u5b9a\u5411\u81f3Https\u7ad9\u70b9\nRewriteEngine On\nRewriteCond %{HTTPS} off\nRewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI}\n&lt;/VirtualHost&gt;\n&lt;VirtualHost *:443&gt;\nServerName blog.dreamgotech.com\nServerAdmin ykh@dreamgo.tech\nDocumentRoot /django/Blog/\nSSLEngine on\n# \u6dfb\u52a0 SSL \u534f\u8bae\u652f\u6301\u534f\u8bae\uff0c\u53bb\u6389\u4e0d\u5b89\u5168\u7684\u534f\u8bae\nSSLProtocol all -SSLv2 -SSLv3\n# \u4fee\u6539\u52a0\u5bc6\u5957\u4ef6\u5982\u4e0b\nSSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM\nSSLHonorCipherOrder on\n# \u8bc1\u4e66\u516c\u94a5\u914d\u7f6e\nSSLCertificateFile cert/blog_dreamgotech_com/public.pem\n# \u8bc1\u4e66\u79c1\u94a5\u914d\u7f6e\nSSLCertificateKeyFile cert/blog_dreamgotech_com/xxxx.key\n# \u8bc1\u4e66\u94fe\u914d\u7f6e\uff0c\u5982\u679c\u8be5\u5c5e\u6027\u5f00\u5934\u6709 '#'\u5b57\u7b26\uff0c\u8bf7\u5220\u9664\u6389\nSSLCertificateChainFile cert/blog_dreamgotech_com/chain.pem\nAlias /static /django/Blog/static/\n&lt;Directory /django/Blog/static/&gt;\nRequire all granted\n&lt;/Directory&gt;\nAlias /media /django/Blog/media/\n&lt;Directory /django/Blog/media/&gt;\nRequire all granted\n&lt;/Directory&gt;\nWSGIScriptAlias / /django/Blog/Blog/wsgi.py\n&lt;Directory /django/Blog/Blog&gt;\n&lt;Files wsgi.py&gt;\nRequire all granted\n&lt;/Files&gt;\n&lt;/Directory&gt;\nWSGIPassAuthorization On\nWSGIDaemonProcess blog.dreamgo.tech python-path=/django/Blog python-home=/django/Blog/environment\nWSGIProcessGroup blog.dreamgo.tech\nWSGIScriptAlias / /django/Blog/Blog/wsgi.py\nErrorLog /django/Blog/log/error.log\nCustomLog /django/Blog/log/access.log combined\n&lt;/VirtualHost&gt;\n</code></pre> <ol> <li>\u91cd\u542fApache</li> </ol>"},{"location":"python/django/apache/#10pip_1","title":"10\u3001pip\u4fee\u6539\u6e90","text":"<p>window\u4e0a\u4fee\u6539user/Administrator/AppData/Local/pip/pip.ini\u4e3a</p> <pre><code>[global]  index-url = http://pypi.douban.com/simple/ [install] trusted-host=pypi.douban.com </code></pre> <p>\u963f\u91cc\u4e91\u7684linux\u4e91\u670d\u52a1\u5668\u81ea\u52a8\u4f1a\u4fee\u6539\u6e90\u4e3a\u963f\u91cc\u4e91\uff0c\u914d\u7f6e\u672c\u5730linux\u4e3b\u673apip\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>sudo mkdir ~/.pip\ncd ~/.pip\nsudo touch pip.conf\nsudo gedit pip.conf\n\u5185\u5bb9\u4fee\u6539\u5982\u4e0a\n</code></pre>"},{"location":"python/django/apache/#11mysql_1","title":"11\u3001mysql\u81ea\u52a8\u5907\u4efd","text":"<pre><code>sudo apt-get install automysqlbackup\n\u5b89\u88c5\u65f6\u82e5\u63d0\u793a\u9009\u62e9mail\u65f6\u4f7f\u7528\u5de6\u53f3\u952e\u9009\u4e2dOK\u7ee7\u7eed\u5373\u53ef\n\nautomysqlbackup\u7684\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e/etc/default/automysqlbackup\u6587\u4ef6\nsudo gedit /etc/default/automysqlbackup\n\n\u65b0\u5efa\u5907\u4efd\u76ee\u5f55\"/django/mysql_backup\"\u5e76\u8d4b\u4e88777\u6743\u9650\n</code></pre> <p>automysqlbackup,\u9700\u8981\u914d\u7f6e\u8d26\u6237\u3001\u5bc6\u7801\u3001\u5907\u4efd\u76ee\u5f55\u3001\u5907\u4efd\u9891\u7387\u3001\u5f85\u5907\u4efd\u6570\u636e\u5e93\u540d\u79f0\u5217\u8868:</p> <pre><code># By default, the Debian version of automysqlbackup will use:\n# mysqldump --defaults-file=/etc/mysql/debian.cnf\n# but you might want to overwrite with a specific user &amp; pass.\n# To do this, simply edit bellow.\n# Username to access the MySQL server e.g. dbuser\nUSERNAME=\"root\"\n# Username to access the MySQL server e.g. password\nPASSWORD=\"root\"\n# Host name (or IP address) of MySQL server e.g localhost\nDBHOST=localhost\n\n# List of DBNAMES for Daily/Weekly Backup e.g. \"DB1 DB2 DB3\"\n# Note that it's absolutely normal that the db named \"mysql\" is not in this\n# list, as it's added later by the script. See the MDBNAMES directives below\n# in this file (advanced options).\n# This is ONLY a convenient default, if you don't like it, don't complain\n# and write your own.\n# The following is a quick hack that will find the names of the databases by\n# reading the mysql folder content. Feel free to replace by something else.\nDBNAMES=\"all\"\n# Backup directory location e.g /backups\n# Folders inside this one will be created (daily, weekly, etc.), and the\n# subfolders will be database names. Note that backups will be owned by\n# root, with Unix rights 0600.\nBACKUPDIR=\"/django/mysql_backup\"\n# Mail setup\n# What would you like to be mailed to you?\n# - log   : send only log file\n# - files : send log file and sql files as attachments (see docs)\n# - stdout : will simply output the log to the screen if run manually.\n# - quiet : Only send logs if an error occurs to the MAILADDR.\nMAILCONTENT=\"quiet\"\n# Set the maximum allowed email size in k. (4000 = approx 5MB email [see\n# docs])\nMAXATTSIZE=\"4000\"\n# Email Address to send mail to? (user@domain.com)\nMAILADDR=\"ykh@dreamgo.tech\"\n# ============================================================\n# === ADVANCED OPTIONS ( Read the doc's below for details )===\n#=============================================================\n# List of DBBNAMES for Monthly Backups.\nMDBNAMES=\"mysql $DBNAMES\"\n# List of DBNAMES to EXLUCDE if DBNAMES are set to all (must be in \" quotes)\nDBEXCLUDE=\"information_schema performance_schema sys\"\n# Include CREATE DATABASE in backup?\nCREATE_DATABASE=yes\n\n# Separate backup directory and file for each DB? (yes or no)\nSEPDIR=yes\n\n# Which day do you want weekly backups? (1 to 7 where 1 is Monday)\nDOWEEKLY=6\n# Choose Compression type. (gzip or bzip2)\nCOMP=gzip\n\n# Compress communications between backup server and MySQL server?\nCOMMCOMP=no\n\n# Additionally keep a copy of the most recent backup in a seperate\n# directory.\nLATEST=no\n\n#  The maximum size of the buffer for client/server communication. e.g. 16MB\n#  (maximum is 1GB)\nMAX_ALLOWED_PACKET=\n#  For connections to localhost. Sometimes the Unix socket file must be\n#  specified.\nSOCKET=\n# Command to run before backups (uncomment to use)\n#PREBACKUP=\"/etc/mysql-backup-pre\"\n# Command run after backups (uncomment to use)\n#POSTBACKUP=\"/etc/mysql-backup-post\"\n# Backup of stored procedures and routines (comment to remove)\nROUTINES=yes\n</code></pre> <p>\u6267\u884c\u547d\u4ee4</p> <pre><code>sudo automysqlbackup /etc/default/automysqlbackup </code></pre> <p>\u8fd0\u884c\u914d\u7f6e\u5373\u53ef\u5728\u5bf9\u5e94\u7684\u5907\u4efd\u76ee\u5f55\u770b\u5230\u5907\u4efd\u7684\u6570\u636e\u5e93\u6587\u4ef6</p>"},{"location":"python/django/apache/#12xfce4","title":"12\u3001\u963f\u91cc\u4e91\u4e0axfce4\u4e2d\u6587\u4e71\u7801","text":"<pre><code>\u4e0b\u8f7d\u4e2d\u6587\u652f\u6301\u5305\uff1a\nsudo apt-get install language-pack-zh-hans\n\u4e0b\u8f7d\u4e2d\u6587\u5b57\u4f53\uff1a\nsudo apt-get install fonts-wqy-zenhei\n</code></pre>"},{"location":"python/django/django-TinyMCE/","title":"Django Admin\u4e2d\u96c6\u6210TinyMCE","text":"<p>\u4f7f\u7528\u7684\u7248\u672c\uff1aDjango 1.10.2  TinyMCE 4.4.3</p>"},{"location":"python/django/django-TinyMCE/#1","title":"\u6b65\u9aa41","text":"<p>\u524d\u5f80TinyMCE\u5b98\u7f51\u4e0b\u8f7dTinyMCE_4.4.3\uff0c\u66f4\u65e9\u4e4b\u524d\u7684\u7248\u672c\u53ef\u4ee5\u70b9\u51fb\u6b64\u5904\u4e0b\u8f7d\u3002</p>"},{"location":"python/django/django-TinyMCE/#2","title":"\u6b65\u9aa42","text":"<p>\u6253\u5f00tinymce_4.4.3/tinymce/js\u6587\u4ef6\u5939\uff0c\u62f7\u8d1d\u5176\u4e2d\u7684tinymce\u6587\u4ef6\u5939\u81f3Django\u9879\u76ee\u7684STATIC_ROOT\u5bf9\u5e94\u8def\u5f84\u7684js\u6587\u4ef6\u5939\u4e0b\uff0c\u76ee\u5f55\u7ed3\u6784\u4e3aSTATIC_ROOT/js/tinymce\u3002</p>"},{"location":"python/django/django-TinyMCE/#3","title":"\u6b65\u9aa43","text":"<p>\u5728STATIC_ROOT/js/\u6587\u4ef6\u5939\u4e0b\u65b0\u5efatextareas.js\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>tinymce.init({\nselector: 'textarea',\nheight: 300,\ntheme: 'modern',\nmenubar: false,\nplugins: [\n'advlist autolink autosave sh4tinymce  link image lists charmap print preview hr anchor pagebreak spellchecker',\n'searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking',\n'save table contextmenu directionality emoticons template paste textcolor','codesample autoresize table'\n],\ntoolbar1: \"undo redo | bold italic codesample sh4tinymce underline | alignleft aligncenter alignright alignjustify \" +\n\"| table link image media | print preview | forecolor backcolor emoticons | bullist numlist outdent indent \" +\n\"| styleselect formatselect fontselect fontsizeselect\",\nlanguage: 'zh_CN',\ncontent_css: [\n'//fonts.googleapis.com/css?family=Lato:300,300i,400,400i',\n'//www.tinymce.com/css/codepen.min.css'\n]\n});\n</code></pre> <ul> <li>\u5176\u4e2dselector\u5bf9\u5e94\u7684\u662f\u5bcc\u6587\u672c\u7f16\u8f91\u5668\u5728\u9875\u9762\u4e2d\u5bf9\u5e94\u7684\u4f5c\u7528\u57df</li> <li>height\u548cweight\u5206\u522b\u5bf9\u5e94\u7684\u5bcc\u6587\u672c\u7f16\u8f91\u5668\u7f16\u8f91\u6846\u7684\u9ad8\u548c\u5bbd\u6b64\u5904\u5bbd\u5ea6\u672a\u8bbe\u7f6e\u5219\u548c\u754c\u9762\u540c\u5bbd</li> <li>theme\u4e3a\u7f16\u8f91\u5668\u4e3b\u9898\uff0c\u53ef\u5728tinymce/themes\u6587\u4ef6\u5939\u4e0b\u770b\u5230\u6709\u4e09\u4e2a\u5b50\u6587\u4ef6\u5939\uff0c\u5206\u522b\u662fadvanced\u3001inlite\u3001modern\uff0c\u5bf9\u5e94\u7684\u6587\u4ef6\u540d\u5373\u53ef\u4f5c\u4e3atheme\u7684\u58f0\u660e\u9009\u9879\u3002</li> <li>menubar\u8bbe\u7f6e\u4e3atrue\u65f6\u663e\u793a\u6700\u4e0a\u65b9\u9ed8\u8ba4\u83dc\u5355\u680f\uff0c\u4e3afalse\u5219\u4e0d\u663e\u793a\u3002</li> <li>plugins\u4e3a\u8be5\u6b64\u5bcc\u6587\u672c\u7f16\u8f91\u5668\u4f7f\u7528\u5230\u7684\u63d2\u4ef6\uff0c\u53ef\u4ee5\u81ea\u5df1\u5b9a\u4e49\u9002\u5408\u81ea\u5df1\u9700\u6c42\u7684\uff0c\u5bf9\u5e94\u7684plugins\u4f4d\u4e8etinymce/plugins\u6587\u4ef6\u5939\u4e0b\uff0c\u7528\u6237\u53ef\u4ee5\u81ea\u5df1\u9700\u8981\u7684\u529f\u80fd\u81ea\u5b9a\u4e49plugins\u5e76\u52a0\u5165\u5230\u58f0\u660e\u5217\u8868\u4e2d\u5373\u53ef\u751f\u6548\uff1b\u6240\u6709\u9884\u8bbe\u7684plugin\u5747\u4f7f\u7528\u538b\u7f29\u8fc7\u7684.min.js\u6587\u4ef6\u7c7b\u578b\uff0c\u53ef\u4f7f\u7528\u5728\u7ebf\u4ee3\u7801\u683c\u5f0f\u5316 \u5de5\u5177\u67e5\u770b\u3002\u5176\u4e2dimage\u3001media\u4e0d\u652f\u6301\u5728\u7ebf\u4e0a\u4f20\u529f\u80fd\uff0c\u53ea\u53ef\u4ee5\u63d2\u5165\u56fe\u7247\u5730\u5740\u6765\u5b9e\u73b0\u63d2\u5165\u56fe\u7247\u3001\u89c6\u9891\u529f\u80fd\uff0c\u7b2c\u4e09\u65b9\u56fe\u7247\u4e0a\u4f20\u53ef\u4ee5\u8003\u8651\u4e03\u725b\u4e91\u548cuploadcare\uff0c\u4e03\u725b\u4e91\u5e76\u6ca1\u6709\u627e\u5230\u53ef\u4ee5\u4f7f\u7528\u73b0\u6210\u7684plugin\u4f46\u662f\u5176\u63d0\u4f9b\u7684\u514d\u8d39\u5b58\u50a8\u7a7a\u95f4\u5927\uff0cuploadcare\u53ef\u4ee5\u81f3\u6b64\u5904\u4e0b\u8f7dplugins(\u4eb2\u6d4b\u53ef\u7528)\u4f46\u514d\u8d39\u5b58\u50a8\u5bb9\u91cf\u53ea\u6709500M\uff1bsimplecode\u4e3a\u63d2\u5165\u4ee3\u7801\u533a\u5757\u7684plugin\uff1bautosize\u652f\u6301\u52a8\u6001\u7684\u6839\u636e\u5f53\u524d\u7f16\u8f91\u7684\u6587\u672c\u5185\u5bb9\u591a\u5c11\u8c03\u6574\u7f16\u8f91\u6846\u7684\u5927\u5c0f;autosave\u53ef\u4ee5\u76f4\u63a5\u5728\u7f16\u8f91\u6846\u4e2d\u6309\u4e0bctrl+s\u6765\u8fdb\u884c\u4fdd\u5b58\u3002</li> <li>toolbar\u4e3a\u5de5\u5177\u6761\u751f\u547d\uff0c\u53ef\u4ee5\u58f0\u660e\u591a\u4e2a\u5de5\u5177\u6761\uff0c\u53ea\u6709\u5728\u5de5\u5177\u6761\u4e2d\u7684plugins\u624d\u80fd\u770b\u5230\u5feb\u6377\u65b9\u5f0f\u56fe\u7247\uff0c\u9700\u8981\u6ce8\u610f | \u7b26\u53f7\u7684\u4e24\u8fb9\u9700\u8981\u7559\u51fa\u7a7a\u683c\u3002</li> <li>language\u4e3a\u5bcc\u6587\u672c\u7f16\u8f91\u5668\u7684\u63d0\u793a\u4f7f\u7528\u8bed\u8a00\uff0c\u53ef\u81f3\u6b64\u5904\u4e0b\u8f7d\u5bf9\u5e94\u7684js\u6587\u4ef6\u540e\u62f7\u8d1d\u81f3tinymce/langs/\u6587\u4ef6\u5939\u4e0b\u5e76\u58f0\u660e\u5373\u53ef\u3002</li> </ul>"},{"location":"python/django/django-TinyMCE/#4","title":"\u6b65\u9aa44","text":"<p>\u5728app\u76ee\u5f55\u4e0b\u7684admin.py\u6587\u4ef6\u4e2d\u63d2\u5165\u5982\u4e0b\u4ee3\u7801\u5373\u53ef\u5b9e\u73b0model\u4e2dTextField \u5bf9\u5e94\u7684\u5b57\u6bb5\u4f7f\u7528\u5bcc\u6587\u672c\u7f16\u8f91\u5668\u6765\u8fdb\u884c\u7f16\u8f91\u7684\u76ee\u7684\u3002</p> <pre><code>class ArticleAdmin(admin.ModelAdmin):\n.\n.\n.\nclass Media:\njs = (\n'/STATIC_ROOT/js/tinymce/tinymce.min.js',\n'/STATIC_ROOT/js/textareas.js',\n)\n</code></pre>"},{"location":"python/django/django-TinyMCE/#5","title":"\u6b65\u9aa45","text":"<p>\u9884\u89c8\u56fe\uff1a</p> <p></p>"},{"location":"python/django/django-admin/","title":"Django admin\u5bf9\u6bd4","text":""},{"location":"python/django/django-admin/#1-admin","title":"1 \u539f\u751fadmin","text":"<p>\u4f18\u70b9\uff1a\u517c\u5bb9\u6027\u597d \u7f3a\u70b9\uff1a\u6837\u5f0f\u4e0d\u597d\u770b \u64cd\u4f5c\u6548\u7387\u4f4e \u4e0d\u517c\u5bb9\u624b\u673a\u7aef</p>"},{"location":"python/django/django-admin/#2-xadmin","title":"2 xadmin","text":"<p>\u4f18\u70b9\uff1a\u64cd\u4f5c\u5feb\u6377 \u7f3a\u70b9\uff1a\u4e0d\u517c\u5bb9django\u6700\u65b0\u7248\u672c</p>"},{"location":"python/django/django-admin/#3-django-material","title":"3 Django-material","text":"<p>\u4f18\u70b9\uff1a\u6837\u5f0f\u7f8e\u89c2 \u517c\u5bb9\u624b\u673a\u7aef \u7f3a\u70b9\uff1a\u4e0d\u652f\u6301\u7ea7\u8054\u4fee\u6539 \u4e0d\u652f\u6301filter_horizontal\u65b9\u5f0f\u9009\u62e9M2M</p> <p></p>"},{"location":"python/django/django-admin/#4-django-admin-bootstrap","title":"4 Django admin bootstrap","text":"<p>\u6837\u5f0f\u9519\u4f4d\uff0c\u4e0d\u8003\u8651\u3002</p> <p></p>"},{"location":"python/django/django-admin/#5-django-suit","title":"5 django suit","text":"<p>\u7f3a\u70b9\uff1a\u4e0d\u597d\u770b \u4e0d\u517c\u5bb9\u624b\u673a \u5546\u7528\u6536\u8d39</p> <p></p>"},{"location":"python/django/django-admin/#6-django-flat-response","title":"6 django flat response","text":"<p>\u4f18\u70b9\uff1a\u6837\u5f0f\u5b8c\u5168\u548c\u539f\u751fadmin\u4e00\u6837 \u53ea\u662f\u589e\u52a0\u4e86\u539f\u751f\u7aef\u624b\u673a\u9002\u914d 1.9\u4ee5\u524d\u53ef\u4ee5\u4f7f\u7528django-flat-theme</p> <p>\u81ea\u5b9a\u4e49base_site.html\u65f6\u9700\u8981\u5728</p> <pre><code>{% extends \"admin/base.html\" %}\n</code></pre> <p>\u4e4b\u540e\u52a0\u5165</p> <pre><code>{% load admin_static %}\n{% block blockbots %}\n  {{ block.super }}\n  &lt;meta name=\"viewport\" content=\"user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0\"&gt;\n  &lt;link rel=\"stylesheet\" type=\"text/css\" href=\"{% static 'admin/css/responsive.css' %}\" /&gt;\n{% endblock %}\n</code></pre> <p>\u624d\u80fd\u4f7f\u54cd\u5e94\u5f0fadmin\u751f\u6548\uff0c\u5c31\u662f\u52a0\u5165\u4e86\u4e00\u4e2aadmin/css/responsive.css</p> <p></p>"},{"location":"python/django/django-admin/#7-django-grappelli","title":"7 django grappelli","text":"<p>\u7f3a\u70b9\uff1a\u4e0d\u597d\u770b \u4e0d\u517c\u5bb9\u624b\u673a \u8bf8\u591a\u517c\u5bb9\u6027\u95ee\u9898</p>"},{"location":"python/django/django-celery/","title":"Django celery","text":"<p>celery.py</p> <pre><code>from __future__ import absolute_import\nimport os\nfrom celery import Celery\nfrom django.conf import settings\n# set the default Django settings module for the 'celery' program.  \nos.environ.setdefault('DJANGO_SETTINGS_MODULE', 'SchoolMS.settings')\napp = Celery('SchoolMS')\n# Using a string here means the worker will not have to  \n# pickle the object when using Windows.  \napp.config_from_object('django.conf:settings')\napp.autodiscover_tasks(lambda: settings.INSTALLED_APPS)\n</code></pre> <p>init.py</p> <pre><code>from __future__ import absolute_import\n# This will make sure the app is always imported when\n# Django starts so that shared_task will use this app.\nfrom .celery import app as celery_app\n</code></pre> <p>setting.py</p> <pre><code># \u5b9a\u65f6\u4efb\u52a1\nbroker_url = 'amqp://guest:guest@localhost:5672//'\nCELERY_TIMEZONE = 'Asia/Shanghai'\nCELERYBEAT_SCHEDULER = 'djcelery.schedulers.DatabaseScheduler'\nCELERYBEAT_SCHEDULE = {\n'check_sms_remain_everyday': {\n'task': 'family.tasks.notify_if_sms_out',\n'schedule': crontab(minute=0, hour=10),\n'args': (),\n},\n'sms_reset': {\n'task': 'family.tasks.reset_sms_count',\n'schedule': crontab(minute=43, hour=17),\n'args': (),\n},\n}\n</code></pre> <p>task.py</p> <pre><code>from celery import shared_task, task\n@task\ndef reset_sms_count():\nsms_reset_date = get_value(settings.SMS_RESET_DATE_NAME)\nif sms_reset_date == datetime.now().day:\nfor sms_assign in SMSAssign.objects.all():\nsms_assign.period_reset()\nLogger.objects.create(user=None, category=5, content='\u7cfb\u7edf\u91cd\u7f6e\u77ed\u4fe1\u5206\u914d')\n</code></pre> <p>\u547d\u4ee4\uff1a</p> <pre><code>python manage.py celery beat -l info # \u542f\u52a8\u4efb\u52a1\u53d1\u9001\u7aef\npython manage.py celery worker -l info # \u542f\u52a8\u4efb\u52a1\u5904\u7406\u7aef worker\n</code></pre> <p>\u91cd\u542fworker\u624d\u80fd\u4f7ftask\u88c5\u9970\u8fc7\u7684\u4ee3\u7801\u5728\u4fee\u6539\u8fc7\u540e\u6539\u6210\u4fee\u6539\u4e4b\u540e\u7684\u7248\u672c\uff0c\u4e0d\u7136\u4e00\u76f4\u8fd0\u884c\u7684\u662f\u4fee\u6539\u524d\u7684\u7248\u672c\uff0c\u7c7b\u4f3c\u4e8eapache\u3002</p> <p>\u5728setting.py \u4e2d\u4fee\u6539CELERYBEAT_SCHEDULE\u8981\u6c42\u91cd\u542fbeat\u548cworker\u624d\u80fd\u5373\u65f6\u751f\u6548</p> <p>\u5b89\u88c5\u3001\u4f7f\u7528RabbitMQ:</p> <p>windows\u9700\u8981\u4e0b\u8f7d\u5b89\u88c5\u8f6f\u4ef6\uff0cLinux\u76f4\u63a5apt-get</p> <p>http://docs.celeryproject.org/en/latest/getting-started/brokers/rabbitmq.html#broker-rabbitmq</p> <pre><code>sudo apt-get install rabbitmq-server\n</code></pre> <p>\u751f\u4ea7\u73af\u5883\u90e8\u7f72\u53c2\u89c1 Supervisor\u4f7f\u7528\u7b14\u8bb0\u53cacelery\u751f\u4ea7\u90e8\u7f72</p> <p>windows\u5b9a\u65f6\u5173\u673a cmd\u8f93\u5165\uff1a</p> <pre><code>at 23:00 shutdown -s \n</code></pre> <p>\u8981\u53d6\u6d88ID\u4e3a1\u7684\u5173\u673a\u8ba1\u5212\uff1a</p> <pre><code>at 1 /delete\n</code></pre>"},{"location":"python/django/django-channels/","title":"Django-Channels\u4f7f\u7528\u548c\u90e8\u7f72","text":""},{"location":"python/django/django-channels/#django-channels","title":"Django-Channels\u4f5c\u7528","text":"<p>\u5728Django\u90e8\u7f72\u7684\u65f6\u5019\uff0c\u901a\u5e38\u4f7f\u7528\u7684\u90fd\u662fWSGI\uff08Web Server Gateway Interface\uff09\u65e2\u901a\u7528\u670d\u52a1\u7f51\u5173\u63a5\u53e3\uff0c\u8be5\u534f\u8bae\u4ec5\u7528\u6765\u5904\u7406 Http \u8bf7\u6c42\uff0c\u66f4\u591a\u5173\u4e8eWSGI\u7684\u8bf4\u660e\u8bf7\u53c2\u89c1\u5ed6\u96ea\u5cf0\u535a\u5ba2\u3002</p> <p>\u5f53\u7f51\u5740\u9700\u8981\u52a0\u5165 WebSocket \u529f\u80fd\u65f6\uff0cWSGI \u5c06\u4e0d\u518d\u6ee1\u8db3\u6211\u4eec\u7684\u9700\u6c42\uff0c\u6b64\u65f6\u6211\u4eec\u9700\u8981\u4f7f\u7528ASGI\u65e2\u5f02\u6b65\u670d\u52a1\u7f51\u5173\u63a5\u53e3\uff0c\u8be5\u534f\u8bae\u80fd\u591f\u7528\u6765\u5904\u7406\u591a\u79cd\u901a\u7528\u534f\u8bae\u7c7b\u578b\uff0c\u5305\u62ecHTTP\u3001HTTP2 \u548c WebSocket\uff0c\u66f4\u591a\u5173\u4e8e ASGI \u7684\u8bf4\u660e\u8bf7\u53c2\u89c1\u6b64\u5904\u3002</p> <p>ASGI \u7531 Django \u56e2\u961f\u63d0\u51fa\uff0c\u4e3a\u4e86\u89e3\u51b3\u5728\u4e00\u4e2a\u7f51\u7edc\u6846\u67b6\u91cc\uff08\u5982 Django\uff09\u540c\u65f6\u5904\u7406 HTTP\u3001HTTP2\u3001WebSocket \u534f\u8bae\u3002\u4e3a\u6b64\uff0cDjango \u56e2\u961f\u5f00\u53d1\u4e86 Django Channels \u63d2\u4ef6\uff0c\u4e3a Django \u5e26\u6765\u4e86 ASGI \u80fd\u529b\u3002</p> <p>\u5728 ASGI \u4e2d\uff0c\u5c06\u4e00\u4e2a\u7f51\u7edc\u8bf7\u6c42\u5212\u5206\u6210\u4e09\u4e2a\u5904\u7406\u5c42\u9762\uff0c\u6700\u524d\u9762\u7684\u4e00\u5c42\uff0cinterface server\uff08\u534f\u8bae\u5904\u7406\u670d\u52a1\u5668\uff09\uff0c\u8d1f\u8d23\u5bf9\u8bf7\u6c42\u534f\u8bae\u8fdb\u884c\u89e3\u6790\uff0c\u5e76\u5c06\u4e0d\u540c\u7684\u534f\u8bae\u5206\u53d1\u5230\u4e0d\u540c\u7684 Channel\uff08\u9891\u9053\uff09\uff1b\u9891\u9053\u5c5e\u4e8e\u7b2c\u4e8c\u5c42\uff0c\u901a\u5e38\u53ef\u4ee5\u662f\u4e00\u4e2a\u961f\u5217\u7cfb\u7edf\u3002\u9891\u9053\u7ed1\u5b9a\u4e86\u7b2c\u4e09\u5c42\u7684 Consumer\uff08\u6d88\u8d39\u8005\uff09\u3002</p> <p>\u73a9\u8f6c ASGI:\u4ece\u96f6\u5230\u4e00\u5b9e\u73b0\u4e00\u4e2a\u5b9e\u65f6\u535a\u5ba2</p>"},{"location":"python/django/django-channels/#django-channels_1","title":"Django-Channels\u4f7f\u7528","text":"<p>\u672c\u6587\u57fa\u4e8eDjango==2.1\uff0cchannels==2.1.3\uff0cchannels-redis==2.3.0\u3002</p> <p>\u793a\u4f8b\u9879\u76eeRestaurantOrder\u65e8\u5728\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8eWebSocket\u7684\u804a\u5929\u5ba4\uff0c\u5728Channels 2.1.3\u6587\u6863\u4e2dTutorial\u7684\u57fa\u7840\u4e0a\u7a0d\u52a0\u4fee\u6539\u7528\u4e8e\u5fae\u4fe1\u70b9\u9910\u8fc7\u7a0b\u4e2d\u7684\u591a\u4eba\u534f\u4f5c\u70b9\u9910\u3002</p> <p>\u5728 <code>settings.py</code> \u52a0\u5165\u548c channels \u76f8\u5173\u7684\u57fa\u7840\u8bbe\u7f6e:</p> <pre><code>INSTALLED_APPS = [\n'django.contrib.admin',\n'django.contrib.auth',\n'django.contrib.contenttypes',\n'django.contrib.sessions',\n'django.contrib.messages',\n'django.contrib.staticfiles',\n'channels',\n...\n]\nASGI_APPLICATION = \"RestaurantOrder.routing.application\"\n# WebSocket\nCHANNEL_LAYERS = {\n'default': {\n'BACKEND': 'channels_redis.core.RedisChannelLayer',\n'CONFIG': {\n\"hosts\": [('127.0.0.1', 6379)],\n},\n},\n}\n</code></pre> <p>\u5728 <code>wsgi.py</code> \u540c\u7ea7\u76ee\u5f55\u65b0\u589e\u6587\u4ef6 <code>asgi.py</code>:</p> <pre><code>\"\"\"\nASGI entrypoint. Configures Django and then runs the application\ndefined in the ASGI_APPLICATION setting.\n\"\"\"\nimport os\nimport django\nfrom channels.routing import get_default_application\nos.environ.setdefault(\"DJANGO_SETTINGS_MODULE\", \"RestaurantOrder.settings\")\ndjango.setup()\napplication = get_default_application()\n</code></pre> <p>\u5728 <code>wsgi.py</code> \u540c\u7ea7\u76ee\u5f55\u65b0\u589e\u6587\u4ef6 <code>routing.py</code>,\u5176\u4f5c\u7528\u7c7b\u578b\u4e0e <code>urls.py</code> ,\u7528\u4e8e\u5206\u53d1<code>webscoket</code>\u8bf7\u6c42:</p> routing.py<pre><code>from django.urls import path\nfrom channels.auth import AuthMiddlewareStack\nfrom channels.routing import ProtocolTypeRouter, URLRouter\nfrom table.consumers import TableConsumer\napplication = ProtocolTypeRouter({\n# Empty for now (http-&gt;django views is added by default)\n'websocket': AuthMiddlewareStack(\nURLRouter([\npath('ws/table/&lt;slug:table_id&gt;/', TableConsumer),\n])\n),\n})\n</code></pre> <p>\u65b0\u589e app \u540d\u4e3a <code>table</code>,\u5728 <code>table</code> \u76ee\u5f55\u4e0b\u65b0\u589e <code>consumers.py</code>:</p> <pre><code>from channels.generic.websocket import AsyncJsonWebsocketConsumer\nfrom table.models import Table\nclass TableConsumer(AsyncJsonWebsocketConsumer):\ntable = None\nasync def connect(self):\nself.table = 'table_{}'.format(self.scope['url_route']['kwargs']['table_id'])\n# Join room group\nawait self.channel_layer.group_add(self.table, self.channel_name)\nawait self.accept()\nasync def disconnect(self, close_code):\n# Leave room group\nawait self.channel_layer.group_discard(self.table, self.channel_name)\n# Receive message from WebSocket\nasync def receive_json(self, content, **kwargs):\n# Send message to room group\nawait self.channel_layer.group_send(self.table, {'type': 'message', 'message': content})\n# Receive message from room group\nasync def message(self, event):\nmessage = event['message']\n# Send message to WebSocket\nawait self.send_json(message)\n</code></pre> <p><code>TableConsumer</code>\u7c7b\u4e2d\u7684\u51fd\u6570\u4f9d\u6b21\u7528\u4e8e\u5904\u7406\u8fde\u63a5\u3001\u65ad\u5f00\u8fde\u63a5\u3001\u63a5\u6536\u6d88\u606f\u548c\u5904\u7406\u5bf9\u5e94\u7c7b\u578b\u7684\u6d88\u606f\uff0c\u5176\u4e2d<code>channel_layer.group_send(self.table, {'type': 'message', 'message': content})</code>\u65b9\u6cd5\uff0c<code>self.table</code> \u53c2\u6570\u4e3a\u5f53\u524d\u7ec4\u7684\u7ec4id\uff0c <code>{'type': 'message', 'message': content}</code> \u90e8\u5206\u5206\u4e3a\u4e24\u90e8\u5206\uff0c<code>type</code> \u7528\u4e8e\u6307\u5b9a\u8be5\u6d88\u606f\u7684\u7c7b\u578b\uff0c\u6839\u636e\u6d88\u606f\u7c7b\u578b\u8c03\u7528\u4e0d\u540c\u7684\u51fd\u6570\u53bb\u5904\u7406\u6d88\u606f\uff0c\u800c <code>message</code> \u5185\u4e3a\u6d88\u606f\u4e3b\u4f53\u3002</p> <p>\u5728 <code>table</code> \u76ee\u5f55\u4e0b\u7684 <code>views.py</code> \u4e2d\u65b0\u589e\u51fd\u6570\uff1a</p> <pre><code>def table(request, table_id):\nreturn render(request, 'table/table.html', {\n'room_name_json': mark_safe(json.dumps(table_id))\n})\n</code></pre> <p><code>table</code> \u51fd\u6570\u5bf9\u5e94\u7684 <code>urls.py</code> \u4e0d\u518d\u8d58\u8ff0\u3002</p> <p>\u5728 <code>table</code> \u7684 <code>templates\\table</code> \u76ee\u5f55\u4e0b\u65b0\u589e <code>table.html</code>:</p> <pre><code>&lt;!-- chat/templates/chat/room.html --&gt;\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;meta charset=\"utf-8\"/&gt;\n&lt;title&gt;Chat Room&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;textarea id=\"chat-log\" cols=\"100\" rows=\"20\"&gt;&lt;/textarea&gt;&lt;br/&gt;\n&lt;input id=\"chat-message-input\" type=\"text\" size=\"100\"/&gt;&lt;br/&gt;\n&lt;input id=\"chat-message-submit\" type=\"button\" value=\"Send\"/&gt;\n&lt;/body&gt;\n&lt;script&gt;\nvar roomName = {{ room_name_json }};\nvar chatSocket = new WebSocket('ws://' + window.location.host + '/ws/table/' + roomName + '/');\nchatSocket.onmessage = function (e) {\nvar data = JSON.parse(e.data);\ndocument.querySelector('#chat-log').value += (JSON.stringify(data) + '\\n');\n};\nchatSocket.onclose = function (e) {\nconsole.error('Chat socket closed unexpectedly');\n};\ndocument.querySelector('#chat-message-input').focus();\ndocument.querySelector('#chat-message-input').onkeyup = function (e) {\nif (e.keyCode === 13) {  // enter, return\ndocument.querySelector('#chat-message-submit').click();\n}\n};\ndocument.querySelector('#chat-message-submit').onclick = function (e) {\nvar messageInputDom = document.querySelector('#chat-message-input');\nvar message = messageInputDom.value;\nchatSocket.send(JSON.stringify(message));\nmessageInputDom.value = '';\n};\n&lt;/script&gt;\n&lt;/html&gt;\n</code></pre>"},{"location":"python/django/django-channels/#django-channels_2","title":"Django-Channels\u90e8\u7f72","text":"<p>\u5728\u5b98\u65b9\u6587\u6863\u4e2d\u63a8\u8350<code>Djaogo-Channels</code>\u7684<code>http</code>\u90e8\u5206\u548c<code>websocket</code>\u90e8\u5206\u5747\u4f7f\u7528<code>daphne</code>\u8fdb\u884c\u90e8\u7f72\uff0c\u8be5\u65b9\u6cd5\u53c2\u89c1DjangoChannels Docs\u3002</p> <p>\u672c\u6587\u4f7f\u7528\u7684\u65b9\u6cd5\u4e3a\u4f7f\u7528<code>Nginx</code>\u4ee3\u7406\uff0c\u5c06<code>http</code>\u90e8\u5206\u8bf7\u6c42\u53d1\u9001\u7ed9<code>uwsgi</code>\u8fdb\u884c\u5904\u7406\uff0c\u5c06<code>websocket</code>\u90e8\u5206\u8bf7\u6c42\u53d1\u9001\u7ed9<code>daphne</code>\u8fdb\u884c\u5904\u7406\u3002<code>uwsgi</code>\u548c<code>daphhe</code>\u5747\u4f7f\u7528<code>supervisord</code>\u8fdb\u884c\u63a7\u5236\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u7531\u4e8e<code>Nginx</code>\u65e0\u6cd5\u8bc6\u522b<code>http</code>\u8bf7\u6c42\u548c<code>websocket</code>\u8bf7\u6c42\uff0c\u9700\u8981\u901a\u8fc7\u8def\u7531\u6765\u533a\u5206\u662f\u54ea\u79cd\u534f\u8bae\u3002\u6211\u4f7f\u7528\u7684\u65b9\u6cd5\u662f\u89c4\u5b9a\u6240\u6709\u7684websocket\u7684\u8def\u7531\u5747\u4ee5/ws\u5f00\u5934(\u5982\uff1a <code>ws://www.example/ws/table/table_id/</code>)\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u8ba9<code>Nginx</code>\u5c06\u6240\u6709\u4ee5<code>/ws</code>\u5f00\u5934\u7684\u8bf7\u6c42\u5168\u90e8\u8f6c\u53d1\u7ed9<code>daphne</code>\u8fdb\u884c\u5904\u7406\u3002</p> <p>\u5728<code>Nginx</code>\u548c<code>daphne</code>\u8fdb\u884c\u901a\u4fe1\u65f6\uff0c\u6709<code>http socket</code>\u548c<code>file socket</code>\u4e24\u79cd\u901a\u4fe1\u65b9\u5f0f\uff0c\u63a8\u8350\u4f7f\u7528\u540e\u4e00\u79cd<code>file socket</code>\u7684\u65b9\u5f0f\uff0c\u5728\u8fd9\u91cc\u5217\u51fa\u4e24\u79cd\u901a\u4fe1\u65b9\u5f0f\u7684\u90e8\u7f72\u4ee3\u7801\u3002</p> <ul> <li>http socket\u65b9\u5f0f</li> </ul> <p>nginx.conf:</p> <pre><code>upstream restaurant_order {\n    server unix:///django/RestaurantOrder/restaurant_order.sock;\n}\n\nserver {\n    listen 8000;\n    server_name 114.116.25.246; # substitute your machine's IP address or FQDN\n    charset utf-8;\n    client_max_body_size 75M;\n\n    location /media {\n        alias /django/RestaurantOrder/media;\n    }\n    location /static {\n        alias /django/RestaurantOrder/static;\n    }\n\n    access_log /django/RestaurantOrder/log/access.log;\n    error_log /django/RestaurantOrder/log/error.log;\n\n    location / {\n        uwsgi_pass restaurant_order;\n        include /django/RestaurantOrder/uwsgi_params;\n    }\n\n    location /ws {\n        proxy_pass http://127.0.0.1:8001;\n\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n\n        proxy_redirect     off;\n        proxy_set_header   Host $host;\n        proxy_set_header   X-Real-IP $remote_addr;\n        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header   X-Forwarded-Host $server_name;\n        proxy_read_timeout  36000s;\n        proxy_send_timeout  36000s;\n    }\n}\n</code></pre> <p>supervisord.conf:</p> <pre><code>[program:restaurant_order_service]\ncommand=uwsgi --ini /django/RestaurantOrder/restaurant_order_uwsgi.ini\ndirectory=/django/RestaurantOrder\nstdout_logfile=/django/RestaurantOrder/log/uwsgi_out.log\nstderr_logfile=/django/RestaurantOrder/log/uwsgi_err.log\nautostart=true\nautorestart=true\nuser=root\nstartsecs=10\n\n[program:restaurant_order_websocket]\ncommand=/django/RestaurantOrder/environment/bin/daphne -b 0.0.0.0 -p 8001 RestaurantOrder.asgi:application\ndirectory=/django/RestaurantOrder\nstdout_logfile=/django/RestaurantOrder/log/websocket_out.log\nstderr_logfile=/django/RestaurantOrder/log/websocket_err.log\nautostart=true\nautorestart=true\nuser=root\nstartsecs=10\n</code></pre> <ul> <li>file socket\u65b9\u5f0f</li> </ul> <p>\u533a\u522b\u4e8e<code>http socket</code>\u7684\u4e3a2\u5904\uff0c1\u662f<code>nginx.conf</code>\u4e2d\u7684\u65b0\u589e<code>upstream websocket</code>\uff0c\u5e76\u5728<code>location /ws</code>\u4e2d\u8bbe\u7f6e<code>proxy_pass http://websocket;</code>\uff0c\u9700\u8981\u6ce8\u610f\u6b64\u5904\u7684<code>http://</code>\u524d\u7f00\u4e0d\u53ef\u7701\u7565;2\u662f<code>daphne</code>\u7684\u542f\u52a8\u65b9\u5f0f\u6539\u4e3a<code>daphne -u /django/RestaurantOrder/websocket.sock RestaurantOrder.asgi:application</code>\u3002</p> <p>nginx.conf:</p> <pre><code>upstream restaurant_order {\n    server unix:///django/RestaurantOrder/restaurant_order.sock;\n}\n\nupstream websocket {\n    server unix:///django/RestaurantOrder/websocket.sock;\n}\n\nserver {\n    listen 8000;\n    server_name 114.116.25.246; # substitute your machine's IP address or FQDN\n    charset utf-8;\n    client_max_body_size 75M;\n\n    location /media {\n        alias /django/RestaurantOrder/media;\n    }\n    location /static {\n        alias /django/RestaurantOrder/static;\n    }\n\n    access_log /django/RestaurantOrder/log/access.log;\n    error_log /django/RestaurantOrder/log/error.log;\n\n    location / {\n        uwsgi_pass restaurant_order;\n        include /django/RestaurantOrder/uwsgi_params;\n    }\n\n    location /ws {\n        proxy_pass http://websocket;\n\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n\n        proxy_redirect     off;\n        proxy_set_header   Host $host;\n        proxy_set_header   X-Real-IP $remote_addr;\n        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header   X-Forwarded-Host $server_name;\n        proxy_read_timeout  36000s;\n        proxy_send_timeout  36000s;\n    }\n}\n</code></pre> <p>supervisord.conf:</p> <pre><code>[program:restaurant_order_service]\ncommand=uwsgi --ini /django/RestaurantOrder/restaurant_order_uwsgi.ini\ndirectory=/django/RestaurantOrder\nstdout_logfile=/django/RestaurantOrder/log/uwsgi_out.log\nstderr_logfile=/django/RestaurantOrder/log/uwsgi_err.log\nautostart=true\nautorestart=true\nuser=root\nstartsecs=10\n\n[program:restaurant_order_websocket]\ncommand=/django/RestaurantOrder/environment/bin/daphne -u /django/RestaurantOrder/websocket.sock RestaurantOrder.asgi:application\ndirectory=/django/RestaurantOrder\nstdout_logfile=/django/RestaurantOrder/log/websocket_out.log\nstderr_logfile=/django/RestaurantOrder/log/websocket_err.log\nautostart=true\nautorestart=true\nuser=root\nstartsecs=10\n</code></pre>"},{"location":"python/django/django-cleanup/","title":"Django-cleanup \u6e05\u7406\u6587\u4ef6","text":""},{"location":"python/django/django-cleanup/#_1","title":"\ufeff\u5b89\u88c5","text":"<pre><code>pip install django-cleanup\n</code></pre>"},{"location":"python/django/django-cleanup/#_2","title":"\u914d\u7f6e","text":"<pre><code>INSTALLED_APPS = (\n...\n'django_cleanup',\n)\n</code></pre>"},{"location":"python/django/django-cleanup/#_3","title":"\u4fe1\u53f7","text":"<pre><code>from django_cleanup.signals import cleanup_pre_delete, cleanup_post_delete\ndef sorl_delete(**kwargs):\nprint(kwargs['file'])\ncleanup_pre_delete.connect(sorl_delete)\n</code></pre>"},{"location":"python/django/django-cleanup/#_4","title":"\u4f5c\u7528","text":"<ol> <li>\u5728django\u5b9e\u4f8b\u4e2d\u7684file\u3001image\u5b57\u6bb5\u5185\u5bb9\u88ab\u66f4\u65b0\u65f6\uff0c\u65e7\u7684\u6587\u4ef6\u5c06\u88ab\u81ea\u52a8\u5220\u9664\u3002</li> <li>\u5728django\u5b9e\u4f8b\u88ab\u5220\u9664\u65f6\uff0c\u5b9e\u4f8b\u5305\u542b\u7684\u6240\u6709file\u3001image\u5c06\u88ab\u81ea\u52a8\u5220\u9664\u3002</li> </ol> <p>\u9ed8\u8ba4\u5934\u50cf\u88ab\u5220\u9664\u7684\u95ee\u9898</p> <p>\u9ed8\u8ba4\u5934\u50cf\u4e0d\u4f7f\u7528default\uff0c\u4f7f\u7528null=True\uff0c\u83b7\u53d6\u5934\u50cf\u4f7f\u7528\u65b9\u6cd5\uff1a</p> <pre><code>def display_avatar(self):\nreturn self.avatar.url or '/static/img/default-avatar.png'\n</code></pre> <p>\u8be6\u89c1https://github.com/un1t/django-cleanup/issues/8</p> <p>\ufeff\u7f29\u7565\u56fe\u517c\u5bb9\uff1a</p> <p>\u517c\u5bb9\u7f29\u7565\u56fe\u751f\u6210\u5de5\u5177\uff1asorl-thumbnail and easy-thumbnail</p> <p>https://github.com/un1t/django-cleanup</p>"},{"location":"python/django/django-cleanup/#_5","title":"\u4fee\u6539\u5206\u8fa8\u7387","text":"<pre><code>profile = Message.objects.get(id=5)\nmedia_root = getattr(settings, 'MEDIA_ROOT', None)\npath = os.path.join(os.path.join(media_root, ''), profile.portrait1.name)\n# \u4fee\u6539\u5934\u50cf\u5206\u8fa8\u7387\nfrom PIL import Image\nim = Image.open(path)\nout = im.resize((200, 200), Image.ANTIALIAS)\nout.save(path)\n</code></pre> <p>\u4f7f\u7528django-imagekit\u751f\u6210\u7f29\u7565\u56fe\uff1a</p> <p>\u65b9\u6cd5\u4e00\uff1a</p> <pre><code>avatar_thumbnail = ImageSpecField(source='portrait1',\nprocessors=[ResizeToFill(200, 200)],\nformat='PNG',\noptions={'quality': 100})\n</code></pre> <pre><code>print(profile.avatar_thumbnail.url)  # &gt; /media/CACHE/images/982d5af84cddddfd0fbf70892b4431e4.jpg\nprint(profile.avatar_thumbnail.width)\n</code></pre> <p>\u65e0\u6cd5\u4f7f\u7528django-cleanup\u81ea\u52a8\u5220\u9664\u751f\u6210\u7684Cache\u6587\u4ef6</p> <p>\u65b9\u6cd5\u4e8c\uff1a</p> <pre><code>from imagekit import ImageSpec\nfrom imagekit.processors import ResizeToFill\nclass Thumbnail(ImageSpec):\nprocessors = [ResizeToFill(200, 200)]\nformat = 'JPEG'\noptions = {'quality': 100}\n</code></pre> <pre><code>source_file = profile.portrait1\nimage_generator = Thumbnail(source=source_file)\nresult = image_generator.generate()\nprint(result, type(result))\ndest = open(path, \"wb+\")\ndest.write(result.read())\ndest.close()\n</code></pre> <p>\u7f29\u7565\u56fe\u8986\u76d6\u539f\u6587\u4ef6\u6216\u8005\u76f4\u63a5\u4fdd\u5b58\u81f3\u5176\u4ed6\u6587\u4ef6\u3002</p> <p>\u540c\u5c3a\u5bf8\u751f\u6210\u540c\u5c3a\u5bf8\u7684\u7f29\u7565\u56fe\u4f1a\u53d8\u6a21\u7cca\uff0c\u4f46\u8fdc\u4f18\u4e8e\u4f7f\u7528PIL-Image\u4fee\u6539\u5206\u8fa8\u7387\u751f\u6210\u7684\u56fe\u7247\u8d28\u91cf\u3002</p>"},{"location":"python/django/django-cleanup/#sorl-thumbnail","title":"sorl-thumbnail","text":"<p>\u5b89\u88c5</p> <pre><code>pip install sorl-thumbnail\n</code></pre> <p>\u914d\u7f6e</p> <pre><code>INSTALLED_APPS = (\n...\n'sorl.thumbnail',\n)\n</code></pre> <p>No Such Table \u9519\u8bef</p> <pre><code>python manage.py makemigrations thumbnail\npython manage.py migrate thumbnail\n</code></pre> <p>\u83b7\u53d6\u53ca\u5220\u9664\u7f29\u7565\u56fe</p> <pre><code>from sorl.thumbnail import get_thumbnail\nfrom sorl.thumbnail import delete\nim = get_thumbnail(my_file, '100x100', crop='center', quality=99)\ndelete(my_file)\n</code></pre> <p>\u914d\u5408django-cleanup</p> <pre><code>from django_cleanup.signals import cleanup_pre_delete, cleanup_post_delete\ndef sorl_delete(**kwargs):\nfrom sorl.thumbnail import delete\ndelete(kwargs['file'])\ncleanup_pre_delete.connect(sorl_delete)\n</code></pre>"},{"location":"python/django/django-constance/","title":"Django-constance\u5b9e\u73b0\u52a8\u6001\u8bbe\u7f6e","text":"<p>\u672c\u6587\u57fa\u4e8e <code>django-constance==2.2.0</code></p>"},{"location":"python/django/django-constance/#_1","title":"\u5b89\u88c5","text":"<p><code>django-constance</code>\u5206\u4e3a<code>redis</code>\u5b58\u50a8\u8bbe\u7f6e\u7684\u7248\u672c\u548c\u4f7f\u7528<code>database</code>\u5b58\u50a8\u8bbe\u7f6e\u7684\u7248\u672c\uff0c\u5bf9\u5e94\u7684\u4e0b\u8f7d\u65b9\u5f0f\u5206\u522b\u4e3a\uff1a</p> <pre><code>pip install \"django-constance[redis]\"\npip install \"django-constance[database]\"\n</code></pre> <p>\u5982\u679c\u786e\u8ba4\u76f8\u5173\u4f9d\u8d56\u5df2\u7ecf\u5b89\u88c5\uff0c\u76f4\u63a5\u4f7f\u7528\u4e0b\u5217\u547d\u4ee4\u5b89\u88c5\uff1a</p> <pre><code>pip install django-constance\n</code></pre>"},{"location":"python/django/django-constance/#_2","title":"\u914d\u7f6e","text":"<p><code>settings.py\u6587\u4ef6</code>\uff1a</p> <pre><code># \u5df2\u5b89\u88c5\u7684Apps\nINSTALLED_APPS = [\n'constance',\n...\n]\n</code></pre> <p>\u82e5\u4f7f\u7528<code>database</code>\u5b58\u50a8\u8bbe\u7f6e\u7684\u7248\u672c\uff0c\u8bf7\u4f7f\u7528\uff1a</p> <pre><code># \u5df2\u5b89\u88c5\u7684Apps\nINSTALLED_APPS = [\n'constance',\n'constance.backends.database',\n...\n]\n</code></pre> <p>\u58f0\u660e\u5f85\u914d\u7f6e\u9009\u9879\uff1a</p> <pre><code>CONSTANCE_BACKEND = 'constance.backends.database.DatabaseBackend'\nCONSTANCE_IGNORE_ADMIN_VERSION_CHECK = True\nCONSTANCE_ADDITIONAL_FIELDS = {\n'coupon_select': ['django.forms.fields.ChoiceField', {\n'widget': 'django.forms.Select',\n'choices': ((0, \"\u65f6+\u5206+\u79d2\"), (1, \"\u65f6+\u5206\"), (2, \"\u65f6\"), (3, \"\u5ffd\u7565\"))\n}],\n}\nCONSTANCE_CONFIG = {\n'site_name': ('\u5357\u4eac\u8bd7\u8fdc\u542f', '\u7f51\u7ad9\u6807\u9898'),\n'site_description': ('\u5357\u4eac\u8bd7\u8fdc\u542f', '\u7ad9\u70b9\u63cf\u8ff0'),\n'coupon_fix_code': ('DreamGo', '\u7535\u5b50\u5238\u56fa\u5b9a\u4ee3\u7801'),\n'coupon_time_format': (0, '\u7535\u5b50\u5238\u65f6\u95f4\u683c\u5f0f', 'coupon_select'),\n'sms_reset_date': (1, '\u5206\u914d\u77ed\u4fe1\u6e05\u96f6\u65f6\u95f4'),\n}\nCONSTANCE_CONFIG_FIELDSETS = {\n'\u7ad9\u70b9\u8bbe\u7f6e': ('site_name', 'site_description'),\n'\u7535\u5b50\u5238': ('coupon_fix_code', 'coupon_time_format', ),\n'\u77ed\u4fe1': ('sms_reset_date', ),\n}\n</code></pre> <p><code>'site_name': ('\u5357\u4eac\u8bd7\u8fdc\u542f', '\u7f51\u7ad9\u6807\u9898'),</code> \u5206\u522b\u4ee3\u8868 \u8bbe\u7f6e\u53d8\u91cf\u7684\u540d\u79f0 \u9ed8\u8ba4\u503c \u8bbe\u7f6e\u53d8\u91cf\u7528\u9014\u63cf\u8ff0(<code>help_text</code>)</p> <p><code>'coupon_time_format': (0, '\u7535\u5b50\u5238\u65f6\u95f4\u683c\u5f0f', 'coupon_select'),</code>\u524d3\u4e2a\u53d8\u91cf\u610f\u4e49\u540c\u4e0a\uff0c\u6700\u540e\u7684<code>'coupon_select'</code>\u4ee3\u8868\u4f7f\u7528\u81ea\u5b9a\u4e49\u9009\u62e9\u63a7\u4ef6\u6765\u9009\u62e9\u503c\u3002</p>"},{"location":"python/django/django-constance/#admin","title":"Admin\u6837\u5f0f","text":""},{"location":"python/django/django-constance/#_3","title":"\u4f7f\u7528\u4ee3\u7801\u83b7\u53d6\u5f53\u524d\u8bbe\u7f6e\u503c","text":"<pre><code>from constance import config\ndef set_value(key, value):\n\"\"\"\n    \u66f4\u65b0\u6570\u636e\u5e93\u8bbe\u7f6e\u9879\n    :param key: \u952e\u540d\n    :param value: \u503c\n    :return: \u65e0\u8fd4\u56de\n    \"\"\"\nsetattr(config, key, value)\ndef get_value(key):\n\"\"\"\n    \u83b7\u53d6\u6570\u636e\u5e93\u8bbe\u7f6e\u9879\u503c\n    :param key: \u952e\u540d\n    :return: \u952e\u540d\u5bf9\u5e94\u7684\u8bbe\u7f6e\u9879\u503c\n    \"\"\"\nreturn getattr(config, key)\n</code></pre> <p>\u7528\u6cd5\uff1a</p> <pre><code>set_value('site_name', '\u5357\u4eac\u8bd7\u8fdc\u542f(\u4fee\u6539\u540e)')\nget_value('site_name') # \u5e94\u4e3a'\u5357\u4eac\u8bd7\u8fdc\u542f(\u4fee\u6539\u540e)'\n</code></pre>"},{"location":"python/django/django-constance/#djangorestframework","title":"DjangoRestFramework\u4e2d\u4f7f\u7528","text":"<p>utils.py:</p> <pre><code>from constance import config\nfrom constance.settings import CONFIG\ndef get_settings(allow_settings):\n\"\"\"\n    \u83b7\u53d6\u5bf9\u5e94settings\u7ec4\u6210\u7684list\n    :param allow_settings: \u5f85\u8f6c\u4e49\u5217\u8868\n    :return: \u5bf9\u5e94settings\u7ec4\u6210\u7684list\n    \"\"\"\nsetting_list = []\nfor key, options in CONFIG.items():\nif key in allow_settings:\ndefault, help_text = options[0], options[1]\ndata = {'key': key, 'default': default, 'help_text': help_text, 'value': get_value(key)}\nsetting_list.append(data)\nreturn setting_list\n</code></pre> <p>views.py:</p> <pre><code>from rest_framework.viewsets import ViewSet\nfrom rest_framework.response import Response\nfrom .utils import set_value, get_value, CONFIG \nclass SettingViewSet(ViewSet):\npermission_classes = (IsAuthenticated,)\ndef setting(self, request, allow_settings):\nif request.method == 'GET':\nreturn Response(data=get_settings(allow_settings), status=status.HTTP_200_OK)\nelse:\nall_settings = CONFIG.keys()\nfor key in request.data:\nif key in allow_settings and key in all_settings:\nvalue = request.data[key]\nset_value(key, '' if value is None else value)\nreturn Response(data=get_settings(allow_settings), status=status.HTTP_200_OK)\ndef create(self, request):\n\"\"\"\n        &lt;p&gt;\u66f4\u65b0\u8bbe\u7f6ePOST:&lt;code&gt;{'\u8bbe\u7f6eKey': \u65b0\u503c}&lt;/code&gt;\n        \"\"\"\nreturn self.setting(request, CONFIG.keys())\ndef list(self, request):\n\"\"\"\n        \u8fd4\u56de\u6240\u6709\u5f85\u9009\u8bbe\u7f6e\u9879\n        \"\"\"\nreturn self.setting(request, CONFIG.keys())\n@action(methods=['GET', 'POST'], detail=False)\ndef site(self, request):\n\"\"\"\u4ec5\u5141\u8bb8\u8bbe\u7f6e \u7f51\u7ad9\u6807\u9898\u3001\u7ad9\u70b9\u63cf\u8ff0\u7684\u63a5\u53e3\"\"\"\nallow_settings = ['site_name', 'site_description']\nreturn self.setting(request, allow_settings)\n</code></pre> <p></p>"},{"location":"python/django/django-constance/#admin_1","title":"\u56fa\u5b9a\u8bbe\u7f6e\u9879\u5728Admin\u4e2d\u7684\u987a\u5e8f","text":"<p>\u4e3a\u4e86\u9632\u6b62\u6bcf\u6b21\u6253\u5f00\u8bbe\u7f6e\u754c\u9762\u8bbe\u7f6e\u9009\u9879\u9519\u8bef\uff0c\u9700\u8981\u4f7f\u7528<code>OrderedDict</code>\u6765\u4fdd\u8bc1\u987a\u5e8f\uff1a</p> <pre><code>from collections import OrderedDict\nSITE_NAME = 'site_name'\nSITE_DESCRIPTION = 'site_description'\nCONSTANCE_CONFIG = OrderedDict([\n(SITE_NAME, ('\u5357\u4eac\u8bd7\u8fdc\u542f', '\u7ad9\u70b9\u540d\u79f0')),\n(SITE_DESCRIPTION, ('\u5357\u4eac\u8bd7\u8fdc\u542f', '\u7ad9\u70b9\u63cf\u8ff0')),\n])\nCONSTANCE_CONFIG_FIELDSETS = OrderedDict([\n('\u7ad9\u70b9\u8bbe\u7f6e', (SITE_NAME, SITE_DESCRIPTION)),\n])\n</code></pre>"},{"location":"python/django/django-constance/#qa","title":"QA","text":""},{"location":"python/django/django-constance/#_4","title":"\u51fa\u73b0\u6ca1\u6709\u8868\u7684\u60c5\u51b5","text":"<p>\u6267\u884c\uff1a</p> <pre><code>python manage.py makemigrations constance\npython manage.py migrate constance\n</code></pre>"},{"location":"python/django/django-constance/#makemigrations","title":"\u5728makemigrations\u65f6\u5c31\u63d0\u793a\u8868\u4e0d\u5b58\u5728","text":"<p><code>INSTALLED_APPS</code>\u4e2d\u52a0<code>constance.backends.database</code>,\u5220\u9664\u4f7f\u7528\u5230<code>constance</code>\u7684\u5730\u65b9\uff0c<code>makemigrations</code>\u4e4b\u540e\u518d\u8fc1\u79fb\u3002</p>"},{"location":"python/django/django-constance/#constancechange_config","title":"\u4fee\u6539\u6743\u9650<code>'constance.change_config'</code>\u7684\u540d\u79f0\u540e\u62a5\u9519","text":"<p><code>constance</code>\u9ed8\u8ba4\u63d0\u4f9b\u4e86\u4e00\u4e2a\u6743\u9650<code>'constance.change_config'</code>\uff0c\u4f46\u662f\u5f53\u4fee\u6539\u4e86\u8be5\u6743\u9650\u7684\u9ed8\u8ba4\u6743\u9650\u540d\u79f0\u540e\uff0c\u4f1a\u51fa\u73b0\u4e00\u4e0b\u9519\u8bef\uff1a</p> <pre><code>django.db.utils.IntegrityError: (1062, \"Duplicate entry '2-change_config' for key 'auth_permission_content_type_id_codename_01ab37\n5a_uniq'\")\n</code></pre> <p>\u91cd\u65b0\u6d4f\u89c8\u4ee3\u7801\u540e\u53d1\u73b0\u662f\u5728<code>constance/apps.py</code> 29\u884c\uff0c\u5199\u4e86\uff1a</p> <pre><code>permission, created = Permission.objects.using(using).get_or_create(\nname='Can change config',\ncontent_type=content_type,\ncodename='change_config')\n</code></pre> <p>\u5c06\u5176\u4fee\u6539\u4e3a\uff1a</p> <pre><code>permission, created = Permission.objects.using(using).get_or_create(\ncontent_type=content_type,\ncodename='change_config',\ndefaults={'name': 'Can change config'})\n</code></pre> <p>\u5373\u53ef\u89e3\u51b3\u8fd9\u4e2a\u9519\u8bef\uff0c\u8be6\u89c1issue\u3002 \u8be5PR\u5df2\u63d0\u4ea4\uff0c\u4ee3\u7801\u5408\u5e76\u6210\u529f\uff0c\u5728\u4e00\u4e2a\u6b63\u5f0f\u7248\u672c\u8be5\u95ee\u9898\u5c06\u88ab\u89e3\u51b3\u3002</p>"},{"location":"python/django/django-constance/#makemigrations-constancemakemigrations","title":"<code>makemigrations constance</code>\u4e00\u76f4\u4e0d\u521b\u5efa<code>makemigrations</code>\u6587\u4ef6","text":"<p>Backends-&gt;Database</p> <pre><code>pip install django-constance[database]\nCONSTANCE_BACKEND = 'constance.backends.database.DatabaseBackend'\nINSTALLED_APPS = (\n# other apps\n'constance.backends.database',\n)\npython manage.py migrate database\n</code></pre>"},{"location":"python/django/django-constance/#cache","title":"\u9891\u7e41\u67e5\u8be2\u3001\u66f4\u65b0\u7684\u8bbe\u7f6e\u9879 \u4f7f\u7528Cache\u52a0\u5feb\u8bbf\u95ee\u901f\u5ea6","text":"<p>Cache</p> <pre><code># cache\u914d\u7f6e\nCACHES = {\n'default': {\n'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',\n'LOCATION': 'unique-snowflake',\n'KEY_PREFIX': 'protal',\n'options': {\n'MAX_ENTRIES': 1024,\n}\n},\n'memcache': {\n'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache',\n'LOCATION': '127.0.0.1:11211',\n'KEY_PREFIX': 'protal',\n'options': {\n'MAX_ENTRIES': 1024,\n}\n},\n}\n# \u8bbe\u7f6e\u7f13\u5b58\nCONSTANCE_DATABASE_CACHE_BACKEND = 'memcache'\n</code></pre>"},{"location":"python/django/django-constance/#illegal-mix-of-collations-for-operation-in","title":"<code>Illegal mix of collations for operation ' IN '</code>","text":"<p>\u82e5\u5728\u5347\u7ea7\u9879\u76ee\u4e2d\u9047\u5230mysql\u62a5\u9519</p> <pre><code>Illegal mix of collations for operation ' IN '\n</code></pre> <p>\u9700\u8981\u5220\u9664\u6570\u636e\u5e93\uff0c\u518d\u6b21\u521b\u5efa <code>create database database_name character set utf8</code>; \u518d\u6b21\u5bfc\u5165\u6570\u636e\u5e93\u5373\u53ef\u3002</p> <p>\u6587\u6863</p>"},{"location":"python/django/django-cors-headers/","title":"Django\u4f7f\u7528django-cors-headers\u5904\u7406API\u8de8\u57df\u95ee\u9898","text":""},{"location":"python/django/django-cors-headers/#_1","title":"\u95ee\u9898\u8bf4\u660e","text":"<p>\u5728Django\u5f00\u53d1\u8fc7\u7a0b\u4e2d\uff0c\u4f7f\u7528\u524d\u540e\u7aef\u5206\u79bb\u8bbe\u8ba1\u7684\u7ad9\u70b9\u8d8a\u6765\u8d8a\u591a\uff0c\u5982Django+VUE\u3001Django+Angular\u3002\u5728\u4f7f\u7528DjangoRestFramework\u5f00\u53d1API\u7684\u8fc7\u7a0b\u4e2d\uff0c\u7531\u4e8e\u524d\u7aef\u7ad9\u70b9\u548c\u540e\u7aefAPI\u7ad9\u70b9\u57df\u540d\u5f80\u5f80\u4e0d\u540c\uff0c\u968f\u4e4b\u800c\u6765\u7684\u4fbf\u662f\u8de8\u57df\u95ee\u9898\u3002</p> <p>\u8de8\u57df\u653b\u51fb\u662f\u4e00\u79cd\u5e38\u89c1\u7684Web\u653b\u51fb\u624b\u6bb5\uff0c\u5e38\u89c1\u7684\u653b\u51fb\u6d41\u7a0b\u4e3a\uff1a \u5047\u8bbe\u73b0\u5728\u4f60\u6709\u4e00\u4e2a\u524d\u7aef\u7ad9\u70b9A\u548c\u540e\u7aef\u7ad9\u70b9B\uff0c\u524d\u7aef\u7ad9\u70b9A\u4f7f\u7528Ajax\u7684GET\u8bf7\u6c42\u540e\u7aef\u7ad9\u70b9B\u7684\u63a5\u53e3<code>/withdraw/?money=1000&amp;account=yinkh</code>\u53ef\u4ee5\u5411\u8d26\u53f7yinkh\u63d0\u73b0\u4e00\u5343\u5143\uff0c\u6574\u4e2a\u8fc7\u7a0b\u4f7f\u7528token\u8ba4\u8bc1\u6216\u8005session\u8ba4\u8bc1\uff0c\u7528\u6237\u7684\u8eab\u4efd\u4fe1\u606f\u4f1a\u88ab\u7f13\u5b58\u5728\u7528\u6237\u7684\u6d4f\u89c8\u5668\u4e2d\u3002\u73b0\u5728\u5047\u8bbe\u6709\u4e0d\u6cd5\u5206\u5b50\u67b6\u8bbe\u4e86\u4e00\u4e2a\u7ad9\u70b9C,\u5728\u7ad9\u70b9C\u4e2d\u653e\u5165\u4e00\u5f20\u56fe\u7247\u5176src\u8def\u5f84\u8bbe\u7f6e\u4e3a<code>/withdraw/?money=1000&amp;account=xxxx</code>\uff0c\u4e0d\u6cd5\u5206\u5b50\u518d\u5c06\u7ad9\u70b9C\u7684\u94fe\u63a5\u901a\u8fc7\u4e00\u5b9a\u7684\u65b9\u5f0f\u8bf1\u5bfc\u4f60\u5728\u7f13\u5b58\u6709\u540e\u7aef\u7ad9\u70b9B\u7684\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee\uff0c\u5982\u679c\u540e\u7aef\u7ad9\u70b9B\u6ca1\u6709\u505a\u8de8\u57df\u8bbf\u95ee\u63a7\u5236\u7684\u8bdd\uff0c\u4f60\u5c31\u5c06\u50cf\u4e0d\u6cd5\u5206\u5b50\u7684\u8d26\u6237xxxx\u63d0\u73b0\u4e00\u5343\u5143\u3002</p> <p>\u800c\u8de8\u57df\u8bbf\u95ee\u63a7\u5236\u662f\u901a\u8fc7\u9a8c\u8bc1\u8bf7\u6c42\u6765\u6e90\u7ad9\u70b9\uff0c\u4ee5\u9632\u6b62\u8de8\u57df\u653b\u51fb\u3002\u53ea\u6709\u4f60\u5c06\u524d\u7aef\u7ad9\u70b9A\u5bf9\u5e94\u7684\u57df\u540d\u6dfb\u52a0\u81f3\u540e\u7aef\u7ad9\u70b9B\u7684\u53ef\u4fe1\u5217\u8868\u4e2d\uff0c\u4f60\u624d\u80fd\u6b63\u786e\u7684\u8bf7\u6c42\u5bf9\u5e94\u7684API\u63a5\u53e3\uff0c\u5426\u5219\u8bf7\u6c42\u5c06\u88ab\u540e\u7aef\u7ad9\u70b9B\u62d2\u7edd\u3002</p>"},{"location":"python/django/django-cors-headers/#_2","title":"\u5b89\u88c5","text":"<pre><code>pip install django-cors-headers==2.4.0\n</code></pre>"},{"location":"python/django/django-cors-headers/#_3","title":"\u8bbe\u7f6e","text":"<p>\u5728<code>settings.py</code>\u4e2d\uff1a</p> <p>1 \u8bbe\u7f6e INSTALLED_APPS</p> <pre><code>INSTALLED_APPS = [\n...\n'corsheaders',\n...\n]\n</code></pre> <p>2 \u8bbe\u7f6e MIDDLEWARE,\u82e5\u4f60\u4f7f\u7528\u7684Django\u7248\u672c\u5c0f\u4e8e1.10\uff0c\u8be5\u9879\u4e3aMIDDLEWARE_CLASSES\u3002</p> <pre><code>MIDDLEWARE = [\n...\n'corsheaders.middleware.CorsMiddleware',\n'django.middleware.common.CommonMiddleware',\n...\n]\n</code></pre> <p>3 \u8bbe\u7f6e\u4fe1\u4efb\u7ad9\u70b9</p> <pre><code># \u5141\u8bb8\u8de8\u57df\nif DEBUG:\nCORS_ORIGIN_ALLOW_ALL = True\nelse:\nCORS_ORIGIN_WHITELIST = (\n'www.example.com',\n)\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u65e2<code>DEBUG=True</code>\u65f6\uff0c\u4e0d\u53ef\u4ee5\u76f4\u63a5\u5c06 <code>CORS_ORIGIN_ALLOW_ALL</code> \u8bbe\u7f6e\u4e3a <code>True</code>\uff0c\u8fd9\u9879\u8bbe\u7f6e\u76f8\u5f53\u4e8e\u5173\u95ed\u4e86\u7ad9\u70b9\u9632\u6b62\u8de8\u57df\u653b\u51fb\u7684\u529f\u80fd\u3002\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u9700\u8981\u4f7f\u7528<code>CORS_ORIGIN_WHITELIST</code>\uff0c\u5c06\u4f60\u4fe1\u4efb\u7684\u524d\u7aef\u7ad9\u70b9\u57df\u540d\u52a0\u5165<code>CORS_ORIGIN_WHITELIST</code>\u5217\u8868\u4e2d\uff0c\u8be5\u57df\u540d\u4e0d\u8981\u4ee5<code>http://</code>\u6216\u8005<code>https://</code>\u5f00\u5934\u3002</p> <p>\u81f3\u6b64\u4f60\u7684\u524d\u7aef\u7ad9\u70b9\u5e94\u8be5\u5c31\u53ef\u4ee5\u6b63\u786e\u7684\u8bbf\u95ee\u540e\u7aef\u7ad9\u70b9\u7684\u63a5\u53e3\u4e86\u3002</p> <p>\u66f4\u591a\u8bbe\u7f6e\u9879\u8bf7\u53c2\u89c1\u6587\u6863\u3002</p>"},{"location":"python/django/django-cors-headers/#_4","title":"\u7b14\u8bb0","text":"<p>Q: \u5728\u4f7f\u7528\u4e86<code>django-cors-headers</code>\u5e93\u540e\uff0c\u65e0\u6cd5\u83b7\u53d6\u81ea\u5b9a\u4e49\u7684<code>requset header</code>\u3002</p> <p>A: <code>settings.py</code>\u52a0\u5165\uff1a</p> <pre><code>from corsheaders.defaults import default_headers\n# The list of non-standard HTTP headers that can be used when making the actual request\nCORS_ALLOW_HEADERS = default_headers + ('YourCustomHeaderName',)\n</code></pre>"},{"location":"python/django/django-extensions/","title":"Django\u6a21\u578b\u4f9d\u8d56\u53ef\u89c6\u5316","text":"<p>\u5b89\u88c5Django-extensions,\u5b89\u88c5\u5b8c\u6210\u540e\u67e5\u770bgraph_models\u90e8\u5206\u3002</p> <p>\u4f7f\u7528\u547d\u4ee4\uff1a</p> <pre><code>python manage.py graph_models -a &gt; my_project.dot\n</code></pre> <p>\u751f\u6210\u9879\u76eemodels\u5bf9\u5e94\u7684.dot\u6587\u4ef6\u3002\u4e0b\u8f7dGraphviz\u8f6f\u4ef6\uff0c\u4f7f\u7528GVEdit\u6253\u5f00my_project.dot\u6587\u4ef6\u5373\u53ef\u67e5\u770b\u5bf9\u5e94\u7684models\u4f9d\u8d56\u5173\u7cfb\u56fe\u3002</p> <p>\u5982\u4f55\u5c06.dot\u6587\u4ef6\u8f6c\u5316\u4e3a.png\u6587\u4ef6\uff1a</p> <p>\u5728GVEdit-&gt;Graph-&gt;Settings\u4e2d\u8bbe\u7f6e\u6587\u4ef6\u8f93\u51fa\u5c5e\u6027\u53ca\u8def\u5f84\uff08\u8def\u5f84\u4e2d\u4e0d\u53ef\u5305\u542b\u4e2d\u6587\uff09\uff0c\u5373\u53ef\u751f\u6210\u5bf9\u5e94\u7684.png\u6587\u4ef6\u3002</p> <p>\u793a\u4f8b\u56fe\u7247\uff1a</p> <p></p> <p>\u9519\u8bef\u8bb0\u5f55\uff1a</p> <pre><code>python manage.py graph_models --pygraphviz -a -g -o  &gt; my_project.png\n</code></pre> <p>\u9700\u8981\u4f7f\u7528pip install pygraphviz\u5b89\u88c5pygraphviz\uff0c\u5b89\u88c5\u5931\u8d25\u3002</p> <pre><code>python manage.py graph_models --pydot -a -g -o  &gt; my_project.png\n</code></pre> <p>\u9700\u8981\u4f7f\u7528pip install pyparsing pydot\uff0c\u5b89\u88c5\u6210\u529f\u3002\u4f46\u662f\u8fd0\u884c\u4e0a\u884c\u547d\u4ee4\u4f1a\u63d0\u793a \u201cdot.exe not found in path\u201d\u9519\u8bef\uff0c\u4f30\u6d4b\u539f\u56e0\u4e3awindos\u5e73\u53f0\u4e0a\u73af\u5883\u53d8\u91cf\u6ca1\u6709\u8bbe\u7f6e\u6216\u8005\u8bbe\u7f6e\u9519\u8bef\u3002</p>"},{"location":"python/django/django-haystack/","title":"Django-haystack\u5168\u5c40\u641c\u7d22","text":""},{"location":"python/django/django-haystack/#_1","title":"\u7b80\u8ff0","text":"<p>Haystack(\u7a3b\u8349\u5806)\u4e00\u822c\u7528\u4e8e\u5f62\u5bb9\u5f85\u68c0\u7d22\u7684\u96c6\u5408\uff0cneedle(\u9488)\u4e00\u822c\u7528\u4e8e\u5f62\u5bb9\u5f85\u68c0\u7d22\u7684\u5bf9\u8c61\uff0c\u4ee5\u5927\u6d77\u635e\u9488\u6765\u5f62\u5bb9\u5168\u5c40\u641c\u7d22\u53ef\u4ee5\u8bf4\u662f\u5341\u5206\u7684\u5f62\u8c61\u751f\u52a8\u3002\u7b80\u8ff0\u5982\u4f55\u4f7f\u7528<code>django-haystack</code>+<code>Whoosh</code>+<code>jieba</code>\u6765\u5b9e\u73b0\u591a\u6a21\u578b\u6df7\u5408\u68c0\u7d22\uff0c\u652f\u6301\u6a21\u7cca\u68c0\u7d22\u3001\u5206\u6a21\u578b\u68c0\u7d22\u3001\u68c0\u7d22\u7ed3\u679c\u9ad8\u4eae\u68c0\u7d22\u5173\u952e\u5b57\uff0c\u4ee5\u53ca<code>django-haystck</code>+<code>django-hvad</code>\u5b9e\u73b0\u591a\u8bed\u8a00\u73af\u5883\u4e2d\u7684\u5168\u5c40\u68c0\u7d22\u3002</p>"},{"location":"python/django/django-haystack/#1","title":"1\u3001 \u5b89\u88c5\u5bf9\u5e94\u63d2\u4ef6","text":"<pre><code>django-haystack==2.6.1\nWhoosh==2.7.4\njieba==0.39\n</code></pre>"},{"location":"python/django/django-haystack/#2-settingspy","title":"2\u3001 \u66f4\u65b0<code>settings.py</code>\u6587\u4ef6","text":"<pre><code># \u68c0\u7d22\u670d\u52a1\nHAYSTACK_CONNECTIONS = {\n'default': {\n'ENGINE': 'common.whoosh_cn_backend.ChineseWhooshEngine',\n'PATH': os.path.join(os.path.dirname(__file__), 'whoosh_index'),\n},\n}\n# \u81ea\u52a8\u66f4\u65b0\u641c\u7d22\u7d22\u5f15\nHAYSTACK_SIGNAL_PROCESSOR = 'haystack.signals.RealtimeSignalProcessor'\n</code></pre>"},{"location":"python/django/django-haystack/#3-jieba","title":"3\u3001 \u5c06<code>jieba</code>\u5206\u8bcd\u52a0\u5165\u68c0\u7d22\u5f15\u64ce\u4e2d","text":"<p>\u65b0\u5efa\u6587\u4ef6<code>common/whoosh_cn_backend.py</code>(\u82e5\u4fee\u6539\u4e86\u6587\u4ef6\u5939\u6216\u6587\u4ef6\u540d\u8bf7\u76f8\u5e94\u4fee\u6539<code>settings.py</code>\u4e2d\u7684<code>HAYSTACK_CONNECTIONS-&gt;ENGINE</code>\u8def\u5f84),\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>from haystack.constants import DJANGO_CT, DJANGO_ID, ID\nfrom haystack.exceptions import SearchBackendError\nfrom whoosh.fields import ID as WHOOSH_ID\nfrom whoosh.fields import BOOLEAN, DATETIME, IDLIST, KEYWORD, NGRAM, NGRAMWORDS, NUMERIC, Schema, TEXT\nfrom jieba.analyse import ChineseAnalyzer\nfrom haystack.backends.whoosh_backend import WhooshSearchBackend, WhooshEngine\nclass ChineseWhooshSearchBackend(WhooshSearchBackend):\ndef build_schema(self, fields):\nschema_fields = {\nID: WHOOSH_ID(stored=True, unique=True),\nDJANGO_CT: WHOOSH_ID(stored=True),\nDJANGO_ID: WHOOSH_ID(stored=True),\n}\n# Grab the number of keys that are hard-coded into Haystack.\n# We'll use this to (possibly) fail slightly more gracefully later.\ninitial_key_count = len(schema_fields)\ncontent_field_name = ''\nfor field_name, field_class in fields.items():\nif field_class.is_multivalued:\nif field_class.indexed is False:\nschema_fields[field_class.index_fieldname] = IDLIST(stored=True, field_boost=field_class.boost)\nelse:\nschema_fields[field_class.index_fieldname] = KEYWORD(stored=True, commas=True, scorable=True,\nfield_boost=field_class.boost)\nelif field_class.field_type in ['date', 'datetime']:\nschema_fields[field_class.index_fieldname] = DATETIME(stored=field_class.stored, sortable=True)\nelif field_class.field_type == 'integer':\nschema_fields[field_class.index_fieldname] = NUMERIC(stored=field_class.stored, numtype=int,\nfield_boost=field_class.boost)\nelif field_class.field_type == 'float':\nschema_fields[field_class.index_fieldname] = NUMERIC(stored=field_class.stored, numtype=float,\nfield_boost=field_class.boost)\nelif field_class.field_type == 'boolean':\n# Field boost isn't supported on BOOLEAN as of 1.8.2.\nschema_fields[field_class.index_fieldname] = BOOLEAN(stored=field_class.stored)\nelif field_class.field_type == 'ngram':\nschema_fields[field_class.index_fieldname] = NGRAM(minsize=3, maxsize=15, stored=field_class.stored,\nfield_boost=field_class.boost)\nelif field_class.field_type == 'edge_ngram':\nschema_fields[field_class.index_fieldname] = NGRAMWORDS(minsize=2, maxsize=15, at='start',\nstored=field_class.stored,\nfield_boost=field_class.boost)\nelse:\nschema_fields[field_class.index_fieldname] = TEXT(stored=True, analyzer=ChineseAnalyzer(),\nfield_boost=field_class.boost, sortable=True)\nif field_class.document is True:\ncontent_field_name = field_class.index_fieldname\nschema_fields[field_class.index_fieldname].spelling = True\n# Fail more gracefully than relying on the backend to die if no fields\n# are found.\nif len(schema_fields) &lt;= initial_key_count:\nraise SearchBackendError(\n\"No fields were found in any search_indexes. Please correct this before attempting to search.\")\nreturn (content_field_name, Schema(**schema_fields))\nclass ChineseWhooshEngine(WhooshEngine):\nbackend = ChineseWhooshSearchBackend\n</code></pre> <p>\u4e3b\u8981\u64cd\u4f5c\u662f\u4f7f\u7528<code>from jieba.analyse import ChineseAnalyzer</code>\u4e2d\u7684<code>ChineseAnalyzer</code>\u66ff\u6362\u539f\u5148\u7684<code>StemmingAnalyzer</code>\uff0c\u4ee5\u8fbe\u5230\u66f4\u597d\u7684\u4e2d\u6587\u5206\u8bcd\u6548\u679c\u3002</p>"},{"location":"python/django/django-haystack/#4","title":"4\u3001 \u4e3a\u6a21\u578b\u68c0\u7d22\u7d22\u5f15","text":"<p>\u7d22\u5f15\u6587\u4ef6\u653e\u4e8e\u5404\u6a21\u578b\u6240\u5728<code>app</code>\u7684\u6839\u76ee\u5f55\u4e0b\uff0c\u9ed8\u8ba4\u540d\u79f0\u4e3a<code>search_indexes.py</code>,\u4ee5\u65b0\u95fb\u548c\u62db\u8058\u4e3a\u4f8b:</p> <p>news/search_indexes.py</p> <pre><code>from haystack import indexes\nfrom .models import News\nclass NewsIndex(indexes.SearchIndex, indexes.Indexable):\ntext = indexes.CharField(document=True, use_template=True)\ntitle = indexes.CharField(null=True, model_attr='title')\nsummary = indexes.CharField(null=True, model_attr='summary')\ncontent = indexes.CharField(null=True, model_attr='content')\npublish_time = indexes.DateTimeField(model_attr='publish_time')\nlang = indexes.CharField(model_attr='language_code')\ndef get_model(self):\nreturn News\ndef index_queryset(self, using=None):\n\"\"\"Used when the entire index for model is updated.\"\"\"\nreturn self.get_model().objects.language('all').all()\ndef read_queryset(self, using=None):\nreturn self.get_model().objects.language()\n</code></pre> <p>recruit/search_indexes.py</p> <pre><code>from haystack import indexes\nfrom .models import Recruit\nclass RecruitIndex(indexes.SearchIndex, indexes.Indexable):\ntext = indexes.CharField(document=True, use_template=True)\njob = indexes.CharField(null=True, model_attr='job')\nplace = indexes.CharField(null=True, model_attr='place')\ncontent = indexes.CharField(null=True, model_attr='content')\npublish_time = indexes.DateTimeField(model_attr='publish_time')\nlang = indexes.CharField(model_attr='language_code')\ndef get_model(self):\nreturn Recruit\ndef index_queryset(self, using=None):\n\"\"\"Used when the entire index for model is updated.\"\"\"\nreturn self.get_model().objects.language('all').all()\ndef read_queryset(self, using=None):\nreturn self.get_model().objects.language()\n</code></pre> <p><code>NewsIndex\u3001RecruitIndex</code>\u91cc\u7684<code>lang = indexes.CharField(model_attr='language_code')</code>\u548c<code>index_queryset\\read_queryset</code>\u4e2d\u7684<code>.language()</code>\u65b9\u6cd5\u5747\u4e3a\u517c\u5bb9<code>django-hvad</code>\u7684\u5199\u6cd5\uff0c\u672a\u4f7f\u7528<code>django-hvad</code>\u53ef\u5220\u9664<code>lang = indexes.CharField(model_attr='language_code')</code>\uff0c\u5c06<code>.language()</code>\u66ff\u6362\u4e3a<code>.all()</code>\u5373\u53ef\u3002</p> <p>\u5728templates\u76ee\u5f55\u4e0b\u65b0\u589esearch\u76ee\u5f55\uff0c\u76ee\u5f55\u6811\u5982\u4e0b\uff1a</p> <pre><code>\u251c\u2500templates\n\u2502  \u2514\u2500search\n\u2502      \u2514\u2500indexes\n\u2502          \u251c\u2500case\n\u2502          \u251c\u2500download\n\u2502          \u251c\u2500flatpage\n\u2502          \u251c\u2500goods\n\u2502          \u251c\u2500news\n\u2502          \u251c\u2500product\n\u2502          \u251c\u2500recruit\n\u2502          \u251c\u2500service\n\u2502          \u251c\u2500solution\n\u2502          \u2514\u2500staff\n</code></pre> <p>indexes\u4e0b\u7684\u6587\u4ef6\u5939\u4ee5app\u5c0f\u5199\u540d\u79f0\u5f00\u5934\uff0c\u5728<code>news</code>\u6587\u4ef6\u5939\u4e0b\u65b0\u589e<code>news_text.txt</code>\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>{{ object.title }}\n{{ object.summary }}\n{{ object.content }}\n{{ object.publish_time }}\n</code></pre> <p>\u5728<code>recruit</code>\u6587\u4ef6\u5939\u4e0b\u65b0\u589e<code>recruit_text.txt</code>\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a</p> <pre><code>{{ object.job }}\n{{ object.place }}\n{{ object.content }}\n{{ object.publish_time }}\n</code></pre> <p>\u7136\u540e\u6267\u884c <code>python manage.py rebuild_index</code> \u6765\u5efa\u7acb\u7d22\u5f15\uff0c\u5982\u5df2\u5efa\u7acb\u7d22\u5f15\uff0c\u53ef\u6267\u884c <code>python manage.py update_index</code> \u6765\u66f4\u65b0\u7d22\u5f15\u3002</p>"},{"location":"python/django/django-haystack/#5","title":"5\u3001 \u591a\u8bed\u8a00\u68c0\u7d22","text":"<p>urls.py</p> <pre><code>url(r'^search/', LangSearchView.as_view(), name='web_search'),\n</code></pre> <p>views.py</p> <pre><code>from haystack.generic_views import SearchView\n# \u591a\u8bed\u8a00\u641c\u7d22\nclass LangSearchView(BaseMixin, SearchView):\nform_class = LangSearchForm\npaginate_by = 10\n</code></pre> <p>forms.py</p> <pre><code>from django.utils.translation import get_language\nfrom haystack.forms import HighlightedSearchForm\nclass LangSearchForm(HighlightedSearchForm):\ndef search(self):\nsqs = super(LangSearchForm, self).search()\nsqs = sqs.filter(lang=get_language())\nreturn sqs\n</code></pre>"},{"location":"python/django/django-haystack/#6","title":"6\u3001 \u641c\u7d22\u7ed3\u679c\u9ad8\u4eae","text":"<p>\u65b0\u589e\u9875\u9762/templates/search/search.html:</p> <pre><code>{% extends 'web/base.html' %}\n{% load i18n %}\n{% load highlight %}\n\n{% block seo %}\n    {% trans \"\u641c\u7d22\u7ed3\u679c\" as default_seo_title %}\n    {% include \"web/seo.html\" with default_seo_title=default_seo_title %}\n{% endblock %}\n\n{% block css %}\n    &lt;style&gt;\nspan.highlighted {\ncolor: #22a7c6;\n}\n&lt;/style&gt;\n{% endblock %}\n\n{% block main %}\n    &lt;div id=\"news_search\"&gt;\n&lt;div class=\"container base news_search_container\"&gt;\n&lt;h2&gt;{% trans '\u641c\u7d22' %}&lt;/h2&gt;\n&lt;form method=\"get\" action=\"{% url 'web_search' %}\" class=\"news_search_form\"&gt;\n&lt;input class=\"news_search_input\" type=\"text\" name=\"q\"\n{% if query %} value=\"{{ query }}\" {% else %} value=\"\" {% endif %}\nplaceholder=\"{% trans '\u641c\u7d22\u4f60\u60f3\u8981\u7684\u5173\u952e\u5b57' %}\"&gt;\n&lt;input type=\"submit\" value=\"\" class=\"back_submit\"&gt;\n&lt;input type=\"submit\" value=\"\" id=\"search\"\nstyle=\"background:url('/static/web/img/search_white.png') no-repeat center center;width: 60px;height: 40px;\"&gt;\n&lt;/form&gt;\n&lt;div class=\"thumb-container\"&gt;\n&lt;span&gt;&lt;img src=\"/static/web/img/location.png\" alt=\"\"&gt;&lt;/span&gt;\n&lt;a href=\"{% url 'web_search' %}\"&gt;{% trans '\u5173\u952e\u8bcd\u641c\u7d22' %}&lt;/a&gt;\n&lt;/div&gt;\n            {% if query %}\n                &lt;div class=\"information-list wow fadeInUp \"&gt;\n&lt;h3&gt;{% trans '\u641c\u7d22\u7ed3\u679c:' %}&lt;/h3&gt;\n                    {% for result in object_list %}\n                        {% if result.model_name == 'news' %}\n                            &lt;a class=\"information-item\" href=\"{{ result.object.get_absolute_url }}\"\n{% if result.object.url %}target=\"_blank\"{% endif %}&gt;\n&lt;div class=\"information-content\"&gt;\n&lt;div class=\"information_div\"&gt;\n&lt;p class=\"information-title\"&gt;{% highlight result.object.title with query %}&lt;/p&gt;\n&lt;p class=\"information-date\"&gt;{{ result.object.publish_time.date }}&lt;/p&gt;\n&lt;/div&gt;\n&lt;div class=\"information-summary-div\"&gt;\n&lt;p class=\"information-summary\"&gt;{% highlight result.object.summary with query %}&lt;/p&gt;\n&lt;/divclass&gt;\n&lt;/div&gt;\n&lt;/a&gt;\n                        {% elif result.model_name == 'recruit' %}\n                            &lt;a class=\"information-item\" href=\"{{ result.object.get_absolute_url }}\"\n{% if result.object.url %}target=\"_blank\" {% endif %}&gt;\n&lt;div class=\"information-content\"&gt;\n&lt;div class=\"information_div\"&gt;\n&lt;p class=\"information-title\"&gt;{% highlight result.object.job with query %}&lt;/p&gt;\n&lt;p class=\"information-date\"&gt;{{ result.object.update_time.date }}&lt;/p&gt;\n&lt;/div&gt;\n&lt;div&gt;\n&lt;p class=\"information-summary\"&gt;{% highlight result.object.place with query %}&lt;/p&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;/a&gt;\n                        {% endif %}\n                    {% empty %}\n                        &lt;p&gt;{% trans '\u6ca1\u6709\u627e\u5230\u60a8\u60f3\u8981\u641c\u7d22\u7684\u7ed3\u679c...' %}&lt;/p&gt;\n                    {% endfor %}\n                &lt;/div&gt;\n                {% include 'web/pagination.html' %}\n            {% else %}\n                {# Show some example queries to run, maybe query syntax, something else? #}\n            {% endif %}\n        &lt;/div&gt;\n&lt;/div&gt;\n{% endblock %} \n</code></pre> <p>\u4f7f\u7528<code>highlight</code>\u6807\u7b7e+\u81ea\u5b9a\u4e49\u7684<code>span.highlighted css</code>\u53ef\u4ee5\u8ba9\u641c\u7d22\u7ed3\u679c\u9ad8\u4eae\uff0c\u4f46<code>SearchForm</code>\u5fc5\u987b\u8981\u7ee7\u627f<code>HighlightedSearchForm</code>\u3002<code>{{ result.model_name }}</code>\u53ef\u4ee5\u83b7\u53d6\u5230\u5f53\u524d\u7ed3\u679c\u5bf9\u5e94\u7684\u6a21\u578b\u540d\uff0c\u636e\u6b64\u53ef\u5bf9\u4e0d\u540c\u7684\u641c\u7d22\u7ed3\u679c\u505a\u51fa\u4e0d\u540c\u7684\u5c55\u793a\u6548\u679c\u3002<code>{{ result.object }}</code>\u65e2\u4e3a\u539f\u59cb\u5bf9\u8c61\uff0c\u53ef\u636e\u6b64\u83b7\u53d6\u5230\u539f\u59cb\u5bf9\u8c61\u7684\u5404\u4e2a\u5c5e\u6027\u3002\u82e5\u60f3\u53ef\u4ee5\u6309\u6a21\u578b\u68c0\u7d22\u8bf7\u4f7f\u7528<code>ModelSearchForm</code>\u6216<code>HighlightedModelSearchForm</code>\uff0c\u68c0\u7d22\u53d1\u8d77\u7684<code>form</code>\u4e0d\u5b9c\u518d\u81ea\u5b9a\u4e49\uff0c\u5e94\u4f7f\u7528<code>{{ form.as_table }}</code>\u3002</p>"},{"location":"python/django/django-m2m/","title":"Django save\u65b9\u6cd5\u4e0d\u7acb\u5373\u66f4\u65b0ManyToManyField\u7684\u95ee\u9898","text":"<p>\u5728Django\u4e2d\u91cd\u5199model\u7684save\u65b9\u6cd5\uff0c\u5728save\u65b9\u6cd5\u4e2d\u5148\u4fdd\u5b58self\u6570\u636e\uff0c\u4f46\u662f\u7acb\u5373\u83b7\u53d6self\u7684ManyToManyField\u4f9d\u65e7\u4e3a\u672a\u66f4\u65b0\u4e4b\u524d\u7684ManyToManyField\u5185\u5bb9\uff0c\u53ea\u6709\u4e0b\u6b21\u66f4\u65b0\u7684\u65f6\u5019\u624d\u80fd\u83b7\u53d6\u5230\u4e0a\u6b21\u66f4\u65b0\u65f6\u7684ManyToManyField\u5b57\u6bb5\u5185\u5bb9\u3002\u8fd9\u662f\u7531\u4e8e\u5728save\u4e4b\u540e\u7acb\u5373\u8c03\u7528self\u7684ManyToManyField\u5b57\u6bb5\uff0c\u4f46\u662fManyToManyField\u7684\u6570\u636e\u5e93\u901a\u8baf\u8fd8\u6ca1\u6709\u5b8c\u6210\uff0c\u6240\u4ee5\u83b7\u53d6\u5230\u7684\u662f\u4e4b\u524d\u7684ManyToManyField\u5b57\u6bb5\u5185\u5bb9\uff0c\u6211\u4eec\u9700\u8981\u76d1\u542c\u6570\u636e\u5e93\u901a\u8baf\u8fc7\u7a0b\uff0c\u7b49\u5f85\u901a\u8baf\u5b8c\u6210\u518d\u53bb\u83b7\u53d6\u66f4\u65b0\u5b8c\u6210\u7684ManyToManyField\u5185\u7684\u5b57\u6bb5\u5185\u5bb9\u3002</p> <p>\u5177\u4f53\u65b9\u6cd5\uff1a\u5728Django 1.9\u4e4b\u540e\u63d0\u4f9b\u4e86transaction\u5de5\u5177\u6765\u76d1\u542c\u6570\u636e\u5e93\u901a\u8baf\u8fc7\u7a0b\uff0c\u6587\u6863\u89c1performing-actions-after-commit\uff0c\u57281.9\u4e4b\u524d\u53ef\u4ee5\u4f7f\u7528django-transaction-hooks\u6765\u76d1\u542c\u6570\u636e\u5e93\u901a\u8baf\u8fc7\u7a0b\u3002</p> <p>\u5b9e\u4f8b\u4ee3\u7801(category\u4e3aManyToManyField\u5bf9\u5e94\u7684\u5b57\u6bb5)\uff1a</p> <pre><code>from django.db import transaction\nclass Goods(models.Model):\n.\n.\n.\ndef save(self, *args, **kwargs):\n# \u5148\u4fdd\u5b58\u5546\u54c1\u6761\u76ee\ninstance = super(Goods, self).save(*args, **kwargs)\nprint(self.unit)\n# \u8c03\u7528transaction.on_commit\u76d1\u542c\u6570\u636e\u5e93\u901a\u8baf\u6267\u884c\u5b8c\u6210\n# update_content\u65b9\u6cd5\u4e0d\u53ef\u4ee5\u53d8\u6210update_content()\ntransaction.on_commit(self.update_content)\nreturn instance\ndef update_content(self):\n# \u6b64\u65f6\u83b7\u5f97\u7684self.category.all()\u4e3a\u66f4\u65b0\u540e\u7684\u6570\u636e\u96c6\u5408\nfor category in self.category.all():\nprint(category.__str__())\nContent.objects.get_or_create(goods=self, category=category)\n</code></pre> <p>\u65b9\u6cd5\u4e8c\u662f\u4f7f\u7528signal\u6765\u76d1\u542cm2m\u5b57\u6bb5\u53d8\u5316\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>from django.db.models.signals import m2m_changed\n@receiver(m2m_changed, sender=Person.friends.through)\ndef friends_change(sender, action, pk_set, instance=None, **kwargs):\nif action in ['post_add', 'post_remove']:\nqueryset = instance.friends.all()\nfor friend in queryset:\nprint(friend.__str__())\n</code></pre>"},{"location":"python/django/django-model/","title":"Django\u91cd\u5199model\u7684\u589e\u5220\u67e5\u6539\u65b9\u6cd5","text":"<p>\u91cd\u5199model\u7684\u589e\u5220\u67e5\u6539\u65b9\u6cd5:</p> <pre><code>class MyModel(model.Model):\ndef save(self, *args, **kwargs):\nif not self.pk:\n# \u589e\nelse:\n# \u6539\nreturn super(MyModel, self).save(*args, **kwargs)\ndef delete(self):\n# \u5220 \u8be5\u65b9\u6cd5\u5728admin\u4e2d\u6279\u91cf\u5220\u9664\u65f6\u4e0d\u53ef\u7528 \u81f3\u9488\u5bf9\u5355\u4e2ainstant\u5220\u9664\nreturn super(MyModel, self).delete()\n</code></pre> <p>\u5982\u679c\u9700\u8981\u5b9e\u73b0\u6279\u91cf\u5220\u9664\u9700\u8981\u91cd\u5199\u9ed8\u8ba4\u7684Manager:</p> <pre><code># multiple delete\nclass FilesManager(models.QuerySet):\ndef delete(self, *args, **kwargs):\nfor obj in self:\nobj.file.delete()\nsuper(FilesManager, self).delete(*args, **kwargs)\nclass MyModel(model.Model):\n# change default manager to FilesManager\nobjects = FilesManager.as_manager()\ndef save(self, *args, **kwargs):\nif not self.pk:\n# \u589e\nelse:\n# \u6539\nreturn super(MyModel, self).save(*args, **kwargs)\ndef delete(self):\n# \u5220 \u8be5\u65b9\u6cd5\u5728admin\u4e2d\u6279\u91cf\u5220\u9664\u65f6\u4e0d\u53ef\u7528 \u81f3\u9488\u5bf9\u5355\u4e2ainstant\u5220\u9664\nreturn super(MyModel, self).delete()\n</code></pre> <p>\u5224\u65ad\u5b57\u6bb5\u88ab\u6539\u52a8\u7684\u4e24\u79cd\u65b9\u6cd5</p> <p>\u65b9\u6cd51:\ufeff</p> <pre><code>class MyModel(models.Model):\nf1 = models.CharField(max_length=1)\ndef save(self, *args, **kw):\nif self.pk is not None:\nthis = MyModel.objects.get(pk=self.pk)\nif this.f1 != self.f1:                print 'f1 changed'\nsuper(MyModel, self).save(*args, **kw)\n</code></pre> <p>\u65b9\u6cd52\uff1a</p> <pre><code>class Person(models.Model):\nname = models.CharField()\n__original_name = None\ndef __init__(self, *args, **kwargs):\nsuper(Person, self).__init__(*args, **kwargs)\nself.__original_name = self.name\ndef save(self, force_insert=False, force_update=False, *args, **kwargs):\nif self.name != self.__original_name:\n# name changed - do something here\nsuper(Person, self).save(force_insert, force_update, *args, **kwargs)\nself.__original_name = self.name\n</code></pre>"},{"location":"python/django/django-multiselectfield/","title":"Django-multiselectfield\u5b9e\u73b0\u56fa\u5b9a\u503c\u591a\u9009","text":""},{"location":"python/django/django-multiselectfield/#_1","title":"\u5b89\u88c5","text":"<pre><code>pip install django-multiselectfield\n</code></pre>"},{"location":"python/django/django-multiselectfield/#model","title":"<code>model</code>","text":"<pre><code>from multiselectfield import MultiSelectField\nMultiCategory = (\n(0, '\u6d4b\u8bd51'),\n(1, '\u6d4b\u8bd52'),\n(2, '\u6d4b\u8bd53'),\n(3, '\u6d4b\u8bd54'),\n)\n# \u7528\u836f\u5bf9\u8d26\nclass Demo(models.Model):\n# \u7c7b\u578b\ncategories = MultiSelectField(choices=MultiCategory,\nmax_length=255,\nverbose_name='\u7c7b\u578b')\n...\n</code></pre>"},{"location":"python/django/django-multiselectfield/#_2","title":"\u81ea\u5b9a\u4e49\u6a21\u677f","text":"<p>It is possible to customize the HTML of this widget in your form template. To do so, you will need to loop through<code>form.{field}.field.choices</code>. Here is an example that displays the field label underneath/after the checkbox for a<code>MultiSelectField</code> called <code>providers</code>:</p> <pre><code>{% for value, text in form.providers.field.choices %}\n  &lt;div class=\"ui slider checkbox\"&gt;\n&lt;input id=\"id_providers_{{ forloop.counter0 }}\" name=\"{{ form.providers.name }}\" type=\"checkbox\" value=\"{{ value }}\"{% if value in checked_providers %} checked=\"checked\"{% endif %}&gt;\n&lt;label&gt;{{ text }}&lt;/label&gt;\n&lt;/div&gt;\n{% endfor %}\n</code></pre> <p>\u672a\u6d4b\u8bd5\uff0c\u76f4\u63a5\u5f15\u7528\u6587\u6863\u3002\u524d\u7aef\u53ef\u914d\u5408\u5e93multi-select\u4f7f\u7528\u3002</p>"},{"location":"python/django/django-multiselectfield/#django-rest-framework","title":"Django REST Framework","text":"<pre><code>from rest_framework import fields\n# \u65b0\u5efa categories\u53c2\u6570\u4f20\u9012list\nclass DemoCreateSerializer(ModelSerializer):\ncategories = fields.MultipleChoiceField(choices=MultiCategory, label='\u7c7b\u578b')\n...\n# \u5217\u8868 \u8be6\u60c5\nclass DemoSerializer(ModelSerializer):\nclass Meta:\nmodel = Demo\nfields = ('id', 'category', 'get_category_display')\n</code></pre> <p>\u5217\u8868\u548c\u8be6\u60c5\u5927\u81f4\u4f1a\u8fd4\u56de\u5982\u4e0b\u683c\u5f0f\u7684\u6570\u636e\uff1a</p> <pre><code>{\n\"id\": 7,\n\"categories\": [\n\"0\",\n\"1\",\n\"2\"\n],\n\"get_categories_display\": \"\u6d4b\u8bd51, \u6d4b\u8bd52, \u6d4b\u8bd53\"\n}\n</code></pre>"},{"location":"python/django/django-multiselectfield/#inttypeerror-sequence-item-int_value-expected-str-instance-int-found","title":"\u9009\u9879\u503c\u4e3aInt\u7c7b\u578b\u65f6\uff0c\u62a5\u9519<code>TypeError: sequence item int_value: expected str instance, int found</code>","text":"<p>\u636e\u539f\u4f5c\u8005\u6240\u8bf4\uff0c\u8fd9\u4e2a\u95ee\u9898\u4e3a\u4e86\u517c\u5bb9\u6027\u4e0d\u65b9\u4fbf\u4fee\u6539\u3002 \u81ea\u884c\u5728\u4ee3\u7801\u91cc\u505a\u4e86\u517c\u5bb9\uff0c</p> <pre><code>from multiselectfield import MultiSelectField\nclass MultiSelectCompatIntField(MultiSelectField):\ndef get_prep_value(self, value):\nreturn '' if value is None else ','.join([str(x) for x in value])\n</code></pre> <p>\u4f7f\u7528<code>MultiSelectCompatIntField</code>\u66ff\u6362<code>MultiSelectField</code>\u5373\u53ef\uff0c\u5c06<code>value</code>\u91cc\u7684<code>item</code>\u7531<code>int</code>\u8f6c\u4e3a<code>str</code>\u3002</p> <p>Pull Request #86</p>"},{"location":"python/django/django-note/","title":"Django\u7b14\u8bb0","text":""},{"location":"python/django/django-note/#_1","title":"\u5e38\u7528\u547d\u4ee4","text":"<ul> <li>django-admin.py startproject projectname  \u521b\u5efa\u9879\u76ee</li> <li>django-admin.py startapp appname \u521b\u5efa\u5e94\u7528</li> <li>python manage.py migrations \u5c06models\u53d8\u5316\u8fc1\u79fb\u81f3migrations</li> <li>python manage.py migrate \u5c06migrations\u53d8\u5316\u8fc1\u79fb\u81f3\u6570\u636e\u5e93</li> <li>python manage.py collectstatic \u62f7\u8d1d\u6240\u6709\u7c7b\u5e93\u53caapp\u4e0b\u7684static\u6587\u4ef6\u5939\u81f3STATIC_ROOT\u6587\u4ef6\u5939</li> <li>python manage.py createsuperuser \u521b\u5efa\u8d85\u7ea7\u7ba1\u7406\u5458</li> <li>python manage.py runserver 192.168.1.101:80 \u5728\u5bf9\u5e94\u7684IP\u5730\u5740\u548c\u7aef\u53e3\u53f7\u4e0a\u8fd0\u884c\u6d4b\u8bd5\u670d\u52a1\u5668</li> <li>pip install django -i https://pypi.douban.com/simple  pip\u66f4\u6362\u6e90</li> <li>pip install django --upgrade \u5347\u7ea7\u81f3\u6700\u65b0\u7248\u672c</li> <li>pip install django --upgrade -i https://pypi.douban.com/simple  pip \u4f7f\u7528\u8c46\u74e3\u6e90\u66f4\u65b0\u81f3\u6700\u65b0\u7248\u672c</li> <li>pip install -r requirements.txt #\u6279\u91cf\u5b89\u88c5 \u53ef\u7528 -i \u6307\u5b9a\u6e90</li> <li>pip freeze &gt; requirements.txt \u81ea\u52a8\u751f\u6210requirements.txt\u6587\u4ef6</li> </ul> <p>\u6253\u5370\u8be6\u7ec6\u7684\u9519\u8bef\u539f\u56e0\u81f3\u63a7\u5236\u53f0</p> <pre><code>import traceback\ntry:\nexcept:\ntraceback.print_exc()\n</code></pre> <pre><code>import ast\n# convert [1,2,3] to list directly \u76f4\u63a5\u5c06\u5b57\u7b26\u4e32[1,2,3]\u8f6c\u5316\u4e3alist\nmembers = ast.literal_eval(request.POST['members'])\n</code></pre>"},{"location":"python/django/django-note/#model","title":"Model\u76f8\u5173","text":""},{"location":"python/django/django-note/#foreignkey","title":"<code>ForeignKey</code>","text":"<p>\u5916\u952e\u662f\u5426\u6709\u503c</p> <pre><code>ForeignKey__isnull=True/False\n</code></pre> <p>\u5728\u4e0d\u8bbe\u7f6e\u7684\u65f6\u5019\u9ed8\u8ba4\u540d\u79f0\u662f</p> <pre><code>modelname_set\n</code></pre>"},{"location":"python/django/django-note/#_2","title":"\u662f\u5426\u6709\u503c","text":""},{"location":"python/django/django-note/#related_name","title":"\u8bbe\u7f6erelated_name","text":""},{"location":"python/django/django-note/#manytomnay","title":"<code>ManyToMnay</code>","text":"<p>\u6a21\u578b\uff1a</p> <pre><code># \u73ed\u7ea7\nclass MyClass(models.Model):\n# \u540d\u79f0\nname = models.CharField(max_length=255,\nnull=True,\nverbose_name=u'\u540d\u79f0')\n# \u5b66\u5458\nstudents = models.ManyToManyField('education.Student',\nblank=True,\nverbose_name=u'\u5b66\u5458')\n</code></pre> <p>\u7c7b\u578b\u5bf9\u5e94\u7684\u64cd\u4f5c\u4e3a</p> <pre><code>add/remove\n</code></pre> <p><code>add</code>\u4e00\u6b21\u6dfb\u52a0\u4e00\u4e2a<code>queryset</code>\u65f6\uff0c\u7528\u6cd5\u4e3a<code>manytomany.add(*queryset)</code>\u6216\u8005<code>manytomany.set(queryset)</code></p> <pre><code>courses = Course.objects.filter(id__in=request.data.getlist('courses'))\ninterview.pre_student.courses.add(*courses)\n</code></pre> <p>\u5728\u4e0d\u8bbe\u7f6e\u7684\u65f6\u5019\u9ed8\u8ba4\u540d\u79f0\u662f</p> <pre><code>modelname_set\n</code></pre> <p>\u5b66\u5458\u83b7\u53d6\u81ea\u5df1\u53c2\u52a0\u7684\u6240\u6709\u8bfe\u7a0b\uff1a</p> <pre><code>courses = request.user.prestudent.student.myclass_set.all() \n# \u4ee5myclass_set\u4e3a\u5173\u952e\u5b57\u8fdb\u884c\u53cd\u5411\u68c0\u7d22 myclass\u4e3a\u7c7b\u540d\u540e\u9762\u63a5_set\nprint(courses) # , , ]&gt;\n</code></pre> <p><code>\u793a\u4f8b</code>:</p> <pre><code># \u90e8\u95e8\nclass Department(models.Model):\n# \u90e8\u95e8\u540d\u79f0\nname = models.CharField(max_length=255,\nverbose_name=u'\u540d\u79f0')\n# \u5b50\u90e8\u95e8 \u5199\u6210'self'\u65f6\u4f1a\u51fa\u73b0\u6dfb\u52a0\u90e8\u95e81\u7684\u5b50\u90e8\u95e8\u4e3a\u90e8\u95e82\u65f6\n# \u90e8\u95e82\u7684\u5b50\u90e8\u95e8\u91cc\u4e5f\u4f1a\u6709\u90e8\u95e81\u7684bug\ndepartments = models.ManyToManyField('school.Department',\nblank=True,\nverbose_name='\u5b50\u90e8\u95e8')\n</code></pre> <p>\u6b64\u5904\u5b50\u90e8\u95e8 M2M\u7684\u5173\u8054\u5199\u6210<code>'self'</code>\u65f6\u4f1a\u51fa\u73b0\u6dfb\u52a0\u90e8\u95e81\u7684\u5b50\u90e8\u95e8\u4e3a\u90e8\u95e82\u65f6\uff0c\u90e8\u95e82\u7684\u5b50\u90e8\u95e8\u91cc\u4e5f\u4f1a\u6709\u90e8\u95e81\u7684bug\u3002 \u5176\u5b9e\u8fd9\u4e0d\u662fbug,\u89e3\u51b3\u65b9\u6cd5\u4e3a \uff081\uff09\u5c06<code>'self'</code>\u6362\u6210<code>'department.Department'</code> (2) \u5728<code>departments</code>\u5b57\u6bb5\u4e2d\u52a0\u5165<code>'symmetrical=False'</code>\uff0c\u8be6\u7ec6\u4ecb\u7ecd\u89c1ManyToManyField.symmetrical\u3002</p> <p>Only used in the definition of ManyToManyFields on self. Consider the following model:</p> <pre><code>from django.db import models\nclass Person(models.Model):\nfriends = models.ManyToManyField(\"self\")\n</code></pre> <p>When Django processes this model, it identifies that it has a ManyToManyField on itself, and as a result, it doesn\u2019t add a person_set attribute to the Person class. Instead, the ManyToManyField is assumed to be symmetrical \u2013 that is, if I am your friend, then you are my friend.</p> <p>If you do not want symmetry in many-to-many relationships with self, set symmetrical to False. This will force Django to add the descriptor for the reverse relationship, allowing ManyToManyField relationships to be non-symmetrical.</p>"},{"location":"python/django/django-note/#_3","title":"\u6dfb\u52a0\u3001\u79fb\u9664","text":""},{"location":"python/django/django-note/#_4","title":"\u6279\u91cf\u6dfb\u52a0","text":""},{"location":"python/django/django-note/#related_name_1","title":"\u8bbe\u7f6e<code>related_name</code>","text":""},{"location":"python/django/django-note/#_5","title":"\u53cd\u5411\u68c0\u7d22","text":""},{"location":"python/django/django-note/#m2mself","title":"M2M\u5230<code>self</code>\u65f6\u7684\u95ee\u9898","text":""},{"location":"python/django/django-note/#_6","title":"\u5916\u952e\u5230\u4e00\u4e2a\u4e0d\u786e\u5b9a\u7684\u7c7b\u7684\u5bf9\u8c61","text":"<pre><code>from django.apps import apps\nfrom django.contrib.contenttypes.models import ContentType\nfrom django.contrib.contenttypes.fields import GenericForeignKey\nclass UnSureModel(models.Model):\n# \u7c7b\u7684content_type\ncontent_type = models.ForeignKey(ContentType,\nnull=True,\nblank=True,\nverbose_name=u'\u6570\u636e\u6765\u6e90')\n# \u5bf9\u5e94\u7c7b\u578b\u5b9e\u4f8bID\nobject_id = models.PositiveIntegerField(null=True,\nblank=True,\nverbose_name=u'\u5b9e\u4f8bID')\n# \u5bf9\u5e94\u7684\u5b9e\u4f8b\ncontent_object = GenericForeignKey('content_type', 'object_id')\ndef get_select_object(self):\nif self.content_type and self.object_id:\nselect_model = apps.get_model(app_label=self.content_type.app_label,\nmodel_name=self.content_type.model)\ntry:\nselect_object = select_model.objects.get(id=self.object_id)\nreturn select_object\nexcept ObjectDoesNotExist:\nreturn None\nelse:\nreturn None\n</code></pre>"},{"location":"python/django/django-note/#durationfield","title":"<code>DurationField</code>\u4f7f\u7528","text":"<p>\u65b0\u589e\u65f6\u4f20\u5165<code>timedelta</code>\u5bf9\u8c61\uff1a</p> <pre><code>craft = Craft.objects.create(name='\u6d4b\u8bd5', craft_duration=timedelta(minutes=10))\n</code></pre> <p>DRF\u5728\u65b0\u589e\u8be5\u5b57\u6bb5\u65f6\u662f\u4ee5\u79d2\u4e3a\u5355\u4f4d\u3002</p>"},{"location":"python/django/django-note/#bulk_create","title":"<code>bulk_create</code>\u4f7f\u7528","text":"<p><code>PostMan</code>\u53d1\u9001\u6570\u636e\uff1a</p> <pre><code>choices\uff1a{'name':'c', 'content':'sss', 'is_right':False} choices\uff1a{'name':'d', 'content':'sssssss', 'is_right':2}\n</code></pre> <p>\u4ee3\u7801\uff1a</p> <pre><code>choices = dict_to_query_dict(request.data).getlist('choices') # \u83b7\u53d6choices\u7684list\n# list\u4e2dstr\u8f6c\u6362\u4e3adict,dict\u518d\u8f6c\u6362\u4e3aChoice\u7c7b\u5b9e\u4f8b\uff0c\u6240\u6709\u7684\u7c7b\u5b9e\u4f8b\u5408\u5e76\u4e3alist\n# bulk_create\u5165\u53c2\u8be5list,\u5176\u5185\u90e8\u5c01\u88c5\u597d\u4e8b\u52a1,\u82e5\u5176\u4e2d\u4e00\u4e2a\u751f\u4ea7\u9519\u8bef\uff0c\u5219\u4f1a\u81ea\u52a8\u64a4\u9500\u4e4b\u524d\u64cd\u4f5c\nchoice_list = Choice.objects.bulk_create([Choice(**ast.literal_eval(choice)) for choice in choices])\n# PS\uff1abulk_create\u4e0d\u4f1a\u8c03\u7528\u5b9e\u4f8b\u7684save\u65b9\u6cd5,\u4e0d\u4f1a\u53d1\u51fapost_save\u4fe1\u53f7,\u8fd4\u56de\u5b9e\u4f8b\u65e0ID,\u9700\u8981\u518d\u6b21\u624b\u52a8\u8c03\u7528save()\nfor choice in choice_list:\nchoice.save()\ninstance = question_serializer.save()\ninstance.choices.add(*choice_list)\nchapter.questions.add(instance)\n</code></pre> <p>\u4e0a\u8ff0<code>PostMan</code>\u53d1\u9001\u7684\u7b2c\u4e8c\u6761\u6570\u636e<code>is_right</code>\u7c7b\u578b\u9519\u8bef\uff0c\u65e0\u6cd5\u4fdd\u5b58\uff0c\u63d0\u793a\u9519\u8bef\uff1aValidationError: ['\u20192\u2018 \u5fc5\u987b\u4e3a True \u6216\u8005 False\u3002']\uff0cbulk_create\u65b9\u6cd5\u5185\u90e8\u5c01\u88c5\u597d\u4e8b\u52a1\uff0c\u5219\u7b2c\u4e00\u6761\u6b63\u786e\u7684\u8bb0\u5f55\u4e5f\u4e0d\u4f1a\u88ab\u65b0\u589e\u3002</p>"},{"location":"python/django/django-note/#_7","title":"\u91d1\u989d\u64cd\u4f5c","text":"<p>\u5bf9\u91d1\u989d\u8fdb\u884c\u64cd\u4f5c\u65f6\uff0c\u4e00\u5f8b\u4f7f\u7528<code>DecimalField</code>\u800c\u4e0d\u4f7f\u7528<code>FloatFiled</code>\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c<code>DecimalField</code>\u5728\u6a21\u578b\u4e2d\u8bbe\u7f6e\u9ed8\u8ba4\u503c\u65f6\uff0c\u5e94\u662f\uff1a</p> <pre><code>price = models.DecimalField(default=Decimal(0.00),\nmax_digits=16,\ndecimal_places=4,\nverbose_name='\u552e\u4ef7')\n</code></pre> <p>\u800c\u4e0d\u662f</p> <pre><code>price = models.DecimalField(default=0.00,\nmax_digits=16,\ndecimal_places=4,\nverbose_name='\u552e\u4ef7')\n</code></pre> <p>\u867d\u7136\u4e0d\u652f\u6301<code>Decimal</code>\u7c7b\u578b\u4e0e<code>float</code>\u7c7b\u578b\u8fdb\u884c\u6df7\u5408\u64cd\u4f5c\uff0c\u5219\u5168\u90e8\u8f6c\u6362\u4e3a<code>Decimal</code>\u7c7b\u578b\u518d\u8fdb\u884c\u56db\u5219\u8fd0\u7b97\u3002</p> <pre><code>from decimal import Decimal\ndiscounted_price = Decimal(self.discount_event.calculate_discount(self.real_price))\nself.discounted_event_price = self.real_price - discounted_price\n</code></pre> <p>float\u7c7b\u578b\u7684str\u8f6c\u4e3aint\uff0c\u9700\u8981\u5148\u8f6c\u5316\u4e3afloat\u518d\u8f6c\u5316\u4e3aint\uff0c\u4e0d\u53ef\u76f4\u63a5\u8f6c\u6362:</p> <pre><code>class_hours = int(float(request.data['class_hours']))\n</code></pre> <p>\u4e0d\u7136\u4f1a\u5c06DecimalField\u7684\u9ed8\u8ba4\u503c\u8bbe\u7f6e\u4e3a\u4e00\u4e2afloat,\u5728\u8ba1\u7b97\u65f6\u4f1a\u5e26\u6765\u7c7b\u4f3c<code>TypeError: unsupported operand type(s) for *: 'float' and 'decimal.Decimal'</code>\u8fd9\u6837\u7684\u9519\u8bef\u3002</p>"},{"location":"python/django/django-note/#_8","title":"\u9a8c\u8bc1\u76f8\u5173","text":"<ul> <li>\u9650\u5236\u56fe\u7247\u5927\u5c0f</li> </ul> <pre><code>def validate_image_size(value):\n\"\"\"\n    \u9650\u5236\u56fe\u7247\u6587\u4ef6\u5927\u5c0f\u4e3a2M 2M=2*1024KB=2*1024*1024Byte (Byte\u65e2\u5b57\u8282)\n    :param value:\u6587\u4ef6\u5b9e\u4f8b\n    :return: raise \u6587\u4ef6\u5927\u5c0f\u8d85\u8fc72MB\n    \"\"\"\nif value.size &gt; 2097152:\nraise ValidationError(u'\u6587\u4ef6\u5927\u5c0f\u8d85\u8fc72MB')\nimage = models.ImageField(upload_to=get_image_path,\nvalidators=[validate_image_size],\nverbose_name='\u56fe\u7247')\n</code></pre> <ul> <li>model\u4e2d\u4f7f\u7528clean\u65b9\u6cd5\u53bb\u63a7\u5236\u4e00\u4e0b\u6bd4\u8f83\u590d\u6742\u7684\u6a21\u578b\u9a8c\u8bc1</li> </ul> <pre><code># \u6536\u652f\u6b3e\u9879\nclass IncomeExpense(models.Model):\n....\ndef clean(self):\npoint, is_created = Point.objects.get_or_create(user=self.user)\nif self.pk:\nthis = IncomeExpense.objects.get(id=self.id)\n# \u672a\u652f\u4ed8-&gt;\u652f\u4ed8\nif this.payment_state == 0 and self.payment_state == 1:\n# \u6536\u5165 \u4f7f\u7528\u4f59\u989d\u652f\u4ed8\nif self.category.income_expense == 0 and self.payment_category.code == 1:\nif point.value &lt; self.amount:\nraise ValidationError({\n'payment_category': '\u8d26\u6237\u4f59\u989d\u4e0d\u8db3 \u4f59\u989d:{} \u5f85\u652f\u4ed8:{}'.format(point.value, self.amount)})\nelse:\n# \u5df2\u652f\u4ed8 \u6536\u5165 \u4f7f\u7528\u4f59\u989d\u652f\u4ed8\nif self.payment_state == 1 and self.category.income_expense == 0 and self.payment_category.code == 1:\nif point.value &lt; self.amount:\nraise ValidationError(\n{'payment_category': '\u8d26\u6237\u4f59\u989d\u4e0d\u8db3 \u4f59\u989d:{} \u5f85\u652f\u4ed8:{}'.format(point.value, self.amount)})\n</code></pre>"},{"location":"python/django/django-note/#property","title":"<code>property</code>","text":"<pre><code>\u6bd4\u5982\u8bf4\u73b0\u5728\u7528\u6237\u4fe1\u606f\u4e2d\u5b58\u50a8\u4e86\u751f\u65e5\u7684\u4fe1\u606f\uff0c\u73b0\u5728\u9700\u8981\u6839\u636e\u751f\u65e5\u53bb\u83b7\u53d6\u5e74\u9f84\uff0c\u4e00\u822c\u65b9\u6cd5\u4e3a\u5b9a\u4e49\u4e00\u4e2aget_age\u7684\u65b9\u6cd5\uff0c\u5982\u4e0b\uff1a\nclass BaseProfile(models.Model):\nbirthdate = models.DateField()\n#...\ndef get_age(self):\ntoday = datetime.date.today()\nreturn (today.year - self.birthdate.year) - int(\n(today.month, today.day) &lt;\n(self.birthdate.month, self.birthdate.day))\n\u4f7f\u7528`profile.get_age()`\u53ef\u4ee5\u83b7\u53d6\u5230\u5bf9\u5e94\u7684\u7528\u6237\u5e74\u9f84\u4fe1\u606f\uff0c\u4f46\u662fprofile.age\u4f1a\u66f4\u5177\u6709\u53ef\u8bfb\u6027\u4e5f\u66f4\u7b26\u5408python\u7684\u7f16\u7a0b\u7406\u5ff5\uff0c\u8fd9\u65f6\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528`property`\u88c5\u9970\u5668\u6765\u5b9e\u73b0\u8fd9\u6837\u7684\u529f\u80fd:\n@property\ndef age(self):\n\u8fd9\u65f6\u6211\u4eec\u5c31\u53ef\u4ee5\u7528`profile.age`\u6765\u83b7\u53d6\u7528\u6237\u7684\u5e74\u9f84\u4fe1\u606f\u4e86\u3002\u4f46\u662f`profile`\u6709\u4e00\u4e2a\u7f3a\u70b9\u5c31\u662f\u548c\u7c7b\u7684\u5185\u90e8\u65b9\u6cd5\u4e00\u6837\u65e0\u6cd5\u5728ORM\u4e2d\u4f7f\u7528\u3002\n&gt; Django Design Patterns and Best Practices P45\n</code></pre>"},{"location":"python/django/django-note/#cached-properties","title":"<code>Cached properties</code>","text":"<pre><code>`cached_property`\u6bd4\u5bf9`property`\u53ef\u4ee5\u7f13\u5b58\u8ba1\u7b97\u7ed3\u679c\uff0c\u9002\u5408\u9891\u7e41\u8c03\u7528\u7684\u53c2\u6570\u6216\u8005\u8ba1\u7b97\u5f00\u9500\u8fc7\u5927\u7684\u53c2\u6570\u3002\nfrom django.utils.functional import cached_property\n#...\n@cached_property\ndef full_name(self):\nreturn \"{0} {1}\".format(self.firstname, self.lastname)\n&gt; Django Design Patterns and Best Practices P45\n</code></pre>"},{"location":"python/django/django-note/#unique_togethercharnulltrueblanktrue","title":"<code>unique_together</code>\u5176\u4e2d\u6709Char\u5b57\u6bb5<code>null=True,blank=True</code>","text":"<p><code>unique_together</code>\u5176\u4e2d\u6709Char\u5b57\u6bb5<code>null=True,blank=True</code>\uff0c\u5bfc\u81f4\u8f93\u5165null\u4e5f\u4f1a\u62a5\u91cd\u590d\u9519\u8bef\uff0c\u6b64\u65f6\u5c06<code>CharField</code>\u66ff\u6362\u4e3a<code>CharNullField</code>\u5b57\u6bb5\u5373\u53ef\u3002</p> <pre><code># issue null=True\u548cunique=True\n# \u540c\u65f6\u4f7f\u7528\u4f1a\u5bfc\u81f4\u7a7a\u503c\u88ab\u5224\u65ad\u4e3a\u76f8\u540c\nclass CharNullField(models.CharField):\ndescription = \"CharField that stores NULL\"\ndef get_db_prep_value(self, value, connection=None, prepared=False):\nvalue = super(CharNullField, self).get_db_prep_value(value, connection, prepared)\nif value == \"\":\nreturn None\nelse:\nreturn value\n</code></pre>"},{"location":"python/django/django-note/#_9","title":"\u68c0\u7d22\u76f8\u5173","text":""},{"location":"python/django/django-note/#queryset","title":"<code>queryset</code>\u5185\u64cd\u4f5c","text":"<pre><code>\u7528\u6cd5\uff1a `get_object_or_404(model,filter)`\n</code></pre> <p><code>instance, is_created = Model.object.get_or_create(name='my_name')</code></p> <p><code>instance</code>\u4e3a\u65b0\u589e\u6216\u8005\u8bfb\u53d6\u5230\u7684\u5b9e\u4f8b\uff0c<code>is_created</code>\u4ee3\u8868\u662f\u5426\u662f\u65b0\u5efa\u7684<code>instance</code>\u3002</p> <p>Annotate adds a field to results:</p> <pre><code>&gt;&gt; Order.objects.annotate(total_price=\n&gt;\n&gt;\n&gt;('price'))\n, ]&gt;\n&gt;&gt; orders.first().total_price\nDecimal('340.00')\n</code></pre> <p>Aggregate returns a dict with asked result:</p> <pre><code>&gt;&gt; Order.objects.aggregate(total_price=Sum('price'))\n{'total_price': Decimal('1260.00')}\n</code></pre> <p>eg\uff1a</p> <pre><code>from django.db.models import Sum\ncurrent_arrange_hours = class_schedule_my_draft.aggregate(Sum('hours'))['hours__sum']\n</code></pre> <p>\u65b9\u6cd5\u8fd4\u56de\u7684\u662fdict\u5bf9\u8c61\uff0c\u952e\u7684\u540d\u79f0\u4e3a \u6c42\u548c\u5b57\u6bb5\u540d__sum\uff0c\u83b7\u53d6\u8be5dict\u5bf9\u8c61\uff0c\u53d6\u503c\u5373\u53ef\u5f97\u5230\u548c\u3002</p> <p>QuerySet\u7684update()\u65b9\u6cd5\u4f1a\u76f4\u63a5\u751f\u6210SQL\u8868\u8fbe\u5f0f\uff0c\u4e0d\u4f1a\u8c03\u7528\u6a21\u578b\u7684save()\u65b9\u6cd5\u3002</p> <p>Be aware that the update() method is converted directly to an SQL statement. It is a bulk operation for direct updates. It doesn\u2019t run anysave() methods on your models, or emit the presave or postsave signals (which are a consequence of calling save()), or honor the auto_now field option. If you want to save every item in a QuerySet and make sure that the save() method is called on each instance, you don\u2019t need any special function to handle that. Just loop over them and call save():</p> <pre><code>for item in my_queryset:\nitem.save()\n</code></pre> <p>updating-multiple-objects-at-once</p> <p><code>aggregat\u200ce</code>(\u805a\u5408)\u751f\u6210\u7684\u65b0\u53c2\u6570\u76f4\u63a5\u52a0\u5165<code>queryset</code>\u7684\u5c5e\u6027\u4e2d\uff0c\u800c<code>annotate</code>(\u5907\u6ce8)\u662f\u9488\u5bf9<code>queryset</code>\u4e2d\u7684\u6bcf\u4e2aitem\u65b0\u589e\u4e00\u4e2a\u5c5e\u6027\uff0c\u5176\u4f5c\u7528\u5bf9\u8c61\u4e0d\u540c\u3002</p> <p>\u9700\u8981\u6ce8\u610f\uff0c\u5728<code>queryset</code>\u4f7f\u7528<code>annotate</code>\u548c<code>aggregate</code>\u4e4b\u524d\uff0c\u82e5\u662f\u4f7f\u7528\u4e86<code>filter</code>\u6216\u8005<code>exclude</code>\uff0c<code>filter</code>\u548c<code>exclude</code>\u4e2d\u7684\u68c0\u7d22\u6761\u4ef6\u4f1a\u88ab\u76f8\u5e94\u7684\u8003\u8651\u5230<code>annotate</code>\u548c<code>aggregate</code>\u51fd\u6570\u4e4b\u4e2d\uff0c\u82e5\u628a<code>filter</code>\u548c<code>exclude</code>\u653e\u5728<code>annotate</code>\u548c<code>aggregate</code>\u51fd\u6570\u7684\u540e\u9762\u6267\u884c\u5219\u4e0d\u4f1a\u6709\u5f71\u54cd\uff0c\u8be6\u89c1\u6b64\u5904\u3002</p> <p>\u793a\u4f8b\uff1a</p> <pre><code>from django.db.models import Count\ntags = [1, 2]\nsimilar_posts = Message.objects.filter(tag__in=tags)\nsimilar_posts = similar_posts.annotate(same_tags=Count('tag'))\nfor x in similar_posts:\nprint(x.id, x.same_tags, x.tag.all())\n13 1 , ]&gt;\n14 2 , , ]&gt;\n</code></pre> <p>\u53ef\u89c1ID\u4e3a13\u7684message\u771f\u6b63\u67092\u4e2a\u6807\u7b7e\uff0c\u4f46\u662f\u7b26\u5408filter\u4e2d\u6761\u4ef6\u7684\u53ea\u67091\u4e2a\uff1bID\u4e3a14\u7684message\u771f\u6b63\u67093\u4e2a\u6807\u7b7e\uff0c\u7b26\u5408filter\u4e2d\u6761\u4ef6\u7684\u53ea\u67092\u4e2a\u3002</p> <pre><code>similar_posts = Message.objects.all() # \u5220\u9664filter\u540e\n13 2 , ]&gt;\n14 3 , , ]&gt;\n</code></pre> <p>\u53ef\u89c1\u5220\u9664filter\u540e\u5f97\u5230\u7684\u6807\u7b7e\u603b\u548c\u624d\u662fMessage\u5305\u542b\u7684\u771f\u6b63\u6807\u7b7e\u6570\u91cf\u3002</p> <p><code>distinct</code>\u51fd\u6570\u5fc5\u987b\u548c<code>order_by</code>\u914d\u5408\u624d\u751f\u6548\uff0c<code>order_by</code>\u5728<code>distinct</code>\u4e4b\u524d\u4e4b\u540e\u90fd\u53ef\u4ee5\u3002</p> <pre><code>Craft.objects.values_list('stage_num', flat=True).distinct()\nCraft.objects.values_list('stage_num', flat=True).distinct().order_by('stage_num')\n</code></pre> <p>Doc model queryset distinct Note</p> <pre><code># fk_ids = [x.fk.id for x in instance.items.all()]\nfk_ids = instance.items.values_list('fk_id', flat=True)\nFK.objects.filter(id__in=fk_ids).all()\n</code></pre> <p>\u5148\u83b7\u53d6\u5916\u952eID\u5217\u8868\uff0c\u88ab\u6ce8\u91ca\u7684\u65b9\u6cd5\u8017\u65f6\u4e3a0.0020s\uff0c\u672a\u6ce8\u91ca\u7684\u65b9\u6cd5\u8017\u65f6\u4e3a0:00:00\uff0c\u63a8\u8350\u4f7f\u7528\u672a\u6ce8\u91ca\u7684\u65b9\u6cd5\uff0c\u4e0d\u7528\u904d\u5386\u5217\u8868\uff0c\u76f4\u63a5\u7531\u6570\u636e\u5e93\u64cd\u4f5c\u83b7\u53d6\u5916\u952eID\u5217\u8868\uff0c\u8017\u65f6\u66f4\u4f4e\u4e5f\u66f4\u4e3a\u7b80\u6d01\u3002</p> <pre><code># \u516c\u5f00\u6587\u7ae0Manager\nclass PublicManager(models.Manager):\ndef get_queryset(self):\nreturn super(PublicManager, self).get_queryset().filter(is_public=True)\n# \u6587\u7ae0\nclass Article(models.Model):\nis_public = models.BooleanField(default=False, verbose_name='\u516c\u5f00')\nobjects = models.Manager()\npublic = PublicManager()\n</code></pre> <p>\u83b7\u53d6\u516c\u5f00\u7684\u6587\u7ae0\u65f6\u76f4\u63a5\u8bbf\u95ee<code>Article.public.all()</code>\u5373\u53ef\uff0c\u4e0d\u9700\u8981\u4f7f\u7528<code>Article.objects.filter(is_public=True)</code>,\u4f7f\u7528\u8d77\u6765\u66f4\u65b9\u4fbf\u3002</p>"},{"location":"python/django/django-note/#get_object_or_404","title":"<code>get_object_or_404</code>","text":""},{"location":"python/django/django-note/#get_or_create","title":"<code>get_or_create</code>","text":""},{"location":"python/django/django-note/#queryset_1","title":"\u6c42querySet\u67d0\u4e00\u5b57\u6bb5\u7684\u548c","text":""},{"location":"python/django/django-note/#update","title":"<code>update()</code>\u65b9\u6cd5\u6ce8\u610f\u4e8b\u9879","text":""},{"location":"python/django/django-note/#annotateaggregate","title":"<code>annotate</code>\u548c<code>aggregat\u200ce</code>\u51fd\u6570","text":""},{"location":"python/django/django-note/#values_list","title":"<code>values_list</code>\u53bb\u91cd","text":""},{"location":"python/django/django-note/#queryset_2","title":"queryset\u83b7\u53d6\u5916\u952e\u5217\u8868","text":""},{"location":"python/django/django-note/#manager","title":"\u81ea\u5b9a\u4e49Manager","text":""},{"location":"python/django/django-note/#search_fields","title":"\u5982\u4f55\u5728 search_fields \u4e2d\u5305\u542b\u5916\u952e\u5b57\u6bb5","text":"<p>\u5f53 search_fields \u5305\u542b\u5916\u952e\u5b57\u6bb5\u65f6\uff0c\u6b64\u65f6\u8fdb\u884c\u641c\u7d22\u4f1a\u62a5\u9519Related Field got invalid lookup: icontains,\u89e3\u51b3\u7684\u529e\u6cd5\u662f\u4fee\u6539 search_fields \u4e2d\u7684\u5916\u952e\u5b57\u6bb5\u540d\u79f0\u3002\u5c06 search_fields \u4e2d\u7684\u5916\u952e\u5b57\u6bb5\u6539\u4e3a foreign_key__related_fieldname \u8fd9\u79cd\u5f62\u5f0f\u5c31\u53ef\u4ee5\u4e86\u3002 \u8fd9\u79cd\u7528\u6cd5\u9002\u7528\u4e8e ForeignKey \u53ca ManyToManyField \u3002</p> <pre><code>class Content(models.Model):\n# \u5bf9\u5e94\u5546\u54c1\ngoods = models.ForeignKey('goods.Goods',\nrelated_name='content_goods',\non_delete=models.CASCADE,\nverbose_name='\u5546\u54c1')\n# \u5546\u54c1\u5305\u542b\u7684\u542b\u91cf\u540d\ncategory = models.ForeignKey('goods.Category',\nrelated_name='content_category',\non_delete=models.CASCADE,\nverbose_name='\u542b\u91cf\u540d')\n# \u542b\u91cf\u540d\u5bf9\u5e94\u7684\u542b\u91cf\u503c max_digits\u51cfdecimal_places\u4e3a\u6574\u6570\u90e8\u5206\u652f\u6301\u7684\u6700\u5927\u4f4d\u6570\nvalue = models.DecimalField(default=0.00,\nmax_digits=10,\ndecimal_places=3,\nverbose_name='\u542b\u91cf\u503c')\n# \u5546\u54c1\u5355\u4f4d\nunit = models.CharField(max_length=255,\nverbose_name='\u542b\u91cf\u5355\u4f4d')\n</code></pre> <p>admin:</p> <pre><code>class ContentAdmin(admin.ModelAdmin):\nsearch_fields = ('goods__name', 'category__name',)\nlist_filter = ('goods__name', 'category__name',)\nlist_display = ('goods', 'category', 'value', 'unit')\nadmin.site.register(Content, ContentAdmin)\n</code></pre>"},{"location":"python/django/django-note/#queryset_3","title":"<code>queryset</code>\u95f4\u64cd\u4f5c","text":"<p>\u6709\u7236\u5206\u7c7b\u7684\u6240\u6709\u542b\u91cf \u51cf\u53bb \u8be5\u5546\u54c1\u5df2\u6709\u7684\u542b\u91cf \u4f5c\u4e3a\u5f85\u9009\u7684\u542b\u91cf\u96c6\uff1a</p> <pre><code>category_list = Category.object.filter(parent__isnull=False).exclude(pk__in=goods.category.all()).all()\n</code></pre> <p><code>queryset = queryset1 | queryset2</code></p> <p>\u6ce8\u610f\uff0c<code>|</code>\u64cd\u4f5c\u4f1a\u5bf9\u4e24\u4e2aqueryset\u95f4\u7684\u91cd\u590d\u90e8\u5206\u8fdb\u884c\u53bb\u91cd\u3002</p> <p>\u5b9e\u73b0\u539f\u7406\uff1a \u67d0\u4e00\u5929\u53d1\u73b0\u4e86\u4e00\u4e2a\u5947\u602a\u7684\u95ee\u9898\uff0c\u5982\u4e0b\uff1a \u8f93\u5165\u5982\u4e0b\uff1a </p> <p>\u4e00\u4e2a\u957f\u5ea6\u4e3a2\u7684<code>queryset</code>\u548c\u4e00\u4e2a\u957f\u5ea6\u4e3a0\u7684<code>queryset</code>\u5408\u5e76\u5f97\u5230\u4e86\u4e00\u4e2a\u957f\u5ea6\u4e3a3\u7684<code>queryset</code>,\u68c0\u7d22\u5176<code>query</code>\u8bed\u53e5\u624d\u53d1\u73b0\u8fd9\u662f\u6709\u53ef\u80fd\u7684\uff0c\u9700\u8981\u5bf9\u5f97\u5230\u7684\u7ed3\u679c\u518d\u6b21\u53bb\u91cd\u3002\u672c\u8d28\u4e0a<code>|</code>\u64cd\u4f5c\u662f\u5bf9sql\u8bed\u53e5\u8fdb\u884c<code>OR</code>,\u5176\u5b9e\u73b0\u4ee3\u7801\u5982\u4e0b\uff1a</p> <p><code>models/query.py</code>:</p> <pre><code>def __or__(self, other):\nself._merge_sanity_check(other)\nif isinstance(self, EmptyQuerySet):\nreturn other\nif isinstance(other, EmptyQuerySet):\nreturn self\ncombined = self._chain()\ncombined._merge_known_related_objects(other)\ncombined.query.combine(other.query, sql.OR)\nreturn combined\n</code></pre>"},{"location":"python/django/django-note/#queryset_4","title":"<code>queryset</code>\u76f8\u51cf","text":""},{"location":"python/django/django-note/#queryset_5","title":"<code>queryset</code>\u76f8\u52a0","text":""},{"location":"python/django/django-note/#migrations","title":"<code>migrations</code>\u6587\u4ef6\u51b2\u7a81","text":"<pre><code># \u5408\u5e76\u591a\u4e2amigrations\u6587\u4ef6\u81f3\u4e00\u4e2a\npython manage.py squashmigrations app_name 0015\n# \u6709conflicting\u65f6\u5408\u5e76\npython manage.py makemigrations \u2013merge\n</code></pre>"},{"location":"python/django/django-note/#migrate-fake","title":"<code>migrate --fake</code>","text":"<pre><code>python manage.py migrate --fake\n</code></pre>"},{"location":"python/django/django-note/#url","title":"Url\u76f8\u5173","text":"<p>\u91cd\u5b9a\u5411\u662f\u6307\u5c06\u5f53\u524d\u7684url\u53d1\u9001/\u8f6c\u8bd1\u4e3a\u5176\u5b83url\u518d\u8fdb\u884c\u5904\u7406\uff0c\u800c\u4e0d\u662f\u6307\u8fd4\u56de\u7684url\uff0c\u4e0d\u80fd\u7528\u4e8e\u9875\u9762\u5237\u65b0\u3002</p> <pre><code>url(r'author/(?P[0-9]+)/$', AuthorUpdate.as_view(), name='author-update'),\nurl(r'author/(?P\\d+)/$', AuthorUpdate.as_view(), name='author-update'),\n</code></pre>"},{"location":"python/django/django-note/#_10","title":"\u91cd\u5b9a\u5411","text":""},{"location":"python/django/django-note/#_11","title":"\u6b63\u5219","text":""},{"location":"python/django/django-note/#view","title":"View\u76f8\u5173","text":"<p><code>return render(request,template,data)</code></p> <pre><code>def get_success_url(self):\nreturn reverse('author-detail', kwargs={'pk': self.object.pk})\n</code></pre> <pre><code>class BaseMixin(View):\ndef get_context_data(self, **kwargs):\nkwargs['example'] = 'example'\nreturn super(BaseMixin, self).get_context_data(**kwargs)\nclass NewsUpdateView(BaseMixin, UpdateView): # \u6709\u7528 example\u5728\u9875\u9762\u4e2d\u53ef\u4ee5\u663e\u793a\nclass NewsUpdateView(UpdateView, BaseMixin): # \u6ca1\u7528 example\u5728\u9875\u9762\u4e2d\u4e0d\u53ef\u663e\u793a\n</code></pre> <pre><code>class NewsAllListView(ListContextMixin, ListView):\nqueryset = News.objects.language('all').in_current_lang().order_by('-id')\ntemplate_name = 'news/list_all.html'\ncontext_object_name = 'news_list'\npaginate_by = settings.PAGE_NUM\n# def get_queryset(self):\n#     return News.objects.language('all').in_current_lang().order_by('-id')\n</code></pre> <p>\u5199\u6210\u5458\u53d8\u91cfqueryset</p> <p>runserver\u65f6\u8f93\u51fa,\u8f93\u51fa\u6765\u6e90\u4e8e<code>in_current_lang()</code>,\u8be5\u65b9\u6cd5\u7528\u4e8e\u9650\u5236\u5f53\u524d\u8bed\u8a00\u73af\u5883\uff0c<code>in_current_lang</code>\u53ea\u4f1a\u5728runserver\u65f6\u88ab\u8c03\u7528\u4e00\u6b21\uff0c\u4e4b\u540e\u5c31\u7b97\u4fee\u6539\u4e86\u8bed\u8a00\u73af\u5883\uff0cqueryset\u6210\u5458\u53d8\u91cf\u4e5f\u4e0d\u4f1a\u518d\u6b21\u6839\u636e\u8bed\u8a00\u73af\u5883\u8fdb\u884c\u8c03\u6574\uff0c\u53ea\u6709\u5f53\u518d\u6b21\u91cd\u542f\u670d\u52a1\u5668\u65f6\u624d\u4f1a\u8c03\u6574\u8bed\u8a00\u73af\u5883\uff0c\u4f18\u70b9\u662f\u52a0\u8f7d\u5feb\uff0c\u4f46\u662f\u65e0\u6cd5\u5b9e\u73b0\u8bed\u8a00\u73af\u5883\u7684\u53d8\u5316\u3002</p> <pre><code>, , ]&gt;\n, ]&gt;\nSystem check identified no issues (0 silenced).\nJuly 18, 2017 - 10:38:29\nDjango version 1.11.2, using settings 'Portal.settings'\nStarting development server at http://0.0.0.0:80/\nQuit the server with CTRL-BREAK.\nPerforming system checks...\n</code></pre> <p>\u5199\u6210\u5458\u65b9\u6cd5<code>get_queryset</code>\u65f6\uff0c\u6bcf\u6b21\u90fd\u4f1a\u6839\u636e\u8bed\u8a00\u73af\u5883\u53bb\u8c03\u6574queryset\u6765\u6e90\uff0c\u7f3a\u70b9\u662f\u5f00\u9500\u6bd4\u5199\u6210\u5458\u53d8\u91cf\u5927\uff0crunserver\u540e\u8f93\u51fa\uff0c\u6bcf\u6b21\u8bf7\u6c42\u8be5<code>listview in_current_lang</code>\u90fd\u4f1a\u88ab\u8c03\u7528\uff1a</p> <pre><code>System check identified no issues (0 silenced).\nJuly 18, 2017 - 10:42:47\nDjango version 1.11.2, using settings 'Portal.settings'\nStarting development server at http://0.0.0.0:80/\nQuit the server with CTRL-BREAK.\n2017-07-18 10:42:52,375 [INFO]- \"GET /manage/ HTTP/1.1\" 200 6224\n2017-07-18 10:42:52,442 [INFO]- \"GET /manage/home/ HTTP/1.1\" 200 1412\n2017-07-18 10:42:52,788 [INFO]- \"GET /static/images/favicon.ico HTTP/1.1\" 200 1099\n, , ]&gt;\n, ]&gt;\n</code></pre>"},{"location":"python/django/django-note/#render","title":"render\u51fd\u6570","text":""},{"location":"python/django/django-note/#success_url","title":"\u52a8\u6001<code>success_url</code>","text":""},{"location":"python/django/django-note/#_12","title":"\u57fa\u7c7b\u7ee7\u627f\u4fe1\u606f\u65f6\uff0c\u57fa\u7c7b\u8981\u4f18\u5148\u7ee7\u627f\uff0c\u4e0d\u7136\u4e0d\u8d77\u4f5c\u7528","text":""},{"location":"python/django/django-note/#listviewqueryset","title":"ListView\u4e2dqueryset\u4f7f\u7528\u9677\u9631","text":""},{"location":"python/django/django-note/#form","title":"Form\u76f8\u5173","text":"<pre><code>class LoginForm(forms.Form):\nerror_messages = {\n'login_error': \"\u8d26\u6237\u540d\u6216\u5bc6\u7801\u8f93\u5165\u9519\u8bef\",\n}\nraise forms.ValidationError(self.error_messages[\"login_error\"])\n</code></pre> <pre><code>self.add_error(\"username\", \"\u8d26\u6237\u540d\u6216\u5bc6\u7801\u8f93\u5165\u9519\u8bef\") # username\u4e3a\u9519\u8bef\u53d1\u751f\u7684\u5b57\u6bb5\n</code></pre>"},{"location":"python/django/django-note/#_13","title":"\u4f7f\u7528\u9884\u8bbe\u7684\u9519\u8bef","text":""},{"location":"python/django/django-note/#_14","title":"\u52a8\u6001\u6dfb\u52a0\u9519\u8bef","text":""},{"location":"python/django/django-note/#template","title":"Template\u76f8\u5173","text":"<p>\u5728\u754c\u9762\u4e2d\u5c06\u67d0\u4e2a\u53d8\u91cf\u6e32\u67d3\u6210\u4e3ahtml\u6709\u4e24\u79cd\u65b9\u6cd5\uff1a</p> <ul> <li><code>{% autoescape off %} {{content}} {% endautoescape %}</code></li> <li> <p><code>{{content|safe}}</code></p> </li> <li> </li> </ul> <pre><code>{{ solution.title|truncatechars:20 }} # 20\u4e2a\u5b57\u7b26\u540e\u663e\u793a...\n{{ solution.create_time|date:\"Y-m-d H:i:s\" }} # datatime\u683c\u5f0f\n</code></pre> <ul> <li> </li> </ul> <pre><code>{% if perms.app_label.can_do_something %}\n{% endif %}\n</code></pre> <p><code>perms</code>\u662f\u4e00\u4e2a<code>django.contrib.auth.context_processors.PermWrapper</code>\u5bf9\u8c61\uff0c\u6587\u6863\u89c1\u6b64\u3002 \u82e5\u4f7f\u7528<code>get_template</code>\u6765\u6e32\u67d3\u9875\u9762\u65f6\u9700\u8981<code>perms</code>\u5bf9\u8c61\uff1a</p> <pre><code>from django.template.loader import get_template\nfrom django.contrib.auth.context_processors import PermWrapper\nfor article in article_list:\nhtml += get_template('article/article_item.html').render({'article': article,\n'perms': PermWrapper(request.user)})\n</code></pre> <ul> <li> </li> </ul> <pre><code>context['is_html'] = True\n{{ is_html|yesno:\"true,false\" }}\n</code></pre> <ul> <li> </li> </ul> <pre><code>kwargs['tags'] = ['1', '2']\nvar tags = {{ tags|safe }};\n</code></pre> <ul> <li> </li> <li> <p>\u751f\u6210\u672c\u9875\u7684\u7edd\u5bf9\u8def\u5f84 <code>{{ request.build_absolute_uri }}</code></p> </li> <li>\u751f\u6210\u6709<code>url name</code>\u7684<code>url</code>\u7684\u7edd\u5bf9\u8def\u5f84 <code>{% absurl 'web_news_detail' news.id %}</code></li> <li>\u751f\u6210\u9759\u6001\u6587\u4ef6\u5bf9\u5e94\u7684\u7edd\u5bf9\u8def\u5f84 <code>{{ news.cover.url|absolute_media_url:request }}</code></li> </ul> <p>\u4f7f\u7528\u7684\u6a21\u677f\u6807\u7b7e\u6587\u4ef6 \u5728\u6a21\u677f\u4e2d\u4f7f\u7528\u65f6\u52a1\u5fc5\u4f7f\u7528<code>{% load absolute_url %}</code>\u52a0\u8f7d\u6807\u7b7e <code>absolute_url.py</code>:</p> <pre><code>from django.template import Library\nfrom django.template.defaulttags import URLNode, url\nfrom urllib.parse import urlencode\nregister = Library()\nclass AbsoluteURL(str):\npass\nclass AbsoluteURLNode(URLNode):\n\"\"\"\u751f\u6210\u7edd\u5bf9\u8def\u5f84\u7684url\u6807\u7b7e\"\"\"\ndef render(self, context):\nasvar, self.asvar = self.asvar, None\npath = super(AbsoluteURLNode, self).render(context)\nrequest = context['request']\nabs_url = AbsoluteURL(request.build_absolute_uri(path))\n# \u4fdd\u6301request parameters\u4e0d\u4e22\u5931\nparameters = urlencode(request.GET, doseq=True)\nif parameters:\nabs_url = '{}?{}'.format(abs_url, parameters)\nif not asvar:\nreturn str(abs_url)\nelse:\nif path == request.path:\nabs_url.active = 'active'\nelse:\nabs_url.active = ''\ncontext[asvar] = abs_url\nreturn ''\n@register.tag\ndef absurl(parser, token):\nnode = url(parser, token)\nreturn AbsoluteURLNode(\nview_name=node.view_name,\nargs=node.args,\nkwargs=node.kwargs,\nasvar=node.asvar\n)\n@register.filter\ndef absolute_url(url, request):\n\"\"\"\n    Usage: {{ url|absolute_url:request }}\n    \"\"\"\nreturn request.build_absolute_uri(url)\n</code></pre> <ul> <li> </li> </ul> <p>filter.qs\u4e3a\u8fc7\u6ee4\u540e\u7684queryset\uff1b filter.data\u4e3a\u5f53\u524d\u8fc7\u6ee4\u53d6\u5f97\u7684\u6570\u636e\uff0c\u5982filter.data.category\u65e2\u4e3a\u5f53\u524d\u53d6\u5f97\u7684\u7c7b\u578bID\u3002</p> <ul> <li> </li> </ul> <p>\u793a\u4f8b<code>Tags</code>\u7684\u4f5c\u7528\u662f\u9ad8\u4eae\u5f53\u524d<code>Navbar</code>\u9009\u4e2d\u7684\u9009\u9879\u3002</p> <p>(1) \u65b0\u5efa<code>templatetags</code>\u6587\u4ef6\u5939\uff0c\u653e\u5165\u7a7a\u7684<code>__init__.py</code>\u6587\u4ef6\u3002</p> <p>(2) <code>app/templatetags/nav.py</code>\uff1a</p> <pre><code>from django.core.urlresolvers import resolve\nfrom django.template import Library\nregister = Library()\n@register.simple_tag\ndef active_nav(request, url):\nurl_name = resolve(request.path).url_name\nif url_name == url:\nreturn \"active\"\nreturn \"\"\n</code></pre> <p>(3) \u7528\u6cd5 <code>{% active_nav request 'pattern_name' %}</code></p>"},{"location":"python/django/django-note/#html","title":"\u6e32\u67d3\u53d8\u91cf\u81f3html","text":""},{"location":"python/django/django-note/#templet","title":"templet\u5e38\u7528\u8fc7\u6ee4\u5668","text":""},{"location":"python/django/django-note/#_15","title":"\u68c0\u6d4b\u7528\u6237\u662f\u5426\u6709\u67d0\u9879\u6743\u9650","text":""},{"location":"python/django/django-note/#booleanjs","title":"\u4f20\u9012boolean\u81f3js","text":""},{"location":"python/django/django-note/#listjs","title":"\u4f20\u9012list\u81f3js","text":""},{"location":"python/django/django-note/#_16","title":"\u7edd\u5bf9\u8def\u5f84\u751f\u6210","text":""},{"location":"python/django/django-note/#django-filter","title":"Django-filter","text":""},{"location":"python/django/django-note/#tags","title":"\u81ea\u5b9a\u4e49Tags","text":""},{"location":"python/django/django-note/#_17","title":"\u5206\u9875","text":"<p>\u4f7f\u7528paginate_by\u8bbe\u7f6e\u6bcf\u9875\u53ef\u663e\u793a\u7684\u4e2a\u6570:</p> <pre><code># Goods\u5217\u8868\nclass GoodsListView(ListView):\nqueryset = Goods.objects.all()\ncontext_object_name = 'goodsList'\npaginate_by = 2\ntemplate_name = 'goods/list.html'\n</code></pre> <p>\u4f7f\u7528page_obj\u53d8\u91cf\u6765\u663e\u793a\u5206\u9875 goods/list.html:</p> <pre><code>{ % block content %}\n&lt; !--\u5206\u9875 --&gt;\n{ % if page_obj %}\n{ % include\n\"include/pagination.html\" %}\n{ % endif %}\n{ % endblock %}\n</code></pre> <p>paginate.html:</p> <pre><code>&lt;ul class=\"pagination\"&gt;\n    {% if  page_obj.has_previous %}\n        &lt;li&gt;&lt;a href=\"?page={{page_obj.previous_page_number}}\"&gt;&amp;laquo;&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=\"?page={{page_obj.previous_page_number}}\"&gt;{{page_obj.previous_page_number}}&lt;/a&gt;&lt;/li&gt;\n    {% else %}\n         &lt;li class=\"disabled\"&gt;&lt;a href=\"#\"&gt;&amp;laquo;&lt;/a&gt;&lt;/li&gt;\n    {% endif %}\n\n&lt;li  class=\"active\"&gt;&lt;a href=\"?page={{page_obj.number}}\"&gt;{{page_obj.number}}&lt;/a&gt;&lt;/li&gt;\n    {% if  page_obj.has_next%}\n        &lt;li&gt;\n&lt;a href=\"?page={{page_obj.next_page_number}}\"&gt;{{page_obj.next_page_number}}&lt;/a&gt;\n&lt;/li&gt;\n&lt;li&gt;\n&lt;a href=\"?page={{page_obj.next_page_number}}\"&gt;&amp;raquo;&lt;/a&gt;\n&lt;/li&gt;\n    {% else %}\n        &lt;li class=\"disabled\"&gt;\n&lt;a href=\"#\"&gt;&amp;raquo;&lt;/a&gt;\n&lt;/li&gt;\n    {% endif %}\n&lt;/ul&gt;\n</code></pre> <ul> <li>page_obj.has_previous \u662f\u5426\u6709\u4e0a\u4e00\u9875</li> <li>page_obj.has_next \u662f\u5426\u6709\u4e0b\u4e00\u9875</li> <li>page_obj.previous_page_number \u4e0a\u4e00\u9875\u9875\u7801</li> <li>page_obj.next_page_number \u4e0b\u4e00\u9875\u9875\u7801</li> <li>page_obj.number \u5f53\u524d\u9875\u7801</li> <li>paginator.num_pages \u603b\u9875\u7801\u6570</li> </ul>"},{"location":"python/django/django-note/#admin","title":"Admin\u76f8\u5173","text":"<ul> <li> <p>\u5199\u5728<code>admins.py</code>\u4e2d\uff1a</p> <pre><code># \u8bd5\u542c\nclass AuditionAdmin(admin.ModelAdmin):\nlist_display = ['id', 'pre_student', 'follower', 'course', 'teacher', 'class_room',\n'state', 'feed_back_staff', 'feed_back_time']\nlist_filter = ('state', )\u3000\uff03 \u6a2a\u5411\u8fc7\u6ee4\u5668\ndef course(self, obj): \n#list_display \u5916\u952e\nreturn obj.class_schedule.course\ncourse.short_description = '\u8bfe\u7a0b'\n</code></pre> </li> <li> <p>\u5199\u5728<code>models.py</code>\u4e2d\uff1a</p> <pre><code>class User(models.Model):\n...\n# \u83b7\u53d6\u5168\u540d\ndef get_full_name(self):\nif self.name == '':\nreturn self.username\nelse:\nreturn self.name\nget_full_name.short_description = '\u5168\u540d'\nclass MyUserAdmin(UserAdmin):\nlist_display = ['id', 'username', 'get_full_name', 'tel', 'email', 'token', 'gender']\n</code></pre> </li> <li> </li> </ul> <p>\u53ef\u89c1\u4f46\u4e0d\u63a5\u4fee\u6539</p> <pre><code>readonly_fields = ('word_count',)\n</code></pre> <ul> <li> </li> </ul> <p>\u5219\u5728</p> <pre><code>model\n</code></pre> <p>\u5b57\u6bb5\u4e2d\u8bbe\u7f6e</p> <pre><code>editable=False\n</code></pre> <p>\u5373\u53ef</p> <ul> <li> </li> </ul> <pre><code>python manage.py changepassword \u4fee\u6539admin\u5bc6\u7801\npython manage.py changepassword username \u6307\u5b9a\u7528\u6237\u4fee\u6539admin\u5bc6\u7801\n</code></pre> <ul> <li> </li> </ul> <pre><code>admin.site.site_title = '\u6d4b\u8bd5'\n</code></pre> <ul> <li> </li> </ul> <p><code>apps.py</code>:</p> <pre><code>class UserConfig(AppConfig):\nname = 'user'\nverbose_name = '\u7528\u6237'\n</code></pre> <p><code>__init__.py</code>:</p> <pre><code>default_app_config = 'user.apps.UserConfig'\n</code></pre> <ul> <li> </li> </ul> <p><code>models.py</code></p> <pre><code>class Meta:\nverbose_name = _('\u7528\u6237')\nverbose_name_plural = _('\u7528\u6237') # \u590d\u6570\u65f6\u663e\u793a\u7684\u503c\n</code></pre> <ul> <li> </li> </ul> <p>\u8bbe\u7f6e</p> <pre><code>list_editable = ('user', 'is_locked')\n</code></pre> <p>\u5373\u53ef\u4e00\u6b21\u7f16\u8f91\u5217\u8868\u4e0a\u591a\u884c\u6570\u636e\u5bf9\u5e94\u7684\u67d0\u4e9b\u5b57\u6bb5\uff0c\u4f46\u662f\u8981\u6c42\u8fd9\u4e9b\u5b57\u6bb5\u90fd\u5728</p> <pre><code>list_display\n</code></pre> <p>\u4e2d\u3002</p>"},{"location":"python/django/django-note/#list","title":"\u65b9\u6cd5\u7ed3\u679c\u663e\u793a\u5728list\u4e2d","text":""},{"location":"python/django/django-note/#_18","title":"\u8bbe\u7f6e\u5b57\u6bb5\u53ea\u8bfb","text":""},{"location":"python/django/django-note/#admin_1","title":"\u8bbe\u7f6e\u5b57\u6bb5\u4e0d\u51fa\u73b0\u5728admin\u4e2d","text":""},{"location":"python/django/django-note/#superuser","title":"\u4fee\u6539SuperUser\u5bc6\u7801","text":""},{"location":"python/django/django-note/#admintitle","title":"\u8bbe\u7f6e\u7ad9\u70b9admin\u663e\u793atitle","text":""},{"location":"python/django/django-note/#appverbose_name","title":"\u8bbe\u7f6eapp\u7684<code>verbose_name</code>","text":""},{"location":"python/django/django-note/#modelverbose_name","title":"\u8bbe\u7f6emodel\u7684verbose_name","text":""},{"location":"python/django/django-note/#_19","title":"\u8bbe\u7f6e\u5217\u8868\u53ef\u7f16\u8f91\u5b57\u6bb5","text":""},{"location":"python/django/django-note/#utils","title":"Utils\u76f8\u5173","text":"<ul> <li> <p>'\u6570\u5b57\uff1a%d \u5b57\u7b26\u4e32 %s'%(instance.pk,instance.name)</p> </li> <li>\u5355\u4e2a\u53d8\u91cf\u65f6\u540e\u9762\u53ef\u4e0d\u7528\u62ec\u53f7\uff0c\u5982\uff1a'\u5b57\u7b26\u4e32:%s'%instance.name</li> <li>'{}{}'.format(str1, str2) \u4f18\u4e8e\u4f7f\u7528%</li> <li> <p>'{one}{two}'.format(one=str1, two=str2)</p> </li> <li> </li> </ul> <p>Django\u7684message\u6846\u67b6\u53ef\u4ee5\u7528\u6765\u4f20\u9012\u9875\u9762\u4e4b\u95f4\u7684\u6d88\u606f</p> <ul> <li> </li> </ul> <pre><code>&gt;&gt;&gt; a = \"03523\" # \u5224\u65ad\u5b57\u7b26\u4e32\u662f\u5426\u662f\u6570\u5b57\n&gt;&gt;&gt; a.isdigit()\nTrue\n&gt;&gt;&gt; b = \"963spam\"\n&gt;&gt;&gt; b.isdigit()\nFalse\n</code></pre> <p>\u5c01\u88c5\u540e\uff1a</p> <pre><code>def isdigit(string):\n\"\"\"\n    :param string:\n    :return: \u8be5\u5b57\u7b26\u662f\u5426\u662f\u6570\u5b57\n    \"\"\"\nif isinstance(string, int):\nreturn True\nelse:\nreturn isinstance(string, str) and string.isdigit()\n</code></pre> <ul> <li> </li> </ul> <pre><code>from django.apps import apps\nmodel = next((m for m in apps.get_models() if m._meta.db_table == 'family_smstemplate'), None)\nprint(model)\n</code></pre> <ul> <li> </li> </ul> <p>\u907f\u514d\u5199\u591a\u884c\uff0c\u66f4\u7b80\u6d01\u3002</p> <p><code>subject, from_email, to = 'hello', settings.EMAIL_HOST_USER, '614457662@qq.com'</code></p> <ul> <li> </li> </ul> <pre><code>class Foo(object):  \npass  \nclass Bar(Foo):  \npass  \nprint type(Foo()) == Foo  True\nprint type(Bar()) == Foo  False\nprint isinstance(Bar(),Foo) True\n</code></pre> <p><code>type</code>\u4e0d\u4f1a\u8ba4\u4e3a\u5b50\u7c7b\u662f\u4e00\u79cd\u7236\u7c7b\u7c7b\u578b\uff0c<code>isinstance</code>\u4f1a\u8ba4\u4e3a\u5b50\u7c7b\u662f\u4e00\u79cd\u7236\u7c7b\u7c7b\u578b\u3002</p>"},{"location":"python/django/django-note/#_20","title":"\u5b57\u7b26\u62fc\u63a5","text":""},{"location":"python/django/django-note/#_21","title":"\u9875\u9762\u95f4\u6d88\u606f\u4f20\u9012","text":""},{"location":"python/django/django-note/#str","title":"\u5224\u65adstr\u662f\u5426\u4e3a\u6570\u5b57","text":""},{"location":"python/django/django-note/#model_1","title":"\u7531\u6570\u636e\u5e93\u8868\u540d\u79f0\u83b7\u53d6\u5bf9\u5e94\u7684model","text":""},{"location":"python/django/django-note/#_22","title":"\u5b57\u7b26\u4e32\u8fde\u7eed\u5b9a\u4e49","text":""},{"location":"python/django/django-note/#python","title":"Python\u7c7b\u578b\u5224\u65ad","text":""},{"location":"python/django/django-note/#_23","title":"\u4fe1\u53f7","text":"<pre><code>from django.core.signals import request_finished\nfrom django.dispatch import receiver\n@receiver(request_finished)\ndef my_callback(sender, **kwargs):\nprint(\"Request finished!\")\nfrom django.dispatch import Signal\nrequest_started = Signal(providing_args=[\"environ\"])\nrequest_finished = Signal()\ngot_request_exception = Signal(providing_args=[\"request\"])\nsetting_changed = Signal(providing_args=[\"setting\", \"value\", \"enter\"])\n</code></pre> <pre><code>from django.dispatch import receiver\npost_viewed = django.dispatch.Signal(providing_args=[\"post\", \"request\"])\n@receiver(post_viewed)\ndef handle_post_viewed(sender, **kwargs):\nprint('------------------')\n# \u7528\u6237\nclass UserViewSet(ModelViewSet):\nqueryset = UserMessage.objects.all()\nserializer_class = UserSerializer\n@list_route(methods=['GET'])\ndef sender(self, request):# \u53d1\u51fa\u4fe1\u53f7\npost_viewed.send(sender=self.__class__)\nreturn Response('sender')\n@list_route(methods=['GET'])# \u4e0d\u53d1\u51fa\u4fe1\u53f7\ndef receiver(self, request):\nreturn Response('')\n</code></pre> <p>it's used before the transaction saves.</p> <p>it's used after the transaction saves.</p> <pre><code>from django.dispatch import receiver\nfrom django.db.models.signals import post_save\n@receiver(post_save, sender=settings.AUTH_USER_MODEL)\ndef user_create(sender, instance=None, created=False, **kwargs):\nif created:\nmember = Member.objects.create(user=instance)\nfamily = Family.objects.create()\nfamily.members.add(member)\n</code></pre> <p>\u65b0\u5efa<code>signals.py</code>\u6587\u4ef6\u5199\u4fe1\u53f7\u76f8\u5173\u7684\u4ee3\u7801\u65f6\uff0c\u9700\u8981\u5728<code>apps.py</code>\u4e2d\u65b0\u589e<code>ready</code>\u51fd\u6570</p> <pre><code>class UserConfig(AppConfig):\nname = 'user'\nverbose_name = '\u7528\u6237'\ndef ready(self):\nimport user.signals\n</code></pre> <p>\u4e0d\u7136\u4f1a\u5bfc\u81f4<code>signals.py</code>\u4e2d\u7684\u4ee3\u7801\u65e0\u6cd5\u751f\u6548\u3002\u800c\u4e14\u5fc5\u987b\u8981\u7528<code>import user.signals</code>\u5bfc\u5165\u800c\u4e0d\u53ef\u7528<code>from .signals import *</code>\u5bfc\u5165,\u4e0d\u7136\u4f1a\u63d0\u793a<code>SyntaxError: import * only allowed at module level</code>\u9519\u8bef\u3002</p>"},{"location":"python/django/django-note/#request_finished","title":"request_finished","text":""},{"location":"python/django/django-note/#_24","title":"\u81ea\u5b9a\u4e49\u4fe1\u53f7","text":""},{"location":"python/django/django-note/#pre_save","title":"pre_save","text":""},{"location":"python/django/django-note/#post_save","title":"post_save","text":""},{"location":"python/django/django-note/#_25","title":"\u4fe1\u53f7\u4e0d\u89e6\u53d1\u95ee\u9898","text":""},{"location":"python/django/django-note/#_26","title":"\u6d4b\u8bd5","text":"<p>\u65e2\u5728\u5199\u529f\u80fd\u4ee3\u7801\u524d\uff0c\u4f18\u5148\u5199\u6d4b\u8bd5\u4ee3\u7801\uff0c\u867d\u7136\u4e0e\u76f4\u89c9\u76f8\u6096\uff0c\u4f46\u662f\u8fd9\u4e0e\u4e00\u822c\u4eba\u505a\u4e8b\u7684\u987a\u5e8f\u76f8\u540c\uff0c\u5148\u53d1\u73b0\u95ee\u9898\uff0c\u518d\u5199\u4ee3\u7801\u53bb\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u53ea\u662f<code>\u6d4b\u8bd5\u9a71\u52a8\u5f00\u53d1</code>\u628a\u8fd9\u4e2a\u8fc7\u7a0b\u5f62\u5f0f\u5316\u4e86\u3002</p> <p>basic-testing-strategies</p> <p>\u51fd\u6570\u5fc5\u987b\u4ee5\u5c0f\u5199\u7684test\u5f00\u5934\uff0c\u5404\u4e2a\u6d4b\u8bd5\u4e4b\u95f4\u8981\u72ec\u7acb\uff0c\u8c03\u7528\u7684\u987a\u5e8f\u4e3a\u51fd\u6570\u540d\u7684\u5b57\u6bcd\u987a\u5e8f\uff0c\u6bcf\u4e2a\u6d4b\u8bd5\u51fd\u6570\u6d4b\u8bd5\u5b8c\u6210\u540e\u6570\u636e\u5e93\u5c06\u81ea\u52a8\u56de\u6eda\u81f3\u521d\u59cb\u72b6\u6001\u3002</p> <p>\u9f20\u6807\u6307\u9488\u4f4d\u4e8e\u6d4b\u8bd5\u6848\u4f8b\u7684\u67d0\u4e2a\u51fd\u6570\u7684\u4f5c\u7528\u57df\u5185\u5c06\u53ea\u6267\u884c\u8fd9\u4e2a\u51fd\u6570\uff0c\u4f4d\u4e8e\u6d4b\u8bd5\u6848\u4f8b\u7684\u4f5c\u7528\u57df\u5185\u5c06\u6267\u884c\u6574\u4e2a\u6d4b\u8bd5\u6848\u4f8b\u3002</p> <pre><code>import pdb\npdb.set_trace()\n</code></pre> <p>\u4e4b\u540e\u5728\u63a7\u5236\u53f0\u5c06\u770b\u5230<code>\uff08Pdb\uff09:</code>\uff0c\u53ef\u4ee5\u8f93\u5165Python\u8bed\u53e5\u8fdb\u884c\u4ea4\u4e92\u68c0\u67e5\u3002</p>"},{"location":"python/django/django-note/#_27","title":"\u6d4b\u8bd5\u9a71\u52a8\u5f00\u53d1","text":""},{"location":"python/django/django-note/#_28","title":"\u6d4b\u8bd5\u51fd\u6570","text":""},{"location":"python/django/django-note/#pycharm","title":"Pycharm\u4e2d\u8fd0\u884c\u6d4b\u8bd5\u7684\u6ce8\u610f\u4e8b\u9879","text":""},{"location":"python/django/django-note/#_29","title":"\u8bbe\u7f6e\u65ad\u70b9","text":""},{"location":"python/django/django-note/#_30","title":"\u7b2c\u4e09\u65b9\u5de5\u5177\u53ca\u4f5c\u7528\u7b80\u4ecb","text":"<p>\u5f02\u6b65\u53d1\u9001\u90ae\u4ef6\u3001\u5904\u7406\u4efb\u52a1\u4f7f\u7528\u5e93</p>"},{"location":"python/django/django-note/#django-celery","title":"django-celery","text":""},{"location":"python/django/django-note/#_31","title":"\u5176\u4ed6","text":"<p>\u53cc\u4e0b\u5212\u7ebf\uff08double undersocres\uff09\u7528\u6237\u5b9a\u4e49\u7c7b\u7684\u5185\u90e8\u5c5e\u6027 \u7528\u4e8e\u5b9a\u4e49\u53ea\u53ef\u5728\u7c7b\u7684\u5185\u90e8\u4f7f\u7528\u7684\u53c2\u6570\u548c\u65b9\u6cd5</p> <pre><code> # __\u4fdd\u8bc1\u8be5\u51fd\u6570\u4e0d\u53ef\u88ab\u5916\u90e8\u8c03\u7528\ndef __send_sms(self, tel, content):\n</code></pre> <p><code>state = True if day == date else False</code></p> <p>\u7b49\u4ef7\u4e8e\uff1a</p> <pre><code>if day == date:\nstate = True\nelse:\nstate = False\n</code></pre> <p>\u4f7f\u7528requests\u5e93\u76f4\u63a5\u5411Django\u53d1\u8d77\u8bf7\u6c42\u65f6\uff0c\u670d\u52a1\u5668\u63a5\u6536\u5230\u7684request.data\u7c7b\u578b\u662fDict\u4e0d\u662fQueryDict\uff0c\u4f1a\u5bfc\u81f4request.data\u7684getlist\u65b9\u6cd5\u65e0\u6cd5\u4f7f\u7528\u3002\u89e3\u51b3\u65b9\u6cd5\uff1a</p> <ol> <li> <p>\u76f4\u63a5\u5224\u65ad\u7c7b\u578b dict\u7c7b\u578b\u65f6\u4f7f\u7528dict['name']\uff0cQueryDict\u7c7b\u578b\u65f6\u4f7f\u7528querydict.getlist('name')\uff0c PS:dict['name']\u7b49\u4ef7\u4e8equerydict.getlist('name')</p> </li> <li> <p>\u8fdb\u884c\u7c7b\u578b\u8f6c\u6362 Django1.11\u5982\u4e0b\uff1a</p> <p>from django.http import QueryDict from django.utils.datastructures import MultiValueDict</p> <p>data = QueryDict('', mutable=True) data.update(MultiValueDict(request.data)) print(data.getlist('id')) def dicttoquery_dict(dict): \"\"\" requests\u5e93\u8bf7\u6c42\u65f6request.data\u4e3adict \u9700\u8981\u8f6c\u6362\u4e3aquerydict\u624d\u80fd\u4f7f\u7528getlist\u65b9\u6cd5 :param dict: dict :return: query*dict \"\"\" query*dict = QueryDict('', mutable=True) querydict.update(MultiValueDict(dict)) return querydict</p> <p>data = dicttoquery_dict(request.data) if isinstance(request.data, dict) else request.data items = data.getlist('items')</p> </li> </ol> <p><code>MultiValueDict</code>\u4ecb\u7ecd\u5982\u4e0b\uff1a</p> <pre><code>class MultiValueDict(dict):\n\"\"\"\n    A subclass of dictionary customized to handle multiple values for the\n    same key.\n    &gt;&gt;&gt; d = MultiValueDict({'name': ['Adrian', 'Simon'], 'position': ['Developer']})\n    &gt;&gt;&gt; d['name']\n    'Simon'\n    &gt;&gt;&gt; d.getlist('name')\n    ['Adrian', 'Simon']\n    &gt;&gt;&gt; d.getlist('doesnotexist')\n    []\n    &gt;&gt;&gt; d.getlist('doesnotexist', ['Adrian', 'Simon'])\n    ['Adrian', 'Simon']\n    &gt;&gt;&gt; d.get('lastname', 'nonexistent')\n    'nonexistent'\n    &gt;&gt;&gt; d.setlist('lastname', ['Holovaty', 'Willison'])\n    This class exists to solve the irritating problem raised by cgi.parse_qs,\n    which returns a list for every key, even though most Web forms submit\n    single name-value pairs.\n    \"\"\"\n</code></pre> <p>requets\u53d1\u8d77\u8bf7\u6c42\uff1a</p> <pre><code>import requests\ndata = {'id': [7, 8], 'ss': 'sss'}\nprint(type(data))\nprint(data)\nr = requests.post(url='http://192.168.1.108/purchase_courses/test/', json=data,\nheaders={'Authorization': 'Token 75xxxxxxxxxxxxxxxxxxxxxfb4'})\nprint(r.text)\n</code></pre>"},{"location":"python/django/django-note/#_32","title":"\u5b9a\u4e49\u7c7b\u5185\u90e8\u65b9\u6cd5","text":""},{"location":"python/django/django-note/#_33","title":"\u4e09\u76ee\u8fd0\u7b97\u7cbe\u7b80\u4ee3\u7801","text":""},{"location":"python/django/django-note/#requestdatadictquerydict","title":"request.data\u7c7b\u578b\u662fDict\u4e0d\u662fQueryDict","text":""},{"location":"python/django/django-note/#sql","title":"\u539f\u751fsql\u9632\u6ce8\u5165","text":"<pre><code>c=db.cursor()\nmax_price=5\nc.execute(\"\"\"SELECT spam, eggs, sausage FROM breakfast\n          WHERE price &lt; %s\"\"\", (max_price,))\n</code></pre> <p>\u800c\u4e0d\u662f</p> <pre><code>c.execute(\"\"\"SELECT spam, eggs, sausage FROM breakfast\n          WHERE price &lt; %s\"\"\" % (max_price,))\n</code></pre> <p>Python best practice and securest to connect to MySQL and execute queries</p>"},{"location":"python/django/django-orm/","title":"Django-orm","text":"<ul> <li>__exact \u7cbe\u786e\u7b49\u4e8e</li> <li>__iexact \u7cbe\u786e\u7b49\u4e8e \u5ffd\u7565\u5927\u5c0f\u5199 </li> <li>__contains \u5305\u542b</li> <li>__icontains \u5305\u542b \u5ffd\u7565\u5927\u5c0f\u5199</li> <li>__gt \u5927\u4e8e</li> <li>__gte \u5927\u4e8e\u7b49\u4e8e</li> <li>__lt \u5c0f\u4e8e</li> <li>__lte \u5c0f\u4e8e\u7b49\u4e8e</li> <li>__in \u5b58\u5728\u4e8e\u67d0\u4e2alist\u4e2d</li> <li>__startswith \u4ee5...\u5f00\u5934</li> <li>__istartswith \u4ee5...\u5f00\u5934 \u5ffd\u7565\u5927\u5c0f\u5199</li> <li>__endswith \u4ee5...\u7ed3\u5c3e \u5ffd\u7565\u5927\u5c0f\u5199</li> <li>__iendwith \u4ee5...\u7ed3\u5c3e \u5ffd\u7565\u5927\u5c0f\u5199</li> <li>__range \u5728...\u8303\u56f4\u5185</li> <li>__year \u65e5\u671f\u5b57\u6bb5\u7684\u5e74\u4efd</li> <li>__month \u65e5\u671f\u5b57\u6bb5\u7684\u6708\u4efd</li> <li>__day \u65e5\u671f\u5b57\u6bb5\u7684\u65e5\u671f</li> <li>__isnull \u5916\u952e\u662f\u5426\u6709\u503c</li> <li>filter \u7b5b\u9009</li> <li>exists \u662f\u5426\u5b58\u5728</li> <li>exclude \u53cd\u9009</li> <li>distinct \u53bb\u91cd</li> <li>relation-&gt;from_member-&gt;user \u7531relation\u7684queryset\u6620\u5c04\u5230user\u7684queryset</li> <li><code>users = User.objects.filter(pk__in=[relation.from_member.user.pk for relation in relations])</code></li> </ul>"},{"location":"python/django/django-oss/","title":"\u5728Django\u4e2d\u4f7f\u7528OSS","text":""},{"location":"python/django/django-oss/#_1","title":"\u5b89\u88c5","text":"<pre><code>pip install oss2==2.5.0\n</code></pre>"},{"location":"python/django/django-oss/#storage","title":"storage","text":"<p>\u7531\u4e8e\u5b98\u65b9\u7684<code>django-oss-storage</code>\u5e93\u6700\u65b0\u7684<code>v1.11</code>\u7248\u672c\u4f9d\u65e7\u6709<code>url</code>\u65e0\u5904\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4\u7684bug\uff0c\u5e76\u4e14\u4e00\u76f4\u4e0d\u63a5\u53d7PR,\u5bf9\u5176\u6e90\u7801\u8fdb\u884c\u62bd\u53d6\u5e76\u4fee\u6539\u5f97\u5230<code>storage.py</code>\u6587\u4ef6\u5982\u4e0b\uff1a</p> <pre><code>import os\nimport six\nimport shutil\nfrom urllib.parse import urljoin\nfrom datetime import datetime\nfrom tempfile import SpooledTemporaryFile\nfrom django.core.files import File\nfrom django.core.exceptions import ImproperlyConfigured, SuspiciousOperation\nfrom django.core.files.storage import Storage\nfrom django.conf import settings\nfrom django.utils.encoding import force_text\nfrom django.utils.deconstruct import deconstructible\nfrom django.utils.timezone import utc\nimport oss2.utils\nimport oss2.exceptions\nfrom oss2 import Auth, Service, Bucket, ObjectIterator\ndef _get_config(name):\nconfig = os.environ.get(name, getattr(settings, name, None))\nif config is not None:\nif isinstance(config, six.string_types):\nreturn config.strip()\nelse:\nreturn config\nelse:\nraise ImproperlyConfigured(\"'%s not found in env variables or setting.py\" % name)\ndef _normalize_endpoint(endpoint):\nif not endpoint.startswith('http://') and not endpoint.startswith('https://'):\nreturn 'https://' + endpoint\nelse:\nreturn endpoint\nclass OssError(Exception):\ndef __init__(self, value):\nself.value = value\ndef __str__(self):\nreturn repr(self.value)\n@deconstructible\nclass OssStorage(Storage):\n\"\"\"\n    Aliyun OSS Storage\n    \"\"\"\ndef __init__(self, access_key_id=None, access_key_secret=None, end_point=None, bucket_name=None):\nself.access_key_id = access_key_id if access_key_id else _get_config('OSS_ACCESS_KEY_ID')\nself.access_key_secret = access_key_secret if access_key_secret else _get_config('OSS_ACCESS_KEY_SECRET')\nself.end_point = _normalize_endpoint(end_point if end_point else _get_config('OSS_ENDPOINT'))\nself.bucket_name = bucket_name if bucket_name else _get_config('OSS_BUCKET_NAME')\nself.auth = Auth(self.access_key_id, self.access_key_secret)\nself.service = Service(self.auth, self.end_point)\nself.bucket = Bucket(self.auth, self.end_point, self.bucket_name)\n# try to get bucket acl to check bucket exist or not\ntry:\nself.bucket.get_bucket_acl().acl\nexcept oss2.exceptions.NoSuchBucket:\nraise SuspiciousOperation(\"Bucket '%s' does not exist.\" % self.bucket_name)\ndef _get_key_name(self, name):\n\"\"\"\n        Get the object key name in OSS, e.g.,\n        location: /media/\n        input   : test.txt\n        output  : media/test.txt\n        \"\"\"\nbase_path = force_text(self.location)\nfinal_path = urljoin(base_path + \"/\", name)\nname = os.path.normpath(final_path.lstrip('/'))\nif six.PY2:\nname = name.encode('utf-8')\nreturn name\ndef _open(self, name, mode='rb'):\nif mode != \"rb\":\nraise ValueError(\"OSS files can only be opened in read-only mode\")\ntarget_name = self._get_key_name(name)\ntry:\n# Load the key into a temporary file\ntmpf = SpooledTemporaryFile(max_size=10 * 1024 * 1024)  # 10MB\nobj = self.bucket.get_object(target_name)\nif obj.content_length is None:\nshutil.copyfileobj(obj, tmpf)\nelse:\noss2.utils.copyfileobj_and_verify(obj, tmpf, obj.content_length, request_id=obj.request_id)\ntmpf.seek(0)\nreturn OssFile(tmpf, target_name, self)\nexcept oss2.exceptions.NoSuchKey:\nraise OssError(\"%s does not exist\" % name)\nexcept:\nraise OssError(\"Failed to open %s\" % name)\ndef _save(self, name, content):\ntarget_name = self._get_key_name(name)\nself.bucket.put_object(target_name, content)\nreturn os.path.normpath(name)\ndef create_dir(self, dirname):\ntarget_name = self._get_key_name(dirname)\nif not target_name.endswith('/'):\ntarget_name += '/'\nself.bucket.put_object(target_name, '')\ndef exists(self, name):\ntarget_name = self._get_key_name(name)\nif name.endswith(\"/\"):\n# This looks like a directory, but OSS has no concept of directories\n# need to check whether the key starts with this prefix\nresult = self.bucket.list_objects(prefix=target_name, delimiter='', marker='', max_keys=1)\nreturn bool(result.object_list)\nexist = self.bucket.object_exists(target_name)\nif not exist:\n# It's not a file, but it might be a directory. Check again that it's not a directory.\nname2 = name + \"/\"\nreturn self.exists(name2)\nreturn exist\ndef get_file_meta(self, name):\nname = self._get_key_name(name)\nreturn self.bucket.get_object_meta(name)\ndef size(self, name):\nfile_meta = self.get_file_meta(name)\nreturn file_meta.content_length\ndef modified_time(self, name):\nfile_meta = self.get_file_meta(name)\nreturn datetime.fromtimestamp(file_meta.last_modified)\ncreated_time = accessed_time = modified_time\ndef get_modified_time(self, name):\nfile_meta = self.get_file_meta(name)\nif settings.USE_TZ:\nreturn datetime.utcfromtimestamp(file_meta.last_modified).replace(tzinfo=utc)\nelse:\nreturn datetime.fromtimestamp(file_meta.last_modified)\nget_created_time = get_accessed_time = get_modified_time\ndef content_type(self, name):\nname = self._get_key_name(name)\nfile_info = self.bucket.head_object(name)\nreturn file_info.content_type\ndef listdir(self, name):\nif name == \".\":\nname = \"\"\nname = self._get_key_name(name)\nif not name.endswith('/'):\nname += \"/\"\nfiles = []\ndirs = []\nfor obj in ObjectIterator(self.bucket, prefix=name, delimiter='/'):\nif obj.is_prefix():\ndirs.append(obj.key)\nelse:\nfiles.append(obj.key)\nreturn dirs, files\ndef url(self, name):\nkey = self._get_key_name(name)\nreturn self.bucket.sign_url('GET', key, settings.OSS_EXPIRE)\ndef delete(self, name):\nname = self._get_key_name(name)\nresult = self.bucket.delete_object(name)\ndef delete_with_slash(self, dirname):\nname = self._get_key_name(dirname)\nif not name.endswith('/'):\nname += '/'\nresult = self.bucket.delete_object(name)\nclass OssMediaStorage(OssStorage):\ndef __init__(self):\nself.location = settings.MEDIA_URL\nsuper(OssMediaStorage, self).__init__()\ndef save(self, name, content, max_length=None):\nreturn super(OssMediaStorage, self)._save(name, content)\nclass OssStaticStorage(OssStorage):\ndef __init__(self):\nself.location = settings.STATIC_URL\nsuper(OssStaticStorage, self).__init__()\ndef save(self, name, content, max_length=None):\nreturn super(OssStaticStorage, self)._save(name, content)\nclass OssFile(File):\n\"\"\"\n    A file returned from AliCloud OSS\n    \"\"\"\ndef __init__(self, content, name, storage):\nsuper(OssFile, self).__init__(content, name)\nself._storage = storage\ndef open(self, mode=\"rb\"):\nif self.closed:\nself.file = self._storage.open(self.name, mode).file\nreturn super(OssFile, self).open(mode)\n</code></pre> <p>\u9700\u8981\u7279\u522b\u6ce8\u610f\u7684\u662f\uff0c\u5f53\u4f60\u7684<code>Bucket</code>\u7684<code>ACL</code>\u7c7b\u578b\u4e3a\u79c1\u6709\u7684\u65f6\u5019\uff0c\u5728<code>storage.py</code>\u7684<code>line 179</code>\u7684<code>url</code>\u65b9\u6cd5\u5e94\u4e3a\uff1a</p> <pre><code>def url(self, name):\nkey = self._get_key_name(name)\nreturn self.bucket.sign_url('GET', key, settings.OSS_EXPIRE)\n</code></pre> <p>\u5f53ACL\u7c7b\u578b\u4e3a\u79c1\u6709\u516c\u5f00\u8bfb\u3001\u516c\u5f00\u8bfb\u5199\u65f6\uff0c\u53ef\u4fee\u6539\u4e3a\uff1a</p> <pre><code>def url(self, name):\nkey = self._get_key_name(name)\nreturn self.bucket._make_url(self.bucket_name, key)\n</code></pre> <p>\u533a\u522b\u662f\u662f\u5426\u5bf9\u94fe\u63a5\u8fdb\u884c\u7b7e\u540d\uff0c\u4ee5\u6388\u6743\u524d\u7aef\u83b7\u53d6\u5230\u8be5\u6587\u4ef6\u3002</p>"},{"location":"python/django/django-oss/#settingspy","title":"settings.py","text":"<pre><code># OSS\u914d\u7f6e\nOSS_ACCESS_KEY_ID = \"\"\nOSS_ACCESS_KEY_SECRET = \"\"\nOSS_ENDPOINT = \"oss-cn-hangzhou.aliyuncs.com\"\nOSS_BUCKET_NAME = \"demo\"\n# OSS_EXPIRE = 3600  # \u79c1\u6709\u94fe\u63a5\u8d85\u65f6\u65f6\u95f4 \u5355\u4f4d\u79d2\nUSE_OSS = not DEBUG\nif USE_OSS:\nDEFAULT_FILE_STORAGE = 'common.storage.OssMediaStorage'\n</code></pre> <p>\u5728\u8fd9\u91cc\u8bbe\u7f6e<code>USE_OSS</code>\u5224\u65ad\u662f\u4e3a\u4e86\u5c06\u7ebf\u4e0b\u6d4b\u8bd5\u73af\u5883\u7684<code>media</code>\u6570\u636e\u4e0e\u7ebf\u4e0a\u751f\u4ea7\u73af\u5883\u7684<code>media</code>\u6570\u636e\u9694\u79bb\u5f00\u6765\uff0c\u4e0d\u9700\u8981\u9694\u79bb\u5219\u76f4\u63a5\u5220\u9664<code>USE_OSS</code>\u5224\u65ad\u5373\u53ef\u3002</p>"},{"location":"python/django/django-oss/#_2","title":"\u56fe\u7247\u5904\u7406\uff08\u7f29\u7565\u56fe\uff09","text":"<p>\u963f\u91cc\u4e91\u63d0\u4f9b\u4e862\u79cd<code>oss</code>\u7f29\u7565\u56fe\u751f\u6210\u7b56\u7565</p> <p>\u4e00\u79cd\u662f\u9884\u8bbe\u5904\u7406\u89c4\u5219\uff0c\u4e4b\u540e\u901a\u8fc7\u89c4\u5219\u540d\u79f0\u53bb\u8c03\u7528\u5904\u7406\u89c4\u5219\uff0c\u5904\u7406\u89c4\u5219\u53ef\u4ee5\u5728\u963f\u91cc\u4e91\u7684OSS\u63a7\u5236\u53f0\u4e2d\u7684\u56fe\u7247\u5904\u7406\u9009\u9879\u4e2d\u7ba1\u7406\u3002\u9ed8\u8ba4\u7684\u8c03\u7528\u89c4\u5219\u4e3a<code>\u57df\u540d/sample.jpg?x-oss-process=style/stylename</code>\u3002</p> <p>\u53e6\u5916\u4e00\u79cd\u662f\u901a\u8fc7url\u53c2\u6570\u6765\u63a7\u5236\u56fe\u7247\u7684\u7f29\u653e\u3001\u88c1\u526a\u548c\u6c34\u5370\u7b49\uff0c\u8fd9\u79cd\u65b9\u6cd5\u4f1a\u66f4\u52a0\u7684\u7075\u6d3b\uff0c\u4f46\u76f8\u5e94\u7684url\u5c06\u53d8\u5f97\u4e0d\u518d\u7b80\u4ecb\u7f8e\u89c2\u3002\u8be6\u60c5\u7684\u4f7f\u7528\u65b9\u6cd5\u53ef\u89c1\u963f\u91cc\u4e91OSS\u6587\u6863\u4e2d\u7684\u56fe\u7247\u5904\u7406\u6307\u5357\u90e8\u5206\u3002</p>"},{"location":"python/django/django-permissions/","title":"Django\u6743\u9650\u673a\u5236","text":""},{"location":"python/django/django-permissions/#model-permissions","title":"Model Permissions","text":"<p>\u200b    Django\u539f\u751f\u6743\u9650\u673a\u5236\u57fa\u4e8eModel\ufeff\u5b9e\u73b0\uff0c\u5bf9\u4e8e\u6bcf\u4e2aModel\u800c\u8a00\uff0c\u7cfb\u7edf\u5c06\u81ea\u52a8\u6dfb\u52a0add\u3001change\u548cdelete\u8fd9\u4e09\u4e2a\u6743\u9650\u3002</p> <p>\u81ea\u5b9a\u4e49\u7684\u6743\u9650\u9700\u8981\u5728model\u4e2d\u624b\u52a8\u6dfb\u52a0\uff1a</p> <pre><code>class Token(models.Model):\nclass Meta:\npermissions = (\n(\"view_token\", \"Can see token\"),\n)\n</code></pre> <p>\u6bcf\u4e2a\u6743\u9650\u5305\u542b</p> <ul> <li>content_type  \u5bf9\u5e94\u8be5\u6743\u9650\u4f5c\u7528\u7684\u6a21\u578b\uff0c\u65e2Token\u3002</li> <li>code_name  \u5bf9\u5e94\u8be5\u6743\u9650\u529f\u80fd\uff0c\u65e2view_token\uff0c\u5728\u68c0\u67e5\u6743\u9650\u65f6\u4f1a\u4f7f\u7528\u3002</li> <li>name  \u5bf9\u5e94\u8be5\u6743\u9650\u529f\u80fd\u7684\u63cf\u8ff0\uff0c\u65e2Can see token\u3002</li> </ul> <p>\u81ea\u5b9a\u4e49\u6743\u9650\u4f7f\u7528\u4ee3\u7801\u65b0\u5efa\uff1a</p> <pre><code>from django.contrib.auth.models import Permission\nfrom django.contrib.contenttypes.models import ContentType\ncontent_type = ContentType.objects.get_for_model(Token)\npermission = Permission.objects.create(codename='view_token',\nname='Can see token',\ncontent_type=content_type)\n</code></pre> <pre><code>print(request.user.has_perm('user.add_token'))  # \u68c0\u67e5\u7528\u6237\u662f\u5426\u62e5\u6709\u67d0\u9879\u6743\u9650 has_perm\uff08app_name.permission_codename\uff09\npermission = Permission.objects.get(codename='add_token')  # \u83b7\u53d6\u6743\u9650\u5b9e\u4f8b\nrequest.user.user_permissions.add(permission)  # \u4e3a\u7528\u6237\u65b0\u589e\u6743\u9650\nprint(request.user.get_all_permissions())  # \u67e5\u770b\u7528\u6237\u5168\u90e8\u6743\u9650\n# \u7531\u4e8e\u6743\u9650\u7f13\u5b58\u673a\u5236 \u7528\u6237\u7684\u6743\u9650\u5728\u7b2c\u4e00\u6b21\u83b7\u53d6\u7528\u6237\u5b9e\u4f8b\u65f6\u4f1a\u88ab\u7f13\u5b58\u4e0b\u6765\n# \u4e3a\u7528\u6237\u589e\u52a0\u4e86\u6743\u9650\u540e\u4e0d\u4f1a\u7acb\u5373\u66f4\u65b0 \u82e5\u60f3\u7acb\u5373\u67e5\u8be2\u7528\u6237\u7684\u65b0\u7684\u6743\u9650\u72b6\u6001\n# \u9700\u8981\u91cd\u65b0\u83b7\u53d6\u7528\u6237\u5b9e\u4f8b \u8be6\u89c1\uff1adjangoproject-permission-caching\nuser = User.objects.get(pk=request.user.id)\nprint(user.has_perm('user.add_token'))  # \u7acb\u5373\u68c0\u67e5\u65b0\u6743\u9650\u6dfb\u52a0\u72b6\u6001\nuser.user_permissions.remove(permission)  # \u4e3a\u7528\u6237\u5220\u9664\u6743\u9650\nrequest.user.user_permissions.clear()  # \u6e05\u9664\u7528\u6237\u5168\u90e8\u6743\u9650\n</code></pre> <p>http://blog.igevin.info/posts/django-permission/</p> <p>https://docs.djangoproject.com/en/1.10/ref/contrib/auth/</p>"},{"location":"python/django/django-permissions/#group-permission","title":"Group Permission","text":"<p>Group Permission\u7684\u7ba1\u7406\u673a\u5236\u57fa\u672c\u4e0a\u548cMoedl Permission\u4e00\u76f4\uff0c\u57fa\u672c\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>group.permissions.set([permission_list])\ngroup.permissions.add(permission, permission, ...)\ngroup.permissions.remove(permission, permission, ...)\ngroup.permissions.clear()\n</code></pre> <p>\u6743\u9650\u68c0\u67e5\u4f9d\u65e7\u4f7f\u7528model.has_permission()\u65b9\u6cd5\u3002</p> <pre><code>new_group, created = Group.objects.get_or_create(name='new_group')\nnew_group.permissions.add(permission)\nrequest.user.groups.add(new_group)\n</code></pre>"},{"location":"python/django/django-permissions/#drf","title":"DRF\u4e2d\u81ea\u5b9a\u4e49\u6743\u9650\u68c0\u67e5","text":"<pre><code># override GET /user/\n# \u67e5\u770b\u7528\u6237\u5217\u8868\ndef list(self, request, *args, **kwargs):\npermission_required(request.user, ['user.view_user'])\nusers = User.objects.all()\nserializer = UserListSerializer(users, many=True)\nreturn Response(serializer.data)\n</code></pre> <pre><code>from rest_framework.exceptions import PermissionDenied, MethodNotAllowed\nfrom .models import *\n# \u83b7\u53d6\u67d0\u4e2amodel\u7684\u5168\u90e8\u6743\u9650\u5217\u8868\n# Receive ----------------------------------\n# model: a model\n# Return -----------------------------------\n# permissions: all permission related to this model\ndef get_model_permission(model):\ncontent_type = ContentType.objects.get_for_model(model)\npermissions = Permission.objects.filter(content_type=content_type)\nreturn permissions\ndef permission_required(user, perm_list):\nif user.has_perms(perm_list):\npass\nelse:\nraise PermissionDenied\n</code></pre> <pre><code>def list(self, request, *args, **kwargs):\nself.add_log(request=request)\npermission_list = []\nimport django.apps\nfor model in django.apps.apps.get_models():  # \u83b7\u53d6\u6240\u6709\u7684model\ndata = {}\ncontent_type = ContentType.objects.get_for_model(model)  # \u83b7\u53d6model\u5bf9\u5e94\u7684content_type\npermissions = Permission.objects.filter(content_type=content_type)  # \u83b7\u53d6\u8be5model\u7684\u6240\u6709permission\nserializer = self.get_serializer(permissions, many=True)  # \u5e8f\u5217\u5316\ndata['name'] = str(model._meta.verbose_name)  # \u538b\u5165json\u4e2d\ndata['content_type'] = str(content_type.id)\ndata['permissions'] = serializer.data\npermission_list.append(data)  # json\u538b\u5165list\u4e2d\n# \u5c06list\u6309\u7167json\u4e2d\u7684content_type\u6b63\u5e8f\u6392\u5217\n# \u4e0d\u52a0int(x['content_type])\u5c06\u6309\u7167str\u7c7b\u578b\u6392\u5e8f \u987a\u5e8f\uff1a1 10 11... 2 20\n# reverse \u53cd\u5e8f\npermission_list = sorted(permission_list, key=lambda x: int(x['content_type']), reverse=False)\nreturn success_response(permission_list)\n</code></pre> <pre><code>from rest_framework.permissions import IsAdminUser\nclass IsVbAdminUser(IsAdminUser):\n\"\"\"\n    Allows access only to admin users.\n    \"\"\"\ndef has_object_permission(self, request, view, obj):\n\"\"\"\n        Return `True` if permission is granted, `False` otherwise.\n        \"\"\"\nreturn self.has_permission(request, view)\n</code></pre> <p>\u7136\u540e\u5728 viewset \u4e2d\uff0c\u4f8b\u5982\u83b7\u53d6\u8be6\u60c5\u63a5\u53e3\uff0c\u8fd9\u6837\u7528\uff0c</p> <pre><code>@wrap_permission(IsVbAdminUser)\ndef retrieve(self, request, *args, **kwargs):\n</code></pre> <p>superuser\u5728\u6240\u6709\u6743\u9650\u68c0\u6d4bhas_perm\u5747\u8fd4\u56deTrue</p>"},{"location":"python/django/django-popup/","title":"Django\u5f39\u7a97\u65b0\u589e\u3001\u4fee\u6539\u3001\u5220\u9664ForeignKey\u3001ManyToMany","text":""},{"location":"python/django/django-popup/#update-20180515","title":"Update 2018/05/15","text":"<p>\u5df2\u5c01\u88c5\u4e3a\u8f6e\u5b50\uff0c\u9700\u8981\u4f7f\u7528\u7684\u5c0f\u4f19\u4f34\u8bf7\u76f4\u63a5\u8bbf\u95ee Github \u6216\u8005 \u793a\u4f8b\u7f51\u7ad9\u3002</p> <p>\u9700\u8981\u4e86\u89e3\u5de5\u4f5c\u539f\u7406\u7684\u8bf7\u7ee7\u7eed\u9605\u8bfb\u3002</p>"},{"location":"python/django/django-popup/#_1","title":"\u539f\u56e0","text":"<p>Django\u81ea\u5e26\u7684admin\u4e2d\u53ef\u4ee5\u4f7f\u7528PopupWindow\u6765\u65b0\u589e\u548c\u4fee\u6539ForeignKey(\u7b80\u79f0FK)\u3001\u65b0\u589eManyToMany(\u7b80\u79f0M2M)\u5b57\u6bb5\uff0c\u53ef\u4ee5\u5728\u65b0\u589e\u6216\u8005\u4fee\u6539\u67d0\u4e2a\u5bf9\u8c61\u65f6\u5feb\u901f\u7684\u4fee\u6539\u4e0e\u5176\u76f8\u5173\u7684\u5176\u4ed6\u5b9e\u4f8b\uff0c\u4f7f\u7528\u8d77\u6765\u65b9\u4fbf\u5feb\u6377\u3002\u5728\u5b9e\u4f8b\u9879\u76ee\u5f00\u53d1\u8fc7\u7a0b\u4e2d\uff0c\u9047\u5230\u4e86\u76f8\u5173\u7684\u7c7b\u4f3c\u9700\u6c42\uff0c\u5728\u6b64\u8bb0\u5f55\u4e0b\u76f8\u5173\u7684\u5b9e\u73b0\u65b9\u6cd5\u3002</p>"},{"location":"python/django/django-popup/#_2","title":"\u53ef\u884c\u7684\u5b9e\u73b0\u65b9\u6848","text":""},{"location":"python/django/django-popup/#ajax","title":"Ajax","text":"<p>\u6700\u5f00\u59cb\u8003\u8651\u4f7f\u7528Ajax\u4ee5\u53caDjangoRestFramework\u6765\u5b9e\u73b0\u8fd9\u9879\u529f\u80fd\uff0c\u4f46\u662f\u7f3a\u70b9\u5341\u5206\u660e\u663e\uff0c\u5bf9\u4e8e\u7eafWeb\u7684\u9879\u76ee\u6765\u8bf4\u9700\u8981\u5f15\u5165\u7b2c\u4e09\u65b9\u5e93\uff0c\u65b0\u589e\u3001\u4fee\u6539\u3001\u5220\u9664FK\\M2M\u65f6\uff0c\u5176\u4e2d\u7684\u903b\u8f91\u9519\u8bef\u5747\u9700\u8981\u624b\u52a8\u53bb\u5904\u7406\uff0c\u6bd4\u8f83\u7e41\u7410\u5e76\u4e14\u4e0d\u5229\u4e8e\u79fb\u690d\u590d\u7528\u3002</p>"},{"location":"python/django/django-popup/#relatedfieldwidgetwrapper","title":"\u76f4\u63a5\u8c03\u7528 RelatedFieldWidgetWrapper","text":"<p>\u5728StackOverflow\u4e0a\u641c\u7d22\u5f97\u5230\u7684\u7b54\u6848\u5747\u4e3a\u4f7f\u7528<code>RelatedFieldWidgetWrapper</code>\u8c03\u7528\u539f\u751fadmin\u7684<code>PopupWindow</code>\uff0c\u7f3a\u70b9\u6bd4\u8f83\u660e\u663e\uff0c\u5bf9\u4e8e\u6709\u4e00\u5957\u81ea\u5df1\u7684UI\u98ce\u683c\u7684Web\u7cfb\u7edf\u6765\u8bf4\uff0c\u754c\u9762\u95f4\u7684\u98ce\u683c\u5dee\u5f02\u662f\u4e0d\u53ef\u5bb9\u5fcd\u7684\u3002</p>"},{"location":"python/django/django-popup/#js","title":"JS","text":"<p>\u53c2\u8003\u4e86Django 1.11.6 admin\u4e2d\u7684\u5b9e\u73b0\u4ee3\u7801\uff0c\u7406\u51fa\u5176\u5b9e\u73b0\u7684\u4e3b\u8981\u601d\u8def\u5982\u4e0b\uff1a</p> <ul> <li><code>RelatedFieldWidgetWrapper</code>\u662f\u4e2a\u7ee7\u627f\u4e8eforms.Widget\u7684\u7c7b\uff0c\u6e90\u7801(<code>/django/contrib/admin/widgets.py</code>)\u5982\u4e0b(\u672a\u663e\u793a\u90e8\u5206\u65e0\u5173\u4ee3\u7801)\uff1a</li> </ul> <p>class RelatedFieldWidgetWrapper(forms.Widget): \"\"\" This class is a wrapper to a given widget to add the add icon for the admin interface. \"\"\" templatename = 'admin/widgets/relatedwidget_wrapper.html'</p> <pre><code>def __init__(self, widget, rel, admin_site, can_add_related=None,\ncan_change_related=False, can_delete_related=False):\nself.needs_multipart_form = widget.needs_multipart_form\nself.attrs = widget.attrs\nself.choices = widget.choices\nself.widget = widget\nself.rel = rel\n# Backwards compatible check for whether a user can add related\n# objects.\nif can_add_related is None:\ncan_add_related = rel.model in admin_site._registry\nself.can_add_related = can_add_related\n# XXX: The UX does not support multiple selected values.\nmultiple = getattr(widget, 'allow_multiple_selected', False)\nself.can_change_related = not multiple and can_change_related\n# XXX: The deletion UX can be confusing when dealing with cascading deletion.\ncascade = getattr(rel, 'on_delete', None) is CASCADE\nself.can_delete_related = not multiple and not cascade and can_delete_related\n# so we can check if the related object is registered with this AdminSite\nself.admin_site = admin_site\ndef get_related_url(self, info, action, *args):\nreturn reverse(\"admin:%s_%s_%s\" % (info + (action,)),\ncurrent_app=self.admin_site.name, args=args)\ndef get_context(self, name, value, attrs):\nfrom django.contrib.admin.views.main import IS_POPUP_VAR, TO_FIELD_VAR\nrel_opts = self.rel.model._meta\ninfo = (rel_opts.app_label, rel_opts.model_name)\nself.widget.choices = self.choices\nurl_params = '&amp;'.join(\"%s=%s\" % param for param in [\n(TO_FIELD_VAR, self.rel.get_related_field().name),\n(IS_POPUP_VAR, 1),\n])\ncontext = {\n'rendered_widget': self.widget.render(name, value, attrs),\n'name': name,\n'url_params': url_params,\n'model': rel_opts.verbose_name,\n}\nif self.can_change_related:\nchange_related_template_url = self.get_related_url(info, 'change', '__fk__')\ncontext.update(\ncan_change_related=True,\nchange_related_template_url=change_related_template_url,\n)\nif self.can_add_related:\nadd_related_url = self.get_related_url(info, 'add')\ncontext.update(\ncan_add_related=True,\nadd_related_url=add_related_url,\n)\nif self.can_delete_related:\ndelete_related_template_url = self.get_related_url(info, 'delete', '__fk__')\ncontext.update(\ncan_delete_related=True,\ndelete_related_template_url=delete_related_template_url,\n)\nreturn context\n</code></pre> <p>\u63a5\u6536<code>rel</code>\u53c2\u6570\uff0c\u5176\u4e3a\u4e00\u4e2aFK\u7c7b\uff0c\u5728<code>get_context</code>\u51fd\u6570\u4e2d\uff0c<code>rel_opts</code>\u4e3a\u8be5\u7c7b\u7684<code>Meta</code>\u5c5e\u6027\uff0c<code>info</code>\u4e3a\u8be5\u7c7b\u6240\u5728\u7684<code>app</code>\u548c<code>model</code>\u540d\u79f0\u7ec4\u6210\u7684\u5143\u7ec4\u3002\u5b9a\u4e49\u51fd\u6570<code>get_related_url</code>\u7528\u4e8e\u751f\u6210\u76f8\u5173\u7684\u65b0\u589e\u3001\u4fee\u6539\u3001\u5220\u9664<code>url</code>,<code>url_params</code>\u9ed8\u8ba4\u6709<code>TO_FIELD_VAR</code>\u7528\u4e8e\u6807\u8bb0\u4fee\u6539\u7684<code>field</code>,<code>IS_POPUP_VAR</code>\u7528\u4e8e\u6807\u8bb0\u662f\u4ee5<code>PopupWindow</code>\u7684\u65b9\u5f0f\u6253\u5f00\u3002</p> <ul> <li>\u5904\u7406\u524d\u9762\u751f\u6210\u7684url\u7684\u89c6\u56fe\u4ee3\u7801\u4f4d\u4e8e<code>/django/contrib/options.py/ModelAdmin/</code>\u3002\u5904\u7406\u65b0\u589e\u4e3a\u51fd\u6570<code>response_add</code>\uff0c\u622a\u53d6\u5904\u7406\u5176\u7c7b\u578b\u4e3a<code>popup</code>\u7684\u90e8\u5206\u4ee3\u7801\u5982\u4e0b\uff1a</li> </ul> <pre><code>if IS_POPUP_VAR in request.POST:\nto_field = request.POST.get(TO_FIELD_VAR)\nif to_field:\nattr = str(to_field)\nelse:\nattr = obj._meta.pk.attname\nvalue = obj.serializable_value(attr)\npopup_response_data = json.dumps({\n'value': six.text_type(value),\n'obj': six.text_type(obj),\n})\nreturn TemplateResponse(request, self.popup_response_template or [\n'admin/%s/%s/popup_response.html' % (opts.app_label, opts.model_name),\n'admin/%s/popup_response.html' % opts.app_label,\n'admin/popup_response.html',\n], {\n'popup_response_data': popup_response_data,\n})\n</code></pre> <p><code>popup_response_data</code> \u662f\u4e00\u4e2a\u5305\u542b\u4e86\u65b0\u589e\u7684<code>FK\\M2M</code>\u7684value(\u663e\u793a\u7684\u503c)\u3001obj(\u65b0\u589e\u7684\u5bf9\u8c61\u5b9e\u4f8bID)json\uff0c\u51fd\u6570\u8fd4\u56de\u7684\u4e3a<code>TemplateResponse</code>\uff0c\u751f\u6548\u90e8\u5206\u4e3a<code>'admin/popup_response.html'</code>\uff0c\u5176\u6e90\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>{% load i18n static %}&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;&lt;title&gt;{% trans 'Popup closing...' %}&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;script type=\"text/javascript\"\nid=\"django-admin-popup-response-constants\"\nsrc=\"{% static \"admin/js/popup_response.js\" %}\"\ndata-popup-response=\"{{ popup_response_data }}\"&gt;\n&lt;/script&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u53ea\u5305\u542b\u4e86\u4e00\u4e2a<code>admin/js/popup_response.js</code>\u6587\u4ef6\uff0c\u5176\u6e90\u7801\u5982\u4e0b\uff1a</p> <pre><code>/*global opener */\n(function() {\n'use strict';\nvar initData = JSON.parse(document.getElementById('django-admin-popup-response-constants').dataset.popupResponse);\nswitch(initData.action) {\ncase 'change':\nopener.dismissChangeRelatedObjectPopup(window, initData.value, initData.obj, initData.new_value);\nbreak;\ncase 'delete':\nopener.dismissDeleteRelatedObjectPopup(window, initData.value);\nbreak;\ndefault:\nopener.dismissAddRelatedObjectPopup(window, initData.value, initData.obj);\nbreak;\n}\n})();\n</code></pre> <p>\u8fd9\u6bb5js\u5c06\u5173\u95ed<code>PopupWindow</code>\u5e76\u5c06\u5f97\u5230\u7684<code>popup_response_data</code>\u63d2\u5165\u6216\u8005\u4fee\u6539\u81f3\u5bf9\u5e94\u7684<code>field,</code>\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0cadmin\u5728\u5bfb\u627e\u63d2\u5165\u7684<code>field_id</code>\u662f\u6839\u636e\u6253\u5f00\u7684<code>PopupWindow</code>\u7684url,\u4f7f\u7528\u4f4d\u4e8e<code>django/contrib/admin/static/js/admin/RelatedObjectLookups.js</code>\u4e2d\u7684<code>windowname_to_id</code>\u51fd\u6570\u4ece\u5f53\u524d\u7a97\u53e3\u7684url\u622a\u53d6\u5e76\u751f\u6210\u5176\u5728\u7236\u9875\u9762\u5f85\u64cd\u4f5c\u7684<code>field_id</code>\u3002</p> <p>\u8fd9\u6837\u7684\u5b9e\u73b0\u65b9\u5f0f\u7684\u4f18\u70b9\u662f\u4fbf\u4e8e\u4f7f\u7528modelform\u4ee5\u53ca\u76f8\u5173\u903b\u8f91\uff0c\u8ba9\u5176\u81ea\u52a8\u751f\u6210\u76f8\u5173\u65b0\u589e\u3001\u4fee\u6539\u3001\u5220\u9664\u754c\u9762\u5e76\u5904\u7406\u76f8\u5173\u9519\u8bef\uff0c\u4fbf\u4e8e\u590d\u7528\u79fb\u81f3\uff0c\u4f46\u662f\u9700\u8981\u5bf9\u6837\u5f0f\u8fdb\u884c\u4fee\u6539\u3002</p>"},{"location":"python/django/django-popup/#fk","title":"FK\u5b9e\u73b0\u65b9\u6cd5","text":"<pre><code>from django.forms.widgets import Select\nclass ForeignKeyWidget(Select):\ntemplate_name = 'widgets/foreign_key_select.html'\ndef __init__(self, url_template, *args, **kw):\nsuper(ForeignKeyWidget, self).__init__(*args, **kw)\nself.url_template = url_template\ndef get_context(self, name, value, attrs):\ncontext = super(ForeignKeyWidget, self).get_context(name, value, attrs)\ncontext['add_url'] = self.url_template\ncontext['update_url'] = self.url_template\ncontext['delete_url'] = self.url_template + 'delete/'\nreturn context\n</code></pre> <p>\u5176\u63a5\u53d7\u4e00\u4e2a<code>url_template</code>\u53c2\u6570\uff0c\u5982<code>url_template</code>\u4e3a<code>/post/</code>,\u5219\u9ed8\u8ba4\u7684url\u4e3a\uff1a</p> <p>\u65b0\u589e\uff1a <code>/post/</code>; \u4fee\u6539\uff1a <code>/post/id/</code>; \u5220\u9664\uff1a <code>/post/delete/id/</code>\uff1b</p> <pre><code>&lt;style&gt;\n#{{ widget.attrs.id }}_add, #{{ widget.attrs.id }}_change, #{{ widget.attrs.id }}_delete {\nmargin-top: 10px;\npadding: 0 10px;\nheight: 25px;\nline-height: 25px;\n}\n&lt;/style&gt;\n&lt;div class=\"row\"&gt;\n&lt;div class=\"col-sm-6\"&gt;\n        {% include \"django/forms/widgets/select.html\" %}\n    &lt;/div&gt;\n&lt;div class=\"col-sm-6 layui-btn-group\"&gt;\n&lt;a class=\"layui-btn layui-btn-mini\" id=\"{{ widget.attrs.id }}_add\"&gt;\u65b0\u589e&lt;/a&gt;\n&lt;a class=\"layui-btn layui-btn-mini layui-btn-disabled layui-btn-normal\" id=\"{{ widget.attrs.id }}_change\"&gt;\u4fee\u6539&lt;/a&gt;\n&lt;a class=\"layui-btn layui-btn-mini layui-btn-disabled layui-btn-danger\" id=\"{{ widget.attrs.id }}_delete\"&gt;\u5220\u9664&lt;/a&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;script&gt;\n$('#{{ widget.attrs.id }}_add').click(function () {\nvar index = layui.layer.open({\ntitle: \"\u6dfb\u52a0\u5206\u7c7b\",\ntype: 2,\narea: ['700px', '500px'],\ncontent: \"{{ add_url }}\" + '?popup=1&amp;to_field={{ widget.attrs.id }}',\nsuccess: function (layer, index) {\n}\n});\n});\n$(\"#{{ widget.attrs.id }}_change\").click(function () {\nvar id = $('#{{ widget.attrs.id }}').val();\nif (id) {\nvar index = layui.layer.open({\ntitle: \"\u4fee\u6539\u5206\u7c7b\",\ntype: 2,\narea: ['700px', '500px'],\ncontent: '{{ update_url }}' + id + '?popup=1&amp;to_field={{ widget.attrs.id }}',\nsuccess: function (layer, index) {\n}\n});\n}\n});\n$(\"#{{ widget.attrs.id }}_delete\").click(function () {\nvar id = $('#{{ widget.attrs.id }}').val();\nvar value = $('#{{ widget.attrs.id }} option[value=' + id + ']').text();\nvar indexGood = value.lastIndexOf('&gt;');\nvar valueN = indexGood &gt; 0 ? value.substring(indexGood + 1, value.length) : value;\nif (id) {\nlayer.confirm('\u786e\u8ba4\u5220\u9664 ' + valueN + ' \u5417?', {icon: 3, title: '\u5220\u9664'}, function (index) {\n$.ajax({\ntype: \"POST\",\ndata: {},\nurl: '{{ delete_url }}' + id + '/',\nbeforeSend: function (xhr) {\nxhr.setRequestHeader(\"X-CSRFToken\", $.cookie('csrftoken'));\n},\nsuccess: function (data, textStatus) {\n&lt;!--\u5173\u95ed\u5f39\u7a97 \u8fd4\u56de\u5217\u8868 --&gt;\nlayer.close(index);\n$('#{{ widget.attrs.id }} option[value=' + data.id + ']').remove();\n$(\"#{{ widget.attrs.id }}_change,#{{ widget.attrs.id }}_delete\").addClass('layui-btn-disabled');\nreturn false;\n},\nerror: function (XMLHttpRequest, textStatus, errorThrown) {\nlayer.alert('\u5220\u9664\u5931\u8d25 ' + XMLHttpRequest.responseText)\n}\n});\n});\n}\n});\n/********select\u7ed1\u5b9achange\u4e8b\u4ef6\uff0c\u5982\u679cvalue\u6709\u503c\uff0c\u5c31\u53ef\u4fee\u6539\u53ca\u5220\u9664  \u9875\u9762\u52a0\u8f7d\u5b8c\u6210\u4e4b\u540e\u505a\u76f8\u540c\u5224\u65ad**********/\nfunction {{ widget.attrs.id }}_isDisabled() {\nif ($('#{{ widget.attrs.id }}').val()) {\n$(\"#{{ widget.attrs.id }}_change,#{{ widget.attrs.id }}_delete\").removeClass('layui-btn-disabled');\n} else {\n$(\"#{{ widget.attrs.id }}_change,#{{ widget.attrs.id }}_delete\").addClass('layui-btn-disabled');\n}\n}\n$('#{{ widget.attrs.id }}').change(function () {\n{{ widget.attrs.id }}_isDisabled();\n});\n{{ widget.attrs.id }}_isDisabled();\n&lt;/script&gt;\n</code></pre> <p>\u4ee5\u4fee\u6539\u5206\u7c7b\u4e3a\u4f8b\uff0c\u5176popup\u6253\u5f00\u7684url\u4e3a<code>'{{ update_url }}' + id + '?popup=1&amp;to_field={{ widget.attrs.id }}'</code>\uff0curl\u4e2d\u7684\u53c2\u6570\u5305\u542b\u4e86popup=1\u7528\u4e8e\u6807\u8bb0\u4ee5popup\u65b9\u5f0f\u6253\u5f00\uff0cto_field\u76f4\u63a5\u53d6\u4e86\u8be5\u63a7\u4ef6\u7684id\u800c\u6ca1\u6709\u60f3admin\u4e2d\u90a3\u6837\u76f4\u63a5\u53bburl\u4e2d\u622a\u53d6\uff0c\u4e3b\u8981\u662f\u56e0\u4e3a\u4e00\u822c\u9879\u76ee\u7684url\u6a21\u5f0f\u6ca1\u6709admin\u4e2d\u90a3\u6837\u89c4\u6574\u3002</p> <pre><code>from django import forms\nfrom common.fields import ForeignKeyWidget\nfrom django.core.urlresolvers import reverse_lazy\nfrom .models import *\nclass ArticleForm(forms.ModelForm):\ndef __init__(self, *args, **kwargs):\nsuper(ArticleForm, self).__init__(*args, **kwargs)\nself.fields['title'].widget.attrs.update({'class': 'form-control'})\nself.fields['category'].widget.attrs.update({'class': 'form-control'})\nclass Meta:\nmodel = Article\nfields = ['title', 'category']\nwidgets = {\n'category': ForeignKeyWidget(url_template=reverse_lazy('category_popup_create')),\n}\nclass CategoryForm(forms.ModelForm):\ndef __init__(self, *args, **kwargs):\nsuper(CategoryForm, self).__init__(*args, **kwargs)\nself.fields['name'].widget.attrs.update({'class': 'form-control'})\nself.fields['parent'].widget.attrs.update({'class': 'form-control'})\nclass Meta:\nmodel = Category\nfields = ['name', 'parent']\n</code></pre> <pre><code># ------------------------------ \u535a\u5ba2\u7c7b\u578bPopup \u5f00\u59cb ------------------------------\nclass CategoryPopupCreateView(PermissionRequiredMixin, CreateView):\nform_class = CategoryForm\ntemplate_name = 'category_popup/create.html'\npermission_required = 'article.add_category'\ndef get_context_data(self, **kwargs):\nif 'to_field' in self.request.GET:\nkwargs['to_field'] = self.request.GET['to_field']\nreturn super(CategoryPopupCreateView, self).get_context_data(**kwargs)\ndef form_valid(self, form):\nself.object = form.save()\ncontext = {'op': 'create', 'id': self.object.id, 'value': self.object.__str__()}\nif 'to_field' in self.request.GET:\ncontext['to_field'] = self.request.GET['to_field']\nreturn TemplateResponse(self.request, 'category_popup/success.html', context=context)\nclass CategoryPopupUpdateView(PermissionRequiredMixin, UpdateView):\nmodel = Category\nform_class = CategoryForm\nslug_field = 'id'\ncontext_object_name = 'category'\ntemplate_name = 'category_popup/update.html'\npermission_required = 'article.change_category'\ndef get_context_data(self, **kwargs):\nif 'to_field' in self.request.GET:\nkwargs['to_field'] = self.request.GET['to_field']\nreturn super(CategoryPopupUpdateView, self).get_context_data(**kwargs)\ndef form_valid(self, form):\nself.object = form.save()\ncontext = {'op': 'update', 'id': self.object.id, 'value': self.object.__str__()}\nif 'to_field' in self.request.GET:\ncontext['to_field'] = self.request.GET['to_field']\nreturn TemplateResponse(self.request, 'category_popup/success.html', context=context)\nclass CategoryPopupDeleteView(PermissionRequiredMixin, DeleteView):\nmodel = Category\nslug_field = 'id'\npermission_required = 'article.delete_category'\ndef delete(self, request, *args, **kwargs):\nself.object = self.get_object()\ndata = {'op': 'delete', 'id': self.object.id, 'value': self.object.__str__()}\nself.object.delete()\nreturn JsonResponse(data=data)\n# ------------------------------ \u535a\u5ba2\u7c7b\u578bPopup \u7ed3\u675f ------------------------------\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0curl\u53c2\u6570\u4e2d\u7684tofield\u53c2\u6570\u5728get-&gt;post\u7684\u8fc7\u7a0b\u4e2d\u9700\u8981\u4e00\u76f4\u88ab\u8bb0\u5f55\u4e0b\u6765\uff0c\u5219\u5728getcontext_data\u4e2d\u83b7\u53d6\u8be5\u53c2\u6570\uff0c\u4f20\u9012\u81f3<code>category_popup/update.html</code>,\u5176\u6e90\u7801\u5982\u4e0b\uff1a</p> <pre><code>{% extends \"category_popup/base.html\" %}\n\n{% block main %}\n    &lt;div style=\"margin: 4px\"&gt;\n&lt;form class=\"form-horizontal\" enctype=\"multipart/form-data\"\naction=\"{% url 'category_popup_update' category.id %}{% if to_field %}?to_field={{ to_field }}{% endif %}\"\nmethod=\"post\"&gt;\n            {% include 'widgets/form.html' %}\n            &lt;div class=\"form-group\"&gt;\n&lt;div class=\"col-sm-10\"&gt;\n&lt;input class=\"btn btn-raised btn-info\" type=\"submit\" value=\"\u4fee\u6539\u5206\u7c7b\"/&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;/form&gt;\n&lt;/div&gt;\n{% endblock %}\n</code></pre> <p>success.html\u4ee3\u7801\uff1a</p> <pre><code>{% extends \"category_popup/base.html\" %}\n\n{% block main %}\n    &lt;script&gt;\nvar to_field = '#{{ to_field }}', op = '{{ op }}', id = '{{ id }}', value = '{{ value }}';\nif (to_field) {\nswitch (op) {\ncase 'create':\nif (id) {\nvar index = parent.layer.getFrameIndex(window.name); //\u5148\u5f97\u5230\u5f53\u524diframe\u5c42\u7684\u7d22\u5f15\nparent.layer.close(index); //\u518d\u6267\u884c\u5173\u95ed\n$option = '&lt;option value=' + id + ' selected&gt;' + value + '&lt;/option&gt;';\n$(to_field, window.parent.document).append($option);\n$(to_field + '_change,' + to_field + '_delete', window.parent.document).removeClass('layui-btn-disabled');\n}\nbreak;\ncase 'update':\nif (id) {\nvar index = parent.layer.getFrameIndex(window.name); //\u5148\u5f97\u5230\u5f53\u524diframe\u5c42\u7684\u7d22\u5f15\nparent.layer.close(index); //\u518d\u6267\u884c\u5173\u95ed\n$(to_field + ' option[value=' + id + ']', window.parent.document).html(value);\n}\nbreak;\n}\n}\n&lt;/script&gt;\n{% endblock %}\n</code></pre> <pre><code>category_urlpatterns = [\nurl(r'^popup/$', CategoryPopupCreateView.as_view(), name='category_popup_create'),\nurl(r'^popup/(?P&lt;pk&gt;\\d+)/$', CategoryPopupUpdateView.as_view(), name='category_popup_update'),\nurl(r'^popup/delete/(?P&lt;pk&gt;\\d+)/$', CategoryPopupDeleteView.as_view(), name='category_popup_delete'),\n]\n</code></pre>"},{"location":"python/django/django-popup/#widget","title":"\u5b9a\u4e49\u4e00\u4e2a<code>Widget</code>:","text":""},{"location":"python/django/django-popup/#widgettemplatelayui20popup","title":"\u5199\u8be5<code>Widget</code>\u5bf9\u5e94\u7684<code>template</code>,\u793a\u4f8b\u4e2d\u4f7f\u7528<code>layui2.0</code>\u4f5c\u4e3a<code>popup</code>\u7684\u6253\u5f00\u65b9\u5f0f\uff0c\u53ef\u4ee5\u6839\u636e\u9700\u8981\u81ea\u884c\u9009\u62e9\u3002","text":""},{"location":"python/django/django-popup/#formspy","title":"forms.py\u58f0\u660e\u63a7\u4ef6","text":""},{"location":"python/django/django-popup/#viewspy","title":"views.py","text":""},{"location":"python/django/django-popup/#urlspy","title":"urls.py","text":""},{"location":"python/django/django-popup/#m2m","title":"M2M\u5b9e\u73b0","text":"<p>M2M\u5b9e\u73b0\u4e0eFK\u7684\u5b9e\u73b0\u65b9\u6cd5\u57fa\u672c\u7c7b\u4f3c\uff0c\u53ea\u662f\u5728\u5224\u65ad\u662f\u5426\u4eae\u8d77\u4fee\u6539\u3001\u5220\u9664\u6309\u94ae\u7684\u903b\u8f91\u4e0a\u6709\u4e9b\u8bb8\u6539\u53d8\uff0c\u4e0d\u518d\u8d58\u8ff0\u3002</p>"},{"location":"python/django/django-popup/#_3","title":"\u6700\u7ec8\u7684\u6548\u679c","text":""},{"location":"python/django/django-smtp/","title":"\u963f\u91cc\u4e91\u90ae\u7bb1 smtp/pop3 Android\u5ba2\u6237\u7aef,Django\u540e\u53f0\u8bbe\u7f6e","text":"<p>\u63a5\u6536 pop3:</p> <p>\u670d\u52a1\u5668\u5730\u5740\uff1apop3.mxhichina.com \u7aef\u53e3\uff1a995 SSL\u52a0\u5bc6</p> <p></p> <p>\u53d1\u9001 smtp:</p> <p>\u670d\u52a1\u5668\u5730\u5740\uff1asmtp.mxhichina.com \u7aef\u53e3\uff1a465 SSL\u52a0\u5bc6 587 \u4e0d\u52a0\u5bc6</p> <p></p> <p>Django \u540e\u53f0\uff1a</p> <pre><code># Email\u914d\u7f6e\n# \u5982\u679c\u60f3\u8981\u652f\u6301ssl (\u6bd4\u5982qq\u90ae\u7bb1) \u89c1 https://github.com/bancek/django-smtp-ssl\nEMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'\nEMAIL_HOST = 'smtp.mxhichina.com'                   # SMTP\u5730\u5740 \u4f8b\u5982: smtp.163.com\nEMAIL_PORT = 587                             # SMTP\u7aef\u53e3 \u4f8b\u5982: 25\nEMAIL_HOST_USER = 'xxx@dreamgo.tech'         # \u90ae\u7bb1\u8d26\u6237\nEMAIL_HOST_PASSWORD = 'xxx'     # \u90ae\u7bb1\u5bc6\u7801\\\u6388\u6743\u7801\nEMAIL_SUBJECT_PREFIX = u'DreamgoBlog'         # \u4e3a\u90ae\u4ef6Subject-line\u524d\u7f00,\u9ed8\u8ba4\u662f'[django]'\nEMAIL_USE_TLS = False                         # \u4e0eSMTP\u670d\u52a1\u5668\u901a\u4fe1\u65f6\uff0c\u662f\u5426\u542f\u52a8TLS\u94fe\u63a5(\u5b89\u5168\u94fe\u63a5)\u3002\u9ed8\u8ba4\u662ffalse\nDEFAULT_FROM_EMAIL = EMAIL_HOST_USER\n</code></pre>"},{"location":"python/django/django-summernote/","title":"Django-summernote\u5bcc\u6587\u672c","text":""},{"location":"python/django/django-summernote/#1media_rootmedia_url","title":"1\u3001\u8bbe\u7f6eMEDIA_ROOT\u548cMEDIA_URL","text":"<pre><code># \u7528\u6237\u4e0a\u4f20\u6587\u4ef6\nMEDIA_ROOT = 'C:\\django/blog/media/'\nMEDIA_URL = '/media/'\n</code></pre>"},{"location":"python/django/django-summernote/#2mediaurl","title":"2\u3001\u8bbe\u7f6emedia\u7684url","text":"<pre><code>from django.conf.urls.static import static\nfrom django.conf import settings\nurlpatterns = [\nurl(r'^admin/', include(admin.site.urls)),\nurl(r'^summernote/', include('django_summernote.urls')),\n] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)\n</code></pre>"},{"location":"python/django/django-summernote/#3","title":"3\u3001\u8bbe\u7f6e\u56fe\u7247\u4e0a\u4f20\u8def\u5f84","text":"<pre><code>def uploaded_filepath(instance, filename):\next = filename.split('.')[-1]\nfilename = \"%s.%s\" % (uuid.uuid4(), ext)\ntoday = datetime.now().strftime('%Y-%m-%d')\n# upload path is MEDIA_ROOT/summernote/today/filename\nreturn os.path.join('summernote/', today, filename)\n</code></pre>"},{"location":"python/django/django-summernote/#4summernote","title":"4\u3001\u914d\u7f6eSummerNote","text":"<pre><code>SUMMERNOTE_CONFIG = {\n'width': '100%',\n'lang': 'zh-CN',\n'iframe': True,\n'attachment_upload_to': uploaded_filepath,\n'attachment_require_authentication': True,\n'internal_js': (\n'/static/django_summernote/lang/summernote-zh-CN.min.js',\n),\n}\n</code></pre>"},{"location":"python/django/django-summernote/#5modelform","title":"5\u3001\u5728ModelForm\u4e2d\u4f7f\u7528","text":"<pre><code># Summer noteWidget\u56fa\u5b9a\u5927\u5c0f Summer noteInplaceWidget \u81ea\u7531\u5927\u5c0f\n# \u4f7f\u7528Summer noteInplaceWidget \u65f6\u4f1a\u6709\u56fe\u7247\u65e0\u6cd5\u4e0a\u4f20\u7684bug\nfrom django_summernote.widgets import SummernoteWidget, SummernoteInplaceWidget\n# \u535a\u5ba2\u8868\u5355\nclass ArticleForm(ModelForm):\ndef __init__(self, *args, **kwargs):\nsuper(ArticleForm, self).__init__(*args, **kwargs)\nself.fields['category'].widget.attrs.update({'class': 'form-control'})\nclass Meta:\nmodel = Article\nfields = '__all__'\nwidgets = {\n'content': SummernoteWidget(),\n}\n</code></pre>"},{"location":"python/django/django-summernote/#6admin","title":"6\u3001\u5728admin\u4e2d\u4f7f\u7528","text":"<p>TextField\u7c7b\u578b\u5bf9\u5e94\u7684\u5b57\u6bb5\u5728admin\u4e2d\u4f1a\u81ea\u52a8\u6e32\u67d3\u6210\u4e3a\u5bcc\u6587\u672c\u7f16\u8f91\u6846\u3002</p>"},{"location":"python/django/django-summernote/#7html","title":"7\u3001html\u4e2d\u8c03\u7528","text":"<p>\u4e00\u5b9a\u8981\u8c03\u7528form.media\u6765\u52a0\u8f7ddjango-summernote\u7cfb\u7edf\u7684\u9759\u6001\u6587\u4ef6(css\u3001js\u3001images\u7b49)</p> <pre><code>&lt;form class=\"form\" enctype=\"multipart/form-data\" action=\"{% url 'article_create' %}\" method=\"post\"&gt;\n{% csrf_token %}\n{{ form.media }}\n{{ form.as_p }}\n&lt;input class=\"btn btn-raised btn-info\" style=\"float:right;\" type=\"submit\" value=\"\u53d1\u5e03\u535a\u5ba2\" /&gt;\n&lt;/form&gt;\n</code></pre>"},{"location":"python/django/django-summernote/#8modelform","title":"8\u3001\u5728ModelForm\u4e2d\u4f7f\u7528","text":"<p>\u4f7f\u7528SummernoteInplaceWidget\u6a21\u5f0f\u4f1a\u51fa\u73b0\u56fe\u7247\u65e0\u6cd5\u4e0a\u4f20\u7684bug,\u63d0\u793a403 csrf_token\u9a8c\u8bc1\u5931\u8d25\u88ab\u62d2\u7edd\uff0c\u89e3\u51b3\u65b9\u6cd5\u4e3a\u5c06django_summernote/templates/django_summernote/widget_inplace.html\u7684\u7b2c\u516b\u884c\u7531<code>var csrftoken = getCookie('{{ CSRF_COOKIE_NAME }}');</code> \u6539\u4e3a <code>var csrftoken = getCookie('csrftoken');</code>\u5373\u53ef\u6b63\u786e\u83b7\u53d6\u5230\u6b63\u786e\u7684scrf_token\u7528\u4e8e\u56fe\u7247\u4e0a\u4f20\u3002</p>"},{"location":"python/django/django-summernote/#_1","title":"\u5e38\u89c1\u95ee\u9898\uff1a","text":"<p>1 form\u4e2dSummernoteinplace\u65e0\u6cd5\u88ab\u6b63\u5e38\u52a0\u8f7d\uff0c\u89e3\u51b3\u65b9\u6cd5\u4e3a\u5728templates\u7684form\u4e2d\u52a0\u5165{{ form.media }}\u3002</p>"},{"location":"python/django/django-transaction/","title":"Django\u4e8b\u52a1","text":"<p>django\u5728\u6279\u91cf\u64cd\u4f5c\u65f6\u4f1a\u4f7f\u7528for\u5faa\u73af\u521b\u5efa\u3001\u66f4\u65b0\u3001\u5220\u9664\u4e00\u7cfb\u5217\u5bf9\u8c61\uff0c\u8fd9\u4e9b\u64cd\u4f5c\u5f80\u5f80\u662f\u6709\u5bf9\u5e94\u7684\u524d\u63d0\u6761\u4ef6\u7684\uff0c\u5982\u8981\u6c42\u53ea\u6709\u53d1\u5e03\u4eba\u624d\u80fd\u5220\u9664\u5bf9\u5e94\u7684\u6587\u7ae0\uff0c\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u5148for\u5faa\u73af\u4e00\u904dqueryset,\u770b\u662f\u5426\u6240\u6709\u7684\u5bf9\u8c61\u90fd\u6ee1\u8db3\u6761\u4ef6\uff0c\u82e5\u6240\u6709\u7684\u5bf9\u8c61\u90fd\u6ee1\u8db3\u6761\u4ef6\u5219\u518d\u6b21for\u5faa\u73af\u8fdb\u884c\u5bf9\u5e94\u7684\u5220\u9664\u64cd\u4f5c\uff0c\u8fd9\u6837\u4f1a\u4f7f\u5f97\u4ee3\u7801\u6781\u5ea6\u4e0d\u7f8e\u89c2\uff0c\u6548\u7387\u5f80\u5f80\u4e5f\u4e0d\u9ad8\u3002</p> <p>\u4f7f\u7528\u4e8b\u52a1\u53ef\u4ee5\u5f88\u597d\u7684\u5904\u7406\u8fd9\u4e00\u7c7b\u95ee\u9898\uff0c\u5728for\u5faa\u73af\u5f00\u59cb\u524d\u8bbe\u7f6e\u4fdd\u5b58\u70b9\uff0cfor\u5faa\u73af\u65f6\uff0c\u6bcf\u5bf9\u6bd4\u6210\u529f\u4e00\u4e2a\u8fdb\u884c\u4e00\u6b21\u5220\u9664\u64cd\u4f5c\uff0c\u82e5\u51fa\u73b0\u4e0d\u7b26\u5408\u6761\u4ef6\u7684\u6587\u7ae0\uff0c\u5219\u56de\u6eda\u6570\u636e\u5230for\u5faa\u73af\u524d\uff0c\u82e5for\u5faa\u73af\u5b8c\u6210\u4e86\u4e5f\u672a\u51fa\u73b0\u9519\u8bef\uff0c\u4e00\u6b21\u6027\u63d0\u4ea4\u6240\u6709\u7684\u6570\u636e\u5e93\u64cd\u4f5c\u3002</p> <pre><code>from django.db import transaction\n@transaction.atomic\ndef create(self, request, *args, **kwargs):\nself.before_create()\nserializer = self.get_serializer(data=request.data)\nif serializer.is_valid():\nsid = transaction.savepoint() # \u8bbe\u7f6e\u4fdd\u5b58\u70b9\nitems = dict_to_query_dict(request.data).getlist('items')\n# \u4f9d\u6b21\u6dfb\u52a0\u5b50\u9000\u8bfe\u4e1a\u52a1\nfor item in items:\ntry:\nitem_dict = ast.literal_eval(item)\nexcept SyntaxError:\nreturn error_response(1, '{}\u5305\u542b\u975e\u6cd5\u5b57\u7b26'.format(item))\nitem_serializer = ReturnClassHourItemModifySerializer(data=item_dict)\nif item_serializer.is_valid():\nitem_instance = item_serializer.save()\nelse:\ntransaction.savepoint_rollback(sid) # \u53d1\u751f\u9519\u8bef \u56de\u6eda\u4e4b\u524d\u4fdd\u5b58\u7684\u6240\u6709\u5bf9\u8c61\nreturn error_response(1, convert_serializer_errors(item_serializer.errors))\ntransaction.savepoint_commit(sid) # for\u5faa\u73af\u5b8c\u6210 \u65e0\u9519\u8bef\u53d1\u751f \u63d0\u4ea4\u4fdd\u5b58\u70b9\u5230\u6b64\u5904\u7684\u6240\u6709\u6570\u636e\u5e93\u64cd\u4f5c\nreturn success_response('')\n</code></pre> <p>bulk_create\u5185\u90e8\u6709 with transaction.atomic(using=self.db, savepoint=False):  \uff0c\u5df2\u7ecf\u5c01\u88c5\u597d\u4e86\u4e8b\u52a1\uff0c\u53ea\u4f1a\u51fa\u73b0\u4e24\u79cd\u7ed3\u679c\uff0c\u62a5\u9519\u4f46\u4e00\u4e2a\u5bf9\u8c61\u90fd\u4e0d\u751f\u6210\u6216\u8005\u5168\u90e8\u751f\u6210\u5b8c\u6bd5\u3002</p> <pre><code># \u6279\u91cf\u6dfb\u52a0\u9009\u9879\n@detail_route(methods=['POST'])\ndef add_choices(self, request, pk):\ntry:\nquestion = self.get_object()\nchoices = dict_to_query_dict(request.data).getlist('choices')\n# list\u4e2dstr\u8f6c\u6362\u4e3adict,dict\u518d\u8f6c\u6362\u4e3aChoice\u7c7b\u5b9e\u4f8b\uff0c\u6240\u6709\u7684\u7c7b\u5b9e\u4f8b\u5408\u5e76\u4e3alist\n# bulk_create\u5165\u53c2\u8be5list,\u5176\u5185\u90e8\u5c01\u88c5\u597d\u4e8b\u52a1,\u82e5\u5176\u4e2d\u4e00\u4e2a\u751f\u4ea7\u9519\u8bef\uff0c\u5219\u4f1a\u81ea\u52a8\u64a4\u9500\u4e4b\u524d\u64cd\u4f5c\nchoice_list = Choice.objects.bulk_create([Choice(**ast.literal_eval(choice)) for choice in choices])\n# PS\uff1abulk_create\u4e0d\u4f1a\u8c03\u7528\u5b9e\u4f8b\u7684save\u65b9\u6cd5,\u4e0d\u4f1a\u53d1\u51fapost_save\u4fe1\u53f7,\u8fd4\u56de\u5b9e\u4f8b\u65e0ID,\u9700\u8981\u518d\u6b21\u624b\u52a8\u8c03\u7528save()\nfor choice in choice_list:\nchoice.save()\nquestion.choices.add(*choice_list)\nreturn success_response('\u6dfb\u52a0\u6210\u529f')\nexcept Exception as e:\nreturn error_response(1, '\u53d1\u751f\u9519\u8bef\uff1a{}'.format(e.__str__()))\n</code></pre>"},{"location":"python/django/django-translation/","title":"Django\u591a\u8bed\u8a00\u652f\u6301","text":""},{"location":"python/django/django-translation/#1-i18n","title":"1 \u5f00\u542fI18N\u652f\u6301","text":"<pre><code>USE_I18N = True\nUSE_L10N = True\n</code></pre>"},{"location":"python/django/django-translation/#2","title":"2 \u8bbe\u7f6e","text":"<pre><code># \u8bed\u8a00\u9009\u9879\nLANGUAGES = (\n('zh-hans', '\u7b80\u4f53\u4e2d\u6587'),\n('zh-hant', '\u7e41\u4f53\u4e2d\u6587'),\n('en', '\u82f1\u8bed'),\n('es', '\u897f\u73ed\u7259\u8bed'),\n('bn', '\u5b5f\u52a0\u62c9\u8bed'),\n('id', '\u5370\u5730\u8bed'),\n('pt', '\u8461\u8404\u7259\u8bed'),\n('ru', '\u4fc4\u8bed'),\n('ja', '\u65e5\u8bed'),\n('de', '\u5fb7\u8bed'),\n('ko', '\u97e9\u8bed'),\n('fr', '\u6cd5\u8bed'),\n('ar', '\u963f\u62c9\u4f2f\u8bed'),\n)\n</code></pre> <pre><code># \u6c49\u8bed \u4e0a\u6d77\u65f6\u533a\nLANGUAGE_CODE = 'zh-hans'\n</code></pre> <p><code>LocaleMiddleware</code>\u5fc5\u987b\u5728<code>Session</code>\u4e4b\u540e\uff0c\u56e0\u4e3a\u8bed\u8a00\u533a\u57df\u6765\u6e90\u4e8e<code>session</code>\u4e2d\u7684\u8bbe\u7f6e\uff0c\u5fc5\u987b\u5728<code>CommonMiddleware</code>\u4e4b\u524d\uff0c\u56e0\u4e3a<code>CommonMiddleware</code>\u9700\u8981\u9009\u62e9\u4e00\u4e2a\u8bed\u8a00\u53bb\u53cd\u67e5url\u3002</p> <pre><code>MIDDLEWARE = [\n'django.contrib.sessions.middleware.SessionMiddleware',\n'django.middleware.locale.LocaleMiddleware',\n'django.middleware.common.CommonMiddleware',\n]\n</code></pre> <pre><code>LOCALE_PATHS = (\nos.path.join(BASE_DIR, \"locale/\"),\n)\n</code></pre>"},{"location":"python/django/django-translation/#1","title":"1. \u8bbe\u7f6e\u652f\u6301\u8bed\u8a00","text":""},{"location":"python/django/django-translation/#2_1","title":"2. \u8bbe\u7f6e\u9ed8\u8ba4\u8bed\u8a00","text":""},{"location":"python/django/django-translation/#3-localemiddlewaremiddleware","title":"3. \u6dfb\u52a0<code>LocaleMiddleware</code>\u81f3<code>MIDDLEWARE</code>\u4e2d","text":""},{"location":"python/django/django-translation/#4","title":"4. \u8bbe\u7f6e\u7ffb\u8bd1\u6587\u4ef6\u5b58\u50a8\u4f4d\u7f6e","text":""},{"location":"python/django/django-translation/#3","title":"3 \u6a21\u677f\u7ffb\u8bd1","text":"<ul> <li> <p>\u6240\u6709\u5f85\u7ffb\u8bd1html\u5fc5\u987b\u52a0\u5165<code>{% load i18n %}</code>\u6807\u7b7e\uff0c\u5373\u4f7f\u662f\u88abinclude\u7684\u7236html\u91cc\u52a0\u8f7d\u8fc7\u8be5\u6807\u7b7e\uff0c\u88abinclude\u7684html\u4f9d\u65e7\u9700\u8981\u52a0\u8f7d\u3002</p> </li> <li> <p>\u5355\u72ec\u6587\u5b57 <code>{% trans \"\u6211\u662f\u5f85\u7ffb\u8bd1\u6587\u5b57\" %}</code></p> </li> <li> <p>\u533a\u5757\u6587\u5b57</p> <pre><code>{% blocktrans with year=product.publish_time|date:'Y' %}\n    {{ year }}\u5e74\u4e0a\u5e02\n{% endblocktrans %}\n</code></pre> </li> <li> </li> <li> </li> </ul> <p>\u5b89\u88c5django-rosetta\u63d2\u4ef6\uff0c\u5373\u53ef\u5728admin\u4e2d\u770b\u5230rosetta\u9762\u677f\uff0c\u8fdb\u5165\u5373\u53ef\u5bf9\u751f\u6210\u7684\u5f85\u7ffb\u8bd1\u7684<code>django.po</code>\u6587\u4ef6\u8fdb\u884c\u7ffb\u8bd1\uff0c\u65e0\u9700\u518d\u5728\u4ee3\u7801\u4e2d\u7ffb\u8bd1\u3002</p> <p>\u6216\u8005\u76f4\u63a5\u5728\u4ee3\u7801\u4e2d\u6253\u5f00<code>django.po</code>\u6587\u4ef6\u8fdb\u884c\u7ffb\u8bd1\u3002</p> <ul> <li> </li> <li> </li> </ul> <pre><code>{% blocktrans count news.view_times as news_view_times %}\n    \u67e5\u770b\u6b21\u6570:{{ news_view_times }}\n{% plural %}\n    \u67e5\u770b\u6b21\u6570:{{ news_view_times }}\n{% endblocktrans %}\n</code></pre> <p>\u4e00\u4e2a\u672a\u53d1\u73b0\u539f\u56e0\u7684Bug,0\u4f1a\u88ab\u8bc6\u522b\u4e3a\u590d\u6570\uff0c\u6682\u672a\u627e\u5230\u89e3\u51b3\u65b9\u6cd5\uff0c\u53ef\u89c1\u6b64\u5904\u3002</p>"},{"location":"python/django/django-translation/#1_1","title":"1. \u7b80\u5355\u7ffb\u8bd1\u8bed\u6cd5","text":""},{"location":"python/django/django-translation/#2-django-admin-makemessages-alldjangopo","title":"2. \u8fd0\u884c<code>django-admin makemessages --all</code>\u751f\u6210\u5f85\u7ffb\u8bd1\u7684<code>django.po</code>\u6587\u4ef6\u3002","text":""},{"location":"python/django/django-translation/#3-djangopo","title":"3. \u7ffb\u8bd1<code>django.po</code>\u6587\u4ef6","text":""},{"location":"python/django/django-translation/#4-django-admin-compilemessagesdjangopodjangomo","title":"4. \u8fd0\u884c<code>django-admin compilemessages</code>\u547d\u4ee4\u7f16\u8bd1\u7ffb\u8bd1\u597d\u7684<code>django.po</code>\u6587\u4ef6\u4ee5\u751f\u6210<code>django.mo</code>\u6587\u4ef6\u3002","text":""},{"location":"python/django/django-translation/#5","title":"5. \u590d\u6570\u7ffb\u8bd1","text":""},{"location":"python/django/django-translation/#4_1","title":"4 \u5185\u5bb9\u7ffb\u8bd1","text":"<pre><code>from django.db import models\nfrom hvad.models import TranslatableModel, TranslatedFields\nclass Demo(TranslatableModel):\ntranslations = TranslatedFields(\n# \u6807\u9898\ntitle=models.CharField(max_length=100,\nverbose_name=u'\u6807\u9898'),\n)\nclass Meta:\nverbose_name = 'Demo'\nverbose_name_plural = 'Demo'\nordering = ('-id',)\ndef trans_title(self):\nreturn self.lazy_translation_getter('title', str(self.id))\ndef __str__(self):\ntitle = self.trans_title()\nreturn title if title else ''\n</code></pre> <pre><code>from django import forms\nfrom hvad.admin import TranslatableModelForm\nfrom .models import *\nclass DemoForm(TranslatableModelForm):\ndef __init__(self, *args, **kwargs):\nsuper(ExhibitForm, self).__init__(*args, **kwargs)\nself.fields['title'].widget.attrs.update({'class': 'form-control'})\nclass Meta:\nmodel = Exhibit\nfields = ['title']\n</code></pre> <p>serializers.py</p> <pre><code>from rest_framework import serializers\nfrom hvad.contrib.restframework import TranslatableModelSerializer\nfrom .models import *\nclass DemoSerializer(TranslatableModelSerializer):\nclass Meta:\nmodel = Demo\nfields = ['title']\n</code></pre> <pre><code>class DemoAllListView(ListView):\ntemplate_name = 'demo/list_all.html'\ncontext_object_name = 'demo_list'\npaginate_by = settings.PAGE_NUM\ndef get_queryset(self):\nreturn Demo.objects.language('all').order_by('-id')\n</code></pre> <pre><code>class DemoListView(ListView):\nqueryset = Demo.objects.language().order_by('-id')\ntemplate_name = 'demo/list_lang.html'\ncontext_object_name = 'demo_list'\npaginate_by = settings.PAGE_NUM\n</code></pre> <pre><code>class DemoCreateView(CreateView):\nform_class = DemoForm\ntemplate_name = 'demo/create.html'\nsuccess_url = reverse_lazy('demo_list')\n</code></pre> <pre><code>class DemoDetailView(DetailView):\nqueryset = Demo.objects.language().all()\nslug_field = 'id'\ntemplate_name = 'demo/detail.html'\n</code></pre>"},{"location":"python/django/django-translation/#1-django-hvad","title":"1. \u5b89\u88c5django-hvad","text":""},{"location":"python/django/django-translation/#2-modelspy","title":"2. models.py","text":""},{"location":"python/django/django-translation/#3-formspy","title":"3. forms.py","text":""},{"location":"python/django/django-translation/#4-django-rest-framework","title":"4. \u5982\u679c\u4f7f\u7528django rest framework\uff0c\u4e0d\u4f7f\u7528\u8bf7\u5ffd\u7565\u672c\u90e8\u5206\u3002","text":""},{"location":"python/django/django-translation/#5_1","title":"5. \u5168\u90e8\u8bed\u8a00\u5217\u8868","text":""},{"location":"python/django/django-translation/#6","title":"6. \u5f53\u524d\u8bed\u8a00\u5217\u8868","text":""},{"location":"python/django/django-translation/#7","title":"7. \u521b\u5efa\u5f53\u524d\u8bed\u8a00\u7684\u5bf9\u8c61","text":""},{"location":"python/django/django-translation/#8","title":"8. \u67e5\u770b\u5f53\u524d\u8bed\u8a00\u7684\u5bf9\u8c61\u8be6\u60c5","text":""},{"location":"python/django/django-translation/#9-i18n_patternsdemotitletitle","title":"9. \u8def\u7531\u4e2d\u8bbe\u7f6e\u4e86i18n_patterns\u65f6\uff0c\u5f53\u524d\u83b7\u53d6\u5230\u7684<code>{{demo.title}}</code>\u65e2\u662f\u5bf9\u5e94\u8bed\u8a00\u7684title\u3002","text":""},{"location":"python/django/django-translation/#5-url","title":"5 url\u8bbe\u7f6e","text":"<pre><code>from django.conf.urls.i18n import i18n_patterns\nurlpatterns += i18n_patterns(\nurl(r'^', include('web.urls')),\nprefix_default_language=False,\n)\n# \u8bbe\u7f6erosetta\u652f\u6301\nif 'rosetta' in settings.INSTALLED_APPS:\nurlpatterns += [\nurl(r'^rosetta/', include('rosetta.urls')),\n]\n</code></pre> <p><code>prefix_default_language</code>\u4e3a<code>False</code>\u65f6\uff0c\u9ed8\u8ba4\u8bed\u8a00\u4e0d\u518d\u51fa\u73b0\u5728url\u4e2d\u3002</p>"},{"location":"python/django/django-translation/#6-url","title":"6 \u53ef\u76f4\u63a5\u5207\u6362\u5f53\u524durl\u8bed\u8a00\u7684\u6807\u7b7e","text":"<p><code>web/templatetags/translate_url.py</code> :</p> <pre><code>from django.template import Library\nfrom django.urls.exceptions import Resolver404\nfrom django.core.urlresolvers import resolve, reverse\nfrom django.utils.translation import activate, get_language\nfrom urllib.parse import urlencode\nregister = Library()\n@register.simple_tag(takes_context=True)\ndef translate_url(context, lang=None, *args, **kwargs):\n\"\"\"\n    \u5c06\u5f53\u524d\u9875\u9762url\u8f6c\u6362\u81f3\u5176\u4ed6\u8bed\u8a00\u7684url\n    \u7528\u6cd5: {% translate_url language.code %}\n    \"\"\"\n# request \u5bf9\u8c61\nrequest = context['request']\n# \u5f53\u524d\u8bed\u8a00\u73af\u5883\ncur_language = get_language()\ntry:\n# \u6839\u636e\u5f53\u524durl\u68c0\u7d22url\u522b\u540d\nurl_parts = resolve(request.path)\n# \u6fc0\u6d3b\u6b32\u8f6c\u6362\u7684\u8bed\u8a00\u73af\u5883\nactivate(lang)\n# \u6839\u636eurl\u522b\u540d\u68c0\u7d22\u51fa\u5bf9\u5e94\u8bed\u8a00\u73af\u5883\u7684url\nurl = reverse(url_parts.url_name, args=url_parts.args, kwargs=url_parts.kwargs)\n# \u4fdd\u6301request parameters\u4e0d\u4e22\u5931\nparameters = urlencode(request.GET, doseq=True)\nif parameters:\nurl = '{}?{}'.format(url, parameters)\nexcept Resolver404:\n# \u672a\u68c0\u7d22\u5230\u5219\u8fd4\u56de\u4e3b\u9875\nurl = '/'\nfinally:\n# \u8fd8\u539f\u81f3\u5f53\u524d\u8bed\u8a00\u73af\u5883\nactivate(cur_language)\nreturn url\n</code></pre> <p>\u4f7f\u7528\u65b9\u6cd5\uff1a</p> <p><code>navbar.html</code>:</p> <pre><code>{% load translate_url %}\n&lt;div class=\"head_bg\"&gt;\n&lt;div class=\"container\"&gt;\n&lt;div class=\"row\"&gt;\n&lt;div class=\"nav_language_select\"&gt;\n                {% get_language_info_list for current_languages as languages %}\n                    &lt;div class=\"col-md-2 col-sm-3 col-xs-5 text-right nav_language_div\"&gt;\n&lt;div class=\"nav_language_div2\"&gt;\n                        {% get_language_info_list for current_languages as languages %}\n                        {% for language in languages %}\n                            {% if not forloop.first %}\n                                &lt;span&gt;/&lt;/span&gt;\n                            {% endif %}\n                            {% ifequal LANGUAGE_CODE language.code %}\n                                &lt;a href=\"{% translate_url language.code %}\" class='nav_color_active'&gt;\n                                    {{ language.name_local }}\n                                &lt;/a&gt;\n                            {% else %}\n                                &lt;a href=\"{% translate_url language.code %}\"&gt;\n                                    {{ language.name_local }}\n                                &lt;/a&gt;\n                            {% endifequal %}\n                        {% endfor %}\n                    &lt;/div&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n</code></pre>"},{"location":"python/django/django-translation/#qa","title":"Q&amp;A","text":"<ul> <li>Q:\u8fd0\u884c <code>django-admin makemessages --all</code> \u547d\u4ee4\u540e\u63d0\u793a<code>can't find msguniq. make sure you have gnu gettext tools 0.15 or newer installed.</code>\uff08window7 django1.11.1\uff09</li> </ul> <p>A\uff1a\u524d\u5f80\u6b64\u5904\u4e0b\u8f7d\u8f6f\u4ef6\u5305\u89e3\u538b\uff0c\u5e76\u8bbe\u7f6e\u5176\u5b50bin\u76ee\u5f55\u81f3\u73af\u5883\u53d8\u91cf\u3002</p> <ul> <li>Q:\u8fd0\u884c <code>django-admin compilemessages</code> \u547d\u4ee4\u540e\uff0cdjango\u63d0\u793a<code>ValueError: plural forms expression could be dangerous</code></li> </ul> <p>A\uff1a\u4fee\u6539\u751f\u6210\u7684django.po\u6587\u4ef6\u4e2d\u7684<code>\"Plural-Forms: nplurals=INTEGER; plural=EXPRESSION;\\n\"\u4e3a\"Plural-Forms: nplurals=1; plural=0;\\n\"</code>\u5373\u53ef\u3002</p> <ul> <li>Q:zh_Hans\u547d\u540d\u95ee\u9898</li> </ul> <p>A\uff1asetting\u4e2d<code>LANGUAGE_CODE = 'zh_Hans'</code>,locale\u4e2d\u6587\u4ef6\u5939\u540d\u79f0\u672azh_Hans,\u5176\u4f59\u5730\u65b9\u7528zh-hans,\u5982\uff1a</p> <pre><code>LANGUAGES = (\n('en', 'English'),\n('zh-hans', 'Chinese'),\n)\n</code></pre> <p>\u5177\u4f53\u539f\u56e0\u53c2\u89c1\u4e0b\u5217 <code>lang2locale</code> \u51fd\u6570\uff0c\u505a\u4e86\u5982\u4e0b\u64cd\u4f5c\uff1aBasically, for our Chinese language codes, the - is replaced with a _, and the first letter of the second word is capitalized(\u53ea\u5728\u540e\u4e00\u4e2a\u5355\u8bcd\u957f\u5ea6\u5927\u4e8e2\u7684\u65f6\u5019\u8f6c\u6362).</p> <pre><code>def to_locale(language, to_lower=False):\n\"\"\"\n    Turns a language name (en-us) into a locale name (en_US). If 'to_lower' is\n    True, the last component is lower-cased (en_us).\n    \"\"\"\np = language.find('-')\nif p &gt;= 0:\nif to_lower:\nreturn language[:p].lower() + '_' + language[p + 1:].lower()\nelse:\n# Get correct locale for sr-latn\nif len(language[p + 1:]) &gt; 2:\nreturn language[:p].lower() + '_' + language[p + 1].upper() + language[p + 2:].lower()\nreturn language[:p].lower() + '_' + language[p + 1:].upper()\nelse:\nreturn language.lower()\n</code></pre> <ul> <li>Q:\u52a0\u5165django-rosetta\u540e\u51fa\u73b0\u59822\u4e2d\u63cf\u8ff0\u7684\u95ee\u9898</li> </ul> <p>A:\u627e\u5230rosetta\u5b89\u88c5\u76ee\u5f55\uff0c\u63092\u4e2d\u89e3\u51b3\u65b9\u6cd5\u4fee\u6539<code>rosetta/locale/en/LC_MESSAGE/django.po</code>\u6587\u4ef6\u5373\u53ef\u3002</p> <ul> <li>Q:\u9700\u8981\u53ea\u751f\u6210\u67d0\u4e2aapp\u7684locale\u6587\u4ef6</li> </ul> <p>A:\u9700\u8981\u8fdb\u5165\u8be5app\u76ee\u5f55\u540e\u518d\u6267\u884c<code>makemessages</code>\u547d\u4ee4\uff0c<code>makemessages</code>\u547d\u4ee4\u4f1a\u751f\u6210\u5f53\u524d\u6267\u884c\u547d\u4ee4\u7684\u6587\u4ef6\u5939\u53ca\u5b50\u6587\u4ef6\u5939\u4e2d\u7684\u6240\u6709<code>locale</code>\u6587\u4ef6\u3002\u6240\u4ee5\u5728\u6839\u76ee\u5f55\u6267\u884c<code>makemessages</code>\u547d\u4ee4\u4f1a\u51fa\u73b0<code>CommandError: Unable to find a locale path to store translations for file Porject\\__init__.py</code>\u7684\u9519\u8bef\u3002</p> <ul> <li>Q:\u7ffb\u8bd1\u540e\u7684\u5185\u5bb9\u4e0d\u5b9e\u65f6\u751f\u6548</li> </ul> <p>A:\u91cd\u542f\u670d\u52a1\u5668\u7ffb\u8bd1\u5185\u5bb9\u624d\u80fd\u751f\u6548</p>"},{"location":"python/django/django-translation/#_1","title":"\u76f8\u5173\u77e5\u8bc6","text":"<ol> <li>Django\u51b3\u5b9a\u5f53\u524d\u8bed\u8a00\u7684\u987a\u5e8f\uff08\u4f7f\u7528LocaleMiddleware\u7684\u60c5\u51b5\u4e0b\uff0c\u672a\u4f7f\u7528\u5219\u4f18\u5148\u4f7f\u7528LANGUAGE_CODE\uff09\uff1a</li> </ol> <pre><code>    \u4f7f\u7528i18_patterns\u65f6\uff0c\u5c06\u4f18\u5148\u5339\u914durl\u4e2d\u7684\u8bed\u8a00\u4ee3\u7801\u3002\n    \u6ca1\u6709\u8bed\u8a00\u4ee3\u7801\uff0c\u4f7f\u7528session\u4e2d\u7684LANGUAGE_SESSION_KEY\u3002\n    \u6ca1\u6709session\uff0c\u68c0\u7d22cookie\u4e2d\u7684django_language\u53c2\u6570\uff0c\u8be5\u53c2\u6570\u4f7f\u7528LANGUAGE_COOKIE_NAME\u8bbe\u7f6e\u3002\n    \u6ca1\u6709cookie,\u4f7f\u7528http\u8bf7\u6c42\u5934\u4e2d\u7684Accept-Language\u3002\n    \u6ca1\u6709Accept-Language\u8bf7\u6c42\u5934\uff0c\u5219\u4f7f\u7528\u7cfb\u7edf\u9ed8\u8ba4\u8bbe\u7f6e\u7684LANGUAGE_CODE\u3002\n</code></pre> <ol> <li> <p><code>locale name</code> \u548c <code>language code</code>\u4e0d\u540c\uff0c<code>locale name</code>\u662f\u6df7\u5408\u4e86\u8bed\u8a00\u4e0e\u57ce\u5e02\u7684\u7b80\u5199\uff0c\u8bed\u8a00\u90e8\u5206\u603b\u662f\u5c0f\u5199\uff0c\u57ce\u5e02\u90e8\u5206\u603b\u662f\u5927\u5199\uff0c\u7528\u4e0b\u5212\u7ebf\u8fde\u63a5\uff0c\u5982it,deAT,es,ptBR\u7b49;language\u603b\u662f\u5c0f\u5199\uff0c\u7528\u7834\u5219\u53f7\u8fde\u63a5\uff0c\u5982it\uff0cde-at,es,ot-br\u3002</p> </li> <li> <p><code>django-admin compilemessages --settings=path.to.settings</code> \u53ea\u7f16\u8bd1\u8bbe\u7f6e\u4e2d\u8bbe\u7f6e\u7684LOCALE_PATHS\u4e2d\u7684\u8bed\u8a00\u6587\u4ef6\u3002</p> </li> <li> <p>Django\u9ed8\u8ba4\u5047\u8bbe\u7528\u6237\u4f7f\u7528\u7684\u53ef\u7ffb\u8bd1\u7684\u9879\u76ee\u7684\u57fa\u7840\u8bed\u8a00\u4e3a\u82f1\u6587\uff0c\u4e0d\u4f7f\u7528\u82f1\u6587\u4f7f\u7528\u82f1\u6587\u505a\u4e3a\u57fa\u7840\u8bed\u8a00\u65f6\uff08\u8be6\u89c1\u6b64\u5904\uff09\uff0c\u9700\u8981\u6ce8\u610f\uff1a gettext \u65b9\u6cd5\u4e3a\u539f\u59cb\u8bed\u8a00\u53ea\u63d0\u4f9b\u4e86\u4e24\u79cd\u590d\u6570\u5f62\u5f0f\uff0c\u6240\u4ee5\u4f60\u9700\u8981\u4e3a\u5176\u4ed6\u590d\u6570\u5f62\u5f0f\u4e0d\u540c\u4e8e\u82f1\u8bed\u7684\u8bed\u8a00\u63d0\u4f9b\u590d\u6570\u5f62\u5f0f\u89c4\u5219\u3002\u5f53\u5176\u4ed6\u82f1\u6587\u7684\u5b50\u8bed\u8a00\u88ab\u4f7f\u7528\u5e76\u4e14\u82f1\u6587\u7ffb\u8bd1\u7f3a\u5931\u65f6\uff0c\u8fd4\u56de\u7684\u8bed\u8a00\u4e0d\u4f1a\u662fLANGUAGE_CODE\u91cc\u9762\u7684\u8bed\u8a00\uff0c\u800c\u662f\u5176\u539f\u59cb\u8bed\u8a00\u3002\u4f8b\u5982\uff0c\u4e00\u4e2a\u82f1\u6587\u7528\u6237\u8bbf\u95ee\u4e00\u4e2a\u897f\u73ed\u7259\u8bed\u4f5c\u4e3a\u9ed8\u8ba4\u8bed\u8a00\u7684\u7f51\u7ad9\uff0c\u5176\u539f\u59cb\u5b57\u7b26\u662f\u4f7f\u7528\u4fc4\u8bed\u5199\u7684\uff0c\u90a3\u4e48\u4ed6\u5c06\u770b\u5230\u7684\u662f\u4fc4\u8bed\u800c\u4e0d\u662f\u897f\u73ed\u7259\u8bed\u3002</p> </li> <li> <p>\u4f7f\u7528 <code>USE_L10N = True</code> \u53ef\u4ee5\u542f\u7528formatting system\uff0c\u6839\u636e\u8bed\u8a00\u533a\u57df\u5bf9\u9875\u9762\u663e\u793a\u683c\u5f0f\u505a\u51fa\u4e2a\u6027\u5316\u9002\u914d\u3002</p> </li> <li> <p>Internationalization\uff0ci \u548c n \u4e4b\u95f4\u6709 18 \u4e2a\u5b57\u6bcd\uff0c\u7b80\u79f0 I18N\u3002\u672c\u5730\u5316 -- localization\uff0c l \u548c n \u4e4b\u95f4\u6709 10 \u4e2a\u5b57\u6bcd\uff0c\u7b80\u79f0 L10N\u3002\u56fd\u9645\u5316\u610f\u5473\u7740 Web\u4ea7\u54c1\u6709\u9002\u7528\u4e8e\u4efb\u4f55\u5730\u65b9\u7684\u6f5c\u529b\uff0c\u9488\u5bf9\u7a0b\u5e8f\u5f00\u53d1\u4eba\u5458\uff1b\u672c\u5730\u5316\u5219\u662f\u6307\u4f7f\u4e00\u4e2a\u56fd\u9645\u5316\u7684\u7a0b\u5e8f\u4e3a\u4e86\u5728\u67d0\u4e2a\u7279\u5b9a\u5730\u533a\u4f7f\u7528\u800c\u8fdb\u884c\u5b9e\u9645\u7ffb\u8bd1\u7684\u8fc7\u7a0b\uff0c\u9488\u5bf9\u7ffb\u8bd1\u4eba\u5458\u800c\u8a00\u3002</p> </li> </ol>"},{"location":"python/django/django-wysiwyg/","title":"Django\u5bcc\u6587\u672c\u7f16\u8f91\u5668(wysiwyg)\u5bf9\u6bd4","text":""},{"location":"python/django/django-wysiwyg/#1django-summernote","title":"1\u3001django-summernote","text":"<ul> <li>\u652f\u6301Admin\u548c\u7a97\u53e3\u4f7f\u7528</li> <li>\u53ef\u81ea\u7531\u65b9\u6cd5\u7f29\u5c0f\u7a97\u53e3</li> <li>\u53ef\u76f4\u63a5\u4e0a\u4f20\u56fe\u7247</li> <li>\u53ef\u63d2\u5165youtube\u548cyouku\u89c6\u9891\u94fe\u63a5</li> <li>\u5168\u5c4f\u7f16\u8f91\u65f6\u6709\u65e0\u6cd5\u4e0a\u4f20\u56fe\u7247\u7684bug\u5f85\u89e3\u51b3</li> <li>\u53ef\u5728modelForm\u4e2d\u4f7f\u7528</li> <li>\u53ef\u6307\u5b9acss</li> <li>\u652f\u6301\u4e2d\u6587</li> <li>\u4e0d\u53ef\u4e0a\u4f20\u6587\u4ef6\u3002</li> </ul>"},{"location":"python/django/django-wysiwyg/#2django-redactor","title":"2\u3001django-redactor","text":"<ul> <li>\u652f\u6301admin\u548c\u7a97\u53e3\u4f7f\u7528</li> <li>\u4e0d\u53ef\u81ea\u7531\u65b9\u6cd5\u7f29\u5c0f\u7a97\u53e3</li> <li>\u53ef\u4e0a\u4f20\u56fe\u7247\u548c\u6587\u4ef6</li> <li>\u4e0d\u53ef\u5168\u5c4f\u7f16\u8f91\u7a97\u53e3</li> <li>\u53ef\u5728modelForm\u4e2d\u4f7f\u7528</li> <li>\u4e0d\u53ef\u6307\u5b9acss</li> <li>\u652f\u6301\u4e2d\u6587</li> <li>\u4e0d\u53ef\u63d2\u5165\u89c6\u9891\u94fe\u63a5</li> </ul>"},{"location":"python/django/django-wysiwyg/#3django-tinymce","title":"3\u3001django-tinymce","text":"<ul> <li>\u529f\u80fd\u4e30\u5bcc</li> <li>\u4e0d\u652f\u6301\u56fe\u7247\u4e0a\u4f20\u529f\u80fd</li> <li>\u652f\u6301\u4e2d\u6587</li> <li>\u652f\u6301\u89c6\u9891\u7a97\u53e3\u5927\u5c0f\u7f16\u8f91</li> </ul>"},{"location":"python/django/django-wysiwyg/#4django-froala-editor","title":"4\u3001django-froala-editor","text":"<ul> <li>\u529f\u80fd\u4e30\u5bcc</li> <li>\u53ef\u4e0a\u4f20\u56fe\u7247\u3001\u6587\u4ef6</li> <li>\u4e0d\u652f\u6301youku\u89c6\u9891</li> <li>\u6536\u8d39 \u4f46\u754c\u9762\u7f8e\u89c2\u7cbe\u81f4</li> </ul>"},{"location":"python/django/fabric/","title":"Fabric\u90e8\u7f72\u3001\u7ef4\u62a4","text":"<p>Fabric\u7684\u5e94\u7528\u8303\u56f4\u662f\u81ea\u52a8\u5316\u8fd0\u7ef4\uff0c\u53ef\u4ee5\u8ba9\u4ee5\u5f80\u9700\u8981ssh\u94fe\u63a5\u5230\u8fdc\u7a0b\u670d\u52a1\u5668\u6267\u884c\u7684\u90e8\u7f72\u3001\u66f4\u65b0\u547d\u4ee4\u5199\u5165\u811a\u672c\u4e2d\u81ea\u52a8\u5b8c\u6210\uff0c\u5927\u5927\u964d\u4f4e\u9879\u76ee\u90e8\u7f72\u3001\u7ef4\u62a4\u7684\u6210\u672c\uff0c \u5b98\u65b9\u6587\u6863\uff1ahttp://www.fabfile.org/\u3002</p> <p>\u6307\u5b9a<code>hosts</code>:</p> <pre><code>from fabric.api import *\nenv.hosts = ['dreamgo@192.168.1.102:22', ]\nenv.passwords = {\n'dreamgo@192.168.1.102:22': 'dreamgo',\n}\n# &gt;fab -H dreamgo@192.168.1.10:22 host_type\n@hosts('dreamgo@192.168.1.102:22')\ndef host_type():\nwith cd('/django/SchoolMS_Server/SchoolMS'):\nrun('uname -s')\nrun('service apache2 reload')\n</code></pre> <p>\u6307\u5b9a<code>roles</code>:</p> <pre><code>from fabric.api import *\nenv.roledefs = {\n'test_server': ['dreamgo@192.168.1.102:22'],\n}\nenv.passwords = {\n'dreamgo@192.168.1.102:22': 'dreamgo',\n}\n# &gt;fab -R test_server host_type\n@roles('test_server')\ndef host_type():\nwith cd('/django/SchoolMS_Server/SchoolMS'):\nrun('uname -s')\nrun('service apache2 reload')\n</code></pre> <p><code>Django</code>\u5237\u65b0\u7a0b\u5e8f\u547d\u4ee4\uff1a</p> <pre><code>from fabric.api import *\nfrom contextlib import contextmanager as _contextmanager\nenv.roledefs = {\n'test_server': ['dreamgo@192.168.1.102:22'],\n}\nenv.passwords = {\n'dreamgo@192.168.1.102:22': 'dreamgo',\n}\nenv.directory = '/django/SchoolMS_Server/'\nenv.activate = 'source environment/bin/activate'\n@_contextmanager\ndef virtualenv():\nwith cd(env.directory):\nwith prefix(env.activate):\nyield\n@roles('test_server')\ndef update():\nwith virtualenv():\nrun('git pull origin master')\nrun('python manage.py makemigrations')\nrun('python manage.py migrate')\nrun('deactivate')\nrun('service apache2 reload')\n</code></pre> <p>\u6267\u884c\u7ed3\u679c\uff1a</p> <pre><code>(environment) C:\\django\\SchoolMS\\SchoolMS&gt;fab update\n[dreamgo@192.168.1.102:22] Executing task 'update'\n[dreamgo@192.168.1.102:22] run: git pull origin master\n[dreamgo@192.168.1.102:22] out: \u6765\u81ea https://git.coding.net/name/xxxx.git\n[dreamgo@192.168.1.102:22] out:  * branch            master     -&gt; FETCH_HEAD\n[dreamgo@192.168.1.102:22] out: \u66f4\u65b0 94bdffc..6e43223\n[dreamgo@192.168.1.102:22] out: Fast-forward\n[dreamgo@192.168.1.102:22] out:  SchoolMS/fabfile.py | 30 ?[32m++++++++++++++++++++++++++++++?[m\n[dreamgo@192.168.1.102:22] out:  requirements.txt    |  3 ?[32m++?[m?[31m-?[m\n[dreamgo@192.168.1.102:22] out:  2 files changed, 32 insertions(+), 1 deletion(-)\n[dreamgo@192.168.1.102:22] out:  create mode 100644 SchoolMS/fabfile.py\n[dreamgo@192.168.1.102:22] out:\n\n[dreamgo@192.168.1.102:22] run: python manage.py makemigrations\n[dreamgo@192.168.1.102:22] out: No changes detected\n[dreamgo@192.168.1.102:22] out:\n\n[dreamgo@192.168.1.102:22] run: python manage.py migrate\n[dreamgo@192.168.1.102:22] out: ?[36;1mOperations to perform:?[0m\n[dreamgo@192.168.1.102:22] out: ?[1m  Apply all migrations: ?[0madmin, auth....\n[dreamgo@192.168.1.102:22] out: ?[36;1mRunning migrations:?[0m\n[dreamgo@192.168.1.102:22] out:   No migrations to apply.\n[dreamgo@192.168.1.102:22] out:\n\n[dreamgo@192.168.1.102:22] run: deactivate\n[dreamgo@192.168.1.102:22] run: service apache2 reload\n[dreamgo@192.168.1.102:22] out:  * Reloading web server apache2\n[dreamgo@192.168.1.102:22] out:  *\n[dreamgo@192.168.1.102:22] out:\n\nDone.\nDisconnecting from dreamgo@192.168.1.102... done.\n</code></pre> <p>\u521b\u5efa\u6570\u636e\u5e93\u7684\u4e24\u79cd\u65b9\u6cd5\uff1a</p> <pre><code>run('echo \"drop database if exists {};\"|mysql --batch --user=root --password'.format(env.db), pty=True)\nrun('echo \"create database {} default character set utf8;\"|mysql --batch --user=root --password'.format(env.db),\n    pty=True)\n\nrun('mysql -uroot -p -e \"drop database if exists {}\"'.format(env.db))\nrun('mysql -uroot -proot -e \"CREATE DATABASE {} DEFAULT CHARACTER set utf8\"'.format(env.db))\n</code></pre> <p>\u5e38\u7528\u547d\u4ee4\uff1a</p> <pre><code>fab -R [role_name] \u51fd\u6570\u540d\u79f0\nfab -H [host_name] \u51fd\u6570\u540d\u79f0\n</code></pre> <p>\u5c0f\u6280\u5de7\uff1a</p> <ul> <li>passwords\u6307\u5b9a\u4e3a''\u65f6\u8fd0\u884c\u547d\u4ee4\u65f6\u4f1a\u63d0\u793a\u8f93\u5165\u5bc6\u7801\u3002</li> <li>\u8fdc\u7a0b\u670d\u52a1\u5668\u4e3a<code>python2</code>\u548c<code>python3</code>\u5171\u5b58\uff0c\u4ee5<code>python3</code>\u4e3a\u9ed8\u8ba4<code>python</code>\u7684\u670d\u52a1\u5668\uff0c\u4f7f\u7528\u547d\u4ee4<code>python2 -m pip install Fabric</code>\u6765\u5b89\u88c5\u3002\u672c\u5730\u670d\u52a1\u5668\u53ea\u6709<code>python3</code>\u73af\u5883\uff0c\u4f7f\u7528\u547d\u4ee4<code>pip install Fabric3</code>\u6765\u5b89\u88c5\u3002</li> <li>Fabric3 \u7684<code>requirements.txt</code>\u5e94\u5199\u4e3a<code>Fabric3==1.13.1.post1</code>\u3002</li> <li>\u53ea\u9700\u8981\u672c\u5730\u5b89\u88c5Fabric\u5373\u53ef\uff0c\u4e0d\u8981\u6c42\u8fdc\u7a0b\u4e5f\u5b89\u88c5Fabric(\u6240\u4ee5\u65e0\u9700\u628a<code>Fabric3==1.13.1.post1</code>\u5199\u5165<code>requirements.txt</code>\u6587\u4ef6)\u3002</li> </ul> <p>Django<code>\u5e38\u7528\u7684\u90e8\u7f72\u3001\u66f4\u65b0\u811a\u672c</code>fabfile.py<code>(\u63a8\u8350\u653e\u7f6e\u5728</code>manage.py`\u6240\u5728\u7684\u6839\u76ee\u5f55)\uff1a</p> <pre><code>from fabric.api import *\nfrom fabric.contrib import django, files\nfrom contextlib import contextmanager as _contextmanager\ndjango.settings_module('NingTe.settings')\nfrom django.conf import settings\n_ = settings.INSTALLED_APPS\nenv.roledefs = {\n'test_server': ['dreamgo@192.168.1.102:22'],\n}\nenv.passwords = {\n'dreamgo@192.168.1.102:22': '',\n}\n# \u9879\u76ee\u5b58\u653e\u76ee\u5f55\nenv.directory = '/django/portal/'\n# \u865a\u62df\u73af\u5883\u76ee\u5f55 \u4ece\u9879\u76ee\u6839\u76ee\u5f55\u7b97\u8d77 environment\u4e3a\u9ed8\u8ba4\u7684\u865a\u62df\u73af\u5883\u6587\u4ef6\u5939\u540d\u79f0\nenv.activate = 'source environment/bin/activate'\n# git\u4ed3\u5e93\u5730\u5740\nenv.repo = ''\nenv.db = settings.DATABASES['default']['NAME']\n@_contextmanager\ndef virtualenv():\nwith cd(env.directory):\nwith prefix(env.activate):\nyield\n# \u6570\u636e\u5e93\u3001\u76ee\u5f55\u3001\u514b\u9686\u4ee3\u7801\u3001\u73af\u5883\u5b89\u88c5\u3001\u63d2\u4ef6\u5b89\u88c5\u3001\u8fc1\u79fb\u6570\u636e\u5e93\u3001\u521b\u5efa\u8d85\u7ba1\n# &gt;fab create \u4e00\u952e\u90e8\u7f72\n@roles('test_server')\ndef create():\nrun('mysql -uroot -p -e \"drop database if exists {}\"'.format(env.db))\nrun('mysql -uroot -p -e \"create database {} default character set utf8\"'.format(env.db))\nrun('rm -rf {}'.format(env.directory))\nrun('mkdir {}'.format(env.directory))\nrun('git clone {} {}'.format(env.repo, env.directory))\nwith cd(env.directory):\nrun('virtualenv environment')\nwith virtualenv():\nrun('pip install -r requirements.txt -i https://pypi.douban.com/simple')\nrun('python manage.py makemigrations')\nrun('python manage.py migrate')\nrun('python manage.py createsuperuser --username=username --email=ykh@dreamgo.tech')\nrun('deactivate')\n# \u62c9\u53d6\u4ee3\u7801\u3001\u8fc1\u79fb\u6570\u636e\u5e93\u3001\u91cd\u8f7dApache\n# &gt;fab update \u4e00\u952e\u7ef4\u62a4\n@roles('remote_server')\ndef update():\nwith virtualenv():\nrun('git stash')\nrun('git pull')\nrun('git stash pop')\nrun('pip install -r requirements.txt -i https://pypi.douban.com/simple')\nrun('python manage.py makemigrations')\nrun('python manage.py migrate')\nrun('deactivate')\nrun('service apache2 reload')\n# \u521b\u5efa\u5e76\u914d\u7f6eApache\u7684conf\u6587\u4ef6 server_name-\u57df\u540d\u6216IP environment\u4e3a\u9ed8\u8ba4\u7684\u865a\u62df\u73af\u5883\u6587\u4ef6\u5939\u540d\u79f0\n# &gt;fab apache_conf \u4e00\u952e\u914d\u7f6eApache\u8bbe\u7f6e\n@roles('test_server')\ndef apache_conf():\ndirectory = env.directory.rstrip('/')\nrun('chmod -R 777 {}'.format(env.directory))\nfile_path = '/etc/apache2/sites-available/'\nfilename = 'portal.conf'\nwith cd(file_path):\nrun('rm -f {}'.format(filename))\nrun('touch {}'.format(filename))\nserver_name = 'blog.dreamgotech.com'\napache_template = \\\n            '&lt;VirtualHost *:8001&gt;\\n' \\\n            '   ServerName {server_name}\\n' \\\n            '   ServerAdmin ykh@dreamgo.tech\\n' \\\n            '   DocumentRoot {document_root}\\n' \\\n            '   \\n' \\\n            '   Alias /static {document_root}/static \\n' \\\n            '   &lt;Directory {document_root}/static&gt;\\n' \\\n            '       Require all granted\\n' \\\n            '   &lt;/Directory&gt;\\n' \\\n            '   \\n' \\\n            '   Alias /media {document_root}/media\\n' \\\n            '   &lt;Directory {document_root}/media&gt; \\n' \\\n            '       Require all granted\\n' \\\n            '   &lt;/Directory&gt;\\n' \\\n            '   \\n' \\\n            '   &lt;Directory {document_root}/Portal&gt;\\n' \\\n            '       &lt;Files wsgi.py&gt;\\n' \\\n            '           Require all granted\\n' \\\n            '       &lt;/Files&gt;\\n' \\\n            '   &lt;/Directory&gt;\\n' \\\n            '   \\n' \\\n            '   WSGIPassAuthorization On\\n' \\\n            '   WSGIDaemonProcess {server_name} python-path={document_root} python-home={document_root}/environment \\n' \\\n            '   WSGIProcessGroup {server_name}\\n' \\\n            '   WSGIScriptAlias / {document_root}/Portal/wsgi.py\\n' \\\n            '   \\n' \\\n            '   ErrorLog {document_root}/log/error.log\\n' \\\n            '&lt;/VirtualHost&gt;\\n'.format(server_name=server_name, document_root=directory)\nfiles.append(filename, apache_template)\nrun('sudo a2dissite {}'.format(filename))\nrun('sudo a2ensite {}'.format(filename))\nrun('service apache2 reload')\n# usage:fab cmd:\"service apache2 reload\"\n@roles('test_server')\ndef cmd(cmd_str=''):\nrun(cmd_str)\n</code></pre>"},{"location":"python/django/html-email/","title":"Django\u53d1\u9001Html\u90ae\u4ef6","text":"<p>Django\u53d1\u9001\u6587\u5b57\u90ae\u4ef6</p> <pre><code>message = \"\".join([\nu\"\u3010{}\u3011\u60a8\u672c\u6b21\u64cd\u4f5c\u7684\u9a8c\u8bc1\u7801\u5982\u4e0b:{}\\n\\n\".format(email_verify.get_purpose_display(),\nemail_verify.code),\nu\"\u5982\u679c\u8fd9\u4e0d\u662f\u60a8\u672c\u4eba\u7684\u64cd\u4f5c\uff0c\u8bf7\u5ffd\u7565\u672c\u90ae\u4ef6!\\n\",\nu\"DreamGo\u5b98\u7f51\uff1ahttp://{}\\n\\n\".format('www.dreamgo.tech'),\n\"\u8c22\u8c22!\\n\",\n\"\u5357\u4eac\u8bd7\u8fdc\u542f\u8d26\u6237\u56e2\u961f\\n\",\n])\nfrom_email = 'verify@dreamgo.tech'\ntry:\nsend_mail('DreamGo\u8d26\u6237\u90ae\u7bb1\u8ba4\u8bc1', message, from_email, [tel_email])\nreturn success_response('\u90ae\u4ef6\u5df2\u53d1\u9001')\nexcept Exception as e:\nreturn error_response(5, '\u90ae\u4ef6\u53d1\u9001\u5931\u8d25 \u539f\u56e0\uff1a' + str(e))\n</code></pre> <p>Django\u53d1\u9001Html\u90ae\u4ef6</p> <p>\u65b9\u6cd51\uff1a</p> <pre><code>from django.template.loader import get_template\nfrom django.core.mail import EmailMessage\nmessage = get_template('page.html').render({\n'bg_url': bg_url,\n})\nmsg = EmailMessage(subject, message, to=[to], from_email=from_email)\nmsg.content_subtype = 'html'\nmsg.send()\n</code></pre> <p>\u65b9\u6cd52\uff1a</p> <pre><code>from django.core.mail import EmailMultiAlternatives\nfrom django.template.loader import render_to_string\nsubject, from_email, to = get_value(settings.SITE_NAME), 'DreamGoTech@dreamgo.tech', '614457662@qq.com'\nmsg_html = render_to_string('page.html', context={\n'bg_url': bg_url,\n}, request=request)\nmsg = EmailMultiAlternatives(subject, '', 'Dreamgo&lt;verify@dreamgo.tech&gt;', [to])\nmsg.attach_alternative(msg_html, \"text/html\")\nmsg.send()\n</code></pre> <p>\u4f7f\u7528\u65b9\u6cd52\u53d1\u9001\u5e26\u9759\u6001\u6587\u4ef6\u7684Html</p> <pre><code>bg_url = request.build_absolute_uri('/static/images/email_verify_head.jpg')\nuser_name = request.user.get_full_name() if request.user.is_authenticated else ''\nmsg_html = render_to_string('email/verify.html', context={\n'bg_url': bg_url,\n'user_name': user_name,\n'verify_purpose': email_verify.get_purpose_display(),\n'verify_code': email_verify.code,\n'verify_duration': email_verify.duration,\n'current_time': datetime.now().date()\n}, request=request)\nsubject = '{} {}'.format(get_value(settings.SITE_NAME), email_verify.get_purpose_display())\nmsg = EmailMultiAlternatives(subject, '', settings.DEFAULT_FROM_EMAIL, [tel_email])\nmsg.attach_alternative(msg_html, \"text/html\")\ntry:\nmsg.send()\nreturn success_response('\u90ae\u4ef6\u5df2\u53d1\u9001')\nexcept Exception as e:\nreturn error_response(5, '\u90ae\u4ef6\u53d1\u9001\u5931\u8d25 \u539f\u56e0\uff1a' + str(e))\n</code></pre> <p>\u9759\u6001\u6587\u4ef6\u4f7f\u7528request.build_absolute_uri\u65b9\u6cd5\u83b7\u53d6\u7edd\u5bf9\u8def\u5f84\uff0c\u5728html\u4e2d\u4f7f\u7528\u683c\u5f0f\u4e3a</p> <pre><code>&lt;div class=\"header\"&gt;\n&lt;img src=\"{{ bg_url }}\" /&gt;\n&lt;/div&gt;\n</code></pre> <p>Email\u4e2dhtml\u8bed\u6cd5\u7684\u7279\u6b8a\u8981\u6c42</p> <p>Html\u5728\u53d1\u9001\u90ae\u4ef6\u65f6\uff0cGmail\u4e0d\u652f\u6301\u6807\u7b7e\u4e2d\u7684background\u5b9e\u73b0\uff0c\u4f1a\u5bfc\u81f4\u56fe\u7247\u65e0\u6cd5\u52a0\u8f7d\u3002\u5177\u4f53\u652f\u6301\u8bed\u6cd5\u60c5\u51b5\u53ef\u81f3\u6b64\u5904\u67e5\u770b\u3002 <p>\u4e00\u822c\u6765\u8bf4\uff0cemail\u4e2d\u7684html\u6709\u5982\u4e0b\u51e0\u70b9\u8981\u6c42\uff1a</p> <p>\u4e0d\u53ef\u4ee5:</p> <ul> <li>Include a  section with styles. Apple Mail.app supports it, but Gmail and Hotmail do not, so it's a no-no. Hotmail will support a style section in the body but Gmail still doesn't. <li>Link to an external stylesheet. Not many email clients support this, best to just forget it.</li> <li>Background-image / Background-position. Gmail is also the culprit on this one.</li> <li>Clear your floats. Gmail again.</li> <li>Margin. Yep, seriously, Hotmail ignores margins. Basically any CSS positioning at all doesn't work.</li> <li>Font-anything. Chances are Eudora will ignore anything you try to declare with fonts.</li> <p>\u53ea\u53ef\u4ee5\u4f7f\u7528inline styles\u6765\u5b8c\u6210Html\u6837\u5f0f\u5b9e\u73b0.</p> <p>https://css-tricks.com/using-css-in-html-emails-the-real-story/</p> <p>\u53d1\u4ef6\u90ae\u7bb1\u8bbe\u7f6e\u522b\u540d\u663e\u793a\uff1a</p> <p>\u8bbe\u7f6esend_email\u65b9\u6cd5\u7684from_user\u4e3a</p> <pre><code>'DreamGo&lt;verify@dreamgo.tech&gt;'\n</code></pre> <p>&lt;&gt;\u91cc\u5fc5\u987b\u4e3a\u81ea\u5df1\u7684\u53d1\u4ef6\u90ae\u7bb1\u5730\u5740\uff0c\u524d\u9762\u4e3a\u771f\u6b63\u663e\u793a\u5728\u5ba2\u6237\u7aef\u7684\u90ae\u7bb1\u522b\u540d\u3002</p> <p></p>"},{"location":"python/django/nginx-uwsgi/","title":"Nginx+uWsgi\u90e8\u7f72Django","text":""},{"location":"python/django/nginx-uwsgi/#_1","title":"\u5b89\u88c5","text":"<pre><code>sudo apt-get install nginx\nsudo apt-get install python3-pip\n# pip3 install uwsgi\npython3.6 -m pip install uwsgi\n</code></pre>"},{"location":"python/django/nginx-uwsgi/#_2","title":"\u914d\u7f6e","text":"<ol> <li>\u62f7\u8d1d<code>uwsgi_params</code>\uff1a</li> </ol> <pre><code>#\u5c06uwsgi_params\u62f7\u8d1d\u5230django\u9879\u76ee\u6587\u4ef6\u5939\u4e0b\ncp /etc/nginx/uwsgi_params project_folder/django/\n</code></pre> <ol> <li><code>project_nginx.conf</code>\uff1a</li> </ol> <pre><code># the upstream component nginx needs to connect to\nupstream django {\nserver unix:///django/TisaneMS/mysite.sock; # for a file socket\n#server 127.0.0.1:8001; # for a web port socket (we'll use this first)\n}\n# configuration of the server\nserver {\n# the port your site will be served on\nlisten 8000;\n# the domain name it will serve for\nserver_name 192.168.1.2; # substitute your machine's IP address or FQDN\ncharset utf-8;\n# max upload size\nclient_max_body_size 75M; # adjust to taste\n# Django media\nlocation /media {\nalias /django/TisaneMS/media; # your Django project's media files - amend as required\n}\nlocation /static {\nalias /django/TisaneMS/static; # your Django project's static files - amend as required\n}\n# Finally, send all non-media requests to the Django server.\nlocation / {\nuwsgi_pass django;\ninclude /django/TisaneMS/uwsgi_params; # the uwsgi_params file you installed\n}\n}\n</code></pre> <ol> <li>\u4f7f\u7528\u8f6f\u94fe\u63a5\u5f00\u542f\u7ad9\u70b9\uff1a</li> </ol> <pre><code>sudo ln -s /path/to/your/mysite/project_nginx.conf /etc/nginx/sites-enabled/\n</code></pre> <ol> <li>\u914d\u7f6e\u6587\u4ef6 <code>project_uwsgi.ini</code>\uff1a</li> </ol> <pre><code>[uwsgi]\n# Django-related settings the base directory (full path)\nchdir = /django/TisaneMS\n# Django's wsgi file\nmodule = TisaneMS.wsgi\n# the virtualenv (full path)\nhome = /django/TisaneMS/environment\n# process-related settings master\nmaster = true\n# maximum number of worker processes\nprocesses = 4\n# \u591a\u7ebf\u7a0b\u652f\u6301\nenable-threads = true\n# the socket (use the full path to be safe\nsocket = /django/TisaneMS/mysite.sock\n# ... with appropriate permissions - may be needed chmod-socket = 664 clear environment on exit\n</code></pre> <ol> <li>\u8fd0\u884c<code>uwsgi</code>:</li> </ol> <pre><code>uwsgi --ini project_uwsgi.ini\n</code></pre> <p>\u751f\u4ea7\u73af\u5883\u4e0b\u9700\u8981\u4f7f\u7528<code>nohup command &amp;</code>\u6216\u8005<code>supervisord</code>\u6765\u8fd0\u884c\u8be5\u547d\u4ee4\u4ee5\u4fdd\u8bc1\u5176\u4e00\u76f4\u5904\u4e8e\u540e\u53f0\u8fd0\u884c\u7684\u72b6\u6001\u3002</p>"},{"location":"python/django/nginx-uwsgi/#https","title":"Https\u652f\u6301","text":"<p>\u57fa\u7840\u914d\u7f6e\uff1a</p> <pre><code>server {\nlisten 80;\nlisten [::]:80;\nserver_name demo.example.com;\nreturn 301 https://$server_name$request_uri;\n}\nserver {\nlisten 443;\nserver_name demo.example.com;\nssl on;\nssl_certificate /etc/nginx/cert/materia_tisane_cn/1542222634451.pem;\nssl_certificate_key /etc/nginx/cert/materia_tisane_cn/1542222634451.key;\nroot /django/Materia_Web;\nindex index.html;\n}\n</code></pre> <p>\u5982\u679c\u63d0\u793akey\u4e0d\u5339\u914d\uff0c\u53ef\u4f7f\u7528openssl\u5de5\u5177\u6838\u5bf9\uff1a</p> <pre><code>openssl x509 -noout -modulus -in demo.crt | openssl md5\nopenssl rsa -noout -modulus -in demo.key | openssl md5\n</code></pre>"},{"location":"python/django/nginx-uwsgi/#_3","title":"\u5e76\u53d1","text":"<p>\u8bbe\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\u4e3at(\u5355\u4f4d\u4e3a\u6beb\u79d2), \u5e76\u53d1\u91cf\u4e3ac\uff0c\u6bcf\u79d2\u5904\u7406\u8bf7\u6c42\u6570\u4e3aq\uff0c\u5219\uff1a</p> <pre><code>q = (1000/t) * c \n</code></pre>"},{"location":"python/django/nginx-uwsgi/#_4","title":"\u8d1f\u8f7d\u5747\u8861","text":"<p>Nginx\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e</p>"},{"location":"python/django/nginx-uwsgi/#uwsgitop","title":"<code>uwsgitop</code>\u72b6\u6001\u76d1\u63a7","text":"<p>\u8fd9\u662f\u4e00\u4e2a\u7528\u4e8e\u67e5\u770b<code>uwsgi</code>\u8fd0\u884c\u72b6\u6001\u7684\u63d2\u4ef6\uff0c\u8be6\u7ec6\u6587\u6863\u89c1uwsgi at githb\u3002</p>"},{"location":"python/django/nginx-uwsgi/#note","title":"Note","text":"<ul> <li> <p>\u53ef\u80fd\u9700\u8981\u4fee\u6539<code>/etc/nginx/nginx.conf</code>\u4e2d\u7684<code>user</code>\u81f3<code>root</code>.</p> </li> <li> <p>Nginx\u548cuWsgi\u4e4b\u95f4\u6709Web Socket\u548cFile Socket\u4e24\u79cd\u901a\u8baf\u65b9\u6cd5\uff0c\u63a8\u8350\u4f7f\u7528File Socket\u3002</p> </li> <li> <p>\u5168\u5c40\u5b89\u88c5uwsgi\u65f6\uff0c\u9700\u8981\u7248\u672c\u9ed8\u8ba4\u7684python\u7248\u672c\u548cvirtualenv\u5bf9\u5e94\u7684\u7248\u672c\u76f8\u540c\uff0c\u4e0d\u7136\u4f1a\u51fa\u73b0\u53ef\u4ee5\u5728virtualenv\u4e2d\u5f00\u542fuwsgi\u800c\u4e0d\u53ef\u5168\u5c40\u5f00\u542fuwsgi\u7684\u9519\u8bef\uff0c\u62a5\u9519\u4fe1\u606f\u4e3a\uff1a</p> </li> </ul> <pre><code>Traceback (most recent call last):\nFile \"./TisaneMS/wsgi.py\", line 12, in &lt;module&gt;\nfrom django.core.wsgi import get_wsgi_application\nImportError: No module named 'django'\n</code></pre> <p>\u82e5\u5168\u5c40python\u7248\u672c\u548cvirtualenv\u5bf9\u5e94\u7684python\u7248\u672c\u4e0d\u540c\uff0c\u53ef\u7528\u4ee5\u4e0b\u547d\u4ee4\u6307\u5b9a\u5b89\u88c5\u65f6\u4f7f\u7528\u7684py\u7248\u672c\uff1a</p> <p>pip is bundled with Python &gt; 3.4</p> <p>On Unix-like systems use:</p> <pre><code>    python3.6 -m pip install [Package_to_install]\n</code></pre> <p>On a Windows system use:</p> <pre><code>    py -m pip install [Package_to_install]\n</code></pre> <p>\u53ef\u4ee5\u4f7f\u7528 <code>uwsgi --python-version</code> \u67e5\u770b\u5f53\u524d\u7f16\u8bd1<code>uwsgi</code>\u4f7f\u7528\u7684<code>python</code>\u7248\u672c</p> <ul> <li>\u5f00\u542f\u7ad9\u70b9\u4e00\u822c\u4f7f\u7528\u8f6f\u94fe\u63a5\u7684\u65b9\u5f0f\u5c06<code>sites-available</code>\u76ee\u5f55\u4e0b\u7684conf\u6587\u4ef6\u94fe\u63a5\u5230<code>sites-enabled</code>\u76ee\u5f55\u4e0b\u3002</li> </ul> <pre><code>ln -s /etc/nginx/sites-available/tisanepms_web.conf /etc/nginx/sites-enabled/\n</code></pre> <ul> <li>\u914d\u7f6e\u9759\u6001\u7f51\u7ad9(\u5982VUE)</li> </ul> <pre><code>server {\nlisten 80;\nserver_name clinicis.tisane.cn;\nroot /django/TisanePMS_Web;\nindex index.html;\n}\n</code></pre> <ul> <li>uwsgi.ini\u53c2\u6570\u8bf4\u660e</li> </ul> <p>threads help: run each worker in prethreaded mode with the specified number of threads</p> <p>processes help: spawn the specified number of workers/processes</p> <ul> <li>\u5f00\u542f\u7ad9\u70b9\u65f6\u751f\u6210\u7684\u6587\u4ef6\u65e0\u6cd5\u8bfb\u53d6\uff08\u5e26\u4e2d\u6a2a\u7ebf\uff09 \u8def\u5f84\u5fc5\u987b\u7531\u6839\u76ee\u5f55\u5f00\u59cb</li> </ul> <pre><code>sudo ln -s /etc/nginx/sites-available/materia_wechat.conf /etc/nginx/sites-enabled/\n</code></pre> <ul> <li>nginx\u914d\u7f6e\u5c5e\u6027</li> </ul> <p><code>client_max_body_size 50m;</code>\u9879\u662f\u7528\u4e8e\u8bbe\u7f6e http \u8bf7\u6c42\u7684 body \u6700\u5927\u5927\u5c0f\u3002\u5982\u679c\u4f60\u7684\u7a0b\u5e8f\u4e2d\u6709\u6587\u4ef6\u4e0a\u4f20\u7684\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u6839\u636e\u81ea\u8eab\u60c5\u51b5\u6765\u8bbe\u7f6e\u5141\u8bb8\u4e0a\u4f20\u6587\u4ef6\u7684\u6700\u5927\u503c\u3002</p> <ul> <li>invalid request block size: 4126 (max 4096)</li> </ul> <p>uwsgi\u8bbe\u7f6e<code>buffer-size=32768\uff1b</code>\uff0c\u8be6\u89c1StackOverflow\u3002</p> <ul> <li>\u79c1\u6709\u6587\u4ef6\u4fdd\u62a4</li> </ul> <p>\u5982\u8be5\u6587\u4ef6\u5939\u540d\u79f0\u4e3a <code>protected</code>,\u793a\u4f8b\u4ee3\u7801\u5982\u4e0b\uff1a</p> <pre><code>file_path = os.path.join(settings.BASE_DIR, 'protected/')\nfile_name = os.path.join(settings.BASE_DIR, 'protected/stock.xlsx')\nif not os.path.exists(file_path):\nos.mkdir(file_path)\nwb.save(file_name)\nwb.close()\nfile = open(file_name, 'rb').read()\nif settings.DEBUG:\nresponse = HttpResponse(file, content_type='application/force-download')\nelse:\nresponse = HttpResponse(content_type='application/force-download')\nresponse['X-Accel-Redirect'] = '/protected/stock.xlsx'\nresponse['Content-Disposition'] = 'attachment; filename={}'.format(urlquote('ExcelDemo.xlsx'))\nreturn response\n</code></pre> <p>Nginx\u914d\u7f6e\u4e3a\uff1a</p> <pre><code>location /protected/ {\ninternal;\nalias /django/Materia/protected/;\n}\n</code></pre> <p>\u82e5\u4e0b\u8f7d\u6587\u4ef6\u65f6\u51fa\u73b0CORS\u9519\u8bef\uff0cNginx\u914d\u7f6e\u8bf7\u4fee\u6539\u4e3a\uff1a</p> <pre><code>location /protected/ {\ninternal;\nadd_header Access-Control-Allow-Origin *;\nalias /django/Materia/protected/;\n}\n</code></pre> <p>\u4ee5\u5141\u8bb8\u8f6c\u53d1\u7684\u8bf7\u6c42\u5934\u8fdb\u884c\u8de8\u57df\u8bbf\u95ee\u3002</p> <ul> <li>Access Log\u8bb0\u5f55\u8bf7\u6c42\u7528\u65f6</li> </ul> <p>\u9ed8\u8ba4\u7684<code>log_format</code>\u4e3a\uff1a</p> <pre><code>    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                  '$status $body_bytes_sent \"$http_referer\" '\n                  '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n</code></pre> <p><code>log_format</code>\u53ef\u9009\u53c2\u6570\u5982\u4e0b\uff1a</p> <pre><code>\u53c2\u6570                      \u8bf4\u660e                                         \u793a\u4f8b\n$remote_addr             \u5ba2\u6237\u7aef\u5730\u5740                                    211.28.65.253\n$remote_user             \u5ba2\u6237\u7aef\u7528\u6237\u540d\u79f0                                --\n$time_local              \u8bbf\u95ee\u65f6\u95f4\u548c\u65f6\u533a                                18/Jul/2012:17:00:01 +0800\n$request                 \u8bf7\u6c42\u7684URI\u548cHTTP\u534f\u8bae                           \"GET /article-10000.html HTTP/1.1\"\n$http_host               \u8bf7\u6c42\u5730\u5740\uff0c\u5373\u6d4f\u89c8\u5668\u4e2d\u4f60\u8f93\u5165\u7684\u5730\u5740\uff08IP\u6216\u57df\u540d\uff09     www.wang.com 192.168.100.100\n$status                  HTTP\u8bf7\u6c42\u72b6\u6001                                  200\n$upstream_status         upstream\u72b6\u6001                                  200\n$body_bytes_sent         \u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\u6587\u4ef6\u5185\u5bb9\u5927\u5c0f                        1547\n$http_referer            url\u8df3\u8f6c\u6765\u6e90                                   https://www.baidu.com/\n$http_user_agent         \u7528\u6237\u7ec8\u7aef\u6d4f\u89c8\u5668\u7b49\u4fe1\u606f                           \"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; SV1; GTB7.0; .NET4.0C;\n$ssl_protocol            SSL\u534f\u8bae\u7248\u672c                                   TLSv1\n$ssl_cipher              \u4ea4\u6362\u6570\u636e\u4e2d\u7684\u7b97\u6cd5                               RC4-SHA\n$upstream_addr           \u540e\u53f0upstream\u7684\u5730\u5740\uff0c\u5373\u771f\u6b63\u63d0\u4f9b\u670d\u52a1\u7684\u4e3b\u673a\u5730\u5740     10.10.10.100:80\n$request_time            \u6574\u4e2a\u8bf7\u6c42\u7684\u603b\u65f6\u95f4                               0.205\n$upstream_response_time  \u8bf7\u6c42\u8fc7\u7a0b\u4e2d\uff0cupstream\u54cd\u5e94\u65f6\u95f4                    0.002\n</code></pre> <p>\u4fee\u6539\u4e3a\uff1a</p> <pre><code>log_format timed_combined '$remote_addr - $remote_user [$time_local] '\n    '\"$request\" $status $body_bytes_sent '\n    '\"$http_referer\" \"$http_user_agent\" '\n    '$request_time $upstream_response_time $pipe';\n</code></pre> <p>\u6700\u540e\u7684<code>Nginx</code>\u914d\u7f6e\uff1a</p> <pre><code>log_format timed_combined '$remote_addr - $remote_user [$time_local] '\n'\"$request\" $status $body_bytes_sent '\n'\"$http_referer\" \"$http_user_agent\" '\n'$request_time $upstream_response_time $pipe';\n# configuration of the server\nserver {\n# the port your site will be served on\nlisten 80;\naccess_log /django/log/access.log timed_combined;\n...\n}\n</code></pre> <p>\u8fd9\u6837\u5373\u53ef\u5728<code>access_log</code>\u4e2d\u770b\u5230\u6b64\u6b21\u8bf7\u6c42\u7684\u5904\u7406\u65f6\u957f\u3002</p>"},{"location":"python/django/order-id/","title":"Django\u8ba2\u5355\u7f16\u53f7\u751f\u6210","text":"<p>\u8fc4\u4eca\u4e3a\u6b62\u5728\u9879\u76ee\u4e2d\u9047\u5230\u4e09\u79cd\u8ba2\u5355\u7f16\u53f7\u751f\u6210\u9700\u6c42\uff0c\u5206\u522b\u7528\u4e8e\u4e0d\u540c\u7684\u73af\u5883\u3002</p>"},{"location":"python/django/order-id/#_1","title":"\u9700\u6c42\u4e00","text":"<p>\u8ba2\u5355\u53f7\u89c4\u5219\u4e3a\u524d\u7f00+\u5c3e\u7f00\uff0c\u524d\u7f00\u53ef\u4ee5\u52a8\u6001\u4fee\u6539\uff0c\u5c3e\u7f00\u4e3a3\u52305\u4f4d\u9012\u589e\u6570\u5b57\u3002\u8fd9\u79cd\u89c4\u5219\u5e38\u7528\u4e8e\u5458\u5de5\u3001\u8bbe\u5907\u7b49\u8303\u56f4\u8f83\u5c0f\u7684\u7f16\u53f7\u3002</p> <p>\u9700\u8981\u501f\u52a9\u4e00\u4e2a\u5e8f\u53f7\u751f\u6210\u5668\u6765\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\uff0c\u63a8\u8350\u4f7f\u7528django-sequences\u3002\u672c\u6587\u5e76\u672a\u76f4\u63a5\u4f7f\u7528<code>django-sequences</code>\uff0c\u800c\u662f\u5bf9\u5176\u8fdb\u884c\u6539\u9020\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a</p> <p>models.py</p> <pre><code>\"\"\"\n \u53c2\u8003 \u5e93django-sequences\n \u5730\u5740:https://github.com/aaugustin/django-sequences\n\"\"\"\nfrom django.db import models\n# \u5e8f\u5217\u5668\nclass Sequence(models.Model):\n# \u540d\u79f0\nname = models.CharField(max_length=255,\nprimary_key=True,\nverbose_name='\u540d\u79f0')\n# \u6700\u8fd1\u503c\nlast = models.PositiveIntegerField(verbose_name='\u6700\u8fd1\u503c')\n# \u65f6\u95f4\ntime = models.DateTimeField(verbose_name='\u65f6\u95f4')\nclass Meta:\nverbose_name = '\u5e8f\u5217\u5668'\nverbose_name_plural = '\u5e8f\u5217\u5668'\ndef __str__(self):\nreturn '[{}] name={} last={}'.format(self.time, self.name, self.last)\n</code></pre> <p>utils.py:</p> <pre><code>def get_next_value(sequence_name):\nnow = timezone.now()\nsequence, created = Sequence.objects.get_or_create(name=sequence_name,\ndefaults={'last': 0, 'time': now})\n# \u83b7\u53d6\u4e0b\u4e00\u4e2a\u6700\u65b0\u503c\nsequence.last += 1\nsequence.time = now\nsequence.save()\nreturn sequence.last\ndef get_next_no(sequence_name, suffix_format, prefix=None):\nnow = timezone.now()\nsequence, created = Sequence.objects.get_or_create(name=sequence_name,\ndefaults={'last': 0, 'time': now})\n# \u83b7\u53d6\u4e0b\u4e00\u4e2a\u6700\u65b0\u503c\nnext_value = sequence.last + 1\n# \u5c3e\u7f00\nif suffix_format == 1:\nsuffix = '{:01}'.format(next_value)\nelif suffix_format == 2:\nsuffix = '{:02}'.format(next_value)\nelif suffix_format == 3:\nsuffix = '{:03}'.format(next_value)\nelif suffix_format == 4:\nsuffix = '{:04}'.format(next_value)\nelif suffix_format == 5:\nsuffix = '{:05}'.format(next_value)\nelse:\nsuffix = '{}'.format(next_value)\n# \u751f\u6210\u7f16\u53f7\nif prefix is not None:\nno = '{}{}'.format(prefix, suffix)\nelse:\nno = suffix\n# \u66f4\u65b0\u5e8f\u5217\u5668\nsequence.last += 1\nsequence.time = now\nsequence.save()\nreturn no\n</code></pre> <p>\u4f7f\u7528DRF\u65b0\u589e\u65f6\uff0c\u5e8f\u53f7\u4ea7\u751f\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <p>constance.py:</p> <pre><code>STAFF_PREFIX = 'staff_prefix'\nSTAFF_SUFFIX = 'staff_suffix'\nCONSTANCE_CONFIG = OrderedDict([\n# \u5de5\u53f7\n(STAFF_PREFIX, ('Staff', '\u5de5\u53f7\u56fa\u5b9a\u4ee3\u7801')),\n(STAFF_SUFFIX, (3, '\u5de5\u53f7\u5c3e\u7f00', 'suffix_select')),\n])\nCONSTANCE_CONFIG_FIELDSETS = OrderedDict([\n('\u5458\u5de5', (STAFF_PREFIX, STAFF_SUFFIX)),\n])\n</code></pre> <p>models.py</p> <pre><code># \u5458\u5de5\nclass Staff(models.Model):\n# \u5de5\u53f7\nno = models.CharField(max_length=255,\nunique=True,\nverbose_name='\u5de5\u53f7')\n</code></pre> <p>serializers.py</p> <pre><code># \u521b\u5efa\u5458\u5de5\nclass StaffCreateSerializer(ModelSerializer):\nno = None\ndef validate(self, data):\nsuffix_format = int(get_value(settings.STAFF_SUFFIX))\nself.no = get_next_no('staff', suffix_format, prefix=get_value(settings.STAFF_PREFIX))\nwhile self.Meta.model.objects.filter(no=self.no).exists():\nself.no = get_next_no('staff', suffix_format, prefix=get_value(settings.STAFF_PREFIX))\nreturn data\nclass Meta:\nmodel = Staff\nfields = ('job_state', 'bank_no', 'social_security_no', 'on_job')\n</code></pre> <p>views.py:</p> <pre><code># \u5458\u5de5\nclass StaffViewSet(ModelViewSet):\n...\ndef perform_create(self, serializer):\nreturn serializer.save(no=serializer.no)\n</code></pre> <p>\u6574\u4f53\u601d\u8def\u4e3a\u4f7f\u7528\u5e8f\u53f7\u751f\u6210\u5668\u8bb0\u5f55\u5f53\u524d\u751f\u6210\u5230\u7684\u7f16\u53f7\uff0c\u4e4b\u540e\u6bcf\u6b21\u751f\u6210\u7f16\u53f7\u65f6\uff0c\u90fd\u8ba9\u5e8f\u53f7\u751f\u6210\u5668\u7ee7\u7eed\u751f\u6210\u4e0b\u4e00\u4e2a\u7f16\u53f7\uff0c\u82e5\u4e0b\u4e00\u4e2a\u7f16\u53f7\u672a\u88ab\u4f7f\u7528\uff0c\u5219\u4f7f\u7528\u8be5\u5e8f\u53f7\u4f5c\u4e3a\u5f53\u524d\u5b9e\u4f8b\u7684\u7f16\u53f7\u3002\u5e8f\u53f7\u751f\u6210\u9700\u8981\u5728<code>validate</code>\u4e2d\u6700\u540e\u8fdb\u884c\uff0c\u4ee5\u514d\u53d1\u751f\u5e8f\u53f7\u751f\u6210\u6210\u529f\u800c<code>validate</code>\u672a\u901a\u8fc7\u5bfc\u81f4\u7684\u7f16\u53f7\u6d6a\u8d39\u95ee\u9898\u3002\u7f16\u53f7\u751f\u6210\u6210\u529f\u65f6\uff0c\u5728<code>serializer.save()</code>\u65f6\u4fdd\u5b58\u81f3\u5b9e\u4f8b\u4e2d\u3002</p>"},{"location":"python/django/order-id/#_2","title":"\u9700\u6c42\u4e8c","text":"<p>\u8ba2\u5355\u53f7\u89c4\u5219\u4e3a \u524d\u7f00+\u65e5\u671f+\u65f6\u95f4+\u5c3e\u7f00\uff0c\u524d\u7f00\u8981\u6c42\u4e3a\u53ef\u52a8\u6001\u4fee\u6539\uff0c\u65e5\u671f\u9009\u9879\u6709(\"\u5e74+\u6708+\u65e5\", \"\u5e74+\u6708\", \"\u5e74\", \"\u5ffd\u7565\")\uff0c\u65f6\u95f4\u9009\u9879\u6709(\"\u65f6+\u5206+\u79d2\", \"\u65f6+\u5206\", \"\u65f6\", \"\u5ffd\u7565\")\uff0c\u5c3e\u7f00\u4e3a3\u52305\u4f4d\u6570\u5b57\u5e76\u4e14\u6bcf\u5929\u4ece1\u5f00\u59cb\u56de\u6eda\u3002</p> <p>constance.py:</p> <pre><code>CONSTANCE_ADDITIONAL_FIELDS = {\n'date_select': ['django.forms.fields.ChoiceField', {\n'widget': 'django.forms.Select',\n'choices': ((0, \"\u5e74+\u6708+\u65e5\"), (1, \"\u5e74+\u6708\"), (2, \"\u5e74\"), (3, \"\u5ffd\u7565\"))\n}],\n'time_select': ['django.forms.fields.ChoiceField', {\n'widget': 'django.forms.Select',\n'choices': ((0, \"\u65f6+\u5206+\u79d2\"), (1, \"\u65f6+\u5206\"), (2, \"\u65f6\"), (3, \"\u5ffd\u7565\"))\n}],\n'suffix_select': ['django.forms.fields.ChoiceField', {\n'widget': 'django.forms.Select',\n'choices': ((0, \"3\u4f4d\u6570\u5b57\"), (1, \"4\u4f4d\u6570\u5b57\"), (2, \"5\u4f4d\u6570\u5b57\"))\n}],\n}\nBALANCE_RECHARGE_FIX_CODE = 'balance_recharge_fix_code'\nBALANCE_RECHARGE_DATE_FORMAT = 'balance_recharge_date_format'\nBALANCE_RECHARGE_TIME_FORMAT = 'balance_recharge_time_format'\nBALANCE_RECHARGE_SUFFIX = 'balance_recharge_time_suffix'\nCONSTANCE_CONFIG = OrderedDict([\n# \u4f59\u989d\u5145\u503c\n(BALANCE_RECHARGE_FIX_CODE, ('YE-CZ', BALANCE_RECHARGE_FIX_CODE)),\n(BALANCE_RECHARGE_DATE_FORMAT, (0, BALANCE_RECHARGE_DATE_FORMAT, 'date_select')),\n(BALANCE_RECHARGE_TIME_FORMAT, (0, BALANCE_RECHARGE_TIME_FORMAT, 'time_select')),\n(BALANCE_RECHARGE_SUFFIX, (0, BALANCE_RECHARGE_SUFFIX, 'suffix_select')),\n])\nCONSTANCE_CONFIG_FIELDSETS = OrderedDict([\n('\u8d22\u52a1', (BALANCE_RECHARGE_FIX_CODE, BALANCE_RECHARGE_DATE_FORMAT,\nBALANCE_RECHARGE_TIME_FORMAT, BALANCE_RECHARGE_SUFFIX)),\n])\n</code></pre> <p>models.py</p> <pre><code>from datetime import datetime\n# \u4f59\u989d\u5145\u503c\nclass BalanceRecharge(models.Model):\n# \u7f16\u53f7\nno = models.CharField(unique=True,\nmax_length=255,\nnull=True,\nblank=True,\nverbose_name=u'\u7f16\u53f7')\n# \u7f16\u53f7\u5c3e\u7f00\nno_suffix = models.PositiveIntegerField(default=0,\nnull=True,\nblank=True,\nverbose_name=u'\u7f16\u53f7\u5c3e\u7f00')\ndef save(self, *args, **kwargs):\nif not self.pk:\n# \u6839\u636e\u56fa\u5b9a\u4ee3\u7801-\u65f6\u95f4\u683c\u5f0f\u751f\u6210\u7f16\u53f7\u524d\u7f00\ndate_format = int(get_value(settings.BALANCE_RECHARGE_DATE_FORMAT))\ntime_format = int(get_value(settings.BALANCE_RECHARGE_TIME_FORMAT))\nformatted_datetime = no_format_datetime(date_format, time_format)\nno = '{}{}'.format(get_value(settings.BALANCE_RECHARGE_FIX_CODE),\nformatted_datetime)\n# \u751f\u6210\u5f53\u5929\u7684\u9012\u589e\u7f16\u53f7\u5c3e\u7f00\nfirst = BalanceRecharge.objects.filter(create_time__day=datetime.now().day).order_by('-no_suffix').first()\nif first:\ncurrent_no_suffix = first.no_suffix if first.no_suffix else 0\nelse:\ncurrent_no_suffix = 0\nself.no_suffix = current_no_suffix + 1\n# \u6839\u636e\u524d\u7f00\u548c\u540e\u7f00\u6570\u5b57\u663e\u793a\u4e2a\u6570\u751f\u6210\u7f16\u53f7\nsuffix_format = int(get_value(settings.BALANCE_RECHARGE_SUFFIX))\nno_suffix = no_format_suffix(self.no_suffix, suffix_format)\nself.no = '{}{}'.format(self.no, no_suffix)\nreturn super(BalanceRecharge, self).save(*args, **kwargs)\n</code></pre> <p>utils.py:</p> <pre><code>def no_format_datetime(date_format, time_format):\n\"\"\"\n    :param date_format: 0 \u5e74\u6708\u65e5 1 \u5e74\u6708 2 \u5e74\n    :param time_format: 0 \u65f6\u5206\u79d2 2 \u65f6\u5206 3 \u65f6\n    :return: \u5bf9\u5e94\u65f6\u95f4\u683c\u5f0f\u7684\u7f16\u53f7\u7247\u6bb5\n    \"\"\"\nnow = datetime.now()\n# \u65e5\u671f\nif date_format == 0:\ntime_data = now.strftime('%Y%m%d')\nelif date_format == 1:\ntime_data = now.strftime('%Y%m')\nelif date_format == 2:\ntime_data = now.strftime('%Y')\nelse:\ntime_data = ''\n# \u65f6\u95f4\nif time_format == 0:\ntime_time = now.strftime('%H%M%S')\nelif time_format == 1:\ntime_time = now.strftime('%H%M')\nelif time_format == 2:\ntime_time = now.strftime('%H')\nelse:\ntime_time = ''\nreturn '{}{}'.format(time_data, time_time)\ndef no_format_suffix(no_suffix, suffix_format):\n\"\"\"\n    :param no_suffix: \u539f\u7f16\u53f7\u5c3e\u7f00\n    :param suffix_format: \u5c3e\u7f00\u683c\u5f0f 0-3\u4f4d\u6570\u5b57 1-4\u4f4d\u6570\u5b57 2-5\u4f4d\u6570\u5b57\n    :return: \u5bf9\u5e94\u683c\u5f0f\u7684\u7f16\u53f7\u5c3e\u7f00\n    \"\"\"\nif suffix_format == 0:\nno_suffix = '{:03}'.format(no_suffix)\nelif suffix_format == 1:\nno_suffix = '{:04}'.format(no_suffix)\nelif suffix_format == 2:\nno_suffix = '{:05}'.format(no_suffix)\nelse:\nno_suffix = '{:04}'.format(no_suffix)\nreturn no_suffix\n</code></pre> <p>\u6574\u4f53\u601d\u8def\u4e3a\u8bbe\u7f6e\u5c3e\u7f00\u4e3a<code>int</code>\u7c7b\u578b\uff0c\u7528\u4e8e\u8bb0\u5f55\u5f53\u524d\u751f\u6210\u7684\u4e3a\u5f53\u5929\u7b2c\u591a\u5c11\u4e2a\u8ba2\u5355\u3002\u5728\u5b9e\u4f8b\u88ab\u521b\u5efa\u65f6\uff0c\u5148\u83b7\u53d6\u524d\u7f00\u548c\u65f6\u95f4\u683c\u5f0f\u8fdb\u884c\u62fc\u63a5\uff0c\u518d\u67e5\u8be2\u5f53\u5929\u751f\u6210\u7684\u5c3e\u7f00\u6700\u5927\u503c\uff0c\u5c06\u5c3e\u7f00\u52a0\u4e00\u4f5c\u4e3a\u672c\u5b9e\u4f8b\u7684\u5c3e\u7f00\u3002\u518d\u683c\u5f0f\u5316\u5c3e\u7f00\u5230\u76f8\u5e94\u7684\u683c\u5f0f\uff0c\u7528\u524d\u7f00+\u65e5\u671f\u65f6\u95f4+\u5c3e\u7f00\u5373\u53ef\u5f97\u5230\u5f53\u524d\u8ba2\u5355\u53f7\u3002</p>"},{"location":"python/django/order-id/#_3","title":"\u9700\u6c42\u4e09","text":"<p>\u8ba2\u5355\u53f7\u89c4\u5219\u4e3a \u524d\u7f00+\u65e5\u671f\u65f6\u95f4+\u5c3e\u7f00\uff0c\u524d\u7f00\u8981\u6c42\u4e3a\u53ef\u52a8\u6001\u4fee\u6539\uff0c\u65e5\u671f\u65f6\u95f4\u9009\u9879\u6709(\"\u5e74\", \"\u6708\", \"\u65e5\", \"\u65f6\", \"\u5206\", \"\u79d2\")\uff0c\u5c3e\u7f00\u4e3a3\u52305\u4f4d\u6570\u5b57\uff0c\u5c3e\u7f00\u6839\u636e\u65e5\u671f\u65f6\u95f4\u9009\u9879\u7684\u7cbe\u5ea6\u6765\u5224\u65ad\u65f6\u5019\u56de\u6eda\u3002\u5982\u65e5\u671f\u65f6\u95f4\u9009\u62e9\u4e86\u65e5\uff0c\u5219\u5c3e\u7f00\u6bcf\u5929\u4ece1\u56de\u6eda\uff1b\u82e5\u65e5\u671f\u65f6\u95f4\u9009\u62e9\u4e86\u5206\uff0c\u5219\u5c3e\u7f00\u6bcf\u5206\u949f\u4ece1\u56de\u6eda\uff0c\u82e5\u5f53\u524d\u5206\u949f\u5c3e\u7f00\u751f\u6210\u81f35\uff0c\u4e0b\u4e00\u5206\u949f\u5c3e\u7f00\u4f9d\u65e7\u91cd\u65b0\u4ece1\u5f00\u59cb\u8ba1\u7b97\u3002</p> <p>constances.py</p> <pre><code>CONSTANCE_ADDITIONAL_FIELDS = {\n'datetime_select': ['django.forms.fields.ChoiceField', {\n'widget': 'django.forms.Select',\n'choices': ((0, \"\u5e74\"), (1, \"\u6708\"), (2, \"\u65e5\"), (3, \"\u65f6\"), (4, \"\u5206\"), (5, \"\u79d2\"))\n}],\n'suffix_select': ['django.forms.fields.ChoiceField', {\n'widget': 'django.forms.Select',\n'choices': ((3, \"3\u4f4d\u6570\u5b57\"), (4, \"4\u4f4d\u6570\u5b57\"), (5, \"5\u4f4d\u6570\u5b57\"))\n}],\n}\nALLOT_PREFIX = 'allot_prefix'\nALLOT_DATETIME = 'allot_datetime'\nALLOT_SUFFIX = 'allot_suffix'\nCONSTANCE_CONFIG = OrderedDict([\n# \u8c03\u62e8\u7ba1\u7406\n(ALLOT_PREFIX, ('Allot', '\u8c03\u62e8\u7ba1\u7406\u56fa\u5b9a\u4ee3\u7801')),\n(ALLOT_DATETIME, (4, '\u8c03\u62e8\u7ba1\u7406\u65f6\u95f4', 'datetime_select')),\n(ALLOT_SUFFIX, (3, '\u8c03\u62e8\u7ba1\u7406\u5c3e\u7f00', 'suffix_select')),\n])\nCONSTANCE_CONFIG_FIELDSETS = OrderedDict([\n('\u8c03\u62e8\u7533\u8bf7', (ALLOT_APPLY_PREFIX, ALLOT_APPLY_DATETIME, ALLOT_APPLY_SUFFIX)),\n])\n</code></pre> <p>models.py</p> <pre><code># \u8c03\u62e8\u7533\u8bf7\nclass AllotApply(models.Model):\n# \u4e1a\u52a1\u5355\u53f7\nno = models.CharField(max_length=255,\nunique=True,\nverbose_name='\u4e1a\u52a1\u5355\u53f7')\n</code></pre> <p>serializers.py</p> <pre><code># \u521b\u5efa\u8c03\u62e8\u7533\u8bf7\nclass AllotApplyCreateSerializer(ModelSerializer):\nno = None\ndef validate(self, data):\nprefix = get_value(settings.ALLOT_APPLY_PREFIX)\ndatetime_format = int(get_value(settings.ALLOT_APPLY_DATETIME))\nsuffix_format = int(get_value(settings.ALLOT_APPLY_SUFFIX))\nself.no = get_next_no('allot_apply', suffix_format, prefix=prefix, datetime_format=datetime_format)\nreturn data\nclass Meta:\nmodel = AllotApply\n</code></pre> <p>views.py:</p> <pre><code># \u8c03\u62e8\u7533\u8bf7\nclass AllotApplyViewSet(ModelViewSet):\n...\n# \u6267\u884c\u65b0\u589e\ndef perform_create(self, serializer):\nreturn serializer.save(no=serializer.no)\n</code></pre> <p>utils.py</p> <pre><code>def get_next_value(sequence_name):\nnow = timezone.now()\nsequence, created = Sequence.objects.get_or_create(name=sequence_name,\ndefaults={'last': 0, 'time': now})\n# \u83b7\u53d6\u4e0b\u4e00\u4e2a\u6700\u65b0\u503c\nsequence.last += 1\nsequence.time = now\nsequence.save()\nreturn sequence.last\ndef get_next_no(sequence_name, suffix_format, prefix=None, datetime_format=None):\nnow = timezone.now()\nnew_period = False\ndatetime_str = None\nsequence, created = Sequence.objects.get_or_create(name=sequence_name,\ndefaults={'last': 0, 'time': now})\nif datetime_format is not None:\n# \u662f\u5426\u5728\u540c\u4e00\u65f6\u95f4\u5468\u671f\nif datetime_format == 0:\ndatetime_str = now.strftime('%Y')\nif now.year != sequence.time.year:\nnew_period = True\nelif datetime_format == 1:\ndatetime_str = now.strftime('%Y%m')\nif (now.year != sequence.time.year) or (now.month != sequence.time.month):\nnew_period = True\nelif datetime_format == 2:\ndatetime_str = now.strftime('%Y%m%d')\nif now.date() != sequence.time.date():\nnew_period = True\nelif datetime_format == 3:\ndatetime_str = now.strftime('%Y%m%d%H')\nif (now.date() != sequence.time.date()) or (now.hour != sequence.time.hour):\nnew_period = True\nelif datetime_format == 4:\ndatetime_str = now.strftime('%Y%m%d%H%M')\nif (now.date() != sequence.time.date()) or (now.hour != sequence.time.hour) or \\\n                    (now.minute != sequence.time.minute):\nnew_period = True\nelif datetime_format == 5:\ndatetime_str = now.strftime('%Y%m%d%H%M%S')\nif (now.date() != sequence.time.date()) or (now.hour != sequence.time.hour) or \\\n                    (now.minute != sequence.time.minute) or (now.second != sequence.time.second):\nnew_period = True\n# \u83b7\u53d6\u4e0b\u4e00\u4e2a\u6700\u65b0\u503c\nnext_value = 1 if new_period else sequence.last + 1\n# \u5c3e\u7f00\nif suffix_format == 1:\nsuffix = '{:01}'.format(next_value)\nelif suffix_format == 2:\nsuffix = '{:02}'.format(next_value)\nelif suffix_format == 3:\nsuffix = '{:03}'.format(next_value)\nelif suffix_format == 4:\nsuffix = '{:04}'.format(next_value)\nelif suffix_format == 5:\nsuffix = '{:05}'.format(next_value)\nelse:\nsuffix = '{}'.format(next_value)\n# \u751f\u6210\u7f16\u53f7\nif prefix is not None:\nif datetime_format is not None:\nno = '{}{}{}'.format(prefix, datetime_str, suffix)\nelse:\nno = '{}{}'.format(prefix, suffix)\nelse:\nif datetime_format is not None:\nno = '{}{}'.format(datetime_str, suffix)\nelse:\nno = suffix\n# \u66f4\u65b0\u5e8f\u5217\u5668\nif new_period:\nsequence.last = 1\nelse:\nsequence.last += 1\nsequence.time = now\nsequence.save()\nreturn no\n</code></pre> <p>\u6574\u4f53\u601d\u8def\u540c\u9700\u6c42\u4e00\uff0c\u5bf9<code>get_next_no</code>\u65b9\u6cd5\u8fdb\u884c\u4e86\u4fee\u6539\uff0c\u4f7f\u5176\u80fd\u591f\u5224\u65ad\u5f53\u524d\u65f6\u95f4\u662f\u5426\u8fdb\u5165\u4e86\u4e0b\u4e00\u8f6e\u7684\u5c3e\u7f00\u5faa\u73af\u3002</p>"},{"location":"python/django/sitemap-rss-robots/","title":"Django\u641c\u7d22\u4f18\u5316sitemap\u3001RSS\u3001robots","text":""},{"location":"python/django/sitemap-rss-robots/#sitemapxml","title":"\u7ad9\u70b9\u5730\u56fe <code>sitemap.xml</code>","text":""},{"location":"python/django/sitemap-rss-robots/#_1","title":"\u7528\u9014","text":"<p>\u544a\u8bc9\u641c\u7d22\u5f15\u64ce\u7ad9\u70b9\u7684\u76ee\u5f55\u7ed3\u6784\uff0c\u65b9\u4fbf\u641c\u7d22\u5f15\u64ce\u6536\u5f55\u7ad9\u70b9\u3002</p>"},{"location":"python/django/sitemap-rss-robots/#_2","title":"\u5b9e\u73b0","text":"<p><code>urls.py</code>:</p> <pre><code>from django.contrib.sitemaps.views import sitemap\nfrom common.sitemaps import sitemaps\nurlpatterns = [\npath('', IndexView.as_view(), name='index'),\npath('admin/', admin.site.urls),\n...\npath('sitemap.xml', sitemap, {'sitemaps': sitemaps}, name='sitemap'),\n]\n</code></pre> <p><code>common/sitemaps.py</code>\uff1a</p> <pre><code>from django.contrib.sitemaps import Sitemap\nfrom django.urls import reverse_lazy\nfrom article.models import Article\nclass StaticViewSitemap(Sitemap):\npriority = 0.5\nchangefreq = 'weekly'\ndef items(self):\n# \u9759\u6001url\u7684name\nreturn ['index', 'article_index', 'article_all', 'news_index', 'user_login', 'user_register',\n'user_forget_pwd', 'version', 'rss']\ndef location(self, item):\nreturn reverse_lazy(item)\nclass ArticleSitemap(Sitemap):\npriority = 0.5\nchangefreq = 'weekly'\ndef items(self):\nreturn Article.objects.filter(is_public=True).all().order_by('-id')\ndef location(self, item):\nreturn reverse_lazy('article_detail', kwargs={'pk': item.id})\nsitemaps = {\n'static': StaticViewSitemap,\n'article': ArticleSitemap,\n...\n}\n</code></pre>"},{"location":"python/django/sitemap-rss-robots/#rss","title":"RSS\u8ba2\u9605","text":""},{"location":"python/django/sitemap-rss-robots/#_3","title":"\u7528\u9014","text":"<p>\u8ba9\u8ba2\u9605\u4f60\u7ad9\u70b9\u7684\u7528\u6237\u80fd\u7b2c\u4e00\u65f6\u95f4\u6536\u5230\u7ad9\u70b9\u4fe1\u606f\u66f4\u65b0\u63d0\u9192\uff0c\u76f8\u5f53\u4e8e\u7ad9\u70b9\u76ee\u5f55\u7684\u529f\u80fd\u3002</p>"},{"location":"python/django/sitemap-rss-robots/#_4","title":"\u5b9e\u73b0","text":"<pre><code>from common.feeds import BlogFeed\nurlpatterns = [\npath('', IndexView.as_view(), name='index'),\npath('admin/', admin.site.urls),\n...\npath('rss/', BlogFeed(), name='rss'),\n]\n</code></pre> <p><code>common/feeds.py</code>:</p> <pre><code>from django.conf import settings\nfrom django.urls import reverse_lazy\nfrom django.utils.feedgenerator import Rss201rev2Feed\nfrom django.contrib.syndication.views import Feed\nfrom article.models import Article\nclass BlogFeed(Feed):\nfeed_type = Rss201rev2Feed\nlink = reverse_lazy('index')\nfeed_url = reverse_lazy('rss')\ndef title(self):\nreturn get_value(settings.WEBSITE_TITLE)\ndef description(self):\nreturn get_value(settings.WEBSITE_SEO_DESCRIPTION)\ndef items(self):\nreturn Article.objects.order_by('-pk')[:10]\ndef item_title(self, item):\nreturn item.title\ndef item_description(self, item):\nreturn item.summary\ndef item_link(self, item):\nreturn reverse_lazy('article_detail', kwargs={'pk': item.id})\ndef feed_copyright(self):\nreturn \"Copyright &amp;copy; 2015-2018 yinkh\"\n</code></pre>"},{"location":"python/django/sitemap-rss-robots/#robotstxt","title":"<code>robots.txt</code>","text":""},{"location":"python/django/sitemap-rss-robots/#_5","title":"\u7528\u9014","text":"<p><code>robots.txt</code>\u914d\u5408\u7ad9\u70b9\u5730\u56fe<code>sitemaps.xml</code>\u4f7f\u7528\uff0c\u7528\u4e8e\u544a\u8bc9\u641c\u7d22\u5f15\u64ce\uff0c\u54ea\u4e9b\u8def\u5f84\u4e0b\u7684\u8d44\u6e90\u53ef\u4ee5\u6293\u53d6\uff0c\u54ea\u4e9b\u8def\u5f84\u4e0b\u7684\u8d44\u6e90\u4e0d\u53ef\u4ee5\u6293\u53d6\u3002</p>"},{"location":"python/django/sitemap-rss-robots/#_6","title":"\u5b9e\u73b0\u65b9\u6cd5","text":"<p>\u65b9\u6cd51 \u7531<code>Django</code>\u63d0\u4f9b<code>robots.txt</code>\u6587\u4ef6(\u4e0d\u63a8\u8350)\uff1a</p> <p><code>urls.py</code>:</p> <pre><code>from django.views.generic import TemplateView\npath('robots.txt', TemplateView.as_view(template_name=\"robots.txt\", content_type=\"text/plain\"), name=\"robots\"),\n</code></pre> <p>\u65b9\u6cd52 <code>robots.txt</code>\u6587\u4ef6\u662f\u9759\u6001\u6587\u4ef6\uff0c\u76f4\u63a5\u7531web\u670d\u52a1\u5668\u5206\u53d1\u4f1a\u66f4\u6709\u6548(\u63a8\u8350)\u3002</p> <p><code>Nginx</code>:</p> <pre><code>location  /robots.txt {\nalias  /path/to/static/robots.txt;\n}\n</code></pre> <p><code>Apache2</code>:</p> <pre><code>Alias /robots.txt /django/Blog/static/robots.txt\n</code></pre>"},{"location":"python/django/sitemap-rss-robots/#robotstxt_1","title":"<code>robots.txt</code>\u6587\u672c\u5185\u5bb9","text":"<p><code>robots.txt</code>\uff1a</p> <pre><code>User-agent: *\nDisallow:\n</code></pre> <p>\u7528\u6cd5\u7b80\u4ecb\uff1a</p> <p><code>User-agent</code>\u662f\u7528\u6765\u5339\u914d\u722c\u866b\u7684\uff0c\u6bcf\u4e2a\u722c\u866b\u90fd\u4f1a\u6709\u4e00\u4e2a\u540d\u5b57\uff0c\u5982\u679c\u4f60\u6709\u5b89\u88c5awstats\u7edf\u8ba1\u5de5\u5177\uff0c\u4f60\u5c31\u80fd\u67e5\u770b\u5230\u722c\u866b\u7684\u540d\u5b57\uff0c\u6bd4\u5982\u767e\u5ea6\u7684\u722c\u866b\u53ebBaiDuSpider\uff0cGoogle\u7684\u722c\u866b\u53ebGooglebot\uff0c*\u8868\u793a\u6240\u6709\u722c\u866b\u3002</p> <p><code>Disallow</code>\u8868\u793a\u7981\u6b62\u722c\u866b\u8bbf\u95ee\u7684\u76ee\u5f55\u3002<code>Disallow: /</code>\u8868\u793a\u62e6\u622a\u6574\u7ad9\u3002</p> <p><code>Allow</code>\u8868\u793a\u5141\u8bb8\u722c\u866b\u8bbf\u95ee\u7684\u76ee\u5f55\u3002<code>Allow: /</code>\u8868\u793a\u5141\u8bb8\u6574\u7ad9\u3002</p> <p><code>Sitemap</code>\u7528\u6765\u6307\u5b9a<code>sitemap</code>\u7684\u4f4d\u7f6e\u3002</p> <p><code>Crawl-delay</code>\u7528\u6765\u544a\u8bc9\u722c\u866b\u4e24\u6b21\u8bbf\u95ee\u7684\u95f4\u9694\uff0c\u5355\u4f4d\u662f\u79d2\u3002\u722c\u866b\u5982\u679c\u722c\u5f97\u5f88\u52e4\uff0c\u5bf9\u52a8\u6001\u7f51\u7ad9\u6765\u8bf4\uff0c\u538b\u529b\u6709\u70b9\u5927\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u670d\u52a1\u5668\u8d1f\u8f7d\u589e\u9ad8\uff0c\u7528\u6237\u8bbf\u95ee\u53d8\u6162\u3002</p> <p>django serving robots.txt efficiently</p> <p>robots.txt\u7528\u6cd5</p>"},{"location":"python/drf/drf-note/","title":"DjangoRestFramework\u7b14\u8bb0","text":"<p>\u8bf4\u660e\uff1a\u5728\u7b14\u8bb0\u4e2d\uff0cDjangoRestFramework\u5c06\u88ab\u7b80\u5199\u4e3aDRF,ForeignKey\u7b80\u5199\u4e3aFk,ManyToManyField\u7b80\u5199\u4e3aM2M\u3002</p>"},{"location":"python/drf/drf-note/#serializer","title":"Serializer\u76f8\u5173","text":""},{"location":"python/drf/drf-note/#serializerurlurl","title":"serializer\u4e2d\u5c06\u56fe\u7247\u3001\u6587\u4ef6\u7b49\u5bf9\u8c61\u7684\u76f8\u5bf9\u8def\u5f84url\u53d8\u6210\u7edd\u5bf9\u8def\u5f84url","text":"<p>\u5728Serializer\u521d\u59cb\u5316\u65f6\u5411\u5176\u4f20\u9012content\u53c2\u6570\u4e2d\u9700\u8981\u5305\u542brequest\u5bf9\u8c61\u5373\u53ef\uff0c\u65e2:<code>serializer = AccountSerializer(queryset, context={'request': request})</code>\u3002</p> <p>\u53ef\u4ee5\u7b80\u5355\u7684\u5199\u6210 <code>serializer = AccountSerializer(queryset, context=self.get_serializer_context())</code>\uff0c\u4ee5\u4e0b\u662fget_serializer_context\u51fd\u6570\u7684\u6e90\u7801\uff1a</p> <pre><code>def get_serializer_context(self):\n\"\"\"\n    Extra context provided to the serializer class.\n    \"\"\"\nreturn {\n'request': self.request,\n'format': self.format_kwarg,\n'view': self\n}\n</code></pre>"},{"location":"python/drf/drf-note/#foreignkeymanytomany","title":"\u6dfb\u52a0ForeignKey\u3001ManytoMany\u65f6\u6ce8\u610f\u4e8b\u9879","text":"<p>\u524d\u7aef\u5728\u6dfb\u52a0ForeignKey\u65f6\uff0c\u76f4\u63a5\u4e3arequsetBody\u6dfb\u52a0ID\u5373\u53ef\uff1b</p> <p>\u6dfb\u52a0ManytoMany\u65f6\uff0c\u4e0d\u662f\u5728requsetBody\u4e2d\u4e3a\u53c2\u6570m2m_name\u6dfb\u52a0[1,2,3],\u800c\u662f\u4f9d\u6b21\u5411m2m_name\u4e2d\u6dfb\u52a01\u30012\u30013\uff0c\u65e2\u8fde\u7eed\u6dfb\u52a0\u4e09\u6b21\u3002</p>"},{"location":"python/drf/drf-note/#ajax","title":"ajax\u4f20\u9012\u6570\u7ec4","text":"<p>\u4f7f\u7528ajax\u4ece\u524d\u7aef\u50cf\u540e\u7aef\u4f20\u9012\u6570\u7ec4\u662f\u6bd4\u8f83\u5e38\u89c4\u7684\u9700\u6c42\uff0c\u5728\u524d\u7aefajax\u9700\u8981\u8bbe\u7f6etraditional: true\u53c2\u6570\u3002DRF\u540e\u7aef\u4f7f\u7528<code>request.data.getlist('key')</code>\u65b9\u6cd5\u83b7\u53d6\u8be5\u6570\u7ec4\u3002</p> <p>\u6709\u65f6\u5019DRF\u5bf9\u5e94\u4f7f\u7528\u4e0d\u540c\u7684\u524d\u7aef\uff0c\u5982android\u4e2d\u7684okhttp\u6216\u8005vue\u4e2d\u7684&amp;http\u6216\u8005python\u4e2d\u7684requests\u6a21\u5757\uff0c\u4f1a\u51fa\u73b0request.data\u662fDict\u800c\u4e0d\u662fQueryDict\u7684\u65f6\u5019\uff0c\u9700\u8981\u4f7f\u7528\u65b9\u6cd5\u517c\u5bb9\uff1a</p> <pre><code>def get_list(_dict, key):\n\"\"\"\n    usage: get_list(request.data, 'key')\n    :param _dict: QueryDict or dict\n    :param key: list \u952e\u540d\n    :return: _dict\u4e2dkey\u5bf9\u5e94\u7684list\n    \"\"\"\nif isinstance(_dict, QueryDict):\nreturn _dict.getlist(key)\nelse:\nreturn _dict.get(key, [])\u7528\u6cd5\u4e3aget_list(request.data, 'key')\u3002\n</code></pre> <p>jQuery ajax\u7684traditional\u53c2\u6570\u7684\u4f5c\u7528</p>"},{"location":"python/drf/drf-note/#serializersfkm2m","title":"Serializers\u5d4c\u5957\u65b0\u589eFK\u6216\u8005M2M","text":"<p>RDF2.0\u4ee5\u524d\u6709\u6b64\u529f\u80fd\uff0c3.0\u58f0\u660e\u4e2d\u653e\u5f03\u6b64\u529f\u80fd\uff0c\u5e94\u4e3a\u6b64\u529f\u80fd\u5bf9\u4e8e\u7528\u6237\u6765\u8bf4\u903b\u8f91\u5904\u7406\u533a\u522b\u5927\uff0c\u8981\u652f\u6301\u5d4c\u5957\u521b\u5efa\u3001\u66f4\u65b0\u9700\u8981\u5f3a\u5236\u91cd\u5199create\u3001update\u65b9\u6cd5\u3002</p> <p>\u65b9\u6cd5\u4e00\uff1a \u7528 ast.literal_eval() \u5c06str\u89e3\u6790\u79f0\u4e3adict\u518d\u5bf9\u5916\u952e\u8fdb\u884c\u5e8f\u5217\u5316\uff0c\u5c06\u5e8f\u5217\u5316\u5f97\u5230\u7684ID\u8d4b\u7ed9\u5916\u952e\u3002\u7565\u7e41\u7410\uff0c\u8d4b\u503c\u65f6\u8981\u8bbe\u7f6erequest.data._mutable=True\u6765\u4fdd\u8bc1request.data\u53ef\u88ab\u4fee\u6539\uff0c\u9700\u8981\u6709\u4e8b\u52a1\u903b\u8f91\uff0c\u5f53\u88ab\u5d4c\u5957\u7684serializer\u6570\u636e\u4e0d\u5408\u6cd5\u65f6\uff0c\u9700\u8981\u5220\u9664\u5148\u524d\u521b\u5efa\u7684\u5f85\u5d4c\u5957\u5bf9\u8c61\uff0c\u6d6a\u8d39\u6570\u636e\u5e93\u5f00\u9500\u3002</p> <p>\u65b9\u6cd5\u4e8c\uff1a \u4f7f\u7528user.name\u4f5c\u4e3a\u53c2\u6570\u540d\u76f4\u63a5\u8fdb\u884c\u5e8f\u5217\u5316\uff0c\u7f3a\u70b9\u662f\u66f4\u65b0\u65f6\u9700\u8981\u4e00\u4e2afield\u4e00\u4e2afield\u7684\u53bb\u5199,\u6bd4\u8f83\u9ebb\u70e6(\u4e5f\u53ef\u7528for\u5faa\u73af\u914d\u5408setattr\u65b9\u6cd5\u4f7f\u7528)\u3002</p> <p>\u65b9\u6cd5\u4e09\uff1a \u624b\u5199\u5177\u4f53\u7684create\\update\u65b9\u6cd5\uff0c\u793a\u4f8b\uff1a</p> <pre><code>class EscapeRecipeModifySerializer(WritableNestedModelSerializer):\ncrafts = EscapeRecipeCraftModifySerializer(many=True, required=False, label='\u7279\u6b8a\u5de5\u827a')\n</code></pre> <p><pre><code>def create(self, validated_data):\ncrafts_data = validated_data.pop('crafts')\nescape_recipe = EscapeRecipe.objects.create(**validated_data)\n# \u4fdd\u5b58\u539f\u59cb\u914d\u65b9\ncrafts = []\nfor craft_data in crafts_data:\ncraft = OriginalRecipe(**craft_data)\ncraft.save()\ncrafts.append(craft)\nescape_recipe.original_recipes.add(*crafts)\nreturn escape_recipe\nclass Meta:\nmodel = EscapeRecipe\nfields = ('original_recipe', 'medicine', 'dosage', 'crafts')\n</code></pre> \u65b9\u6cd5\u56db\uff1a\u4f7f\u7528drf-writable-nested\u5e93\uff0c\u9700\u6ce8\u610f\u5ba2\u6237\u7aef\u548c\u5355\u5143\u6d4b\u8bd5\u65f6\u6570\u636e\u683c\u5f0f\u5fc5\u987b\u4e3aapplication/json\u3002\u7528requests\u5e93\u8bf7\u6c42\u65f6\uff0c\u7528requests.post(url=xxx,json={},headers={}),\u662fjson={}\u800c\u4e0d\u662fdata={}\uff0c\u53ef\u53c2\u8003drf-writable-nested\u5d4c\u5957\u65b0\u589e\u66f4\u65b0\u3002</p>"},{"location":"python/drf/drf-note/#serializerfko2om2m","title":"\u521b\u5efa\u3001\u66f4\u65b0\u65f6\u4f7f\u7528\u7684Serializer\u4e2dFK\\O2O\\M2M\u4e0d\u53ef\u5c55\u5f00","text":"<p>\u521b\u5efa\u4f7f\u7528\u7684serializer\u548c\u66f4\u65b0\u4f7f\u7528\u7684serializer\uff0c\u5982\u679c\u5305\u542b\u5916\u952e\u3001O2O\u3001M2M\u7684\u8bdd\uff0c\u4e0d\u53ef\u5c06\u5916\u952e\u3001O2O\u3001M2M\u5c55\u5f00\u6210\u8be6\u60c5\uff0c\u4e0d\u7136\u65e0\u6cd5\u8fdb\u884c\u521b\u5efa\u6216\u8005\u66f4\u65b0\u3002</p>"},{"location":"python/drf/drf-note/#serializer-vs","title":"Serializer \u4e00\u6b21\u5e8f\u5217\u5316\u591a\u4e2a\u5bf9\u8c61 VS \u591a\u6b21\u5e8f\u5217\u4e00\u4e2a\u5bf9\u8c61","text":"<p>Serializer\u901a\u8fc7data = Serializer(queryset, many=True).data\u6781\u7aef\u8017\u8d39\u65f6\u95f4\uff0c\u80fd\u4e00\u6b21\u83b7\u53d6\u7684data\u4e0d\u8981\u901a\u8fc7\u591a\u6b21\u83b7\u53d6\u3002\u5b81\u613f\u83b7\u53d6\u5230data\u7684list,\u518d\u53bb\u4ea4\u53c9\u5bf9\u6bd4list\u91cc\u9762\u7684\u6570\u636e\u4e5f\u4e0d\u8981\u4e3a\u4e86\u4f7f\u7528orm\u65b9\u4fbf\uff0c\u5728\u7b5b\u9009\u51fa\u5bf9\u5e94\u7684queryset\u540e\u518d\u591a\u6b21\u53bb\u505aqueryset\u7684\u5e8f\u5217\u5316\uff0c\u8fd9\u6837\u8017\u8d39\u7684\u65f6\u95f4\u5c06\u6210\u500d\u589e\u52a0\uff0c1\u6b21\u5e8f\u5217\u53161\u4e2a\u5bf9\u8c61\u7684\u65f6\u95f4\u548c\u5e8f\u5217\u53161000\u4e2a\u5bf9\u8c61\u7684\u65f6\u95f4\u5dee\u8ddd\u5e76\u4e0d\u5927\uff0c\u800c\u5e8f\u5217\u53161\u6b21\u548c\u5e8f\u5217\u53161000\u6b21\u7684\u65f6\u95f4\u5dee\u8ddd\u5de8\u5927,\u4e00\u6b21\u5e8f\u5217\u53161000\u4e2a\u8017\u65f6\u662f\u5e8f\u5217\u53161000\u6b21\uff08\u6bcf\u6b21\u4e00\u4e2a\uff09\u8017\u65f6\u7684\u4e94\u5206\u4e4b\u4e00\u3002</p> <pre><code>import django.apps\nfrom school.serializers import PermissionSerializer\npermission_list = []\npermissions = request.user.user_permissions\nfor model in django.apps.apps.get_models():\ncontent_type = ContentType.objects.get_for_model(model)\nmodel_permissions = permissions.filter(content_type=content_type)\nserializer = PermissionSerializer(model_permissions, many=True)\npermission_list.append({'name': model._meta.verbose_name,\n'content_type': content_type.id,\n'model': content_type.model,\n'permissions': serializer.data})\n# permission_list = sorted(permission_list, key=lambda x: int(x['content_type']))\ndata = {'id': user.id,\n'token': token.access_token,\n'name': user.get_full_name(),\n'permission_list': permission_list}\nreturn success_response(data)\n</code></pre> <p>\u4f7f\u7528orm\u7b5b\u9009\u540e\u591a\u6b21\u5bf9queryset\u5e8f\u5217\u5316 \u8017\u65f6\uff1a 0.20399999618530273</p> <pre><code># \u83b7\u53d6\u6839\u636e\u6a21\u578b\u5f97\u5230\u7684\u6743\u9650\u5217\u8868\npermission_list = []\nperm_data = PermissionSerializer(request.user.user_permissions, many=True).data\nfor model in django.apps.apps.get_models():\ncontent_type = ContentType.objects.get_for_model(model)\nmodel_permissions = [data for data in perm_data if data['content_type'] == content_type.id]\npermission_list.append({'name': model._meta.verbose_name, 'content_type': content_type.id,\n'model': content_type.model, 'permissions': model_permissions})\ndata = {'id': user.id,\n'token': token.access_token,\n'name': user.get_full_name(),\n'permission_list': sorted(permission_list, key=lambda x: x['content_type'])}\nreturn success_response(data)\n</code></pre> <p>\u4e00\u6b21\u5e8f\u5217\u5316\u5f97\u5230list\u518d\u5bf9\u6bd4 \u8017\u65f6:0.04799985885620117</p> <p>\u6027\u80fd\u5bf9\u6bd4\uff1a</p> <pre><code>@list_route(methods=['GET'])\ndef test(self, request):\nusers = request.user\nlists = []\nfor x in range(0, 1000):\nlists.append(users)\nstart_time = time.time()\ndata1 = UserListSerializer(lists, many=True, context=self.get_serializer_context()).data\nend_time = time.time()\nprint(end_time-start_time)\nstart_time = time.time()\nfor user in lists:\ndata = UserListSerializer(user, context=self.get_serializer_context()).data\nend_time = time.time()\nprint(end_time - start_time)\nreturn success_response('')\n</code></pre> <p>\u5e73\u5747\u8017\u65f6\u4e3a\uff1a0.1s 0.5s</p>"},{"location":"python/drf/drf-note/#_1","title":"\u8bbe\u7f6e\u5b57\u6bb5\u9009\u586b\u3001\u5fc5\u586b","text":"<pre><code>extra_kwargs = {'pre_student': {'required': True}}\nextra_kwargs = {'username': {'required': False}}\n</code></pre>"},{"location":"python/drf/drf-note/#_2","title":"\u5c06\u5e8f\u5217\u5316\u9519\u8bef\u8f6c\u6362\u6210\u53ef\u8bfb\u8bed\u8a00","text":"<pre><code># \u5c06serializer\u4e2d\u7684\u9519\u8bef\u89e3\u6790\u4e3a\u4ea4\u4e92\u66f4\u53cb\u597d\u7684\u5f62\u5f0f\nclass HumanizationSerializerErrorsMixin(object):\n    # humanization_serializer_errors\n        def humanize_errors(self, serializer=None, errors=None):\n            \"\"\"\n            \u5c06serializer\u4e2d\u7684\u9519\u8bef\u89e3\u6790\u4e3a\u4ea4\u4e92\u66f4\u53cb\u597d\u7684\u5f62\u5f0f\n            :param serializer: \u5e8f\u5217\u5316\u7c7b\n            :param errors: \u5bf9\u5e94\u9519\u8bef\n            :return: \u4ea4\u4e92\u53cb\u597d\u7684\u9519\u8bef\u63d0\u793a\n            \"\"\"\n            humanization_errors = []\n            if serializer is None:\n                serializer = self\n            if errors is None:\n                errors = serializer.errors\n\n            if isinstance(errors, list):\n                for error in errors:\n                    humanization_errors.append(str(error))\n            elif isinstance(errors, ErrorDetail):\n                humanization_errors.append(str(errors))\n            else:\n                fields = serializer.get_fields()\n                for key, values in errors.items():\n                    try:\n                        field = fields[key]\n                        # field\u4e2d\u6709model\u5219\u4f7f\u7528model\n                        verbose_name = field.label if field.label else key\n                        # \u89e3\u6790\u5b50\u9519\u8bef-\u9012\u5f52\n                        if isinstance(field, serializers.Serializer):\n                            values = self.humanize_errors(field, errors=values)\n                        elif isinstance(field, serializers.ListSerializer):\n                            values = [self.humanize_errors(field.child, errors=x) for x in values]\n                    except KeyError:\n                        if isinstance(serializer, ModelSerializer):\n                            model = serializer.Meta.model\n                            verbose_name = model._meta.verbose_name\n                        else:\n                            verbose_name = key\n                    errors_text = values if isinstance(values, str) else ' '.join([str(x) for x in values])\n                    humanization_errors.append('{}:{}'.format(str(verbose_name), errors_text))\n            return '; '.join(humanization_errors)\n</code></pre>"},{"location":"python/drf/drf-note/#drfserializer","title":"\u67e5\u770bDRF\u81ea\u52a8\u751f\u6210\u7684Serializer\u5185\u5bb9","text":"<p><code>python from user.serializers import UserSerializer serializer = UserSerializer() print(repr(serializer))</code></p>"},{"location":"python/drf/drf-note/#baseserializersave","title":"BaseSerializer\u5982\u4f55\u5224\u65adsave\u65b9\u6cd5\u5f53\u524d\u662f\u65b0\u589e\u8fd8\u662f\u66f4\u65b0","text":"<p>\u6709\u6210\u5458\u53d8\u91cfinstance,\u6ca1\u6709\u6539instance\u65f6save\u65b9\u6cd5\u8c03\u7528create\u65b9\u6cd5,\u6709\u8be5instance\u65f6\u8c03\u7528update\u65b9\u6cd5</p> <pre><code>if self.instance is not None:\nself.instance = self.update(self.instance, validated_data)\nassert self.instance is not None, (\n'`update()` did not return an object instance.'\n)\nelse:\nself.instance = self.create(validated_data)\nassert self.instance is not None, (\n'`create()` did not return an object instance.'\n)\n</code></pre>"},{"location":"python/drf/drf-note/#vaildate","title":"vaildate\u6307\u5b9a\u9519\u8bef\u5bf9\u5e94\u7684\u5b57\u6bb5\u65b9\u6cd5","text":"<p>raise serializers.ValidationError({'discountcouponrecord': ['\u4ec5\u53ef\u4f7f\u7528\u8be5\u5b66\u5458\u9886\u53d6\u7684\u4f18\u60e0\u5238']})</p>"},{"location":"python/drf/drf-note/#vaildatemodelclean","title":"vaildate\u8c03\u7528model\u4e2dclean\u65b9\u6cd5","text":"<p>DRF3.0\u540e\uff0cModelSerializer\u7684validate\u9ed8\u8ba4\u4e0d\u4f1a\u518d\u8c03\u7528model\u7684clean\u65b9\u6cd5\uff0c\u58f0\u660e\u89c1\u6b64\u3002\u9700\u8981\u624b\u52a8\u8c03\u7528model\u7684clean\u65b9\u6cd5\uff1a</p> <pre><code>def validate(self, data):\ninstance = self.Meta.model(**data)\ninstance.clean()\nreturn data\n</code></pre>"},{"location":"python/drf/drf-note/#modelserializer","title":"\u91cd\u5199ModelSerializer","text":"<ol> <li>\u5c06None\u5e8f\u5217\u5316\u4e3a '' \u800c\u4e0d\u662f 'null'</li> </ol> <p><pre><code>class ModelSerializer(serializers.ModelSerializer):\ndef to_representation(self, instance):\n\"\"\"\n              Object instance -&gt; Dict of primitive data types.\n        \"\"\"\nret = OrderedDict()\nfields = [field for field in self.fields.values() if not field.write_only]\nfor field in fields:\ntry:\nkey = field.get_attribute(instance)\nexcept SkipField:\ncontinue\nif key is not None:\nvalue = field.to_representation(key)\n# \u5b50\u5bf9\u8c61\u4e2d\u6709\u5bf9\u8c61\u4e3a\u7a7a \u4f9d\u65e7\u5e8f\u5217\u5316\n# if value is None:\n#     # Do not serialize empty objects\n#     print('empty objects')\n#     continue\n# \u5b50\u5bf9\u8c61\u4e2d\u6709\u5217\u8868\u4e3a\u7a7a \u4f9d\u65e7\u5e8f\u5217\u5316 eg:Moment-&gt;photos\u4e3a\u7a7a\u4f9d\u65e7\u8981\u5e8f\u5217\u5316\n# if isinstance(value, list) and not value:\n#     # Do not serialize empty lists\n#     print('empty lists')\n#     continue\nret[field.field_name] = value\n# print(field.field_name, value)\nelse:\n# value None to '' rather tan 'null'\n# print(field.field_name, field.to_representation(key), '\u6709\u7a7a\u503c')\nret[field.field_name] = ''\n# \u4e3aserializers\u4e2d\u52a8\u6001\u6dfb\u52a0\u7684context\u8d4b\u503c\u8f93\u51fa\nfor field in self.context:\n# context defaults to including 'request', 'view' and 'format' keys.\nif field not in ['request', 'view', 'format']:\nret[field] = self.context[field]\nreturn ret\n</code></pre> 2. \u65b0\u589e\u65f6model\u8bbe\u7f6e\u4e86null=True\u7684\u5b57\u6bb5\u4e5f\u8981\u6c42\u5fc5\u586b\uff08\u548cform\u4e00\u81f4\uff09</p> <pre><code>class ModelSerializer(serializers.ModelSerializer):\ndef build_field(self, field_name, info, model_class, nested_depth):\n\"\"\"\n        Return a two tuple of (cls, kwargs) to build a serializer field with.\n        \u91cd\u65b0\u8be5\u65b9\u6cd5\u4ee5\u4fdd\u8bc1model\u4e2dField\u5728null=True\u7684\u60c5\u51b5\u4e0b\u4f9d\u65e7\u662f\u5fc5\u586b\u9879\n        field_kwargs\u4e2drequired\u53c2\u6570\u539f\u59cb\u5224\u65ad\u4f9d\u636e\n        (build_field-&gt;build_standard_field \\ build_relational_field-&gt;get_field_kwargs\\get_relation_kwargs):\n            if model_field.has_default() or model_field.blank or model_field.null:\n                kwargs['required'] = False\n        \u66f4\u65b0\u540e\u4f9d\u636e:\n            if model_field.has_default() or model_field.blank:\n                field_kwargs['required'] = False\n            else:\n                field_kwargs['required'] = True\n        \"\"\"\nif field_name in info.fields_and_pk:\n# \u666e\u901afield \u90e8\u5206\nmodel_field = info.fields_and_pk[field_name]\nfield_class, field_kwargs = self.build_standard_field(field_name, model_field)\nfield_kwargs['required'] = False if (model_field.has_default() or model_field.blank) else True\nreturn field_class, field_kwargs\nelif field_name in info.relations:\n# FK\\M2M \u90e8\u5206\nrelation_info = info.relations[field_name]\nif not nested_depth:\nfield_class, field_kwargs = self.build_relational_field(field_name, relation_info)\nmodel_field, related_model, to_many, to_field, has_through_model, reverse = relation_info\nfield_kwargs['required'] = False if (model_field.has_default() or model_field.blank) else True\nreturn field_class, field_kwargs\nelse:\nreturn self.build_nested_field(field_name, relation_info, nested_depth)\nelif hasattr(model_class, field_name):\nreturn self.build_property_field(field_name, model_class)\nelif field_name == self.url_field_name:\nreturn self.build_url_field(field_name, model_class)\nreturn self.build_unknown_field(field_name, model_class)\n</code></pre>"},{"location":"python/drf/drf-note/#dynamicfieldsmodelserializer","title":"DynamicFieldsModelSerializer","text":"<p><pre><code># \u52a8\u6001\u83b7\u53d6Fields\nclass DynamicFieldsModelSerializer(ModelSerializer):\n\"\"\"\n    A ModelSerializer that takes an additional `fields` argument that\n    controls which fields should be displayed.\n    \"\"\"\ndef __init__(self, *args, **kwargs):\n# Don't pass the 'fields' arg up to the superclass\nfields = kwargs.pop('fields', None)\nexclude = kwargs.pop('exclude', None)\n# Instantiate the superclass normally\nsuper(DynamicFieldsModelSerializer, self).__init__(*args, **kwargs)\nif fields is not None:\n# Drop any fields that are not specified in the `fields` argument.\nallowed = set(fields)\nexisting = set(self.fields.keys())\nfor field_name in existing - allowed:\nself.fields.pop(field_name)\nif exclude is not None:\nnot_allowed = set(exclude)\nfor exclude_name in not_allowed:\nself.fields.pop(exclude_name)\n</code></pre> \u7528\u6cd5\uff1a</p> <pre><code>DynamicFieldsModelSerializer(data=data, fields=('name'))\nDynamicFieldsModelSerializer(data=data, exclude=('name'))\n</code></pre>"},{"location":"python/drf/drf-note/#dictfield","title":"DictField\u4f7f\u7528","text":"<pre><code>from rest_framework.serializers import DictField\nfrom django.utils import six\nclass MyDictField(DictField):\ndef to_internal_value(self, data):\n\"\"\"\n        Dicts of native values &lt;- Dicts of primitive datatypes.\n        \"\"\"\n# if html.is_html_input(data):\n#    data = html.parse_html_dict(data)\nif not isinstance(data, dict):\nself.fail('not_a_dict', input_type=type(data).__name__)\nreturn {\nsix.text_type(key): self.child.run_validation(value)\nfor key, value in data.items()\n}\nclass FavoritesModifySerializer(ModelSerializer):\ndata_params = MyDictField(child=serializers.CharField())\n...\ndef create(self, validated_data):\nprint(validated_data)\ndata_dic = validated_data.pop(\"data_params\")\nprint(data_dic)\nreturn super(FavoritesModifySerializer, self).create(validated_data)\n</code></pre> <p>PostMan\u4e2d\u53d1\u9001key:data_params.data value:\u5475\u5475\uff0c\u63a7\u5236\u53f0\u8f93\u51fa\uff1a</p> <pre><code>{'user': , 'cover': , 'name': '1', 'posts': [], 'data_params': {'data': '\u5475\u5475'}, 'categor\ny': 1}\n{'data': '\u5475\u5475'}\n</code></pre>"},{"location":"python/drf/drf-note/#to_representation","title":"\u91cd\u5199to_representation\u65b9\u6cd5","text":"<pre><code>def to_representation(self, instance):\nserialized_data = super(SerializerClass, self).to_representation(instance)\nserialized_data['override_field'] = 'some data'\nreturn serialized_data\n</code></pre>"},{"location":"python/drf/drf-note/#source","title":"source","text":"<pre><code>name = serializers.CharField(source='user.full_name')\n</code></pre>"},{"location":"python/drf/drf-note/#unique_together","title":"\u81ea\u5b9a\u4e49unique_together\u63d0\u793a\u4fe1\u606f","text":"<p>\u65b9\u6cd5\u4e00\uff1a</p> <pre><code>class MedicineEscapeModifySerializer(ModelSerializer):\nclass Meta:\nmodel = MedicineEscape\nfields = ('hospital', 'medicine', 'medicine_form', 'hospital_medicine_name', 'hospital_medicine_no', 'remarks')\nvalidators = [\nserializers.UniqueTogetherValidator(\nqueryset=model.objects.all(),\nfields=('hospital', 'hospital_medicine_name'),\nmessage='\u533b\u9662\u4e0d\u53ef\u91cd\u590d\u5173\u8054\u540c\u4e00\u533b\u9662\u836f\u54c1\u540d\u79f0;'\n),\nserializers.UniqueTogetherValidator(\nqueryset=model.objects.all(),\nfields=('hospital', 'hospital_medicine_no'),\nmessage='\u533b\u9662\u4e0d\u53ef\u91cd\u590d\u5173\u8054\u540c\u4e00\u533b\u9662\u836f\u54c1\u7f16\u7801;'\n)\n]\n</code></pre> <p>\u65b9\u6cd5\u4e8c\uff1a</p> <p><pre><code> class MedicineEscapeModifySerializer(ModelSerializer):\nclass Meta:\nmodel = MedicineEscape\nfields = ('hospital', 'medicine', 'medicine_form', 'hospital_medicine_name', 'hospital_medicine_no', 'remarks')\ndef get_unique_together_validators(self):\nvalidators = super(MedicineEscapeModifySerializer, self).get_unique_together_validators()\nprint(self.initial_data)\nfor validator in validators:\nif validator.fields == ('hospital', 'hospital_medicine_name'):\nvalidator.message = '\u533b\u9662\u4e0d\u53ef\u91cd\u590d\u5173\u8054\u540c\u4e00\u533b\u9662\u836f\u54c1\u540d\u79f0;'\nif validator.fields == ('hospital', 'hospital_medicine_no'):\nvalidator.message = '\u533b\u9662\u4e0d\u53ef\u91cd\u590d\u5173\u8054\u540c\u4e00\u533b\u9662\u836f\u54c1\u7f16\u7801;'\nreturn validators\n</code></pre> \u53ea\u5bf9admin\u3001form\u6709\u6548, \u5bf9serializer\u65e0\u6548\u7684\u65b9\u6cd5\uff1a</p> <pre><code>class MedicineEscape(models.Model):\n....\ndef unique_error_message(self, model_class, unique_check):\n\"\"\"\u53ea\u5bf9admin\u3001form\u6709\u6548 \u5bf9serializer\u65e0\u6548\"\"\"\nif model_class == type(self) and unique_check == ('hospital', 'hospital_medicine_name'):\nreturn '{}\u4e0d\u53ef\u91cd\u590d\u5173\u8054{}'.format(self.hospital.name, self.hospital_medicine_name)\nelse:\nreturn super(MedicineEscape, self).unique_error_message(model_class, unique_check)\n</code></pre>"},{"location":"python/drf/drf-note/#view","title":"View\u76f8\u5173","text":""},{"location":"python/drf/drf-note/#url","title":"\u83b7\u53d6url\u53c2\u6570","text":"<p>\u8bf7\u6c42url\u4e3ahttp://192.168.1.108/discount_coupon/?name=xxx</p> <p>\u65b9\u6cd5\u4e00\uff1a name = self.request.query_params.get('name')</p> <p>\u65b9\u6cd5\u4e8c\uff1a name = self.request.GET.get('name')</p>"},{"location":"python/drf/drf-note/#strdict","title":"str\u8f6cdict\u65b9\u6cd5","text":"<pre><code>import ast\ndef literal_eval(data):\n\"\"\"\n    :param data: str\u6216\u8005dict\n    :return: dict or None\n    \"\"\"\nif isinstance(data, dict):\nreturn data\nelse:\ntry:\nreturn ast.literal_eval(data)\nexcept (SyntaxError, ValueError):\nreturn None\n</code></pre>"},{"location":"python/drf/drf-note/#get_list","title":"get_list\u9002\u914d","text":"<pre><code>from django.http import QueryDict\ndef get_list(_dict, key):\n\"\"\"\n    :param _dict: QueryDict or dict\n    :param key: list \u952e\u540d\n    :return: _dict\u4e2dkey\u5bf9\u5e94\u7684list\n    \"\"\"\nif isinstance(_dict, QueryDict):\nreturn _dict.getlist(key)\nelse:\nreturn _dict[key]\n</code></pre> <p>\u7528\u6cd5\uff1aget_list(request.data, 'ids')</p> <p>\u5ba2\u6237\u7aef\u5411\u670d\u52a1\u5668\u53d1\u8d77\u8bf7\u6c42\u65f6\uff0c\u670d\u52a1\u5668\u63a5\u6536\u5230\u7684request.data\u53ef\u80fd\u662fdict\u4e5f\u53ef\u80fd\u662fQueryDict\uff0c\u4e0d\u540c\u7c7b\u578b\u65f6\u53d6list\u65f6\u65b9\u6cd5\u4e0d\u540c\u3002\u524d\u7aef\u4f7f\u7528Ajax\u65f6\u9700\u8981\u8bbe\u7f6etraditional: true\uff0ctraditional\u4e3afalse\uff0c\u5373jquery\u4f1a\u6df1\u5ea6\u5e8f\u5217\u5316\u53c2\u6570\u5bf9\u8c61\uff0c\u4ee5\u9002\u5e94\u5982PHP\u548cRuby on Rails\u6846\u67b6\uff0c\u4f46DRF\u65e0\u6cd5\u5904\u7406\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6etraditional\u4e3atrue\u963b\u6b62\u6df1\u5ea6\u5e8f\u5217\u5316\u3002</p>"},{"location":"python/drf/drf-note/#requestdata","title":"\u5411request.data\u4e2d\u6dfb\u52a0\u6570\u636e","text":"<ol> <li> <p>data = request.data.copy() \u5f00\u9500\u5927\uff0c\u4e0d\u53cb\u597d</p> </li> <li> <p>request.data._mutable = True \u63a8\u8350\u4f7f\u7528\uff0c\u8bbe\u7f6e\u53ef\u4fee\u6539\u6807\u5fd7\u4f4dTrue</p> </li> </ol>"},{"location":"python/drf/drf-note/#queryset","title":"queryset\u61d2\u52a0\u8f7d","text":"<pre><code>class UserList(ModelViewSet):\nqueryset = User.objects.all()\n</code></pre> <p>queryset\u5bf9\u8c61\u53ea\u4f1a\u5728\u7a0b\u5e8f\u521d\u59cb\u5316\u7684\u65f6\u5019\u53bb\u6570\u636e\u5e93\u53d6\u4e00\u6b21\u503c\uff0c\u4e4b\u540e\u4f7f\u7528\u7684\u7ed3\u679c\u5747\u4e3a\u7f13\u5b58\u503c\uff0c\u5982\u7a0b\u5e8f\u542f\u52a8\u65f6queryset\u5185\u6709\u3010\u7528\u62371\u3011\uff0c\u540e\u9762\u65b0\u589e\u4e86\u3010\u7528\u62372\u3011\uff0c\u518d\u6b21\u53bb\u53d6\u8be5queryset\u5bf9\u8c61\u4f9d\u65e7\u53ea\u6709\u3010\u7528\u62371\u3011\u3002</p> <p>\u60f3\u8981\u83b7\u53d6\u5230\u5b9e\u65f6\u7684\u6570\u636e\u5e93queryset,\u9700\u8981\u8c03\u7528queryset.all()\u65b9\u6cd5\u6765\u91cd\u65b0\u81f3\u6570\u636e\u5e93\u8bfb\u53d6\u6570\u636e\u3002ModelViewSet\u7684\u9ed8\u8ba4get_queryset\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <p><pre><code>def get_queryset(self):\n\"\"\"\n    Get the list of items for this view.\n    This must be an iterable, and may be a queryset.\n    Defaults to using `self.queryset`.\n    This method should always be used rather than accessing `self.queryset`\n    directly, as `self.queryset` gets evaluated only once, and those results\n    are cached for all subsequent requests.\n    You may want to override this if you need to provide different\n    querysets depending on the incoming request.\n    (Eg. return a list of items that is specific to the user)\n    \"\"\"\nassert self.queryset is not None, (\n\"'%s' should either include a `queryset` attribute, \"\n\"or override the `get_queryset()` method.\"\n% self.__class__.__name__\n)\nqueryset = self.queryset\nif isinstance(queryset, QuerySet):\n# Ensure queryset is re-evaluated on each request.\nqueryset = queryset.all()\nreturn queryset\n</code></pre> \u53ef\u89c1\uff1a<code>queryset = queryset.all() # Ensure queryset is re-evaluated on each request</code>.</p> <p>DRF view doc</p>"},{"location":"python/drf/drf-note/#auth","title":"Auth\u76f8\u5173","text":""},{"location":"python/drf/drf-note/#sessionauthentication403","title":"\u5f00\u542fSessionAuthentication\u65f6403","text":"<p>DRF\u5728\u5f00\u542fSessionAuthentication\u65f6\u4f1a\u5bfc\u81f4\u6743\u9650\u8bbe\u7f6e\u6210AllowAny\u65f6\u4f9d\u65e7\u4f1a\u51fa\u73b0403\u8fd4\u56de\uff0c\u8be6\u60c5\u4e3aCSRF Failed: CSRF token missing or incorrent\u3002</p> <p>\u5220\u9664SessionAuthentication\u53ea\u4f7f\u7528TokenAuthentication\u5373\u53ef\uff0c\u4f46\u662fDjango\u9ed8\u8ba4\u4f7f\u7528session\u8fdb\u884c\u8ba4\u8bc1\uff0c\u8fd9\u5c06\u5bfc\u81f4\u767b\u9646\u540e\u53f0\u6210\u529f\u540e\u65e0\u6cd5\u6d4f\u89c8DRF\u7684\u53ef\u89c6\u5316API\uff08browsable api\uff09\uff0c</p> <p>\u4f7f\u7528chrome\u63d2\u4ef6ModHeader\u5373\u53ef\u5c06\u6d4f\u89c8\u5668\u8bf7\u6c42\u52a0\u5165token\u5934\u90e8\u6d4f\u89c8\u53ef\u89c6\u5316API\u6765\u89e3\u51b3\u6b64\u95ee\u9898\u3002</p>"},{"location":"python/drf/drf-note/#_3","title":"\u5217\u8868\u76f8\u5173","text":""},{"location":"python/drf/drf-note/#_4","title":"\u591a\u91cd\u6761\u4ef6\u8fc7\u6ee4\u3001\u6392\u5e8f\u3001\u641c\u7d22","text":"<p>settings.py</p> <pre><code>REST_FRAMEWORK = {\n'DEFAULT_FILTER_BACKENDS': (\n# \u591a\u91cd\u6761\u4ef6\u8fc7\u6ee4\n'django_filters.rest_framework.DjangoFilterBackend',\n# \u6392\u5e8f\n'rest_framework.filters.OrderingFilter',\n# \u641c\u7d22\n'rest_framework.filters.SearchFilter'\n),\n'ORDERING_PARAM': 'ordering',\n'SEARCH_PARAM': 'search',\n}\n</code></pre> <p>filters.py</p> <pre><code>from django_filters.rest_framework import FilterSet\nclass UserFilter(FilterSet):\nclass Meta:\nmodel = User\nfields = {\n'username': ['exact', 'icontains'],\n'tel': ['exact', 'icontains', 'isnull']\n}\n</code></pre> <p>views.py</p> <pre><code>class EmailViewSet(viewsets.ModelViewSet):\nqueryset = Email.objects.all()\nserializer_class = EmailCreateSerializer\npermission_classes = (IsAuthenticated,)\nfilter_class = UserFilter\nordering_fields = '__all__'\nsearch_fields = ('name', )\n</code></pre> <p>\u7528\u6cd5\uff1a</p> <p>\u8fc7\u6ee4\uff1ahttp://192.168.1.108/email/?name=GG&amp;id=2</p> <p>\u6392\u5e8f\uff1ahttp://192.168.1.108/email/?ordering=-name,id</p> <p>\u641c\u7d22\uff1ahttp://192.168.1.108/email/?search=GG</p> <p>\ufefforder_by\u51fd\u6570\u4f1a\u6309\u7167\u4f20\u9012\u4f20\u8f93\u7684\u987a\u5e8f\u8fdb\u884c\u6392\u5e8f\uff0c\u5982\u4f20\u9012(name, id)\uff0c\u610f\u601d\u4e3a\u5728name\u76f8\u540c\u7684\u60c5\u51b5\u4e0b\u6309\u7167id\u81ea\u589e\u7684\u987a\u5e8f\u8fdb\u884c\u6392\u5217\uff0c\u540e\u9762\u7684\u6761\u4ef6\u53ea\u6709\u5728\u524d\u9762\u7684\u6761\u4ef6\u76f8\u540c\u7684\u60c5\u51b5\u4e0b\u624d\u4f1a\u751f\u6548\u3002</p>"},{"location":"python/drf/drf-note/#_5","title":"\u5206\u9875\u76f8\u5173","text":""},{"location":"python/drf/drf-note/#_6","title":"\u52a8\u6001\u8bbe\u7f6e\u5206\u9875\u4e2d\u6bcf\u9875\u4e2a\u6570 \u52a8\u6001\u5f00\u5173\u5206\u9875","text":"<p><pre><code># \u5206\u9875\nclass Pagination(PageNumberPagination):\n# django_paginator_class = DjangoPaginator\npage_number = 1\npage_size_query_param = 'page_size'\nmax_page_size = 100\ndef paginate_queryset(self, queryset, request, view=None):\n\"\"\"\n        \u4f7f\u7528page_size\u53c2\u6570\u9650\u5236\u6bcf\u9875\u6761\u6570\n        \u8d85\u51fa\u9875\u7801\u8303\u56f4\u8fd4\u56de\u7b2c\u4e00\u9875\n        \u6700\u540e\u4e00\u9875\u9875\u7801\u7528last\u8868\u793a\n        \"\"\"\npage_size = self.get_page_size(request)\nif not page_size:\nreturn None\npaginator = self.django_paginator_class(queryset, page_size)\nself.page_number = request.query_params.get(self.page_query_param, 1)\nif self.page_number in self.last_page_strings:\nself.page_number = paginator.num_pages\ntry:\nself.page = paginator.page(self.page_number)\nexcept InvalidPage:\n# \u975e\u6cd5\u9875\u7801\u8fd4\u56de\u7b2c\u4e00\u9875\nself.page_number = '1'\nself.page = paginator.page(self.page_number)\nif paginator.num_pages &gt; 1 and self.template is not None:\n# The browsable API should display pagination controls.\nself.display_page_controls = True\nself.request = request\nreturn list(self.page)\ndef get_page_size(self, request):\n\"\"\"\n        page_size &gt; 0 \u4f7f\u7528\u65b0page_size\n        page_size = 0 \u65f6\u4e0d\u5206\u9875\n        page_size &lt; 0 \u65f6\u4f7f\u7528\u9ed8\u8ba4page_size\n        \"\"\"\nif self.page_size_query_param:\npage_size = min(int(request.query_params.get(self.page_size_query_param, self.page_size)),\nself.max_page_size)\nif page_size &gt; 0:\nreturn page_size\nelif page_size == 0:\nreturn None\nelse:\npass\nreturn self.page_size\n</code></pre> \u7528\u6cd5\uff1a</p> <p>\u6bcf\u98755\u6761\uff1aget https://www.example.com/post/?page_size=5</p> <p>\u4e0d\u5f00\u542f\u5206\u9875\uff1aget https://www.example.com/post/?page_size=0</p>"},{"location":"python/drf/drf-note/#_7","title":"\u91cd\u5199\u5206\u9875\u8fd4\u56de\u7ed3\u679c","text":"<pre><code>class Pagination(PageNumberPagination):\n# django_paginator_class = DjangoPaginator\ndef get_paginated_response(self, data):\nreturn Response(OrderedDict([\n('count', self.page.paginator.count),\n('num_pages', self.page.paginator.num_pages),\n('next', self.get_next_link()),\n('previous', self.get_previous_link()),\n('results', data)\n]))\n</code></pre>"},{"location":"python/drf/drf-note/#django1111-paginatorunorderedobjectlistwarning","title":"Django1.11.1 Paginator\u65b0\u589eUnorderedObjectListWarning\u68c0\u6d4b","text":"<p>Q:Django1.11.1 Paginator\u65b0\u589eUnorderedObjectListWarning\u68c0\u6d4b,\u8981\u6c42DRF\u7684queryset\u6216\u8005get_queryset\u4e4b\u540e\u8fdb\u884c\u6392\u5e8f \u4ee5\u9632\u6b62\u591a\u6b21\u5206\u9875\u5f97\u5230\u4e0d\u540c\u7684\u7ed3\u679c</p> <p>A\uff1a</p> <p>\u65b9\u6cd5\u4e00:</p> <pre><code>from django.core.paginator import Paginator\n# \u5c4f\u853dUnorderedObjectListWarning\nclass DjangoPaginator(Paginator):\ndef _check_object_list_is_ordered(self):\n\"\"\"\n        Warn if self.object_list is unordered (typically a QuerySet).\n        Pagination may yield inconsistent results with an unordered\n        \"\"\"\npass\n# \u5206\u9875\nclass Pagination(PageNumberPagination):\n# django_paginator_class = DjangoPaginator\n</code></pre> <p>\u65b9\u6cd5\u4e8c\uff1a</p> <p>\u6ca1\u6709\u91cd\u5199get_queryset\u65b9\u6cd5\u7684ModelViewSet(\u6dfb\u52a0\u4e86order_by):</p> <p>queryset = MessageTemplate.objects.all().order_by('id')</p> <p>\u91cd\u5199\u4e86get_queryset\u65b9\u6cd5\u7684ModelViewSet(\u6dfb\u52a0\u4e86order_by):</p> <pre><code>def get_queryset(self):\nqueryset = MessageTemplate.objects.filter(Q(publisher=self.request.user, is_private=True) |\nQ(is_private=False)).order_by('id')\n</code></pre> <p>\u200b    return queryset</p>"},{"location":"python/drf/drf-note/#_8","title":"\u6743\u9650\u76f8\u5173","text":""},{"location":"python/drf/drf-note/#viewset-model","title":"ViewSet model\u6743\u9650","text":"<pre><code>class DRFModelPermissions(permissions.DjangoModelPermissions):\n\"\"\"\n    Similar to `DjangoModelPermissions`, but adding 'view' permissions.\n    \"\"\"\nperms_map = {\n'GET': ['%(app_label)s.view_%(model_name)s'],\n'OPTIONS': ['%(app_label)s.view_%(model_name)s'],\n'HEAD': ['%(app_label)s.view_%(model_name)s'],\n'POST': ['%(app_label)s.add_%(model_name)s'],\n'PUT': ['%(app_label)s.change_%(model_name)s'],\n'PATCH': ['%(app_label)s.change_%(model_name)s'],\n'DELETE': ['%(app_label)s.delete_%(model_name)s'],\n}\n</code></pre> <p>\u4f7f\u7528list_router\u548cdetail_router\u65f6\uff0c\u4f1a\u6839\u636e\u8bbf\u95ee\u7684\u65b9\u6cd5\u7c7b\u578b\u8981\u6c42\u5bf9\u5e94\u7684\u6743\u9650\u3002</p>"},{"location":"python/drf/drf-note/#viewset-model-model","title":"ViewSet model\u6743\u9650 \u6307\u5b9amodel","text":"<p><pre><code>class DRFCertainModelPermissions(DRFModelPermissions):\n\"\"\"\n    Certain model with permission_model in ViewSet for DRFModelPermissions\n    \"\"\"\ndef get_model(self, view):\nif not hasattr(view, 'permission_model'):\nraise ImproperlyConfigured('permission_model must be override in ViewSet which used '\n'DRFCertainModelPermissions.')\nreturn getattr(view, 'permission_model')\ndef has_permission(self, request, view):\n# Workaround to ensure DjangoModelPermissions are not applied\n# to the root view when using DefaultRouter.\nif getattr(view, '_ignore_model_permissions', False):\nreturn True\nif not request.user or (\nnot request.user.is_authenticated and self.authenticated_users_only):\nreturn False\nperms = self.get_required_permissions(request.method, self.get_model(view))\nreturn request.user.has_perms(perms)\n</code></pre> \u7528\u6cd5\uff1a</p> <pre><code>class LabelPrinterViewSet(ModelViewSet):\nqueryset = LabelPrinter.objects.all()\npermission_classes = (DRFCertainModelPermissions,)\npermission_model = Label\n</code></pre> <p>\u5219\u53ef\u4ee5\u8ba9LabelPrinterViewSet\u7684CRUD\u5bf9\u5e94\u4f7f\u7528Label\u7684CRUD\u6743\u9650\u3002</p>"},{"location":"python/drf/drf-note/#viewset-model_1","title":"ViewSet model\u6743\u9650 \u5047\u5220\u9664","text":"<p>\u5047\u5220\u9664\u65f6\uff0c\u5220\u9664\u5b9e\u9645\u4e0a\u4e3a\u4f5c\u5e9f\uff0c\u8c03\u6574\u5220\u9664\u9700\u8981\u7684\u6743\u9650\u4e3a\u4fee\u6539\u6743\u9650\u5373\u53ef\u3002</p> <pre><code>class DRFModelDeleteAsChangePermissions(permissions.DjangoModelPermissions):\n\"\"\"\n    Similar to `DjangoModelPermissions`, but adding 'view' permissions.\n    Delete action use same permissions as PUT/PATCH action.\n    \"\"\"\nperms_map = {\n'GET': ['%(app_label)s.view_%(model_name)s'],\n'OPTIONS': ['%(app_label)s.view_%(model_name)s'],\n'HEAD': ['%(app_label)s.view_%(model_name)s'],\n'POST': ['%(app_label)s.add_%(model_name)s'],\n'PUT': ['%(app_label)s.change_%(model_name)s'],\n'PATCH': ['%(app_label)s.change_%(model_name)s'],\n'DELETE': ['%(app_label)s.change_%(model_name)s'],\n}\n</code></pre>"},{"location":"python/drf/drf-note/#viewsetpermission_classes","title":"ViewSet\u4e2dpermission_classes\u68c0\u67e5\u4ece\u5de6\u5230\u53f3\u4f9d\u6b21\u8fdb\u884c\uff0c\u9700\u8981\u5c06\u524d\u63d0\u6743\u9650\u7c7b\u653e\u5728\u6700\u524d\u9762\u3002","text":"<pre><code>permission_classes = (DRFModelPermissions, IsAuthenticated,)\npermission_classes = (IsAuthenticated, DRFModelPermissions, )\n</code></pre> <p>\u524d\u4e00\u79cd\u60c5\u51b5\u4f1a\u5bfc\u81f4\u672a\u767b\u9646\u7684\u7528\u6237\u53ef\u4ee5\u8bbf\u95ee\u5230\u6240\u6709\u63a5\u53e3\uff0c\u540e\u4e00\u79cd\u60c5\u51b5\u624d\u80fd\u591f\u771f\u6b63\u9650\u5236\u7528\u6237\u5fc5\u987b\u767b\u9646\u5e76\u4e14\u5177\u6709\u6a21\u578b\u6743\u9650\u3002\u56e0\u4e3aIsAuthenticated\u8981\u6c42\u7528\u6237\u767b\u9646\uff0cDRFModelPermissions\u5224\u65ad\u767b\u9646\u7528\u6237\u662f\u5426\u6709\u5bf9\u5e94\u7684\u6a21\u578b\u6743\u9650\uff0c\u5176\u524d\u7f6e\u6761\u4ef6\u4e3a\u8981\u6c42\u7528\u6237\u4e3a\u767b\u9646\u7528\u6237\u3002</p>"},{"location":"python/drf/drf-note/#_9","title":"\u52a8\u6001\u6743\u9650\u68c0\u67e5","text":"<p>\u65b9\u6cd51\uff08\u81ea\u5df1\u5199\u7684 \u4e0d\u63a8\u8350 \u4f1a\u5bfc\u81f4\u6240\u6709\u63a5\u53e3\u8c03\u7528\u524d\u591a\u4e00\u6b21\u4e0d\u5fc5\u8981\u7684\u6743\u9650\u5bf9\u8c61\u662f\u7c7b\u8fd8\u662f\u5b9e\u4f8b\u7684\u5224\u65ad\uff09\uff1a</p> <p><pre><code> class ModelViewSet: \n...\ndef get_permissions(self):\n\"\"\"\n        Instantiates and returns the list of permissions that this view requires.\n        \u517c\u5bb9\u5b9e\u4f8b\u6216\u7c7b\n        \"\"\"\npermissions = []\nfor permission in self.permission_classes:\nif isinstance(permission, type):\n# \u7c7b\npermissions.append(permission())\nelse:\n# \u5b9e\u4f8b\npermissions.append(permission)\nreturn permissions\n</code></pre> permissions.py:</p> <p><pre><code>class DynamicPermsClass(permissions.BasePermission):\n\"\"\"\n    \u52a8\u6001\u6743\u9650\u68c0\u67e5 \u9700\u8981\u8c03\u6574ModelViewSet\u4e2dget_permissions\u65b9\u6cd5\u517c\u5bb9\n    usage: DynamicPermsClass(['app_label.action_model', ])\n    \"\"\"\npermissions = []\ndef __init__(self, *args, **kwargs):\nself.permissions = args[0] if len(args) &gt; 0 else []\nsuper(DynamicPermsClass, self).__init__()\ndef has_permission(self, request, view):\nprint('has_permission', self.permissions)\nif request.user and request.user.is_authenticated and request.user.has_perms(self.permissions):\nreturn True\nelse:\nreturn False\n</code></pre> views.py:</p> <pre><code>@action(methods=['GET'], detail=False, serializer_class=None,\npermission_classes=[DynamicPermsClass(['demo.view_demo']), ])\ndef demo(self, request, *args, **kwargs):\n</code></pre> <p>\u65b9\u6cd52\uff08\u7531django-rest-framework-rules\u6539\u9020\u800c\u6765\uff09\uff1a</p> <p>mixins.py:</p> <p><pre><code>class PermissionRequiredMixin(object):\n\"\"\"\n    \u6e90\u4e8edjango-rest-framework-rules \u7528\u4e8e\u81ea\u5b9a\u4e49\u7684action\u65b9\u6cd5\n    usage:\n    @action(methods=['GET'], detail=False, permission_required='prescription.view_patient') or\n    @action(methods=['GET'], detail=False, permission_required=['prescription.view_patient', 'prescription.view_doctor'])\n    \"\"\"\npermission_required = None\ndef get_permission_required(self):\nif self.permission_required is None:\n# This prevents a misconfiguration of the view into which the mixin\n# is mixed. If the mixin is used, at least one permission should be\n# required.\nraise ImproperlyConfigured(\n'{0} is missing the permission_required attribute. Define '\n'{0}.permission_required, or override '\n'{0}.get_permission_required().'.format(self.__class__.__name__)\n)\nif isinstance(self.permission_required, str):\nperms = (self.permission_required,)\nelse:\nperms = self.permission_required\nreturn perms\ndef check_permissions(self, request):\nif request.user.has_perms(self.get_permission_required()):\nreturn super(PermissionRequiredMixin, self).check_permissions(request)\nelse:\nself.permission_denied(request, message='\u60a8\u6ca1\u6709\u6267\u884c\u8be5\u64cd\u4f5c\u7684\u6743\u9650')\n</code></pre> decorators.py:</p> <pre><code>def permission_required(permissions):\n\"\"\"\n    \u6e90\u81ea\u6e90\u4e8edjango-rest-framework-rules \u7528\u4e8ecreate\u3001update\u3001destroy \u7b49\u5185\u7f6e\u65b9\u6cd5\n    usage:\n    @permission_required('demo.add_demo')\n    def create(self, request, *args, **kwargs)\n    \"\"\"\ndef decorator(view):\ndef wrapped_view(self, request, *args, **kwargs):\nif isinstance(permissions, str):\nperms = (permissions,)\nelse:\nperms = permissions\nif not request.user.has_perms(perms):\n# raises a permission denied exception causing a 403 response\nself.permission_denied(request, message='\u60a8\u6ca1\u6709\u6267\u884c\u8be5\u64cd\u4f5c\u7684\u6743\u9650(\u7279\u6b8a\u6743\u9650\u68c0\u67e5\u672a\u901a\u8fc7)')\nreturn view(self, request, *args, **kwargs)\nreturn wrapped_view\nreturn decorator\n</code></pre>"},{"location":"python/drf/drf-note/#_10","title":"\u6587\u6863\u751f\u6210","text":""},{"location":"python/drf/drf-note/#_11","title":"\u5b89\u88c5","text":"<p>\u9700\u8981\u5b89\u88c5coreapi\u5e93\u7528\u4e8e\u6587\u6863\u751f\u6210\u3002\u6ce8\u91ca\u8bed\u6cd5\u4f7f\u7528markdown\u8bed\u6cd5,\u9700\u8981\u5b89\u88c5markdown\u5e93\u3002</p> <pre><code>from rest_framework.documentation import include_docs_urls\nurlpatterns = [\n...\nurl(r'^docs/', include_docs_urls(title='My API title'))\n]\n</code></pre>"},{"location":"python/drf/drf-note/#_12","title":"\u6ce8\u91ca\u65b9\u6cd5","text":"<pre><code>class UserViewSet(viewsets.ModelViewSet):\n\"\"\"\n    retrieve:\n    Return the given user.\n    list:\n    Return a list of all the existing users.\n    create:\n    Create a new user instance.\n    \"\"\"\n@list_route(methods=['POST'], permission_classes=[AllowAny], serializer_class=None)\ndef refresh_token(self, request):\n\"\"\"\n     \u5237\u65b0\u4ee4\u724c\n\u3010\u63a5\u6536\u3011token: \u4ee4\u724c\n\u3010\u8fd4\u56de\u3011200 \u65b0\u4ee4\u724c 400-1 \u6570\u636e\u683c\u5f0f\u9519\u8bef 400-2 \u4ee4\u724c\u9519\u8bef\n    \"\"\"\n</code></pre>"},{"location":"python/drf/drf-note/#_13","title":"\u4e2a\u6027\u5316","text":"<p>\u8868\u683c\u63cf\u8ff0\u6539\u4e3aserializer\u4e2dfield\u7684label,\u5e76\u52a0\u5165\u7c7b\u578b\uff0c\u4e3aChoiceField\u65f6\u5217\u51fa\u9009\u9879\u5185\u5bb9\uff1a \u4fee\u6539rest_framework/schema/inspectors.py\u4e2d\u7684field_to_schema\u65b9\u6cd5\uff1a</p> <pre><code>description = '\u3010{}\u3011{}'.format(field.__class__.__name__, force_text(field.label) if field.label else '')\n# ChoiceField \u5217\u51fa\u9009\u9879\u5185\u5bb9\nif isinstance(field, ChoiceField):\ndescription += ' \u3010\u9009\u9879\u3011'\nfor key, value in field.choices.items():\ndescription += ' {}-{}'.format(key, value)\n</code></pre> <p>\u5de6\u4fa7\u5bfc\u822a\u4fee\u6539\u4e3a\u4e2d\u6587 \u4fee\u6539 rest_framework/schema/generators.py SchemaGenerator\u7c7b\u4e2d\u7684get_keys\u65b9\u6cd5\uff1a</p> <pre><code># \u4fee\u6539user-&gt;\u7528\u6237\nnamed_path_components = [\ncomponent for component in subpath.strip('/').split('/') if '{' not in component\n]\nnamed_path_components[0] = view.queryset.model._meta.verbose_name.title()\n</code></pre> <p>\u52a0\u5165\u81ea\u5b9a\u4e49\u65b9\u6cd5\u652f\u6301 \u4fee\u6539 rest_framework/schema/generators.py\u4e2d\u7684is_custom_action\u65b9\u6cd5\u4e3a\uff1a</p> <pre><code>def is_custom_action(action):\nreturn action not in {\n'retrieve', 'list', 'create', 'update', 'partial_update', 'destroy', 'bulk_update', 'bulk_destroy'\n}\n</code></pre> <p>\u6700\u7ec8\u751f\u6210\u6587\u6863\u6548\u679c\uff1a </p> <p>Documenting your API</p>"},{"location":"python/drf/drf-note/#_14","title":"\u5176\u4ed6","text":""},{"location":"python/drf/drf-note/#_15","title":"\u533a\u5206\u8def\u5f84\u7c7b\u578b","text":"<p>\u4ee5/\u5f00\u5934\u7684\u8def\u5f84\u662f\u7edd\u5bf9\u8def\u5f84\uff0c\u5426\u5219\u4f1a\u9ed8\u8ba4\u53d6\u76f8\u5bf9\u8def\u5f84\u3002</p>"},{"location":"python/drf/drf-note/#routerbase_name","title":"Router\u9ed8\u8ba4base_name","text":"<p>\u4ee5viewset\u4e2d\u7684queryset\u53c2\u6570\u4f5c\u4e3a\u9ed8\u8ba4base_name\uff1b</p>"},{"location":"python/drf/drf-writable-nested/","title":"drf-writable-nested\u5d4c\u5957\u65b0\u589e\u66f4\u65b0","text":""},{"location":"python/drf/drf-writable-nested/#_1","title":"\u5b89\u88c5","text":"<p>\u672c\u6587<code>requirement</code>\u73af\u5883\u5982\u4e0b\uff1a</p> <pre><code>Django==2.0.4\ndjangorestframework==3.8.2\ndrf-writable-nested==0.4.2\n</code></pre>"},{"location":"python/drf/drf-writable-nested/#o2o","title":"\u5916\u952e\u6216O2O\u76f4\u63a5\u5d4c\u5957\u65b0\u589e","text":""},{"location":"python/drf/drf-writable-nested/#_2","title":"\u6a21\u578b","text":"<pre><code># \u7528\u6237\nclass User(AbstractBaseUser, PermissionsMixin):\n# \u624b\u673a\u53f7\u7801\ntel = CharNullField(max_length=20,\nunique=True,\nnull=True,\nerror_messages={\n'unique': \"\u5177\u6709\u8be5\u624b\u673a\u53f7\u7801\u7684\u7528\u6237\u5df2\u5b58\u5728\",\n},\nverbose_name='\u624b\u673a\u53f7\u7801')\n# \u59d3\u540d\nname = models.CharField(max_length=30,\nblank=True,\nverbose_name='\u59d3\u540d')\n# \u5458\u5de5\nclass Staff(models.Model):\n# \u7528\u6237 \u7ea7\u8054\u5220\u9664\nuser = models.OneToOneField('user.User',\nnull=True,\non_delete=models.CASCADE,\nverbose_name='\u5bf9\u5e94\u7528\u6237')\n# \u5de5\u53f7\nno = models.CharField(max_length=255,\nunique=True,\nverbose_name='\u5de5\u53f7')\n</code></pre>"},{"location":"python/drf/drf-writable-nested/#_3","title":"\u89c6\u56fe","text":"<p>views.py</p> <pre><code># \u5458\u5de5\nclass StaffViewSet(ModelViewSet):\n\"\"\"\n    create:\n    \u65b0\u589e\u6570\u636e\u683c\u5f0f\uff1a\n    &lt;p&gt;&lt;code&gt;{\n            'user': {'name': 'YKH', 'tel': '17749503263', 'email': 'ykh@dreamgo.tech', 'password': 'YKH123456',\n                     'is_active': True, 'is_staff': True, 'groups': [self.group.id]},\n            'job_state': 1, 'bank_no': '614457662', 'social_security_no': '\u6682\u65e0', 'on_job': True\n        }&lt;/code&gt;\n    partial_update:\n    \u66f4\u65b0\u6570\u636e\u683c\u5f0f\uff1a\n        &lt;p&gt;&lt;code&gt;{\n            'user': {'id': user.id, 'name': 'YKH', 'tel': '17749503263', 'email': 'ykh@dreamgo.tech',\n             'password': 'YKH123456', 'is_active': True, 'is_staff': True, 'groups': [self.group.id]},\n            'job_state': 1, 'bank_no': '614457662', 'social_security_no': '\u6682\u65e0', 'on_job': True\n        }&lt;/code&gt;\n    \"\"\"\nqueryset = Staff.objects.all()\nserializer_class = StaffCreateSerializer\n</code></pre> <p>serializers.py</p> <pre><code># \u521b\u5efa\u7528\u6237\nclass StaffUserCreateSerializer(ModelSerializer):\ndef to_internal_value(self, data):\nif 'id' in data and 'id' in self.fields:\ntry:\nobj_id = self.fields['id'].to_internal_value(data['id'])\nexcept serializers.ValidationError as exc:\nraise serializers.ValidationError({'id': exc.detail})\nfor field in self.fields.values():\nfor validator in field.validators:\nfrom rest_framework.validators import UniqueValidator\nif type(validator) == UniqueValidator:\n# Exclude id from queryset for checking uniqueness\nvalidator.queryset = validator.queryset.exclude(id=obj_id)\nreturn super(StaffUserCreateSerializer, self).to_internal_value(data)\ndef create(self, validated_data):\n# print('StaffUserCreateSerializer-&gt;create')\ngroups = validated_data.pop('groups', None)\n# \u4f7f\u7528create_user\u4e0d\u662fcreate\ninstance = User.objects.create_user(**validated_data)\nif groups is not None:\ninstance.groups.add(*groups)\nreturn instance\ndef update(self, instance, validated_data):\n# print('StaffUserCreateSerializer-&gt;update')\npassword = validated_data.pop('password', None)\nsuper(StaffUserCreateSerializer, self).update(instance, validated_data)\nif password is not None:\ninstance.set_password(password)\ninstance.save()\nreturn instance\ndef validate_password(self, value):\n# \u9a8c\u8bc1\u5bc6\u7801\u683c\u5f0f\npassword_validation.validate_password(value)\nreturn value\nclass Meta:\nmodel = User\nfields = ('id', 'name', 'tel', 'email', 'password', 'is_active', 'is_staff', 'groups')\nclass StaffCreateSerializer(WritableNestedModelSerializer):\nuser = StaffUserCreateSerializer(label='\u7528\u6237')\nclass Meta:\nmodel = Staff\nfields = ('user', 'no', 'job_state', 'bank_no', 'social_security_no', 'on_job')\n</code></pre> <p>tests.py:</p> <pre><code>class StaffTests(APITestCase):\ndef setUp(self):\nself.user = User.objects.create_user(tel='18094213193', password='123456')\nself.user.user_permissions.add(*get_model_permission(Staff))\ntoken, _ = Token.objects.get_or_create(user=self.user)\nself.access_token = token.access_token\n# \u6570\u636e\nself.group = Group.objects.create(name='\u6d4b\u8bd5')\nself.data = {\n'user': {'name': 'YKH', 'tel': '17749503263', 'email': 'ykh@dreamgo.tech', 'password': 'YKH123456',\n'is_active': True, 'is_staff': True, 'groups': [self.group.id]},\n'job_state': 1, 'bank_no': '614457662', 'social_security_no': '\u6682\u65e0', 'on_job': True\n}\nself.data1 = {\n'user': {'name': 'YKH1', 'tel': '177495023263', 'email': 'y2kh@dreamgo.tech', 'password': 'YKH123456',\n'is_active': True, 'is_staff': True, 'groups': [self.group.id]},\n'job_state': 1, 'bank_no': '614457662', 'social_security_no': '\u6682\u65e0', 'on_job': True\n}\ndef test_staff_create(self):\n\"\"\"\u521b\u5efa\"\"\"\nurl = reverse('staff-list')\nself.client.credentials(HTTP_AUTHORIZATION='Token ' + self.access_token)\nresponse = self.client.post(url, self.data, format='json')\nprint('\u521b\u5efa', json.dumps(response.data, ensure_ascii=False, indent=2))\nself.assertEqual(response.status_code, status.HTTP_200_OK)\nStaff.objects.all().update(no='Staff002')\nresponse = self.client.post(url, self.data1, format='json')\nprint('\u521b\u5efa', json.dumps(response.data, ensure_ascii=False, indent=2))\nself.assertEqual(response.status_code, status.HTTP_200_OK)\ndef test_staff_update(self):\n\"\"\"\u66f4\u65b0\"\"\"\nuser = User.objects.create_user(tel='17749503263', password='YKH123456')\ninstance = Staff.objects.create(user=user, no='17749503263')\nprint('\u539f\u59cb\uff1a', instance.user.id)\nprint('\u65e7\u5bc6\u7801\u767b\u9646\u7ed3\u679c:', authenticate(tel='17749503263', password='YKH123456'))\nurl = reverse('staff-detail', kwargs={'pk': instance.id})\nself.client.credentials(HTTP_AUTHORIZATION='Token ' + self.access_token)\ndata = {\n'user': {'id': 2, 'name': 'YKH1', 'tel': '17749503263', 'password': 'YKH654321'},\n'job_state': 0, 'bank_no': '614457662'\n}\nresponse = self.client.patch(url, data, format='json')\nprint('\u66f4\u65b0', json.dumps(response.data, ensure_ascii=False, indent=2))\nprint('\u65b0\u5bc6\u7801\u767b\u9646\u7ed3\u679c:', authenticate(tel='17749503263', password='YKH654321'))\nself.assertEqual(response.status_code, status.HTTP_200_OK)\n</code></pre> <p>\u6d4b\u8bd5\u8f93\u51fa\uff1a</p> <pre><code>\u521b\u5efa {\n\"id\": 1,\n\"user\": {\n\"id\": 2,\n\"tel\": \"17749503263\",\n\"portrait\": \"http://testserver/media/default/user/default.png\",\n\"groups\": [\n{\n\"id\": 1,\n\"name\": \"\u53ea\u8bfb\"\n},\n{\n\"id\": 2,\n\"name\": \"\u6d4b\u8bd5\"\n}\n],\n\"last_login\": \"\",\n\"gender\": 2,\n\"name\": \"YKH\",\n\"birth_day\": \"\",\n\"email\": \"ykh@dreamgo.tech\",\n\"fixed_tel\": \"\",\n\"id_no\": \"\",\n\"qq\": \"\",\n\"contact_address\": \"\",\n\"brief_code\": \"\",\n\"get_gender_display\": \"\u4fdd\u5bc6\",\n\"get_full_name\": \"YKH\",\n\"is_staff\": true,\n\"is_superuser\": false,\n\"is_active\": true\n},\n\"no\": \"staff001\",\n\"job_state\": 1,\n\"bank_no\": \"614457662\",\n\"social_security_no\": \"\u6682\u65e0\",\n\"on_job\": true,\n\"create_time\": \"2018-05-08 16:20:14\",\n\"update_time\": \"2018-05-08 16:20:14\"\n}\n----------------------------------------------------\n\u539f\u59cb\uff1a 2\n\u65e7\u5bc6\u7801\u767b\u9646\u7ed3\u679c: 2 17749503263\n\u66f4\u65b0 {\n\"user\": {\n\"id\": 2,\n\"name\": \"YKH1\",\n\"tel\": \"17749503263\",\n\"email\": \"\",\n\"password\": \"pbkdf2_sha256$100000$OCufCY1edUNM$nxQpQCU77q+HXh6ADuiWqcV9azR1uLThDsuO+ZuWEOQ=\",\n\"is_active\": true,\n\"is_staff\": false,\n\"groups\": [\n1\n]\n},\n\"no\": \"17749503263\",\n\"job_state\": 0,\n\"bank_no\": \"614457662\",\n\"social_security_no\": \"\",\n\"on_job\": true\n}\n\u65b0\u5bc6\u7801\u767b\u9646\u7ed3\u679c: 2 YKH1\n</code></pre>"},{"location":"python/drf/drf-writable-nested/#m2m","title":"M2M\u76f4\u63a5\u5d4c\u5957\u65b0\u589e","text":""},{"location":"python/drf/drf-writable-nested/#_4","title":"\u6a21\u578b","text":"<pre><code># \u51fa\u5e93\nclass StorageOut(models.Model):\n# \u4e1a\u52a1\u5355\u53f7\nno = models.CharField(max_length=255,\nunique=True,\nverbose_name='\u4e1a\u52a1\u5355\u53f7')\n# \u51fa\u5e93\u5b50\u8bb0\u5f55\nitems = models.ManyToManyField('storage.StorageOutItem',\nverbose_name='\u51fa\u5e93\u5b50\u8bb0\u5f55')\n# \u51fa\u5e93\u5b50\u8bb0\u5f55\nclass StorageOutItem(models.Model):\n# \u5e93\u5b58\nstock = models.ForeignKey('storage.Stock',\nrelated_name='storage_out_item_stock',\nnull=True,\non_delete=models.SET_NULL,\nblank=True,\nverbose_name='\u5e93\u5b58')\n# \u51fa\u5e93\u6570\u91cf\nout_num = models.PositiveIntegerField(default=0,\nverbose_name='\u51fa\u5e93\u6570\u91cf')\n</code></pre>"},{"location":"python/drf/drf-writable-nested/#_5","title":"\u89c6\u56fe","text":"<p>views.py</p> <pre><code># \u51fa\u5e93\nclass StorageOutViewSet(ModelViewSet, BulkUpdateModelMixin):\n\"\"\"\n    create:&lt;code&gt;{'storage': \u4ed3\u5e93ID, 'category': 0, 'remarks': '\u51fa\u5165\u5907\u6ce8',\n        'items': [{'stock': \u5e93\u5b58ID, 'out_num': 2}]}&lt;/code&gt;\n    \"\"\"\nqueryset = StorageOut.objects.all()\nserializer_class = StorageOutCreateSerializer\n</code></pre> <p>serializers.py</p> <pre><code># \u521b\u5efa\u51fa\u5e93\u5b50\u8bb0\u5f55\nclass StorageOutItemModifySerializer(ModelSerializer):\nclass Meta:\nmodel = StorageOutItem\nfields = ('stock', 'out_num')\nextra_kwargs = {'stock': {'required': True}}\n# \u521b\u5efa\u51fa\u5e93\nclass StorageOutCreateSerializer(WritableNestedModelSerializer):\nitems = StorageOutItemModifySerializer(required=True, many=True, label='\u51fa\u5e93\u5b50\u8bb0\u5f55')\nclass Meta:\nmodel = StorageOut\nfields = ('no', 'items')\n</code></pre> <p>tests.py</p> <pre><code>class StorageOutTests(APITestCase):\ndef setUp(self):\n...\ndef test_out(self):\n\"\"\"\u51fa\u5e93\"\"\"\nresponse_out = self.client.post(url_out, {'no': 'no001, 'items': [{'stock': 1, 'out_num': 2}]},format='json')\nprint('\u51fa\u5e93\u65b0\u589e', json.dumps(response_out.data, ensure_ascii=False, indent=2))\n</code></pre> <p>\u6d4b\u8bd5\u8f93\u51fa\uff1a</p> <pre><code>\u51fa\u5e93\u65b0\u589e {\n\"id\": 1,\n\"no\": \"NO001\",\n\"items\": [\n{\n\"stock\": 1,\n\"medicine_batch\": {\n\"id\": 1,\n\"medicine\": {\n\"id\": 1,\n\"name\": \"999\u611f\u5192\u7075\",\n\"no\": \"NO999\"\n},\n\"stock_num\": 3,\n\"out_num\": 2,\n\"unit_price\": \"4.0000\",\n\"total_price\": \"8.0000\",\n\"create_time\": \"2018-05-08 16:36:58\",\n\"update_time\": \"2018-05-08 16:36:58\"\n}\n],\n\"create_time\": \"2018-05-08 16:36:58\",\n\"update_time\": \"2018-05-08 16:36:58\"\n}\n</code></pre> <p>Note:\u5728\u66f4\u65b0M2M\u5b57\u6bb5\u65f6\uff0c\u6709\u4e00\u90e8\u5206\u4e0d\u60f3\u4fee\u6539\u4e5f\u4e0d\u60f3\u4e0a\u4f20\u5bf9\u5e94id\u7684\u8bb0\u5f55\uff0c\u5219\u9700\u8981\u91cd\u5199serializer\u91cc\u7684update\u65b9\u6cd5\u4e3a\uff1a</p> <pre><code>def update(self, instance, validated_data):\nrelations, reverse_relations = self._extract_relations(validated_data)\n# Create or update direct relations (foreign key, one-to-one)\nself.update_or_create_direct_relations(validated_data, relations, )\n# Update instance\ninstance = super(PrescriptionCheckEscapeSerializer, self).update(instance, validated_data)\nself.update_or_create_reverse_relations(instance, reverse_relations)\n# \u4e0d\u5220\u9664\u65e7\u7684M2M\u6570\u636e\n# self.delete_reverse_relations_if_need(instance, reverse_relations)\nreturn instance\n</code></pre>"},{"location":"python/drf/drf-writable-nested/#_6","title":"\u5916\u952e\u53cd\u5411\u7ea7\u8054\u65b0\u589e","text":""},{"location":"python/drf/drf-writable-nested/#_7","title":"\u6a21\u578b","text":"<pre><code># \u8ba1\u91cf\u6807\u51c6\nclass UnitGroup(models.Model):\n# \u540d\u79f0\nname = models.CharField(max_length=255,\nverbose_name='\u540d\u79f0')\n# \u8ba1\u91cf\u5355\u4f4d\nclass Unit(models.Model):\n# \u8ba1\u91cf\u6807\u51c6\nunit_group = models.ForeignKey('medicine.UnitGroup',\nrelated_name='unit_unit_group',\nnull=True,\non_delete=models.SET_NULL,\nverbose_name='\u8ba1\u91cf\u6807\u51c6')\n# \u540d\u79f0\nname = models.CharField(max_length=255,\nverbose_name='\u540d\u79f0')\n# \u663e\u793a\u540d\u79f0\ndisplay_name = models.CharField(max_length=255,\nverbose_name='\u663e\u793a\u540d\u79f0')\n</code></pre>"},{"location":"python/drf/drf-writable-nested/#_8","title":"\u89c6\u56fe","text":"<p>views.py \u540c\u4e0a</p> <p>serializers.py:</p> <pre><code># \u521b\u5efa\u8ba1\u91cf\u5355\u4f4d\nclass UnitCreateSerializer(ModelSerializer):\nclass Meta:\nmodel = Unit\nfields = ('name', 'display_name', 'ratio', 'is_active')\n# \u521b\u5efa\u8ba1\u91cf\u6807\u51c6\nclass UnitGroupCreateSerializer(WritableNestedModelSerializer):\nunit_unit_group = UnitCreateSerializer(many=True)\nclass Meta:\nmodel = UnitGroup\nfields = ('unit_unit_group', 'name')\n</code></pre> <p>tests.py:</p> <pre><code>class UnitGroupTests(APITestCase):\ndef setUp(self):\ntry:\nself.user = User.objects.get(tel='18094213198')\nexcept User.DoesNotExist:\nself.user = User.objects.create_user(tel='18094213198', password='123456')\nself.user.user_permissions.add(*get_model_permission(UnitGroup))\ntoken, _ = Token.objects.get_or_create(user=self.user)\nself.access_token = token.access_token\ndef test_create(self):\n\"\"\"\u521b\u5efa\"\"\"\nurl = reverse('unitgroup-list')\nself.client.credentials(HTTP_AUTHORIZATION='Token ' + self.access_token)\ndata = {'name': '\u91cd\u91cf', 'unit_unit_group': [{'name': '1', 'display_name': 'yi'}]}\nresponse = self.client.post(url, data, format='json')\nprint([(x, x.unit_group) for x in Unit.objects.all()])\nprint('\u521b\u5efa', json.dumps(response.data, ensure_ascii=False, indent=2))\nself.assertEqual(response.status_code, status.HTTP_200_OK)\n</code></pre> <p>\u6d4b\u8bd5\u8f93\u51fa\uff1a</p> <pre><code>[(&lt;Unit: 1&gt;, &lt;UnitGroup: \u91cd\u91cf&gt;)]\n\u521b\u5efa {\n\"id\": 1,\n\"name\": \"\u91cd\u91cf\",\n\"create_time\": \"2018-05-08 16:59:51\",\n\"update_time\": \"2018-05-08 16:59:51\"\n}\n</code></pre>"},{"location":"python/drf/drf-writable-nested/#uniquetrue","title":"unique=True","text":"<p>\u5f53\u6a21\u578b\u4e2d\u6709unique=True\u7684\u5b57\u6bb5\u65f6\uff0c\u5728\u5d4c\u5957\u66f4\u65b0\u65f6\u4f20\u9012\u4e86\u548c\u66f4\u65b0\u524d\u76f8\u540c\u7684\u8be5\u5b57\u6bb5\uff0c\u4f9d\u65e7\u63d0\u793a\u8be5\u5b57\u6bb5\u5df2\u5b58\u5728\u7684\u95ee\u9898\u3002 \u6211\u4eec\u4ee5<code>\u5916\u952e\u6216O2O\u76f4\u63a5\u5d4c\u5957\u65b0\u589e</code>\u4e2d\u7684\u6a21\u578b\u6765\u8bb2\u89e3\uff0c\u5176\u66f4\u65b0\u65f6\u4f7f\u7528\u7684serializer\u4e3a\uff1a</p> <pre><code># \u66f4\u65b0\u5458\u5de5\nclass StaffUpdateSerializer(WritableNestedModelSerializer):\nuser = StaffUserCreateSerializer(label='\u7528\u6237', partial=True)\nclass Meta:\nmodel = Staff\nfields = ('user', 'no', 'job_state', 'bank_no', 'social_security_no', 'on_job')\n</code></pre> <p>\u5728python shell\u8f93\u5165\uff1a</p> <pre><code>from user.models import User, Staff\nstaff = Staff.objects.first()\nfrom user.serializers import StaffUpdateSerializer\nserializer = StaffUpdateSerializer(staff, partial=True)\nprint(repr(serializer))\n\u5f97\u5230\uff1a\nStaffUpdateSerializer(&lt;Staff: s&gt;, partial=True):\nuser = StaffUserCreateSerializer(label='\u7528\u6237', partial=True):\nid = IntegerField(label='ID', read_only=True, required=False)\nname = CharField(allow_blank=True, label='\u59d3\u540d', max_length=30, required=False)\ntel = CharField(allow_null=True, label='\u624b\u673a\u53f7\u7801', max_length=20, required=True, validators=[&lt;UniqueValidator(queryset=User.objects.all())&gt;])\nemail = CharField(allow_blank=True, allow_null=True, label='\u7535\u5b50\u90ae\u4ef6', max_length=255, required=False, validators=[&lt;UniqueValidator(queryset=User.objects.all())&gt;])\npassword = CharField(label='\u5bc6\u7801', max_length=128, required=True)\nis_active = BooleanField(label='\u6709\u6548', required=False)\nis_staff = BooleanField(label='\u804c\u5458\u72b6\u6001', required=False)\ngroups = PrimaryKeyRelatedField(help_text='\u8be5\u7528\u6237\u5f52\u5c5e\u7684\u7ec4\u3002\u4e00\u4e2a\u7528\u6237\u5c06\u5f97\u5230\u5176\u5f52\u5c5e\u7684\u7ec4\u7684\u6240\u6709\u6743\u9650\u3002', label='\u7ec4', many=True, queryset=Group.objects.all(), required=False)\nno = CharField(label='\u5de5\u53f7', max_length=255, required=True, validators=[&lt;UniqueValidator(queryset=Staff.objects.all())&gt;])\njob_state = ChoiceField(choices=dict_items([(0, '\u5168\u804c'), (1, '\u517c\u804c')]), label='\u5165\u804c\u7c7b\u578b', required=False, validators=[&lt;django.core.validators.MinValueValidator object&gt;, &lt;django.core.validators.MaxValueValidator object&gt;])\nbank_no = CharField(allow_blank=True, label='\u94f6\u884c\u5361\u53f7\u7801', max_length=30, required=False)\nsocial_security_no = CharField(allow_blank=True, label='\u793e\u4fdd\u53f7', max_length=30, required=False)\non_job = BooleanField(label='\u662f\u5426\u5728\u804c', required=False)\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230<code>StaffUserCreateSerializer</code>\u4e2d\u6ca1\u6709<code>instance</code>\u5bf9\u8c61\uff0c\u6240\u4ee5<code>tel</code>\u5b57\u6bb5\u7684<code>UniqueValidator</code>\u8303\u56f4\u4e3a<code>queryset=User.objects.all()</code>\u3002\u7531\u6b64\u53ef\u89c1\u5bfc\u81f4\u4e0a\u8ff0\u95ee\u9898\u7684\u4e3b\u8981\u539f\u56e0\u662f<code>serializer</code>\u5728\u5b9e\u4f8b\u5316\u7684\u65f6\u5019\u5e76\u6ca1\u6709\u628a<code>staff</code>\u5bf9\u5e94\u7684<code>user</code>\u4f5c\u4e3a<code>instance</code>\u4f20\u9012\u7ed9<code>StaffUserCreateSerializer</code>\u3002</p> <p>\u4e0b\u9762\u7ed9\u51fa\u4e24\u79cd\u89e3\u51b3\u65b9\u6848\uff0c\u6709\u5174\u8da3\u7684\u53ef\u4ee5\u67e5\u770b\uff1a</p> <p>\u65b9\u6cd51\uff1a\u5728 <code>rest_framework/validators.py/BaseUniqueForValidator</code> \u4e2d\u6709\u5982\u4e0b\u65b9\u6cd5\uff0c\u5f53<code>serializer</code>\u6709<code>instance</code>\u65f6\uff0c\u552f\u4e00\u9a8c\u8bc1\u7684\u8303\u56f4\u4f1a\u6392\u9664\u5f53\u524d<code>instance</code>,\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48\u90e8\u5206\u66f4\u65b0<code>instance</code>\u65f6\u4e0a\u4f20<code>instance</code>\u539f\u5148\u7684\u552f\u4e00\u503c\u4e0d\u4f1a\u62a5\u9519\u7684\u539f\u56e0\u3002</p> <pre><code>def exclude_current_instance(self, attrs, queryset):\n\"\"\"\n    If an instance is being updated, then do not include\n    that instance itself as a uniqueness conflict.\n    \"\"\"\nif self.instance is not None:\nreturn queryset.exclude(pk=self.instance.pk)\nreturn queryset\n</code></pre> <p>\u57fa\u4e8e\u4e0a\u9762\u7684\u601d\u8def\uff0c\u6211\u4eec\u53ef\u4ee5\u4e3a<code>UniqueValidator</code>\u91cd\u65b0\u7b5b\u9009\u8303\u56f4\uff1a</p> <pre><code>class UserSerializer(ModelSerializer):\n# Reverse OneToOne relation\nprofile = ProfileSerializer(required=False, allow_null=True)\ndef to_internal_value(self, data):\nif 'pk' in data and 'pk' in self.fields:\nprint(data)\ntry:\nobj_id = self.fields['pk'].to_internal_value(data['pk'])\nexcept serializers.ValidationError as exc:\nraise serializers.ValidationError({'pk': exc.detail})\nfor field in self.fields.values():\nfor validator in field.validators:\nfrom rest_framework.validators import UniqueValidator\nif type(validator) == UniqueValidator:\n# Exclude id from queryset for checking uniqueness\nvalidator.queryset = validator.queryset.exclude(id=obj_id)\nreturn super(UserSerializer, self).to_internal_value(data)\n</code></pre> <p>\u65b9\u6cd52\uff1a\u5c06\u5bf9\u5e94\u7684<code>id/pk</code>\u8f6c\u5316\u4e3a<code>instance</code>:</p> <pre><code>class StaffUserCreateSerializer(ModelSerializer):\ndef to_internal_value(self, data):\nif 'pk' in data and 'pk' in self.fields:\nprint(data)\ntry:\nobj_id = self.fields['pk'].to_internal_value(data['pk'])\nexcept serializers.ValidationError as exc:\nraise serializers.ValidationError({'pk': exc.detail})\nself.instance = self.Meta.model.objects.get(id=obj_id)\nreturn super(StaffUserCreateSerializer, self).to_internal_value(data)\nclass Meta:\nmodel = User\nfields = ('pk', 'name', 'tel',)\nclass StaffModifySerializer(WritableNestedModelSerializer):\nuser = StaffUserCreateSerializer(label='User', partial=True)\nclass Meta:\nmodel = Staff\nfields = ('user', 'job_state', 'bank_no', 'social_security_no', 'on_job')\n</code></pre> <p>\u76f8\u5173Issue:</p> <p>DRF issue2403 DRF issue 2996 drf-writable-nested issue 34</p>"},{"location":"python/drf/rest_framework_cache/","title":"rest_framework_cache\u4f18\u5316\u63a5\u53e3\u8bbf\u95ee\u901f\u5ea6","text":""},{"location":"python/drf/rest_framework_cache/#_1","title":"\u573a\u666f","text":"<p>\u5728DRF\u4e2d\uff0c\u6709\u4e00\u4e9b\u9ad8\u9891\u7684\u5217\u8868\u63a5\u53e3(\u5982\u4f9b\u524d\u7aef\u641c\u7d22\u4e0b\u62c9\u9009\u62e9\u7684\u6570\u636e\u6e90\u63a5\u53e3)\uff0c\u4f7f\u7528\u7f13\u5b58\u53ef\u4ee5\u5927\u5e45\u5ea6\u7684\u63d0\u9ad8\u63a5\u53e3\u7684\u54cd\u5e94\u901f\u5ea6\u3002</p>"},{"location":"python/drf/rest_framework_cache/#_2","title":"\u9879\u76ee\u4ecb\u7ecd","text":"<p><code>django-rest-framework-cache</code>\u662f\u4e00\u4e2a\u5d4c\u5165<code>Serializer</code>\u5c42\u53bb\u7f13\u5b58\u6570\u636e\u7684\u5de5\u5177\uff0c\u901a\u8fc7\u91cd\u5199<code>Serializer</code>\u7684<code>to_representation</code>\u65b9\u6cd5\u6765\u5b9e\u73b0\u7f13\u5b58\u3002\u82e5\u4f60\u91cd\u5199\u4e86<code>ModelSerializer</code>\u7684<code>to_representation</code>\u65b9\u6cd5\u3002</p> <p>Github\u4ed3\u5e93\u5730\u5740</p>"},{"location":"python/drf/rest_framework_cache/#_3","title":"\u5b89\u88c5","text":"<pre><code>pip install rest-framework-cache\n</code></pre> <p>settings.py:</p> <pre><code>INSTALLED_APPS = (\n...\n'rest_framework_cache',\n)\n</code></pre> <p>urls.py:</p> <pre><code>from rest_framework_cache.registry import cache_registry\ncache_registry.autodiscover()\n</code></pre>"},{"location":"python/drf/rest_framework_cache/#_4","title":"\u914d\u7f6e","text":""},{"location":"python/drf/rest_framework_cache/#_5","title":"\u7f13\u5b58\u6e90","text":"<pre><code>CACHES = {\n'default': {\n'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache',\n'LOCATION': '127.0.0.1:11211',\n},\n'rest_backend': {\n'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',\n'LOCATION': 'unique-snowflake',\n}\n}\nREST_FRAMEWORK_CACHE = {\n'DEFAULT_CACHE_BACKEND': 'rest_backend',\n}\n</code></pre>"},{"location":"python/drf/rest_framework_cache/#_6","title":"\u5168\u5c40\u8d85\u65f6\u65f6\u957f","text":"<pre><code>REST_FRAMEWORK_CACHE = {\n'DEFAULT_CACHE_TIMEOUT': 86400, # Default is 1 day\n}\n</code></pre>"},{"location":"python/drf/rest_framework_cache/#_7","title":"\u7528\u6cd5","text":"<pre><code>from rest_framework import serializers\n# You must import the CachedSerializerMixin and cache_registry\nfrom rest_framework_cache.serializers import CachedSerializerMixin\nfrom rest_framework_cache.registry import cache_registry\nfrom .models import Comment\nclass CommentSerializer(serializers.ModelSerializer, CachedSerializerMixin):\nclass Meta:\nmodel = Comment\ncache_registry.register(CommentSerializer)\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9879\uff1a<code>django-rest-framework-cache</code>\u901a\u8fc7\u91cd\u5199<code>Serializer</code>\u7684<code>to_representation</code>\u65b9\u6cd5\u6765\u5b9e\u73b0\u7f13\u5b58\u3002\u82e5\u4f60\u91cd\u5199\u4e86<code>ModelSerializer</code>\u7684<code>to_representation</code>\u65b9\u6cd5,\u56e0\u4e3aPython3\u7684MRO\u7b97\u6cd5\u7684\u539f\u56e0\uff0c<code>Serializer</code>\u4f7f\u7528\u65f6\u5e94\u5148\u7ee7\u627f<code>CachedSerializerMixin</code>:</p> <pre><code>class CommentSerializer(CachedSerializerMixin, CustomModelSerializer):\n</code></pre>"},{"location":"python/drf/rest_framework_cache/#_8","title":"\u5b9e\u6d4b\u6548\u679c","text":"<p>\u6570\u636e\u5217\u8868\u8fd4\u56de\u7684\u6570\u636e\u5171\u6709310\u6761\u7c7b\u4f3c\u4e0b\u5217\u7684\u6570\u636e\uff1a</p> <pre><code>{\n\"id\": 310,\n\"name\": \"\u8292\u679c\",\n\"no\": \"600006\",\n\"unit_group\": {\n\"id\": 1,\n\"name\": \"\u91cd\u91cf\",\n\"minimum_unit\": {\n\"id\": 4,\n\"name\": \"g\",\n\"display_name\": \"\u514b\"\n}\n}\n}\n</code></pre> <p>\u5728CPU:<code>i7-7700 3.6G</code> \u5185\u5b58\uff1a<code>16GB</code> \u7cfb\u7edf:<code>Win764</code>\u4f4d\uff0c\u4f7f\u7528<code>requests</code>\u5de5\u5177\u8bbf\u95ee100\u6b21\u7684\u5e73\u5747\u7528\u65f6\u5982\u4e0b\uff1a</p> <p>\u4f7f\u7528<code>Cached</code>\u524d\uff1a0.459s \u4f7f\u7528<code>LocMemCache</code>\u540e\uff1a0.197s \u4f7f\u7528<code>MemcachedCache</code>\u540e\uff1a0.0538s</p> <p>\u5728CPU:<code>G4400 0.8G</code> \u5185\u5b58\uff1a<code>8GB</code> \u7cfb\u7edf:<code>Ubuntu14.04</code>\u4f4d\uff0c\u4f7f\u7528<code>requests</code>\u5de5\u5177\u8bbf\u95ee100\u6b21\u7684\u5e73\u5747\u7528\u65f6\u5982\u4e0b\uff1a</p> <p>\u4f7f\u7528<code>Cached</code>\u524d\uff1a0.639s \u4f7f\u7528<code>LocMemCache</code>\u540e\uff1a0.319s \u4f7f\u7528<code>MemcachedCache</code>\u540e\uff1a0.0817s</p> <p><code>django-rest-framework-cache</code>\u4f7f\u7528<code>LocMemCache</code>\u4f18\u5316\u540e\u53ef\u4ee5\u7f29\u77ed\u7528\u65f6\u81f3\u539f\u5148\u7684<code>1/2</code>\uff0c\u4f7f\u7528<code>MemcachedCache</code>\u4f18\u5316\u540e\u53ef\u4ee5\u7f29\u77ed\u7528\u65f6\u81f3\u539f\u5148\u7684<code>1/8</code>\u3002</p>"},{"location":"python/drf/rest_framework_cache/#issuefkm2mupdated-in-20180802","title":"Issue:\u5d4c\u5957\u7684FK\u6570\u636e\u6216\u8005M2M\u6570\u636e\u4fee\u6539\u540e\u4e0d\u751f\u6548\u95ee\u9898\uff08Updated in 2018/08/02\uff09","text":"<p>\u7ecf\u8fc7\u4e00\u4e2a\u591a\u6708\u7684\u4f7f\u7528\uff0c\u53d1\u73b0\u6b64\u63d2\u4ef6\u6709\u4e00\u4e2a\u4e0d\u5b8c\u7f8e\u7684\u5730\u65b9\u3002\u4ee5\u4e0a\u8ff0\u7684\u8bc4\u8bba\u6a21\u578b<code>Comment</code>\u4e3a\u4f8b\uff0c\u5047\u8bbe\u8bc4\u8bba\u6709\u4e00\u4e2a\u5916\u952e\u53eb\u6240\u5c5e\u4eba<code>owner</code>,\u5728\u5217\u8868\u8bc4\u8bba\u7684\u65f6\u5019,\u4f7f\u7528\u7684<code>Serializer</code>\u5982\u4e0b\uff1a</p> <pre><code>class CommentSerializer(serializers.ModelSerializer, CachedSerializerMixin):\nowner = UserSerializer(read_only=True)\nclass Meta:\nmodel = Comment\n</code></pre> <p>\u5f53\u8bc4\u8bba\u5217\u8868\u7684\u6570\u636e\u88ab\u7f13\u5b58\u4e0b\u6765\u4ee5\u540e\uff0c\u518d\u53bb\u4fee\u6539\u8bc4\u8bba\u4e2d\u5bf9\u5e94<code>owner</code>\u7684\u4fe1\u606f\uff0c\u518d\u6b21\u8bbf\u95ee\u8be5\u8bc4\u8bba\u5217\u8868\u53d6\u5230\u7684\u4f9d\u65e7\u662f\u672a\u4fee\u6539\u524d\u7684\u7528\u6237\u4fe1\u606f\u3002\u8fd9\u662f\u56e0\u4e3a\u7f13\u5b58\u7684<code>serializer</code>\u4fe1\u606f\uff0c\u53ea\u6709\u5728\u8be5<code>serializer</code>\u5bf9\u5e94\u7684<code>Model</code>\u5b9e\u4f8b\u88ab\u4fee\u6539\u540e\u624d\u4f1a\u5237\u65b0\uff0c\u4e5f\u5c31\u662f\u8bf4\u53ea\u6709\u5728<code>Comment</code>\u5b9e\u4f8b\u88ab\u4fee\u6539\u65f6\u7f13\u5b58\u624d\u4f1a\u88ab\u5237\u65b0\uff0c\u4fee\u6539<code>Comment</code>\u5bf9\u5e94\u7684\u5916\u952e<code>User</code>\u5b9e\u4f8b\u5e76\u4e0d\u4f1a\u53bb\u5237\u65b0\u7f13\u5b58\u3002</p> <p>\u5bf9\u6b64\u63d2\u4ef6\u505a\u5982\u4e0b\u6539\u8fdb\uff0c\u91cd\u5199<code>CachedSerializerMixin</code>\uff0c\u4f7f\u5176\u53ef\u4ee5\u9009\u62e9\u67d0\u4e00\u4e9b\u5b57\u6bb5\u4e0d\u8fdb\u884c\u7f13\u5b58\uff1a</p> <pre><code>from collections import OrderedDict\nfrom django.utils.functional import cached_property\nfrom rest_framework import serializers\nfrom rest_framework.fields import SkipField\nfrom rest_framework.relations import PKOnlyObject\nfrom rest_framework_cache.cache import cache\nfrom rest_framework_cache.settings import api_settings\nfrom rest_framework_cache.utils import get_cache_key\nclass CachedSerializerMixin(serializers.ModelSerializer):\ndef _get_cache_key(self, instance):\nrequest = self.context.get('request')\nprotocol = request.scheme if request else 'http'\nreturn get_cache_key(instance, self.__class__, protocol)\n@cached_property\ndef _not_cache_fields(self):\nnot_cache_fields = getattr(self.Meta, 'not_cache_fields', [])\nreturn [\nfield for field in self.fields.values()\nif field.field_name in not_cache_fields\n]\n@cached_property\ndef _cacheable_fields(self):\nnot_cache_fields = getattr(self.Meta, 'not_cache_fields', [])\nreturn [\nfield for field in self.fields.values()\nif not field.write_only and field.field_name not in not_cache_fields\n]\ndef fields_to_representation(self, instance, fields, ret):\nfor field in fields:\ntry:\nattribute = field.get_attribute(instance)\nexcept SkipField:\ncontinue\ncheck_for_none = attribute.pk if isinstance(attribute, PKOnlyObject) else attribute\nif check_for_none is None:\nret[field.field_name] = None\nelse:\nret[field.field_name] = field.to_representation(attribute)\nreturn ret\ndef to_representation(self, instance):\n\"\"\"\n        Checks if the representation of instance is cached and adds to cache\n        if is not.\n        \"\"\"\nkey = self._get_cache_key(instance)\ncached = cache.get(key)\nif cached:\nret = cached\nelse:\nret = OrderedDict()\nret = self.fields_to_representation(instance, self._cacheable_fields, ret)\ncache.set(key, ret, api_settings.DEFAULT_CACHE_TIMEOUT)\nret = self.fields_to_representation(instance, self._not_cache_fields, ret)\nreturn ret\n</code></pre> <p>\u7528\u6cd5\uff1a</p> <pre><code>class UserSerializer(serializers.ModelSerializer, CachedSerializerMixin):\nclass Meta:\nmodel = User\ncache_registry.register(UserSerializer)\nclass CommentSerializer(serializers.ModelSerializer, CachedSerializerMixin):\nowner = UserSerializer(read_only=True)\nclass Meta:\nmodel = Comment\nnot_cache_fields = ('owner',)\ncache_registry.register(CommentSerializer)\n</code></pre> <p>\u4f7f\u7528<code>not_cache_fields</code>\u9009\u9879\u6307\u5b9a<code>CommentSerializer</code>\u4e0d\u7f13\u5b58<code>owner</code>\u5b57\u6bb5\uff0c\u8be5\u5b57\u6bb5\u7531<code>UserSerializer</code>\u7684\u7f13\u5b58\u8bfb\u53d6\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\u4e86\u3002</p> <p>\u5df2\u63d0\u4ea4PR,\u4e0d\u8fc7\u6309\u4f5c\u8005\u7684\u60c5\u51b5\u6765\u770b\u53ef\u80fd\u4e0d\u4f1a\u5408\u5e76\u4e86\u3002\u6211Fork\u51fa\u6765\u4fee\u6539\u597d\u7684\u5e93\u89c1\u6b64\u5904\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u56e0\u4e3a\u7cbe\u529b\u6709\u9650\u7684\u539f\u56e0\u8be5\u6539\u8fdb\u4ec5\u5728<code>djangorestframework==3.8.2</code>\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u4e86\u6d4b\u8bd5\u3002</p>"},{"location":"python/fastapi/Flask-Django-FastApi-SpringBoot-Go-performance/","title":"Flask\u3001Django\u3001FastApi\u3001SpringBoot\u3001Go\u6027\u80fd\u6bd4\u8f83","text":""},{"location":"python/fastapi/Flask-Django-FastApi-SpringBoot-Go-performance/#_1","title":"\u8bf4\u660e","text":"<p>\u6d4b\u8bd5\u73af\u5883\u4e3a\u4e24\u53f01\u68382G\u7684centos7\u865a\u62df\u673a\uff0c\u4e00\u53f0\u4f7f\u7528wrk\u8fdb\u884c\u6d4b\u8bd5\uff0c\u4e00\u53f0\u90e8\u7f72\u4e1a\u52a1\uff0c\u6570\u636e\u5e93\u4e3a\u90e8\u7f72\u4e8e\u4e1a\u52a1\u673a\u5668\u7684Mysql5.7\uff0c\u6700\u5927\u8fde\u63a5\u6570\u4e3a2000\u3002</p> <p>\u6d4b\u8bd5\u4ee3\u7801\u5747\u4e0d\u76f8\u540c(\u6ca1\u65f6\u95f4\u5199\u592a\u591aDemo\uff0c\u5747\u627e\u4e00\u4e9b\u529f\u80fd\u76f8\u4f3c\u7684\u63a5\u53e3\u8fdb\u884c\u6d4b\u8bd5)\uff0c\u4e3b\u8981\u903b\u8f91\u662f\u7531\u6570\u636e\u5e93\u4e2d\u8bfb\u53d6\u5355\u6761\u6570\u636e\u540e\u5e8f\u5217\u5316\u901a\u8fc7api\u8fd4\u56de\u3002</p> <p>\u5927\u81f4\u6d4b\u8bd5\u7ed3\u679c\u4e3a\uff0c\u7ecf\u4f9b\u53c2\u8003\uff1a</p> \u6846\u67b6 \u90e8\u7f72\u65b9\u5f0f \u6bcf\u79d2\u5904\u7406\u8bf7\u6c42\u6570 Django2.0+DRF gunicorn+gevent 75 Django3.1+DRF gunicorn+gevent wsgi 95 Django3.1+DRF uvicorn asgi 181 Flask+SQLAlchemy gunicorn+gevent 210 SpringBoot java -jar 343 FastApi+Tortoise ORM uvicorn asgi 568 Go(Gin\u6846\u67b6) ./bubble conf/config.ini 3984.92"},{"location":"python/fastapi/Flask-Django-FastApi-SpringBoot-Go-performance/#_2","title":"\u6d4b\u8bd5\u6570\u636e","text":""},{"location":"python/fastapi/Flask-Django-FastApi-SpringBoot-Go-performance/#django20drf","title":"Django2.0+DRF","text":"<p>Django+DjangoRestFramework\u6838\u5fc3\u4ee3\u7801;</p> <pre><code>def retrieve(self, request, *args, **kwargs):\n  instance = self.get_object()\n  serializer = TodoSerializer(instance, context=self.get_serializer_context())\n  return success_response(serializer.data)\n</code></pre> <p>Django+gunicorn+gevent \u8d44\u6e90\u8be6\u60c5\u63a5\u53e3</p> <pre><code>[root@localhost opt]# wrk -t 8 -c 100 -d 120 --latency http://192.168.11.5:6000/api/todo/f83e3a9c-2650-4beb-b1f1-a2a93cd13175/\nRunning 2m test @ http://192.168.11.5:6000/api/todo/f83e3a9c-2650-4beb-b1f1-a2a93cd13175/\n8 threads and 100 connections\nThread Stats   Avg     Stdev     Max   +/- Stdev\n  Latency   25.28ms 120.30ms   1.95s   98.89%\n  Req/Sec   64.00     24.27   90.00     79.69%\nLatency Distribution\n    50%   12.36ms\n    75%   13.36ms\n    90%   23.06ms\n    99% 258.84ms\n8977 requests in 2.00m, 5.85MB read\nSocket errors: connect 0, read 492, write 0, timeout 718\nRequests/sec:     74.78\nTransfer/sec:     49.88KB\n</code></pre> <p>Top\u6570\u636e</p> <pre><code>  PID USER     PR NI   VIRT   RES   SHR S %CPU %MEM     TIME+ COMMAND\n4619 mysql     20   0 1189752 295300   8732 S 34.9 15.9   0:08.83 mysqld\n4966 root     20   0 384904 66672   6732 R 32.2 3.6   0:08.28 gunicorn \n4967 root     20   0 385156 66908   6724 R 32.2 3.6   0:08.60 gunicorn  \n</code></pre>"},{"location":"python/fastapi/Flask-Django-FastApi-SpringBoot-Go-performance/#flask","title":"Flask","text":"<p>Flask\u6838\u5fc3\u4ee3\u7801</p> <pre><code>def retrieve():\n  log.info(f'\u8c03\u7528/retrieve\u63a5\u53e3')\n  _id = request.args.get('id')\n  serializer = CookieSerializer(cookie)\n  return return_template(code=1, msg='success', result=serializer.data))\n</code></pre> <p>Flask+gunicorn+gevent \u8d44\u6e90\u8be6\u60c5\u63a5\u53e3</p> <pre><code>[root@localhost opt]# wrk -t 8 -c 100 -d 120 --latency \"http://192.168.11.5:6000/cookies/retrieve?cookie_id=2c1ec53e-b4d2-4601-9298-7e608c8eb5d7&amp;platform=0\"\nRunning 2m test @ http://192.168.11.5:6000/cookies/retrieve?cookie_id=2c1ec53e-b4d2-4601-9298-7e608c8eb5d7&amp;platform=0\n8 threads and 100 connections\nThread Stats   Avg     Stdev     Max   +/- Stdev\n  Latency   454.27ms   70.46ms 763.42ms   69.37%\n  Req/Sec   26.99     13.76   110.00     69.20%\nLatency Distribution\n    50% 445.85ms\n    75% 493.55ms\n    90% 547.84ms\n    99% 661.73ms\n25309 requests in 2.00m, 18.60MB read\nRequests/sec:   210.81\nTransfer/sec:   158.67KB\n</code></pre> <p>Top</p> <pre><code>  PID USER     PR NI   VIRT   RES   SHR S %CPU %MEM     TIME+ COMMAND\n5290 root     20   0 949312 82068   3896 R 47.4 4.4   0:37.43 gunicorn\n5289 root     20   0 944252 75156   3876 R 46.7 4.0   0:36.86 gunicorn\n4619 mysql     20   0 1211500 303244   8948 S 4.3 16.3   0:44.21 mysqld  \n</code></pre>"},{"location":"python/fastapi/Flask-Django-FastApi-SpringBoot-Go-performance/#springboot","title":"SpringBoot","text":"<p>wrk\u6d4b\u8bd5\u7ed3\u679c\uff1a</p> <pre><code>[root@localhost opt]# wrk -t 8 -c 500 -d 30 --latency http://192.168.11.5:8809/api/registerCenter/page\nRunning 30s test @ http://192.168.11.5:8809/api/registerCenter/page\n8 threads and 500 connections\nThread Stats   Avg     Stdev     Max   +/- Stdev\n  Latency     1.25s   287.88ms   2.00s   80.07%\n  Req/Sec   51.77     40.90   386.00     73.08%\nLatency Distribution\n    50%   1.27s \n    75%   1.39s \n    90%   1.55s \n    99%   1.95s \n10334 requests in 30.06s, 5.11MB read\nSocket errors: connect 0, read 0, write 0, timeout 857\nRequests/sec:   343.77\nTransfer/sec:   174.24KB\n</code></pre> <p>TOP\u6570\u636e</p> <pre><code>  PID USER     PR NI   VIRT   RES   SHR S %CPU %MEM     TIME+ COMMAND\n6161 root     20   0 3133868 521532 14068 S 90.2 28.0   2:08.70 java   \n4619 mysql     20   0 1191436 302916   9100 S 8.2 16.3   1:01.23 mysqld \n</code></pre>"},{"location":"python/fastapi/Flask-Django-FastApi-SpringBoot-Go-performance/#django31","title":"Django3.1","text":""},{"location":"python/fastapi/Flask-Django-FastApi-SpringBoot-Go-performance/#django31gunicorn-wsgi","title":"django3.1+gunicorn wsgi","text":"<pre><code>[root@localhost ~]# wrk -t 8 -c 500 -d 30 --latency http://192.168.11.5:8000/api/command/1/\nRunning 30s test @ http://192.168.11.5:8000/api/command/1/\n8 threads and 500 connections\nThread Stats   Avg     Stdev     Max   +/- Stdev\n  Latency   24.08ms   66.73ms   1.94s   99.56%\n  Req/Sec   48.30     9.63   108.00     87.76%\nLatency Distribution\n    50%   20.11ms\n    75%   20.95ms\n    90%   23.99ms\n    99%   35.17ms\n2877 requests in 30.07s, 1.59MB read\nSocket errors: connect 0, read 408, write 0, timeout 142\nRequests/sec:     95.67\nTransfer/sec:     54.00KB\n</code></pre>"},{"location":"python/fastapi/Flask-Django-FastApi-SpringBoot-Go-performance/#django31uvicorn-asgi","title":"django3.1+uvicorn asgi","text":"<pre><code>[root@localhost ~]# wrk -t 8 -c 500 -d 30 --latency http://192.168.11.5:8000/api/command/1/\nRunning 30s test @ http://192.168.11.5:8000/api/command/1/\n8 threads and 500 connections\nThread Stats   Avg     Stdev     Max   +/- Stdev\n  Latency     1.80s   12.53ms   1.82s   95.62%\n  Req/Sec   159.07   231.52   610.00     75.42%\nLatency Distribution\n    50%   1.81s \n    75%   1.81s \n    90%   1.81s \n    99%   1.81s \n5456 requests in 30.04s, 2.84MB read\nSocket errors: connect 0, read 0, write 0, timeout 5205\nRequests/sec:   181.63\nTransfer/sec:     96.85KB\n</code></pre>"},{"location":"python/fastapi/Flask-Django-FastApi-SpringBoot-Go-performance/#fastapi","title":"FastAPI","text":"<p>Fastapi+uvicorn+Tortoise ORM</p> <pre><code>[root@localhost ~]# wrk -t 8 -c 500 -d 30 --latency http://192.168.11.5:8000/client/1\nRunning 30s test @ http://192.168.11.5:8000/client/1\n8 threads and 500 connections\nThread Stats   Avg     Stdev     Max   +/- Stdev\n  Latency   751.06ms 526.96ms   1.95s   59.53%\n  Req/Sec   112.46   107.55   650.00     78.82%\nLatency Distribution\n    50% 848.00ms\n    75% 934.46ms\n    90%   1.65s \n    99%   1.82s \n17120 requests in 30.09s, 8.72MB read\nSocket errors: connect 0, read 0, write 0, timeout 860\nRequests/sec:   568.93\nTransfer/sec:   296.69KB\n</code></pre> <p>TOP\u6570\u636e</p> <pre><code>PID USER     PR NI   VIRT   RES   SHR S %CPU %MEM     TIME+ COMMAND\n28082 root     20   0 380140 56708   8628 R 87.3 3.0   1:52.78 uvicorn\n1132 mysql     20   0 1159764 254644   9260 S 11.0 13.7   1:14.19 mysqld\n</code></pre>"},{"location":"python/fastapi/Flask-Django-FastApi-SpringBoot-Go-performance/#gogin","title":"Go(Gin\u6846\u67b6)","text":"<p>Wrk\u6d4b\u8bd5\u7ed3\u679c</p> <pre><code>[root@localhost wrk]# wrk -t 8 -c 500 -d 30 --latency http://192.168.11.5:9000/v1/todo\nRunning 30s test @ http://192.168.11.5:9000/v1/todo\n  8 threads and 500 connections\n  Thread Stats   Avg      Stdev     Max   +/- Stdev\n    Latency   201.99ms  281.57ms   1.65s    85.82%\n    Req/Sec   501.23     97.01     0.88k    69.65%\n  Latency Distribution\n     50%   89.46ms\n     75%  172.46ms\n     90%  698.35ms\n     99%    1.13s \n  119909 requests in 30.09s, 84.16MB read\n  Socket errors: connect 0, read 0, write 0, timeout 516\nRequests/sec:   3984.92\nTransfer/sec:      2.80MB\n</code></pre> <p>TOP\u6570\u636e</p> <pre><code> PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND   \n 78086 root      20   0  935180  38164   5044 R 106.0  1.0   0:07.72 bubble   \n  2109 mysql     20   0 1690548 347604   5948 R  84.7  9.0   0:59.65 mysqld\n</code></pre>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/","title":"FastApi+Uvicorn\u4f7f\u7528logrotate\u538b\u7f29access\u65e5\u5fd7\u540e\u65b0\u65e5\u5fd7\u65e0\u6cd5\u6b63\u5e38\u8f93\u51fa","text":""},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#_1","title":"\u95ee\u9898\u73b0\u8c61","text":"<p>Fastapi\u4f7f\u7528Gunicorn+Uvicorn\u90e8\u7f72\u751f\u4ea7\u73af\u5883\uff0c\u4f7f\u7528Logrotate\u538b\u7f29access\u65e5\u5fd7\u540e\uff0c\u65b0\u7684Access\u65e5\u5fd7\u65e0\u6cd5\u6b63\u5e38\u8f93\u51fa\u3002</p> <p>Uvicorn issue</p>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#1-gunicornuvicorn","title":"1 \u542f\u52a8gunicorn+uvicorn","text":"<pre><code>(venv) [root@localhost task_registry_center]# gunicorn -w 2 -b 0.0.0.0:8000 -k uvicorn.workers.UvicornWorker --access-logfile log/access.log main:app\n[2020-12-16 17:09:41 +0800] [3330] [INFO] Starting gunicorn 20.0.4\n[2020-12-16 17:09:41 +0800] [3330] [INFO] Listening at: http://0.0.0.0:8000 (3330)\n[2020-12-16 17:09:41 +0800] [3330] [INFO] Using worker: uvicorn.workers.UvicornWorker\n[2020-12-16 17:09:41 +0800] [3332] [INFO] Booting worker with pid: 3332\n[2020-12-16 17:09:41 +0800] [3333] [INFO] Booting worker with pid: 3333\n</code></pre>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#2-accesslog","title":"2 \u6e05\u7a7aaccess.log\u6587\u4ef6","text":"<pre><code>now access log file is empty\n[root@localhost log]# pwd\n/data/task_registry_center/log\n[root@localhost log]# ll\ntotal 20\n-rw-r--r--. 1 root root    0 Dec 16 16:56 access.log\n-rw-r--r--. 1 root root    0 Dec 16 16:41 client.log\n-rw-r--r--. 1 root root    0 Dec 16 16:56 debug.log\n-rw-r--r--. 1 root root    0 Dec 16 16:41 elk_client.log\n-rw-r--r--. 1 root root 5402 Dec 16 17:08 error.log\n-rw-r--r--. 1 root root    0 Dec 16 16:41 id_server.log\n-rw-r--r--. 1 root root 4029 Dec 16 17:09 main.log\n-rw-r--r--. 1 root root 4480 Dec 16 17:10 tasks.log\n</code></pre>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#3-10apiaccesslog","title":"3 \u8c03\u752810\u6b21Api\uff0c\u6b64\u65f6access.log\u5185\u5bb9\u5982\u4e0b\uff1a","text":"<pre><code>192.168.11.1:60477 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60478 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60479 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60480 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60481 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60482 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60483 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60484 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60485 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60486 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n</code></pre>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#4-logrotate","title":"4 logrotate \u914d\u7f6e\u5982\u4e0b\uff1a","text":"<pre><code>[root@localhost ~]# cat /etc/logrotate.d/task_registry_center                                                                                                                                                   \n/data/task_registry_center/log/*.log {                                                                                                                                  size 1M                                                                                                                                                         rotate 20                                                                                                                                                       compress                                                                                                                                                        nodelaycompress                                                                                                                                                 dateformat -%Y-%m-%d-%s                                                                                                                                         dateext                                                                                                                                                         missingok                                                                                                                                                       notifempty                                                                                                                                                      postrotate                                                                                                                                                      killall -s USR1 gunicorn                                                                                                                  13,9          All\n        endscript\n}\n</code></pre>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#5-logrotategunicornusr1","title":"5 \u624b\u52a8\u8c03\u7528logrotate\u547d\u4ee4\u8fdb\u884c\u65e5\u5fd7\u538b\u7f29\u6216\u8005\u76f4\u63a5\u50cfgunicorn\u53d1\u9001USR1\u4fe1\u53f7:","text":"<pre><code>\u624b\u52a8\u8c03\u7528logrotate\u547d\u4ee4\uff1a `[root@localhost ~]# /usr/sbin/logrotate -f /etc/logrotate.d/task_registry_center`\n\n\u53d1\u9001USR1\u4fe1\u53f7\uff1a `killall -s USR1 gunicorn`\n</code></pre>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#6-gunicornusr1gunicornusr1","title":"6 Gunicorn\u65e5\u5fd7\u63d0\u793a\u5df2\u7ecf\u6b63\u5e38\u5904\u7406\u4e86USR1\u4fe1\u53f7\uff08\u5728gunicorn\u4e2d\uff0cUSR1\u4fe1\u53f7\u8868\u793a\u65e5\u5fd7\u6587\u4ef6\u53d1\u751f\u53d8\u66f4\uff0c\u9700\u8981\u91cd\u65b0\u6253\u5f00\u65e5\u5fd7\u6587\u4ef6\uff09\uff1a","text":"<pre><code>[2020-12-16 17:12:16 +0800] [3330] [INFO] Handling signal: usr1\n[2020-12-16 17:12:16 +0800] [3330] [INFO] Handling signal: usr1\n[2020-12-16 17:12:16 +0800] [3330] [INFO] Handling signal: usr1\n[2020-12-16 17:12:16 +0800] [3330] [INFO] Handling signal: usr1\n</code></pre>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#7-10apiaccesslog","title":"7 \u518d\u6b21\u8c03\u752810\u6b21Api\uff0caccess.log\u5e76\u672a\u8bb0\u5f55\u5230\u6700\u65b0\u7684\u8c03\u7528\u8bb0\u5f55\u3002","text":"<ul> <li>\u65e5\u5fd7\u76ee\u5f55\uff0c\u53ef\u89c1\u65b0\u7684access.log\u65e5\u5fd7\u4e3a\u7a7a\uff1a</li> </ul> <p><pre><code>[root@localhost log]# ll\ntotal 20\n-rw-r--r--. 1 root root   0 Dec 16 17:12 access.log\n-rw-r--r--. 1 root root 125 Dec 16 17:11 access.log-2020-12-16-1608109936.gz\n</code></pre> - <code>access.log-2020-12-16-1608109936.gz</code>\u6587\u4ef6\u5185\u5bb9\u4f9d\u65e7\u4e3a\u524d10\u6b21\u7684API\u8c03\u7528\u8bb0\u5f55: <pre><code>192.168.11.1:60477 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60478 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60479 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60480 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60481 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60482 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60483 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60484 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60485 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n192.168.11.1:60486 - \"GET /api/client?page_size=10&amp;page=1 HTTP/1.1\" 200\n</code></pre></p>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#_2","title":"\u73af\u5883\u4fe1\u606f","text":"<ul> <li>\u7cfb\u7edf Centos7</li> <li>Python 3.8.3</li> <li>gunicorn 20.0.4</li> <li>uvicorn 0.13.1</li> <li>fastapi 0.62.0</li> </ul>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#logrotate","title":"logrotate","text":"<p>logrotate\u6709\u4e24\u4e2a\u5de5\u4f5c\u6a21\u5f0f\uff0c\u5206\u522b\u4e3a<code>copytruncate</code>\u548c<code>create</code>\uff0c\u7b80\u5355\u8bf4\u4e0b\u4e24\u79cd\u6a21\u5f0f\u7684\u533a\u522b\u3002</p> <p>\u5728\u4ecb\u7ecdcreate\u6a21\u5f0f\u4e4b\u524d\uff0c\u9700\u8981\u5148\u4ecb\u7ecd\u4e0blinux\u7cfb\u7edf\u4e2d\u6587\u4ef6\u662f\u901a\u8fc7inode\u7f16\u53f7\u6765\u5b9a\u4f4d\u7684\uff0c\u548c\u6587\u4ef6\u540d\u79f0\u6ca1\u6709\u5173\u7cfb\u3002</p>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#create","title":"create","text":"<ol> <li>\u5c06\u5f53\u524d\u7a0b\u5e8f\u8f93\u51fa\u7684\u65e5\u5fd7\u6587\u4ef6\u91cd\u547d\u540d\u4e3a\u538b\u7f29\u6587\u4ef6\uff0c\u4f46\u662finode\u7f16\u53f7\u4e0d\u53d8\u3002\u7a0b\u5e8f\u4ec5\u901a\u8fc7inode\u7f16\u53f7\u5b9a\u4f4d\u65e5\u5fd7\u6587\u4ef6\uff0c\u6240\u4ee5\u6b64\u65f6\u5230\u7a0b\u5e8f\u91cd\u65b0\u6253\u5f00\u65e5\u5fd7\u6587\u4ef6\uff0c\u6240\u6709\u751f\u6210\u7684\u65e5\u5fd7\u90fd\u8f93\u51fa\u5230\u4e86\u91cd\u547d\u540d\u540e\u7684\u6587\u4ef6\u4e2d\u3002</li> <li>\u521b\u5efa\u65b0\u7684\u540c\u540d\u65e5\u5fd7\u6587\u4ef6\uff0c\u867d\u7136\u65b0\u7684\u65e5\u5fd7\u6587\u4ef6\u548c\u539f\u6765\u65e5\u5fd7\u6587\u4ef6\u7684\u540d\u5b57\u4e00\u6837\uff0c\u4f46\u662finode\u7f16\u53f7\u4e0d\u4e00\u6837\uff0c\u6240\u4ee5\u7a0b\u5e8f\u8f93\u51fa\u7684\u65e5\u5fd7\u8fd8\u662f\u5f80\u539f\u65e5\u5fd7\u6587\u4ef6\u8f93\u51fa\u3002</li> <li>\u901a\u8fc7\u67d0\u4e9b\u65b9\u5f0f\u901a\u77e5\u7a0b\u5e8f\uff0c\u91cd\u65b0\u6253\u5f00\u65e5\u5fd7\u6587\u4ef6\u3002\u7a0b\u5e8f\u91cd\u65b0\u6253\u5f00\u65e5\u5fd7\u6587\u4ef6\uff0c\u9760\u7684\u662f\u6587\u4ef6\u8def\u5f84\u800c\u4e0d\u662finode\u7f16\u53f7\uff0c\u6240\u4ee5\u6253\u5f00\u7684\u662f\u65b0\u7684\u65e5\u5fd7\u6587\u4ef6\u3002</li> </ol>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#copytruncate","title":"copytruncate","text":"<ol> <li>\u62f7\u8d1d\u5f53\u524d\u65e5\u5fd7\u6587\u4ef6\u5230\u538b\u7f29\u6587\u4ef6\uff0c\u8fd9\u671f\u95f4\u7a0b\u5e8f\u7167\u5e38\u8f93\u51fa\u65e5\u5fd7\u5230\u539f\u6765\u7684\u6587\u4ef6\u4e2d\uff0c\u539f\u6765\u7684\u6587\u4ef6\u540d\u4e5f\u6ca1\u6709\u53d8\u3002</li> <li>\u6e05\u7a7a\u7a0b\u5e8f\u6b63\u5728\u8f93\u51fa\u7684\u65e5\u5fd7\u6587\u4ef6\u3002\u6e05\u7a7a\u540e\u7a0b\u5e8f\u8f93\u51fa\u7684\u65e5\u5fd7\u8fd8\u662f\u8f93\u51fa\u5230\u8fd9\u4e2a\u65e5\u5fd7\u6587\u4ef6\u4e2d\uff0c\u56e0\u4e3a\u6e05\u7a7a\u6587\u4ef6\u53ea\u662f\u628a\u6587\u4ef6\u7684\u5185\u5bb9\u5220\u9664\u4e86\uff0c\u6587\u4ef6\u7684inode\u7f16\u53f7\u5e76\u6ca1\u6709\u53d1\u751f\u53d8\u5316\uff0c\u53d8\u5316\u7684\u662f\u5143\u4fe1\u606f\u4e2d\u6587\u4ef6\u5185\u5bb9\u7684\u4fe1\u606f\u3002</li> </ol> <p>\u6b64\u65b9\u6848\u5b58\u5728\u4e00\u4e2a\u95ee\u9898\uff0c\u5c31\u662f\u5728\u65e5\u5fd7\u62f7\u8d1d\u5f00\u59cb\uff0c\u5230\u6e05\u7a7a\u65e5\u5fd7\u6587\u4ef6\u7684\u8fd9\u6bb5\u65f6\u95f4\u5185\uff0c\u7a0b\u5e8f\u8f93\u51fa\u7684\u65e5\u5fd7\u6ca1\u6709\u5b58\u50a8\uff0c\u5b58\u5728\u65e5\u5fd7\u4e22\u5931\u7684\u98ce\u9669\u3002</p> <p>logrotate\u673a\u5236\u548c\u539f\u7406</p>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#_3","title":"\u95ee\u9898\u4fee\u590d","text":""},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#gunicorn","title":"Gunicorn\u6e90\u7801\u5206\u6790","text":"<p>\u5728gunicorn(\u7248\u672c20.0.4)\u4e2d\u53ef\u4ee5\u67e5\u627e\u5230\u548cUSR1\u4fe1\u53f7\u5904\u7406\u7684\u76f8\u5173\u4ee3\u7801\u5982\u4e0b\uff1a</p> <p><code>venv/Lib/site-packages/gunicorn/arbiter.py</code> 196\u884c\uff1a</p> <pre><code>def run(self):\n\"Main master loop.\"\nself.start()\nutil._setproctitle(\"master [%s]\" % self.proc_name)\ntry:\nself.manage_workers()\nwhile True:\nself.maybe_promote_master()\nsig = self.SIG_QUEUE.pop(0) if self.SIG_QUEUE else None\nif sig is None:\nself.sleep()\nself.murder_workers()\nself.manage_workers()\ncontinue\nif sig not in self.SIG_NAMES:\nself.log.info(\"Ignoring unknown signal: %s\", sig)\ncontinue\nsigname = self.SIG_NAMES.get(sig)\nhandler = getattr(self, \"handle_%s\" % signame, None)\nif not handler:\nself.log.error(\"Unhandled signal: %s\", signame)\ncontinue\nself.log.info(\"Handling signal: %s\", signame)\nhandler()\nself.wakeup()\ndef handle_usr1(self):\n\"\"\"\n    SIGUSR1 handling.\n    Kill all workers by sending them a SIGUSR1\n    \"\"\"\nself.log.reopen_files()\nself.kill_workers(signal.SIGUSR1)\n</code></pre>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#uvicorn","title":"Uvicorn\u6e90\u7801\u5206\u6790","text":"<p>Uvicorn\u53ea\u5904\u7406\u4e86\u7a0b\u5e8f\u7ec8\u6b62\u76f8\u5173\u7684\u4fe1\u53f7\uff1a <pre><code>HANDLED_SIGNALS = (\nsignal.SIGINT,  # Unix signal 2. Sent by Ctrl+C.\nsignal.SIGTERM,  # Unix signal 15. Sent by `kill &lt;pid&gt;`.\n)\n</code></pre></p> <p><code>venv/Lib/site-packages/uvicorn/workers.py</code> 64\u884c\uff1a <pre><code>    def init_process(self):\nself.config.setup_event_loop()\nsuper(UvicornWorker, self).init_process()\ndef init_signals(self):\npass\ndef run(self):\nself.config.app = self.wsgi\nserver = Server(config=self.config)\nloop = asyncio.get_event_loop()\nloop.run_until_complete(server.serve(sockets=self.sockets))\n</code></pre> \u53ef\u4ee5\u770b\u5230UvicornWorker\u7684init_signals\u51fd\u6570\u88ab\u91cd\u5199\u4e3a\u4e0d\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u4e86\uff0c\u5176\u7236\u7c7bgunicorn.workers.base.Worker\u7684init_signals\u65b9\u6cd5\u4e3a\uff1a <pre><code>    def init_signals(self):\n# reset signaling\nfor s in self.SIGNALS:\nsignal.signal(s, signal.SIG_DFL)\n# init new signaling\nsignal.signal(signal.SIGQUIT, self.handle_quit)\nsignal.signal(signal.SIGTERM, self.handle_exit)\nsignal.signal(signal.SIGINT, self.handle_quit)\nsignal.signal(signal.SIGWINCH, self.handle_winch)\nsignal.signal(signal.SIGUSR1, self.handle_usr1)\nsignal.signal(signal.SIGABRT, self.handle_abort)\n# Don't let SIGTERM and SIGUSR1 disturb active requests\n# by interrupting system calls\nsignal.siginterrupt(signal.SIGTERM, False)\nsignal.siginterrupt(signal.SIGUSR1, False)\nif hasattr(signal, 'set_wakeup_fd'):\nsignal.set_wakeup_fd(self.PIPE[1])\n</code></pre></p>"},{"location":"python/fastapi/fastapi-uvicorn-logrotate/#_4","title":"\u89e3\u51b3\u65b9\u6848","text":"<p>\u8ba9UvicornWorker\u6b63\u5e38\u5904\u7406USR1\u4fe1\u53f7\u5373\u53ef\uff0c\u5c06<code>venv/Lib/site-packages/uvicorn/workers.py</code> 63\u884c\u7531\uff1a <pre><code>def init_signals(self):\npass\n</code></pre> \u4fee\u6539\u4e3a <pre><code>import signal\ndef init_signals(self):\nsignal.signal(signal.SIGUSR1, self.handle_usr1)\n</code></pre> \u5373\u53ef\u3002</p>"},{"location":"python/fastapi/request-id/","title":"request-id\u5b9e\u73b0","text":""},{"location":"python/fastapi/request-id/#requestid","title":"RequestID\u5b9e\u73b0","text":"<p>\u4e3a\u5355\u6b21\u8bf7\u6c42\u8d4b\u4e88\u4e00\u4e2a\u552f\u4e00\u7684RequestID\u53ef\u4ee5\u65b9\u4fbf\u5b9a\u4f4d\u95ee\u9898\uff0c\u83b7\u53d6\u8c03\u7528\u6808\u548c\u65e5\u5fd7\u3002\u6bd4\u8f83\u5e38\u89c1\u7684\u573a\u666f\u4e3a\uff0c\u63a5\u6536\u5230\u8bf7\u6c42\u540e\uff0c\u4e3a\u8bf7\u6c42\u5206\u914dRequestID\uff0c\u672c\u6b21\u8bf7\u6c42\u4ea7\u751f\u7684\u6240\u6709\u65e5\u5fd7\u3001\u7b2c\u4e09\u65b9\u8c03\u7528\u7b49\u5747\u5173\u8054\u6b64RequestID\uff0c\u8be5RequestID\u5728\u63a5\u53e3\u7684\u8fd4\u56de\u4f53\u6216\u8005\u8fd4\u56de\u5934\u4e2d\u8fd4\u56de\u7ed9\u8c03\u7528\u8005\u3002</p> <p>\u5b9e\u73b0\u601d\u8def\uff0c\u5e38\u89c1\u7684RequestID\u4e00\u822c\u662f\u5728\u8bf7\u6c42\u8fdb\u5165\u65f6\u5206\u914d\u5e76\u5b58\u5165\u4e0a\u4e0b\u6587\uff08context\uff09\u53d8\u91cf\u4e2d\u3002\u7b2c\u4e00\u6b21\u5b9e\u73b0\u7684\u65f6\u5019\u662f\u5c06RequestID\u8bb0\u5f55\u5728\u4e86request.scope\u5bf9\u8c61\u91cc\uff0c\u6bcf\u6b21\u83b7\u53d6RequestID\u65f6\u5747\u9700\u8981\u83b7\u53d6request\u5bf9\u8c61\uff0c\u5341\u5206\u7684\u4e0d\u65b9\u4fbf\u3002\u76f4\u63a5\u4ecb\u7ecd\u5f53\u524d\u4f7f\u7528\u7684\u65b9\u6848\uff0c\u501f\u52a9 starlette-context \u5de5\u5177\u5e93\uff0c\u6b64\u5e93\u5df2\u7ecf\u5b9e\u73b0\u4e86RequestID\u7684\u751f\u6210\u548c\u5173\u8054\u4e86\uff0c\u5728\u8fd9\u91cc\u63a5\u7eed\u4ecb\u7ecdRequestID\u5728\u8bf7\u6c42\u4f53\u7684\u81ea\u52a8\u8fd4\u56de\u548c\u65e5\u5fd7\u5173\u8054(\u53ef\u5173\u8054\u81f3gunicorn\u7684AccesssLog)\u3002</p> <p>requirements.txt</p> <pre><code>starlette-context==0.2.3\n</code></pre> <p>common/request_id.py</p> <pre><code>import logging\nfrom starlette_context import context\nfrom starlette_context.plugins.plugin_uuid import PluginUUIDBase\nREQUEST_ID_CTX_KEY = 'X-Request-ID'\nclass RequestIdPlugin(PluginUUIDBase):\nkey = REQUEST_ID_CTX_KEY\ndef get_new_uuid(self) -&gt; str:\nfunc = self.uuid_functions_mapper[self.version]\nreturn str(func())\ndef current_request_id():\n\"\"\"get current request_id inside context var\"\"\"\nreturn context.data[REQUEST_ID_CTX_KEY]\nclass RequestIDLogFilter(logging.Filter):\n\"\"\"\n    Log filter to inject the current request id of the request under `log_record.request_id`\n    \"\"\"\ndef filter(self, log_record):\nlog_record.request_id = current_request_id()\nreturn log_record\n</code></pre> <p>\u4e3b\u8981\u4fee\u6539\u70b9\uff1a</p> <ul> <li>RequestIdPlugin \u91cd\u5199\u4e86 get_new_uuid \u51fd\u6570\uff0c\u8c03\u6574\u4e86\u4e0b\u751f\u6210\u7684uuid\u683c\u5f0f\u3002</li> <li>current_request_id\u4f1a\u81ea\u52a8\u8fd4\u56de\u672c\u6b21\u8bf7\u6c42\u5bf9\u5e94\u7684request_id</li> <li>RequestIDLogFilter \u7528\u4e8e\u4e3a\u65e5\u5fd7\u5bf9\u8c61\u6dfb\u52a0request_id\u503c</li> </ul> <p>\u4e3aApp\u65b0\u589e\u4e2d\u95f4\u4ef6 main.py</p> <pre><code>from starlette_context.middleware import ContextMiddleware \nfrom common.request_id import RequestIdPlugin\n\ndef get_application() -&gt; FastAPI:\n    application = FastAPI(title=\"Demo\", debug=config.DEBUG, version='1.0')\n\n    # \u4e2d\u95f4\u4ef6\n    application.add_middleware(ContextMiddleware, plugins=(RequestIdPlugin(),))\n\n    ...\n\n    application.include_router(api_router, prefix='/api')\n    return application\n</code></pre>"},{"location":"python/fastapi/request-id/#requestid_1","title":"\u63a5\u53e3\u81ea\u52a8\u8fd4\u56deRequestID","text":"<p>common/response.py</p> <pre><code>from typing import Any, List\nfrom pydantic import BaseModel, Field\nfrom common.request_id import current_request_id\nclass Response(BaseModel):\n\"\"\"\u63a5\u53e3\u8fd4\u56de\u683c\u5f0f\"\"\"\ncode: int = Field(..., example=0, description='\u54cd\u5e94\u7801')\nmessage: str = Field(..., example=\"success\", description='\u54cd\u5e94\u7801\u89e3\u91ca\uff0csuccess\u6216\u8005failed\u3002')\ncause: Any = Field('', example=\"\u8d44\u6e90\u672a\u627e\u5230\", description='\u5f02\u5e38\u89e3\u91ca\u3002')\nrequest_id: str = Field(default_factory=current_request_id, example=\"04950cb5-6b24-426b-a5ce-db6344982597\",\ndescription='RequestId\uff0c\u7528\u4e8e\u5b9a\u4f4d\u5355\u6b21\u8bf7\u6c42\u3002')\nresult: Any = Field(..., example=\"\", description='\u54cd\u5e94\u6570\u636e\uff0c\u6570\u636e\u683c\u5f0f\u6839\u636eAPI\u53d8\u5316\u3002')\n</code></pre> <p>views.py</p> <pre><code>@router.get(\"/demo\", response_model=Response)\nasync def demo():\nreturn Response(message='success', code=0, result='demo\u3002')\n</code></pre> <p>\u5355\u6b21\u8bf7\u6c42\u7684\u8fd4\u56de\u5982\u4e0b\uff1a</p> <pre><code>{'cause': '',\n'code': 0,\n'message': 'success',\n'request_id': '99cf0bf2-42a0-4ed4-a396-da611a370d06',\n'result': 'demo'}\n</code></pre>"},{"location":"python/fastapi/request-id/#_1","title":"\u65e5\u5fd7\u5173\u8054","text":"<p>common/constances.py</p> <pre><code>LOG_FORMAT = '%(asctime)s [pid:%(process)d] %(filename)s(line:%(lineno)d) %(levelname)s %(message)s'\nREQUEST_ID_LOG_FORMAT = '%(asctime)s [pid:%(process)d] %(filename)s(line:%(lineno)d) %(levelname)s [%(request_id)s] %(message)s'\n</code></pre> <p>common/log_handler.py</p> <pre><code>import json\nimport logging\nimport os\nfrom copy import copy\nfrom logging.handlers import WatchedFileHandler\nfrom uvicorn.logging import AccessFormatter\nimport config\nfrom common.constants import LOG_FORMAT, REQUEST_ID_LOG_FORMAT\nfrom common.request_id import RequestIDLogFilter, current_request_id\nfrom common.request_time import current_request_time\nclass LogHandler(logging.Logger):\n\"\"\"\n    LogHandler\n    \"\"\"\nlog_format = LOG_FORMAT\ndef __init__(self, name, level=None, stream=True, file=True):\nself.name = name\nif level:\nself.level = level\nelse:\nself.level = config.LOG_LEVEL\nlogging.Logger.__init__(self, self.name, level=self.level)\nif stream:\nself.__setStreamHandler__()\nif file:\nself.__setFileHandler__()\ndef __setFileHandler__(self, level=None):\n\"\"\"\n        set file handler\n        :param level:\n        :return:\n        \"\"\"\nfile_name = os.path.join(LOG_PATH, f'{self.name}.log')\nfile_handler = WatchedFileHandler(filename=file_name)\nif not level:\nfile_handler.setLevel(self.level)\nelse:\nfile_handler.setLevel(level)\nformatter = logging.Formatter(self.log_format)\nfile_handler.setFormatter(formatter)\nself.file_handler = file_handler\nself.addHandler(file_handler)\ndef __setStreamHandler__(self, level=None):\n\"\"\"\n        set stream handler\n        :param level:\n        :return:\n        \"\"\"\nstream_handler = logging.StreamHandler()\nformatter = logging.Formatter(self.log_format)\nstream_handler.setFormatter(formatter)\nif not level:\nstream_handler.setLevel(self.level)\nelse:\nstream_handler.setLevel(level)\nself.addHandler(stream_handler)\ndef resetName(self, name):\n\"\"\"\n        reset name\n        :param name:\n        :return:\n        \"\"\"\nself.name = name\nself.removeHandler(self.file_handler)\nself.__setFileHandler__()\nclass RequestLogHandler(LogHandler):\nlog_format = REQUEST_ID_LOG_FORMAT\ndef __setFileHandler__(self, level=None):\nsuper(RequestLogHandler, self).__setFileHandler__(level=level)\nself.addFilter(RequestIDLogFilter())\ndef __setStreamHandler__(self, level=None):\nsuper(RequestLogHandler, self).__setStreamHandler__(level=level)\nself.addFilter(RequestIDLogFilter())\n</code></pre> <p>views.py:</p> <pre><code>log = RequestLogHandler('demo')\n@router.get(\"/demo\", response_model=Response)\nasync def demo():\nlog.info('demo')\nreturn Response(message='success', code=0, result='demo')\n</code></pre> <p>\u8f93\u51fa\u65e5\u5fd7\uff1a</p> <pre><code>2020-10-01 16:27:53,065 [pid:19120] views.py(line:26) INFO [d42f6cfb-2a0f-4673-a3c9-d8c00d2e58b4] demo\n</code></pre>"},{"location":"python/fastapi/request-id/#accesslog","title":"\u5173\u8054AccessLog","text":"<p>FastAPI\u5f53\u524d\u4f7f\u7528\u7684\u90e8\u7f72\u65b9\u6848\u662f nginx-&gt;gunicorn-&gt;uvicorn-&gt;fastapi\uff0cnginx\u505a\u8d1f\u8f7d\u5747\u8861\uff0cgunicorn\u8d1f\u8d23\u7ba1\u7406\u8c03\u5ea6uvicorn\uff0cuvicorn\u518d\u5c06\u5177\u4f53\u8bf7\u6c42\u4f20\u9012\u7ed9fastapi\u3002gunicorn\u90e8\u7f72\u7684\u65f6\u5019\u4e00\u822c\u6307\u5b9aworker type\u4e3a<code>uvicorn.workers.UvicornWorker</code>\uff0c\u5177\u4f53\u53ef\u4ee5\u53c2\u8003 uvicorn-deployment\u3002\u4e3a\u4e86\u8ba9Access\u65e5\u5fd7\u80fd\u591f\u663e\u793aRequestID\uff0c\u9700\u8981\u7684\u9ed8\u8ba4\u7684Worker\u8fdb\u884c\u91cd\u5199\u3002</p> <p>common/workers.py</p> <pre><code>import logging\nfrom uvicorn.workers import UvicornWorker\nfrom common import constants\nfrom common.log_handler import RequestAccessFormatter\nclass RequestUvicornWorker(UvicornWorker):\n\"\"\"\u81ea\u5b9a\u4e49worker \u751f\u6210\u6307\u5b9a\u683c\u5f0f\u7684access\u65e5\u5fd7\"\"\"\ndef __init__(self, *args, **kwargs):\nsuper(RequestUvicornWorker, self).__init__(*args, **kwargs)\nlogger = logging.getLogger(\"uvicorn.access\")\nfor handler in self.log.access_log.handlers:\nhandler.setFormatter(RequestAccessFormatter(constants.ACCESS_LOG_FORMAT))\nlogger.handlers = self.log.access_log.handlers\nlogger.setLevel(self.log.access_log.level)\n</code></pre> <p>common/log_handler.py</p> <pre><code>from common.request_time import current_request_time\nfrom uvicorn.logging import AccessFormatter\nclass RequestAccessFormatter(AccessFormatter):\ndef __init__(self, fmt=None, datefmt=None, style=\"%\", use_colors=None):\nsuper().__init__(fmt=fmt, datefmt=datefmt, style=style)\nself.use_colors = False\ndef get_status_code(self, record):\nstatus_code = record.__dict__[\"status_code\"]\nreturn status_code\ndef formatMessage(self, record):\nrecord_copy = copy(record)\nrecord_copy.__dict__['request_id'] = current_request_id()\nreturn super().formatMessage(record_copy)\n</code></pre> <p>common/comstants.py</p> <pre><code>ACCESS_LOG_FORMAT = '[%(asctime)s] %(request_id)s %(status_code)s %(client_addr)s ' \\\n                    '- \"%(request_line)s\"'\n</code></pre> <p>gunicorn\u4f7f\u7528\u7684\u914d\u7f6e\u6587\u4ef6 gun.py</p> <pre><code>import multiprocessing\nimport config as local_config\nbind = f'{local_config.HOST}:{local_config.PORT}'\nworkers = multiprocessing.cpu_count() * 2\nbacklog = 2048\nworker_class = 'common.workers.RequestUvicornWorker'\nproc_name = 'gunicorn.proc'\npidfile = 'log/gunicorn.pid'\nerrorlog = 'log/error.log'\naccesslog = 'log/access.log'\nloglevel = 'info'\ndaemon = True\ntimeout = 10\nlimit_request_line = 0\n</code></pre> <p>\u4f7f\u7528gunicorn\u542f\u52a8\u670d\u52a1\u540e\uff0caccess.log\u5c55\u793a\u7684\u65e5\u5fd7\u683c\u5f0f\u5c06\u5982\u4e0b\uff1a</p> <pre><code>[2020-09-30 15:28:54,793] ff1216ac-f46e-4997-901b-c749c306e744 200 192.168.11.1:53607 - \"GET /redoc HTTP/1.1\"\n</code></pre> <p>ff1216ac-f46e-4997-901b-c749c306e744 \u5c31\u662f\u672c\u6b21\u8bf7\u6c42\u5bf9\u5e94\u7684RequestID\u3002</p>"},{"location":"python/fastapi/request-id/#requesttime","title":"RequestTime\u5b9e\u73b0","text":"<p>Gunicorn\u90e8\u7f72Flask\u7684\u65f6\u5019\uff0c\u662f\u53ef\u4ee5\u81ea\u52a8\u8ba1\u7b97\u8bf7\u6c42\u8017\u65f6\u7684\u3002\u4f46\u662f\u4f7f\u7528Gunicorn+uvicorn\u4e4b\u540e\uff0cAccess\u65e5\u5fd7\u662f\u7531uvicorn\u8d1f\u8d23\u6253\u5370\u7684\uff0cuvicorn\uff08uvicorn==0.11.8\uff09\u5f53\u524d\u597d\u50cf\u8fd8\u662f\u4e0d\u652f\u6301\u8bf7\u6c42\u8017\u65f6\u8ba1\u7b97\u3002\u67e5\u770b\u5355\u6b21\u8bf7\u6c42\u7684\u8017\u65f6\u662f\u4e2a\u521a\u9700\uff0c\u548cRequestID\u7684\u5b9e\u73b0\u65b9\u5f0f\u7c7b\u578b\uff0c\u4f9d\u65e7\u501f\u52a9 starlette-context \u5b9e\u73b0\uff0c\u6539\u9020\u5982\u4e0b\uff1a</p> <p>common/middlewares.py</p> <pre><code>from contextvars import Token\nfrom starlette.middleware.base import RequestResponseEndpoint\nfrom starlette.requests import Request\nfrom starlette.responses import Response\nfrom starlette_context import _request_scope_context_storage\nfrom starlette_context.middleware import ContextMiddleware as BaseContextMiddleware\nclass ContextMiddleware(BaseContextMiddleware):\nasync def dispatch(\nself, request: Request, call_next: RequestResponseEndpoint\n) -&gt; Response:\n_starlette_context_token: Token = _request_scope_context_storage.set(\nawait self.set_context(request)\n)\ntry:\nresponse = await call_next(request)\nfor plugin in self.plugins:\nawait plugin.enrich_response(response)\nfinally:\npass\nreturn response\n</code></pre> <p>\u4e3b\u8981\u7684\u4fee\u6539\u70b9\u662f\u4e4b\u524d\u8bf7\u6c42\u5b8c\u6210\u540e\uff0c\u4f1a\u91cd\u7f6e\u5168\u5c40\u4e0a\u4e0b\u6587\u53d8\u91cf\uff0c\u5220\u9664\u4e86\u8fd9\u4e2a\u91cd\u7f6e\u52a8\u4f5c\u3002</p> <p>common/request_time.py</p> <pre><code>import time\nfrom typing import Union\nfrom starlette.requests import Request\nfrom starlette.responses import Response\nfrom starlette_context import _request_scope_context_storage\nfrom starlette_context import context\nfrom starlette_context.plugins.plugin import Plugin\nREQUEST_START_TIME_CTX_KEY = 'X-Request-Start-Time'\nREQUEST_TIME_CTX_KEY = 'X-Request-Time'\nclass RequestTimePlugin(Plugin):\nkey = REQUEST_START_TIME_CTX_KEY\nasync def process_request(self, request: Request) -&gt; Union[str, int, dict, float]:\n\"\"\"\n        Runs always on request.\n        Extracts value from header by default.\n        \"\"\"\nassert isinstance(self.key, str)\nreturn time.time()\nasync def enrich_response(self, response: Response) -&gt; None:\ncontext: dict = _request_scope_context_storage.get()\nstart_time = context.pop(self.key)\ncontext[REQUEST_TIME_CTX_KEY] = time.time() - start_time\n_request_scope_context_storage.set(context)\ndef current_request_time(precision=3):\n\"\"\"get current request_time inside context var\"\"\"\ncontext_data = context.data\nif REQUEST_TIME_CTX_KEY in context_data:\nrequest_time = round(context.data[REQUEST_TIME_CTX_KEY], precision)\nelse:\nrequest_time = round(time.time() - context.data[REQUEST_START_TIME_CTX_KEY], precision)\nreturn request_time\n</code></pre> <p>common/log_handler.py</p> <pre><code>class RequestAccessFormatter(AccessFormatter):\ndef __init__(self, fmt=None, datefmt=None, style=\"%\", use_colors=None):\nsuper().__init__(fmt=fmt, datefmt=datefmt, style=style)\nself.use_colors = False\ndef get_status_code(self, record):\nstatus_code = record.__dict__[\"status_code\"]\nreturn status_code\ndef formatMessage(self, record):\nrecord_copy = copy(record)\nrecord_copy.__dict__['request_time'] = current_request_time()\nrecord_copy.__dict__['request_id'] = current_request_id()\nreturn super().formatMessage(record_copy)\n</code></pre> <p>common/constants.py</p> <pre><code>ACCESS_LOG_FORMAT = '[%(asctime)s] %(request_id)s %(status_code)s %(request_time)ss %(client_addr)s - \"%(request_line)s\"'\n</code></pre> <p>main.py:</p> <pre><code># \u4e2d\u95f4\u4ef6\napplication.add_middleware(ContextMiddleware, plugins=(RequestIdPlugin(), RequestTimePlugin()))\n</code></pre> <p>worker\u7684\u4fee\u6539\u53c2\u8003RequestID\u90e8\u5206\u7684\u4ecb\u7ecd\u3002</p> <p>\u6700\u7ec8\u7684AccessLog\u683c\u5f0f\u5927\u81f4\u4e3a\uff1a</p> <pre><code>[2020-10-01 16:58:27,183] 079fa7bd-e737-40c5-9edf-6aac536595ad 200 0.01s 172.16.120.13:52621 - \"PUT /demo HTTP/1.1\"\n</code></pre>"},{"location":"python/fastapi/tortoise-orm/","title":"tortoise-orm\u6559\u7a0b","text":""},{"location":"python/fastapi/tortoise-orm/#_1","title":"\u7b80\u4ecb","text":"<p>FastApi\u57fa\u4e8eStarlette\u6846\u67b6\u4e8c\u6b21\u5f00\u53d1\uff0c\u4f7f\u7528pydantic\u505a\u63a5\u53e3\u5165\u53c2\u6821\u9a8c\uff0c\u53ef\u81ea\u52a8\u751f\u6210openapi\u5f62\u5f0f\u7684\u63a5\u53e3\u6587\u6863\u3002</p> <p>\u4ecePython3.6\u5f00\u59cb\u652f\u6301<code>asyncio</code>\u4e4b\u540e\uff0c\u8bb8\u591a\u652f\u6301\u6b64\u7279\u6027\u7684python web\u6846\u67b6\u5f00\u59cb\u9646\u7eed\u51fa\u73b0\uff0c\u5982sanic\u3001fastapi\uff0c\u5229\u7528\u5f02\u6b65\u7279\u6027+\u5f02\u6b65ORM\uff0c\u53ef\u4ee5\u63d0\u9ad8web\u670d\u52a1\u7684\u5e76\u53d1\u548c\u541e\u5410\u91cf\u3002</p> <p>Django3.0\u4e4b\u540e\u624d\u5f00\u59cb\u652f\u6301Asgi\u534f\u8bae\uff0c\u81f3\u5f53\u524d\u6700\u65b0\u7248\u672c3.0.7\u4f9d\u65e7\u672a\u652f\u6301\u5f02\u6b65ORM\u3002</p> <p>\u4e0d\u4e25\u8c28\u7684\u573a\u666f\u4e0b\u6027\u80fd\u6d4b\u8bd5\u7ed3\u679c\u662f FastAPI&gt;Flask&gt;Django3\u3002</p>"},{"location":"python/fastapi/tortoise-orm/#tortoise-orm","title":"tortoise-orm","text":"<p>tortoise-orm\u5b98\u7f51</p> <p>tortoise-orm\u662f\u4e00\u4e2a\u7c7bDjango\u7684\u5f02\u6b65\u652f\u6301\u7684ORM\uff0c\u5982\u679c\u4e4b\u524d\u4f7f\u7528\u8fc7Django\u7684\u8bdd\uff0c\u8bed\u6cd5\u57fa\u672c\u4e00\u81f4\uff0c\u65e0\u9700\u7279\u6b8a\u5b66\u4e60\u3002</p> <p>\u6700\u5927\u7684\u533a\u522b\u5c31\u662f\u6240\u6709\u7684ORM\u8bed\u53e5\u6267\u884c\u524d\u90fd\u9700\u8981\u52a0\u5165<code>await</code>\u5173\u952e\u5b57\uff0c\u4ee5\u6b64\u652f\u6301\u5f02\u6b65ORM\u8bfb\u53d6\u64cd\u4f5c\u3002\u4e0b\u9762\u53ea\u7b80\u5355\u4ecb\u7ecd\u4e00\u4e9b\u5728\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u9047\u5230\u7684\u96be\u70b9\u95ee\u9898\u3002</p>"},{"location":"python/fastapi/tortoise-orm/#_2","title":"\u6570\u636e\u5e93\u8fde\u63a5","text":"<p>FastAPI\u7684app\u4e3b\u6587\u4ef6\u5185\uff0c main.py:</p> <pre><code>from tortoise.contrib.fastapi import register_tortoise\nregister_tortoise(\napp,\ndb_url=config.DATABASE_URI,\nmodules={\"models\": [\"client.models\"]},\ngenerate_schemas=False,\nadd_exception_handlers=False,\n)\n</code></pre> <p>\u5176\u4e2dapp\u4e3aFastAPI\u7684app\u5bf9\u8c61\u3002</p> <p>modules\u4e3a\u4f60models\u6587\u4ef6\u5b9a\u4e49\u7684\u8def\u5f84\u3002</p> <p>generate_schemas\u4e3aTrue\u7684\u8bdd\u4f1a\u81ea\u52a8\u68c0\u6d4b\u76f8\u5173\u7684\u8868\u662f\u5426\u5b58\u5728\uff0c\u4e0d\u5b58\u5728\u7684\u8bdd\u4f1a\u81ea\u52a8\u5c1d\u8bd5\u521b\u5efa\uff0c\u8868\u4e2d\u7684\u5b57\u6bb5\u53d8\u5316\u7684\u8bdd\uff0c\u4e0d\u4f1a\u81ea\u52a8\u66f4\u65b0\u7684\u3002</p> <p>add_exception_handlers\u4e3aTrue\u7684\u8bdd\u4f1a\u81ea\u52a8\u4e3a\u4f60\u5904\u7406ORM\u7684DoesNotExist\u5f02\u5e38\u3002</p>"},{"location":"python/fastapi/tortoise-orm/#_3","title":"\u65f6\u533a\u95ee\u9898","text":"<pre><code>create_time = fields.DatetimeField(auto_now_add=True, description='\u521b\u5efa\u65f6\u95f4')\nupdate_time = fields.DatetimeField(auto_now=True, description='\u66f4\u65b0\u65f6\u95f4')\n</code></pre> <p>models\u5728\u5b9a\u4e49\u7684\u65f6\u5019\uff0c\u7ecf\u5e38\u4f1a\u5b9a\u4e49\u521b\u5efa\u65f6\u95f4\u548c\u66f4\u65b0\u65f6\u95f4\uff0c\u8fd9\u4e2a\u65f6\u95f4\u5728\u4e0d\u663e\u5f0f\u6307\u5b9a\u65f6\uff0c\u4f1a\u7531ORM\u81ea\u52a8\u8865\u5168\uff0c\u5f53\u524dtortoise-orm(\u7248\u672ctortoise-orm==0.16.16)\u597d\u50cf\u4e0d\u652f\u6301\u6307\u5b9a\u65f6\u533a\uff0c\u5165\u5e93\u4f7f\u7528\u7684\u65f6\u95f4\u4e3aUTC\u65f6\u95f4\uff0c\u6e90\u7801\u4e3a\uff1a</p> <p>\\tortoise\\fields\\data.py Line 304:</p> <pre><code>def to_db_value(\nself, value: Optional[datetime.datetime], instance: \"Union[Type[Model], Model]\"\n) -&gt; Optional[datetime.datetime]:\n# Only do this if it is a Model instance, not class. Test for guaranteed instance var\nif hasattr(instance, \"_saved_in_db\") and (\nself.auto_now\nor (self.auto_now_add and getattr(instance, self.model_field_name) is None)\n):\nvalue = datetime.datetime.utcnow()\nsetattr(instance, self.model_field_name, value)\nreturn value\nreturn value\n</code></pre> <p>value\u5f3a\u5236\u6307\u5b9a\u4e3a<code>datetime.datetime.utcnow()</code>\uff0c\u5f53\u524d\u76f4\u63a5\u91cd\u5199\u81ea\u5b9a\u4e49\u7684\u5b57\u6bb5\u89e3\u51b3\uff0c\u5c06<code>datetime.datetime.utcnow()</code>\u4fee\u6539\u4e3a<code>datetime.datetime.now()</code>\u5373\u53ef\u3002</p>"},{"location":"python/fastapi/tortoise-orm/#_4","title":"\u65e5\u5fd7\u95ee\u9898","text":"<p>tortoise-orm\u6240\u6709\u7684\u64cd\u4f5c\u65e5\u5fd7\u90fd\u4f1alog\u5728\u4e00\u4e2a\u540d\u4e3adb_client\u7684log\u5bf9\u8c61\u4e0b\uff0c\u8be5log\u9ed8\u8ba4\u4e0d\u4f1a\u8f93\u51fa\u81f3\u63a7\u5236\u53f0\uff0c\u82e5\u60f3\u67e5\u770b\u6bcf\u6b21\u64cd\u4f5c\u5bf9\u5e94\u7684SQL\u8bed\u53e5\uff0c\u53ef\u4ee5\u4e3a\u8be5log\u5bf9\u8c61\u6dfb\u52a0handler\u5373\u53ef\u3002</p> <pre><code># \u6570\u636e\u5e93\u65e5\u5fd7\ndb_log = logging.getLogger(\"db_client\")\ndb_log.setLevel(10)\nhandler = WatchedFileHandler(filename='log/db_client.log')\nformatter = logging.Formatter('%(asctime)s %(filename)s[line:%(lineno)d] %(levelname)s %(message)s')\nhandler.setFormatter(formatter)\ndb_log.addHandler(handler)\n</code></pre> <p>\u60f3\u8981\u67e5\u770b\u5355\u6b21ORM\u6267\u884c\u65f6\u5bf9\u5e94\u7684sql\u8bed\u53e5\uff0c\u76f4\u63a5\u5728ORM\u8bed\u53e5\u540e\u8c03\u7528\u4e0b<code>.sql()</code>\u65b9\u6cd5\u5373\u53ef\u3002</p>"},{"location":"python/python/mkdocs/","title":"MkDocs","text":""},{"location":"python/python/mkdocs/#mkdocs","title":"MkDocs","text":""},{"location":"python/python/mkdocs/#_1","title":"\u80cc\u666f","text":"<p>\u6700\u8fd1\u5c06\u535a\u5ba2\u4ece\u4e4b\u524d\u7684Django\u52a8\u6001\u7f51\u7ad9\u6539\u4e3a\u4f7f\u7528MkDocs+MkDocs-Material\u642d\u5efa\u7684\u9759\u6001\u7f51\u7ad9\u3002</p> <p>\u4e3b\u8981\u539f\u56e0\u6709\u5982\u4e0b\u4e24\u70b9\uff1a</p> <ol> <li>\u4e4b\u524d\u5199\u535a\u5ba2\u662f\u5728Typora\u4e2d\u5199\u5b8cmarkdown\u7684\u6587\u4ef6\uff0c\u518d\u901a\u8fc7Django\u7684\u540e\u53f0\u66f4\u65b0\u4e0a\u53bb\uff0c\u6bcf\u6b21\u66f4\u65b0\u535a\u5ba2\u6bd4\u8f83\u9ebb\u70e6\u3002</li> <li>\u9700\u8981\u4e00\u53f0\u4e91\u670d\u52a1\u5668\u72ec\u7acb\u90e8\u7f72\uff0c\u6709\u6210\u672c\u3002</li> </ol> <p>\u540e\u9762\u5728\u5de5\u4f5c\u4e2d\u63a5\u89e6\u5230\u4e86MkDocs\u8fd9\u4e2a\u9879\u76ee\uff0c\u80fd\u5b8c\u7f8e\u89e3\u51b3\u6211\u7684\u8fd9\u4e24\u4e2a\u75db\u70b9\u3002\u5c31\u8d81\u7740\u6700\u8fd1\u5de5\u4f5c\u53d8\u52a8\u4e4b\u9645\uff0c\u8bb0\u5f55\u4e0b\u76f8\u5173\u95ee\u9898\u3002</p>"},{"location":"python/python/mkdocs/#_2","title":"\u5b98\u7f51","text":"<p>mkdocs.org.</p>"},{"location":"python/python/mkdocs/#_3","title":"\u547d\u4ee4","text":"<ul> <li><code>mkdocs new [dir-name]</code> - Create a new project.</li> <li><code>mkdocs serve</code> - Start the live-reloading docs server.</li> <li><code>mkdocs build</code> - Build the documentation site.</li> <li><code>mkdocs -h</code> - Print help message and exit.</li> </ul>"},{"location":"python/python/mkdocs/#_4","title":"\u9879\u76ee\u5c42\u7ea7","text":"<pre><code>mkdocs.yml    # The configuration file.\ndocs/\n    index.md  # The documentation homepage.\n    ...       # Other markdown pages, images and other files.\n</code></pre>"},{"location":"python/python/mkdocs/#_5","title":"\u90e8\u7f72","text":"<p>MkDocs \u90e8\u7f72\u6587\u6863</p> <p>MkDocs-Material \u90e8\u7f72\u6587\u6863</p> <p>\u5f53\u524d\u4f7f\u7528github pages\u670d\u52a1\u90e8\u7f72\u9759\u6001\u6587\u4ef6\uff0c\u7531\u4e8e\u4e0d\u60f3\u535a\u5ba2\u7684\u6e90\u6587\u4ef6\u66b4\u9732\u51fa\u53bb\uff0c\u6211\u5c06\u4e4b\u5206\u4e3a\u4e24\u4e2a\u9879\u76ee\uff0c\u4e00\u4e2a\u79c1\u6709\u9879\u76eeBlog-MkDocs\u5b58\u653e\u535a\u5ba2\u6e90\u7801\uff0c\u4e00\u4e2a\u516c\u5f00\u9879\u76eeyinkh.github.io\u505agithub-pages\u670d\u52a1\u3002</p>"},{"location":"python/python/mkdocs/#_6","title":"\u81ea\u5b9a\u4e49\u57df\u540d","text":"<p>GitHub Pages\u670d\u52a1\u7684\u81ea\u5b9a\u4e49\u57df\u540d\u529f\u80fd\u7531CNAME\u6587\u4ef6\u5b9e\u73b0\uff0cMkDocs\u5bf9\u6b64\u505a\u4e86\u7279\u6b8a\u652f\u6301\uff0c\u5728 docs_dir \u76ee\u5f55\u4e0b\u653e\u7f6eCNAME\u6587\u4ef6\u540e\uff0c\u7f16\u8bd1\u9759\u6001\u6587\u4ef6\u7684\u65f6\u5019\u4f1a\u81ea\u52a8\u5e26\u4e0a\u8be5\u6587\u4ef6\u3002custom-domains</p>"},{"location":"python/python/mkdocs/#_7","title":"\u624b\u52a8\u90e8\u7f72","text":"<p>\u5728Blog-MkDocs\u9879\u76ee\u4e0b\uff0c\u624b\u52a8\u5411\u9879\u76eeyinkh.github.io\u63a8\u9001\u3002</p> <pre><code>cd ..\\yinkh.github.io\nmkdocs gh-deploy --config-file ..\\Blog-MkDocs\\mkdocs.yml --remote-branch master\n</code></pre>"},{"location":"python/python/mkdocs/#_8","title":"\u81ea\u52a8\u90e8\u7f72","text":"<p>\u53c2\u8003 Github Pages\u548cActions\uff0c\u53ef\u5b9e\u73b0\u5199\u5b8c\u535a\u5ba2\u540e\uff0c\u63a8\u9001\u81f3github\uff0c\u4e4b\u540e\u7684\u5de5\u4f5c\u5b8c\u5168\u7531CI\u5b8c\u6210\u3002</p>"},{"location":"python/python/mkdocs/#mkdocs-material","title":"mkdocs material","text":"<p>\u9879\u76ee\u5730\u5740\uff1amkdocs-material</p>"},{"location":"python/python/mkdocs/#_9","title":"\u4e2d\u6587\u641c\u7d22\u652f\u6301","text":"<p>chinese-search-support</p>"},{"location":"python/python/mkdocs/#_10","title":"\u5bfc\u822a\u680f\u5355\u884c\u652f\u6301","text":"<ol> <li> <p>\u4e0b\u8f7d\u4ee3\u7801\uff0c\u642d\u5efa\u5f00\u53d1\u73af\u5883 customization</p> </li> <li> <p>\u6309PR\u4e2d\u7684change\u4fee\u6539\u6e90\u7801 mkdocs-material/pull/3936</p> </li> <li> <p>\u6253\u5305\u65b0\u7684\u4ee3\u7801 building-the-theme</p> </li> <li> <p>\u6253\u5305\u4ea7\u7269\u4f4d\u4e8ematerial\u6587\u4ef6\u5939\u4e0b\uff0c\u9700\u8981\u4e0b\u5217\u6587\u4ef6\u79fb\u52a8\u81f3\u81ea\u5df1\u9879\u76ee\u7684overrides\u6587\u4ef6\u5939\u4e0b\u7684\uff1a <pre><code>material/base.html\nmaterial/partials/header.html\nmaterial/assets/javascripts/bundle.e39167e5.min.js\nmaterial/assets/javascripts/bundle.e39167e5.min.js.map\nmaterial/assets/javascripts/workers/search.c9d2aade.min.js\nmaterial/assets/javascripts/workers/search.c9d2aade.min.js.map\nmaterial/assets/stylesheets/main.39214a4c.min.css\nmaterial/assets/stylesheets/main.39214a4c.min.css.map\nmaterial/assets/stylesheets/palette.a6bdf11c.min.css\nmaterial/assets/stylesheets/palette.a6bdf11c.min.css.map\n</code></pre> \u5c06 <code>base.html</code> \u6587\u4ef6\u4e2d\u5f15\u7528\u7684 <code>bundle.js search.js main.css palette.css</code> \u91cd\u547d\u540d\u4e3a\u5bf9\u5e94\u7684\u538b\u7f29\u6587\u4ef6\u3002</p> </li> </ol> <p>mkdocs-material==9.1.11 \u51fa\u73b0\u641c\u7d22\u65f6\u5bfc\u822a\u680f\u4e0d\u538b\u9ed1\u7684\u60c5\u51b5 <code>src/assets/stylesheets/main/components/_tabs.scss:31</code>:</p> <pre><code>.md-tabs {\n    z-index: 1;\n}\n</code></pre>"},{"location":"python/python/pinyin/","title":"\u6c49\u5b57\u8f6c\u62fc\u97f3\uff08\u7b80\u7801\u751f\u6210\uff09","text":""},{"location":"python/python/pinyin/#_1","title":"\u5bf9\u6bd4","text":""},{"location":"python/python/pinyin/#pinyin","title":"pinyin","text":"<ul> <li>\u4e0d\u652f\u6301\u591a\u97f3\u5b57</li> </ul>"},{"location":"python/python/pinyin/#pypinyin","title":"pypinyin","text":"<ul> <li>\u6839\u636e\u8bcd\u7ec4\u667a\u80fd\u5339\u914d\u6700\u6b63\u786e\u7684\u62fc\u97f3\u3002</li> <li> <p>\u652f\u6301\u591a\u97f3\u5b57\u3002</p> </li> <li> <p>\u7b80\u5355\u7684\u7e41\u4f53\u652f\u6301\u3002</p> </li> <li>\u652f\u6301\u591a\u79cd\u4e0d\u540c\u62fc\u97f3\u98ce\u683c\u3002</li> </ul>"},{"location":"python/python/pinyin/#xpinyin","title":"xpinyin","text":"<ul> <li>\u4e0d\u652f\u6301\u591a\u97f3\u5b57</li> </ul>"},{"location":"python/python/pinyin/#chinesetone","title":"ChineseTone","text":"<ul> <li>\u652f\u6301\u591a\u97f3\u5b57</li> <li>\u5224\u65ad\u662f\u5426\u4e3a\u591a\u97f3\u5b57</li> <li>\u83b7\u53d6\u62fc\u97f3\u7684\u58f0\u6bcd\u90e8\u5206</li> <li>\u83b7\u53d6\u67d0\u6c49\u5b57\u7684\u6240\u6709\u62fc\u97f3</li> </ul>"},{"location":"python/python/pinyin/#_2","title":"\u5b9e\u73b0","text":"<p>ChineseTone\u5728python3\u65f6\u6253\u5f00\u6587\u4ef6\u9700\u8981\u52a0\u5165encoding='utf-8</p> <pre><code>str = '\u91cd\u5e86'\nimport pinyin\nprint(pinyin.get(str, format=\"strip\", delimiter=\" \"))\nfrom pypinyin import pinyin\nimport pypinyin\nprint(pinyin(str, style=pypinyin.NORMAL, heteronym=True))\nfrom ChineseTone import *\nprint(PinyinHelper.convertToPinyinFromSentence(str, pinyinFormat=PinyinFormat.WITHOUT_TONE))\n</code></pre> <p>\u91cd\u5e86\uff1a</p> <pre><code>zhong qing\n\n[['chong'], ['qing']]\n\n['chong', 'qing']\n</code></pre> <p>\u4e86\u89e3\u4e86\uff1a</p> <pre><code>le jie le\n\n[['le', 'liao'], ['jie', 'xie'], ['le', 'liao']]\n\n['liao', 'jie', 'le']\n</code></pre> <p>\u5927\u592b\uff1a</p> <pre><code>da fu\n\n[['da'], ['fu']]\n\n['da', 'fu']\n</code></pre> <p>pypinyin\u548cChineseTone\u529f\u80fd\u76f8\u8fd1\uff0c\u6682\u7528pypinyin\uff0c\u591a\u6b21\u5bf9\u6bd4\u591a\u97f3\u5b57pypinyin\u66f4\u4e3a\u51c6\u786e\uff0c\u4f46\u90fd\u4f1a\u51fa\u9519\u3002</p> <p>\u7b80\u7801\u751f\u6210\u57fa\u7840\u4ee3\u7801\uff1a</p> <pre><code>import itertools\nimport pypinyin\nfrom pypinyin import pinyin\nname = '\u91cd\u5927\u6bb7\u4e5001'\nsimple_code_list = pinyin(name, style=pypinyin.FIRST_LETTER, heteronym=True, errors='default')\nfor i in range(0, len(simple_code_list)-1):\nc = list(itertools.product(simple_code_list[i], simple_code_list[i+1]))\nd = []\nfor j in c:\nd.append(''.join(j))\nsimple_code_list[i+1] = d\nprint(simple_code_list[i+1], len(simple_code_list[i+1]))\n</code></pre> <p>\u8f93\u51fa\u7ed3\u679c\uff1a</p> <pre><code>['zd', 'zt', 'cd', 'ct', 'td', 'tt'] 6\n\nzd,zt,cd,ct,td,tt\n\n['zdy', 'zty', 'cdy', 'cty', 'tdy', 'tty'] 6\n\nzdy,zty,cdy,cty,tdy,tty\n\n['zdyl', 'zdyy', 'ztyl', 'ztyy', 'cdyl', 'cdyy', 'ctyl', 'ctyy', 'tdyl', 'tdyy', 'ttyl', 'ttyy'] 12\n\nzdyl,zdyy,ztyl,ztyy,cdyl,cdyy,ctyl,ctyy,tdyl,tdyy,ttyl,ttyy\n\n['zdyl01', 'zdyy01', 'ztyl01', 'ztyy01', 'cdyl01', 'cdyy01', 'ctyl01', 'ctyy01', 'tdyl01', 'tdyy01', 'ttyl01', 'ttyy01'] 12\n</code></pre> <p>\u4f7f\u7528join \u51fd\u6570\u6765\u62fc\u63a5\u5b57\u7b26\u4e32:</p> <pre><code>print(','.join(simple_code_list[i+1]))\n</code></pre> <p>\u8f93\u51fa\u7ed3\u679c\uff1azdyl01,zdyy01,ztyl01,ztyy01,cdyl01,cdyy01,ctyl01,ctyy01,tdyl01,tdyy01,ttyl01,ttyy01</p> <pre><code>print('_'.join(simple_code_list[i+1]))\n</code></pre> <p>\u8f93\u51fa\u7ed3\u679c\uff1azdyl01_zdyy01_ztyl01_ztyy01_cdyl01_cdyy01_ctyl01_ctyy01_tdyl01_tdyy01_ttyl01_ttyy01</p> <pre><code>print(' '.join(simple_code_list[i+1]))\n</code></pre> <p>\u8f93\u51fa\u7ed3\u679c\uff1azdyl01 zdyy01 ztyl01 ztyy01 cdyl01 cdyy01 ctyl01 ctyy01 tdyl01 tdyy01 ttyl01 ttyy01</p> <p>\u4f7f\u7528split\u51fd\u6570\u6765\u62c6\u5206\u5b57\u7b26\u4e32:</p> <pre><code>c = ','.join(simple_code_list[i+1])\nprint(c.split(','), type(c.split(',')))\n</code></pre> <p>\u8f93\u51fa\u7ed3\u679c\uff1a['zdyl01', 'zdyy01', 'ztyl01', 'ztyy01', 'cdyl01', 'cdyy01', 'ctyl01', 'ctyy01', 'tdyl01', 'tdyy01', 'ttyl01', 'ttyy01']  <pre><code>c = ' '.join(simple_code_list[i+1])\nprint(c.split(' '), type(c.split(',')))\n</code></pre> <p>\u8f93\u51fa\u7ed3\u679c\uff1a['zdyl01', 'zdyy01', 'ztyl01', 'ztyy01', 'cdyl01', 'cdyy01', 'ctyl01', 'ctyy01', 'tdyl01', 'tdyy01', 'ttyl01', 'ttyy01']  <p>\u6574\u7406\u5b8c\u6210\u7684\u51fd\u6570:</p> <pre><code>import itertools\nimport pypinyin\nfrom pypinyin import pinyin\n# \u7531\u6c49\u5b57\u83b7\u53d6\u62fc\u97f3\u7b80\u7801\u5b57\u7b26\u4e32\n# Receive ----------------------------------\n# name: \u6c49\u5b57\u540d\u79f0\n# Return -----------------------------------\n# \u7b80\u7801\u5b57\u7b26\u4e32 \u4ee5 , \u9694\u5f00\ndef brief_code(name=''):\n# \u53ea\u83b7\u53d6\u9996\u5b57\u6bcd\u62fc\u97f3 \u5141\u8bb8\u591a\u97f3\u5b57 \u975e\u6c49\u5b57\u90e8\u5206\u4fdd\u7559\u539f\u59cb\u5b57\u7b26\nbrief_codes = pinyin(name, style=pypinyin.FIRST_LETTER, heteronym=True, errors='default')\nfor i in range(0, len(brief_codes) - 1):\nc = list(itertools.product(brief_codes[i], brief_codes[i + 1]))\nd = []\nfor j in c:\nd.append(''.join(j))\nbrief_codes[i + 1] = d\nif i == len(brief_codes) - 2:\nreturn ','.join(brief_codes[i + 1])\nreturn ''\nprint(brief_code('\u91cd\u5927\u6bb7\u4e5001'))\n</code></pre> <p>\u8f93\u51fa\u7ed3\u679c\uff1azdyl01,zdyy01,ztyl01,ztyy01,cdyl01,cdyy01,ctyl01,ctyy01,tdyl01,tdyy01,ttyl01,ttyy01</p> <p>https://www.biaodianfu.com/python-hanzi-to-pinyin.html</p>"},{"location":"python/python/pip-publish/","title":"PyPi\u53d1\u5e03","text":""},{"location":"python/python/pip-publish/#_1","title":"\u6ce8\u518c","text":"<p>\u524d\u5f80 https://pypi.org/ \u6ce8\u518c\u8d26\u53f7\u3002</p>"},{"location":"python/python/pip-publish/#setup","title":"setup\u6a21\u677f","text":"<p>\u8be5\u6587\u4ef6\u7528\u4e8e\u5bf9\u5e93\u8fdb\u884c\u8bf4\u660e\u3001\u8bbe\u7f6e</p> <pre><code>import os\nfrom setuptools import find_packages, setup\nimport popup_field\nversion = popup_field.__version__\nwith open(os.path.join(os.path.dirname(__file__), 'README.md')) as readme:\nREADME = readme.read()\nwith open(os.path.join(os.path.dirname(__file__), 'HISTORY.md')) as history:\nHISTORY = history.read()\n# allow setup.py to be run from any path\nos.chdir(os.path.normpath(os.path.join(os.path.abspath(__file__), os.pardir)))\nsetup(\nname='django-popup-field',\nversion=version,\ndescription='A popup field for django which can create\\\\update\\\\delete ForeignKey and ManyToManyField instance by popup windows.',\nlong_description=README + '\\n\\n' + HISTORY,\nlicense='BSD 3-Clause License',\npackages=[\n'popup_field'\n],\ninclude_package_data=True,\ninstall_requires=[\n],\nurl='https://github.com/yinkh/django-popup-field.git',\nauthor='Yin KangHong',\nauthor_email='614457662@qq.com',\nkeywords='django-popup-field',\nclassifiers=[\n'Development Status :: 3 - Alpha',\n'Intended Audience :: Developers',\n'License :: OSI Approved :: MIT License',\n'Operating System :: OS Independent',\n'Programming Language :: Python :: 3',\n'Topic :: Software Development :: Libraries',\n'Environment :: Web Environment',\n'Framework :: Django',\n],\n)\n</code></pre>"},{"location":"python/python/pip-publish/#license","title":"LICENSE\u6a21\u677f","text":"<p>\u8be5\u6587\u4ef6\u7528\u4e8e\u58f0\u660e\u6388\u6743</p> <pre><code>BSD 3-Clause License\n\nCopyright (c) 2018 Yin KangHong(\u6bb7\u5eb7\u7ea2)\nAll rights reserved.\n\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions are met:\n\n* Redistributions of source code must retain the above copyright notice, this\n  list of conditions and the following disclaimer.\n\n* Redistributions in binary form must reproduce the above copyright notice,\n  this list of conditions and the following disclaimer in the documentation\n  and/or other materials provided with the distribution.\n\n* Neither the name of the copyright holder nor the names of its\n  contributors may be used to endorse or promote products derived from\n  this software without specific prior written permission.\n\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\"\nAND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\nIMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\nDISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE\nFOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL\nDAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR\nSERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER\nCAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,\nOR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\nOF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n</code></pre>"},{"location":"python/python/pip-publish/#manifestin","title":"MANIFEST.in\u6a21\u677f","text":"<p>\u8be5\u6587\u4ef6\u7528\u4e8e\u6307\u5b9a\u4f1a\u6253\u5305\u6db5\u76d6\u7684\u6587\u4ef6</p> <pre><code>include LICENSE\ninclude README.md\ninclude HISTORY.md\nrecursive-include popup_field *\nglobal-exclude *.pyc\n</code></pre>"},{"location":"python/python/pip-publish/#_2","title":"\u7f16\u8bd1","text":"<ul> <li>tar.gz</li> </ul> <pre><code> python setup.py sdist build\n</code></pre> <ul> <li>wheel</li> </ul> <pre><code>pip install wheel\npython setup.py bdist_wheel --universal\n</code></pre>"},{"location":"python/python/pip-publish/#_3","title":"\u4e0a\u4f20","text":"<pre><code>sudo pip install twine\ntwine upload dist/*\n</code></pre>"},{"location":"python/python/pip-publish/#demo-site","title":"Demo Site","text":"<p>\u4f7f\u7528<code>Django</code>\u5b9e\u73b0\u4e00\u4e2a\u6d4b\u8bd5\u7ad9\u70b9\u65f6\uff0c\u9700\u8981\u5728<code>settings</code>\u91cc\u58f0\u660e\uff1a</p> <pre><code>PACKAGE_DIR = os.path.dirname(BASE_DIR)\nif PACKAGE_DIR not in sys.path:\nsys.path.insert(0, PACKAGE_DIR)\n</code></pre> <p>\u4ee5\u4fdd\u8bc1\u8be5\u5e93\u80fd\u5728<code>INSTALLED_APPS</code>\u4e2d\u88ab\u6b63\u786e\u5f15\u7528\u3002</p>"},{"location":"python/python/pycharm-ssh/","title":"Pycharm\u4e2d\u5229\u7528ssh\u8fdc\u7a0b\u90e8\u7f72","text":""},{"location":"python/python/pycharm-ssh/#1-pycharm","title":"1 \u914d\u7f6ePycharm","text":"<ol> <li> <p>\u6253\u5f00 <code>Tools -&gt; Deployment -&gt; Configuration</code></p> </li> <li> <p>\u70b9\u51fb\u6dfb\u52a0\u6309\u94ae\uff0c\u6dfb\u52a0\u914d\u7f6e\u3002</p> </li> <li> <p><code>Name</code>\u8f93\u5165\u5bf9\u5e94\u670d\u52a1\u5668\u7684\u522b\u540d</p> </li> </ol> <p><code>Connection</code> \u8fde\u63a5\u9009\u9879\u5361\u914d\u7f6e</p> <p></p> <ul> <li>\u9009\u4e2d<code>Visible only for this project</code>\uff0c\u53ca\u4ec5\u5728\u6b64\u9879\u76ee\u4e2d\u53ef\u89c1\u6b64\u914d\u7f6e(\u8fdc\u7a0b\u670d\u52a1\u5668)\u3002</li> <li><code>Type</code>\u8fde\u63a5\u7c7b\u578b\u9009\u62e9SFTP</li> <li><code>SFTP host</code>\u4e3a\u4f60\u670d\u52a1\u5668\u7684IP\u5730\u5740</li> <li><code>PORT</code>\u4e3a<code>ssh</code>\u7aef\u53e3\uff0c\u9ed8\u8ba4\u4e3a22\uff0c\u82e5\u670d\u52a1\u5668<code>ssh</code>\u7aef\u53e3\u5df2\u4fee\u6539\uff0c\u8bf7\u76f8\u5e94\u4fee\u6539\u6b64\u53c2\u6570\u3002</li> <li><code>Root path</code>\u4e3a\u670d\u52a1\u5668\u6839\u76ee\u5f55\uff0c\u9ed8\u8ba4\u4e3a/\u3002</li> <li><code>User name</code>\u4e3a\u670d\u52a1\u5668\u7ba1\u7406\u5458\u8d26\u53f7</li> <li><code>Auth type</code>\u4e3a\u670d\u52a1\u5668\u9a8c\u8bc1\u7c7b\u578b\uff0c\u652f\u6301ras\u5bc6\u94a5\u548c\u5bc6\u7801\u3002\u672c\u6587\u4e3a\u8fde\u63a5\u5c40\u57df\u7f51\u6d4b\u8bd5\u670d\u52a1\u5668\uff0c\u4f7f\u7528\u5bc6\u7801\u8fde\u63a5\uff0c\u82e5\u8fde\u63a5\u8fdc\u7a0b\u670d\u52a1\u5668\uff0c\u63a8\u8350\u4f7f\u7528ras\u5bc6\u94a5\u8fdb\u884c\u9a8c\u8bc1\u4ee5\u4fdd\u8bc1\u5b89\u5168\u3002</li> <li><code>Password</code>\u4e3a\u670d\u52a1\u5668\u7ba1\u7406\u5458\u5bc6\u7801</li> <li><code>Web server root URL</code>\u4e3a\u8fdc\u7a0b\u670d\u52a1\u5668\u8fde\u63a5url</li> </ul> <p><code>Mappings</code> \u6587\u4ef6\u8def\u5f84\u6620\u5c04\u9009\u9879\u5361\u914d\u7f6e</p> <p></p> <ul> <li><code>Local path</code>\u4e3a\u672c\u5730\u9879\u76ee\u7684\u9879\u76ee\u4f4d\u7f6e</li> <li><code>Deployment path on server</code>\u4e3a\u8fdc\u7a0b\u670d\u52a1\u5668\u5bf9\u5e94\u7684\u9879\u76ee\u4f4d\u7f6e</li> </ul> <p><code>Excluded Paths</code> \u5ffd\u7565\u7684\u540c\u6b65\u8def\u5f84\u8bbe\u7f6e</p> <p></p> <ul> <li><code>Add local path</code> \u6dfb\u52a0\u672c\u5730\u4e0a\u4f20\u65f6\u5ffd\u7565\u7684\u6587\u4ef6\u5939</li> <li><code>Add deployment path</code> \u4e0b\u8f7d\u8fdc\u7a0b\u670d\u52a1\u5668\u6587\u4ef6\u5939\u65f6\u5ffd\u7565\u7684\u6587\u4ef6\u5939</li> </ul>"},{"location":"python/python/pycharm-ssh/#2","title":"2 \u4f7f\u7528\u7b14\u8bb0","text":"<ul> <li>\u5b8c\u6210\u914d\u7f6e1\u6b65\u9aa43\u540e,\u9009\u4e2d\u5f85\u4e0a\u4f20\u7684\u6587\u4ef6\u5939\u6216\u8005\u6587\u4ef6,\u518d\u6b21\u6253\u5f00Tools -&gt; Deployment \u5373\u53ef\u770b\u5230upload to server_xxx,\u70b9\u51fb\u5373\u53ef\u540c\u6b65\u5bf9\u5e94\u670d\u52a1\u5668\u4e0a\u6620\u5c04\u76ee\u5f55\u4ee3\u7801\u3002</li> <li>\u70b9\u51fb <code>Tools -&gt; Deployment -&gt; Automatic Upload</code> \u5373\u53ef\u81ea\u52a8\u5c06\u672c\u5730\u4fee\u6539\u7684\u4ee3\u7801\u540c\u6b65\u81f3\u8fdc\u7a0b\u670d\u52a1\u5668</li> <li>\u70b9\u51fb <code>Tools -&gt; Deployment -&gt; Browse Remote Host</code> \u5373\u53ef\u6253\u5f00\u8fdc\u7a0b\u670d\u52a1\u5668\u4e0a\u7684\u6587\u4ef6\u76ee\u5f55\u6811\uff0c\u9009\u62e9\u6587\u4ef6\u5373\u53ef\u5728\u672c\u5730IDE\u4e2d\u5bf9\u4ee3\u7801\u8fdb\u884c\u4fee\u6539\uff0c\u4fee\u6539\u5b8c\u6210\u540ePycharm\u4f1a\u51fa\u73b0\u63d0\u793a\u7a97\u63d0\u793a\u6587\u4ef6\u88ab\u4fee\u6539\u662f\u5426\u4e0a\u4f20\uff0c\u70b9\u51fb\u4e0a\u4f20\u5373\u53ef\u4fee\u6539\u8fdc\u7a0b\u670d\u52a1\u5668\u4e2d\u4ee3\u7801\u3002</li> <li>\u4e0a\u4f20\u4ee3\u7801\u65f6\u8bf7\u65b0<code>clone</code>\u4e00\u4e2a\u7eaf\u51c0\u7684\u9879\u76ee,\u4e0d\u8981\u628a<code>virtualenv\u3001migrations\u3001media</code>\u7b49\u672c\u5730\u6d4b\u8bd5\u7684\u65e0\u7528\u6587\u4ef6\u4e0a\u4f20\u81f3\u8fdc\u7a0b\u670d\u52a1\u5668\uff0c\u7279\u522b\u662f<code>migrations</code>\u6587\u4ef6\uff0c\u4e00\u65e6\u4e0a\u4f20\u81f3\u8fdc\u7a0b\u670d\u52a1\u5668\u5c06\u5bfc\u81f4\u8fdc\u7a0b\u670d\u52a1\u5668\u6570\u636e\u5e93\u811a\u672c<code>node</code>\u4e2d\u65ad\u800c\u65e0\u6cd5\u7ee7\u7eed\u8fc1\u79fb\u6570\u636e\u5e93\u3002</li> <li>\u6bcf\u6b21<code>upload</code>\u7684\u6587\u4ef6\u4e3a<code>IDE</code>\u5f53\u524d\u9009\u4e2d\u7684\u6587\u4ef6</li> <li>\u5fc5\u987b\u6709\u9009\u4e2d\u7684\u6587\u4ef6\u6216\u8005\u6587\u4ef6\u5939,\u70b9\u51fb<code>Tools -&gt; Deployment</code> \u624d\u53ef\u770b\u5230<code>upload to server_xxx</code>\u9009\u9879\u4eae\u8d77,\u5426\u5219\u4e0d\u4f1a\u4eae\u8d77\uff01</li> </ul>"},{"location":"python/python/pycharm-ssh/#3-terminalssh","title":"3 \u5728<code>Terminal</code>\u4e2d<code>ssh</code>\u76f4\u8fde\u670d\u52a1\u5668","text":"<p>\u4e3b\u83dc\u5355<code>Tools-&gt;Start SSH Session</code>,\u9009\u62e9\u9700\u8981ssh\u8fde\u63a5\u7684\u670d\u52a1\u5668\uff0c\u5373\u53ef\u5b9e\u73b0\u4e0e<code>PuTTY</code>\u7c7b\u4f3c\u7684\u529f\u80fd\uff0c\u65b9\u4fbf\u5feb\u6377\u3002</p> <p>\u9ebb\u74dc\u7f16\u7a0b \u817e\u8baf\u89c6\u9891 \u77e5\u4e4e\u95ee\u9898</p>"},{"location":"python/python/pycharm/","title":"Pycharm\u8c03\u6559","text":""},{"location":"python/python/pycharm/#_1","title":"\u5e38\u7528\u5feb\u6377\u952e","text":"<pre><code>- Show Intention Actions \u5feb\u901f\u5bfc\u5165\u3001\u8865\u5168\u51fd\u6570 (alt+z) # \u5df2\u6539\u540d\u4e3a Show Context Actions\n- Reformat Code \u81ea\u52a8\u6574\u7406\u4ee3\u7801 (ctrl+tab)\n- Select Line at Caret \u9009\u62e9\u5f53\u524d\u884c ctrl+d\n- Alt+Shift+\u5411\u4e0a\u7bad\u5934\\\u5411\u4e0b\u7bad\u5934 \u79fb\u52a8\u672c\u884c\u4ee3\u7801\n- Alt+\u4e0a\u4e0b\u7bad\u5934 \u79fb\u52a8\u5230\u672c\u6587\u4ef6\u5185\u7684\u4e0a\u4e00\u4e2a\u6216\u8005\u4e0b\u4e00\u4e2a\u65b9\u6cd5\u5b9a\u4e49\u7684\u4f4d\u7f6e\n- # FIXME Bug\u63cf\u8ff0\n- # TODO \u5f85\u505a\u4e8b\u9879\n- ctrl+shift+F \u5168\u5c40\u67e5\u627e\u4e00\u4e2a\u53d8\u91cf \u4e00\u5b9a\u8981\u5728\u82f1\u6587\u8f93\u5165\u6cd5\u4e0b\u8c03\u7528\uff0c\u5426\u5219\u65e0\u6cd5\u6389\u51fa\u641c\u7d22\u9875\u9762\u3002\n- Full Screen \u5168\u5c4f  \u63a8\u8350\u6309\u952e`ctrl+Q`\n- Comment with Line Comment \u5355\u884c\u6ce8\u91ca\uff08ctrl+\\\uff09 \u63a8\u8350\u6309\u952eCtrl+Shift+C\n- Comment with Blick Comment \u533a\u5757\u6ce8\u91ca\uff08ctrl+shift+\\)\n- ctrl+shift+I \u67e5\u770b\u53d8\u91cf\u5b9a\u4e49\u7684\u4f4d\u7f6e\n- ctrl+alt+O Optimize Imports \u81ea\u52a8\u6574\u7406import\n- ctrl+alt+[] \u5207\u6362\u5230\u4e0a\u4e00\u4e2a\u6216\u8005\u4e0b\u4e00\u4e2a\u9879\u76ee\u7684\u7a97\u53e3\n- ctrl+shift+alt+c \u590d\u5236\u5f53\u524d\u6587\u4ef6\uff08\u65b9\u6cd5\uff09\u8def\u5f84\n</code></pre>"},{"location":"python/python/pycharm/#terminalssh","title":"\u5728<code>Terminal</code>\u4e2d<code>ssh</code>\u76f4\u8fde\u670d\u52a1\u5668","text":"<p>\u4e3b\u83dc\u5355<code>Tools-&gt;Start SSH Session</code>,\u9009\u62e9\u9700\u8981ssh\u8fde\u63a5\u7684\u670d\u52a1\u5668\uff0c\u5373\u53ef\u5b9e\u73b0\u4e0e<code>PuTTY</code>\u7c7b\u4f3c\u7684\u529f\u80fd\uff0c\u65b9\u4fbf\u5feb\u6377\u3002</p>"},{"location":"python/python/pycharm/#live-template","title":"Live Template","text":"<p>\u4f7f\u7528\u5feb\u6377\u540d\u79f0\u5feb\u901f\u8865\u5168\u4ee3\u7801\u5757\uff0c\u4ee5\u63d0\u9ad8\u642c\u7816\u6548\u7387\u3002 \u5982\u4e0a\u56fe\u6240\u793a\uff0c\u4ee5\u540e\u53ea\u9700\u8981\u5728<code>.py</code>\u6587\u4ef6\u4e2d\u6253\u51fa<code>model</code>\u5373\u53ef\u9009\u62e9\u8fd9\u4e2a<code>new model</code>\u7684\u6a21\u677f\uff0c\u9009\u62e9\u540e\u5c06\u81ea\u52a8\u5c06<code>Template text</code>\u8d34\u5165\u5f53\u524d\u4f4d\u7f6e\u3002</p>"},{"location":"python/python/pycharm/#_2","title":"\u5f55\u5236\u5e38\u7528\u547d\u4ee4","text":"<pre><code>\u9891\u7e41\u7684\u5728Terminal\u4e2d\u8f93\u5165`makemigrations\u3001migrate\u3001runserver`\u7b49\u547d\u4ee4\u6548\u7387\u6bd4\u8f83\u4f4e\uff0c\u91c7\u7528\u5f55\u5236\u547d\u4ee4\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u4e00\u952e\u5b8c\u6210\u4e0a\u8ff0\u64cd\u4f5c\uff0c\u65b9\u4fbf\u5feb\u6377\uff0c\u6b65\u9aa4\u5982\u4e0b\uff1a\n- Pycharm\u53f3\u4e0a\u89d2\u70b9\u51fb\u8fd0\u884c\u6309\u94ae\u5de6\u4fa7\u7684\u4e0b\u62c9\u6846\uff0c\u9009\u62e9`Edit Configurations`\u3002\n![](https://blog.dreamgotech.com/media/summer_note/20171108-174126-967.png)\n- \u8fdb\u5165\u5982\u56fe\u754c\u9762\uff1a![](https://blog.dreamgotech.com/media/summer_note/20171108-174139-124.png)\n\n    * `Name`\uff1a\u8be5\u547d\u4ee4\u7684\u522b\u540d\n    * `Script`:Django\u6839\u76ee\u5f55\u7684manage.py\u6587\u4ef6\n    * `Script Parameters`\uff1a\u5177\u4f53\u7684\u547d\u4ee4\uff0c\u4e0d\u5e26`python manage.py`\u8fd9\u90e8\u5206\uff0c\u5982`python manage.py makemigrations`\u53ea\u8f93\u5165`makemigrations`\u5373\u53ef\u3002\n    * `Python interpreter`:\u9879\u76ee\u5bf9\u5e94\u7684python\u73af\u5883\uff0c\u4f7f\u7528\u865a\u62df\u73af\u5883\u65f6\u8bf7\u9009\u62e9\u5230\u5bf9\u5e94\u7684\u865a\u62df\u73af\u5883\u3002\n\n\u8bbe\u7f6e\u5b8c\u4e0a\u8ff0\u9009\u9879\uff0c\u4fdd\u5b58\u5373\u53ef\u3002\n</code></pre>"},{"location":"python/python/pycharm/#_3","title":"\u63d2\u4ef6","text":"<pre><code>- CodeGlance \u4ee3\u7801\u9884\u89c8\u63d2\u4ef6\n- JsonParser JSON\u89e3\u6790\n- Rainbow Brackets \u9ad8\u4eae\u5339\u914d\u7b26\n- Requirements \u7ba1\u7406\u4f9d\u8d56\uff0c\u53ef\u4ee5\u4e00\u952e\u81ea\u52a8\u751f\u6210\n- String Manipulation \u5b57\u7b26\u4e32\u5927\u5c0f\u5199\u547d\u540d\u65b9\u5f0f\u8f6c\u6362\n- Translation Google\u7ffb\u8bd1\n- Grep Console Console\u5173\u952e\u5b57\u8fc7\u6ee4\n</code></pre>"},{"location":"python/python/pycharm/#_4","title":"\u7f16\u7801\u95ee\u9898","text":"<pre><code>- log\u6587\u4ef6\u4e2d\u6587\u4e71\u7801 \n    \u6253\u5f00\u8bbe\u7f6e\uff0c\u641c\u7d22File Encodings-&gt;\u4f7f\u7528BG18030\u7f16\u7801\u52a0\u8f7dlog\u6587\u4ef6\n</code></pre>"},{"location":"python/python/pycharm/#_5","title":"\u7248\u6743\u8bbe\u7f6e","text":"<pre><code>\u5728\u8bbe\u7f6e\u91cc\u641c\u7d22`File and Code Templates`,\u8bbe\u7f6e\u9ed8\u8ba4\u6a21\u677f\u4e3a\uff1a\n\n    \"\"\"\n     Created by ${USER} on ${DATE}.\n    \"\"\"\n\n\u53ef\u4f7f\u7528\u7684\u53d8\u91cf\u8bf7\u53c2\u89c1[\u6b64\u5904](https://www.jetbrains.com/help/pycharm/file-template-variables.html)\u3002\n</code></pre> <p>\u76d7\u5f20\u4ecb\u7ecd\u56fe\uff0c\u51fa\u5904\u89c1\u6c34\u5370\uff1a </p> <p>\u5728pycharm\u4e2d\u4f7f\u7528sftp\u4e0e\u670d\u52a1\u5668\u8fdb\u884c\u6587\u4ef6\u4ea4\u4e92\u8bf7\u53c2\u8003Pycharm\u4e2d\u5229\u7528ssh\u8fdc\u7a0b\u90e8\u7f72\u3002\u8fdc\u7a0b\u90e8\u7f72\u63a8\u8350\u4f7f\u7528Fabric\u90e8\u7f72\u3001\u7ef4\u62a4\u3002</p>"},{"location":"python/python/pycharm/#__pychche__","title":"\u663e\u793a\u6216\u9690\u85cf<code>__pychche__</code>\u6587\u4ef6\u5939","text":"<p><code>Setting-&gt;Editor-&gt;File Types-&gt;Ignore files and folders</code> \u9ed8\u8ba4\uff1a</p> <pre><code>*$py.class;*.hprof;*.rbc;*.yarb;*~;.DS_Store;.git;.hg;.svn;CVS;_svn;vssver.scc;vssver2.scc;__pycache__;\n</code></pre>"},{"location":"python/python/python-note/","title":"Python\u7b14\u8bb0","text":""},{"location":"python/python/python-note/#_1","title":"\u95ed\u5305","text":"<p>\u5b9a\u4e49\uff1a\u5982\u679c\u5728\u4e00\u4e2a\u5185\u90e8\u51fd\u6570\u91cc\uff0c\u5bf9\u5728\u5916\u90e8\u4f5c\u7528\u57df\uff08\u4f46\u4e0d\u5728\u5168\u5c40\u4f5c\u7528\u57df\uff09\u7684\u53d8\u91cf\u8fdb\u884c\u5f15\u7528\uff0c\u51fd\u6570\u8fd4\u56de\u5185\u90e8\u51fd\u6570\uff0c\u90a3\u4e48\u5185\u90e8\u51fd\u6570\u5c31\u88ab\u8ba4\u4e3a\u662f\u95ed\u5305\uff08closure\uff09\u3002</p> <p>\u95ed\u5305\u9700\u8981\u6ee1\u8db3\u4e09\u4e2a\u6761\u4ef6\uff1a</p> <ol> <li>\u51fd\u6570\u6709\u5185\u90e8\u51fd\u6570</li> <li>\u5185\u90e8\u51fd\u6570\u5bf9\u5728\u5916\u90e8\u4f5c\u7528\u57df\uff08\u4f46\u4e0d\u5728\u5168\u5c40\u4f5c\u7528\u57df\uff09\u7684\u53d8\u91cf\u8fdb\u884c\u5f15\u7528</li> <li>\u51fd\u6570\u8fd4\u56de\u5185\u90e8\u51fd\u6570</li> </ol> <p>\u793a\u4f8b\u4ee3\u78011\uff1a</p> <pre><code>def addx(x):\ndef adder(y):\nreturn x+y\nreturn adder\nc = addx(8)\nprint(c.__name__, type(c))\nprint(c(10))\nprint(c(11))\n</code></pre> <p>\u8f93\u51fa\uff1a</p> <pre><code>adder &lt;class 'function'&gt;   18 19\n</code></pre> <p>\u9519\u8bef\u793a\u83032\uff1a</p> <pre><code>def foo(a):\ndef bar():\na += 1\nreturn a[0]\nreturn bar\nd = foo(1)\nprint(d(), d(), d(), d())\n</code></pre> <p>\u9519\u8bef\u63d0\u793a\uff1a</p> <pre><code>File \"D:/PY_workspace/simple_code/closure.py\", line 16, in bar\na += 1\nUnboundLocalError: local variable 'a' referenced before assignment\n</code></pre> <p>\u539f\u56e0\uff1a</p> <p>python\u6307\u5b9a\u6240\u6709\u8d4b\u503c\u8bed\u53e5\u5de6\u8fb9\u7684\u53d8\u91cf\u90fd\u662f\u5c40\u90e8\u53d8\u91cf\uff0c\u5728\u95ed\u5305\u51fd\u6570bar()\u4e2d\uff0c\u53d8\u91cfa\u88ab\u770b\u505a\u4e86\u5c40\u90e8\u53d8\u91cf\uff0c\u63a5\u4e0b\u6765\u6267\u884cprint\u65f6\uff0c\u7a0b\u5e8f\u8fd0\u884c\u81f3a += 1\u65f6\uff0c\u56e0\u4e3a\u5148\u524d\u5df2\u7ecf\u628aa\u770b\u6210\u4e86\u5c40\u90e8\u53d8\u91cf\uff0c\u73b0\u5728python\u53bbbar\u4e2d\u5bfb\u627e\u8d4b\u503c\u8bed\u53e5\u53f3\u8fb9\u7684a\u7684\u503c\u627e\u4e0d\u5230\u5219\u4f1a\u62a5\u9519\u3002</p> <p>\u89e3\u51b3\u65b9\u6cd5\u4e3a\u5c06a\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u5bb9\u5668\uff0c\u5982\u4e0b\uff1a</p> <pre><code>def foo():\na = [1]\ndef bar():\na[0] = a[0] + 1\nreturn a[0]\nreturn bar\nd = foo()\nprint(d(), d(), d(), d())\n</code></pre> <p>\u8f93\u51fa\uff1a</p> <pre><code>2 3 4 5\n</code></pre> <p>\u793a\u4f8b\u4ee3\u78013\uff1a</p> <pre><code>origin = [0, 0]  # \u5750\u6807\u7cfb\u7edf\u539f\u70b9\nlegal_x = [0, 50]  # x\u8f74\u65b9\u5411\u7684\u5408\u6cd5\u5750\u6807\nlegal_y = [0, 50]  # y\u8f74\u65b9\u5411\u7684\u5408\u6cd5\u5750\u6807\ndef create(pos=origin):\ndef player(direction, step):\n# \u8fd9\u91cc\u5e94\u8be5\u9996\u5148\u5224\u65ad\u53c2\u6570direction,step\u7684\u5408\u6cd5\u6027\uff0c\u6bd4\u5982direction\u4e0d\u80fd\u659c\u7740\u8d70\uff0cstep\u4e0d\u80fd\u4e3a\u8d1f\u7b49\n# \u7136\u540e\u8fd8\u8981\u5bf9\u65b0\u751f\u6210\u7684x\uff0cy\u5750\u6807\u7684\u5408\u6cd5\u6027\u8fdb\u884c\u5224\u65ad\u5904\u7406\uff0c\u8fd9\u91cc\u4e3b\u8981\u662f\u60f3\u4ecb\u7ecd\u95ed\u5305\uff0c\u5c31\u4e0d\u8be6\u7ec6\u5199\u4e86\u3002\nnew_x = pos[0] + direction[0] * step\nnew_y = pos[1] + direction[1] * step\npos[0] = new_x\npos[1] = new_y\n# \u6ce8\u610f\uff01\u6b64\u5904\u4e0d\u80fd\u5199\u6210 pos = [new_x, new_y]\uff0c\u539f\u56e0\u5728\u4e0a\u6587\u6709\u8bf4\u8fc7\nreturn pos\nreturn player\nplayer = create()  # \u521b\u5efa\u68cb\u5b50player\uff0c\u8d77\u70b9\u4e3a\u539f\u70b9\nprint(player.__name__)\nprint(player([1, 0], 10)) # \u5411x\u8f74\u6b63\u65b9\u5411\u79fb\u52a810\u6b65\nprint(player([0, 1], 20))  # \u5411y\u8f74\u6b63\u65b9\u5411\u79fb\u52a820\u6b65\nprint(player([-1, 0], 10))  # \u5411x\u8f74\u8d1f\u65b9\u5411\u79fb\u52a810\u6b65\n</code></pre> <p>\u8f93\u51fa\uff1a</p> <pre><code>[10, 0] [10, 20] [0, 20]\n</code></pre> <p>\u95ed\u5305\u7684\u4f5c\u7528\uff1a</p> <p>1 \u5f53\u95ed\u5305\u6267\u884c\u5b8c\u6210\u540e\uff0c\u4f9d\u65e7\u53ef\u4ee5\u4fdd\u6301\u4f4f\u5f53\u524d\u7684\u8fd0\u884c\u73af\u5883\u3002</p> <p>2 \u95ed\u5305\u53ef\u4ee5\u66f4\u52a0\u5916\u90e8\u4f5c\u7528\u57df\u7684\u5c40\u90e8\u53d8\u91cf\u6765\u5f97\u5230\u4e0d\u540c\u7684\u7ed3\u679c\uff0c\u8fd9\u70b9\u7c7b\u4f3c\u4e8e\u914d\u7f6e\u529f\u80fd\u7684\u4f5c\u7528\uff0c\u53ef\u4ee5\u4fee\u6539\u5916\u90e8\u7684\u53d8\u91cf\uff0c\u95ed\u5305\u6839\u636e\u8fd9\u4e2a\u53d8\u91cf\u5c55\u73b0\u51fa\u4e0d\u540c\u7684\u529f\u80fd\u3002</p> <p>Python\u4e2d\u7684\u95ed\u5305</p>"},{"location":"python/python/python-note/#keydict","title":"\u4e00\u6b21\u68c0\u6d4b\u591a\u4e2akey\u662f\u5426\u4f4d\u4e8edict\u4e2d","text":"<pre><code>if all(k in request.data for k in (\"foo\", \"bar\")):\nprint('all in request.data')\n</code></pre>"},{"location":"python/python/python-note/#_2","title":"\u7236\u7c7b\u5f3a\u5236\u5b50\u7c7b\u7ee7\u627f\u7236\u7c7b\u7684\u65b9\u6cd5","text":"<pre><code>class BaseSerializer(Field):\ndef to_internal_value(self, data):\nraise NotImplementedError('`to_internal_value()` must be implemented.')\ndef to_representation(self, instance):\nraise NotImplementedError('`to_representation()` must be implemented.')\ndef update(self, instance, validated_data):\nraise NotImplementedError('`update()` must be implemented.')\ndef create(self, validated_data):\nraise NotImplementedError('`create()` must be implemented.')\n</code></pre> <p>\u5148\u5199\u4e00\u4e2a\u4f1a\u62a5<code>NotImplementedError</code>\u7684\u9ed8\u8ba4\u65b9\u6cd5\uff0c\u8981\u662f\u6ca1\u6709\u91cd\u5199\u8be5\u65b9\u6cd5\uff0c\u4f7f\u7528\u5230\u8be5\u65b9\u6cd5\u5c31\u4f1a\u629b\u51fa\u9519\u8bef\u3002</p>"},{"location":"python/python/python-note/#_3","title":"\u5e73\u884c\u8d4b\u503c","text":"<p>\u300a\u6d41\u7545\u7684Python\u300b P64</p> <pre><code>city, year, pop, chg, area = ('Tokyo', 2003, 32450, 0.66, 8014)\n</code></pre> <p>\u53e6\u5916\u4e00\u4e2a\u5f88\u4f18\u96c5\u7684\u5199\u6cd5\u5f53\u5c5e\u4e0d\u4f7f\u7528\u4e2d\u95f4\u53d8\u91cf\u4ea4\u6362\u4e24\u4e2a\u53d8\u91cf\u7684\u503c\uff1a</p> <pre><code>b, a = a, b\n</code></pre>"},{"location":"python/python/python-note/#_4","title":"\u5143\u7ec4\u62c6\u5305","text":"<p>\u5e73\u884c\u8d4b\u503c\u662f\u6700\u597d\u8fa8\u8ba4\u7684\u5143\u7ec4\u62c6\u5305\u5f62\u5f0f\u3002 \u300a\u6d41\u7545\u7684Python\u300b P65</p> <pre><code>&gt;&gt;&gt; lax_coordinates = (33.9425, -118.408056)\n&gt;&gt;&gt; latitude, longitude = lax_coordinates # \u5143\u7ec4\u62c6\u5305\n</code></pre> <p>\u5d4c\u5957\u5143\u7ec4\u62c6\u5305\uff1a</p> <pre><code>metro_areas = [\n('Tokyo','JP',36.933,(35.689722,139.691667)),\n]\nfor name, cc, pop, (latitude, longitude) in metro_areas:\nprint(name, cc, pop, latitude, longitude)\n</code></pre> <p>\u5177\u540d\u5143\u7ec4\uff1a</p> <pre><code>Card = collections.namedtuple('Card', ['rank', 'suit'])\n</code></pre>"},{"location":"python/python/python-note/#_5","title":"\u5207\u7247","text":"<p>\u4ee5\u7528 s[a:b:c]\u7684\u5f62\u5f0f\u5bf9 s \u5728 a \u548c b \u4e4b\u95f4\u4ee5 c \u4e3a\u95f4\u9694\u53d6\u503c\u3002 c \u7684\u503c\u8fd8\u53ef\u4ee5\u4e3a\u8d1f\uff0c\u8d1f\u503c\u610f\u5473\u7740\u53cd\u5411\u53d6\u503c\u3002 seq[start:stop:step]</p> <pre><code>&gt;&gt;&gt; s = 'bicycle'\n&gt;&gt;&gt; s[::3]\n'bye'\n&gt;&gt;&gt; s[::-1]\n&gt;&gt;&gt; s[::-2]\n'eccb'\n</code></pre>"},{"location":"python/python/python-note/#_6","title":"\u53d8\u91cf\u547d\u540d","text":"<pre><code>`_` \u8868\u793a\u5ffd\u7565\u7684\u5143\u7d20\uff0c\u4f46\u5f53\u9879\u76ee\u9700\u8981\u56fd\u9645\u5316\u65f6\uff0c\u63a8\u8350\u4f7f\u7528`ign(ignore)`\u4ee3\u8868\u5ffd\u7565\u7684\u5143\u7d20\uff0c\u56e0\u4e3a`python`\u4e2d\u5e38\u7528 `_` \u8868\u793a\u7ffb\u8bd1\u51fd\u6570\u3002\n</code></pre>"},{"location":"python/python/python-note/#_7","title":"\u65f6\u95f4\u3001\u65f6\u95f4\u95f4\u9694\u64cd\u4f5c","text":"<pre><code>pip install python-dateutil\n</code></pre> <p>\u83b7\u53d6\u53d8\u957f\u65f6\u95f4\u95f4\u9694 \u5982\u4e0b\u5468\u4e00\uff1a</p> <pre><code>from dateutil.relativedelta import relativedelta\nfrom datetime import datetime\nnext_monday = datetime.now() + relativedelta(weekday=0)\n</code></pre>"},{"location":"python/python/python-note/#pip-install-mysql-python","title":"pip install mysql-python","text":"<p>\u62a5\u9519\uff1a</p> <pre><code>Microsoft Visual C++ 14.0 is required\n</code></pre> <p>\u5b89\u88c5C++ Build Tools\u9700\u89816G\u7684\u786c\u76d8\u7a7a\u95f4\uff0c\u653e\u5f03\u3002\u53ef\u884c\u65b9\u6cd5\uff1a</p> <pre><code>easy_install http://www.voidspace.org.uk/python/pycrypto-2.6.1/pycrypto-2.6.1.win32-py2.7.exe\n</code></pre> <p>How do I install PyCrypto on Windows?</p>"},{"location":"python/python/python-note/#pip","title":"PIP\u6e90","text":"<ul> <li>\u5355\u6b21\u5207\u6362 pip install django -i https://pypi.douban.com/simple</li> <li>\u6c38\u4e45\u5207\u6362 \u5728 C:\\Users\\lenovo \u76ee\u5f55\u4e0b\u65b0\u5efa pip \u6587\u4ef6\u5939\uff08lenovo\u662f\u4f60\u4e3b\u673a\u5f53\u524d\u767b\u5f55\u7684\u7528\u6237\u540d\u79f0\uff09\uff0c\u6587\u4ef6\u5939\u5185\u65b0\u5efa\u6587\u4ef6 pip.ini\uff0c\u6587\u4ef6\u5185\u5bb9\uff1a</li> </ul> <pre><code>[global]\nindex-url = https://pypi.douban.com/simple\n</code></pre>"},{"location":"python/python/python-note/#_8","title":"\u7ecf\u5178\u7c7b\u3001\u65b0\u5f0f\u7c7b","text":"<p><code>python2</code>\u9ed8\u8ba4\u4e3a\u7ecf\u5178\u7c7b\uff0c\u53ea\u6709\u663e\u5f0f\u7ee7\u627fobj\u624d\u662f\u65b0\u5f0f\u7c7b\uff0c\u5176\u591a\u7ee7\u627f\u5c5e\u6027\u7684\u641c\u7d22\u987a\u5e8f\u4e3a\uff1a\u5148\u6df1\u5165\u7ee7\u627f\u6811\u5de6\u4fa7\uff0c\u518d\u8fd4\u56de\uff0c\u65e2\u6df1\u5ea6\u4f18\u5148\u641c\u7d22\u3002 <code>python3</code>\u9ed8\u8ba4\u4e3a\u65b0\u5f0f\u7c7b\uff0c\u591a\u7ee7\u627f\u5c5e\u6027\u7684\u641c\u7d22\u987a\u5e8f\u4e3a\uff1a\u5148\u6c34\u5e73\u641c\u7d22\u518d\u5411\u4e0a\u79fb\u52a8\uff0c\u65e2\u5e7f\u5ea6\u4f18\u5148\u641c\u7d22\u3002 \u300c\u65b9\u6cd5\u89e3\u6790\u987a\u5e8f\u300d\uff08Method Resolution Order\uff0c\u6216MRO\uff09</p>"},{"location":"python/python/python-note/#groupby","title":"groupby","text":"<p>Doc \u9700\u8981\u6ce8\u610f\u4e00\u70b9\uff0c\u5728\u4f7f\u7528groupby\u65b9\u6cd5\u53bb\u4e3a\u4e00\u4e2alist\u5206\u7ec4\u65f6\uff0c\u9700\u8981\u4f7f\u7528\u4e0e\u5206\u7ec4\u7528\u7684\u76f8\u540c\u7684key\u5148\u53bb\u4e3alist\u6392\u5e8f\u3002</p> <p>you are supposed to apply groupby to a list which is already sorted using the same key as groupby itself</p> <p>Python\u7248\uff1a</p> <pre><code>from itertools import groupby\nqueryset = self.filter_queryset(self.get_queryset()).order_by('category')\ndata = []\noriginal_data = sorted(self.get_serializer(queryset, many=True).data, key=lambda x: x['category'])\nfor k, g in groupby(original_data, key=lambda x: x['category']):\nrecords = list(g)\ndata.append({'category': k, 'records': records})\n</code></pre> <p>Django\u7248\uff1a</p> <pre><code>from itertools import groupby\nqueryset = self.filter_queryset(self.get_queryset()).order_by('category')\ndata = []\nfor k, g in groupby(self.get_serializer(queryset, many=True).data, key=lambda x: x['category']):\nrecords = list(g)\ndata.append({'category': k, 'records': records})\n</code></pre>"},{"location":"python/python/python-note/#jsondict","title":"\u8bfb\u53d6\u5e26\u4e2d\u6587\u7684json\u6587\u4ef6\u81f3dict","text":"<pre><code>import json\nimport codecs\nwith codecs.open('data.json', 'r', 'utf-8') as f:\ndata = json.load(f)\n</code></pre>"},{"location":"python/python/python-note/#excel","title":"excel\u8bfb\u53d6","text":"<p>\u5b89\u88c5<code>xlrd</code></p> <pre><code>pip install xlrd\n</code></pre> <p>\u8bfb\u53d6\uff1a</p> <pre><code>import xlrd\ndef excel_table_by_name(file_path, col_name_index=0, by_name=u'Sheet1'):\n\"\"\"\n    :param work_book:\n    :param col_name_index: \u8868\u5934\u5217\u540d\u6240\u5728\u884c\u7684\u7d22\u5f15\n    :param by_name: \u5de5\u4f5c\u533a\u540d\u79f0\n    :return: Excel\u8868\u683c\u4e2d\u7684\u6570\u636e\n    \"\"\"\ntry:\ntable = xlrd.open_workbook(file_path).sheet_by_name(by_name)\nrows = table.nrows  # \u884c\u6570\ncol_names = table.row_values(col_name_index)  # \u67d0\u4e00\u884c\u6570\u636e\ndata = []\nfor row_num in range(1, rows):\nrow_value = table.row_values(row_num)\nif row_value:\napp = {}\nfor i in range(len(col_names)):\napp[col_names[i]] = row_value[i]\ndata.append(app)\nreturn data\nexcept Exception as e:\nreturn None\ntables = excel_table_by_name('city_code.xlsx', 0, '\u5927\u9646\u7701\u5e02\u533a\u4e61\u9547\u5217\u8868')\nif tables:\nfor row in tables:\nprint(row['\u57ce\u5e02\u4ee3\u7801'], row['\u7701'], row['\u5e02'])\n</code></pre>"},{"location":"python/python/python-note/#listlist","title":"list\u5c5e\u4e8e\u53e6\u4e00\u4e2alist","text":"<pre><code>set(list_one).issubset(list_two)\n</code></pre>"},{"location":"python/python/python-note/#sort","title":"sort","text":"<p>\u6570\u7ec4\u7684sort\u65b9\u6cd5\u4e0d\u4f1a\u8fd4\u56de\u6392\u5e8f\u540e\u7684\u6570\u7ec4\uff0c\u4ec5\u4f1a\u5bf9\u6e90\u5bf9\u8c61\u8fdb\u884c\u6392\u5e8f\u3002</p> <pre><code>context['fieldsets'].sort(key=itemgetter('title'))\n</code></pre>"},{"location":"python/python/python-note/#anyall","title":"any\u3001all","text":""},{"location":"python/python/python-note/#re","title":"re\u6b63\u5219","text":"<pre><code>import re\ndata = '2018-05-09 10:17:23,966 [INFO]- \"OPTIONS /group/?page_size=0&amp;search=1 HTTP/1.1\" 200 0'\nm = re.match(r'^(.*)\\[(.*)]- (.*)$', data)\nprint(m.groups())\nprint(m.group(0))\nprint(m.group(1), m.group(2), m.group(3))\n</code></pre> <p>\u8f93\u51fa\uff1a</p> <pre><code>('2018-05-09 10:17:23,966 ', 'INFO', '\"OPTIONS /group/?page_size=0&amp;search=1 HTTP/1.1\" 200 0')\n2018-05-09 10:17:23,966 [INFO]- \"OPTIONS /group/?page_size=0&amp;search=1 HTTP/1.1\" 200 0\n2018-05-09 10:17:23,966  INFO \"OPTIONS /group/?page_size=0&amp;search=1 HTTP/1.1\" 200 0\n</code></pre> <pre><code>import re\ndata = 'ab23cc3dd4'\narr = re.split(r'(\\d+)', data)\nprint(arr)\n</code></pre> <p>\u8f93\u51fa\uff1a</p> <pre><code>['ab', '23', 'cc', '3', 'dd', '4', '']\n</code></pre> <ul> <li>\u8d2a\u5a6a</li> </ul>"},{"location":"python/python/python-note/#_9","title":"\u5206\u6bb5","text":""},{"location":"python/python/python-note/#_10","title":"\u622a\u53d6\u6570\u5b57","text":""},{"location":"python/python/python-note/#_11","title":"\uff08.\uff09\u8d2a\u5a6a\u5339\u914d \uff08.?\uff09\u975e\u8d2a\u5a6a\u5339\u914d","text":""},{"location":"python/python/python-note/#pythonfor","title":"Python\u591a\u5c42for\u5faa\u73af\u5d4c\u5957","text":"<pre><code>Python\u591a\u5c42for\u5faa\u73af\u5d4c\u5957\u65f6\uff0c\u5185\u5c42\u5faa\u73af\u9700\u8981\u8df3\u51fa\u5230\u6700\u5916\u5c42for\u5faa\u73af\u4e2d\uff0c\u4f7f\u7528\u65b9\u6cd5\u662f\u9664\u4e86\u6700\u5916\u5c42for\u5faa\u73af\u5916\uff0c\u6240\u6709\u7684\u5185\u5c42\u5faa\u73af\u5168\u90e8\u79fb\u52a8\u5230\u51fd\u6570\u4f53\u4e2d\uff0c\u4f7f\u7528return\u65b9\u6cd5\u8df3\u51fa\u5230\u6700\u5916\u5c42for\u5faa\u73af\u3002\ndef xxx():\nfor y in ('a', 'b', 'c'):\nfor z in ('x', 'y', 'z'):\nif z == 'z':\nreturn \nelse:\nprint('{} {} {}'.format(x, y, z))\nfor x in range(1, 3):\nxxx()\n1 a x\n1 a y\n2 a x\n2 a y\n</code></pre>"},{"location":"python/python/python-note/#list","title":"list","text":"<pre><code>list\u65b9\u6cd5\u4e2d\uff0cappend\u662f\u6dfb\u52a0item,extend\u662f\u5c06\u4e00\u4e2alist\u62fc\u63a5\u5230\u5f53\u524dlist\u4e0a\u3002\n</code></pre>"},{"location":"python/python/python-note/#sorted","title":"sorted\u51fd\u6570\u7528\u6cd5","text":"<pre><code>\u53ef\u4ee5\u4e3alist\u6216\u8005queryset\u6392\u5e8f\n\n    sorted_list = sorted(self.queryset, key=lambda x: x.time())\n    permission_list = sorted(permission_list, key=lambda x: int(x['content_type'])) \n    # \u8f6c\u6362\u4e3aint\u7c7b\u578b\u8fdb\u884c\u5bf9\u6bd4\u662f\u56e0\u4e3a\u6309\u7167str\u7c7b\u578b\u987a\u5e8f\u4e3a 1 11 12... 2 21... 3\n</code></pre>"},{"location":"python/python/python-note/#decimalformatdecimalstr","title":"\u4fee\u6539Decimal\u663e\u793a\u7cbe\u5ea6\u4f46\u4e0d\u6539\u53d8\u7c7b\u578b\uff08format\u65b9\u6cd5\u4f1a\u5c06Decimal\u6539\u53d8\u4e3astr\uff09","text":"<pre><code>    '{0:.2f}'.format(amount) # \u7c7b\u578b\u6539\u53d8\u4e3astr \u4f46\u662f\u53ef\u4ee5\u8fbe\u5230\u6539\u53d8\u663e\u793a\u683c\u5f0f\u7684\u76ee\u7684\n\n    &gt;&gt;&gt; round(14.22222223, 2)\n    14.22\n</code></pre>"},{"location":"python/python/python-note/#python","title":"Python\u4e2d\u4f7f\u7528\u5e38\u91cf","text":"<p><code>constants.py</code>\u6587\u4ef6\uff1a</p> <pre><code>class InExCategory(object):\nPurchaseCourses = 1\nBalanceRecharge = 2\nClassHourExpense = 3\nAdmissionDeduct = 4\nRecommendDeduct = 5\nBalanceWithdraw = 6\nReturnClassHour = 7\n</code></pre> <p>\u6216\u8005\u76f4\u63a5</p> <pre><code>PurchaseCourses = 1\nBalanceRecharge = 2\nClassHourExpense = 3\nAdmissionDeduct = 4\nRecommendDeduct = 5\nBalanceWithdraw = 6\nReturnClassHour = 7\n</code></pre> <p>\u4f7f\u7528\u7c7b\u662f\u4e3a\u4e86\u5f52\u7eb3\u533a\u5206\u5e38\u91cf\u7c7b\u578b</p>"},{"location":"python/python/python-note/#mateclass","title":"\u5143\u7c7b<code>mateclass</code>\u7406\u89e3","text":"<p>StackOverFlow</p>"},{"location":"python/python/python-note/#list_1","title":"\u4e24\u4e2alist\u53d6\u5dee","text":"<pre><code>\u65b9\u6cd51\uff1a\ns = set(temp2)\ntemp3 = [x for x in temp1 if x not in s]\n\u65b9\u6cd52\uff1a\nlist(set(temp1) - set(temp2))\n</code></pre> <p>Get difference between two lists</p>"},{"location":"python/python/python-note/#_12","title":"\u4ee3\u7801\u4fdd\u62a4","text":"<p>\u4f7f\u7528<code>__pycache__</code>\u6587\u4ef6\u5939\u4e0b\u5bf9\u5e94\u7684<code>pyc</code>\u6587\u4ef6\u91cd\u547d\u540d(<code>views.cpython-35.pyc</code> -&gt; <code>views.pyc</code>)\u540e\u66ff\u4ee3\u539f\u5148\u7684<code>py</code>\u6587\u4ef6\u5373\u53ef\u3002</p> <pre><code>python -m py_compile /path/to/\u9700\u8981\u751f\u6210.pyc\u7684\u811a\u672c.py #\u82e5\u6279\u91cf\u5904\u7406.py\u6587\u4ef6\n#\u5219\u66ff\u6362\u4e3a/path/to/{\u9700\u8981\u751f\u6210.pyc\u7684\u811a\u672c1,\u811a\u672c2,...}.py\n#\u6216\u8005/path/to/\nimport py_compile\npy_compile.compile(r'/path/to/\u9700\u8981\u751f\u6210.pyc\u7684\u811a\u672c.py') #\u540c\u6837\u4e5f\u53ef\u4ee5\u662f\u5305\u542b.py\u6587\u4ef6\u7684\u76ee\u5f55\u8def\u5f84\n#\u6b64\u5904\u5c3d\u53ef\u80fd\u4f7f\u7528raw\u5b57\u7b26\u4e32\uff0c\u4ece\u800c\u907f\u514d\u8f6c\u4e49\u7684\u9ebb\u70e6\u3002\u6bd4\u5982\uff0c\u8fd9\u91cc\u4e0d\u52a0\u201cr\u201d\u7684\u8bdd\uff0c\u4f60\u5c31\u5f97\u5bf9\u659c\u6760\u8fdb\u884c\u8f6c\u4e49\n</code></pre>"},{"location":"python/python/python-note/#migrate","title":"\u4fee\u6539<code>migrate</code>\u8bb0\u5f55","text":"<pre><code>delete from tisanems.django_migrations \nwhere id=19\nlimit 1\n</code></pre>"},{"location":"python/python/python-note/#mysqluniquetrue","title":"<code>mysql</code>\u65b0\u589e<code>unique=True</code>\u9519\u8bef","text":"<pre><code>Q:`django.db.utils.OperationalError: (1061, \"Duplicate key name 'storage_allotapply_no_eb237ab5_uniq'\")`\n\nA:`mysql&gt; DROP INDEX [index_name] ON [table_name];`\u65e2\n\n    use dbname;\n    DROP INDEX storage_allotapply_no_eb237ab5_uniq ON storage_allotapply;\n    # \u8981\u4e00\u6b21DROP\u5b8c\u6240\u6709\u7684\n</code></pre> <p>Django database migration error: duplicate key</p>"},{"location":"python/python/python-note/#keyerrorkey","title":"KeyError\u83b7\u53d6\u54ea\u4e2akey\u9519\u8bef","text":"<pre><code>try:\nexcept KeyError as e:\nreturn error_response(1, '\u83b7\u53d6\u53c2\u6570{}\u5931\u8d25'.format(e.args[0]))\n</code></pre>"},{"location":"python/python/python-note/#glossary","title":"Glossary \u672f\u8bed\u8868","text":"<ul> <li> <p>BDFL Benevolent Dictator For Life \u7684\u7b80\u79f0\uff0c\u610f\u4e3a\u201c\u4ec1\u6148\u7684\u72ec\u88c1\u8005\u201d\u3002</p> </li> <li> <p>CRUD Create\u3001 Read\u3001 Update\u3001 Delete \u7684\u9996\u5b57\u6bcd\u7f29\u5199\uff0c\u8fd9\u662f\u5b58\u50a8\u8bb0\u5f55\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684\u56db\u79cd\u57fa \u672c\u64cd\u4f5c\u3002</p> </li> <li> <p>DRY Don't Repeat Yourself\uff08\u4e0d\u8981\u81ea\u6211\u91cd\u590d\uff09\u7684\u7f29\u5199\uff0c\u4e00\u79cd\u8f6f\u4ef6\u5de5\u7a0b\u539f\u5219\u3002</p> </li> <li> <p>dunder \u9996\u5c3e\u6709\u4e24\u6761\u4e0b\u5212\u7ebf\u7684\u7279\u6b8a\u65b9\u6cd5\u548c\u5c5e\u6027\u7684\u7b80\u6d01\u8bfb\u6cd5\uff08\u5373\u628a len \u8bfb\u6210\u201cdunder len\u201d\uff09\u3002</p> </li> <li> <p>EAFP \u201cit's easier to ask forgiveness than permission\u201d\uff08\u53d6\u5f97\u539f\u8c05\u6bd4\u83b7\u5f97\u8bb8\u53ef\u5bb9\u6613\uff09\u7684\u9996\u5b57\u6bcd\u7f29 \u5199\u3002\u4eba\u4eec\u8ba4\u4e3a\u8fd9\u53e5\u8bdd\u662f\u8ba1\u7b97\u673a\u5148\u9a71 Grace Hopper \u8bf4\u7684\uff0c Python\u7a0b\u5e8f\u5458\u4f7f\u7528\u8fd9\u4e2a\u7f29\u5199\u6307\u4ee3 \u4e00\u79cd\u52a8\u6001\u7f16\u7a0b\u65b9\u5f0f\uff0c\u4f8b\u5982\u8bbf\u95ee\u5c5e\u6027\u524d\u4e0d\u6d4b\u8bd5\u6709\u6ca1\u6709\u5c5e\u6027\uff0c\u5982\u679c\u6ca1\u6709\u5c31\u6355\u83b7\u5f02\u5e38\u3002 hasattr \u51fd\u6570\u7684\u6587\u6863\u5b57\u7b26\u4e32\u662f\u8fd9\u6837\u63cf\u8ff0\u5b83\u7684\u5de5\u4f5c\u65b9\u5f0f\u7684\uff1a \u201c\u8c03\u7528 getattr(object, name)\uff0c\u7136\u540e\u6355\u83b7 AttributeError \u5f02\u5e38\u3002</p> </li> <li> <p>LBYL \u4e09\u601d\u800c\u540e\u884c\uff08look before you leap\uff09\u3002\u8fd9\u79cd\u7f16\u7a0b\u98ce\u683c\u5728\u8c03\u7528\u51fd\u6570\u6216\u67e5\u627e\u5c5e\u6027\u6216\u952e \u4e4b\u524d\u663e\u5f0f\u6d4b\u8bd5\u524d\u63d0\u6761\u4ef6\u3002\u4e0e EAFP \u98ce\u683c\u76f8\u53cd\uff0c\u8fd9\u79cd\u98ce\u683c\u7684\u7279\u70b9\u662f\u4ee3\u7801\u4e2d\u6709\u5f88\u591a if \u8bed \u53e5\u3002\u5728\u591a\u7ebf\u7a0b\u73af\u5883\u4e2d\uff0c LBYL\u98ce\u683c\u53ef\u80fd\u4f1a\u5728\u201c\u68c0\u67e5\u201d\u548c\u201c\u884c\u4e8b\u201d\u7684\u7a7a\u5f53\u5f15\u5165\u6761\u4ef6\u7ade\u4e89\u3002\u4f8b \u5982\uff0c\u5bf9 if key in mapping: return mapping[key] \u8fd9\u6bb5\u4ee3\u7801\u6765\u8bf4\uff0c\u5982\u679c\u5728\u6d4b\u8bd5 \u4e4b\u540e\uff0c\u4f46\u5728\u67e5\u627e\u4e4b\u524d\uff0c\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u4ece\u6620\u5c04\u4e2d\u5220\u9664\u4e86\u90a3\u4e2a\u952e\uff0c\u90a3\u4e48\u8fd9\u6bb5\u4ee3\u7801\u5c31\u4f1a\u5931\u8d25\u3002 \u8fd9\u4e2a\u95ee\u9898\u53ef\u4ee5\u4f7f\u7528\u9501\u6216\u8005 EAFP \u98ce\u683c\u89e3\u51b3\u3002</p> </li> <li> <p>ORM Object-Relational Mapper\uff08\u5bf9\u8c61\u5173\u7cfb\u6620\u5c04\u5668\uff09\u7684\u7f29\u5199\uff0c\u901a\u8fc7\u8fd9\u79cd API \u53ef\u4ee5\u4f7f\u7528 Python \u7c7b\u548c\u5bf9\u8c61\u8bbf\u95ee\u6570\u636e\u5e93\u4e2d\u7684\u8868\u548c\u8bb0\u5f55\uff0c\u800c\u4e14\u8c03\u7528\u65b9\u6cd5\u53ef\u4ee5\u6267\u884c\u6570\u636e\u5e93\u64cd\u4f5c\u3002 SQLAlchemy\u662f \u6d41\u884c\u7684\u72ec\u7acb Python ORM\uff0c Django \u548c Web2py\u81ea\u5e26\u4e86 ORM\u3002</p> </li> <li> <p>PyPI Python \u5305\u7d22\u5f15\uff08https://pypi.python.org/\uff09\uff0c\u91cc\u9762\u6709\u8d85\u8fc7 60 000 \u4e2a\u5305\u53ef\u7528\u3002\u4e5f\u53eb\u5976\u916a\u5e97 \uff08\u53c2\u89c1\u5976\u916a\u5e97\u8bcd\u6761\uff09\u3002\u4e3a\u4e86\u9632\u6b62\u4e0e PyPy \u6df7\u6dc6\uff0c PyPI \u5e94\u8be5\u8bfb\u4f5c\u201cpie-P-eye\u201d\u3002</p> </li> <li> <p>YAGNI You Ain't Gonna Need It\uff08\u4f60\u4e0d\u9700\u8981\u8fd9\u4e2a\uff09\u7684\u9996\u5b57\u6bcd\u7f29\u5199\uff0c\u8fd9\u4e2a\u53e3\u53f7\u7684\u610f\u601d\u662f\uff0c\u6839\u636e\u5bf9 \u672a\u6765\u9700\u6c42\u7684\u9884\u6d4b\uff0c\u4e0d\u8981\u5b9e\u73b0\u975e\u7acb\u5373\u9700\u8981\u7684\u529f\u80fd\u3002</p> </li> <li> <p>monkey patching \u7334\u5b50\u8865\u4e01 \u5728\u8fd0\u884c\u65f6\u52a8\u6001\u4fee\u6539\u6a21\u5757\u3001\u7c7b\u6216\u51fd\u6570\uff0c\u901a\u5e38\u662f\u6dfb\u52a0\u529f\u80fd\u6216\u4fee\u6b63\u7f3a\u9677\u3002\u7334\u5b50\u8865\u4e01\u5728\u5185\u5b58\u4e2d \u53d1\u6325\u4f5c\u7528\uff0c\u4e0d\u4f1a\u4fee\u6539\u6e90\u7801\uff0c\u56e0\u6b64\u53ea\u5bf9\u5f53\u524d\u8fd0\u884c\u7684\u7a0b\u5e8f\u5b9e\u4f8b\u6709\u6548\u3002\u56e0\u4e3a\u7334\u5b50\u8865\u4e01\u7834\u574f\u4e86\u5c01 \u88c5\uff0c\u800c\u4e14\u5bb9\u6613\u5bfc\u81f4\u7a0b\u5e8f\u4e0e\u8865\u4e01\u4ee3\u7801\u7684\u5b9e\u73b0\u7ec6\u8282\u7d27\u5bc6\u8026\u5408\uff0c\u6240\u4ee5\u88ab\u89c6\u4e3a\u4e34\u65f6\u7684\u53d8\u901a\u65b9\u6848\uff0c\u4e0d \u662f\u96c6\u6210\u4ee3\u7801\u7684\u63a8\u8350\u65b9\u5f0f</p> </li> <li> <p>mixin method \u6df7\u5165\u65b9\u6cd5 \u62bd\u8c61\u57fa\u7c7b\u6216\u6df7\u5165\u7c7b\u4e2d\u65b9\u6cd5\u7684\u5177\u4f53\u5b9e\u73b0\u3002</p> </li> <li> <p>mixin class \u6df7\u5165\u7c7b \u7528\u4e8e\u968f\u7740\u591a\u91cd\u7ee7\u627f\u7c7b\u6811\u4e2d\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u7c7b\u4e00\u8d77\u6269\u5c55\u7684\u7c7b\u3002\u6df7\u5165\u7c7b\u7edd\u4e0d\u80fd\u5b9e\u4f8b\u5316\uff0c\u5b83\u7684 \u5177\u4f53\u5b50\u7c7b\u4e5f\u5e94\u8be5\u662f\u5176\u4ed6\u975e\u6df7\u5165\u7c7b\u7684\u5b50\u7c7b\u3002</p> </li> <li> <p>duck typing \u9e2d\u5b50\u7c7b\u578b \u591a\u6001\u7684\u4e00\u79cd\u5f62\u5f0f\uff0c\u5728\u8fd9\u79cd\u5f62\u5f0f\u4e2d\uff0c\u4e0d\u7ba1\u5bf9\u8c61\u5c5e\u4e8e\u54ea\u4e2a\u7c7b\uff0c\u4e5f\u4e0d\u7ba1\u58f0\u660e\u7684\u5177\u4f53\u63a5\u53e3\u662f\u4ec0 \u4e48\uff0c\u53ea\u8981\u5bf9\u8c61\u5b9e\u73b0\u4e86\u76f8\u5e94\u7684\u65b9\u6cd5\uff0c\u51fd\u6570\u5c31\u53ef\u4ee5\u5728\u5bf9\u8c61\u4e0a\u6267\u884c\u64cd\u4f5c\u3002</p> </li> <li> <p>decorator \u88c5\u9970\u5668 \u4e00\u4e2a\u53ef\u8c03\u7528\u7684\u5bf9\u8c61 A\uff0c\u8fd4\u56de\u53e6\u4e00\u4e2a\u53ef\u8c03\u7528\u7684\u5bf9\u8c61 B\uff0c\u5728\u53ef\u8c03\u7528\u7684\u5bf9\u8c61 C \u7684\u5b9a\u4e49\u4f53\u4e4b\u524d \u4f7f\u7528\u53e5\u6cd5 @A \u8c03\u7528\u3002 Python \u89e3\u91ca\u5668\u8bfb\u53d6\u8fd9\u6837\u7684\u4ee3\u7801\u65f6\uff0c\u4f1a\u8c03\u7528 A(C)\uff0c\u628a\u8fd4\u56de\u7684 B \u7ed1\u5b9a\u7ed9\u4e4b \u524d\u8d4b\u4e88 C \u7684\u53d8\u91cf\uff0c\u4e5f\u5c31\u662f\u628a C \u7684\u5b9a\u4e49\u4f53\u6362\u6210 B\u3002\u5982\u679c\u76ee\u6807\u53ef\u8c03\u7528\u5bf9\u8c61 C \u662f\u51fd\u6570\uff0c\u90a3\u4e48 A \u662f \u51fd\u6570\u88c5\u9970\u5668\uff1b\u5982\u679c C \u662f\u7c7b\uff0c\u90a3\u4e48 A \u662f\u7c7b\u88c5\u9970\u5668\u3002</p> </li> <li> <p>IDLE An Integrated Development Environment for Python. IDLE is a basic editor and interpreter environment which ships with the standard distribution of Python.</p> </li> <li> <p>Zen of Python Listing of Python design principles and philo</p> </li> </ul> <p>sophies that are helpful in understanding and using the language. The listing can be found by typing \u201cimport this\u201d at the interactive prompt.</p> <pre><code>The Zen of Python, by Tim Peters\n\nBeautiful is better than ugly.\nExplicit is better than implicit.\nSimple is better than complex.\nComplex is better than complicated.\nFlat is better than nested.\nSparse is better than dense.\nReadability counts.\nSpecial cases aren't special enough to break the rules.\nAlthough practicality beats purity.\nErrors should never pass silently.\nUnless explicitly silenced.\nIn the face of ambiguity, refuse the temptation to guess.\nThere should be one-- and preferably only one --obvious way to do it.\nAlthough that way may not be obvious at first unless you're Dutch.\nNow is better than never.\nAlthough never is often better than *right* now.\nIf the implementation is hard to explain, it's a bad idea.\nIf the implementation is easy to explain, it may be a good idea.\nNamespaces are one honking great idea -- let's do more of those!\n</code></pre>"},{"location":"python/python/python-venv/","title":"Virtualenv","text":""},{"location":"python/python/python-venv/#python2","title":"Python2:","text":"<ul> <li>pip install virtual</li> <li>virtualenv environment #\u65b0\u5efa\u865a\u62df\u7a7a\u95f4</li> <li>virtualenv environment --python=python3.5 #\u6307\u5b9apython\u7248\u672c</li> </ul>"},{"location":"python/python/python-venv/#python36","title":"Python36\u4ee5\u4e0a:","text":"<ul> <li>python -m venv venv_name</li> </ul>"},{"location":"python/python/python-venv/#_1","title":"\u6fc0\u6d3b\u865a\u62df\u73af\u5883\uff1a","text":"<ul> <li>venv\\Scripts\\activate.bat # windows\u4e0b\u6fc0\u6d3b\u865a\u62df\u73af\u5883</li> <li>source environment/bin/activate #linux\u4e0b\u6fc0\u6d3b\u865a\u62df\u73af\u5883</li> </ul>"},{"location":"python/python/python-venv/#_2","title":"\u5173\u95ed\u865a\u62df\u73af\u5883","text":"<ul> <li>deactivate</li> </ul> <p>\u5b98\u65b9\u6587\u6863</p>"},{"location":"python/python/pyupdater/","title":"Pyupdater\u81ea\u52a8\u66f4\u65b0","text":""},{"location":"python/python/pyupdater/#_1","title":"\u5b89\u88c5","text":"<p><code>pip install pyupdater==4.0</code></p>"},{"location":"python/python/pyupdater/#_2","title":"\u4f7f\u7528","text":""},{"location":"python/python/pyupdater/#_3","title":"\u5176\u4ed6\u673a\u5668\u4e0a\u6267\u884c","text":"<p>\u5728\u5176\u4ed6\u673a\u5668\u4e0a\u751f\u6210\u5bc6\u94a5\uff0c\u5c06\u751f\u6210\u7684\u5bc6\u94a5\u653e\u7f6e\u5728\u4f7f\u7528pyinstaller\u7684\u9879\u76ee\u7684\u6839\u76ee\u5f55\u3002 <pre><code>pyupdater keys -c\n</code></pre></p>"},{"location":"python/python/pyupdater/#_4","title":"\u5f00\u53d1\u673a\u5668\u4e0a\u6267\u884c","text":""},{"location":"python/python/pyupdater/#_5","title":"\u6e05\u7a7a\u914d\u7f6e\uff1a","text":"<pre><code>pyupdater clean\n</code></pre>"},{"location":"python/python/pyupdater/#pyupdater","title":"\u521d\u59cb\u5316pyupdater","text":"<p><code>pyupdater init</code></p> <p>\u8f93\u5165\u7684\u5e94\u7528\u540d\u79f0\u8981\u548c\u751f\u6210\u79d8\u94a5\u65f6\u7684\u540d\u79f0\u4e00\u81f4\uff0c\u6267\u884c\u5b8c\u6210\u540e\uff0c\u4f1a\u5728\u9879\u76ee\u7684\u6839\u76ee\u5f55\u751f\u6210\u4e00\u4e2aclient_config.py</p> <p>\u793a\u4f8b\uff1a <pre><code>(venv) D:\\python_workspace\\AdbKit&gt;pyupdater init\n[INFO] PyUpdater 4.0\n192 INFO: PyUpdater 4.0\nPlease enter app name\n[DEFAULT] -&gt; PyUpdater App\nPress Enter To Use Default\n--&gt; TestKit\nYou entered TestKit, is this correct?\n[N/y]?y\nPlease enter your name or company name\n[DEFAULT] -&gt; PyUpdater App\nPress Enter To Use Default\n--&gt; yinkanghong\nYou entered yinkanghong, is this correct?\n[N/y]?y\nEnter a url to ping for updates. - No Default Available\n--&gt; http://10.241.132.118:5080/static/testkit\nYou entered http://10.241.132.118:5080/static/testkit, is this correct?\n[N/y]?y\nWould you like to add another url for backup?\n[N/y]?n\nWould you like to enable patch updates?\n[Y/n]?y\nPlease enter the path to where pyupdater will write the client_config.py file. You'll need to import this file to initialize the update process. \nExamples:\n\nlib/utils, src/lib, src.\n\nLeave blank to use the current directory\n[DEFAULT] -&gt; AdbKit\nPress Enter To Use Default\n--&gt;\nYou entered AdbKit, is this correct?\n[N/y]?y\n[INFO] Creating pyu-data dir...\n27219 INFO: Creating pyu-data dir...\n27220 DEBUG: Creating config dir\n27220 DEBUG: Config Dir: D:\\python_workspace\\AdbKit\\.pyupdater\n27220 DEBUG: Config DB: D:\\python_workspace\\AdbKit\\.pyupdater\\config.pyu\n27220 DEBUG: Config Dir: D:\\python_workspace\\AdbKit\\.pyupdater\n27221 DEBUG: Config DB: D:\\python_workspace\\AdbKit\\.pyupdater\\config.pyu\n27221 DEBUG: Config Dir: D:\\python_workspace\\AdbKit\\.pyupdater\n27221 DEBUG: Config DB: D:\\python_workspace\\AdbKit\\.pyupdater\\config.pyu\n[INFO] Creating dir: D:\\python_workspace\\AdbKit\\pyu-data\\new\n27221 INFO: Creating dir: D:\\python_workspace\\AdbKit\\pyu-data\\new\n[INFO] Creating dir: D:\\python_workspace\\AdbKit\\pyu-data\\deploy\n27221 INFO: Creating dir: D:\\python_workspace\\AdbKit\\pyu-data\\deploy\n27239 DEBUG: Saving Config\n27239 DEBUG: Syncing db to filesystem\n27240 DEBUG: Config saved\n27240 DEBUG: *** Keypack data is None ***\n27240 DEBUG: Writing client_config.py\n27240 DEBUG: Adding PUBLIC_KEY to client_config.py\n27241 DEBUG: Adding APP_NAME to client_config.py\n27241 DEBUG: Adding COMPANY_NAME to client_config.py\n27241 DEBUG: Adding HTTP_TIMEOUT to cilent_config.py\n27242 DEBUG: Adding MAX_DOWNLOAD_RETRIES to client_config.py\n27242 DEBUG: Adding UPDATE_URLS to client_config.py\n27242 DEBUG: Wrote client config\n[INFO] Setup complete\n27242 INFO: Setup complete\n</code></pre></p>"},{"location":"python/python/pyupdater/#_6","title":"\u5bfc\u5165\u79d8\u94a5","text":"<p><code>pyupdater keys --import</code> \u6267\u884c\u5b8c\u6210\u540e\uff0cclient_config.py \u4e2dPUBLIC_KEY\u5c06\u6709\u503c</p>"},{"location":"python/python/pyupdater/#spec","title":"\u751f\u6210spec\u6587\u4ef6","text":"<p>pyinstaller\u7684spec\u6587\u4ef6\u548cpyupdater\u4e0d\u5171\u7528 pyupdater\u9700\u8981\u91cd\u65b0\u751f\u6210\uff0c\u4e0d\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u4e4b\u524dpyinstaller\u7684\u3002</p> <p><pre><code>pyupdater make-spec --add-data \"adb;adb\" --add-data \"autotest;autotest\" --add-data \"common;common\" --add-data \"scrcpy;sc\nrcpy\"  --add-data \"templates;templates\"  --add-data \"static;static\" --add-data \"scrcpy-win64-v1.24;scrcpy-win64-v1.24\" -w adb_kit.py\n</code></pre> \u5c06\u5728\u6839\u76ee\u5f55\u751f\u6210\u4e00\u4e2awin.spec\u6587\u4ef6\uff0c\u5176\u4e2dwin\u4e3a\u5e73\u53f0\u540d\u79f0\uff0c\u6309\u5e73\u53f0\u4f1a\u81ea\u52a8\u6539\u53d8\u3002</p>"},{"location":"python/python/pyupdater/#_7","title":"\u6253\u5305","text":"<p><pre><code>pyupdater build --app-version=1.0.0 win.spec\n</code></pre> \u5b8c\u6210\u540e\u5c06\u5728 pyu-data/new \u76ee\u5f55\u4e2d\u770b\u5230\u6253\u5305\u5b8c\u6210\u7684\u4ea7\u7269</p>"},{"location":"python/python/pyupdater/#1","title":"\u9519\u8bef1","text":"<p>Q: FileNotFoundError: [Errno 2] No such file or directory: 'TestKit\\win.exe.manifest' A: https://github.com/Digital-Sapphire/PyUpdater/issues/304 \u5728 win.spec \u4e2d \u5728EXE\u914d\u7f6e\u91cc\u6dfb\u52a0 embed_manifest=False, <pre><code>exe = EXE(\n    pyz,\n    a.scripts,\n    [],\n    exclude_binaries=True,\n    name='win',\n    debug=False,\n    bootloader_ignore_signals=False,\n    strip=False,\n    upx=True,\n    console=False,\n    disable_windowed_traceback=False,\n    argv_emulation=False,\n    target_arch=None,\n    codesign_identity=None,\n    entitlements_file=None,\n    embed_manifest=False,\n)\n</code></pre></p>"},{"location":"python/python/pyupdater/#2","title":"\u9519\u8bef2","text":"<p>Q: FileNotFoundError: [WinError 3] \u7cfb\u7edf\u627e\u4e0d\u5230\u6307\u5b9a\u7684\u8def\u5f84\u3002: 'win'</p>"},{"location":"python/python/pyupdater/#_8","title":"\u7b7e\u540d","text":"<p><pre><code>pyupdater pkg --process --sign\n</code></pre> \u7b7e\u540d\u540e\uff0c\u4ea7\u7269\u5c06\u4ece pyu-data/new \u76ee\u5f55\u79fb\u52a8\u81f3 pyu-data/deploy \u76ee\u5f55\u3002</p>"},{"location":"python/python/pyupdater/#1_1","title":"\u9519\u8bef1","text":"<p>Q: AttributeError: 'LegacyVersion' object has no attribute 'major' A: pip install dsdev-utils==1.0.5 \u5b89\u88c5\u6307\u5b9a\u7248\u672c\u5373\u53ef</p> <p>https://github.com/Digital-Sapphire/PyUpdater/issues/299</p>"},{"location":"python/python/pywebview/","title":"\u4ecb\u7ecd","text":"<p>Pywebview\u662f\u4f7f\u7528flask\u4f5c\u4e3a\u540e\u7aef\u3001webview\u4f5c\u4e3a\u524d\u7aef\u7684\u5ba2\u6237\u7aef\u8f6f\u4ef6\u5f00\u53d1\u5de5\u5177\uff0c\u524d\u7aef\u53ef\u6309\u5b9e\u9645\u60c5\u51b5\u9009\u62e9html\u6216\u8005vue\u3001react\u4e00\u7c7b\u7684\u5f00\u53d1\u8bed\u8a00\u3002 \u524d\u7aef\u548c\u540e\u7aef\u7684\u6570\u636e\u4ea4\u4e92\u63d0\u4f9b\u4e86\u4e24\u79cd\u65b9\u5f0f\uff0c\u5206\u522b\u4e3aapi\u63a5\u53e3\u548cjs bridge\u3002</p>"},{"location":"python/python/pywebview/#_2","title":"\u524d\u7aef\u8d44\u6e90","text":"<p>\u5c06\u524d\u7aef\u6253\u5305\u7684\u8d44\u6e90\uff0cindex.html\u6587\u4ef6\u653e\u4e8e templates \u76ee\u5f55\u4e0b\uff0c\u5176\u4f59\u6587\u4ef6\u653e\u5728 static \u76ee\u5f55\u4e0b\u3002 \u5ba2\u6237\u7aef\u6253\u5f00\u540e\u9996\u9875\u76f4\u63a5\u6e32\u67d3index.html <pre><code>@app.route('/', methods=['GET'])\ndef home():\n    return render_template('index.html')\n</code></pre></p> <p>\u914d\u7f6estatic\u76ee\u5f55\u7684\u9759\u6001\u6587\u4ef6\u4f3a\u670d\uff1a <pre><code>app = Flask(__name__, static_url_path='/static', static_folder='static', template_folder='./templates')\n</code></pre></p> <p>\u524d\u7aef\u6253\u5305\u65f6\u914d\u7f6e\u6587\u4ef6\u7684\u8def\u7531\u524d\u7f00\u4e3astatic\uff0c\u4ee5vue3+vite\u4e3a\u4f8b: <pre><code>import { defineConfig } from 'vite'\nimport vue from '@vitejs/plugin-vue'\n// https://vitejs.dev/config/\nexport default defineConfig({\nplugins: [vue()],\n  // \u8def\u7531\u524d\u7f00\n  base: \"/static\"\n})\n</code></pre></p>"},{"location":"python/python/pywebview/#_3","title":"\u4e8c\u6b21\u5f00\u53d1","text":""},{"location":"python/python/pywebview/#web","title":"\u4fee\u6539web\u7aef\u53e3","text":"<pre><code>start -&gt;\n\nwindow._initialize(guilib, multiprocessing, http_server)\nself.real_url = resolve_url(self.original_url, self._is_http_server)\nurl = get_wsgi_server(_path_apps[path])\nport = _get_random_port()\n</code></pre>"},{"location":"python/python/rw-excel/","title":"python\u8bfb\u5199Excel","text":""},{"location":"python/python/rw-excel/#openpyxlexcel","title":"openpyxl\u8bfb\u5199Excel","text":""},{"location":"python/python/rw-excel/#excel","title":"\u8bfb\u53d6Excel\u5185\u5bb9","text":"<pre><code>from openpyxl import load_workbook\nwb = load_workbook(filename='test.xlsx')\nws = wb['Sheet1']\nfor row in ws.rows:\nprint(row\uff0c row[0].value)\n</code></pre> <p>\u82e5\u60f3\u6309\u884c\u6807\u8bfb\u53d6\uff1a</p> <pre><code>from openpyxl import load_workbook\nwb = load_workbook(filename='test.xlsx')\nws = wb['Sheet1']\nrows = list(ws.rows)\nfor index in range(start, end):\nrow = rows[index]\n</code></pre>"},{"location":"python/python/rw-excel/#excel_1","title":"\u5185\u5bb9\u5199\u5165Excel","text":"<pre><code>from openpyxl import load_workbook\nwb = load_workbook(filename='test.xlsx')\nws = wb['Sheet1']\nws.cell(row=1, column=1).value = 'new value'\nwb.save('new_test.xlsx')\nwb.close()\n</code></pre>"},{"location":"python/python/rw-excel/#xlrdxlwtexcel","title":"xlrd\u3001xlwt\u8bfb\u5199Excel","text":""},{"location":"python/python/rw-excel/#excel_2","title":"\u8bfb\u53d6Excel\u5185\u5bb9","text":"<p>\u8bfb\u53d6excel\u4f7f\u7528\u5e93xlrd\uff0c\u76f4\u63a5pip\u5b89\u88c5\u5373\u53ef\uff0c\u793a\u4f8b\u4ee3\u7801\uff1a</p> <pre><code>import xlrd\ndata = xlrd.open_workbook('text.xls')\ndef excel_table_by_name(col_name_index=0, by_name=u'Sheet1'):\n\"\"\"\n    \u6839\u636e\u540d\u79f0\u83b7\u53d6Excel\u8868\u683c\u4e2d\u7684\u6570\u636e\n    :param col_name_index: \u8868\u5934\u5217\u540d\u6240\u5728\u884c\u7684\u7d22\u5f15\n    :param by_name: Sheet\u540d\u79f0\n    :return: \n    \"\"\"\ntry:\ntable = data.sheet_by_name(by_name)\nrows = table.nrows  # \u884c\u6570\ncol_names = table.row_values(col_name_index)  # \u67d0\u4e00\u884c\u6570\u636e\nlst = []\nfor row_num in range(1, rows):\nrow = table.row_values(row_num)\nif row:\napp = {}\nfor i in range(len(col_names)):\napp[col_names[i]] = row[i]\nlst.append(app)\nreturn lst\nexcept Exception as e:\nreturn None\ntables = excel_table_by_name(0, 'Sheet1')\nif tables:\nfor row in tables:\nprint(row['\u540d\u79f0'])\n</code></pre> <p>\u4f7f\u7528xlrd\u8bfb\u53d6\u7684\u884c\u4e2d\u5305\u542b\u65e5\u671f\u65f6\u95f4\u65f6\uff0c\u9700\u8981\u8fdb\u884c\u7279\u6b8a\u8f6c\u5316\uff1a</p> <pre><code>from datetime import datetime\ntables = excel_table_by_name(0, 'Sheet1')\nif tables:\nfor row in tables:\ndate_values = xlrd.xldate_as_tuple(row['\u65f6\u95f4'], data.datemode)\nprint(date_values, type(date_values))\nprint(datetime(*date_values))\n</code></pre>"},{"location":"python/python/rw-excel/#excel_3","title":"\u5185\u5bb9\u5199\u5165Excel","text":"<p><code>xlrd</code>\u5e93\u5bf9\u5e94\u6709\u4e00\u4e2a<code>xlwt</code>\u5e93\uff0c\u652f\u6301\u5199\u5165\u5185\u5bb9\u5230Excel\u3002\u5f53\u8bfb\u53d6\u548c\u5199\u5165\u7684\u662f\u540c\u4e00\u4e2aExcel\u6587\u4ef6\u65f6\uff0c\u9700\u8981\u5bf9\u8bfb\u53d6\u7684Excel\u6587\u4ef6\u8fdb\u884c\u62f7\u8d1d\uff0c\u7136\u540e\u5c06\u53d8\u66f4\u7684\u5185\u5bb9\u5199\u5165\u62f7\u8d1d\u7684Excel\u6587\u4ef6\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>from xlutils.copy import copy\nfrom xlrd import open_workbook\nrb = open_workbook('test.xlsx')\nwb = copy(rb)\nw_sheet = wb.get_sheet(0)\nw_sheet.write(1, 1, 'test')\nwb.save('new_test.xlsx')\n</code></pre> <p>\u4f46\u662f<code>xlwt</code>\u6700\u591a\u53ef\u5199\u516565500\u884c\u6570\u636e\u3002</p> <p>writing-to-existing-workbook-using-xlwt</p>"},{"location":"python/python/sf-express/","title":"\u987a\u4e30\u4e30\u6865\u5bf9\u63a5\u7b14\u8bb0","text":""},{"location":"python/python/sf-express/#_2","title":"\u4e0b\u5355\u3001\u7b5b\u5355\u3001\u8def\u7531\u67e5\u8be2\u3001\u8fd0\u5355\u6253\u5370","text":"<p><code>city_code.json</code>\uff08\u70b9\u6211\u4e0b\u8f7d\uff09</p> <pre><code>import os\nimport json\nimport codecs\nimport base64\nimport requests\nimport hashlib\nfrom xml.etree import ElementTree\nfrom xml.etree.ElementTree import Element, SubElement\nfrom django.conf import settings\nfrom user.models import Image\nfrom django.core.files.base import ContentFile\n# logger\nimport logging\nlogger = logging.getLogger(\"info\")\nclass Singleton(type):\ndef __init__(cls, name, bases, dict):\nsuper(Singleton, cls).__init__(name, bases, dict)\ncls.instance = None\ndef __call__(cls, *args, **kw):\nif cls.instance is None:\ncls.instance = super(Singleton, cls).__call__(*args, **kw)\nreturn cls.instance\nclass SF(metaclass=Singleton):\ndomain = 'https://bsp-oisp.sf-express.com/bsp-oisp/sfexpressService'\nclient_code = ''\ncheck_word = ''\ncity_data = None\ndef call_service(self, xml):\n# \u62fc\u63a5\u6821\u9a8c\u7801\ncombine_str = xml + self.check_word\n# md5\nmd5 = hashlib.md5()\nmd5.update(combine_str.encode('utf-8'))\nmd5_str = md5.digest()\n# base64\nverify_code = base64.b64encode(md5_str).decode('utf-8')\n# call service\ndata = {\"xml\": xml, \"verifyCode\": verify_code}\nresponse = requests.post(self.domain, data=data)\nreturn response\ndef order_create(self, order_id, month_card, province, city, district, detailed_address, company, contact, tel,\npaster, packet):\n\"\"\"\n            \u5feb\u901f\u4e0b\u5355\n            \u8fd4\u56de\u53c2\u6570\u4f9d\u6b21\u4e3a \u53d1\u8d27\u72b6\u6001 \u5feb\u9012\u5355\u53f7 \u9519\u8bef\u4fe1\u606f\n        \"\"\"\nroot = Element('Request', service='OrderService', lang=\"zh-CN\")\nhead = SubElement(root, 'Head')\nhead.text = self.client_code\nbody = SubElement(root, 'Body')\norder_attributes = {\n'orderid': order_id,\n'is_gen_bill_no': '1',\n'express_type': '2',\n# 'j_province': '\u6c5f\u82cf\u7701',\n# 'j_city': '\u5357\u4eac\u5e02',\n# 'j_company': '\u96e8\u82b1\u53f0\u533a',\n'j_address': '\u8f6f\u4ef6\u8c37\u79d1\u521b\u57ceD2\u5357',\n'j_contact': '\u6bb7\u5148\u751f',\n'j_tel': '17749503263',\n'd_province': province,\n'd_city': city,\n'd_county': district,\n'd_address': detailed_address,\n'd_company': company,\n'd_contact': contact,\n'd_tel': tel,\n'parcel_quantity': '1',\n'custid': month_card,\n'pay_method': '1',\n'customs_batchs': ''\n}\norder = SubElement(body, 'Order', attrib=order_attributes)\nSubElement(order, 'Cargo', attrib={'name': '\u4e2d\u836f(\u5e16)', 'count': str(paster), 'unit': '\u5e16'})\nSubElement(order, 'Cargo', attrib={'name': '\u4e2d\u836f(\u5305)', 'count': str(packet), 'unit': '\u5305'})\nxml = ElementTree.tostring(root, encoding='utf8').decode()\nresponse = self.call_service(xml)\nif response.status_code == 200:\net = ElementTree.fromstring(response.text)\nhead = et.find('Head').text\nif head == 'OK':\nreturn True, et.find('Body').find('OrderResponse').attrib['mailno']\nelse:\nreturn False, et.find('ERROR').text\nelse:\nreturn False, '\u987a\u4e30\u670d\u52a1\u5668\u65e0\u54cd\u5e94'\ndef order_filter(self, province, city, district, address, tel):\n\"\"\"\u7b5b\u5355 \u9700\u8981\u5f00\u542f\u8ba2\u5355\u7b5b\u9009\u63a5\u53e3 \u5224\u65ad\u5224\u65ad\u5ba2\u6237\u7684\u6536\u3001\u6d3e\u5730\u5740\u662f\u5426\u5c5e\u4e8e\u987a\u4e30\u7684\u6536\u6d3e\u8303\u56f4\"\"\"\nroot = Element('Request', service='OrderFilterService', lang=\"zh-CN\")\nhead = SubElement(root, 'Head')\nhead.text = self.client_code\nbody = SubElement(root, 'Body')\nSubElement(body, 'OrderFilter', attrib={\n'filter_type': '2',\n'd_address': address\n})\nSubElement(body, 'OrderFilterOption', attrib={\n'd_country': '\u4e2d\u56fd',\n'd_province': province,\n'd_city': city,\n'd_county': district,\n'd_tel': tel\n})\nxml = ElementTree.tostring(root, encoding='utf8').decode()\nresponse = self.call_service(xml)\nif response.status_code == 200:\net = ElementTree.fromstring(response.text)\nhead = et.find('Head').text\nif head == 'OK':\nreturn et.find('Body').find('OrderFilterResponse').attrib['filter_result']\nreturn None\ndef router_query(self, order_id):\n\"\"\"\u8def\u7531\u67e5\u8be2 \u5feb\u9012\u4fe1\u606f\u67e5\u8be2\"\"\"\nroot = Element('Request', service='RouteService', lang=\"zh-CN\")\nhead = SubElement(root, 'Head')\nhead.text = self.client_code\nbody = SubElement(root, 'Body')\nSubElement(body, 'RouteRequest', attrib={\n'tracking_type': '2',\n'tracking_number': order_id,\n'method_type': '1'\n})\nxml = ElementTree.tostring(root, encoding='utf8').decode()\nresponse = self.call_service(xml)\nif response.status_code == 200:\net = ElementTree.fromstring(response.text)\nhead = et.find('Head').text\nif head == 'OK':\nrouters = et.find('Body').find('RouteResponse').findall('Route')\ndata = []\nfor router in routers:\nrouter_data = {}\nfor attr in router.attrib:\nrouter_data[attr] = router.attrib[attr]\ndata.append(router_data)\nreturn data\nreturn None\ndef city_to_code(self, city):\n\"\"\"\u57ce\u5e02\u8f6c\u987a\u4e30\u7f16\u7801\"\"\"\nif self.city_data is None:\npath = os.path.join(settings.BASE_DIR, 'common/city_code.json')\nwith codecs.open(path, 'r', 'utf-8') as f:\nself.city_data = json.load(f)\nfor x in self.city_data:\nif x['city'] == city:\nreturn x['code']\nreturn None\ndef waybill(self, mail_no, month_card, province, city, district, detailed_address, company, contact, tel,\npaster, packet):\n\"\"\"\u7535\u5b50\u8fd0\u5355\u56fe\u7247\u4e0b\u8f7d\"\"\"\ndata = {\n'mailNo': mail_no,\n'expressType': 2,\n'payMethod': 1,\n'returnTrackingNo': None,\n'monthAccount': month_card,\n'orderNo': None,\n'zipCode': self.city_to_code('\u5357\u4eac\u5e02'),\n'destCode': self.city_to_code(city),\n'payArea': None,\n# \u5bc4\u4ef6\u4eba\u4fe1\u606f\n'deliverCompany': '\u5357\u4eac\u8bd7\u8fdc\u542f\u79d1\u6280\u6709\u9650\u516c\u53f8',\n'deliverName': '\u6bb7\u5148\u751f',\n'deliverMobile': '17749503263',\n'deliverTel': None,\n'deliverProvince': '\u6c5f\u82cf\u7701',\n'deliverCity': '\u5357\u4eac\u5e02',\n'deliverCounty': '\u96e8\u82b1\u53f0\u533a',\n'deliverAddress': '\u5927\u5468\u8def\u8f6f\u4ef6\u8c37\u79d1\u521b\u57ceD2\u5357',\n'deliverShipperCode': None,\n# \u6536\u4ef6\u4eba\u4fe1\u606f\n'consignerCompany': company,\n'consignerName': contact,\n'consignerMobile': tel,\n'consignerTel': None,\n'consignerProvince': province,\n'consignerCity': city,\n'consignerCounty': district,\n'consignerAddress': detailed_address,\n'consignerShipperCode': None,\n# logo\u76f8\u5173\n'logo': None,\n'sftelLogo': None,\n'topLogo': None,\n'topsftelLogo': None,\n# \u5176\u4ed6\u4fe1\u606f\n'totalFee': None,\n'appId': '\u5fc5\u586b',\n'appKey': '\u5fc5\u586b',\n'electric': 'E',\n'insureValue': None,\n'insureFee': None,\n'codValue': None,\n'codMonthAccount': None,\n# \u4e30\u5bc6\u8fd0\u5355\u76f8\u5173\u914d\u7f6e\n'abFlag': None,\n'xbFlag': None,\n'proCode': None,\n'destRouteLabel': None,\n'destTeamCode': None,\n'codingMapping': None,\n'codingMappingOut': None,\n'sourceTransferCode': None,\n'printIcon': None,\n'qrcode': None,\n# \u52a0\u5bc6\n'encryptMobile': False,\n'encryptCustName': False,\n# \u8d27\u7269\u4fe1\u606f\n'cargoInfoDtoList': [\n{\n'cargo': '\u4e2d\u836f(\u5e16)',\n'parcelQuantity': None,\n'cargoCount': paster,\n'cargoUnit': '\u5e16',\n'cargoWeight': None,\n'cargoAmount': None,\n'cargoTotalWeight': None,\n'remark': '\u5185\u6709\u6db2\u4f53 \u5c0f\u5fc3\u8f7b\u653e',\n'sku': None\n},\n{\n'cargo': '\u4e2d\u836f(\u5305)',\n'parcelQuantity': None,\n'cargoCount': packet,\n'cargoUnit': '\u5305',\n'cargoWeight': None,\n'cargoAmount': None,\n'cargoTotalWeight': None,\n'remark': '',\n'sku': None\n}\n]\n}\nurl = 'http://localhost:4040/sf/waybill/print?type=V2.1_poster_100mm150mm&amp;output=image'\nresponse = requests.post(url, data='[{}]'.format(json.dumps(data)))\nif response.json()['code'] == 'SYS_CODE_QIAO_0200':\nimages = []\nfor image_base64 in response.json()['result']:\n_image = ContentFile(base64.b64decode(image_base64), name='express_waybill.jpg')\nimage = Image.objects.create(image=_image, purpose=2)\nimages.append(image)\nreturn images\nreturn None\n</code></pre>"},{"location":"python/python/sf-express/#ubuntu1404jdk17","title":"Ubuntu14.04\u5b89\u88c5JDK1.7","text":""},{"location":"python/python/sf-express/#_3","title":"\u5b98\u7f51\u4e0b\u8f7d\u5b89\u88c5\u5305","text":"<p>\u524d\u5f80\u5b98\u7f51\u4e0b\u8f7d\u5b89\u88c5\u5305\uff0c\u5c06\u5b89\u88c5\u5305\u62f7\u8d1d\u81f3\u4e3b\u673a\u5f85\u7528\u3002</p>"},{"location":"python/python/sf-express/#_4","title":"\u521b\u5efa\u6587\u4ef6\u5939\u3001\u89e3\u538b\u6587\u4ef6","text":"<p>\u521b\u5efa\u6587\u4ef6\u5939</p> <pre><code>sudo mkdir /usr/lib/java\n</code></pre> <p>\u89e3\u538b\u538b\u7f29\u5305\u81f3\u6587\u4ef6\u5939</p> <pre><code>sudo tar zxvf jdk-7u80-linux-x64.tar.gz -C /usr/lib/java\n</code></pre>"},{"location":"python/python/sf-express/#_5","title":"\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf","text":"<pre><code>sudo nano /etc/profile \n</code></pre> <p>\u6587\u4ef6\u7ed3\u5c3e\u52a0\u5165\u73af\u5883\u53d8\u91cf\u5185\u5bb9\uff1a</p> <pre><code>#set java environment\nexport JAVA_HOME=/usr/lib/java/jdk1.7.0_80\nexport JRE_HOME=${JAVA_HOME}/jre \nexport CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib \nexport PATH=${JAVA_HOME}/bin:$PATH \n</code></pre> <p>\u8bbe\u7f6e\u5b8c\u73af\u5883\u53d8\u91cf\u4e4b\u540e\u6267\u884c\u547d\u4ee4\u8ba9\u8bbe\u7f6e\u751f\u6548</p> <pre><code>source /etc/profile \n</code></pre>"},{"location":"python/python/sf-express/#jdk","title":"\u8bbe\u7f6e\u9ed8\u8ba4\u7684JDK","text":"<pre><code>sudo update-alternatives --install /usr/bin/java  java  /usr/lib/java/jdk1.7.0_80/bin/java 300\nsudo update-alternatives --install /usr/bin/javac javac /usr/lib/java/jdk1.7.0_80/bin/javac 300\n</code></pre>"},{"location":"python/python/sf-express/#ubuntujdk","title":"\u68c0\u67e5Ubuntu\u7684JDK\u7248\u672c","text":"<pre><code>dreamgo@dreamgo:/usr/lib/java$ java -version\njava version \"1.7.0_80\"\nJava(TM) SE Runtime Environment (build 1.7.0_80-b15)\nJava HotSpot(TM) 64-Bit Server VM (build 24.80-b11, mixed mode)\n</code></pre>"},{"location":"python/python/sf-express/#sdk","title":"\u8fd0\u5355\u9762\u5355\u81ea\u52a9\u6253\u5370SDK","text":""},{"location":"python/python/sf-express/#_6","title":"\u8fd0\u884c\u670d\u52a1","text":"<ul> <li>\u62f7\u8d1d<code>csim_waybill_print_service_V1.0.5.jar</code>\u81f3\u670d\u52a1\u5668</li> <li><code>chmod -R 777 csim_waybill_print_service_V1.0.5.jar</code> \u5bf9\u6587\u4ef6\u6388\u6743\uff0c\u4ee5\u786e\u4fdd\u8be5jar\u80fd\u6b63\u786e\u751f\u6210\u65e5\u5fd7\u6587\u4ef6\u3002</li> <li><code>sudo java -jar csim_waybill_print_service_V1.0.5.jar 8888</code> #\u7aef\u53e3\u53f7\u4e0d\u586b\u65f6\u9ed8\u8ba4\u4e3a4040\uff0c\u8bf7\u68c0\u67e5\u9632\u706b\u5899\u72b6\u6001\u3002\uff08\u591a\u6b21\u53cd\u590d\u542f\u52a8\\\u5173\u95ed\u4f1a\u5bfc\u81f4\u670d\u52a1\u5f00\u542f\u662f\u5361\u5728\u7b2c3\u6b65\uff0c\u5df2\u63d0\u4ea4\u987a\u4e30\u6280\u672f\uff0c\u7b49\u5f85\u9a8c\u8bc1\u89e3\u51b3\u3002\uff09</li> </ul>"},{"location":"python/python/sf-express/#python","title":"python\u8bf7\u6c42\u63a5\u53e3","text":"<p>\u4f7f\u7528\u7684100x150mm,\u8f6cbase64\u7684\u63a5\u53e3\uff0c\u4ee3\u7801\u53c2\u89c1\u6700\u4e0a\u65b9\u3002\u53ef\u7ed3\u5408\u9700\u6c42\u548cnodejs\u4ee5\u53cajava\u7248\u672cdemo\u81ea\u884c\u4fee\u6539\u3002</p>"},{"location":"python/python/sf-express/#_7","title":"\u5b89\u88c5\u5b57\u4f53","text":"<p>\u5b89\u88c5\u5b57\u4f53\u662f\u4e3a\u4e86\u89e3\u51b3\u5728Linux\u7cfb\u7edf\u4e0a\uff0c\u751f\u6210\u7684\u5feb\u9012\u9762\u5355\u65e0\u6cd5\u6b63\u5e38\u663e\u793a\u76ee\u7684\u5730\u7f16\u7801\u7684\u95ee\u9898\u3002</p>"},{"location":"python/python/sf-express/#_8","title":"\u4e0b\u8f7d\u5b57\u4f53","text":"<p>\u5b57\u4f53\u5305<code>simhei.ttf</code>\u53ef\u5728<code>SF-CSIM-PRINTER-SDK-V1.0.5</code>\u538b\u7f29\u5305\u4e2d\u7684<code>linux\u7cfb\u7edf\u542f\u52a8\u6ce8\u610f\u4e8b\u9879</code>\u6587\u4ef6\u5939\u4e2d\u627e\u5230\u3002</p>"},{"location":"python/python/sf-express/#_9","title":"\u67e5\u770b\u5f53\u524d\u7cfb\u7edf\u4e2d\u5df2\u5b89\u88c5\u7684\u4e2d\u6587\u5b57\u4f53","text":"<pre><code>fc-list :lang=zh\n</code></pre>"},{"location":"python/python/sf-express/#simsunttf","title":"\u590d\u5236<code>simsun.ttf</code>\u5b57\u4f53\u6587\u4ef6","text":"<pre><code>mkdir -p /usr/share/fonts/my_fonts\n</code></pre> <p>\u62f7\u8d1d\u5b57\u4f53\u6587\u4ef6\u81f3\u8be5\u6587\u4ef6\u5939</p> <pre><code>cd /usr/share/fonts/my_fonts\napt-get install xfonts-utils\nmkfontscale \nmkfontdir #\u6ce8\u610f \u662f mkfontdir \u4e0d\u662f mkfontsdir\uff0c\u6b64\u5904\u987a\u4e30\u6587\u6863\u6709\u9519\u8bef\u3002\n\nll # \u5e94\u8be5\u53ef\u4ee5\u770b\u5230\u5bf9\u5e94\u7684fonts.dir \u548c fonts.scale\u6587\u4ef6\n</code></pre>"},{"location":"python/python/sf-express/#_10","title":"\u518d\u6b21\u67e5\u770b\u5df2\u5b89\u88c5\u7684\u5b57\u4f53","text":"<pre><code>fc-list :lang=zh\n</code></pre>"},{"location":"python/python/sf-express/#_11","title":"\u81ea\u52a8\u5f00\u542f\u81ea\u52a9\u9762\u5355\u6253\u5370\u670d\u52a1","text":""},{"location":"python/python/sf-express/#supervisord","title":"supervisord","text":"<p><code>fengqiao.conf</code>:</p> <pre><code>[program:feng_qiao]\ncommand=java -jar csim_waybill_print_service_V1.0.5.jar\ndirectory=/django/fengqiao\nstdout_logfile=/django/fengqiao/out.log\nstderr_logfile=/django/fengqiao/error.log\nautostart=true\nautorestart=true\nuser=root\nstartsecs=10\n</code></pre> <p>\u7528\u6237<code>user</code>\u5fc5\u987b\u662f<code>root</code>\uff0c\u8d85\u7ba1\u540d\u79f0\u4e0d\u662f<code>root</code>\u7684\u4e5f\u5199<code>root</code>\uff0c\u4e0d\u7136\u4f1a\u6743\u9650\u4e0d\u8db3\u3002 <code>supervisord</code>\u76f8\u5173\u64cd\u4f5c\uff0c\u90e8\u7f72\u8bf7\u53c2\u8003Supervisor\u4f7f\u7528\u7b14\u8bb0\u53cacelery\u751f\u4ea7\u90e8\u7f72\u3002</p>"},{"location":"python/python/sf-express/#_12","title":"\u4f5c\u4e3a\u670d\u52a1 \u6682\u672a\u6d4b\u8bd5\u901a\u8fc7","text":"<pre><code>#!/bin/sh\nSERVICE_NAME=fengqiao\nPATH_TO_JAR=/django/fengqiao/csim_waybill_print_service_V1.0.5.jar\nPID_PATH_NAME=/tmp/fengqiao-pid\ncase $1 in\nstart)\necho \"Starting $SERVICE_NAME ...\"\nif [ ! -f $PID_PATH_NAME ]; then\nnohup java -jar $PATH_TO_JAR /tmp 2&gt;&gt; /dev/null &gt;&gt; /dev/null &amp;\necho $! &gt; $PID_PATH_NAME\necho \"$SERVICE_NAME started ...\"\nelse\necho \"$SERVICE_NAME is already running ...\"\nfi\n;;\nstop)\nif [ -f $PID_PATH_NAME ]; then\nPID=$(cat $PID_PATH_NAME);\necho \"$SERVICE_NAME stoping ...\"\nkill $PID;\necho \"$SERVICE_NAME stopped ...\"\nrm $PID_PATH_NAME\nelse\necho \"$SERVICE_NAME is not running ...\"\nfi\n;;\nrestart)\nif [ -f $PID_PATH_NAME ]; then\nPID=$(cat $PID_PATH_NAME);\necho \"$SERVICE_NAME stopping ...\";\nkill $PID;\necho \"$SERVICE_NAME stopped ...\";\nrm $PID_PATH_NAME\necho \"$SERVICE_NAME starting ...\"\nnohup java -jar $PATH_TO_JAR /tmp 2&gt;&gt; /dev/null &gt;&gt; /dev/null &amp;\necho $! &gt; $PID_PATH_NAME\necho \"$SERVICE_NAME started ...\"\nelse\necho \"$SERVICE_NAME is not running ...\"\nfi\n;;\nesac\n</code></pre>"},{"location":"tags/","title":"\u6807\u7b7e","text":"<p>\u6587\u7ae0\u5217\u8868:</p>"}]}